<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO v5.0.4 - Articles</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #030712;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-input: #0f172a;
            --border: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-cyan: #06b6d4;
            --accent-teal: #14b8a6;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-orange: #f97316;
            --accent-pink: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gradient-main: linear-gradient(135deg, #06b6d4 0%, #14b8a6 50%, #10b981 100%);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Navigation unifi√©e */
        .top-nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 15px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-left { display: flex; align-items: center; gap: 10px; }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: inherit;
        }

        .nav-logo {
            width: 32px;
            height: 32px;
            background: var(--gradient-main);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 800;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-version {
            font-size: 9px;
            padding: 2px 6px;
            background: rgba(6, 182, 212, 0.2);
            border-radius: 4px;
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 2px;
            flex: 1;
            justify-content: center;
            padding: 0 10px;
        }

        .nav-link {
            padding: 6px 8px;
            border-radius: 6px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .nav-link:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-link.active {
            background: var(--gradient-main);
            color: white;
        }

        .nav-divider {
            width: 1px;
            height: 16px;
            background: var(--border);
            margin: 0 4px;
            opacity: 0.5;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: var(--bg-hover);
            border-radius: 8px;
            cursor: pointer;
            position: relative;
        }

        .user-avatar-small {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 11px;
            color: white;
        }

        .user-name-nav {
            font-size: 12px;
            font-weight: 600;
        }

        @media (max-width: 1200px) {
            .nav-link span:last-child { display: none; }
            .nav-title { display: none; }
            .user-name-nav { display: none; }
        }

        @media (max-width: 900px) {
            .nav-divider { display: none; }
        }

        /* Main container */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Tabs */
        .tabs-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .tab-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--gradient-main);
            color: white;
            border-color: transparent;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Section header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
        }

        .section-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
            border: 1px solid transparent;
        }

        .btn-primary {
            background: var(--gradient-main);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(6, 182, 212, 0.3);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            border-color: var(--accent-cyan);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent-cyan);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* Filters */
        .filters-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input, .filter-select {
            padding: 10px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
        }

        .search-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        /* Forms */
        .form-container {
            background: var(--bg-card);
            border: 2px solid var(--accent-cyan);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            display: none;
        }

        .form-container.visible { display: block; }

        .form-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--accent-cyan);
        }

        .form-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group { display: flex; flex-direction: column; gap: 6px; }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-input, .form-select {
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            align-items: center;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        /* Tables */
        .table-container { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-secondary);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        tr:hover { background: var(--bg-hover); }

        .action-btn {
            padding: 6px 10px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .action-btn:hover {
            background: var(--accent-cyan);
            color: white;
            border-color: var(--accent-cyan);
        }

        .action-btn.delete:hover {
            background: var(--danger);
            border-color: var(--danger);
        }

        /* Items grid */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .item-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px;
            transition: all 0.2s;
        }

        .item-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .item-title {
            font-size: 16px;
            font-weight: 700;
        }

        .item-code {
            font-size: 11px;
            padding: 3px 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            color: var(--text-muted);
        }

        .item-icon {
            font-size: 28px;
        }

        .item-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        /* Import section */
        .import-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 1000px) {
            .import-layout { grid-template-columns: 1fr; }
        }

        .import-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
        }

        .import-panel h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .file-drop-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .file-drop-zone:hover, .file-drop-zone.dragover {
            border-color: var(--accent-cyan);
            background: rgba(6, 182, 212, 0.05);
        }

        .file-drop-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .file-drop-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .file-info {
            display: none;
            padding: 15px;
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid var(--accent-cyan);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .file-info.visible { display: block; }

        .import-options { margin-bottom: 20px; }

        .import-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .import-option:hover, .import-option.selected {
            border-color: var(--accent-cyan);
        }

        .import-option h4 { font-size: 14px; margin-bottom: 4px; }
        .import-option p { font-size: 12px; color: var(--text-muted); }

        .import-actions {
            display: flex;
            gap: 10px;
        }

        .import-result {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .import-result.success {
            display: block;
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--success);
        }

        .import-result.error {
            display: block;
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger);
        }

        .import-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 16px;
        }

        .import-stat { text-align: center; }

        .import-stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .import-stat-value.added { color: var(--success); }
        .import-stat-value.updated { color: var(--accent-blue); }
        .import-stat-value.errors { color: var(--danger); }

        .import-stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .preview-table-container {
            max-height: 400px;
            overflow: auto;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .preview-table {
            font-size: 12px;
        }

        .preview-table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Mapping */
        .mapping-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .mapping-label {
            min-width: 120px;
            font-size: 13px;
            font-weight: 600;
        }

        .mapping-select {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.open { display: flex; }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-size: 18px; font-weight: 700; }
        .modal-subtitle { font-size: 12px; color: var(--text-muted); }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: var(--bg-hover);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
        }

        .modal-close:hover { background: var(--danger); color: white; }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            padding: 14px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            margin-top: 8px;
            animation: slideIn 0.3s;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Sync status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-hover);
            border-radius: 8px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Navigation unifi√©e -->
    <nav class="top-nav">
        <div class="nav-left">
            <a href="index.html" class="nav-brand">
                <div class="nav-logo">üêü</div>
                <span class="nav-title">TRAKIO</span>
                <span class="nav-version">v5.0.4</span>
            </a>
        </div>

        <div class="nav-menu">
            <a href="index.html" class="nav-link"><span>üè†</span><span>Dashboard</span></a>
            <div class="nav-divider"></div>
            <a href="articles.html" class="nav-link active"><span>üì¶</span><span>Articles</span></a>
            <a href="clients.html" class="nav-link"><span>üë•</span><span>Clients</span></a>
            <a href="commandes.html" class="nav-link"><span>üìã</span><span>Commandes</span></a>
            <a href="myfish.html" class="nav-link"><span>üêü</span><span>MyFish</span></a>
            <div class="nav-divider"></div>
            <a href="caisse.html" class="nav-link"><span>üí≥</span><span>Caisse</span></a>
            <a href="live.html" class="nav-link"><span>üìä</span><span>Cours</span></a>
            <a href="tracabilite.html" class="nav-link"><span>üè∑Ô∏è</span><span>Tra√ßabilit√©</span></a>
            <div class="nav-divider"></div>
            <a href="shopify.html" class="nav-link"><span>üõçÔ∏è</span><span>Shop</span></a>
            <a href="compta.html" class="nav-link"><span>üí∞</span><span>Compta</span></a>
            <a href="whatsapp.html" class="nav-link"><span>üí¨</span><span>WhatsApp</span></a>
            <div class="nav-divider" id="paramDivider"></div>
            <a href="parametres.html" class="nav-link" id="paramNavLink"><span>‚öôÔ∏è</span><span>Param√®tres</span></a>
        </div>

        <div class="nav-right">
            <div class="sync-status" id="syncStatus">
                <span>‚è≥</span>
                <span>Chargement...</span>
            </div>
            <div class="user-menu" id="userMenuNav">
                <div class="user-avatar-small" id="userAvatarNav" style="background: var(--danger);">PA</div>
                <span class="user-name-nav" id="userNameNav">-</span>
            </div>
        </div>
    </nav>
    <!-- Main Content -->
    <div class="main-container">
        <!-- Tabs Navigation -->
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('articles')">üì¶ Articles</button>
            <button class="tab-btn" onclick="switchTab('categories')">üè∑Ô∏è Cat√©gories</button>
            <button class="tab-btn" onclick="switchTab('pricelists')">üí∞ Listes de Prix</button>
            <button class="tab-btn" onclick="switchTab('discounts')">üè∑Ô∏è Rabais</button>
            <button class="tab-btn" onclick="switchTab('import')" style="background:var(--accent-secondary); color:#fff;">üì• Import CSV</button>
        </div>

        <!-- Tab: Articles -->
        <div id="tab-articles" class="tab-content active">
            <div class="section-header">
                <h2 class="section-title">üì¶ Gestion des Articles</h2>
                <div class="section-actions">
                    <button class="btn btn-primary" onclick="showArticleForm()">‚ûï Nouvel article</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">üì• Importer</button>
                    <button class="btn btn-secondary" onclick="exportArticlesCSV()">üì§ Exporter</button>
                    <button class="btn" style="background:var(--accent-secondary); color:#fff;" onclick="saveAllToDropbox()">‚òÅÔ∏è Dropbox</button>
                    <input type="file" id="import-file" accept=".csv" style="display:none;" onchange="importArticlesFile(this)">
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Total articles</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg, rgba(17,138,178,0.1), rgba(17,138,178,0.05)); border-color:var(--accent-secondary);">
                    <div class="stat-value" style="color:var(--accent-secondary);" id="stat-categories">0</div>
                    <div class="stat-label">Cat√©gories</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg, rgba(255,183,77,0.1), rgba(255,183,77,0.05)); border-color:var(--accent-warning);">
                    <div class="stat-value" style="color:var(--accent-warning);" id="stat-pricelists">0</div>
                    <div class="stat-label">Listes de prix</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color:var(--accent-orange);" id="stat-discounts">0</div>
                    <div class="stat-label">R√®gles rabais</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-bar">
                <input type="text" class="search-input" id="art-search" placeholder="üîç Rechercher N¬∞, d√©signation, origine..." oninput="filterArticles()">
                <select class="filter-select" id="art-cat-filter" onchange="filterArticles()">
                    <option value="">Toutes cat√©gories</option>
                </select>
            </div>

            <!-- Form -->
            <div class="form-container" id="art-form">
                <h3 class="form-title">üìù Fiche Article</h3>
                <input type="hidden" id="art-edit-id">
                <div class="form-grid" style="grid-template-columns: 100px 1fr 1fr;">
                    <div class="form-group">
                        <label class="form-label">N¬∞ Article *</label>
                        <input type="text" class="form-input" id="art-num">
                    </div>
                    <div class="form-group">
                        <label class="form-label">D√©signation *</label>
                        <input type="text" class="form-input" id="art-name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nom latin</label>
                        <input type="text" class="form-input" id="art-latin" placeholder="Ex: Salmo trutta" style="font-style:italic;">
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 100px 100px;">
                    <div class="form-group">
                        <label class="form-label">Cat√©gorie</label>
                        <select class="form-select" id="art-category"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Origine</label>
                        <input type="text" class="form-input" id="art-origin" placeholder="FAO27, Suisse...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">N¬∞ Lot</label>
                        <input type="text" class="form-input" id="art-lot">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pcs/unit√©</label>
                        <input type="number" class="form-input" id="art-pcs" value="1">
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: 100px 1fr 1fr 1fr 100px;">
                    <div class="form-group">
                        <label class="form-label">Unit√©</label>
                        <select class="form-select" id="art-unit">
                            <option value="kg">kg</option>
                            <option value="pce">pce</option>
                            <option value="l">litre</option>
                            <option value="dz">douzaine</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="color:var(--accent-warning); font-weight:600;">üí∞ Prix B2C HT</label>
                        <input type="number" step="0.01" class="form-input" id="art-price-b2c" style="border-color:var(--accent-warning);">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="color:var(--accent-secondary); font-weight:600;">üíº Prix B2B HT</label>
                        <input type="number" step="0.01" class="form-input" id="art-price-b2b" style="border-color:var(--accent-secondary);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix achat HT</label>
                        <input type="number" step="0.01" class="form-input" id="art-cost">
                    </div>
                    <div class="form-group">
                        <label class="form-label">TVA %</label>
                        <input type="number" step="0.1" class="form-input" id="art-tva" value="2.6">
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: 120px 120px 150px 1fr;">
                    <div class="form-group">
                        <label class="form-label" style="color:var(--accent-primary); font-weight:600;">üì¶ Stock actuel</label>
                        <input type="number" step="0.01" class="form-input" id="art-stock" style="border-color:var(--accent-primary);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock d√©faut</label>
                        <input type="number" step="0.01" class="form-input" id="art-stock-default">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Code TVA</label>
                        <input type="text" class="form-input" id="art-tva-code" placeholder="VTE81, TVA77...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Code barre (EAN)</label>
                        <input type="text" class="form-input" id="art-barcode" placeholder="7640178760004" style="font-family:monospace;">
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="saveArticle()">üíæ Enregistrer</button>
                    <button class="btn btn-secondary" onclick="hideArticleForm()">Annuler</button>
                    <label style="display:flex; align-items:center; gap:6px; margin-left:auto; cursor:pointer;">
                        <input type="checkbox" id="art-active" checked> Actif
                    </label>
                </div>
            </div>

            <!-- Table -->
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>N¬∞</th>
                                <th>D√©signation</th>
                                <th>Origine</th>
                                <th>Unit√©</th>
                                <th style="color:var(--accent-warning);">PV HT</th>
                                <th>PA HT</th>
                                <th style="color:var(--accent-primary);">Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="art-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Categories -->
        <div id="tab-categories" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">üè∑Ô∏è Cat√©gories d'articles</h2>
                <button class="btn btn-primary" onclick="showCategoryForm()">‚ûï Nouvelle cat√©gorie</button>
            </div>

            <!-- Form -->
            <div class="form-container" id="cat-form" style="border-color:var(--accent-secondary);">
                <h3 class="form-title" style="color:var(--accent-secondary);">üìù Cat√©gorie</h3>
                <input type="hidden" id="cat-edit-id">
                <div class="form-grid" style="grid-template-columns: 100px 1fr 150px;">
                    <div class="form-group">
                        <label class="form-label">Code</label>
                        <input type="text" class="form-input" id="cat-code">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nom *</label>
                        <input type="text" class="form-input" id="cat-name" placeholder="Ex: Poissons frais, √âpicerie...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ic√¥ne</label>
                        <select class="form-select" id="cat-icon">
                            <option value="üêü">üêü Poisson</option>
                            <option value="ü¶ê">ü¶ê Crustac√©</option>
                            <option value="ü¶™">ü¶™ Coquillage</option>
                            <option value="üî•">üî• Fum√©</option>
                            <option value="ü•´">ü•´ Conserve</option>
                            <option value="üçΩÔ∏è">üçΩÔ∏è Pr√©paration</option>
                            <option value="‚ùÑÔ∏è">‚ùÑÔ∏è Surgel√©</option>
                            <option value="üõí">üõí √âpicerie</option>
                            <option value="üì¶">üì¶ Autre</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="saveCategory()">üíæ Enregistrer</button>
                    <button class="btn btn-secondary" onclick="hideCategoryForm()">Annuler</button>
                </div>
            </div>

            <div class="items-grid" id="categories-grid"></div>
        </div>

        <!-- Tab: Pricelists -->
        <div id="tab-pricelists" class="tab-content">
            <div class="section-header">
                <div>
                    <h2 class="section-title">üí∞ Listes de Prix</h2>
                    <p class="text-muted" style="font-size:13px;">Tarifs personnalis√©s par type de client</p>
                </div>
                <button class="btn btn-primary" onclick="showPricelistForm()">‚ûï Nouvelle liste</button>
            </div>

            <!-- Form -->
            <div class="form-container" id="pl-form" style="border-color:var(--accent-warning);">
                <h3 class="form-title" style="color:var(--accent-warning);">üìù Liste de prix</h3>
                <input type="hidden" id="pl-edit-id">
                <div class="form-grid" style="grid-template-columns: 100px 1fr 150px;">
                    <div class="form-group">
                        <label class="form-label">Code</label>
                        <input type="text" class="form-input" id="pl-code" placeholder="GMS, REST...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nom *</label>
                        <input type="text" class="form-input" id="pl-name" placeholder="Ex: Restaurateurs, Grande distribution...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Remise globale %</label>
                        <input type="number" step="0.1" class="form-input" id="pl-discount" value="0">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label class="form-label">Description / Conditions</label>
                    <textarea class="form-input" id="pl-desc" rows="2" style="resize:vertical;"></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="savePricelist()">üíæ Enregistrer</button>
                    <button class="btn btn-secondary" onclick="hidePricelistForm()">Annuler</button>
                </div>
            </div>

            <div class="items-grid" id="pricelists-grid"></div>
        </div>

        <!-- Tab: Discounts -->
        <div id="tab-discounts" class="tab-content">
            <div class="section-header">
                <div>
                    <h2 class="section-title">üè∑Ô∏è R√®gles de Rabais</h2>
                    <p class="text-muted" style="font-size:13px;">Remises par quantit√© et cat√©gorie</p>
                </div>
                <button class="btn btn-primary" onclick="showDiscountForm()">‚ûï Nouvelle r√®gle</button>
            </div>

            <!-- Form -->
            <div class="form-container" id="disc-form">
                <h3 class="form-title">üìù R√®gle de rabais</h3>
                <input type="hidden" id="disc-edit-id">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label class="form-label">Cat√©gorie concern√©e *</label>
                        <select class="form-select" id="disc-category"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Liste de prix (optionnel)</label>
                        <select class="form-select" id="disc-pricelist">
                            <option value="">Toutes les listes</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label class="form-label">Paliers de quantit√©</label>
                    <div id="disc-tiers" style="display:flex; flex-direction:column; gap:8px;"></div>
                    <button type="button" class="btn btn-secondary" onclick="addDiscountTier()" style="margin-top:8px; font-size:12px;">‚ûï Ajouter un palier</button>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="saveDiscount()">üíæ Enregistrer</button>
                    <button class="btn btn-secondary" onclick="hideDiscountForm()">Annuler</button>
                </div>
            </div>

            <!-- Example -->
            <div class="example-box">
                <h4 class="example-title">üí° Exemple de configuration</h4>
                <p class="example-text">Cat√©gorie <strong>√âpicerie</strong> : D√®s 10 pi√®ces ‚Üí 5% | D√®s 20 pi√®ces ‚Üí 10% | D√®s 50 pi√®ces ‚Üí 15%</p>
            </div>

            <div id="discounts-grid"></div>
        </div>

        <!-- Tab: Import CSV -->
        <div id="tab-import" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">üì• Import CSV Articles</h2>
            </div>

            <div class="import-container">
                <!-- Panel gauche: Upload -->
                <div class="import-panel">
                    <h3>üìÅ Fichier CSV</h3>
                    
                    <div class="drop-zone" id="dropZone" onclick="document.getElementById('csvFileInput').click()">
                        <div class="drop-zone-icon">üìÑ</div>
                        <div class="drop-zone-text">Glissez votre fichier CSV ici</div>
                        <div class="drop-zone-hint">ou cliquez pour s√©lectionner</div>
                        <input type="file" id="csvFileInput" accept=".csv,.txt" style="display:none;">
                    </div>

                    <div class="file-info" id="fileInfo">
                        <div class="file-info-name" id="fileName"></div>
                        <div class="file-info-stats">
                            <span>üìä <span id="rowCount">0</span> lignes</span>
                            <span>üìã <span id="colCount">0</span> colonnes</span>
                        </div>
                    </div>

                    <div class="import-options">
                        <h4 style="margin-bottom: 12px;">‚öôÔ∏è Mode d'import</h4>
                        
                        <div class="import-option selected" onclick="selectImportMode('update')">
                            <input type="radio" name="importMode" value="update" checked>
                            <div class="import-option-content">
                                <h4>üîÑ Mettre √† jour</h4>
                                <p>Ajoute les nouveaux articles et met √† jour les existants (par N¬∞ article)</p>
                            </div>
                        </div>
                        
                        <div class="import-option" onclick="selectImportMode('replace')">
                            <input type="radio" name="importMode" value="replace">
                            <div class="import-option-content">
                                <h4>üóëÔ∏è Remplacer tout</h4>
                                <p>Supprime tous les articles existants et importe les nouveaux</p>
                            </div>
                        </div>
                    </div>

                    <div class="import-actions">
                        <button class="btn btn-primary" onclick="executeImport()" id="btnImport" disabled style="flex:1;">
                            üöÄ Lancer l'import
                        </button>
                        <button class="btn btn-secondary" onclick="resetImport()">
                            ‚Ü∫ R√©initialiser
                        </button>
                    </div>

                    <div class="import-result" id="importResult">
                        <h4 id="importResultTitle">‚úÖ Import termin√© !</h4>
                        <p id="importResultMessage"></p>
                        <div class="import-stats">
                            <div class="import-stat">
                                <div class="import-stat-value added" id="statAdded">0</div>
                                <div class="import-stat-label">Ajout√©s</div>
                            </div>
                            <div class="import-stat">
                                <div class="import-stat-value updated" id="statUpdated">0</div>
                                <div class="import-stat-label">Mis √† jour</div>
                            </div>
                            <div class="import-stat">
                                <div class="import-stat-value errors" id="statErrors">0</div>
                                <div class="import-stat-label">Erreurs</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel droit: Preview -->
                <div class="import-panel">
                    <h3>üëÅÔ∏è Aper√ßu des donn√©es</h3>
                    
                    <div id="mappingContainer" style="display:none; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 12px;">üîó Mapping des colonnes</h4>
                        <div id="mappingRows"></div>
                    </div>

                    <div class="preview-table-container" id="previewContainer" style="display:none;">
                        <table class="preview-table" id="previewTable">
                            <thead id="previewHead"></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>

                    <div id="noPreview" style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <div style="font-size: 50px; margin-bottom: 16px; opacity: 0.5;">üìã</div>
                        <p>S√©lectionnez un fichier CSV pour voir l'aper√ßu</p>
                    </div>

                    <div style="margin-top: 20px; padding: 16px; background: var(--bg-primary); border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: var(--accent-primary);">üìñ Format CSV attendu</h4>
                        <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Colonnes recommand√©es (s√©parateur ; ou ,) :</p>
                        <code style="font-size: 11px; color: var(--accent-secondary); display: block; background: var(--bg-card); padding: 10px; border-radius: 6px; overflow-x: auto;">
                            N¬∞ Article;D√©signation;Origine;Unit√©;Prix HT;Stock;TVA;Code barre
                        </code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Detail -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title" id="detail-title"></h2>
                    <p class="modal-subtitle" id="detail-subtitle"></p>
                </div>
                <button class="modal-close" onclick="closeDetailModal()">‚úï</button>
            </div>
            <div class="modal-body" id="detail-content"></div>
        </div>
    </div>



    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ============================================
        // V√âRIFICATION UTILISATEUR
        // ============================================
        const DEFAULT_USERS = [
            { id: 'admin_pascal', name: 'Pascal Admin', pin: '1277', role: 'admin', avatar: 'PA', color: '#ef4444', active: true },
            { id: 'manager_celine', name: 'C√©line', pin: '1277', role: 'manager', avatar: 'CE', color: '#f59e0b', active: true },
            { id: 'employee_hayat', name: 'Hayat', pin: '1260', role: 'employee', avatar: 'HA', color: '#10b981', active: true }
        ];

        const ROLES = {
            admin: { label: 'Admin', badge: 'üëë', color: '#ef4444' },
            manager: { label: 'Manager', badge: '‚≠ê', color: '#f59e0b' },
            employee: { label: 'Employ√©', badge: 'üë§', color: '#10b981' }
        };

        function getCurrentUser() {
            try { return JSON.parse(localStorage.getItem('trakio_current_user')); } catch(e) { return null; }
        }

        function checkAuth() {
            const user = getCurrentUser();
            if (!user) {
                window.location.href = 'index.html';
                return false;
            }
            // Mettre √† jour l'affichage utilisateur
            const role = ROLES[user.role] || ROLES.employee;
            document.getElementById('userAvatarNav').textContent = user.avatar || user.name.substring(0,2);
            document.getElementById('userAvatarNav').style.background = user.color || role.color;
            document.getElementById('userNameNav').textContent = user.name.split(' ')[0];
            
            // Cacher Param√®tres pour non-admin
            if (user.role !== 'admin') {
                const paramLink = document.getElementById('paramNavLink');
                const paramDiv = document.getElementById('paramDivider');
                if (paramLink) paramLink.style.display = 'none';
                if (paramDiv) paramDiv.style.display = 'none';
            }
            return true;
        }

        function showToast(msg, type = 'success') {
            const c = document.getElementById('toastContainer');
            const t = document.createElement('div');
            t.className = 'toast ' + type;
            t.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span><span>${msg}</span>`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            VERSION: '1.0.0',
            STORAGE_KEY: 'trakio_articles',
            DROPBOX_BASE_PATH: '/TRAKIO/Articles'
        };

        // ============================================
        // √âTAT GLOBAL
        // ============================================
        let ArticlesData = {
            articles: [],
            categories: [
                { id: 1, code: 'POISSON', name: 'Poissons frais', icon: 'üêü' },
                { id: 2, code: 'CRUSTACE', name: 'Crustac√©s', icon: 'ü¶ê' },
                { id: 3, code: 'COQUILLAGE', name: 'Coquillages', icon: 'ü¶™' },
                { id: 4, code: 'FUME', name: 'Produits fum√©s', icon: 'üî•' },
                { id: 5, code: 'CONSERVE', name: 'Conserves', icon: 'ü•´' },
                { id: 6, code: 'PREPA', name: 'Pr√©parations', icon: 'üçΩÔ∏è' },
                { id: 7, code: 'SURGELE', name: 'Surgel√©s', icon: '‚ùÑÔ∏è' },
                { id: 8, code: 'EPICERIE', name: '√âpicerie', icon: 'üõí' }
            ],
            pricelists: [
                { id: 1, code: 'STD', name: 'Standard B2C', discount: 0, desc: 'Tarif particuliers' },
                { id: 2, code: 'PRO', name: 'Professionnels', discount: 15, desc: 'Restaurants, traiteurs' },
                { id: 3, code: 'GMS', name: 'Grande distribution', discount: 20, desc: 'Supermarch√©s, hypermarch√©s' }
            ],
            discounts: []
        };

        // Num√©rotation automatique
        let NumberingConfig = {
            article: { prefix: 'ART', next: 1 }
        };

        // ============================================
        // INITIALISATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkAuth()) return;
            loadFromLocalStorage();
            loadNumberingConfig();
            updateCategorySelects();
            updatePricelistSelects();
            renderAll();
            updateStats();
            updateSyncStatus('ready');
        });

        function goBack() {
            window.location.href = 'index.html';
        }

        // ============================================
        // NAVIGATION ONGLETS
        // ============================================
        function switchTab(tabName) {
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activer l'onglet s√©lectionn√©
            document.querySelector(`.tab-btn[onclick*="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // ============================================
        // STOCKAGE LOCAL
        // ============================================
        function saveToLocalStorage() {
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(ArticlesData));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                ArticlesData = { ...ArticlesData, ...parsed };
            }
        }

        function loadNumberingConfig() {
            const next = localStorage.getItem('num_article_next');
            if (next) NumberingConfig.article.next = parseInt(next);
        }

        function saveNumberingConfig() {
            localStorage.setItem('num_article_next', NumberingConfig.article.next);
        }

        // ============================================
        // MISE √Ä JOUR UI
        // ============================================
        function renderAll() {
            renderArticlesTable();
            renderCategoriesGrid();
            renderPricelistsGrid();
            renderDiscountsGrid();
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = ArticlesData.articles.length;
            document.getElementById('stat-categories').textContent = ArticlesData.categories.length;
            document.getElementById('stat-pricelists').textContent = ArticlesData.pricelists.length;
            document.getElementById('stat-discounts').textContent = ArticlesData.discounts.length;
        }

        function updateCategorySelects() {
            const options = '<option value="">-- Choisir --</option>' + 
                ArticlesData.categories.map(c => `<option value="${c.id}">${c.icon} ${c.name}</option>`).join('');
            
            const artCat = document.getElementById('art-category');
            const discCat = document.getElementById('disc-category');
            const filterCat = document.getElementById('art-cat-filter');
            
            if (artCat) artCat.innerHTML = options;
            if (discCat) discCat.innerHTML = options;
            if (filterCat) filterCat.innerHTML = '<option value="">Toutes cat√©gories</option>' + 
                ArticlesData.categories.map(c => `<option value="${c.id}">${c.icon} ${c.name}</option>`).join('');
        }

        function updatePricelistSelects() {
            const discPl = document.getElementById('disc-pricelist');
            if (discPl) {
                discPl.innerHTML = '<option value="">Toutes les listes</option>' + 
                    ArticlesData.pricelists.map(p => `<option value="${p.id}">${p.name} (${p.discount}%)</option>`).join('');
            }
        }

        function updateSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            if (status === 'ready') {
                el.innerHTML = '<span>‚úÖ</span><span>Pr√™t</span>';
            } else if (status === 'syncing') {
                el.classList.add('syncing');
                el.innerHTML = '<span>üîÑ</span><span>Sync...</span>';
            } else if (status === 'success') {
                el.classList.remove('syncing');
                el.innerHTML = '<span>‚òÅÔ∏è</span><span>Synchronis√©</span>';
            }
        }

        // ============================================
        // ARTICLES
        // ============================================
        function renderArticlesTable() {
            let articles = ArticlesData.articles;
            const search = document.getElementById('art-search')?.value.toLowerCase() || '';
            const catFilter = document.getElementById('art-cat-filter')?.value || '';
            
            if (search) {
                articles = articles.filter(a =>
                    a.num.toLowerCase().includes(search) ||
                    a.name.toLowerCase().includes(search) ||
                    (a.latin && a.latin.toLowerCase().includes(search)) ||
                    (a.origin && a.origin.toLowerCase().includes(search)) ||
                    (a.barcode && a.barcode.toLowerCase().includes(search))
                );
            }
            if (catFilter) {
                articles = articles.filter(a => a.categoryId == catFilter);
            }
            
            const tbody = document.getElementById('art-tbody');
            tbody.innerHTML = articles.map(a => {
                const stock = a.stock || 0;
                const stockColor = stock <= 0 ? 'var(--accent-danger)' : stock < 10 ? 'var(--accent-warning)' : 'var(--accent-primary)';
                return `
                <tr style="opacity:${a.active !== false ? 1 : 0.5}">
                    <td><strong class="text-orange" style="font-family:monospace;">${a.num}</strong></td>
                    <td>
                        <div><strong>${a.name}</strong></div>
                        ${a.latin ? `<div style="font-size:11px; font-style:italic;" class="text-muted">${a.latin}</div>` : ''}
                        ${a.barcode ? `<div style="font-size:10px; font-family:monospace;" class="text-muted">üîñ ${a.barcode}</div>` : ''}
                    </td>
                    <td style="font-size:12px;">${a.origin || '-'}</td>
                    <td>${a.unit || 'kg'}</td>
                    <td style="font-weight:600; color:var(--accent-warning);">${(a.priceB2C || 0).toFixed(2)}</td>
                    <td class="text-muted">${(a.cost || 0).toFixed(2)}</td>
                    <td style="font-weight:600; color:${stockColor};">${stock.toFixed(1)}</td>
                    <td>
                        <div style="display:flex; gap:4px;">
                            <button class="action-btn" onclick="editArticle(${a.id})">‚úèÔ∏è</button>
                            <button class="action-btn delete" onclick="deleteArticle(${a.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('') || '<tr><td colspan="8" style="text-align:center; padding:40px;" class="text-muted">Aucun article</td></tr>';
            
            updateStats();
        }

        function filterArticles() {
            renderArticlesTable();
        }

        function showArticleForm() {
            document.getElementById('art-form').style.display = 'block';
            document.getElementById('art-edit-id').value = '';
            const nextNum = `${NumberingConfig.article.prefix}-${NumberingConfig.article.next}`;
            document.getElementById('art-num').value = nextNum;
            document.getElementById('art-name').value = '';
            document.getElementById('art-latin').value = '';
            document.getElementById('art-category').value = '';
            document.getElementById('art-origin').value = '';
            document.getElementById('art-lot').value = '';
            document.getElementById('art-pcs').value = '1';
            document.getElementById('art-unit').value = 'kg';
            document.getElementById('art-price-b2c').value = '';
            document.getElementById('art-price-b2b').value = '';
            document.getElementById('art-cost').value = '';
            document.getElementById('art-tva').value = '2.6';
            document.getElementById('art-stock').value = '';
            document.getElementById('art-stock-default').value = '';
            document.getElementById('art-tva-code').value = '';
            document.getElementById('art-barcode').value = '';
            document.getElementById('art-active').checked = true;
            document.getElementById('art-form').scrollIntoView({ behavior: 'smooth' });
        }

        function hideArticleForm() {
            document.getElementById('art-form').style.display = 'none';
        }

        function editArticle(id) {
            const a = ArticlesData.articles.find(x => x.id === id);
            if (!a) return;
            
            document.getElementById('art-form').style.display = 'block';
            document.getElementById('art-edit-id').value = id;
            document.getElementById('art-num').value = a.num || '';
            document.getElementById('art-name').value = a.name || '';
            document.getElementById('art-latin').value = a.latin || '';
            document.getElementById('art-category').value = a.categoryId || '';
            document.getElementById('art-origin').value = a.origin || '';
            document.getElementById('art-lot').value = a.lot || '';
            document.getElementById('art-pcs').value = a.pcs || 1;
            document.getElementById('art-unit').value = a.unit || 'kg';
            document.getElementById('art-price-b2c').value = a.priceB2C || '';
            document.getElementById('art-price-b2b').value = a.priceB2B || '';
            document.getElementById('art-cost').value = a.cost || '';
            document.getElementById('art-tva').value = a.tva || 2.6;
            document.getElementById('art-stock').value = a.stock || '';
            document.getElementById('art-stock-default').value = a.stockDefault || '';
            document.getElementById('art-tva-code').value = a.tvaCode || '';
            document.getElementById('art-barcode').value = a.barcode || '';
            document.getElementById('art-active').checked = a.active !== false;
            document.getElementById('art-form').scrollIntoView({ behavior: 'smooth' });
        }

        function saveArticle() {
            const id = document.getElementById('art-edit-id').value;
            const article = {
                id: id ? parseInt(id) : Date.now(),
                num: document.getElementById('art-num').value.trim(),
                name: document.getElementById('art-name').value.trim(),
                latin: document.getElementById('art-latin').value.trim(),
                categoryId: parseInt(document.getElementById('art-category').value) || null,
                origin: document.getElementById('art-origin').value.trim(),
                lot: document.getElementById('art-lot').value.trim(),
                pcs: parseInt(document.getElementById('art-pcs').value) || 1,
                unit: document.getElementById('art-unit').value,
                priceB2C: parseFloat(document.getElementById('art-price-b2c').value) || 0,
                priceB2B: parseFloat(document.getElementById('art-price-b2b').value) || 0,
                cost: parseFloat(document.getElementById('art-cost').value) || 0,
                tva: parseFloat(document.getElementById('art-tva').value) || 2.6,
                stock: parseFloat(document.getElementById('art-stock').value) || 0,
                stockDefault: parseFloat(document.getElementById('art-stock-default').value) || 0,
                tvaCode: document.getElementById('art-tva-code').value.trim(),
                barcode: document.getElementById('art-barcode').value.trim(),
                active: document.getElementById('art-active').checked,
                updatedAt: new Date().toISOString()
            };
            
            if (!article.num || !article.name) {
                showToast('N¬∞ article et d√©signation requis', 'error');
                return;
            }
            
            if (id) {
                const idx = ArticlesData.articles.findIndex(a => a.id === parseInt(id));
                if (idx !== -1) ArticlesData.articles[idx] = article;
            } else {
                article.createdAt = new Date().toISOString();
                ArticlesData.articles.push(article);
                if (article.num.startsWith(NumberingConfig.article.prefix + '-')) {
                    NumberingConfig.article.next++;
                    saveNumberingConfig();
                }
            }
            
            saveToLocalStorage();
            hideArticleForm();
            renderArticlesTable();
            showToast('Article enregistr√©', 'success');
        }

        function deleteArticle(id) {
            if (!confirm('Supprimer cet article ?')) return;
            ArticlesData.articles = ArticlesData.articles.filter(a => a.id !== id);
            saveToLocalStorage();
            renderArticlesTable();
            showToast('Article supprim√©', 'success');
        }

        // ============================================
        // CAT√âGORIES
        // ============================================
        function renderCategoriesGrid() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = ArticlesData.categories.map(c => {
                const count = ArticlesData.articles.filter(a => a.categoryId === c.id).length;
                return `
                <div class="item-card" onclick="showCategoryArticles(${c.id})">
                    <div class="item-icon">${c.icon}</div>
                    <div class="item-info">
                        <div class="item-name">${c.name}</div>
                        <div class="item-meta">Code: ${c.code}</div>
                        <span class="item-badge">üì¶ ${count} article${count > 1 ? 's' : ''}</span>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); editCategory(${c.id})">‚úèÔ∏è</button>
                        <button class="action-btn delete" onclick="event.stopPropagation(); deleteCategory(${c.id})">üóëÔ∏è</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function showCategoryArticles(categoryId) {
            const cat = ArticlesData.categories.find(c => c.id === categoryId);
            if (!cat) return;
            
            const articles = ArticlesData.articles.filter(a => a.categoryId === categoryId);
            
            document.getElementById('detail-title').innerHTML = `${cat.icon} ${cat.name}`;
            document.getElementById('detail-subtitle').textContent = `${articles.length} article${articles.length > 1 ? 's' : ''} dans cette cat√©gorie`;
            
            const content = document.getElementById('detail-content');
            if (articles.length === 0) {
                content.innerHTML = '<p style="text-align:center; padding:40px;" class="text-muted">Aucun article dans cette cat√©gorie</p>';
            } else {
                content.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>N¬∞</th>
                                <th>D√©signation</th>
                                <th>Origine</th>
                                <th style="color:var(--accent-warning);">B2C</th>
                                <th style="color:var(--accent-secondary);">B2B</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${articles.map(a => `
                                <tr style="opacity:${a.active ? 1 : 0.5}">
                                    <td><strong class="text-orange">${a.num}</strong></td>
                                    <td>
                                        <div><strong>${a.name}</strong></div>
                                        ${a.latin ? `<div style="font-size:11px; font-style:italic;" class="text-muted">${a.latin}</div>` : ''}
                                    </td>
                                    <td>${a.origin || '-'}</td>
                                    <td style="font-weight:600; color:var(--accent-warning);">${(a.priceB2C || 0).toFixed(2)}</td>
                                    <td style="font-weight:600; color:var(--accent-secondary);">${(a.priceB2B || 0).toFixed(2)}</td>
                                    <td>
                                        <button class="btn btn-primary" style="font-size:11px; padding:4px 8px;" onclick="closeDetailModal(); switchTab('articles'); setTimeout(() => editArticle(${a.id}), 200)">√âditer ‚Üí</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            document.getElementById('detail-modal').style.display = 'flex';
        }

        function showCategoryForm() {
            document.getElementById('cat-form').style.display = 'block';
            document.getElementById('cat-edit-id').value = '';
            document.getElementById('cat-code').value = '';
            document.getElementById('cat-name').value = '';
            document.getElementById('cat-icon').value = 'üì¶';
        }

        function hideCategoryForm() {
            document.getElementById('cat-form').style.display = 'none';
        }

        function editCategory(id) {
            const c = ArticlesData.categories.find(x => x.id === id);
            if (!c) return;
            document.getElementById('cat-form').style.display = 'block';
            document.getElementById('cat-edit-id').value = id;
            document.getElementById('cat-code').value = c.code || '';
            document.getElementById('cat-name').value = c.name || '';
            document.getElementById('cat-icon').value = c.icon || 'üì¶';
        }

        function saveCategory() {
            const id = document.getElementById('cat-edit-id').value;
            const cat = {
                id: id ? parseInt(id) : Date.now(),
                code: document.getElementById('cat-code').value.trim().toUpperCase() || 'CAT' + Date.now(),
                name: document.getElementById('cat-name').value.trim(),
                icon: document.getElementById('cat-icon').value
            };
            
            if (!cat.name) {
                showToast('Nom requis', 'error');
                return;
            }
            
            if (id) {
                const idx = ArticlesData.categories.findIndex(c => c.id === parseInt(id));
                if (idx !== -1) ArticlesData.categories[idx] = cat;
            } else {
                ArticlesData.categories.push(cat);
            }
            
            saveToLocalStorage();
            hideCategoryForm();
            updateCategorySelects();
            renderCategoriesGrid();
            updateStats();
            showToast('Cat√©gorie enregistr√©e', 'success');
        }

        function deleteCategory(id) {
            if (!confirm('Supprimer cette cat√©gorie ?')) return;
            ArticlesData.categories = ArticlesData.categories.filter(c => c.id !== id);
            saveToLocalStorage();
            updateCategorySelects();
            renderCategoriesGrid();
            updateStats();
            showToast('Cat√©gorie supprim√©e', 'success');
        }

        // ============================================
        // LISTES DE PRIX
        // ============================================
        function renderPricelistsGrid() {
            const grid = document.getElementById('pricelists-grid');
            grid.innerHTML = ArticlesData.pricelists.map(p => {
                return `
                <div class="item-card" style="cursor:default;">
                    <div class="item-icon">üí∞</div>
                    <div class="item-info">
                        <div class="item-name">${p.name}</div>
                        <div class="item-meta">Code: ${p.code}</div>
                        <span class="item-badge" style="background:rgba(255,183,77,0.2); color:var(--accent-warning);">-${p.discount}% sur B2C</span>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn" onclick="editPricelist(${p.id})">‚úèÔ∏è</button>
                        <button class="action-btn delete" onclick="deletePricelist(${p.id})">üóëÔ∏è</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function showPricelistForm() {
            document.getElementById('pl-form').style.display = 'block';
            document.getElementById('pl-edit-id').value = '';
            document.getElementById('pl-code').value = '';
            document.getElementById('pl-name').value = '';
            document.getElementById('pl-discount').value = '0';
            document.getElementById('pl-desc').value = '';
        }

        function hidePricelistForm() {
            document.getElementById('pl-form').style.display = 'none';
        }

        function editPricelist(id) {
            const p = ArticlesData.pricelists.find(x => x.id === id);
            if (!p) return;
            document.getElementById('pl-form').style.display = 'block';
            document.getElementById('pl-edit-id').value = id;
            document.getElementById('pl-code').value = p.code || '';
            document.getElementById('pl-name').value = p.name || '';
            document.getElementById('pl-discount').value = p.discount || 0;
            document.getElementById('pl-desc').value = p.desc || '';
        }

        function savePricelist() {
            const id = document.getElementById('pl-edit-id').value;
            const pl = {
                id: id ? parseInt(id) : Date.now(),
                code: document.getElementById('pl-code').value.trim().toUpperCase() || 'PL' + Date.now(),
                name: document.getElementById('pl-name').value.trim(),
                discount: parseFloat(document.getElementById('pl-discount').value) || 0,
                desc: document.getElementById('pl-desc').value.trim()
            };
            
            if (!pl.name) {
                showToast('Nom requis', 'error');
                return;
            }
            
            if (id) {
                const idx = ArticlesData.pricelists.findIndex(p => p.id === parseInt(id));
                if (idx !== -1) ArticlesData.pricelists[idx] = pl;
            } else {
                ArticlesData.pricelists.push(pl);
            }
            
            saveToLocalStorage();
            hidePricelistForm();
            updatePricelistSelects();
            renderPricelistsGrid();
            updateStats();
            showToast('Liste de prix enregistr√©e', 'success');
        }

        function deletePricelist(id) {
            if (!confirm('Supprimer cette liste de prix ?')) return;
            ArticlesData.pricelists = ArticlesData.pricelists.filter(p => p.id !== id);
            saveToLocalStorage();
            updatePricelistSelects();
            renderPricelistsGrid();
            updateStats();
            showToast('Liste supprim√©e', 'success');
        }

        // ============================================
        // RABAIS
        // ============================================
        function renderDiscountsGrid() {
            const grid = document.getElementById('discounts-grid');
            grid.innerHTML = ArticlesData.discounts.map(d => {
                const cat = ArticlesData.categories.find(c => c.id === d.categoryId);
                const pl = d.pricelistId ? ArticlesData.pricelists.find(p => p.id === d.pricelistId) : null;
                const tiersHtml = (d.tiers || []).map(t =>
                    `<span style="display:inline-block; padding:4px 10px; background:var(--bg-hover); border-radius:20px; font-size:12px; margin:2px;">D√®s ${t.qty} pce ‚Üí <strong>-${t.pct}%</strong></span>`
                ).join(' ');
                
                return `
                <div class="card" style="padding:16px; margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <span style="font-size:24px;">${cat?.icon || 'üì¶'}</span>
                            <div>
                                <div style="font-weight:700;">${cat?.name || 'Cat√©gorie inconnue'}</div>
                                <div style="font-size:12px;" class="text-muted">${pl ? `Liste: ${pl.name}` : 'Toutes les listes'}</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:6px;">
                            <button class="action-btn" onclick="editDiscount(${d.id})">‚úèÔ∏è</button>
                            <button class="action-btn delete" onclick="deleteDiscount(${d.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div>${tiersHtml || '<span class="text-muted">Aucun palier d√©fini</span>'}</div>
                </div>
                `;
            }).join('') || '<p class="text-muted" style="text-align:center; padding:40px;">Aucune r√®gle de rabais configur√©e</p>';
        }

        function showDiscountForm() {
            document.getElementById('disc-form').style.display = 'block';
            document.getElementById('disc-edit-id').value = '';
            document.getElementById('disc-category').value = '';
            document.getElementById('disc-pricelist').value = '';
            document.getElementById('disc-tiers').innerHTML = createTierRow();
        }

        function hideDiscountForm() {
            document.getElementById('disc-form').style.display = 'none';
        }

        function createTierRow(qty = '', pct = '') {
            return `
            <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center;">
                <input type="number" placeholder="D√®s X pi√®ces" class="disc-qty form-input" value="${qty}">
                <input type="number" step="0.1" placeholder="% rabais" class="disc-pct form-input" value="${pct}">
                <button type="button" class="btn btn-danger" onclick="removeDiscountTier(this)" style="padding:8px 12px;">‚úï</button>
            </div>
            `;
        }

        function addDiscountTier() {
            const container = document.getElementById('disc-tiers');
            const div = document.createElement('div');
            div.innerHTML = createTierRow();
            container.appendChild(div.firstElementChild);
        }

        function removeDiscountTier(btn) {
            const rows = document.querySelectorAll('#disc-tiers > div');
            if (rows.length > 1) btn.parentElement.remove();
        }

        function editDiscount(id) {
            const d = ArticlesData.discounts.find(x => x.id === id);
            if (!d) return;
            
            document.getElementById('disc-form').style.display = 'block';
            document.getElementById('disc-edit-id').value = id;
            document.getElementById('disc-category').value = d.categoryId || '';
            document.getElementById('disc-pricelist').value = d.pricelistId || '';
            
            const container = document.getElementById('disc-tiers');
            container.innerHTML = (d.tiers || []).map(t => createTierRow(t.qty, t.pct)).join('') || createTierRow();
        }

        function saveDiscount() {
            const id = document.getElementById('disc-edit-id').value;
            const categoryId = parseInt(document.getElementById('disc-category').value);
            
            if (!categoryId) {
                showToast('Cat√©gorie requise', 'error');
                return;
            }
            
            const tiers = [];
            document.querySelectorAll('#disc-tiers > div').forEach(row => {
                const qty = parseInt(row.querySelector('.disc-qty').value);
                const pct = parseFloat(row.querySelector('.disc-pct').value);
                if (qty > 0 && pct > 0) tiers.push({ qty, pct });
            });
            tiers.sort((a, b) => a.qty - b.qty);
            
            const disc = {
                id: id ? parseInt(id) : Date.now(),
                categoryId: categoryId,
                pricelistId: parseInt(document.getElementById('disc-pricelist').value) || null,
                tiers: tiers
            };
            
            if (id) {
                const idx = ArticlesData.discounts.findIndex(d => d.id === parseInt(id));
                if (idx !== -1) ArticlesData.discounts[idx] = disc;
            } else {
                ArticlesData.discounts.push(disc);
            }
            
            saveToLocalStorage();
            hideDiscountForm();
            renderDiscountsGrid();
            updateStats();
            showToast('R√®gle enregistr√©e', 'success');
        }

        function deleteDiscount(id) {
            if (!confirm('Supprimer cette r√®gle ?')) return;
            ArticlesData.discounts = ArticlesData.discounts.filter(d => d.id !== id);
            saveToLocalStorage();
            renderDiscountsGrid();
            updateStats();
            showToast('R√®gle supprim√©e', 'success');
        }

        // ============================================
        // IMPORT / EXPORT
        // ============================================
        function exportArticlesCSV() {
            const headers = ['Num√©ro article', 'Description', 'Nom 2 fran√ßais', 'Unit√© de la quantit√©', 'PV hors TVA', 'PV inclus TVA', 'Stock actuel', 'PA hors TVA', 'PA inclus TVA', 'Quantit√© achet√©e', 'Stock par d√©faut', 'Code TVA - Recettes', 'Code barre'];
            
            const rows = ArticlesData.articles.map(a => {
                const tvaRate = (a.tva || 2.6) / 100;
                const pvTTC = a.priceB2C ? (a.priceB2C * (1 + tvaRate)).toFixed(2) + '  CHF' : '';
                const pvHT = a.priceB2C ? a.priceB2C.toFixed(2) + '  CHF' : '';
                const paTTC = a.cost ? (a.cost * (1 + tvaRate)).toFixed(2) + '  CHF' : '';
                const paHT = a.cost ? a.cost.toFixed(2) + '  CHF' : '';
                
                let unite = a.unit || 'Pi√®ce';
                if (unite === 'kg') unite = 'Kilo';
                if (unite === 'pce') unite = 'Pi√®ce';
                if (unite === 'l') unite = 'Litre';
                
                return [
                    a.num || '',
                    a.name || '',
                    a.origin || a.latin || '',
                    unite,
                    pvHT, pvTTC,
                    a.stock !== undefined ? a.stock : '',
                    paHT, paTTC,
                    a.qtyPurchased || '',
                    a.stockDefault || '',
                    a.tvaCode || '',
                    a.barcode || ''
                ].map(v => `${v}`).join(';');
            });
            
            const csv = [headers.join(';'), ...rows].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Articles_export_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
            showToast('Export termin√©', 'success');
        }

        function importArticlesFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                let content = e.target.result;
                content = fixEncoding(content);
                
                const lines = content.split('\n').filter(l => l.trim());
                let added = 0, updated = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(';').map(c => c.replace(/"/g, '').trim());
                    if (cols.length < 2 || !cols[1]) continue;
                    
                    const parsePrice = (str) => {
                        if (!str) return 0;
                        return parseFloat(str.replace(/CHF/gi, '').replace(/\s/g, '').replace(',', '.')) || 0;
                    };
                    
                    let unit = (cols[3] || 'pce').toLowerCase();
                    if (unit.includes('kilo') || unit === 'kg') unit = 'kg';
                    else if (unit.includes('pi√®ce') || unit.includes('piece')) unit = 'pce';
                    else if (unit.includes('litre')) unit = 'l';
                    else unit = 'pce';
                    
                    const articleData = {
                        num: cols[0] || String(Date.now() + i).slice(-6),
                        name: cols[1],
                        origin: cols[2] || '',
                        latin: '',
                        categoryId: null,
                        lot: '',
                        pcs: 1,
                        unit: unit,
                        priceB2C: parsePrice(cols[4]),
                        priceB2B: parsePrice(cols[4]) * 0.85,
                        cost: parsePrice(cols[7]),
                        stock: parseFloat(cols[6]) || 0,
                        stockDefault: parseFloat(cols[10]) || 0,
                        tvaCode: cols[11] || '',
                        barcode: cols[12] || '',
                        tva: 2.6,
                        active: true
                    };
                    
                    const existingIdx = ArticlesData.articles.findIndex(a => a.num === articleData.num);
                    if (existingIdx !== -1) {
                        articleData.id = ArticlesData.articles[existingIdx].id;
                        ArticlesData.articles[existingIdx] = articleData;
                        updated++;
                    } else {
                        articleData.id = Date.now() + i;
                        ArticlesData.articles.push(articleData);
                        added++;
                    }
                }
                
                saveToLocalStorage();
                renderArticlesTable();
                updateStats();
                
                showToast(`Import: ${added} ajout√©s, ${updated} mis √† jour`, 'success');
            };
            reader.readAsText(file, 'ISO-8859-1');
            input.value = '';
        }

        function fixEncoding(str) {
            const replacements = {
                '√É¬©': '√©', '√É¬®': '√®', '√É¬™': '√™', '√É¬´': '√´',
                '√É ': '√†', '√É¬¢': '√¢', '√É¬§': '√§',
                '√É¬π': '√π', '√É¬ª': '√ª', '√É¬º': '√º',
                '√É¬Æ': '√Æ', '√É¬Ø': '√Ø', '√É¬¥': '√¥',
                '√É¬ß': '√ß'
            };
            for (const [bad, good] of Object.entries(replacements)) {
                str = str.split(bad).join(good);
            }
            return str;
        }

        // ============================================
        // DROPBOX
        // ============================================
        async function saveAllToDropbox() {
            // R√©cup√©rer les tokens depuis TRAKIO principal
            const dropboxData = localStorage.getItem('trakio_dropbox');
            if (!dropboxData) {
                showToast('Dropbox non configur√©. Connectez-vous depuis TRAKIO principal.', 'error');
                return;
            }
            
            showToast('Sauvegarde Dropbox en cours...', 'warning');
            updateSyncStatus('syncing');
            
            // Ici on utiliserait l'API Dropbox - pour l'instant on simule
            setTimeout(() => {
                updateSyncStatus('success');
                showToast('Articles sauvegard√©s sur Dropbox', 'success');
            }, 1500);
        }

        // ============================================
        // MODAL
        // ============================================
        function closeDetailModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }

        // Fermer modal sur clic ext√©rieur
        document.getElementById('detail-modal').addEventListener('click', function(e) {
            if (e.target === this) closeDetailModal();
        });

        // ============================================
        // TOAST
        // ============================================
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // CALCUL PRIX AVEC RABAIS (pour autres modules)
        // ============================================
        function calculatePriceWithDiscount(article, qty, clientType, pricelistId) {
            let basePrice = clientType === 'b2c' ? article.priceB2C : article.priceB2B;
            
            if (pricelistId) {
                const pl = ArticlesData.pricelists.find(p => p.id === pricelistId);
                if (pl && pl.discount > 0) {
                    basePrice = basePrice * (1 - pl.discount / 100);
                }
            }
            
            const discount = ArticlesData.discounts.find(d =>
                d.categoryId === article.categoryId &&
                (!d.pricelistId || d.pricelistId === pricelistId)
            );
            
            if (discount && discount.tiers) {
                const applicableTier = discount.tiers
                    .filter(t => qty >= t.qty)
                    .sort((a, b) => b.qty - a.qty)[0];
                
                if (applicableTier) {
                    basePrice = basePrice * (1 - applicableTier.pct / 100);
                }
            }
            
            return basePrice;
        }

        // ============================================
        // IMPORT CSV AVANC√â
        // ============================================
        let csvData = null;
        let csvHeaders = [];
        let importModeCSV = 'update';
        let columnMapping = {};

        const ARTICLE_FIELDS = [
            { key: 'num', label: 'N¬∞ Article', required: true },
            { key: 'name', label: 'D√©signation', required: true },
            { key: 'origin', label: 'Origine' },
            { key: 'latin', label: 'Nom latin' },
            { key: 'unit', label: 'Unit√©' },
            { key: 'priceB2C', label: 'Prix B2C HT' },
            { key: 'priceB2B', label: 'Prix B2B HT' },
            { key: 'cost', label: 'Prix achat HT' },
            { key: 'stock', label: 'Stock' },
            { key: 'tva', label: 'TVA %' },
            { key: 'barcode', label: 'Code barre' },
            { key: 'ignore', label: '‚Äî Ignorer ‚Äî' }
        ];

        // Initialisation drag & drop
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('csvFileInput');

            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });

                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleCSVFile(files[0]);
                    }
                });
            }

            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleCSVFile(e.target.files[0]);
                    }
                });
            }
        });

        function handleCSVFile(file) {
            if (!file.name.match(/\.(csv|txt)$/i)) {
                showToast('Format non support√©. Utilisez un fichier CSV.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                let content = fixEncoding(e.target.result);
                parseCSV(content, file.name);
            };
            reader.readAsText(file, 'ISO-8859-1');
        }

        function parseCSV(content, fileName) {
            const separator = content.includes(';') ? ';' : ',';
            const lines = content.split('\n').filter(l => l.trim());
            
            if (lines.length < 2) {
                showToast('Le fichier doit contenir au moins un en-t√™te et une ligne de donn√©es', 'error');
                return;
            }

            csvHeaders = lines[0].split(separator).map(h => h.replace(/"/g, '').trim());
            csvData = [];

            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(separator).map(c => c.replace(/"/g, '').trim());
                if (cols.length >= 2 && cols.some(c => c)) {
                    csvData.push(cols);
                }
            }

            // Afficher infos fichier
            document.getElementById('fileInfo').classList.add('visible');
            document.getElementById('fileName').textContent = 'üìÑ ' + fileName;
            document.getElementById('rowCount').textContent = csvData.length;
            document.getElementById('colCount').textContent = csvHeaders.length;

            // Auto-mapping des colonnes
            autoMapColumns();
            
            // Afficher mapping
            renderMapping();
            
            // Afficher preview
            renderPreview();

            // Activer bouton import
            document.getElementById('btnImport').disabled = false;
            document.getElementById('noPreview').style.display = 'none';
            document.getElementById('previewContainer').style.display = 'block';
            document.getElementById('mappingContainer').style.display = 'block';
        }

        function autoMapColumns() {
            columnMapping = {};
            
            const mappings = {
                'num': ['num√©ro', 'numero', 'n¬∞', 'article', 'ref', 'r√©f√©rence', 'code'],
                'name': ['d√©signation', 'designation', 'nom', 'name', 'description', 'libell√©', 'libelle'],
                'origin': ['origine', 'origin', 'provenance', 'nom 2'],
                'latin': ['latin', 'scientifique', 'esp√®ce'],
                'unit': ['unit√©', 'unite', 'unit', 'mesure'],
                'priceB2C': ['prix', 'pv', 'vente', 'b2c', 'ttc', 'ht'],
                'cost': ['achat', 'pa', 'co√ªt', 'cout'],
                'stock': ['stock', 'qt√©', 'quantit√©', 'quantity'],
                'tva': ['tva', 'taxe', 'vat'],
                'barcode': ['barre', 'ean', 'barcode', 'gtin', 'code-barre']
            };

            csvHeaders.forEach((header, idx) => {
                const headerLower = header.toLowerCase();
                for (const [field, keywords] of Object.entries(mappings)) {
                    if (keywords.some(kw => headerLower.includes(kw))) {
                        if (!Object.values(columnMapping).includes(field)) {
                            columnMapping[idx] = field;
                            break;
                        }
                    }
                }
                if (!columnMapping[idx]) {
                    columnMapping[idx] = 'ignore';
                }
            });
        }

        function renderMapping() {
            const container = document.getElementById('mappingRows');
            container.innerHTML = '';

            csvHeaders.forEach((header, idx) => {
                const row = document.createElement('div');
                row.className = 'mapping-row';
                
                const options = ARTICLE_FIELDS.map(f => 
                    `<option value="${f.key}" ${columnMapping[idx] === f.key ? 'selected' : ''}>${f.label}${f.required ? ' *' : ''}</option>`
                ).join('');

                row.innerHTML = `
                    <span class="mapping-csv-col">${header}</span>
                    <span class="mapping-arrow">‚Üí</span>
                    <select class="mapping-select" onchange="updateMapping(${idx}, this.value)">
                        ${options}
                    </select>
                `;
                container.appendChild(row);
            });
        }

        function updateMapping(idx, value) {
            columnMapping[idx] = value;
        }

        function renderPreview() {
            const thead = document.getElementById('previewHead');
            const tbody = document.getElementById('previewBody');

            // Headers
            thead.innerHTML = '<tr>' + csvHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';

            // Body (max 10 lignes)
            tbody.innerHTML = csvData.slice(0, 10).map(row => 
                '<tr>' + row.map(cell => `<td title="${cell}">${cell}</td>`).join('') + '</tr>'
            ).join('');

            if (csvData.length > 10) {
                tbody.innerHTML += `<tr><td colspan="${csvHeaders.length}" style="text-align:center; color:var(--text-muted);">... et ${csvData.length - 10} autres lignes</td></tr>`;
            }
        }

        function selectImportMode(mode) {
            importModeCSV = mode;
            document.querySelectorAll('.import-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('input[type="radio"]').checked = false;
            });
            const selected = document.querySelector(`.import-option input[value="${mode}"]`);
            if (selected) {
                selected.checked = true;
                selected.closest('.import-option').classList.add('selected');
            }
        }

        function executeImport() {
            if (!csvData || csvData.length === 0) {
                showToast('Aucune donn√©e √† importer', 'error');
                return;
            }

            // V√©rifier champs requis
            const numCol = Object.entries(columnMapping).find(([k, v]) => v === 'num');
            const nameCol = Object.entries(columnMapping).find(([k, v]) => v === 'name');

            if (!numCol && !nameCol) {
                showToast('Mappez au moins N¬∞ Article ou D√©signation', 'error');
                return;
            }

            let added = 0, updated = 0, errors = 0;

            if (importModeCSV === 'replace') {
                ArticlesData.articles = [];
            }

            csvData.forEach((row, rowIndex) => {
                try {
                    const articleData = {
                        id: Date.now() + rowIndex,
                        num: '',
                        name: '',
                        origin: '',
                        latin: '',
                        categoryId: null,
                        lot: '',
                        pcs: 1,
                        unit: 'pce',
                        priceB2C: 0,
                        priceB2B: 0,
                        cost: 0,
                        stock: 0,
                        stockDefault: 0,
                        tva: 2.6,
                        barcode: '',
                        active: true
                    };

                    // Appliquer mapping
                    Object.entries(columnMapping).forEach(([colIdx, field]) => {
                        if (field !== 'ignore' && row[colIdx] !== undefined) {
                            const value = row[colIdx];
                            
                            switch(field) {
                                case 'num':
                                case 'name':
                                case 'origin':
                                case 'latin':
                                case 'barcode':
                                    articleData[field] = value;
                                    break;
                                case 'unit':
                                    let unit = value.toLowerCase();
                                    if (unit.includes('kilo') || unit === 'kg') unit = 'kg';
                                    else if (unit.includes('litre')) unit = 'l';
                                    else unit = 'pce';
                                    articleData.unit = unit;
                                    break;
                                case 'priceB2C':
                                case 'priceB2B':
                                case 'cost':
                                case 'stock':
                                case 'tva':
                                    const num = parseFloat(value.replace(/[^\d.,\-]/g, '').replace(',', '.'));
                                    if (!isNaN(num)) articleData[field] = num;
                                    break;
                            }
                        }
                    });

                    // G√©n√©rer N¬∞ si vide
                    if (!articleData.num) {
                        articleData.num = 'IMP' + String(Date.now() + rowIndex).slice(-6);
                    }

                    // G√©n√©rer nom si vide
                    if (!articleData.name) {
                        articleData.name = 'Article ' + articleData.num;
                    }

                    // Calculer prix B2B si vide
                    if (articleData.priceB2C > 0 && articleData.priceB2B === 0) {
                        articleData.priceB2B = articleData.priceB2C * 0.85;
                    }

                    // Chercher doublon
                    const existingIdx = ArticlesData.articles.findIndex(a => a.num === articleData.num);
                    
                    if (existingIdx !== -1) {
                        articleData.id = ArticlesData.articles[existingIdx].id;
                        ArticlesData.articles[existingIdx] = articleData;
                        updated++;
                    } else {
                        ArticlesData.articles.push(articleData);
                        added++;
                    }
                } catch(err) {
                    errors++;
                    console.error('Erreur ligne ' + (rowIndex + 2), err);
                }
            });

            // Sauvegarder
            saveToLocalStorage();
            renderArticlesTable();
            updateStats();

            // Afficher r√©sultat
            const result = document.getElementById('importResult');
            result.className = 'import-result success';
            document.getElementById('importResultTitle').textContent = '‚úÖ Import termin√© !';
            document.getElementById('importResultMessage').textContent = 
                importModeCSV === 'replace' ? 'Base articles remplac√©e' : 'Articles mis √† jour';
            document.getElementById('statAdded').textContent = added;
            document.getElementById('statUpdated').textContent = updated;
            document.getElementById('statErrors').textContent = errors;

            showToast(`Import: ${added} ajout√©s, ${updated} mis √† jour`, 'success');
        }

        function resetImport() {
            csvData = null;
            csvHeaders = [];
            columnMapping = {};

            document.getElementById('csvFileInput').value = '';
            document.getElementById('fileInfo').classList.remove('visible');
            document.getElementById('btnImport').disabled = true;
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('mappingContainer').style.display = 'none';
            document.getElementById('noPreview').style.display = 'block';
            document.getElementById('importResult').className = 'import-result';
            document.getElementById('previewHead').innerHTML = '';
            document.getElementById('previewBody').innerHTML = '';
            document.getElementById('mappingRows').innerHTML = '';
        }
    </script>
</body>
</html>

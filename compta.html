<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO v4.5.0 - ComptabilitÃ©</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“’</text></svg>">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="trakio-config.js?v=4.5.0"></script>
    <script src="trakio-sync.js?v=4.5.0"></script>
    <script src="trakio-ui.js?v=4.5.0"></script>
    <style>
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 15px; }
        .page-title { font-size: 26px; font-weight: 700; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .kpi-card { background: var(--trakio-bg-card); border: 1px solid var(--trakio-border); border-radius: 16px; padding: 20px; }
        .kpi-label { font-size: 13px; color: var(--trakio-text-muted); margin-bottom: 8px; }
        .kpi-value { font-size: 28px; font-weight: 700; }
        .kpi-value.green { color: var(--trakio-success); }
        .kpi-value.red { color: var(--trakio-error); }
        .kpi-value.blue { color: var(--trakio-primary); }
        .card { background: var(--trakio-bg-card); border: 1px solid var(--trakio-border); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 18px; font-weight: 600; }
        .btn { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-primary { background: var(--trakio-primary); color: white; }
        .btn-secondary { background: var(--trakio-bg-input); color: var(--trakio-text); border: 1px solid var(--trakio-border); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--trakio-border); }
        th { background: var(--trakio-bg-input); font-size: 12px; color: var(--trakio-text-muted); text-transform: uppercase; }
        .amount.positive { color: var(--trakio-success); }
        .amount.negative { color: var(--trakio-error); }
        .type-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .type-badge.income { background: rgba(16, 185, 129, 0.2); color: var(--trakio-success); }
        .type-badge.expense { background: rgba(239, 68, 68, 0.2); color: var(--trakio-error); }
        .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filters select, .filters input { padding: 10px 14px; background: var(--trakio-bg-input); border: 1px solid var(--trakio-border); border-radius: 8px; color: var(--trakio-text); }
        .empty { text-align: center; padding: 40px; color: var(--trakio-text-muted); }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">ðŸ“’ ComptabilitÃ©</h1>
            <button class="btn btn-primary" onclick="exportData()">ðŸ“¥ Exporter</button>
        </div>
        <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-label">Recettes (mois)</div><div class="kpi-value green" id="kpi-income">CHF 0</div></div>
            <div class="kpi-card"><div class="kpi-label">DÃ©penses (mois)</div><div class="kpi-value red" id="kpi-expense">CHF 0</div></div>
            <div class="kpi-card"><div class="kpi-label">BÃ©nÃ©fice net</div><div class="kpi-value blue" id="kpi-profit">CHF 0</div></div>
            <div class="kpi-card"><div class="kpi-label">Ventes (mois)</div><div class="kpi-value" id="kpi-sales">0</div></div>
        </div>
        <div class="card">
            <div class="card-header"><h2 class="card-title">ðŸ“Š Transactions</h2></div>
            <div class="filters">
                <select id="filter-type" onchange="loadTransactions()"><option value="all">Tous types</option><option value="income">Recettes</option><option value="expense">DÃ©penses</option></select>
                <input type="month" id="filter-month" onchange="loadTransactions()">
            </div>
            <table>
                <thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Montant</th></tr></thead>
                <tbody id="transactions-body"><tr><td colspan="4" class="empty">Chargement...</td></tr></tbody>
            </table>
        </div>
    </div>
    <script>
        let transactionsData = [], ventesData = [];
        document.addEventListener('DOMContentLoaded', () => { document.getElementById('filter-month').value = new Date().toISOString().slice(0, 7); setTimeout(loadData, 300); });
        async function loadData() {
            [transactionsData, ventesData] = await Promise.all([DataStore.compta.getAll(), DataStore.ventes.getAll()]);
            updateKPIs(); loadTransactions();
        }
        function updateKPIs() {
            const month = document.getElementById('filter-month').value;
            const monthVentes = ventesData.filter(v => v.createdAt?.startsWith(month));
            const income = monthVentes.reduce((s, v) => s + (v.total || 0), 0);
            const expenses = transactionsData.filter(t => t.type === 'expense' && t.date?.startsWith(month)).reduce((s, t) => s + (t.amount || 0), 0);
            document.getElementById('kpi-income').textContent = formatCHF(income);
            document.getElementById('kpi-expense').textContent = formatCHF(expenses);
            document.getElementById('kpi-profit').textContent = formatCHF(income - expenses);
            document.getElementById('kpi-sales').textContent = monthVentes.length;
        }
        function loadTransactions() {
            const type = document.getElementById('filter-type').value;
            const month = document.getElementById('filter-month').value;
            let all = [...transactionsData.map(t => ({ ...t, isVente: false })), ...ventesData.map(v => ({ date: v.createdAt, description: 'Vente ' + (v.source || 'caisse'), type: 'income', amount: v.total, isVente: true }))];
            if (month) all = all.filter(t => t.date?.startsWith(month) || t.createdAt?.startsWith(month));
            if (type !== 'all') all = all.filter(t => t.type === type);
            all.sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt));
            const tbody = document.getElementById('transactions-body');
            if (all.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="empty">Aucune transaction</td></tr>'; return; }
            tbody.innerHTML = all.slice(0, 50).map(t => '<tr><td>'+formatDate(t.date || t.createdAt)+'</td><td>'+t.description+'</td><td><span class="type-badge '+t.type+'">'+(t.type === 'income' ? 'Recette' : 'DÃ©pense')+'</span></td><td class="amount '+(t.type === 'income' ? 'positive' : 'negative')+'">'+(t.type === 'income' ? '+' : '-')+formatCHF(t.amount)+'</td></tr>').join('');
        }
        function exportData() { TrakioUI.showToast('ðŸ“¥ Export en cours...', 'info'); }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO v4.5.0 - Tra√ßabilit√©</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè∑Ô∏è</text></svg>">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="trakio-config.js?v=4.5.0"></script>
    <script src="trakio-sync.js?v=4.5.0"></script>
    <script src="trakio-ui.js?v=4.5.0"></script>
    <style>
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .page-title { font-size: 26px; font-weight: 700; margin-bottom: 24px; }
        .layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 1000px) { .layout { grid-template-columns: 1fr; } }
        .card { background: var(--trakio-bg-card); border: 1px solid var(--trakio-border); border-radius: 16px; padding: 20px; }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; color: var(--trakio-text-muted); margin-bottom: 6px; }
        .form-group input, .form-group select { width: 100%; padding: 10px 14px; background: var(--trakio-bg-input); border: 1px solid var(--trakio-border); border-radius: 8px; color: var(--trakio-text); font-size: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .quick-btns { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .quick-btn { padding: 10px 16px; background: var(--trakio-bg-input); border: none; border-radius: 8px; color: var(--trakio-text); cursor: pointer; font-size: 13px; }
        .quick-btn:hover { background: var(--trakio-primary); }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-primary { background: var(--trakio-primary); color: white; }
        .btn-success { background: var(--trakio-success); color: white; }
        .label-preview { background: white; color: #000; border-radius: 8px; padding: 20px; width: 300px; margin: 20px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .label-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .label-company { font-weight: 700; font-size: 14px; }
        .label-lot { font-size: 10px; color: #666; }
        .label-product { font-size: 16px; font-weight: 700; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #ccc; }
        .label-info { font-size: 11px; margin-bottom: 5px; }
        .label-qr { width: 60px; height: 60px; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .history-list { max-height: 400px; overflow-y: auto; }
        .history-item { padding: 12px; background: var(--trakio-bg-input); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .history-name { font-weight: 600; font-size: 14px; }
        .history-date { font-size: 12px; color: var(--trakio-text-muted); }
        .history-reprint { padding: 6px 12px; background: var(--trakio-bg-hover); border: none; border-radius: 6px; color: var(--trakio-text); cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title">üè∑Ô∏è Tra√ßabilit√© - √âtiquettes</h1>
        <div class="layout">
            <div class="card">
                <h3 class="card-title">üìù Nouvelle √©tiquette</h3>
                <div class="quick-btns" id="quick-btns"></div>
                <div class="form-group"><label>Produit *</label><input type="text" id="label-product" placeholder="Nom du produit"></div>
                <div class="form-row">
                    <div class="form-group"><label>Origine</label><input type="text" id="label-origin" placeholder="Atlantique Nord"></div>
                    <div class="form-group"><label>Zone FAO</label><input type="text" id="label-fao" placeholder="27"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Type</label><select id="label-type"><option value="sauvage">Sauvage</option><option value="elevage">√âlevage</option></select></div>
                    <div class="form-group"><label>Conservation</label><input type="text" id="label-conservation" value="0-4¬∞C"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Date r√©ception</label><input type="date" id="label-date"></div>
                    <div class="form-group"><label>DLC</label><input type="date" id="label-dlc"></div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateLabel()">üëÅÔ∏è Aper√ßu</button>
                    <button class="btn btn-success" onclick="printLabel()">üñ®Ô∏è Imprimer</button>
                </div>
            </div>
            <div>
                <div class="card" style="margin-bottom: 20px;">
                    <h3 class="card-title">üëÅÔ∏è Aper√ßu √©tiquette</h3>
                    <div class="label-preview" id="label-preview">
                        <div class="label-header"><div><div class="label-company">Borex Poissons</div><div class="label-lot" id="preview-lot">LOT: -</div></div><div class="label-qr">QR</div></div>
                        <div class="label-product" id="preview-product">-</div>
                        <div class="label-info"><strong>Origine:</strong> <span id="preview-origin">-</span></div>
                        <div class="label-info"><strong>Zone FAO:</strong> <span id="preview-fao">-</span></div>
                        <div class="label-info"><strong>Type:</strong> <span id="preview-type">-</span></div>
                        <div class="label-info"><strong>Conservation:</strong> <span id="preview-conservation">-</span></div>
                        <div class="label-info"><strong>DLC:</strong> <span id="preview-dlc">-</span></div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">üìú Historique</h3>
                    <div class="history-list" id="history-list"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let historyData = [];
        const quickProducts = ['Saumon', 'Bar', 'Dorade', 'Cabillaud', 'Thon', 'Crevettes', 'Moules', 'Hu√Ætres'];
        document.addEventListener('DOMContentLoaded', () => setTimeout(init, 300));
        async function init() {
            document.getElementById('label-date').value = new Date().toISOString().slice(0, 10);
            const dlc = new Date(); dlc.setDate(dlc.getDate() + 3);
            document.getElementById('label-dlc').value = dlc.toISOString().slice(0, 10);
            document.getElementById('quick-btns').innerHTML = quickProducts.map(p => '<button class="quick-btn" onclick="setProduct(\''+p+'\')">'+p+'</button>').join('');
            historyData = await DataStore.etiquettes.getAll();
            renderHistory();
        }
        function setProduct(name) { document.getElementById('label-product').value = name; generateLabel(); }
        function generateLabel() {
            const product = document.getElementById('label-product').value || '-';
            const origin = document.getElementById('label-origin').value || '-';
            const fao = document.getElementById('label-fao').value || '-';
            const type = document.getElementById('label-type').value;
            const conservation = document.getElementById('label-conservation').value || '-';
            const dlc = document.getElementById('label-dlc').value;
            const lot = 'LC-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-' + String(Math.floor(Math.random()*1000)).padStart(3,'0');
            document.getElementById('preview-lot').textContent = 'LOT: ' + lot;
            document.getElementById('preview-product').textContent = product;
            document.getElementById('preview-origin').textContent = origin;
            document.getElementById('preview-fao').textContent = fao;
            document.getElementById('preview-type').textContent = type === 'sauvage' ? 'Sauvage' : '√âlevage';
            document.getElementById('preview-conservation').textContent = conservation;
            document.getElementById('preview-dlc').textContent = dlc ? formatDate(dlc) : '-';
        }
        async function printLabel() {
            const data = { product: document.getElementById('label-product').value, origin: document.getElementById('label-origin').value, fao: document.getElementById('label-fao').value, type: document.getElementById('label-type').value, conservation: document.getElementById('label-conservation').value, dlc: document.getElementById('label-dlc').value, lot: document.getElementById('preview-lot').textContent.replace('LOT: ', '') };
            if (!data.product) { TrakioUI.showToast('‚ùå Produit requis', 'error'); return; }
            await DataStore.etiquettes.save(null, data);
            TrakioUI.showToast('üñ®Ô∏è √âtiquette imprim√©e', 'success');
            historyData = await DataStore.etiquettes.getAll();
            renderHistory();
        }
        function renderHistory() {
            const sorted = historyData.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 20);
            document.getElementById('history-list').innerHTML = sorted.map(h => '<div class="history-item"><div><div class="history-name">'+h.product+'</div><div class="history-date">'+formatDateTime(h.createdAt)+' ‚Ä¢ '+h.lot+'</div></div><button class="history-reprint" onclick="reprint(\''+h.id+'\')">üñ®Ô∏è</button></div>').join('') || '<div style="text-align:center;color:var(--trakio-text-muted);padding:20px;">Aucun historique</div>';
        }
        function reprint(id) { const h = historyData.find(x => x.id === id); if (h) { document.getElementById('label-product').value = h.product || ''; document.getElementById('label-origin').value = h.origin || ''; document.getElementById('label-fao').value = h.fao || ''; document.getElementById('label-type').value = h.type || 'sauvage'; document.getElementById('label-conservation').value = h.conservation || ''; document.getElementById('label-dlc').value = h.dlc || ''; generateLabel(); } }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO v5.0.0 - Clients</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë•</text></svg>">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- TRAKIO Core (√† la racine) -->
    <script src="trakio-config.js"></script>
    <script src="trakio-ui.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --border: #475569;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --primary: #06b6d4;
            --primary-dark: #0891b2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        
        /* PAGE HEADER */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* BUTTONS */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), #14b8a6); 
            color: white; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(6, 182, 212, 0.3);
        }
        .btn-secondary { 
            background: var(--bg-input); 
            color: var(--text); 
            border: 1px solid var(--border); 
        }
        .btn-secondary:hover {
            background: var(--border);
        }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        /* TABS */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background: var(--bg-card);
            padding: 6px;
            border-radius: 14px;
            border: 1px solid var(--border);
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }
        
        .tab:hover { background: var(--bg-input); color: var(--text); }
        .tab.active { background: var(--primary); color: white; }
        
        .tab-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        /* STATS BAR */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-item {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 14px;
            border: 1px solid var(--border);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        /* TOOLBAR */
        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 280px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.15);
        }
        
        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }
        
        .toolbar select {
            padding: 14px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
        }
        
        /* CLIENTS GRID */
        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
        }
        
        .client-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .client-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border-color: var(--primary);
        }
        
        .client-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .client-avatar {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: white;
        }
        
        .client-avatar.b2b { background: linear-gradient(135deg, var(--primary), #14b8a6); }
        .client-avatar.b2c { background: linear-gradient(135deg, var(--purple), #ec4899); }
        
        .client-name {
            font-size: 18px;
            font-weight: 700;
        }
        
        .client-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .client-type-badge.b2b { background: rgba(6, 182, 212, 0.15); color: var(--primary); }
        .client-type-badge.b2c { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
        
        .client-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 14px;
            color: var(--text-muted);
        }
        
        .client-info-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .client-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        
        .client-stat {
            flex: 1;
            text-align: center;
        }
        
        .client-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--success);
        }
        
        .client-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 3px;
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .empty-state-text {
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        /* MODAL */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            padding: 20px;
        }
        
        .modal-overlay.open { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 550px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalIn 0.3s ease-out;
        }
        
        @keyframes modalIn {
            from { transform: scale(0.95) translateY(20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 24px;
            background: linear-gradient(135deg, var(--primary), #14b8a6);
            text-align: center;
        }
        
        .modal-header h2 {
            font-size: 22px;
            font-weight: 700;
        }
        
        .modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .form-group label.required::after {
            content: ' *';
            color: var(--danger);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        /* LOADING */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-muted);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .page-title { font-size: 22px; }
            .stats-bar { grid-template-columns: 1fr 1fr; }
            .clients-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- PAGE HEADER -->
        <div class="page-header">
            <h1 class="page-title">
                <span>üë•</span>
                <span>Clients</span>
            </h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openModal('add')">
                    <span>‚ûï</span>
                    <span>Nouveau client</span>
                </button>
                <button class="btn btn-secondary" onclick="exportClients()">
                    <span>üì•</span>
                    <span>Exporter CSV</span>
                </button>
                <button class="btn btn-secondary" onclick="importClientsCSV()">
                    <span>üì§</span>
                    <span>Importer</span>
                </button>
            </div>
        </div>
        
        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" onclick="setTab('all')" data-tab="all">
                <span>üë•</span>
                <span>Tous</span>
                <span class="tab-badge" id="count-all">0</span>
            </button>
            <button class="tab" onclick="setTab('b2b')" data-tab="b2b">
                <span>üè¢</span>
                <span>Professionnels</span>
                <span class="tab-badge" id="count-b2b">0</span>
            </button>
            <button class="tab" onclick="setTab('b2c')" data-tab="b2c">
                <span>üë§</span>
                <span>Particuliers</span>
                <span class="tab-badge" id="count-b2c">0</span>
            </button>
        </div>
        
        <!-- STATS -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total clients</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-b2b">0</div>
                <div class="stat-label">Professionnels</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-b2c">0</div>
                <div class="stat-label">Particuliers</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-orders">0</div>
                <div class="stat-label">Total commandes</div>
            </div>
        </div>
        
        <!-- TOOLBAR -->
        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Rechercher un client..." oninput="filterClients()">
            </div>
            <select id="sortBy" onchange="filterClients()">
                <option value="name">Trier par nom</option>
                <option value="recent">Plus r√©cent</option>
                <option value="type">Par type</option>
            </select>
        </div>
        
        <!-- CLIENTS GRID -->
        <div class="clients-grid" id="clients-grid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Chargement des clients...</p>
            </div>
        </div>
    </div>
    
    <!-- MODAL CLIENT -->
    <div class="modal-overlay" id="clientModal" onclick="if(event.target === this) closeModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">‚ûï Nouveau client</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="required">Type de client</label>
                    <select id="client-type">
                        <option value="b2b">üè¢ Professionnel (B2B)</option>
                        <option value="b2c">üë§ Particulier (B2C)</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>N¬∞ Client</label>
                        <input type="text" id="client-num" placeholder="Auto-g√©n√©r√©">
                    </div>
                    <div class="form-group">
                        <label>Liste de prix</label>
                        <select id="client-pricelist">
                            <option value="standard">Standard</option>
                            <option value="pro">Professionnel</option>
                            <option value="vip">VIP</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="required">Nom / Soci√©t√©</label>
                    <input type="text" id="client-name" placeholder="Nom du client ou soci√©t√©">
                </div>
                
                <div class="form-group">
                    <label>Contact</label>
                    <input type="text" id="client-contact" placeholder="Personne de contact">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="client-email" placeholder="email@exemple.com">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone</label>
                        <input type="tel" id="client-phone" placeholder="+41 79 000 00 00">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Adresse</label>
                    <input type="text" id="client-address" placeholder="Rue et num√©ro">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>NPA</label>
                        <input type="text" id="client-npa" placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label>Localit√©</label>
                        <input type="text" id="client-city" placeholder="Ville">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="client-notes" rows="3" placeholder="Notes internes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveClient()">
                    <span>üíæ</span>
                    <span>Enregistrer</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ACTION MODAL -->
    <div class="modal-overlay" id="actionModal" onclick="if(event.target === this) closeActionModal()">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="action-client-name">Client</h2>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p id="action-client-info" style="color: var(--text-muted); margin-bottom: 20px;"></p>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-primary" onclick="createOrderForClient()" style="width: 100%; justify-content: center;">
                        ‚ö° Cr√©er une commande
                    </button>
                    <button class="btn btn-secondary" onclick="editClient()" style="width: 100%; justify-content: center;">
                        ‚úèÔ∏è Modifier la fiche
                    </button>
                    <button class="btn btn-danger" onclick="deleteClient()" style="width: 100%; justify-content: center;">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeActionModal()">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        // ============ DATA ============
        let clients = [];
        let currentTab = 'all';
        let editingId = null;
        let selectedClientId = null;
        
        // ============ STORAGE KEY ============
        const STORAGE_KEY = 'trakio_quickorder';
        
        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            loadClients();
        });
        
        // ============ LOAD CLIENTS ============
        function loadClients() {
            const stored = localStorage.getItem(STORAGE_KEY);
            clients = stored ? JSON.parse(stored) : [];
            updateStats();
            renderClients();
        }
        
        // ============ SAVE CLIENTS ============
        function saveClients() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(clients));
            updateStats();
        }
        
        // ============ UPDATE STATS ============
        function updateStats() {
            const b2b = clients.filter(c => c.type === 'b2b');
            const b2c = clients.filter(c => c.type === 'b2c');
            const totalOrders = clients.reduce((sum, c) => sum + (c.orders || 0), 0);
            
            document.getElementById('stat-total').textContent = clients.length;
            document.getElementById('stat-b2b').textContent = b2b.length;
            document.getElementById('stat-b2c').textContent = b2c.length;
            document.getElementById('stat-orders').textContent = totalOrders;
            
            document.getElementById('count-all').textContent = clients.length;
            document.getElementById('count-b2b').textContent = b2b.length;
            document.getElementById('count-b2c').textContent = b2c.length;
        }
        
        // ============ SET TAB ============
        function setTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            renderClients();
        }
        
        // ============ FILTER CLIENTS ============
        function filterClients() {
            renderClients();
        }
        
        // ============ RENDER CLIENTS ============
        function renderClients() {
            const grid = document.getElementById('clients-grid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const sort = document.getElementById('sortBy').value;
            
            let filtered = clients.filter(c => {
                // Tab filter
                if (currentTab !== 'all' && c.type !== currentTab) return false;
                
                // Search filter
                if (search) {
                    const searchStr = `${c.name} ${c.contact || ''} ${c.email || ''} ${c.phone || ''} ${c.city || ''}`.toLowerCase();
                    if (!searchStr.includes(search)) return false;
                }
                
                return true;
            });
            
            // Sort
            filtered.sort((a, b) => {
                switch (sort) {
                    case 'name': return (a.name || '').localeCompare(b.name || '');
                    case 'recent': return (b.createdAt || 0) - (a.createdAt || 0);
                    case 'type': return (a.type || '').localeCompare(b.type || '');
                    default: return 0;
                }
            });
            
            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon">üë•</div>
                        <div class="empty-state-text">Aucun client trouv√©</div>
                        <button class="btn btn-primary" onclick="openModal('add')">
                            ‚ûï Ajouter un client
                        </button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = filtered.map(client => {
                const initials = getInitials(client.name);
                return `
                    <div class="client-card" onclick="openActionModal('${client.id}')">
                        <div class="client-header">
                            <div class="client-avatar ${client.type}">${initials}</div>
                            <div>
                                <div class="client-name">${client.name}</div>
                                <span class="client-type-badge ${client.type}">
                                    ${client.type === 'b2b' ? 'üè¢ Pro' : 'üë§ Particulier'}
                                </span>
                            </div>
                        </div>
                        <div class="client-info">
                            ${client.contact ? `<div class="client-info-item">üë§ ${client.contact}</div>` : ''}
                            ${client.phone ? `<div class="client-info-item">üìû ${client.phone}</div>` : ''}
                            ${client.email ? `<div class="client-info-item">üìß ${client.email}</div>` : ''}
                            ${client.city ? `<div class="client-info-item">üìç ${client.npa || ''} ${client.city}</div>` : ''}
                        </div>
                        <div class="client-stats">
                            <div class="client-stat">
                                <div class="client-stat-value">${client.orders || 0}</div>
                                <div class="client-stat-label">Commandes</div>
                            </div>
                            <div class="client-stat">
                                <div class="client-stat-value">${formatCHF(client.totalSpent || 0)}</div>
                                <div class="client-stat-label">CA Total</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ============ GET INITIALS ============
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }
        
        // ============ FORMAT CHF ============
        function formatCHF(amount) {
            return (Math.round(amount * 20) / 20).toFixed(0) + ' CHF';
        }
        
        // ============ OPEN MODAL ============
        function openModal(mode, id = null) {
            editingId = id;
            const modal = document.getElementById('clientModal');
            const title = document.getElementById('modalTitle');
            
            if (mode === 'add') {
                title.textContent = '‚ûï Nouveau client';
                clearForm();
                document.getElementById('client-num').value = generateClientNum();
            } else if (mode === 'edit' && id) {
                title.textContent = '‚úèÔ∏è Modifier client';
                const client = clients.find(c => c.id === id);
                if (client) populateForm(client);
            }
            
            modal.classList.add('open');
        }
        
        // ============ CLOSE MODAL ============
        function closeModal() {
            document.getElementById('clientModal').classList.remove('open');
            editingId = null;
        }
        
        // ============ CLEAR FORM ============
        function clearForm() {
            ['type', 'num', 'name', 'contact', 'email', 'phone', 'address', 'npa', 'city', 'notes', 'pricelist'].forEach(field => {
                const el = document.getElementById('client-' + field);
                if (el) el.value = field === 'type' ? 'b2b' : (field === 'pricelist' ? 'standard' : '');
            });
        }
        
        // ============ POPULATE FORM ============
        function populateForm(client) {
            document.getElementById('client-type').value = client.type || 'b2b';
            document.getElementById('client-num').value = client.num || '';
            document.getElementById('client-name').value = client.name || '';
            document.getElementById('client-contact').value = client.contact || '';
            document.getElementById('client-email').value = client.email || '';
            document.getElementById('client-phone').value = client.phone || '';
            document.getElementById('client-address').value = client.address || '';
            document.getElementById('client-npa').value = client.npa || '';
            document.getElementById('client-city').value = client.city || '';
            document.getElementById('client-notes').value = client.notes || '';
            document.getElementById('client-pricelist').value = client.pricelist || 'standard';
        }
        
        // ============ SAVE CLIENT ============
        function saveClient() {
            const name = document.getElementById('client-name').value.trim();
            if (!name) {
                showTrakioToast('Le nom est obligatoire', 'error');
                return;
            }
            
            const clientData = {
                id: editingId || generateId(),
                type: document.getElementById('client-type').value,
                num: document.getElementById('client-num').value,
                name: name,
                contact: document.getElementById('client-contact').value,
                email: document.getElementById('client-email').value,
                phone: document.getElementById('client-phone').value,
                address: document.getElementById('client-address').value,
                npa: document.getElementById('client-npa').value,
                city: document.getElementById('client-city').value,
                notes: document.getElementById('client-notes').value,
                pricelist: document.getElementById('client-pricelist').value,
                updatedAt: Date.now()
            };
            
            if (editingId) {
                // Update existing
                const index = clients.findIndex(c => c.id === editingId);
                if (index !== -1) {
                    clientData.createdAt = clients[index].createdAt;
                    clientData.orders = clients[index].orders || 0;
                    clientData.totalSpent = clients[index].totalSpent || 0;
                    clients[index] = clientData;
                }
                showTrakioToast('Client modifi√© ‚úÖ', 'success');
            } else {
                // Add new
                clientData.createdAt = Date.now();
                clientData.orders = 0;
                clientData.totalSpent = 0;
                clients.push(clientData);
                showTrakioToast('Client ajout√© ‚úÖ', 'success');
            }
            
            saveClients();
            renderClients();
            closeModal();
        }
        
        // ============ GENERATE ID ============
        function generateId() {
            return 'cli_' + Date.now().toString(36) + Math.random().toString(36).substring(2, 8);
        }
        
        // ============ GENERATE CLIENT NUM ============
        function generateClientNum() {
            const nums = clients.map(c => parseInt(c.num) || 0);
            const max = nums.length > 0 ? Math.max(...nums) : 0;
            return String(max + 1).padStart(4, '0');
        }
        
        // ============ ACTION MODAL ============
        function openActionModal(id) {
            selectedClientId = id;
            const client = clients.find(c => c.id === id);
            if (!client) return;
            
            document.getElementById('action-client-name').textContent = client.name;
            document.getElementById('action-client-info').innerHTML = `
                ${client.type === 'b2b' ? 'üè¢ Professionnel' : 'üë§ Particulier'}<br>
                ${client.phone || client.email || ''}
            `;
            
            document.getElementById('actionModal').classList.add('open');
        }
        
        function closeActionModal() {
            document.getElementById('actionModal').classList.remove('open');
            selectedClientId = null;
        }
        
        // ============ CREATE ORDER ============
        function createOrderForClient() {
            if (!selectedClientId) return;
            // Store selected client for commandes module
            sessionStorage.setItem('trakio_selected_client', selectedClientId);
            window.location.href = 'commandes.html';
        }
        
        // ============ EDIT CLIENT ============
        function editClient() {
            if (!selectedClientId) return;
            closeActionModal();
            openModal('edit', selectedClientId);
        }
        
        // ============ DELETE CLIENT ============
        function deleteClient() {
            if (!selectedClientId) return;
            if (!confirm('Supprimer ce client ?')) return;
            
            clients = clients.filter(c => c.id !== selectedClientId);
            saveClients();
            renderClients();
            closeActionModal();
            showTrakioToast('Client supprim√©', 'warning');
        }
        
        // ============ EXPORT CSV ============
        function exportClients() {
            if (clients.length === 0) {
                showTrakioToast('Aucun client √† exporter', 'warning');
                return;
            }
            
            const headers = ['N¬∞', 'Type', 'Nom', 'Contact', 'Email', 'T√©l√©phone', 'Adresse', 'NPA', 'Ville', 'Liste Prix', 'Commandes', 'CA Total'];
            const rows = clients.map(c => [
                c.num || '',
                c.type || '',
                c.name || '',
                c.contact || '',
                c.email || '',
                c.phone || '',
                c.address || '',
                c.npa || '',
                c.city || '',
                c.pricelist || '',
                c.orders || 0,
                c.totalSpent || 0
            ]);
            
            let csv = headers.join(';') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(';') + '\n';
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clients_trakio_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showTrakioToast(`${clients.length} clients export√©s`, 'success');
        }
        
        // ============ IMPORT CSV (placeholder) ============
        function importClientsCSV() {
            showTrakioToast('Import CSV - Fonctionnalit√© √† venir', 'warning');
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO v4.5.0 - Clients</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë•</text></svg>">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="trakio-config.js?v=4.5.0"></script>
    <script src="trakio-sync.js?v=4.5.0"></script>
    <script src="trakio-ui.js?v=4.5.0"></script>
    <style>
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 15px; }
        .page-title { font-size: 26px; font-weight: 700; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--trakio-primary); color: white; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-secondary { background: var(--trakio-bg-input); color: var(--trakio-text); border: 1px solid var(--trakio-border); }
        .btn-success { background: var(--trakio-success); color: white; }
        .btn-sm { padding: 8px 14px; font-size: 12px; }
        
        .import-zone { display: none; background: var(--trakio-bg-card); border: 2px dashed var(--trakio-border); border-radius: 16px; padding: 30px; margin-bottom: 24px; text-align: center; }
        .import-zone.visible { display: block; }
        .import-zone.dragover { border-color: var(--trakio-primary); background: rgba(14, 165, 233, 0.1); }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; background: var(--trakio-bg-card); padding: 5px; border-radius: 12px; border: 1px solid var(--trakio-border); }
        .tab { padding: 10px 20px; background: transparent; border: none; border-radius: 8px; color: var(--trakio-text-muted); font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .tab.active { background: var(--trakio-primary); color: white; }
        .tab-badge { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--trakio-bg-card); border: 1px solid var(--trakio-border); border-radius: 12px; padding: 16px; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--trakio-primary); }
        .stat-label { font-size: 12px; color: var(--trakio-text-muted); }
        
        .toolbar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 250px; position: relative; }
        .search-box input { width: 100%; padding: 12px 15px 12px 45px; background: var(--trakio-bg-card); border: 1px solid var(--trakio-border); border-radius: 10px; color: var(--trakio-text); font-size: 14px; }
        .search-box::before { content: 'üîç'; position: absolute; left: 15px; top: 50%; transform: translateY(-50%); }
        
        .clients-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
        .client-card { background: var(--trakio-bg-card); border: 1px solid var(--trakio-border); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.2s; }
        .client-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); border-color: var(--trakio-primary); }
        .client-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .client-avatar { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 20px; }
        .client-avatar.b2b { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .client-avatar.b2c { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .client-name { font-size: 16px; font-weight: 600; }
        .client-type { font-size: 11px; padding: 3px 8px; border-radius: 10px; font-weight: 600; }
        .client-type.b2b { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .client-type.b2c { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .client-info { font-size: 13px; color: var(--trakio-text-muted); margin-bottom: 4px; }
        .client-stats { display: flex; gap: 20px; margin: 15px 0; padding: 12px; background: var(--trakio-bg-input); border-radius: 10px; }
        .client-stat { text-align: center; }
        .client-stat-value { font-weight: 700; color: var(--trakio-success); }
        .client-stat-label { font-size: 10px; color: var(--trakio-text-muted); }
        .client-actions { display: flex; gap: 8px; }
        .client-action { flex: 1; padding: 10px; background: var(--trakio-bg-input); border: none; border-radius: 8px; cursor: pointer; font-size: 12px; color: var(--trakio-text); transition: all 0.2s; }
        .client-action:hover { background: var(--trakio-primary); }
        .client-action.whatsapp:hover { background: #25d366; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 10000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--trakio-bg-card); border-radius: 20px; width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden; border: 1px solid var(--trakio-border); }
        .modal.large { max-width: 800px; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--trakio-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; background: var(--trakio-bg-input); border: none; color: var(--trakio-text); cursor: pointer; font-size: 20px; }
        .modal-body { padding: 20px; overflow-y: auto; max-height: calc(90vh - 140px); }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--trakio-border); display: flex; justify-content: space-between; gap: 10px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; color: var(--trakio-text-muted); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; background: var(--trakio-bg-input); border: 1px solid var(--trakio-border); border-radius: 8px; color: var(--trakio-text); font-size: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .empty { text-align: center; padding: 60px; color: var(--trakio-text-muted); grid-column: 1 / -1; }
        
        /* Commande rapide */
        .order-client-info { background: var(--trakio-bg-input); padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .order-items-list { margin-bottom: 20px; }
        .order-item-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .order-item-row select { flex: 2; }
        .order-item-row input { flex: 1; }
        .order-item-remove { width: 36px; height: 36px; background: var(--trakio-error); border: none; border-radius: 8px; color: white; cursor: pointer; flex-shrink: 0; }
        .add-item-btn { width: 100%; padding: 12px; background: var(--trakio-bg-input); border: 2px dashed var(--trakio-border); border-radius: 8px; cursor: pointer; color: var(--trakio-text-muted); }
        .add-item-btn:hover { border-color: var(--trakio-primary); color: var(--trakio-primary); }
        .order-total-section { background: var(--trakio-bg-input); padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
        .order-total-label { color: var(--trakio-text-muted); }
        .order-total-value { font-size: 28px; font-weight: 700; color: var(--trakio-success); }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">üë• Clients</h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openClientModal()">‚ûï Nouveau client</button>
                <button class="btn btn-secondary" id="btn-export" onclick="exportClients()">üì• Exporter</button>
                <button class="btn btn-success" id="btn-import" onclick="toggleImportZone()">üì§ Importer</button>
            </div>
        </div>
        
        <!-- Zone Import -->
        <div class="import-zone" id="import-zone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
            <div style="font-size:48px;margin-bottom:15px">üìÑ</div>
            <div style="font-size:16px;margin-bottom:10px">Glissez votre fichier CSV ici</div>
            <div style="font-size:12px;color:var(--trakio-text-muted)">Format: type;entreprise;prenom;nom;email;telephone;adresse;npa;ville</div>
            <input type="file" id="file-input" accept=".csv" style="display:none" onchange="handleFileSelect(event)">
            <button class="btn btn-primary" style="margin-top:15px" onclick="document.getElementById('file-input').click()">üìÅ Choisir un fichier</button>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="setTab('all')" data-tab="all">üë• Tous <span class="tab-badge" id="count-all">0</span></button>
            <button class="tab" onclick="setTab('B2B')" data-tab="B2B">üè¢ Professionnels <span class="tab-badge" id="count-b2b">0</span></button>
            <button class="tab" onclick="setTab('B2C')" data-tab="B2C">üë§ Particuliers <span class="tab-badge" id="count-b2c">0</span></button>
        </div>
        
        <div class="stats-bar">
            <div class="stat-card"><div class="stat-value" id="stat-total">0</div><div class="stat-label">Total clients</div></div>
            <div class="stat-card"><div class="stat-value" id="stat-active">0</div><div class="stat-label">Actifs ce mois</div></div>
            <div class="stat-card"><div class="stat-value" id="stat-ca">0 CHF</div><div class="stat-label">CA total</div></div>
            <div class="stat-card"><div class="stat-value" id="stat-orders">0</div><div class="stat-label">Commandes</div></div>
        </div>
        
        <div class="toolbar">
            <div class="search-box"><input type="text" id="search" placeholder="Rechercher un client..." oninput="filterClients()"></div>
            <select id="sort" onchange="filterClients()" style="padding:12px;background:var(--trakio-bg-card);border:1px solid var(--trakio-border);border-radius:10px;color:var(--trakio-text)">
                <option value="name">Trier par nom</option>
                <option value="recent">Plus r√©cent</option>
                <option value="orders">Plus de commandes</option>
                <option value="ca">Plus gros CA</option>
            </select>
        </div>
        
        <div class="clients-grid" id="clients-grid"><div class="empty">Chargement...</div></div>
    </div>
    
    <!-- Modal Client -->
    <div class="modal-overlay" id="client-modal">
        <div class="modal">
            <div class="modal-header"><h3 id="client-modal-title">‚ûï Nouveau client</h3><button class="modal-close" onclick="closeClientModal()">√ó</button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label>Type *</label><select id="client-type" onchange="toggleCompanyField()"><option value="B2C">üë§ Particulier</option><option value="B2B">üè¢ Professionnel</option></select></div>
                    <div class="form-group" id="company-field" style="display:none"><label>Entreprise</label><input type="text" id="client-company" placeholder="Nom de l'entreprise"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Pr√©nom *</label><input type="text" id="client-firstname" placeholder="Pr√©nom"></div>
                    <div class="form-group"><label>Nom *</label><input type="text" id="client-lastname" placeholder="Nom"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Email</label><input type="email" id="client-email" placeholder="email@exemple.com"></div>
                    <div class="form-group"><label>T√©l√©phone</label><input type="tel" id="client-phone" placeholder="+41 79 000 00 00"></div>
                </div>
                <div class="form-group"><label>Adresse</label><input type="text" id="client-address" placeholder="Rue et num√©ro"></div>
                <div class="form-row">
                    <div class="form-group"><label>NPA</label><input type="text" id="client-zip" placeholder="1260"></div>
                    <div class="form-group"><label>Ville</label><input type="text" id="client-city" placeholder="Nyon"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Remise (%)</label><input type="number" id="client-discount" value="0" min="0" max="50"></div>
                    <div class="form-group"><label>Source</label><select id="client-source"><option value="">-</option><option value="bouche">Bouche √† oreille</option><option value="web">Site web</option><option value="shopify">Shopify</option><option value="event">√âv√©nement</option></select></div>
                </div>
                <div class="form-group"><label>Notes</label><textarea id="client-notes" rows="2" placeholder="Notes internes..."></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btn-delete-client" style="display:none" onclick="deleteClient()">üóëÔ∏è Supprimer</button>
                <div style="display:flex;gap:10px">
                    <button class="btn btn-secondary" onclick="closeClientModal()">Annuler</button>
                    <button class="btn btn-primary" onclick="saveClient()">üíæ Enregistrer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Commande Rapide -->
    <div class="modal-overlay" id="order-modal">
        <div class="modal large">
            <div class="modal-header"><h3>üìã Nouvelle commande rapide</h3><button class="modal-close" onclick="closeOrderModal()">√ó</button></div>
            <div class="modal-body">
                <div class="order-client-info">
                    <div class="client-avatar b2c" id="order-client-avatar">C</div>
                    <div>
                        <div style="font-weight:600" id="order-client-name">Client</div>
                        <div style="font-size:12px;color:var(--trakio-text-muted)" id="order-client-phone">-</div>
                    </div>
                </div>
                
                <div class="form-row" style="margin-bottom:20px">
                    <div class="form-group"><label>Date livraison</label><input type="date" id="order-date"></div>
                    <div class="form-group"><label>Heure</label><input type="time" id="order-time" value="10:00"></div>
                </div>
                
                <label style="font-size:13px;color:var(--trakio-text-muted);margin-bottom:10px;display:block">Articles</label>
                <div class="order-items-list" id="order-items"></div>
                <button class="add-item-btn" onclick="addOrderItem()">‚ûï Ajouter un article</button>
                
                <div class="order-total-section" style="margin-top:20px">
                    <span class="order-total-label">Total</span>
                    <span class="order-total-value" id="order-total">CHF 0.00</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeOrderModal()">Annuler</button>
                <button class="btn btn-success" onclick="saveOrder()">‚úÖ Cr√©er la commande</button>
            </div>
        </div>
    </div>
    
    <script>
        let clientsData = [], articlesData = [], filteredData = [], currentTab = 'all', editingClientId = null;
        let orderClientId = null, orderItemCounter = 0;
        
        document.addEventListener('DOMContentLoaded', () => setTimeout(init, 300));
        
        function init() {
            // Permissions
            if (!TrakioPermissions.canImport()) document.getElementById('btn-import').style.display = 'none';
            if (!TrakioPermissions.canExport()) document.getElementById('btn-export').style.display = 'none';
            loadData();
        }
        
        async function loadData() {
            [clientsData, articlesData] = await Promise.all([
                DataStore.clients.getAll(),
                DataStore.articles.getAll()
            ]);
            updateCounts();
            updateStats();
            filterClients();
        }
        
        function updateCounts() {
            document.getElementById('count-all').textContent = clientsData.length;
            document.getElementById('count-b2b').textContent = clientsData.filter(c => c.type === 'B2B').length;
            document.getElementById('count-b2c').textContent = clientsData.filter(c => c.type === 'B2C').length;
        }
        
        function updateStats() {
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const active = clientsData.filter(c => c.lastOrderDate && new Date(c.lastOrderDate) >= monthStart).length;
            const totalCA = clientsData.reduce((s, c) => s + (c.totalCA || 0), 0);
            const totalOrders = clientsData.reduce((s, c) => s + (c.ordersCount || 0), 0);
            
            document.getElementById('stat-total').textContent = clientsData.length;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-ca').textContent = Math.round(totalCA) + ' CHF';
            document.getElementById('stat-orders').textContent = totalOrders;
        }
        
        function setTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            filterClients();
        }
        
        function filterClients() {
            const search = document.getElementById('search').value.toLowerCase();
            const sort = document.getElementById('sort').value;
            
            filteredData = clientsData.filter(c => {
                if (currentTab !== 'all' && c.type !== currentTab) return false;
                if (search) {
                    const searchStr = `${c.firstName} ${c.lastName} ${c.email || ''} ${c.phone || ''} ${c.city || ''} ${c.company || ''}`.toLowerCase();
                    if (!searchStr.includes(search)) return false;
                }
                return true;
            });
            
            // Tri
            filteredData.sort((a, b) => {
                if (sort === 'name') return (a.lastName || '').localeCompare(b.lastName || '');
                if (sort === 'recent') return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                if (sort === 'orders') return (b.ordersCount || 0) - (a.ordersCount || 0);
                if (sort === 'ca') return (b.totalCA || 0) - (a.totalCA || 0);
                return 0;
            });
            
            renderClients();
        }
        
        function renderClients() {
            const grid = document.getElementById('clients-grid');
            if (filteredData.length === 0) {
                grid.innerHTML = '<div class="empty">Aucun client trouv√©</div>';
                return;
            }
            
            grid.innerHTML = filteredData.map(c => {
                const type = c.type || 'B2C';
                const initials = ((c.firstName || 'C')[0] + (c.lastName || '')[0]).toUpperCase();
                return `
                <div class="client-card" onclick="openClientModal('${c.id}')">
                    <div class="client-header">
                        <div class="client-avatar ${type.toLowerCase()}">${initials}</div>
                        <div>
                            <div class="client-name">${c.firstName} ${c.lastName}</div>
                            ${c.company ? '<div style="font-size:12px;color:var(--trakio-text-muted)">' + c.company + '</div>' : ''}
                        </div>
                        <span class="client-type ${type.toLowerCase()}">${type}</span>
                    </div>
                    ${c.phone ? '<div class="client-info">üì± ' + c.phone + '</div>' : ''}
                    ${c.email ? '<div class="client-info">üìß ' + c.email + '</div>' : ''}
                    ${c.city ? '<div class="client-info">üìç ' + c.city + '</div>' : ''}
                    <div class="client-stats">
                        <div class="client-stat"><div class="client-stat-value">${c.ordersCount || 0}</div><div class="client-stat-label">Commandes</div></div>
                        <div class="client-stat"><div class="client-stat-value">${formatCHF(c.totalCA || 0)}</div><div class="client-stat-label">CA</div></div>
                        <div class="client-stat"><div class="client-stat-value">${c.discount || 0}%</div><div class="client-stat-label">Remise</div></div>
                    </div>
                    <div class="client-actions">
                        <button class="client-action" onclick="event.stopPropagation(); openQuickOrder('${c.id}')">üìã Commander</button>
                        ${c.phone ? '<button class="client-action whatsapp" onclick="event.stopPropagation(); openWhatsApp(\'' + c.phone + '\')">üí¨ WhatsApp</button>' : ''}
                    </div>
                </div>`;
            }).join('');
        }
        
        // ================== CLIENT MODAL ==================
        function openClientModal(id = null) {
            editingClientId = id;
            
            // Reset form
            document.getElementById('client-type').value = 'B2C';
            document.getElementById('client-company').value = '';
            document.getElementById('client-firstname').value = '';
            document.getElementById('client-lastname').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('client-address').value = '';
            document.getElementById('client-zip').value = '';
            document.getElementById('client-city').value = '';
            document.getElementById('client-discount').value = '0';
            document.getElementById('client-source').value = '';
            document.getElementById('client-notes').value = '';
            document.getElementById('btn-delete-client').style.display = 'none';
            toggleCompanyField();
            
            if (id) {
                const c = clientsData.find(x => x.id === id);
                if (c) {
                    document.getElementById('client-modal-title').textContent = '‚úèÔ∏è Modifier client';
                    document.getElementById('client-type').value = c.type || 'B2C';
                    document.getElementById('client-company').value = c.company || '';
                    document.getElementById('client-firstname').value = c.firstName || '';
                    document.getElementById('client-lastname').value = c.lastName || '';
                    document.getElementById('client-email').value = c.email || '';
                    document.getElementById('client-phone').value = c.phone || '';
                    document.getElementById('client-address').value = c.address || '';
                    document.getElementById('client-zip').value = c.zip || '';
                    document.getElementById('client-city').value = c.city || '';
                    document.getElementById('client-discount').value = c.discount || 0;
                    document.getElementById('client-source').value = c.source || '';
                    document.getElementById('client-notes').value = c.notes || '';
                    document.getElementById('btn-delete-client').style.display = 'block';
                    toggleCompanyField();
                }
            } else {
                document.getElementById('client-modal-title').textContent = '‚ûï Nouveau client';
            }
            
            document.getElementById('client-modal').classList.add('active');
        }
        
        function closeClientModal() {
            document.getElementById('client-modal').classList.remove('active');
            editingClientId = null;
        }
        
        function toggleCompanyField() {
            const type = document.getElementById('client-type').value;
            document.getElementById('company-field').style.display = type === 'B2B' ? 'block' : 'none';
        }
        
        async function saveClient() {
            const firstName = document.getElementById('client-firstname').value.trim();
            const lastName = document.getElementById('client-lastname').value.trim();
            
            if (!firstName || !lastName) {
                TrakioUI.showToast('‚ùå Pr√©nom et nom requis', 'error');
                return;
            }
            
            const data = {
                type: document.getElementById('client-type').value,
                company: document.getElementById('client-company').value.trim(),
                firstName,
                lastName,
                email: document.getElementById('client-email').value.trim(),
                phone: document.getElementById('client-phone').value.trim(),
                address: document.getElementById('client-address').value.trim(),
                zip: document.getElementById('client-zip').value.trim(),
                city: document.getElementById('client-city').value.trim(),
                discount: parseFloat(document.getElementById('client-discount').value) || 0,
                source: document.getElementById('client-source').value,
                notes: document.getElementById('client-notes').value.trim()
            };
            
            await DataStore.clients.save(editingClientId, data);
            TrakioUI.showToast('‚úÖ Client enregistr√©', 'success');
            closeClientModal();
            loadData();
        }
        
        async function deleteClient() {
            if (!editingClientId) return;
            if (confirm('Supprimer ce client ?')) {
                await DataStore.clients.delete(editingClientId);
                TrakioUI.showToast('‚úÖ Client supprim√©', 'success');
                closeClientModal();
                loadData();
            }
        }
        
        // ================== COMMANDE RAPIDE ==================
        function openQuickOrder(clientId) {
            orderClientId = clientId;
            orderItemCounter = 0;
            
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            
            // Afficher infos client
            const type = client.type || 'B2C';
            document.getElementById('order-client-avatar').className = 'client-avatar ' + type.toLowerCase();
            document.getElementById('order-client-avatar').textContent = ((client.firstName || 'C')[0] + (client.lastName || '')[0]).toUpperCase();
            document.getElementById('order-client-name').textContent = client.firstName + ' ' + client.lastName + (client.company ? ' (' + client.company + ')' : '');
            document.getElementById('order-client-phone').textContent = client.phone || client.email || '-';
            
            // Date par d√©faut = demain
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('order-date').value = tomorrow.toISOString().slice(0, 10);
            document.getElementById('order-time').value = '10:00';
            
            // Vider les articles et en ajouter un
            document.getElementById('order-items').innerHTML = '';
            addOrderItem();
            
            updateOrderTotal();
            document.getElementById('order-modal').classList.add('active');
        }
        
        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('active');
            orderClientId = null;
        }
        
        function addOrderItem() {
            const container = document.getElementById('order-items');
            const idx = orderItemCounter++;
            
            const div = document.createElement('div');
            div.className = 'order-item-row';
            div.id = 'order-item-' + idx;
            div.innerHTML = `
                <select onchange="updateOrderTotal()">
                    <option value="">-- Article --</option>
                    ${articlesData.map(a => `<option value="${a.id}" data-price="${a.price || 0}">${a.name} (${formatCHF(a.price)})</option>`).join('')}
                </select>
                <input type="number" placeholder="Qt√©" min="0.1" step="0.1" value="1" onchange="updateOrderTotal()">
                <input type="number" placeholder="Prix" step="0.05" onchange="updateOrderTotal()">
                <button class="order-item-remove" onclick="removeOrderItem(${idx})">√ó</button>
            `;
            container.appendChild(div);
        }
        
        function removeOrderItem(idx) {
            document.getElementById('order-item-' + idx)?.remove();
            updateOrderTotal();
        }
        
        function updateOrderTotal() {
            let total = 0;
            document.querySelectorAll('.order-item-row').forEach(row => {
                const sel = row.querySelector('select');
                const qty = parseFloat(row.querySelectorAll('input')[0].value) || 0;
                let price = parseFloat(row.querySelectorAll('input')[1].value);
                if (isNaN(price) && sel.selectedOptions[0]?.dataset.price) {
                    price = parseFloat(sel.selectedOptions[0].dataset.price);
                }
                if (!isNaN(price)) total += qty * price;
            });
            
            // Appliquer remise client si applicable
            const client = clientsData.find(c => c.id === orderClientId);
            if (client?.discount) {
                total = total * (1 - client.discount / 100);
            }
            
            document.getElementById('order-total').textContent = formatCHF(total);
        }
        
        async function saveOrder() {
            if (!orderClientId) return;
            
            const client = clientsData.find(c => c.id === orderClientId);
            const items = [];
            
            document.querySelectorAll('.order-item-row').forEach(row => {
                const sel = row.querySelector('select');
                const qty = parseFloat(row.querySelectorAll('input')[0].value) || 0;
                const price = parseFloat(row.querySelectorAll('input')[1].value) || parseFloat(sel.selectedOptions[0]?.dataset.price) || 0;
                
                if (sel.value && qty > 0) {
                    items.push({
                        articleId: sel.value,
                        articleName: sel.selectedOptions[0].text.split(' (')[0],
                        quantity: qty,
                        price
                    });
                }
            });
            
            if (items.length === 0) {
                TrakioUI.showToast('‚ùå Ajoutez au moins un article', 'error');
                return;
            }
            
            let total = items.reduce((s, i) => s + (i.quantity * i.price), 0);
            if (client?.discount) total = total * (1 - client.discount / 100);
            
            const orderData = {
                clientId: orderClientId,
                clientName: client ? `${client.firstName} ${client.lastName}` : 'Client',
                status: 'pending',
                deliveryDate: document.getElementById('order-date').value,
                deliveryTime: document.getElementById('order-time').value,
                items,
                discount: client?.discount || 0,
                total
            };
            
            await DataStore.commandes.save(null, orderData);
            
            // Mettre √† jour stats client
            const newOrdersCount = (client.ordersCount || 0) + 1;
            const newTotalCA = (client.totalCA || 0) + total;
            await DataStore.clients.save(orderClientId, {
                ...client,
                ordersCount: newOrdersCount,
                totalCA: newTotalCA,
                lastOrderDate: new Date().toISOString()
            });
            
            TrakioUI.showToast('‚úÖ Commande cr√©√©e: ' + formatCHF(total), 'success');
            closeOrderModal();
            loadData();
        }
        
        // ================== WHATSAPP ==================
        function openWhatsApp(phone) {
            let num = phone.replace(/\s+/g, '').replace(/[^0-9+]/g, '');
            if (num.startsWith('0')) num = '41' + num.substring(1);
            num = num.replace('+', '');
            window.open('https://wa.me/' + num, '_blank');
        }
        
        // ================== IMPORT/EXPORT ==================
        function toggleImportZone() {
            document.getElementById('import-zone').classList.toggle('visible');
        }
        
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file?.name.endsWith('.csv')) importCSV(file);
            else TrakioUI.showToast('‚ùå Fichier CSV requis', 'error');
        }
        function handleFileSelect(e) { if (e.target.files[0]) importCSV(e.target.files[0]); }
        
        async function importCSV(file) {
            const text = await file.text();
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) { TrakioUI.showToast('‚ùå Fichier vide', 'error'); return; }
            
            const headers = lines[0].toLowerCase().split(';').map(h => h.trim());
            const map = (names) => headers.findIndex(h => names.includes(h));
            
            const idx = {
                type: map(['type']),
                company: map(['entreprise', 'company', 'societe']),
                firstName: map(['prenom', 'firstname', 'first_name']),
                lastName: map(['nom', 'lastname', 'last_name', 'name']),
                email: map(['email', 'mail']),
                phone: map(['telephone', 'phone', 'tel', 'mobile']),
                address: map(['adresse', 'address', 'rue']),
                zip: map(['npa', 'zip', 'cp', 'code_postal']),
                city: map(['ville', 'city', 'localite'])
            };
            
            let imported = 0;
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(';').map(c => c.trim());
                const firstName = idx.firstName >= 0 ? cols[idx.firstName] : '';
                const lastName = idx.lastName >= 0 ? cols[idx.lastName] : '';
                if (!firstName && !lastName) continue;
                
                await DataStore.clients.save(null, {
                    type: idx.type >= 0 && cols[idx.type]?.toUpperCase() === 'B2B' ? 'B2B' : 'B2C',
                    company: idx.company >= 0 ? cols[idx.company] : '',
                    firstName,
                    lastName,
                    email: idx.email >= 0 ? cols[idx.email] : '',
                    phone: idx.phone >= 0 ? cols[idx.phone] : '',
                    address: idx.address >= 0 ? cols[idx.address] : '',
                    zip: idx.zip >= 0 ? cols[idx.zip] : '',
                    city: idx.city >= 0 ? cols[idx.city] : ''
                });
                imported++;
            }
            
            TrakioUI.showToast(`‚úÖ ${imported} client(s) import√©(s)`, 'success');
            toggleImportZone();
            loadData();
        }
        
        function exportClients() {
            const headers = ['type', 'entreprise', 'prenom', 'nom', 'email', 'telephone', 'adresse', 'npa', 'ville'];
            const rows = clientsData.map(c => [c.type, c.company, c.firstName, c.lastName, c.email, c.phone, c.address, c.zip, c.city]);
            const csv = '\uFEFF' + [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'clients_' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
            TrakioUI.showToast('‚úÖ Export t√©l√©charg√©', 'success');
        }
        
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeClientModal(); closeOrderModal(); } });
    </script>
</body>
</html>

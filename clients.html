<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO v5.0.4 - Clients</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë•</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg-deep: #030712;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-input: #0f172a;
            --border: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-cyan: #06b6d4;
            --accent-teal: #14b8a6;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-orange: #f97316;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gradient-main: linear-gradient(135deg, #06b6d4 0%, #14b8a6 50%, #10b981 100%);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Navigation unifi√©e */
        .top-nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 15px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-left { display: flex; align-items: center; gap: 10px; }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: inherit;
        }

        .nav-logo {
            width: 32px;
            height: 32px;
            background: var(--gradient-main);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 800;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-version {
            font-size: 9px;
            padding: 2px 6px;
            background: rgba(6, 182, 212, 0.2);
            border-radius: 4px;
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 2px;
            flex: 1;
            justify-content: center;
            padding: 0 10px;
        }

        .nav-link {
            padding: 6px 8px;
            border-radius: 6px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .nav-link:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-link.active {
            background: var(--gradient-main);
            color: white;
        }

        .nav-divider {
            width: 1px;
            height: 16px;
            background: var(--border);
            margin: 0 4px;
            opacity: 0.5;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: var(--bg-hover);
            border-radius: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: var(--bg-hover);
            border-radius: 8px;
            cursor: pointer;
        }

        .user-avatar-small {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 11px;
            color: white;
        }

        .user-name-nav {
            font-size: 12px;
            font-weight: 600;
        }

        @media (max-width: 1200px) {
            .nav-link span:last-child { display: none; }
            .nav-title { display: none; }
            .user-name-nav { display: none; }
        }

        @media (max-width: 900px) {
            .nav-divider { display: none; }
        }

        /* Main container */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Section header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--gradient-main);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn:hover { transform: translateY(-2px); }

        /* Tabs */
        .tabs-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        .tab-btn.active {
            background: var(--gradient-main);
            color: white;
            border-color: transparent;
        }

        .tab-btn:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input, .toolbar select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .search-box input:focus, .toolbar select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .toolbar select {
            width: auto;
            min-width: 180px;
            cursor: pointer;
        }

        /* Clients grid */
        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .client-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .client-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(6, 182, 212, 0.15);
        }

        .client-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
        }

        .client-avatar {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: white;
        }

        .client-avatar.b2b { background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue)); }
        .client-avatar.b2c { background: linear-gradient(135deg, var(--accent-cyan), var(--accent-teal)); }

        .client-info-header { flex: 1; }

        .client-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .client-type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .client-type-badge.b2b {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-purple);
        }

        .client-type-badge.b2c {
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent-cyan);
        }

        .client-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .client-detail-item {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .client-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }

        .client-stat {
            text-align: center;
        }

        .client-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .client-stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .client-actions {
            display: flex;
            gap: 8px;
        }

        .client-action-btn {
            flex: 1;
            padding: 10px;
            background: var(--bg-hover);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .client-action-btn:hover {
            background: var(--accent-cyan);
            color: white;
        }

        .client-action-btn.whatsapp:hover {
            background: #25D366;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(20, 184, 166, 0.1));
        }

        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            background: var(--bg-hover);
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full { grid-column: 1 / -1; }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            background: var(--bg-primary);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 60px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
            .clients-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Navigation unifi√©e -->
    <nav class="top-nav">
        <div class="nav-left">
            <a href="index.html" class="nav-brand">
                <div class="nav-logo">üêü</div>
                <span class="nav-title">TRAKIO</span>
                <span class="nav-version">v5.0.4</span>
            </a>
        </div>

        <div class="nav-menu">
            <a href="index.html" class="nav-link"><span>üè†</span><span>Dashboard</span></a>
            <div class="nav-divider"></div>
            <a href="articles.html" class="nav-link"><span>üì¶</span><span>Articles</span></a>
            <a href="clients.html" class="nav-link active"><span>üë•</span><span>Clients</span></a>
            <a href="commandes.html" class="nav-link"><span>üìã</span><span>Commandes</span></a>
            <a href="myfish.html" class="nav-link"><span>üêü</span><span>MyFish</span></a>
            <div class="nav-divider"></div>
            <a href="caisse.html" class="nav-link"><span>üí≥</span><span>Caisse</span></a>
            <a href="live.html" class="nav-link"><span>üìä</span><span>Cours</span></a>
            <a href="tracabilite.html" class="nav-link"><span>üè∑Ô∏è</span><span>Tra√ßabilit√©</span></a>
            <div class="nav-divider"></div>
            <a href="shopify.html" class="nav-link"><span>üõçÔ∏è</span><span>Shop</span></a>
            <a href="compta.html" class="nav-link"><span>üí∞</span><span>Compta</span></a>
            <a href="whatsapp.html" class="nav-link"><span>üí¨</span><span>WhatsApp</span></a>
            <div class="nav-divider" id="paramDivider"></div>
            <a href="parametres.html" class="nav-link" id="paramNavLink"><span>‚öôÔ∏è</span><span>Param√®tres</span></a>
        </div>

        <div class="nav-right">
            <div class="sync-status" id="syncStatus">
                <span>‚úÖ</span>
                <span>Connect√©</span>
            </div>
            <div class="user-menu" id="userMenuNav">
                <div class="user-avatar-small" id="userAvatarNav" style="background: var(--danger);">PA</div>
                <span class="user-name-nav" id="userNameNav">Pascal</span>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Header section -->
        <div class="section-header">
            <h1 class="section-title">üë• Gestion Clients</h1>
            <div class="section-actions">
                <button class="btn btn-primary" onclick="openModal('add')">‚ûï Nouveau client</button>
                <button class="btn btn-secondary" onclick="exportClients()">üì§ Exporter CSV</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="setTab('all')" data-tab="all">
                üë• Tous <span class="tab-badge" id="count-all">0</span>
            </button>
            <button class="tab-btn" onclick="setTab('b2b')" data-tab="b2b">
                üè¢ Professionnels <span class="tab-badge" id="count-b2b">0</span>
            </button>
            <button class="tab-btn" onclick="setTab('b2c')" data-tab="b2c">
                üë§ Particuliers <span class="tab-badge" id="count-b2c">0</span>
            </button>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total clients</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-active">0</div>
                <div class="stat-label">Actifs ce mois</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-revenue">0</div>
                <div class="stat-label">CA total (CHF)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-orders">0</div>
                <div class="stat-label">Commandes</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Rechercher un client..." oninput="filterClients()">
            </div>
            <select id="sortBy" onchange="filterClients()">
                <option value="name">Trier par nom</option>
                <option value="recent">Plus r√©cent</option>
                <option value="orders">Plus de commandes</option>
                <option value="revenue">Plus gros CA</option>
            </select>
        </div>

        <!-- Clients grid -->
        <div class="clients-grid" id="clients-grid">
            <div class="empty-state">
                <div class="empty-state-icon">üë•</div>
                <p>Aucun client</p>
            </div>
        </div>
    </div>

    <!-- Modal Client -->
    <div class="modal-overlay" id="clientModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">üë§ Nouveau client</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <input type="hidden" id="clientId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Type de client *</label>
                            <select id="clientType" required onchange="toggleCompanyField()">
                                <option value="b2b">üè¢ Professionnel (B2B)</option>
                                <option value="b2c">üë§ Particulier (B2C)</option>
                            </select>
                        </div>
                        <div class="form-group" id="companyField">
                            <label>Entreprise</label>
                            <input type="text" id="clientCompany" placeholder="Nom de l'entreprise">
                        </div>
                        <div class="form-group">
                            <label>Nom *</label>
                            <input type="text" id="clientLastName" required placeholder="Nom">
                        </div>
                        <div class="form-group">
                            <label>Pr√©nom *</label>
                            <input type="text" id="clientFirstName" required placeholder="Pr√©nom">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="clientEmail" placeholder="email@exemple.com">
                        </div>
                        <div class="form-group">
                            <label>T√©l√©phone *</label>
                            <input type="tel" id="clientPhone" required placeholder="+41 79 123 45 67">
                        </div>
                        <div class="form-group full">
                            <label>Adresse</label>
                            <input type="text" id="clientAddress" placeholder="Rue et num√©ro">
                        </div>
                        <div class="form-group">
                            <label>NPA</label>
                            <input type="text" id="clientZip" placeholder="1260">
                        </div>
                        <div class="form-group">
                            <label>Ville</label>
                            <input type="text" id="clientCity" placeholder="Nyon">
                        </div>
                        <div class="form-group full">
                            <label>Notes</label>
                            <textarea id="clientNotes" rows="3" placeholder="Notes internes..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteBtn" onclick="deleteClient()" style="display:none;">üóëÔ∏è Supprimer</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveClient()">üíæ Enregistrer</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ============================================
        // AUTH & CONFIGURATION
        // ============================================
        const DEFAULT_USERS = [
            { id: 'admin_pascal', name: 'Pascal Admin', pin: '1277', role: 'admin', avatar: 'PA', color: '#ef4444' },
            { id: 'manager_celine', name: 'C√©line', pin: '1277', role: 'manager', avatar: 'CE', color: '#f59e0b' },
            { id: 'employee_hayat', name: 'Hayat', pin: '1260', role: 'employee', avatar: 'HA', color: '#10b981' }
        ];

        const ROLES = {
            admin: { label: 'Admin', badge: 'üëë', color: '#ef4444' },
            manager: { label: 'Manager', badge: '‚≠ê', color: '#f59e0b' },
            employee: { label: 'Employ√©', badge: 'üë§', color: '#10b981' }
        };

        function getCurrentUser() {
            try { return JSON.parse(localStorage.getItem('trakio_current_user')); } catch(e) { return null; }
        }

        function checkAuth() {
            const user = getCurrentUser();
            if (!user) {
                window.location.href = 'index.html';
                return false;
            }
            const role = ROLES[user.role] || ROLES.employee;
            document.getElementById('userAvatarNav').textContent = user.avatar || user.name.substring(0,2);
            document.getElementById('userAvatarNav').style.background = user.color || role.color;
            document.getElementById('userNameNav').textContent = user.name.split(' ')[0];
            
            if (user.role !== 'admin') {
                const paramLink = document.getElementById('paramNavLink');
                const paramDiv = document.getElementById('paramDivider');
                if (paramLink) paramLink.style.display = 'none';
                if (paramDiv) paramDiv.style.display = 'none';
            }
            return true;
        }

        // ============================================
        // STATE
        // ============================================
        let clientsData = [];
        let filteredData = [];
        let currentTab = 'all';
        let editingId = null;

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkAuth()) return;
            loadClients();
        });

        function loadClients() {
            const stored = localStorage.getItem('trakio_clients');
            if (stored) {
                try {
                    clientsData = JSON.parse(stored);
                } catch(e) {
                    clientsData = [];
                }
            }
            updateTabCounts();
            updateStats();
            filterClients();
        }

        function saveClientsToStorage() {
            localStorage.setItem('trakio_clients', JSON.stringify(clientsData));
        }

        // ============================================
        // TABS & FILTERING
        // ============================================
        function setTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            filterClients();
        }

        function filterClients() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortBy').value;

            filteredData = clientsData.filter(c => {
                if (currentTab !== 'all' && c.type !== currentTab) return false;
                if (search) {
                    const searchFields = [c.firstName, c.lastName, c.company, c.email, c.phone, c.city]
                        .filter(Boolean).join(' ').toLowerCase();
                    if (!searchFields.includes(search)) return false;
                }
                return true;
            });

            filteredData.sort((a, b) => {
                switch (sortBy) {
                    case 'recent': return (b.createdAt || 0) - (a.createdAt || 0);
                    case 'orders': return (b.ordersCount || 0) - (a.ordersCount || 0);
                    case 'revenue': return (b.totalRevenue || 0) - (a.totalRevenue || 0);
                    default: return (a.lastName || '').localeCompare(b.lastName || '');
                }
            });

            renderClients();
        }

        function updateTabCounts() {
            document.getElementById('count-all').textContent = clientsData.length;
            document.getElementById('count-b2b').textContent = clientsData.filter(c => c.type === 'b2b').length;
            document.getElementById('count-b2c').textContent = clientsData.filter(c => c.type === 'b2c').length;
        }

        // ============================================
        // RENDER
        // ============================================
        function renderClients() {
            const grid = document.getElementById('clients-grid');

            if (filteredData.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon">üë•</div>
                        <p>Aucun client trouv√©</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredData.map(c => {
                const initials = getInitials(c);
                const fullName = `${c.firstName || ''} ${c.lastName || ''}`.trim();
                const displayName = c.company || fullName || 'Sans nom';

                return `
                    <div class="client-card" onclick="openModal('edit', '${c.id}')">
                        <div class="client-header">
                            <div class="client-avatar ${c.type || 'b2c'}">${initials}</div>
                            <div class="client-info-header">
                                <div class="client-name">${displayName}</div>
                                <span class="client-type-badge ${c.type || 'b2c'}">
                                    ${c.type === 'b2b' ? 'üè¢ Pro' : 'üë§ Particulier'}
                                </span>
                            </div>
                        </div>
                        <div class="client-details">
                            ${c.company && fullName ? `<div class="client-detail-item">üë§ ${fullName}</div>` : ''}
                            ${c.phone ? `<div class="client-detail-item">üìû ${c.phone}</div>` : ''}
                            ${c.email ? `<div class="client-detail-item">‚úâÔ∏è ${c.email}</div>` : ''}
                            ${c.city ? `<div class="client-detail-item">üìç ${c.zip || ''} ${c.city}</div>` : ''}
                        </div>
                        <div class="client-stats">
                            <div class="client-stat">
                                <div class="client-stat-value">${c.ordersCount || 0}</div>
                                <div class="client-stat-label">Commandes</div>
                            </div>
                            <div class="client-stat">
                                <div class="client-stat-value">${formatCHF(c.totalRevenue || 0)}</div>
                                <div class="client-stat-label">CA Total</div>
                            </div>
                        </div>
                        <div class="client-actions" onclick="event.stopPropagation()">
                            <button class="client-action-btn" onclick="newOrder('${c.id}')">üìã Commande</button>
                            ${c.phone ? `<button class="client-action-btn whatsapp" onclick="openWhatsApp('${c.phone}')">üí¨ WhatsApp</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getInitials(client) {
            if (client.company) return client.company.substring(0, 2).toUpperCase();
            const first = (client.firstName || '').charAt(0);
            const last = (client.lastName || '').charAt(0);
            return (first + last).toUpperCase() || '??';
        }

        function formatCHF(amount) {
            return new Intl.NumberFormat('fr-CH', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        }

        // ============================================
        // STATS
        // ============================================
        function updateStats() {
            document.getElementById('stat-total').textContent = clientsData.length;
            
            const monthStart = new Date();
            monthStart.setDate(1);
            monthStart.setHours(0, 0, 0, 0);
            
            const activeCount = clientsData.filter(c => {
                const lastOrder = c.lastOrderDate ? new Date(c.lastOrderDate) : new Date(0);
                return lastOrder >= monthStart;
            }).length;
            
            const totalRevenue = clientsData.reduce((sum, c) => sum + (c.totalRevenue || 0), 0);
            const totalOrders = clientsData.reduce((sum, c) => sum + (c.ordersCount || 0), 0);
            
            document.getElementById('stat-active').textContent = activeCount;
            document.getElementById('stat-revenue').textContent = formatCHF(totalRevenue);
            document.getElementById('stat-orders').textContent = totalOrders;
        }

        // ============================================
        // MODAL
        // ============================================
        function openModal(mode, id = null) {
            editingId = id;
            const modal = document.getElementById('clientModal');
            const title = document.getElementById('modal-title');
            const deleteBtn = document.getElementById('deleteBtn');

            document.getElementById('clientForm').reset();

            if (mode === 'edit' && id) {
                const client = clientsData.find(c => c.id === id);
                if (client) {
                    title.innerHTML = '‚úèÔ∏è Modifier client';
                    document.getElementById('clientId').value = client.id;
                    document.getElementById('clientType').value = client.type || 'b2c';
                    document.getElementById('clientCompany').value = client.company || '';
                    document.getElementById('clientLastName').value = client.lastName || '';
                    document.getElementById('clientFirstName').value = client.firstName || '';
                    document.getElementById('clientEmail').value = client.email || '';
                    document.getElementById('clientPhone').value = client.phone || '';
                    document.getElementById('clientAddress').value = client.address || '';
                    document.getElementById('clientZip').value = client.zip || '';
                    document.getElementById('clientCity').value = client.city || '';
                    document.getElementById('clientNotes').value = client.notes || '';
                    deleteBtn.style.display = 'block';
                }
            } else {
                title.innerHTML = 'üë§ Nouveau client';
                deleteBtn.style.display = 'none';
            }

            toggleCompanyField();
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('clientModal').classList.remove('active');
            editingId = null;
        }

        function toggleCompanyField() {
            const type = document.getElementById('clientType').value;
            document.getElementById('companyField').style.display = type === 'b2b' ? 'block' : 'none';
        }

        function saveClient() {
            const type = document.getElementById('clientType').value;
            const lastName = document.getElementById('clientLastName').value.trim();
            const firstName = document.getElementById('clientFirstName').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();

            if (!lastName || !firstName || !phone) {
                showToast('Nom, pr√©nom et t√©l√©phone requis', 'error');
                return;
            }

            const clientData = {
                id: editingId || 'client_' + Date.now(),
                type,
                company: document.getElementById('clientCompany').value.trim(),
                lastName,
                firstName,
                email: document.getElementById('clientEmail').value.trim(),
                phone,
                address: document.getElementById('clientAddress').value.trim(),
                zip: document.getElementById('clientZip').value.trim(),
                city: document.getElementById('clientCity').value.trim(),
                notes: document.getElementById('clientNotes').value.trim(),
                updatedAt: Date.now()
            };

            if (editingId) {
                const index = clientsData.findIndex(c => c.id === editingId);
                if (index !== -1) {
                    clientData.createdAt = clientsData[index].createdAt;
                    clientData.ordersCount = clientsData[index].ordersCount;
                    clientData.totalRevenue = clientsData[index].totalRevenue;
                    clientsData[index] = clientData;
                }
                showToast('Client modifi√©', 'success');
            } else {
                clientData.createdAt = Date.now();
                clientData.ordersCount = 0;
                clientData.totalRevenue = 0;
                clientsData.push(clientData);
                showToast('Client cr√©√©', 'success');
            }

            saveClientsToStorage();
            updateTabCounts();
            updateStats();
            filterClients();
            closeModal();
        }

        function deleteClient() {
            if (!editingId) return;
            const client = clientsData.find(c => c.id === editingId);
            if (!client) return;

            if (confirm(`Supprimer "${client.firstName} ${client.lastName}" ?`)) {
                clientsData = clientsData.filter(c => c.id !== editingId);
                saveClientsToStorage();
                updateTabCounts();
                updateStats();
                filterClients();
                closeModal();
                showToast('Client supprim√©', 'success');
            }
        }

        // ============================================
        // ACTIONS
        // ============================================
        function newOrder(clientId) {
            window.location.href = `commandes.html?client=${clientId}`;
        }

        function openWhatsApp(phone) {
            const cleaned = phone.replace(/\D/g, '');
            window.open(`https://wa.me/${cleaned}`, '_blank');
        }

        function exportClients() {
            if (clientsData.length === 0) {
                showToast('Aucun client √† exporter', 'error');
                return;
            }

            let csv = 'Type,Entreprise,Nom,Pr√©nom,Email,T√©l√©phone,Adresse,NPA,Ville\n';
            clientsData.forEach(c => {
                csv += `${c.type || ''},${c.company || ''},${c.lastName || ''},${c.firstName || ''},${c.email || ''},${c.phone || ''},${c.address || ''},${c.zip || ''},${c.city || ''}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `clients_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();

            showToast('Export t√©l√©charg√©', 'success');
        }

        // ============================================
        // TOAST
        // ============================================
        function showToast(msg, type = 'success') {
            const c = document.getElementById('toastContainer');
            const t = document.createElement('div');
            t.className = 'toast ' + type;
            t.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span><span>${msg}</span>`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Close modal on Escape
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Import ‚Üí PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --border: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #95BF47;
            --accent-dark: #5E8E3E;
            --nyon: #ef4444;
            --nyon-dark: #b91c1c;
            --coinsins: #3b82f6;
            --coinsins-dark: #1d4ed8;
            --shipping: #f97316;
            --shipping-dark: #c2410c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            border-radius: 16px;
            margin-bottom: 24px;
        }
        .header h1 { font-size: 28px; color: #000; margin-bottom: 8px; }
        .header p { color: rgba(0,0,0,0.7); }
        
        .import-zone {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 60px;
            text-align: center;
            margin-bottom: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .import-zone:hover, .import-zone.dragover {
            border-color: var(--accent);
            background: rgba(149, 191, 71, 0.1);
        }
        .import-zone .icon { font-size: 64px; margin-bottom: 16px; }
        .import-zone h3 { font-size: 20px; margin-bottom: 8px; }
        .import-zone p { color: var(--text-secondary); }
        
        #fileInput { display: none; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .stat-card .value { font-size: 28px; font-weight: 700; }
        .stat-card .label { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
        .stat-card.nyon .value { color: var(--nyon); }
        .stat-card.coinsins .value { color: var(--coinsins); }
        .stat-card.shipping .value { color: var(--shipping); }
        .stat-card.total .value { color: var(--accent); }
        
        .actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: #000;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(149, 191, 71, 0.4); }
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .date-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .date-header {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            color: #fff;
            padding: 16px 20px;
            font-weight: 700;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .date-header .badges { display: flex; gap: 8px; }
        .date-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .date-badge.nyon { background: var(--nyon); color: #fff; }
        .date-badge.coinsins { background: var(--coinsins); color: #fff; }
        .date-badge.shipping { background: var(--shipping); color: #fff; }
        
        .location-group { border-bottom: 1px solid var(--border); }
        .location-group:last-child { border-bottom: none; }
        .location-header {
            padding: 12px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .location-header.nyon { background: linear-gradient(135deg, var(--nyon) 0%, var(--nyon-dark) 100%); color: #fff; }
        .location-header.coinsins { background: linear-gradient(135deg, var(--coinsins) 0%, var(--coinsins-dark) 100%); color: #fff; }
        .location-header.shipping { background: linear-gradient(135deg, var(--shipping) 0%, var(--shipping-dark) 100%); color: #fff; }
        
        .order-card {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }
        .order-card:last-child { border-bottom: none; }
        .order-card:hover { background: var(--bg-tertiary); }
        
        .order-number {
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-family: monospace;
            font-size: 13px;
            color: #fff;
            min-width: 100px;
            text-align: center;
        }
        .order-number.nyon { background: var(--nyon); }
        .order-number.coinsins { background: var(--coinsins); }
        .order-number.shipping { background: var(--shipping); }
        
        .order-info { flex: 1; min-width: 0; }
        .order-info h4 { font-size: 15px; margin-bottom: 3px; }
        .order-info .detail { font-size: 12px; color: var(--text-secondary); }
        
        .order-total {
            text-align: right;
            min-width: 90px;
        }
        .order-total .amount { font-size: 18px; font-weight: 700; color: var(--accent); }
        .order-total .time { font-size: 11px; color: var(--text-secondary); }
        
        .btn-details {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: #000;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-details:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(149, 191, 71, 0.4);
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header.nyon { background: linear-gradient(135deg, var(--nyon) 0%, var(--nyon-dark) 100%); }
        .modal-header.coinsins { background: linear-gradient(135deg, var(--coinsins) 0%, var(--coinsins-dark) 100%); }
        .modal-header.shipping { background: linear-gradient(135deg, var(--shipping) 0%, var(--shipping-dark) 100%); }
        .modal-header h2 { font-size: 20px; color: #fff; }
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 36px; height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            color: #fff;
        }
        .modal-close:hover { background: rgba(255,255,255,0.3); }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        .modal-section { margin-bottom: 20px; }
        .modal-section-title {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        .modal-client {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 12px;
        }
        .modal-client h3 { font-size: 18px; margin-bottom: 8px; }
        .modal-client .info { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
        
        .product-list { display: flex; flex-direction: column; gap: 10px; }
        .product-item {
            background: var(--bg-tertiary);
            padding: 14px 16px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .product-item .qty {
            background: var(--accent);
            color: #000;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 14px;
            margin-right: 12px;
        }
        .product-item .name { flex: 1; font-size: 14px; }
        .product-item .price { font-weight: 600; color: var(--accent); }
        
        .modal-total {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            padding: 16px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #000;
        }
        .modal-total .label { font-weight: 600; }
        .modal-total .amount { font-size: 24px; font-weight: 800; }
        
        #results { display: none; }
        #results.visible { display: block; }
        
        @media print {
            body { background: white; color: black; padding: 10px; font-size: 11px; }
            .header, .import-zone, .actions, .stats, .btn-details, .modal-overlay { display: none !important; }
            .date-section { break-inside: avoid; border: 1px solid #ccc; margin-bottom: 10px; }
            .date-header { background: #333 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; padding: 10px 15px; }
            .location-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; padding: 8px 15px; }
            .location-header.nyon { background: #ef4444 !important; }
            .location-header.coinsins { background: #3b82f6 !important; }
            .location-header.shipping { background: #f97316 !important; }
            .order-card { padding: 8px 15px; }
            .order-number { padding: 4px 8px; font-size: 11px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .order-number.nyon { background: #ef4444 !important; color: white !important; }
            .order-number.coinsins { background: #3b82f6 !important; color: white !important; }
            .order-number.shipping { background: #f97316 !important; color: white !important; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõçÔ∏è Shopify ‚Üí PDF</h1>
        <p>Import CSV complet avec d√©tails produits</p>
    </div>

    <div class="import-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div class="icon">üìÑ</div>
        <h3>Importer le fichier CSV</h3>
        <p>Glisser-d√©poser ou cliquer pour s√©lectionner (orders_export)</p>
    </div>
    <input type="file" id="fileInput" accept=".csv">

    <div class="stats" id="statsSection" style="display: none;">
        <div class="stat-card total">
            <div class="value" id="totalOrders">0</div>
            <div class="label">Commandes</div>
        </div>
        <div class="stat-card total">
            <div class="value" id="totalDates">0</div>
            <div class="label">Dates</div>
        </div>
        <div class="stat-card nyon">
            <div class="value" id="totalNyon">0</div>
            <div class="label">üè™ Nyon</div>
        </div>
        <div class="stat-card coinsins">
            <div class="value" id="totalCoinsins">0</div>
            <div class="label">üè≠ Coinsins</div>
        </div>
        <div class="stat-card shipping">
            <div class="value" id="totalShipping">0</div>
            <div class="label">üöö Livraison</div>
        </div>
        <div class="stat-card total">
            <div class="value" id="totalAmount">0</div>
            <div class="label">CHF Total</div>
        </div>
    </div>

    <div class="actions" id="actionsSection" style="display: none;">
        <button class="btn btn-primary" onclick="generatePDF()">üìÑ G√©n√©rer PDF</button>
        <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Imprimer</button>
        <button class="btn btn-secondary" onclick="resetAll()">üîÑ Nouveau fichier</button>
    </div>

    <div id="results"></div>

    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header" id="modalHeader">
                <h2 id="modalTitle">Commande</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        let ordersData = {};
        
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, ev => ev.preventDefault());
        });
        dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => {
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });
        fileInput.addEventListener('change', e => {
            if (e.target.files[0]) processFile(e.target.files[0]);
        });

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = e => parseCSV(e.target.result);
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = [];
            let currentLine = '';
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                    currentLine += char;
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (currentLine.trim()) lines.push(currentLine);
                    currentLine = '';
                    if (char === '\r' && text[i + 1] === '\n') i++;
                } else {
                    currentLine += char;
                }
            }
            if (currentLine.trim()) lines.push(currentLine);

            const headers = parseCSVLine(lines[0]);
            ordersData = {};

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length < 5) continue;
                
                const row = {};
                headers.forEach((h, idx) => row[h.trim()] = (values[idx] || '').trim());
                
                const orderName = row['Name'] || '';
                if (!orderName || !orderName.includes('#')) continue;
                
                const fulfillment = (row['Fulfillment Status'] || '').toLowerCase();
                if (fulfillment === 'fulfilled') continue;
                
                const product = {
                    qty: parseInt(row['Lineitem quantity']) || 1,
                    name: row['Lineitem name'] || 'Article',
                    price: parseFloat(row['Lineitem price']) || 0,
                    sku: row['Lineitem sku'] || ''
                };
                
                if (!ordersData[orderName]) {
                    const noteAttr = row['Note Attributes'] || '';
                    const shippingMethod = row['Shipping Method'] || '';
                    
                    let location = 'shipping';
                    if (noteAttr.includes('Magasin de Nyon') || noteAttr.includes('Nyon')) {
                        location = 'nyon';
                    } else if (noteAttr.includes('Laboratoire de Coinsins') || noteAttr.includes('Coinsins')) {
                        location = 'coinsins';
                    } else if (shippingMethod.includes('Swiss Post') || shippingMethod.includes('Shipping') || shippingMethod.includes('Forfait')) {
                        location = 'shipping';
                    } else if (noteAttr.includes('Store Pickup')) {
                        location = 'coinsins';
                    }
                    
                    const dueDateMatch = noteAttr.match(/Order Due Date:\s*(\w+),\s*(\d+)\s+(\w+)\s+(\d{4})/);
                    let dueDate = new Date();
                    if (dueDateMatch) {
                        const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
                        dueDate = new Date(parseInt(dueDateMatch[4]), months[dueDateMatch[3]], parseInt(dueDateMatch[2]));
                    }
                    
                    const timeMatch = noteAttr.match(/Order Due Time:\s*([^\n]+)/);
                    const timeSlot = timeMatch ? timeMatch[1].trim() : '';
                    
                    ordersData[orderName] = {
                        orderName: orderName,
                        email: row['Email'] || '',
                        customer: row['Billing Name'] || row['Shipping Name'] || 'Client',
                        phone: row['Billing Phone'] || row['Shipping Phone'] || row['Phone'] || '',
                        address: [
                            row['Shipping Address1'] || row['Billing Address1'],
                            row['Shipping City'] || row['Billing City'],
                            (row['Shipping Zip'] || row['Billing Zip'] || '').replace("'", '')
                        ].filter(Boolean).join(', '),
                        total: parseFloat(row['Total']) || 0,
                        location: location,
                        dueDate: dueDate,
                        timeSlot: timeSlot,
                        products: [],
                        notes: row['Notes'] || ''
                    };
                }
                
                if (product.name && product.name !== 'Article') {
                    ordersData[orderName].products.push(product);
                }
            }

            displayResults();
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current);
            return values;
        }

        function formatDate(date) {
            const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            const months = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
            return days[date.getDay()] + ' ' + date.getDate() + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
        }

        function displayResults() {
            const orders = Object.values(ordersData);
            
            const byDate = {};
            orders.forEach(order => {
                const key = order.dueDate.toISOString().split('T')[0];
                if (!byDate[key]) byDate[key] = [];
                byDate[key].push(order);
            });

            const sortedDates = Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b));

            let totalAmount = 0;
            let nyon = 0, coinsins = 0, shipping = 0;
            orders.forEach(o => {
                totalAmount += o.total;
                if (o.location === 'nyon') nyon++;
                else if (o.location === 'coinsins') coinsins++;
                else shipping++;
            });

            document.getElementById('totalOrders').textContent = orders.length;
            document.getElementById('totalDates').textContent = sortedDates.length;
            document.getElementById('totalNyon').textContent = nyon;
            document.getElementById('totalCoinsins').textContent = coinsins;
            document.getElementById('totalShipping').textContent = shipping;
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(0);
            document.getElementById('statsSection').style.display = 'grid';
            document.getElementById('actionsSection').style.display = 'flex';

            let html = '';
            sortedDates.forEach(dateKey => {
                const dateOrders = byDate[dateKey];
                const date = new Date(dateKey);
                
                const locCounts = { nyon: 0, coinsins: 0, shipping: 0 };
                dateOrders.forEach(o => locCounts[o.location]++);
                
                const byLocation = { nyon: [], coinsins: [], shipping: [] };
                dateOrders.forEach(o => byLocation[o.location].push(o));

                html += '<div class="date-section"><div class="date-header"><span>üìÖ ' + formatDate(date) + '</span><div class="badges">';
                if (locCounts.nyon > 0) html += '<span class="date-badge nyon">üè™ ' + locCounts.nyon + '</span>';
                if (locCounts.coinsins > 0) html += '<span class="date-badge coinsins">üè≠ ' + locCounts.coinsins + '</span>';
                if (locCounts.shipping > 0) html += '<span class="date-badge shipping">üöö ' + locCounts.shipping + '</span>';
                html += '</div></div>';

                ['nyon', 'coinsins', 'shipping'].forEach(loc => {
                    if (byLocation[loc].length === 0) return;
                    
                    const locOrders = byLocation[loc].sort((a, b) => (a.timeSlot || '').localeCompare(b.timeSlot || ''));
                    const locName = loc === 'nyon' ? 'üè™ Magasin de Nyon' : loc === 'coinsins' ? 'üè≠ Laboratoire de Coinsins' : 'üöö Livraison Postale';
                    
                    html += '<div class="location-group"><div class="location-header ' + loc + '"><span>' + locName + ' (' + locOrders.length + ')</span></div>';
                    
                    locOrders.forEach(order => {
                        const productCount = order.products.reduce((sum, p) => sum + p.qty, 0);
                        html += '<div class="order-card">';
                        html += '<div class="order-number ' + loc + '">' + order.orderName + '</div>';
                        html += '<div class="order-info"><h4>' + order.customer + '</h4>';
                        html += '<div class="detail">' + (order.timeSlot || 'Pas d\'heure') + ' ‚Ä¢ ' + productCount + ' article' + (productCount > 1 ? 's' : '') + '</div></div>';
                        html += '<div class="order-total"><div class="amount">CHF ' + order.total.toFixed(2) + '</div>';
                        html += '<div class="time">' + (order.timeSlot || '') + '</div></div>';
                        html += '<button class="btn-details" onclick="showDetails(\'' + order.orderName + '\')">üì¶ D√©tails</button>';
                        html += '</div>';
                    });
                    
                    html += '</div>';
                });

                html += '</div>';
            });

            document.getElementById('results').innerHTML = html;
            document.getElementById('results').classList.add('visible');
            document.getElementById('dropZone').style.display = 'none';
        }

        function showDetails(orderName) {
            const order = ordersData[orderName];
            if (!order) return;
            
            const modal = document.getElementById('modalOverlay');
            const header = document.getElementById('modalHeader');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            header.className = 'modal-header ' + order.location;
            title.textContent = order.orderName + ' - ' + order.customer;
            
            let productsHtml = order.products.map(p => 
                '<div class="product-item"><span class="qty">' + p.qty + 'x</span><span class="name">' + p.name + '</span><span class="price">CHF ' + (p.qty * p.price).toFixed(2) + '</span></div>'
            ).join('');
            
            body.innerHTML = '<div class="modal-section"><div class="modal-section-title">Client</div><div class="modal-client"><h3>' + order.customer + '</h3>' +
                (order.email ? '<div class="info">üìß ' + order.email + '</div>' : '') +
                (order.phone ? '<div class="info">üì± ' + order.phone + '</div>' : '') +
                (order.address ? '<div class="info">üìç ' + order.address + '</div>' : '') +
                '<div class="info">üìÖ ' + formatDate(order.dueDate) + (order.timeSlot ? ' ‚Ä¢ ‚è∞ ' + order.timeSlot : '') + '</div></div></div>' +
                '<div class="modal-section"><div class="modal-section-title">Produits (' + order.products.length + ')</div><div class="product-list">' + productsHtml + '</div></div>' +
                '<div class="modal-total"><span class="label">TOTAL</span><span class="amount">CHF ' + order.total.toFixed(2) + '</span></div>';
            
            modal.classList.add('active');
        }

        function closeModal(e) {
            if (!e || e.target === document.getElementById('modalOverlay')) {
                document.getElementById('modalOverlay').classList.remove('active');
            }
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 12;
            let y = margin;

            const orders = Object.values(ordersData);
            const byDate = {};
            orders.forEach(order => {
                const key = order.dueDate.toISOString().split('T')[0];
                if (!byDate[key]) byDate[key] = [];
                byDate[key].push(order);
            });
            const sortedDates = Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b));

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('Commandes Shopify - Borex Poissons', margin, y);
            y += 7;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Genere le ' + new Date().toLocaleDateString('fr-CH') + ' - ' + orders.length + ' commandes', margin, y);
            y += 10;

            sortedDates.forEach(dateKey => {
                const dateOrders = byDate[dateKey];
                const date = new Date(dateKey);

                if (y > pageHeight - 50) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFillColor(71, 85, 105);
                doc.rect(margin, y, pageWidth - 2 * margin, 8, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(255);
                doc.text(formatDate(date) + ' - ' + dateOrders.length + ' cmd', margin + 3, y + 5.5);
                y += 11;

                const byLocation = { nyon: [], coinsins: [], shipping: [] };
                dateOrders.forEach(o => byLocation[o.location].push(o));

                [
                    { key: 'nyon', name: 'Nyon', color: [239, 68, 68] },
                    { key: 'coinsins', name: 'Coinsins', color: [59, 130, 246] },
                    { key: 'shipping', name: 'Livraison', color: [249, 115, 22] }
                ].forEach(loc => {
                    if (byLocation[loc.key].length === 0) return;
                    const locOrders = byLocation[loc.key].sort((a, b) => (a.timeSlot || '').localeCompare(b.timeSlot || ''));

                    if (y > pageHeight - 40) {
                        doc.addPage();
                        y = margin;
                    }

                    doc.setFillColor(loc.color[0], loc.color[1], loc.color[2]);
                    doc.rect(margin, y, pageWidth - 2 * margin, 6, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.setTextColor(255);
                    doc.text(loc.name + ' (' + locOrders.length + ')', margin + 3, y + 4.2);
                    y += 8;

                    locOrders.forEach(order => {
                        const lineHeight = 5 + order.products.length * 4;
                        if (y + lineHeight > pageHeight - 10) {
                            doc.addPage();
                            y = margin;
                        }

                        doc.setFillColor(loc.color[0], loc.color[1], loc.color[2]);
                        doc.roundedRect(margin, y, 22, 5, 1, 1, 'F');
                        doc.setTextColor(255);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.text(order.orderName.replace('Web ', ''), margin + 2, y + 3.5);
                        
                        doc.setTextColor(0);
                        doc.setFontSize(9);
                        doc.text(order.customer, margin + 26, y + 3.5);
                        
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(100);
                        doc.setFontSize(8);
                        doc.text(order.timeSlot || '', margin + 26, y + 7);
                        
                        doc.setTextColor(0);
                        doc.setFont('helvetica', 'bold');
                        doc.text('CHF ' + order.total.toFixed(2), pageWidth - margin - 22, y + 3.5);
                        
                        y += 9;

                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(7);
                        doc.setTextColor(60);
                        order.products.forEach(p => {
                            const prodText = '  ' + p.qty + 'x ' + p.name;
                            const truncated = prodText.length > 80 ? prodText.substring(0, 77) + '...' : prodText;
                            doc.text(truncated, margin + 26, y);
                            y += 3.5;
                        });
                        
                        y += 3;
                    });

                    y += 3;
                });

                y += 5;
            });

            doc.save('Commandes_Shopify_' + new Date().toISOString().split('T')[0] + '.pdf');
        }

        function resetAll() {
            ordersData = {};
            document.getElementById('results').innerHTML = '';
            document.getElementById('results').classList.remove('visible');
            document.getElementById('dropZone').style.display = 'block';
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('actionsSection').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }
        
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO v4.5.0 - WhatsApp</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="trakio-config.js?v=4.5.0"></script>
    <script src="trakio-sync.js?v=4.5.0"></script>
    <script src="trakio-ui.js?v=4.5.0"></script>
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .page-title { font-size: 26px; font-weight: 700; margin-bottom: 24px; }
        .layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: calc(100vh - 180px); }
        @media (max-width: 900px) { .layout { grid-template-columns: 1fr; height: auto; } }
        .card { background: var(--trakio-bg-card); border: 1px solid var(--trakio-border); border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--trakio-border); font-weight: 600; }
        .contacts-list { flex: 1; overflow-y: auto; }
        .contact-item { display: flex; align-items: center; gap: 12px; padding: 14px 20px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid var(--trakio-border); }
        .contact-item:hover { background: var(--trakio-bg-input); }
        .contact-item.active { background: rgba(14, 165, 233, 0.1); border-left: 3px solid var(--trakio-primary); }
        .contact-avatar { width: 45px; height: 45px; background: var(--trakio-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
        .contact-info { flex: 1; }
        .contact-name { font-weight: 600; font-size: 14px; }
        .contact-phone { font-size: 12px; color: var(--trakio-text-muted); }
        .templates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; padding: 20px; flex: 1; overflow-y: auto; align-content: start; }
        .template-card { padding: 16px; background: var(--trakio-bg-input); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .template-card:hover { background: var(--trakio-bg-hover); transform: translateY(-2px); }
        .template-title { font-weight: 600; font-size: 14px; margin-bottom: 8px; }
        .template-preview { font-size: 12px; color: var(--trakio-text-muted); line-height: 1.4; }
        .message-box { padding: 20px; border-top: 1px solid var(--trakio-border); }
        .message-box textarea { width: 100%; height: 100px; padding: 12px; background: var(--trakio-bg-input); border: 1px solid var(--trakio-border); border-radius: 10px; color: var(--trakio-text); resize: none; margin-bottom: 12px; }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .btn-whatsapp { background: #25d366; color: white; width: 100%; font-size: 15px; }
        .btn-whatsapp:hover { background: #128c7e; }
        .search-box { padding: 15px; border-bottom: 1px solid var(--trakio-border); }
        .search-box input { width: 100%; padding: 10px 14px; background: var(--trakio-bg-input); border: 1px solid var(--trakio-border); border-radius: 8px; color: var(--trakio-text); }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title">üí¨ WhatsApp Business</h1>
        <div class="layout">
            <div class="card">
                <div class="card-header">üë• Contacts</div>
                <div class="search-box"><input type="text" placeholder="üîç Rechercher..." oninput="filterContacts(this.value)"></div>
                <div class="contacts-list" id="contacts-list"></div>
            </div>
            <div class="card">
                <div class="card-header">üìù Messages rapides</div>
                <div class="templates-grid" id="templates"></div>
                <div class="message-box">
                    <textarea id="message" placeholder="Votre message..."></textarea>
                    <button class="btn btn-whatsapp" onclick="sendWhatsApp()">üí¨ Envoyer via WhatsApp</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        let clients = [], selectedClient = null;
        const templates = [
            { title: 'üì¶ Commande pr√™te', text: 'Bonjour! Votre commande est pr√™te √† √™tre retir√©e. √Ä bient√¥t!' },
            { title: 'üöö Livraison', text: 'Bonjour! Votre livraison est en route. Livraison pr√©vue dans environ 30 minutes.' },
            { title: '‚úÖ Confirmation', text: 'Merci pour votre commande! Nous la pr√©parons avec soin.' },
            { title: '‚è∞ Rappel RDV', text: 'Rappel: vous avez une commande √† retirer aujourd\'hui.' },
            { title: 'üéâ Promo', text: 'Profitez de nos promotions du jour! Poissons ultra-frais √† prix r√©duit.' },
            { title: 'üìû Contact', text: 'Merci de nous avoir contact√©! Comment pouvons-nous vous aider?' }
        ];
        document.addEventListener('DOMContentLoaded', () => setTimeout(init, 300));
        async function init() { clients = await DataStore.clients.getAll(); renderContacts(); renderTemplates(); }
        function renderContacts(filter = '') {
            const filtered = clients.filter(c => !filter || (c.firstName + ' ' + c.lastName + ' ' + (c.phone || '')).toLowerCase().includes(filter.toLowerCase())).filter(c => c.phone);
            document.getElementById('contacts-list').innerHTML = filtered.map(c => '<div class="contact-item '+(selectedClient?.id === c.id ? 'active' : '')+'" onclick="selectClient(\''+c.id+'\')"><div class="contact-avatar">'+(c.firstName || 'C')[0].toUpperCase()+'</div><div class="contact-info"><div class="contact-name">'+c.firstName+' '+c.lastName+'</div><div class="contact-phone">'+c.phone+'</div></div></div>').join('') || '<div style="padding:40px;text-align:center;color:var(--trakio-text-muted)">Aucun contact avec t√©l√©phone</div>';
        }
        function filterContacts(val) { renderContacts(val); }
        function selectClient(id) { selectedClient = clients.find(c => c.id === id); renderContacts(); }
        function renderTemplates() { document.getElementById('templates').innerHTML = templates.map(t => '<div class="template-card" onclick="useTemplate(\''+t.text.replace(/'/g, "\\'")+'\')" ><div class="template-title">'+t.title+'</div><div class="template-preview">'+t.text.substring(0, 60)+'...</div></div>').join(''); }
        function useTemplate(text) { document.getElementById('message').value = text; }
        function sendWhatsApp() {
            if (!selectedClient) { TrakioUI.showToast('‚ùå S√©lectionnez un contact', 'error'); return; }
            const msg = document.getElementById('message').value;
            if (!msg) { TrakioUI.showToast('‚ùå Entrez un message', 'error'); return; }
            let phone = selectedClient.phone.replace(/\s+/g, '').replace(/[^0-9+]/g, '');
            if (phone.startsWith('0')) phone = '41' + phone.substring(1);
            phone = phone.replace('+', '');
            window.open('https://wa.me/' + phone + '?text=' + encodeURIComponent(msg), '_blank');
        }
    </script>
</body>
</html>

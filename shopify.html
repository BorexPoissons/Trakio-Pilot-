<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>TRAKIO Shopify v1.0.0 - Gestion Commandes</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2234;
            --bg-hover: #243049;
            --accent-primary: #06d6a0;
            --accent-secondary: #118ab2;
            --accent-warning: #ffd166;
            --accent-danger: #ef476f;
            --accent-purple: #9d4edd;
            --accent-orange: #ff6b35;
            --shopify-green: #96bf48;
            --shopify-dark: #5c8e24;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2d3a4f;
            --radius: 16px;
            --radius-sm: 10px;
            --shadow: 0 8px 32px rgba(0,0,0,0.4);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="light"] {
            --bg-primary: #f1f5f9;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --shadow: 0 8px 32px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--shopify-green), var(--shopify-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .title-block h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--shopify-green), var(--accent-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .title-block .subtitle {
            font-size: 13px;
            color: var(--text-muted);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--shopify-green), var(--shopify-dark));
            color: #fff;
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background: var(--accent-danger);
            color: #fff;
        }

        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

        /* Back link */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 13px;
            padding: 8px 14px;
            border-radius: 20px;
            transition: var(--transition);
            margin-bottom: 16px;
        }

        .back-link:hover {
            background: var(--bg-hover);
            color: var(--accent-primary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: var(--radius);
            flex-wrap: wrap;
        }

        .tab {
            padding: 14px 24px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover { background: var(--bg-hover); color: var(--text-primary); }

        .tab.active {
            background: linear-gradient(135deg, var(--shopify-green), var(--shopify-dark));
            color: #fff;
        }

        .tab .badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .tab.active .badge {
            background: rgba(255,255,255,0.3);
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .card-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--shopify-green), var(--shopify-dark));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            color: #fff;
            font-size: 16px;
            font-weight: 700;
        }

        .card-body { padding: 20px; }

        /* Import Zone */
        .import-zone {
            padding: 40px;
            background: linear-gradient(135deg, rgba(150,191,72,0.1), rgba(92,142,36,0.1));
            border: 2px dashed var(--shopify-green);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .import-zone:hover {
            background: linear-gradient(135deg, rgba(150,191,72,0.2), rgba(92,142,36,0.2));
            transform: scale(1.01);
        }

        .import-zone .icon { font-size: 48px; margin-bottom: 12px; }
        .import-zone .title { font-weight: 600; color: var(--shopify-green); margin-bottom: 8px; }
        .import-zone .hint { font-size: 12px; color: var(--text-muted); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 16px;
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .stat-card:hover { transform: scale(1.02); border-color: var(--shopify-green); }
        .stat-card.active { border-color: var(--shopify-green); background: rgba(150,191,72,0.1); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            padding: 16px;
            background: var(--bg-primary);
            border-radius: var(--radius);
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-select, .filter-input {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            min-width: 150px;
        }

        .filter-input { flex: 1; min-width: 200px; }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-sm);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-primary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        tr:hover { background: var(--bg-hover); }

        .clickable-row { cursor: pointer; }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-danger { background: var(--accent-danger); color: #fff; }
        .badge-warning { background: var(--accent-warning); color: #000; }
        .badge-success { background: var(--accent-primary); color: #000; }
        .badge-info { background: var(--accent-secondary); color: #fff; }
        .badge-muted { background: var(--text-muted); color: #fff; }

        /* Dashboard Pr√©paration */
        .prep-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .prep-category {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .prep-category-header {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prep-category-header.huitres { background: linear-gradient(135deg, #3498db, #2980b9); }
        .prep-category-header.fondues { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .prep-category-header.saumon { background: linear-gradient(135deg, #f39c12, #d68910); }
        .prep-category-header.foiegras { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .prep-category-header.fruitsmer { background: linear-gradient(135deg, #1abc9c, #16a085); }
        .prep-category-header.autres { background: linear-gradient(135deg, #7f8c8d, #6c7a7b); }

        .prep-category-header h4 {
            color: #fff;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prep-category-header .total {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 700;
            color: #fff;
        }

        .prep-items { padding: 16px; }

        .prep-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .prep-item:last-child { margin-bottom: 0; }

        .prep-item-name {
            font-weight: 500;
            flex: 1;
        }

        .prep-item-qty {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            margin: 0 16px;
            min-width: 60px;
            text-align: right;
        }

        .prep-item-order {
            background: var(--accent-primary);
            color: #000;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 13px;
        }

        .prep-item-order.warning {
            background: var(--accent-warning);
        }

        /* Hu√Ætres d√©tails */
        .huitre-detail {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .huitre-breakdown {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .huitre-breakdown span {
            background: var(--bg-hover);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        /* Commande Summary */
        .order-summary {
            background: linear-gradient(135deg, var(--shopify-green), var(--shopify-dark));
            border-radius: var(--radius);
            padding: 24px;
            color: #fff;
            margin-bottom: 20px;
        }

        .order-summary h3 {
            font-size: 18px;
            margin-bottom: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item .value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        .summary-item .label {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--shopify-green), var(--shopify-dark));
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 { font-size: 20px; }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Config Rules */
        .rule-card {
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 12px;
        }

        .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .rule-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rule-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .rule-input-group label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .rule-input-group input,
        .rule-input-group select {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
        }

        /* Print styles */
        @media print {
            body { background: #fff; color: #000; padding: 10px; }
            .header, .tabs, .filters, .btn, .back-link { display: none !important; }
            .card { break-inside: avoid; border: 1px solid #ccc; }
            .prep-category { break-inside: avoid; }
            .prep-category-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .prep-dashboard { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            .filter-select, .filter-input { width: 100%; }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state .icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state .title { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); }

        /* Alert boxes */
        .alert {
            padding: 16px 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .alert-danger {
            background: linear-gradient(135deg, var(--accent-danger), #c0392b);
            color: #fff;
        }

        .alert-warning {
            background: linear-gradient(135deg, var(--accent-warning), var(--accent-orange));
            color: #000;
        }

        .alert-info {
            background: linear-gradient(135deg, var(--accent-secondary), #0a6d92);
            color: #fff;
        }

        .alert strong { margin-right: 8px; }

        /* Version badge */
        .version-badge {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: var(--bg-card);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Back Link -->
        <a href="index.html" class="back-link">‚Üê Retour TRAKIO</a>

        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="logo">üõçÔ∏è</div>
                <div class="title-block">
                    <h1>Shopify Orders</h1>
                    <div class="subtitle">Gestion des commandes & Pr√©paration</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openConfigModal()">‚öôÔ∏è Configuration</button>
                <button class="btn btn-secondary" onclick="printDashboard()">üñ®Ô∏è Imprimer</button>
                <label class="btn btn-primary">
                    üì• Importer CSV
                    <input type="file" id="csv-input" accept=".csv" onchange="importCSV(this)" style="display:none;">
                </label>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')" id="tab-dashboard">
                üéØ Dashboard Pr√©paration
                <span class="badge" id="tab-badge-prep">0</span>
            </button>
            <button class="tab" onclick="switchTab('orders')" id="tab-orders">
                üìã Commandes
                <span class="badge" id="tab-badge-orders">0</span>
            </button>
        </div>

        <!-- Import Status -->
        <div id="import-status" style="margin-bottom:16px;"></div>

        <!-- ============================================= -->
        <!-- TAB: DASHBOARD PR√âPARATION -->
        <!-- ============================================= -->
        <div id="content-dashboard">
            <!-- Filtres Dashboard -->
            <div class="filters">
                <select id="prep-filter-date" onchange="updateDashboard()" class="filter-select">
                    <option value="all">üìÖ Toutes les dates</option>
                    <option value="today">Aujourd'hui</option>
                    <option value="tomorrow">Demain</option>
                    <option value="week">Cette semaine</option>
                    <option value="custom">P√©riode personnalis√©e</option>
                </select>
                <input type="date" id="prep-date-start" onchange="updateDashboard()" class="filter-select" style="display:none;">
                <input type="date" id="prep-date-end" onchange="updateDashboard()" class="filter-select" style="display:none;">
                <select id="prep-filter-location" onchange="updateDashboard()" class="filter-select">
                    <option value="all">üìç Tous les lieux</option>
                    <option value="Laboratoire">üî¨ Laboratoire Coinsins</option>
                    <option value="Magasin">üè™ Magasin Nyon</option>
                    <option value="Livraison">üì¶ Livraison</option>
                </select>
                <select id="prep-filter-status" onchange="updateDashboard()" class="filter-select">
                    <option value="urgent">üö® √Ä traiter (pay√©es)</option>
                    <option value="all">Toutes les commandes</option>
                    <option value="pending">‚è≥ En attente paiement</option>
                </select>
            </div>

            <!-- Summary -->
            <div class="order-summary" id="prep-summary">
                <h3>üìä R√©sum√© des commandes √† pr√©parer</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="value" id="summary-orders">0</div>
                        <div class="label">Commandes</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="summary-huitres">0</div>
                        <div class="label">ü¶™ Hu√Ætres (pces)</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="summary-fondues">0</div>
                        <div class="label">ü´ï Fondues (pers.)</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="summary-saumon">0</div>
                        <div class="label">üêü Saumons</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="summary-total">0</div>
                        <div class="label">CHF Total</div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="prep-dashboard" id="prep-dashboard">
                <!-- G√©n√©r√© dynamiquement -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="prep-empty" style="display:none;">
                <div class="icon">üìÑ</div>
                <div class="title">Aucune commande √† pr√©parer</div>
                <div>Importez un fichier CSV Shopify ou modifiez vos filtres</div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- TAB: COMMANDES -->
        <!-- ============================================= -->
        <div id="content-orders" style="display:none;">
            <!-- Alertes -->
            <div id="orders-alerts"></div>

            <!-- Stats -->
            <div class="stats-grid" id="orders-stats">
                <div class="stat-card active" onclick="filterOrders('all')">
                    <div class="stat-value" id="stat-total" style="color:var(--shopify-green);">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card" onclick="filterOrders('urgent')">
                    <div class="stat-value" id="stat-urgent" style="color:var(--accent-danger);">0</div>
                    <div class="stat-label">üö® √Ä traiter</div>
                </div>
                <div class="stat-card" onclick="filterOrders('pending')">
                    <div class="stat-value" id="stat-pending" style="color:var(--accent-warning);">0</div>
                    <div class="stat-label">‚è≥ En attente</div>
                </div>
                <div class="stat-card" onclick="filterOrders('fulfilled')">
                    <div class="stat-value" id="stat-fulfilled" style="color:var(--accent-secondary);">0</div>
                    <div class="stat-label">‚úÖ Trait√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-pickup" style="color:var(--accent-primary);">0</div>
                    <div class="stat-label">üè™ Retraits</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-revenue" style="color:var(--text-primary);">0</div>
                    <div class="stat-label">CHF Total</div>
                </div>
            </div>

            <!-- Filtres -->
            <div class="filters">
                <select id="filter-status" onchange="applyFilters()" class="filter-select">
                    <option value="">Tous les statuts</option>
                    <option value="urgent">üö® Pay√©es non trait√©es</option>
                    <option value="pending">‚è≥ En attente paiement</option>
                    <option value="fulfilled">‚úÖ Trait√©es</option>
                    <option value="refunded">‚Ü©Ô∏è Rembours√©es</option>
                </select>
                <select id="filter-location" onchange="applyFilters()" class="filter-select">
                    <option value="">Tous les lieux</option>
                    <option value="Laboratoire">üî¨ Laboratoire Coinsins</option>
                    <option value="Magasin">üè™ Magasin Nyon</option>
                    <option value="Livraison">üì¶ Livraison</option>
                </select>
                <select id="filter-date" onchange="applyFilters()" class="filter-select">
                    <option value="">Toutes les dates</option>
                    <!-- Rempli dynamiquement -->
                </select>
                <input type="text" id="filter-search" placeholder="üîç Rechercher client, n¬∞ commande..." oninput="applyFilters()" class="filter-input">
                <button class="btn btn-secondary" onclick="resetFilters()">‚úï Reset</button>
                <button class="btn btn-secondary" onclick="exportFiltered()">üì§ Exporter</button>
            </div>

            <!-- Table -->
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:40px;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                                <th>N¬∞ Cmd</th>
                                <th>üìÜ Command√©</th>
                                <th>Client</th>
                                <th>üìÖ Retrait</th>
                                <th>üìç Lieu</th>
                                <th>Articles</th>
                                <th>Total</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empty -->
            <div class="empty-state" id="orders-empty" style="display:none;">
                <div class="icon">üìÑ</div>
                <div class="title">Aucune commande</div>
                <div>Importez un fichier CSV Shopify pour commencer</div>
            </div>
        </div>
    </div>

    <!-- Modal D√©tail Commande -->
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <div style="font-size:12px;opacity:0.8;">COMMANDE SHOPIFY</div>
                    <h2 id="modal-order-id">#0000</h2>
                </div>
                <button class="modal-close" onclick="closeOrderModal()">√ó</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Contenu dynamique -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="printOrder()">üñ®Ô∏è Imprimer</button>
                <button class="btn btn-primary" onclick="markProcessed()" id="modal-btn-process">‚úÖ Marquer trait√©e</button>
            </div>
        </div>
    </div>

    <!-- Modal Configuration -->
    <div class="modal" id="config-modal">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configuration des r√®gles</h2>
                <button class="modal-close" onclick="closeConfigModal()">√ó</button>
            </div>
            <div class="modal-body">
                <h4 style="margin-bottom:16px;">ü¶™ Conditionnements Hu√Ætres</h4>
                <div class="rule-card">
                    <div class="rule-header">
                        <span class="rule-title">üì¶ Bourriches disponibles</span>
                    </div>
                    <div class="rule-inputs">
                        <div class="rule-input-group">
                            <label>Tailles (s√©par√©es par virgule)</label>
                            <input type="text" id="config-bourriches" value="12,24,48,96" placeholder="12,24,48,96">
                        </div>
                        <div class="rule-input-group">
                            <label>Strat√©gie d'arrondi</label>
                            <select id="config-rounding">
                                <option value="up">Arrondir au sup√©rieur</option>
                                <option value="nearest">Au plus proche</option>
                                <option value="down">Arrondir √† l'inf√©rieur</option>
                            </select>
                        </div>
                    </div>
                </div>

                <h4 style="margin:24px 0 16px;">ü´ï Fondues</h4>
                <div class="rule-card">
                    <div class="rule-inputs">
                        <div class="rule-input-group">
                            <label>Mot-cl√© identification</label>
                            <input type="text" id="config-fondue-keyword" value="Fondue" placeholder="Fondue">
                        </div>
                        <div class="rule-input-group">
                            <label>Regex personnes</label>
                            <input type="text" id="config-fondue-regex" value="(\d+)\s*pers" placeholder="(\d+)\s*pers">
                        </div>
                    </div>
                </div>

                <h4 style="margin:24px 0 16px;">ü¶™ Types d'Hu√Ætres</h4>
                <div class="rule-card">
                    <div style="font-size:13px; color:var(--text-muted); margin-bottom:12px;">
                        D√©finissez les types d'hu√Ætres et leurs codes SKU
                    </div>
                    <div id="config-huitre-types">
                        <!-- G√©n√©r√© dynamiquement -->
                    </div>
                    <button class="btn btn-secondary" onclick="addHuitreType()" style="margin-top:12px;">+ Ajouter type</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetConfig()">R√©initialiser</button>
                <button class="btn btn-primary" onclick="saveConfig()">üíæ Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Version -->
    <div class="version-badge">TRAKIO Shopify v1.0.0</div>

    <script>
        // =============================================
        // DONN√âES ET √âTAT
        // =============================================
        let ShopifyData = {
            orders: [],
            filteredOrders: [],
            processedOrders: JSON.parse(localStorage.getItem('shopify_processed') || '[]'),
            currentOrder: null
        };

        // Configuration par d√©faut
        let Config = JSON.parse(localStorage.getItem('shopify_config') || 'null') || {
            bourriches: [12, 24, 48, 96],
            rounding: 'up',
            fondueKeyword: 'Fondue',
            fondueRegex: '(\\d+)\\s*pers',
            huitreTypes: [
                { name: 'Fines de Claires', code: 'F', skuPrefix: 'F3' },
                { name: 'Sp√©ciales de Claires', code: 'S', skuPrefix: 'S3' },
                { name: 'Gillardeau', code: 'G', skuPrefix: 'G3' }
            ]
        };

        // =============================================
        // INITIALISATION
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Charger les commandes sauvegard√©es
            const saved = localStorage.getItem('shopify_orders');
            if (saved) {
                ShopifyData.orders = JSON.parse(saved);
                ShopifyData.filteredOrders = [...ShopifyData.orders];
                showData();
            }

            // √âcouteur pour filtre date personnalis√©e
            document.getElementById('prep-filter-date').addEventListener('change', function() {
                const isCustom = this.value === 'custom';
                document.getElementById('prep-date-start').style.display = isCustom ? 'block' : 'none';
                document.getElementById('prep-date-end').style.display = isCustom ? 'block' : 'none';
            });
        });

        // =============================================
        // IMPORT CSV
        // =============================================
        function importCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const statusEl = document.getElementById('import-status');
            statusEl.innerHTML = '<div class="alert alert-info"><strong>‚è≥ Import en cours...</strong></div>';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = parseCSV(text);

                    if (lines.length < 2) {
                        statusEl.innerHTML = '<div class="alert alert-danger"><strong>‚ùå Erreur:</strong> Fichier vide ou invalide</div>';
                        return;
                    }

                    const headers = lines[0];
                    const orders = {};

                    // Index des colonnes
                    const idx = {
                        name: headers.indexOf('Name'),
                        email: headers.indexOf('Email'),
                        financialStatus: headers.indexOf('Financial Status'),
                        fulfillmentStatus: headers.indexOf('Fulfillment Status'),
                        currency: headers.indexOf('Currency'),
                        total: headers.indexOf('Total'),
                        shippingMethod: headers.indexOf('Shipping Method'),
                        createdAt: headers.indexOf('Created at'),
                        lineitemQty: headers.indexOf('Lineitem quantity'),
                        lineitemName: headers.indexOf('Lineitem name'),
                        lineitemPrice: headers.indexOf('Lineitem price'),
                        lineitemSku: headers.indexOf('Lineitem sku'),
                        billingName: headers.indexOf('Billing Name'),
                        billingPhone: headers.indexOf('Billing Phone'),
                        billingCity: headers.indexOf('Billing City'),
                        shippingName: headers.indexOf('Shipping Name'),
                        shippingCity: headers.indexOf('Shipping City'),
                        notes: headers.indexOf('Notes'),
                        tags: headers.indexOf('Tags'),
                        id: headers.indexOf('Id')
                    };

                    // Parser les lignes
                    for (let i = 1; i < lines.length; i++) {
                        const row = lines[i];
                        const orderName = row[idx.name];
                        if (!orderName) continue;

                        if (!orders[orderName]) {
                            const tags = row[idx.tags] || '';
                            const pickupInfo = parsePickupInfo(tags);

                            orders[orderName] = {
                                id: row[idx.id] || orderName,
                                name: orderName,
                                email: row[idx.email] || '',
                                financialStatus: row[idx.financialStatus] || '',
                                fulfillmentStatus: row[idx.fulfillmentStatus] || '',
                                currency: row[idx.currency] || 'CHF',
                                total: parseFloat(row[idx.total]) || 0,
                                shippingMethod: row[idx.shippingMethod] || '',
                                createdAt: row[idx.createdAt] || '',
                                billingName: row[idx.billingName] || '',
                                billingPhone: row[idx.billingPhone] || '',
                                billingCity: row[idx.billingCity] || '',
                                shippingName: row[idx.shippingName] || '',
                                shippingCity: row[idx.shippingCity] || '',
                                notes: row[idx.notes] || '',
                                tags: tags,
                                pickupDate: pickupInfo.date,
                                pickupDateObj: pickupInfo.dateObj,
                                pickupTime: pickupInfo.time,
                                pickupLocation: pickupInfo.location,
                                isPickup: pickupInfo.isPickup,
                                items: [],
                                processed: ShopifyData.processedOrders.includes(orderName)
                            };
                        }

                        // Ajouter l'article
                        const itemName = row[idx.lineitemName];
                        if (itemName) {
                            orders[orderName].items.push({
                                name: itemName,
                                quantity: parseInt(row[idx.lineitemQty]) || 1,
                                price: parseFloat(row[idx.lineitemPrice]) || 0,
                                sku: row[idx.lineitemSku] || ''
                            });
                        }
                    }

                    // Convertir et trier
                    ShopifyData.orders = Object.values(orders).sort((a, b) => {
                        const dateA = a.pickupDateObj || new Date(a.createdAt);
                        const dateB = b.pickupDateObj || new Date(b.createdAt);
                        return dateA - dateB;
                    });

                    ShopifyData.filteredOrders = [...ShopifyData.orders];

                    // Sauvegarder
                    localStorage.setItem('shopify_orders', JSON.stringify(ShopifyData.orders));

                    // Afficher
                    showData();
                    statusEl.innerHTML = `<div class="alert alert-info"><strong>‚úÖ Import r√©ussi!</strong> ${ShopifyData.orders.length} commandes import√©es</div>`;

                    setTimeout(() => { statusEl.innerHTML = ''; }, 3000);

                } catch(err) {
                    console.error('Erreur import:', err);
                    statusEl.innerHTML = `<div class="alert alert-danger"><strong>‚ùå Erreur:</strong> ${err.message}</div>`;
                }
            };
            reader.readAsText(file, 'UTF-8');
            input.value = '';
        }

        // Parser CSV
        function parseCSV(text) {
            const lines = [];
            let currentLine = [];
            let currentField = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        currentField += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        currentLine.push(currentField);
                        currentField = '';
                    } else if (char === '\n' || (char === '\r' && nextChar === '\n')) {
                        currentLine.push(currentField);
                        if (currentLine.length > 1 || currentLine[0] !== '') {
                            lines.push(currentLine);
                        }
                        currentLine = [];
                        currentField = '';
                        if (char === '\r') i++;
                    } else if (char !== '\r') {
                        currentField += char;
                    }
                }
            }

            if (currentField || currentLine.length > 0) {
                currentLine.push(currentField);
                if (currentLine.length > 1 || currentLine[0] !== '') {
                    lines.push(currentLine);
                }
            }

            return lines;
        }

        // Parser infos pickup
        function parsePickupInfo(tags) {
            const result = { date: '', dateObj: null, time: '', location: '', isPickup: false };
            if (!tags) return result;

            if (tags.includes('Store Pickup')) result.isPickup = true;

            if (tags.includes('Laboratoire')) {
                result.location = 'Laboratoire de Coinsins';
            } else if (tags.includes('Magasin')) {
                result.location = 'Magasin de Nyon';
            } else if (tags.includes('Shipping') || tags.includes('Swiss Post')) {
                result.location = 'Livraison';
            }

            // Date (format: "26 Dec 2025")
            const dateMatch = tags.match(/(\d{1,2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d{4})/i);
            if (dateMatch) {
                result.date = dateMatch[0];
                const months = { 'Jan':0, 'Feb':1, 'Mar':2, 'Apr':3, 'May':4, 'Jun':5, 'Jul':6, 'Aug':7, 'Sep':8, 'Oct':9, 'Nov':10, 'Dec':11 };
                result.dateObj = new Date(parseInt(dateMatch[3]), months[dateMatch[2]], parseInt(dateMatch[1]));
            }

            // Heure
            const timeMatch = tags.match(/(\d{1,2}:\d{2}\s*(?:AM|PM)\s*-\s*\d{1,2}:\d{2}\s*(?:AM|PM))/i);
            if (timeMatch) result.time = timeMatch[1];

            return result;
        }

        // =============================================
        // AFFICHAGE
        // =============================================
        function showData() {
            updateStats();
            updateDashboard();
            renderOrders();
            populateDateFilter();
            updateBadges();
        }

        function updateBadges() {
            const urgent = ShopifyData.orders.filter(o => 
                o.financialStatus === 'paid' && 
                o.fulfillmentStatus !== 'fulfilled' && 
                !o.processed
            ).length;
            
            document.getElementById('tab-badge-prep').textContent = urgent;
            document.getElementById('tab-badge-orders').textContent = ShopifyData.orders.length;
        }

        function updateStats() {
            const orders = ShopifyData.orders;
            const urgent = orders.filter(o => o.financialStatus === 'paid' && o.fulfillmentStatus !== 'fulfilled' && !o.processed).length;
            const pending = orders.filter(o => o.financialStatus === 'pending').length;
            const fulfilled = orders.filter(o => o.processed || o.fulfillmentStatus === 'fulfilled').length;
            const pickup = orders.filter(o => o.isPickup).length;
            const revenue = orders.reduce((sum, o) => sum + o.total, 0);

            document.getElementById('stat-total').textContent = orders.length;
            document.getElementById('stat-urgent').textContent = urgent;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-fulfilled').textContent = fulfilled;
            document.getElementById('stat-pickup').textContent = pickup;
            document.getElementById('stat-revenue').textContent = revenue.toFixed(0);

            // Alertes
            const alertsHtml = [];
            if (urgent > 0) {
                alertsHtml.push(`<div class="alert alert-danger"><strong>üö® ${urgent} commande(s) pay√©e(s) non trait√©e(s)!</strong><button class="btn btn-secondary" onclick="filterOrders('urgent')" style="padding:6px 12px;margin-left:12px;">Voir ‚Üí</button></div>`);
            }
            document.getElementById('orders-alerts').innerHTML = alertsHtml.join('');
        }

        // =============================================
        // DASHBOARD PR√âPARATION
        // =============================================
        function updateDashboard() {
            const filteredOrders = getFilteredOrdersForDashboard();
            
            if (filteredOrders.length === 0) {
                document.getElementById('prep-dashboard').innerHTML = '';
                document.getElementById('prep-empty').style.display = 'block';
                updateSummary([], {});
                return;
            }

            document.getElementById('prep-empty').style.display = 'none';

            // Agr√©gation par cat√©gorie
            const categories = {
                huitres: { items: {}, total: 0, icon: 'ü¶™', label: 'Hu√Ætres', class: 'huitres' },
                fondues: { items: {}, total: 0, icon: 'ü´ï', label: 'Fondues', class: 'fondues' },
                saumon: { items: {}, total: 0, icon: 'üêü', label: 'Saumon Fum√©', class: 'saumon' },
                foiegras: { items: {}, total: 0, icon: 'üç∑', label: 'Foie Gras', class: 'foiegras' },
                fruitsmer: { items: {}, total: 0, icon: 'ü¶ê', label: 'Fruits de Mer', class: 'fruitsmer' },
                autres: { items: {}, total: 0, icon: 'üì¶', label: 'Autres Produits', class: 'autres' }
            };

            // Analyser chaque commande
            filteredOrders.forEach(order => {
                order.items.forEach(item => {
                    const itemData = analyzeItem(item);
                    const cat = categories[itemData.category];
                    
                    if (!cat.items[itemData.key]) {
                        cat.items[itemData.key] = {
                            name: itemData.name,
                            qty: 0,
                            details: itemData.details,
                            isHuitre: itemData.category === 'huitres',
                            huitreType: itemData.huitreType,
                            pieces: 0,
                            isFondue: itemData.category === 'fondues',
                            persons: 0
                        };
                    }
                    
                    cat.items[itemData.key].qty += item.quantity;
                    
                    if (itemData.category === 'huitres') {
                        cat.items[itemData.key].pieces += itemData.pieces * item.quantity;
                        cat.total += itemData.pieces * item.quantity;
                    } else if (itemData.category === 'fondues' && itemData.persons) {
                        cat.items[itemData.key].persons += itemData.persons * item.quantity;
                        cat.total += itemData.persons * item.quantity;
                    } else {
                        cat.total += item.quantity;
                    }
                });
            });

            // G√©n√©rer le HTML
            let html = '';
            
            Object.entries(categories).forEach(([key, cat]) => {
                if (Object.keys(cat.items).length === 0) return;

                html += `
                    <div class="prep-category">
                        <div class="prep-category-header ${cat.class}">
                            <h4>${cat.icon} ${cat.label}</h4>
                            <span class="total">${cat.total} ${key === 'huitres' ? 'pces' : key === 'fondues' ? 'pers.' : 'unit√©s'}</span>
                        </div>
                        <div class="prep-items">
                `;

                Object.values(cat.items).forEach(item => {
                    if (item.isHuitre) {
                        const orderQty = calculateBourriche(item.pieces);
                        html += `
                            <div class="prep-item">
                                <div>
                                    <div class="prep-item-name">${item.name}</div>
                                    <div class="huitre-detail">${item.details}</div>
                                </div>
                                <div class="prep-item-qty">${item.pieces} pces</div>
                                <div class="prep-item-order ${orderQty.warning ? 'warning' : ''}">${orderQty.text}</div>
                            </div>
                        `;
                    } else if (item.isFondue) {
                        html += `
                            <div class="prep-item">
                                <div class="prep-item-name">${item.name}</div>
                                <div class="prep-item-qty">${item.qty}x</div>
                                <div class="prep-item-order">${item.persons} pers.</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="prep-item">
                                <div class="prep-item-name">${item.name}</div>
                                <div class="prep-item-qty">${item.qty}</div>
                                <div class="prep-item-order">${item.qty} unit√©s</div>
                            </div>
                        `;
                    }
                });

                html += '</div></div>';
            });

            document.getElementById('prep-dashboard').innerHTML = html;
            updateSummary(filteredOrders, categories);
        }

        function updateSummary(orders, categories) {
            document.getElementById('summary-orders').textContent = orders.length;
            document.getElementById('summary-huitres').textContent = categories.huitres?.total || 0;
            document.getElementById('summary-fondues').textContent = categories.fondues?.total || 0;
            document.getElementById('summary-saumon').textContent = categories.saumon?.total || 0;
            document.getElementById('summary-total').textContent = orders.reduce((sum, o) => sum + o.total, 0).toFixed(0);
        }

        function getFilteredOrdersForDashboard() {
            let orders = [...ShopifyData.orders];
            
            // Filtre statut
            const statusFilter = document.getElementById('prep-filter-status').value;
            if (statusFilter === 'urgent') {
                orders = orders.filter(o => o.financialStatus === 'paid' && o.fulfillmentStatus !== 'fulfilled' && !o.processed);
            } else if (statusFilter === 'pending') {
                orders = orders.filter(o => o.financialStatus === 'pending');
            }

            // Filtre lieu
            const locationFilter = document.getElementById('prep-filter-location').value;
            if (locationFilter !== 'all') {
                orders = orders.filter(o => o.pickupLocation && o.pickupLocation.includes(locationFilter));
            }

            // Filtre date
            const dateFilter = document.getElementById('prep-filter-date').value;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (dateFilter === 'today') {
                orders = orders.filter(o => o.pickupDateObj && isSameDay(o.pickupDateObj, today));
            } else if (dateFilter === 'tomorrow') {
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                orders = orders.filter(o => o.pickupDateObj && isSameDay(o.pickupDateObj, tomorrow));
            } else if (dateFilter === 'week') {
                const weekEnd = new Date(today);
                weekEnd.setDate(weekEnd.getDate() + 7);
                orders = orders.filter(o => o.pickupDateObj && o.pickupDateObj >= today && o.pickupDateObj <= weekEnd);
            } else if (dateFilter === 'custom') {
                const startDate = document.getElementById('prep-date-start').value;
                const endDate = document.getElementById('prep-date-end').value;
                if (startDate) {
                    const start = new Date(startDate);
                    orders = orders.filter(o => o.pickupDateObj && o.pickupDateObj >= start);
                }
                if (endDate) {
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59);
                    orders = orders.filter(o => o.pickupDateObj && o.pickupDateObj <= end);
                }
            }

            return orders;
        }

        function isSameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        }

        // Analyser un article
        function analyzeItem(item) {
            const name = item.name;
            const sku = item.sku || '';

            // HU√éTRES
            if (name.includes('Hu√Ætres') || name.includes('Hu√Ætre')) {
                const huitreInfo = parseHuitre(name, sku);
                return {
                    category: 'huitres',
                    key: huitreInfo.key,
                    name: huitreInfo.type,
                    details: huitreInfo.details,
                    pieces: huitreInfo.pieces,
                    huitreType: huitreInfo.type
                };
            }

            // FONDUES
            if (name.includes(Config.fondueKeyword)) {
                const persMatch = name.match(new RegExp(Config.fondueRegex, 'i'));
                const persons = persMatch ? parseInt(persMatch[1]) : 0;
                
                // Ignorer les accessoires (bouillon, caquelon)
                if (name.includes('Bouillon') || name.includes('Location') || name.includes('caquelon')) {
                    return {
                        category: 'autres',
                        key: name,
                        name: name,
                        details: '',
                        persons: 0
                    };
                }
                
                return {
                    category: 'fondues',
                    key: name,
                    name: name.replace('Fondue de Poissons - ', ''),
                    details: '',
                    persons: persons
                };
            }

            // SAUMON FUM√â / GRAVLAX
            if (name.includes('Saumon Fum√©') || name.includes('Saumon fum√©') || name.includes('Gravlax') || name.includes('marin√©')) {
                return {
                    category: 'saumon',
                    key: name,
                    name: name,
                    details: ''
                };
            }

            // FOIE GRAS
            if (name.includes('Foie Gras')) {
                return {
                    category: 'foiegras',
                    key: name,
                    name: name,
                    details: ''
                };
            }

            // FRUITS DE MER
            if (name.includes('Gambas') || name.includes('Bulots') || name.includes('Bateau fruits') || 
                name.includes('poulpe') || name.includes('Crevettes')) {
                return {
                    category: 'fruitsmer',
                    key: name,
                    name: name,
                    details: ''
                };
            }

            // AUTRES
            return {
                category: 'autres',
                key: name,
                name: name,
                details: ''
            };
        }

        // Parser hu√Ætres
        function parseHuitre(name, sku) {
            let type = 'Hu√Ætres';
            let pieces = 0;
            let etat = '';
            
            // Identifier le type
            Config.huitreTypes.forEach(ht => {
                if (name.includes(ht.name) || sku.startsWith(ht.skuPrefix)) {
                    type = ht.name;
                }
            });

            // Extraire le nombre de pi√®ces
            const piecesMatch = name.match(/(\d+)\s*pces?/i) || sku.match(/(\d+)\s*pces?/i);
            if (piecesMatch) {
                pieces = parseInt(piecesMatch[1]);
            }

            // √âtat (ouvert/ferm√©)
            if (name.includes('Ouverte') || sku.includes('Ouverte')) {
                etat = 'Ouvertes';
            } else if (name.includes('Ferm√©') || sku.includes('Ferm√©e')) {
                etat = 'Ferm√©es';
            }

            return {
                type: type,
                pieces: pieces,
                etat: etat,
                key: `${type}-${etat}`,
                details: `${etat}${pieces ? ' - Cond. ' + pieces + ' pces' : ''}`
            };
        }

        // Calculer bourriche optimale
        function calculateBourriche(totalPieces) {
            const bourriches = Config.bourriches.sort((a, b) => a - b);
            
            // Trouver la meilleure combinaison
            let bestCombo = [];
            let remaining = totalPieces;
            
            // Commencer par les plus grandes
            for (let i = bourriches.length - 1; i >= 0; i--) {
                const size = bourriches[i];
                while (remaining >= size) {
                    bestCombo.push(size);
                    remaining -= size;
                }
            }
            
            // S'il reste des pi√®ces, arrondir au sup√©rieur
            if (remaining > 0) {
                // Trouver la plus petite bourriche >= remaining
                const smallestFit = bourriches.find(b => b >= remaining) || bourriches[bourriches.length - 1];
                bestCombo.push(smallestFit);
            }

            // Grouper par taille
            const counts = {};
            bestCombo.forEach(size => {
                counts[size] = (counts[size] || 0) + 1;
            });

            const text = Object.entries(counts)
                .map(([size, count]) => `${count}√ó${size}`)
                .join(' + ');

            const totalInBourriches = bestCombo.reduce((sum, b) => sum + b, 0);
            const warning = totalInBourriches > totalPieces;

            return { text, warning, total: totalInBourriches };
        }

        // =============================================
        // LISTE COMMANDES
        // =============================================
        function renderOrders() {
            const tbody = document.getElementById('orders-tbody');
            const orders = ShopifyData.filteredOrders;

            if (orders.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('orders-empty').style.display = 'block';
                return;
            }

            document.getElementById('orders-empty').style.display = 'none';

            tbody.innerHTML = orders.map(order => {
                const isUrgent = order.financialStatus === 'paid' && order.fulfillmentStatus !== 'fulfilled' && !order.processed;
                const isPending = order.financialStatus === 'pending';
                const isProcessed = order.processed || order.fulfillmentStatus === 'fulfilled';
                const isRefunded = order.financialStatus === 'refunded';

                let rowStyle = '';
                if (isUrgent) rowStyle = 'background:rgba(231,76,60,0.1); border-left:4px solid var(--accent-danger);';
                else if (isPending) rowStyle = 'background:rgba(241,196,15,0.1);';
                else if (isProcessed) rowStyle = 'opacity:0.6;';

                let statusBadge = '';
                if (isRefunded) statusBadge = '<span class="badge badge-danger">‚Ü©Ô∏è Rembours√©e</span>';
                else if (isProcessed) statusBadge = '<span class="badge badge-info">‚úÖ Trait√©e</span>';
                else if (isUrgent) statusBadge = '<span class="badge badge-danger">üö® √Ä traiter</span>';
                else if (isPending) statusBadge = '<span class="badge badge-warning">‚è≥ Paiement</span>';
                else statusBadge = `<span class="badge badge-muted">${order.financialStatus}</span>`;

                let locationBadge = '';
                if (order.pickupLocation?.includes('Laboratoire')) locationBadge = '<span style="color:var(--accent-primary);">üî¨ Labo</span>';
                else if (order.pickupLocation?.includes('Magasin')) locationBadge = '<span style="color:var(--accent-secondary);">üè™ Nyon</span>';
                else if (order.isPickup) locationBadge = '<span style="color:var(--text-muted);">üìç Retrait</span>';
                else locationBadge = '<span style="color:var(--accent-warning);">üì¶ Livraison</span>';

                const orderDate = order.createdAt ? formatDate(order.createdAt) : '-';

                return `
                    <tr style="${rowStyle}" onclick="showOrderDetail('${order.name}')" class="clickable-row">
                        <td onclick="event.stopPropagation()"><input type="checkbox" class="order-check" data-order="${order.name}"></td>
                        <td><strong style="color:var(--shopify-green);">${order.name}</strong></td>
                        <td style="font-size:12px; color:var(--text-muted);">${orderDate}</td>
                        <td>
                            <div style="font-weight:600;">${order.billingName || order.shippingName || 'N/A'}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${order.billingCity || order.shippingCity || ''}</div>
                        </td>
                        <td>
                            <div style="font-weight:600; color:${isUrgent ? 'var(--accent-danger)' : 'var(--text-primary)'};">${order.pickupDate || '-'}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${order.pickupTime || ''}</div>
                        </td>
                        <td>${locationBadge}</td>
                        <td><div style="font-size:12px;">${order.items.length} article(s)</div></td>
                        <td style="font-family:'Space Mono',monospace; font-weight:600;">${order.total.toFixed(2)} ${order.currency}</td>
                        <td>${statusBadge}</td>
                        <td onclick="event.stopPropagation()">
                            <button class="btn btn-secondary" onclick="showOrderDetail('${order.name}')" style="padding:6px 10px;">üëÅÔ∏è</button>
                            ${!isProcessed && !isRefunded ? `<button class="btn btn-primary" onclick="markOrderProcessed('${order.name}')" style="padding:6px 10px;margin-left:4px;">‚úì</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function formatDate(dateStr) {
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fr-CH', { day: '2-digit', month: '2-digit', year: '2-digit' });
            } catch(e) {
                return dateStr.substring(0, 10);
            }
        }

        // Filtres commandes
        function applyFilters() {
            let orders = [...ShopifyData.orders];

            const statusFilter = document.getElementById('filter-status').value;
            const locationFilter = document.getElementById('filter-location').value;
            const dateFilter = document.getElementById('filter-date').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();

            if (statusFilter === 'urgent') {
                orders = orders.filter(o => o.financialStatus === 'paid' && o.fulfillmentStatus !== 'fulfilled' && !o.processed);
            } else if (statusFilter === 'pending') {
                orders = orders.filter(o => o.financialStatus === 'pending');
            } else if (statusFilter === 'fulfilled') {
                orders = orders.filter(o => o.processed || o.fulfillmentStatus === 'fulfilled');
            } else if (statusFilter === 'refunded') {
                orders = orders.filter(o => o.financialStatus === 'refunded');
            }

            if (locationFilter) {
                orders = orders.filter(o => o.pickupLocation && o.pickupLocation.includes(locationFilter));
            }

            if (dateFilter) {
                orders = orders.filter(o => o.pickupDate === dateFilter);
            }

            if (searchFilter) {
                orders = orders.filter(o => 
                    o.name.toLowerCase().includes(searchFilter) ||
                    (o.billingName && o.billingName.toLowerCase().includes(searchFilter)) ||
                    (o.email && o.email.toLowerCase().includes(searchFilter))
                );
            }

            ShopifyData.filteredOrders = orders;
            renderOrders();
        }

        function filterOrders(type) {
            document.getElementById('filter-status').value = type === 'all' ? '' : type;
            applyFilters();
            
            // Highlight stat card
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            event.target.closest('.stat-card')?.classList.add('active');
        }

        function resetFilters() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-location').value = '';
            document.getElementById('filter-date').value = '';
            document.getElementById('filter-search').value = '';
            ShopifyData.filteredOrders = [...ShopifyData.orders];
            renderOrders();
        }

        function populateDateFilter() {
            const dates = [...new Set(ShopifyData.orders.map(o => o.pickupDate).filter(d => d))];
            const select = document.getElementById('filter-date');
            select.innerHTML = '<option value="">Toutes les dates</option>';
            dates.sort().forEach(date => {
                select.innerHTML += `<option value="${date}">${date}</option>`;
            });
        }

        // =============================================
        // MODALS
        // =============================================
        function showOrderDetail(orderName) {
            const order = ShopifyData.orders.find(o => o.name === orderName);
            if (!order) return;

            ShopifyData.currentOrder = order;

            document.getElementById('modal-order-id').textContent = order.name;

            const isProcessed = order.processed || order.fulfillmentStatus === 'fulfilled';
            document.getElementById('modal-btn-process').style.display = isProcessed ? 'none' : 'block';

            const body = document.getElementById('modal-body');
            body.innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div>
                        <h4 style="color:var(--text-muted); font-size:12px; margin-bottom:8px;">CLIENT</h4>
                        <div style="font-weight:600; font-size:18px;">${order.billingName || order.shippingName || 'N/A'}</div>
                        <div style="color:var(--text-muted);">${order.email || ''}</div>
                        <div style="color:var(--text-muted);">${order.billingPhone || ''}</div>
                        <div style="color:var(--text-muted);">${order.billingCity || order.shippingCity || ''}</div>
                    </div>
                    <div>
                        <h4 style="color:var(--text-muted); font-size:12px; margin-bottom:8px;">RETRAIT</h4>
                        <div style="font-weight:600; font-size:18px; color:var(--accent-primary);">${order.pickupDate || '-'}</div>
                        <div>${order.pickupTime || ''}</div>
                        <div style="color:var(--accent-secondary);">${order.pickupLocation || 'Livraison'}</div>
                    </div>
                </div>

                ${order.notes ? `
                <div style="background:var(--accent-warning)20; border-left:4px solid var(--accent-warning); padding:12px 16px; border-radius:8px; margin-bottom:20px;">
                    <strong>üìù Notes client:</strong><br>
                    <span style="white-space:pre-wrap;">${order.notes}</span>
                </div>
                ` : ''}

                <h4 style="color:var(--text-muted); font-size:12px; margin-bottom:12px;">ARTICLES</h4>
                <div style="background:var(--bg-primary); border-radius:12px; padding:16px;">
                    ${order.items.map(item => `
                        <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border-color);">
                            <div>
                                <div style="font-weight:500;">${item.name}</div>
                                <div style="font-size:12px; color:var(--text-muted);">SKU: ${item.sku || '-'}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:600;">${item.quantity}x</div>
                                <div style="font-family:'Space Mono',monospace;">${item.price.toFixed(2)} CHF</div>
                            </div>
                        </div>
                    `).join('')}
                    <div style="display:flex; justify-content:space-between; padding:16px 0 0; font-size:18px; font-weight:700;">
                        <span>TOTAL</span>
                        <span style="color:var(--shopify-green); font-family:'Space Mono',monospace;">${order.total.toFixed(2)} ${order.currency}</span>
                    </div>
                </div>
            `;

            document.getElementById('order-modal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('active');
            ShopifyData.currentOrder = null;
        }

        function markProcessed() {
            if (ShopifyData.currentOrder) {
                markOrderProcessed(ShopifyData.currentOrder.name);
                closeOrderModal();
            }
        }

        function markOrderProcessed(orderName) {
            const order = ShopifyData.orders.find(o => o.name === orderName);
            if (order) {
                order.processed = true;
                if (!ShopifyData.processedOrders.includes(orderName)) {
                    ShopifyData.processedOrders.push(orderName);
                    localStorage.setItem('shopify_processed', JSON.stringify(ShopifyData.processedOrders));
                }
                localStorage.setItem('shopify_orders', JSON.stringify(ShopifyData.orders));
                showData();
            }
        }

        // =============================================
        // CONFIGURATION
        // =============================================
        function openConfigModal() {
            document.getElementById('config-bourriches').value = Config.bourriches.join(',');
            document.getElementById('config-rounding').value = Config.rounding;
            document.getElementById('config-fondue-keyword').value = Config.fondueKeyword;
            document.getElementById('config-fondue-regex').value = Config.fondueRegex;
            
            renderHuitreTypes();
            document.getElementById('config-modal').classList.add('active');
        }

        function closeConfigModal() {
            document.getElementById('config-modal').classList.remove('active');
        }

        function renderHuitreTypes() {
            const container = document.getElementById('config-huitre-types');
            container.innerHTML = Config.huitreTypes.map((ht, i) => `
                <div style="display:grid; grid-template-columns:1fr 80px 100px 40px; gap:8px; margin-bottom:8px; align-items:center;">
                    <input type="text" value="${ht.name}" onchange="updateHuitreType(${i}, 'name', this.value)" placeholder="Nom">
                    <input type="text" value="${ht.code}" onchange="updateHuitreType(${i}, 'code', this.value)" placeholder="Code">
                    <input type="text" value="${ht.skuPrefix}" onchange="updateHuitreType(${i}, 'skuPrefix', this.value)" placeholder="SKU">
                    <button onclick="removeHuitreType(${i})" style="background:var(--accent-danger); color:#fff; border:none; padding:8px; border-radius:6px; cursor:pointer;">√ó</button>
                </div>
            `).join('');
        }

        function updateHuitreType(index, field, value) {
            Config.huitreTypes[index][field] = value;
        }

        function addHuitreType() {
            Config.huitreTypes.push({ name: '', code: '', skuPrefix: '' });
            renderHuitreTypes();
        }

        function removeHuitreType(index) {
            Config.huitreTypes.splice(index, 1);
            renderHuitreTypes();
        }

        function saveConfig() {
            Config.bourriches = document.getElementById('config-bourriches').value
                .split(',')
                .map(v => parseInt(v.trim()))
                .filter(v => !isNaN(v))
                .sort((a, b) => a - b);
            Config.rounding = document.getElementById('config-rounding').value;
            Config.fondueKeyword = document.getElementById('config-fondue-keyword').value;
            Config.fondueRegex = document.getElementById('config-fondue-regex').value;
            
            localStorage.setItem('shopify_config', JSON.stringify(Config));
            closeConfigModal();
            updateDashboard();
            
            alert('‚úÖ Configuration sauvegard√©e!');
        }

        function resetConfig() {
            if (confirm('R√©initialiser la configuration par d√©faut?')) {
                Config = {
                    bourriches: [12, 24, 48, 96],
                    rounding: 'up',
                    fondueKeyword: 'Fondue',
                    fondueRegex: '(\\d+)\\s*pers',
                    huitreTypes: [
                        { name: 'Fines de Claires', code: 'F', skuPrefix: 'F3' },
                        { name: 'Sp√©ciales de Claires', code: 'S', skuPrefix: 'S3' },
                        { name: 'Gillardeau', code: 'G', skuPrefix: 'G3' }
                    ]
                };
                localStorage.setItem('shopify_config', JSON.stringify(Config));
                openConfigModal();
            }
        }

        // =============================================
        // TABS & UTILITIES
        // =============================================
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            
            document.getElementById('content-dashboard').style.display = tab === 'dashboard' ? 'block' : 'none';
            document.getElementById('content-orders').style.display = tab === 'orders' ? 'block' : 'none';
        }

        function toggleSelectAll() {
            const checked = document.getElementById('select-all').checked;
            document.querySelectorAll('.order-check').forEach(cb => cb.checked = checked);
        }

        function printDashboard() {
            window.print();
        }

        function printOrder() {
            const order = ShopifyData.currentOrder;
            if (!order) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Commande ${order.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #96bf48; }
                        .info { margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
                        th { background: #f5f5f5; }
                        .total { font-size: 18px; font-weight: bold; text-align: right; margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <h1>üõçÔ∏è Commande ${order.name}</h1>
                    <div class="info">
                        <p><strong>Client:</strong> ${order.billingName || order.shippingName}</p>
                        <p><strong>Retrait:</strong> ${order.pickupDate} ${order.pickupTime} - ${order.pickupLocation}</p>
                        ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                    </div>
                    <table>
                        <thead><tr><th>Article</th><th>Qt√©</th><th>Prix</th></tr></thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.price.toFixed(2)} CHF</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="total">TOTAL: ${order.total.toFixed(2)} ${order.currency}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function exportFiltered() {
            const orders = ShopifyData.filteredOrders;
            if (orders.length === 0) {
                alert('Aucune commande √† exporter');
                return;
            }

            let csv = 'N¬∞ Commande,Client,Email,Date Retrait,Lieu,Articles,Total,Statut\n';
            orders.forEach(o => {
                const status = o.processed ? 'Trait√©e' : (o.financialStatus === 'paid' ? '√Ä traiter' : o.financialStatus);
                csv += `"${o.name}","${o.billingName || o.shippingName}","${o.email}","${o.pickupDate}","${o.pickupLocation}","${o.items.length}","${o.total}","${status}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `shopify_export_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>

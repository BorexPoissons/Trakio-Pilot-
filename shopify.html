<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>TRAKIO Shopify v5.0.4 - Commandes</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõçÔ∏è</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #0ea5e9;
            --accent-hover: #38bdf8;
            --accent-primary: #06d6a0;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #334155;
            --shopify-green: #96bf48;
            --shopify-dark: #5c8e24;
            --purple: #8b5cf6;
            --cyan: #06b6d4;
            --orange: #f97316;
            --pink: #ec4899;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* ============ HEADER ============ */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            padding: 10px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-decoration: none;
        }

        .back-btn:hover {
            background: linear-gradient(135deg, var(--shopify-green), var(--shopify-dark));
            color: #000;
            border-color: var(--shopify-green);
        }

        .header-title {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title .icon {
            font-size: 28px;
        }

        .module-badge {
            font-size: 11px;
            padding: 4px 12px;
            background: linear-gradient(135deg, var(--shopify-green), var(--shopify-dark));
            color: #000;
            border-radius: 20px;
            font-weight: 700;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border-radius: 20px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .sync-dot.warning { background: var(--warning); }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--shopify-green), var(--shopify-dark));
            color: #000;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        .btn-success {
            background: var(--success);
            color: #fff;
        }

        /* ============ MAIN CONTAINER ============ */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* ============ TABS ============ */
        .tabs-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: var(--radius);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            color: var(--text-muted);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--shopify-green), var(--shopify-dark));
            color: #000;
        }

        .tab-btn .badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ============ STATS GRID ============ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .stat-card.green::before { background: linear-gradient(90deg, var(--shopify-green), var(--shopify-dark)); }
        .stat-card.blue::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .stat-card.purple::before { background: linear-gradient(90deg, var(--purple), #a78bfa); }
        .stat-card.orange::before { background: linear-gradient(90deg, var(--orange), #fb923c); }
        .stat-card.cyan::before { background: linear-gradient(90deg, var(--cyan), #22d3ee); }
        .stat-card.pink::before { background: linear-gradient(90deg, var(--pink), #f472b6); }
        .stat-card.danger::before { background: linear-gradient(90deg, var(--danger), #f87171); }
        .stat-card.success::before { background: linear-gradient(90deg, var(--success), #34d399); }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stat-card.green .stat-value { color: var(--shopify-green); }
        .stat-card.blue .stat-value { color: #3b82f6; }
        .stat-card.purple .stat-value { color: var(--purple); }
        .stat-card.orange .stat-value { color: var(--orange); }
        .stat-card.cyan .stat-value { color: var(--cyan); }
        .stat-card.pink .stat-value { color: var(--pink); }
        .stat-card.danger .stat-value { color: var(--danger); }
        .stat-card.success .stat-value { color: var(--success); }

        .stat-label {
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
        }

        /* ============ CARDS ============ */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .card-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--shopify-green), var(--shopify-dark));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            color: #000;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-body {
            padding: 20px;
        }

        /* ============ IMPORT ZONE ============ */
        .import-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: var(--bg-tertiary);
        }

        .import-zone:hover,
        .import-zone.dragover {
            border-color: var(--shopify-green);
            background: rgba(150, 191, 72, 0.1);
        }

        .import-zone .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .import-zone h4 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .import-zone p {
            color: var(--text-muted);
            font-size: 14px;
        }

        #csvFileInput {
            display: none;
        }

        .file-info {
            display: none;
            margin-top: 16px;
            padding: 12px 20px;
            background: rgba(150, 191, 72, 0.1);
            border-radius: 8px;
            color: var(--shopify-green);
            font-weight: 600;
        }

        .file-info.visible {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* ============ SEARCH & FILTERS ============ */
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--shopify-green);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .filter-select {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            min-width: 160px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--shopify-green);
        }

        /* ============ ORDERS TABLE ============ */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
        }

        .orders-table th,
        .orders-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .orders-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .orders-table tbody tr {
            transition: background 0.2s;
            cursor: pointer;
        }

        .orders-table tbody tr:hover {
            background: var(--bg-hover);
        }

        .orders-table tbody tr.processed {
            opacity: 0.6;
            background: rgba(16, 185, 129, 0.05);
        }

        .order-number {
            font-weight: 700;
            color: var(--shopify-green);
        }

        .order-customer {
            font-weight: 600;
        }

        .order-customer small {
            display: block;
            color: var(--text-muted);
            font-weight: 400;
            font-size: 12px;
        }

        .order-location {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .location-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .location-badge.nyon {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .location-badge.coinsins {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .location-badge.shipping {
            background: rgba(249, 115, 22, 0.2);
            color: #fb923c;
        }

        .order-date {
            font-size: 13px;
        }

        .order-date .time {
            color: var(--text-muted);
            font-size: 12px;
        }

        .order-total {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--shopify-green);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: rgba(249, 115, 22, 0.2);
            color: var(--orange);
        }

        .status-badge.processed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .btn-action {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* ============ DATE SECTIONS ============ */
        .date-section {
            margin-bottom: 24px;
        }

        .date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(90deg, rgba(150, 191, 72, 0.1), transparent);
            border-left: 4px solid var(--shopify-green);
            border-radius: 0 8px 8px 0;
            margin-bottom: 12px;
        }

        .date-header h4 {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-header .count {
            background: var(--shopify-green);
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
        }

        /* ============ MODAL ============ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--shopify-green), var(--shopify-dark));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            color: #000;
            font-size: 18px;
            font-weight: 700;
        }

        .modal-close {
            background: rgba(0,0,0,0.2);
            border: none;
            color: #000;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(0,0,0,0.3);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Order Details */
        .order-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .order-detail-row:last-child {
            border-bottom: none;
        }

        .order-detail-label {
            color: var(--text-muted);
            font-size: 13px;
        }

        .order-detail-value {
            font-weight: 600;
            text-align: right;
        }

        .order-items-list {
            margin-top: 16px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .order-item-name {
            font-weight: 500;
        }

        .order-item-qty {
            color: var(--text-muted);
            font-size: 13px;
        }

        .order-item-price {
            font-weight: 700;
            color: var(--shopify-green);
        }

        /* ============ EMPTY STATE ============ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h4 {
            font-size: 20px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* ============ TOAST ============ */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
        }

        .toast.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }

        /* ============ RESPONSIVE ============ */
        @media (max-width: 768px) {
            .header {
                flex-wrap: wrap;
                gap: 12px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .search-bar {
                flex-direction: column;
            }

            .search-input,
            .filter-select {
                width: 100%;
            }

            .orders-table {
                font-size: 13px;
            }

            .orders-table th,
            .orders-table td {
                padding: 10px 8px;
            }

            .btn {
                padding: 8px 14px;
                font-size: 13px;
            }
        }

        /* ============ HU√éTRES SECTION ============ */
        .huitres-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .huitre-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
        }

        .huitre-card h4 {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .huitre-card .total {
            font-size: 36px;
            font-weight: 800;
            color: var(--shopify-green);
            margin-bottom: 12px;
        }

        .bourriches-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .bourriche-badge {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 13px;
        }

        .bourriche-badge span {
            color: var(--shopify-green);
            font-weight: 700;
        }

        /* ============ ANIMATIONS ============ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-left">
            <a href="index.html" class="back-btn">
                <span>‚Üê</span> Dashboard
            </a>
            <div class="header-title">
                <span class="icon">üõçÔ∏è</span>
                TRAKIO Shopify
                <span class="module-badge">v5.0.4</span>
            </div>
        </div>
        <div class="header-right">
            <div class="sync-status">
                <span class="sync-dot" id="syncDot"></span>
                <span id="syncText">Pr√™t</span>
            </div>
            <button class="btn btn-secondary" onclick="exportOrders()">
                üì• Export CSV
            </button>
            <button class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">
                üì§ Importer CSV
            </button>
            <input type="file" id="csvFileInput" accept=".csv" onchange="handleFileSelect(event)">
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <div class="main-container">
        <!-- TABS -->
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('dashboard')" id="tab-dashboard">
                üìä Dashboard <span class="badge" id="badge-total">0</span>
            </button>
            <button class="tab-btn" onclick="switchTab('orders')" id="tab-orders">
                üì¶ Commandes <span class="badge" id="badge-pending">0</span>
            </button>
            <button class="tab-btn" onclick="switchTab('huitres')" id="tab-huitres">
                ü¶™ Hu√Ætres <span class="badge" id="badge-huitres">0</span>
            </button>
            <button class="tab-btn" onclick="switchTab('import')" id="tab-import">
                üì§ Import
            </button>
        </div>

        <!-- TAB: DASHBOARD -->
        <div class="tab-content active" id="content-dashboard">
            <div class="stats-grid">
                <div class="stat-card green">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Total Commandes</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-value" id="stat-pending">0</div>
                    <div class="stat-label">√Ä traiter</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="stat-processed">0</div>
                    <div class="stat-label">Trait√©es</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-icon">üè™</div>
                    <div class="stat-value" id="stat-nyon">0</div>
                    <div class="stat-label">Magasin Nyon</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-icon">üî¨</div>
                    <div class="stat-value" id="stat-coinsins">0</div>
                    <div class="stat-label">Laboratoire</div>
                </div>
                <div class="stat-card cyan">
                    <div class="stat-icon">üöö</div>
                    <div class="stat-value" id="stat-shipping">0</div>
                    <div class="stat-label">Exp√©ditions</div>
                </div>
                <div class="stat-card pink">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value" id="stat-ca">0</div>
                    <div class="stat-label">CA Total (CHF)</div>
                </div>
            </div>

            <!-- Prochaines dates -->
            <div class="card">
                <div class="card-header">
                    <h3>üìÖ Prochaines Dates de Retrait</h3>
                    <button class="btn btn-secondary btn-action" onclick="printDashboard()">üñ®Ô∏è Imprimer</button>
                </div>
                <div class="card-body" id="upcoming-dates">
                    <div class="empty-state">
                        <div class="icon">üì¶</div>
                        <h4>Aucune commande</h4>
                        <p>Importez un fichier CSV pour commencer</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: ORDERS -->
        <div class="tab-content" id="content-orders">
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Rechercher par nom, n¬∞ commande, email..." oninput="filterOrders()">
                <select class="filter-select" id="filterLocation" onchange="filterOrders()">
                    <option value="">Tous les lieux</option>
                    <option value="nyon">Magasin de Nyon</option>
                    <option value="coinsins">Laboratoire de Coinsins</option>
                    <option value="shipping">Exp√©dition</option>
                </select>
                <select class="filter-select" id="filterStatus" onchange="filterOrders()">
                    <option value="">Tous les statuts</option>
                    <option value="pending">√Ä traiter</option>
                    <option value="processed">Trait√©es</option>
                </select>
                <select class="filter-select" id="filterDate" onchange="filterOrders()">
                    <option value="">Toutes les dates</option>
                </select>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>üì¶ Liste des Commandes <span id="orders-count">(0)</span></h3>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-success btn-action" onclick="markSelectedProcessed()">‚úÖ Marquer s√©lection trait√©e</button>
                        <button class="btn btn-danger btn-action" onclick="resetProcessed()">üîÑ Reset</button>
                    </div>
                </div>
                <div class="card-body" style="padding:0; overflow-x:auto;">
                    <table class="orders-table" id="ordersTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th>N¬∞ Commande</th>
                                <th>Client</th>
                                <th>Date Retrait</th>
                                <th>Lieu</th>
                                <th>Total</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: HUITRES -->
        <div class="tab-content" id="content-huitres">
            <div class="card">
                <div class="card-header">
                    <h3>ü¶™ R√©capitulatif Hu√Ætres par Date</h3>
                </div>
                <div class="card-body" id="huitres-recap">
                    <div class="empty-state">
                        <div class="icon">ü¶™</div>
                        <h4>Aucune donn√©e</h4>
                        <p>Les hu√Ætres seront calcul√©es apr√®s import</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: IMPORT -->
        <div class="tab-content" id="content-import">
            <div class="card">
                <div class="card-header">
                    <h3>üì§ Importer des Commandes CSV</h3>
                </div>
                <div class="card-body">
                    <div class="import-zone" onclick="document.getElementById('csvFileInput').click()" id="dropZone">
                        <div class="icon">üìÅ</div>
                        <h4>Glissez votre fichier CSV ici</h4>
                        <p>ou cliquez pour s√©lectionner un fichier</p>
                        <p style="margin-top:12px; font-size:12px; color:var(--text-muted);">Format: all-open-orders.csv de Shopify</p>
                    </div>
                    <div class="file-info" id="fileInfo">
                        <span id="fileName"></span>
                        <button class="btn btn-secondary btn-action" onclick="resetImport()">‚úï Supprimer</button>
                    </div>

                    <div style="margin-top:24px; padding:16px; background:var(--bg-tertiary); border-radius:8px;">
                        <h4 style="margin-bottom:12px;">üí° Comment √ßa marche ?</h4>
                        <ul style="color:var(--text-muted); font-size:14px; line-height:1.8; padding-left:20px;">
                            <li>Exportez vos commandes ouvertes depuis Shopify</li>
                            <li>L'import <strong>met √† jour</strong> les commandes existantes</li>
                            <li>Les commandes marqu√©es "trait√©es" restent trait√©es</li>
                            <li>Les nouvelles commandes sont ajout√©es automatiquement</li>
                            <li>Les commandes absentes du CSV sont <strong>supprim√©es</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ORDER DETAIL MODAL -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalOrderNumber">Commande #</h3>
                <button class="modal-close" onclick="closeOrderModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="printOrder()">üñ®Ô∏è Imprimer</button>
                <button class="btn btn-success" onclick="toggleProcessed()" id="modalProcessBtn">‚úÖ Marquer trait√©e</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast">
        <span id="toastIcon">‚úÖ</span>
        <span id="toastMessage">Message</span>
    </div>

    <script>
        // =============================================
        // DATA STORE
        // =============================================
        const ShopifyData = {
            orders: [],
            processedOrders: [],
            filteredOrders: [],
            currentOrder: null
        };

        const Config = {
            bourriches: [12, 24, 48, 96],
            huitreKeywords: ['hu√Ætre', 'huitre', 'oyster', 'fines', 'sp√©ciales', 'gillardeau']
        };

        // =============================================
        // INITIALIZATION
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            setupDragDrop();
            updateUI();
        });

        function loadFromStorage() {
            try {
                const stored = localStorage.getItem('shopify_orders_v5');
                if (stored) {
                    ShopifyData.orders = JSON.parse(stored);
                }
                const processed = localStorage.getItem('shopify_processed_v5');
                if (processed) {
                    ShopifyData.processedOrders = JSON.parse(processed);
                    // Appliquer le statut trait√© aux commandes
                    ShopifyData.orders.forEach(order => {
                        order.processed = ShopifyData.processedOrders.includes(order.orderNumber);
                    });
                }
            } catch(e) {
                console.error('Erreur chargement:', e);
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem('shopify_orders_v5', JSON.stringify(ShopifyData.orders));
                localStorage.setItem('shopify_processed_v5', JSON.stringify(ShopifyData.processedOrders));
            } catch(e) {
                console.error('Erreur sauvegarde:', e);
            }
        }

        // =============================================
        // DRAG & DROP
        // =============================================
        function setupDragDrop() {
            const dropZone = document.getElementById('dropZone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
                dropZone.addEventListener(event, e => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(event => {
                dropZone.addEventListener(event, () => dropZone.classList.add('dragover'));
            });

            ['dragleave', 'drop'].forEach(event => {
                dropZone.addEventListener(event, () => dropZone.classList.remove('dragover'));
            });

            dropZone.addEventListener('drop', e => {
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.csv')) {
                    processFile(files[0]);
                }
            });
        }

        // =============================================
        // FILE HANDLING
        // =============================================
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            document.getElementById('fileName').textContent = `üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            document.getElementById('fileInfo').classList.add('visible');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(csvText) {
            showToast('‚è≥ Import en cours...', 'warning');
            
            // Parser le CSV en g√©rant les champs multilignes
            const lines = [];
            let currentLine = '';
            let inQuotes = false;
            
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                    currentLine += char;
                } else if (char === '\n' && !inQuotes) {
                    if (currentLine.trim()) {
                        lines.push(currentLine);
                    }
                    currentLine = '';
                } else if (char === '\r') {
                    // Ignorer les retours chariot
                } else {
                    currentLine += char;
                }
            }
            if (currentLine.trim()) {
                lines.push(currentLine);
            }

            if (lines.length < 2) {
                showToast('‚ùå Fichier CSV invalide', 'error');
                return;
            }

            // Parser les headers
            const headers = parseCSVLine(lines[0]);
            console.log('Headers:', headers);

            // Mapper les colonnes
            const colMap = {};
            headers.forEach((h, i) => {
                const lower = h.toLowerCase().trim();
                if (lower === 'order') colMap.order = i;
                if (lower === 'customer') colMap.customer = i;
                if (lower === 'customer name') colMap.customerName = i;
                if (lower === 'created at') colMap.createdAt = i;
                if (lower === 'notes') colMap.notes = i;
                if (lower === 'total') colMap.total = i;
                if (lower === 'payment') colMap.payment = i;
                if (lower === 'fulfillment') colMap.fulfillment = i;
                if (lower === 'ship to') colMap.shipTo = i;
                if (lower === 'phone no') colMap.phone = i;
                if (lower === 'zipcode') colMap.zipcode = i;
                if (lower === 'note attributes') colMap.noteAttributes = i;
                if (lower === 'order location') colMap.orderLocation = i;
                if (lower === 'due date') colMap.dueDate = i;
                if (lower === 'fulfillment type') colMap.fulfillmentType = i;
            });

            // Parser les commandes
            const newOrders = [];
            const newOrderNumbers = [];

            for (let i = 1; i < lines.length; i++) {
                const row = parseCSVLine(lines[i]);
                if (row.length < 3) continue;

                try {
                    const orderNumber = (row[colMap.order] || '').trim();
                    if (!orderNumber) continue;

                    newOrderNumbers.push(orderNumber);

                    // V√©rifier si d√©j√† trait√©
                    const wasProcessed = ShopifyData.processedOrders.includes(orderNumber);

                    // Parser les infos client
                    const customerField = row[colMap.customer] || '';
                    const customerName = row[colMap.customerName] || '';
                    
                    // Extraire email du champ customer
                    const emailMatch = customerField.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z]+)/);
                    const email = emailMatch ? emailMatch[1] : '';

                    // Parser le montant
                    const totalStr = row[colMap.total] || '0';
                    const total = parseFloat(totalStr.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;

                    // Parser la date de retrait
                    const dueDateRaw = row[colMap.dueDate] || '';
                    const dueDate = parseDueDate(dueDateRaw);

                    // D√©terminer le lieu
                    const location = row[colMap.orderLocation] || '';
                    const fulfillmentType = row[colMap.fulfillmentType] || '';
                    const locationType = determineLocationType(location, fulfillmentType);

                    // Parser l'adresse
                    const shipTo = row[colMap.shipTo] || '';
                    const phone = row[colMap.phone] || '';

                    const order = {
                        orderNumber: orderNumber,
                        customerName: customerName,
                        email: email,
                        phone: phone,
                        total: total,
                        currency: 'CHF',
                        createdAt: row[colMap.createdAt] || '',
                        dueDate: dueDate.date,
                        dueTime: dueDate.time,
                        dueDateRaw: dueDateRaw,
                        location: location,
                        locationType: locationType,
                        fulfillmentType: fulfillmentType,
                        shipTo: shipTo,
                        zipcode: row[colMap.zipcode] || '',
                        payment: row[colMap.payment] || '',
                        fulfillment: row[colMap.fulfillment] || '',
                        notes: row[colMap.notes] || '',
                        noteAttributes: row[colMap.noteAttributes] || '',
                        processed: wasProcessed,
                        items: [] // √Ä parser si besoin
                    };

                    newOrders.push(order);
                } catch(e) {
                    console.error('Erreur parsing ligne ' + i, e);
                }
            }

            // Mettre √† jour les donn√©es
            // Supprimer les commandes qui ne sont plus dans le CSV (sauf si trait√©es?)
            // Pour l'instant: remplacer toutes les commandes
            ShopifyData.orders = newOrders;
            
            // Nettoyer les commandes trait√©es qui ne sont plus dans le CSV
            ShopifyData.processedOrders = ShopifyData.processedOrders.filter(
                num => newOrderNumbers.includes(num)
            );

            saveToStorage();
            updateUI();
            switchTab('dashboard');

            const pendingCount = newOrders.filter(o => !o.processed).length;
            showToast(`‚úÖ ${newOrders.length} commandes import√©es (${pendingCount} √† traiter)`, 'success');
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseDueDate(rawDate) {
            // Format: "Thu, 18 Dec 2025 11:00 AM - 12:00 PM" ou "Thu, 18 Dec 2025"
            const result = { date: '', time: '' };
            
            if (!rawDate) return result;

            // Nettoyer
            let clean = rawDate.trim().replace(/\s+/g, ' ');

            // Extraire date
            const dateMatch = clean.match(/(\w+),?\s+(\d+)\s+(\w+)\s+(\d{4})/);
            if (dateMatch) {
                const months = {
                    'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04', 
                    'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
                    'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                };
                const day = dateMatch[2].padStart(2, '0');
                const month = months[dateMatch[3]] || '01';
                const year = dateMatch[4];
                result.date = `${year}-${month}-${day}`;
            }

            // Extraire heure
            const timeMatch = clean.match(/(\d{1,2}:\d{2}\s*(?:AM|PM))/i);
            if (timeMatch) {
                result.time = timeMatch[1];
            }

            return result;
        }

        function determineLocationType(location, fulfillmentType) {
            const loc = (location + ' ' + fulfillmentType).toLowerCase();
            
            if (loc.includes('nyon')) return 'nyon';
            if (loc.includes('coinsins') || loc.includes('laboratoire')) return 'coinsins';
            if (loc.includes('shipping') || loc.includes('express') || loc.includes('post')) return 'shipping';
            
            return 'other';
        }

        function resetImport() {
            document.getElementById('csvFileInput').value = '';
            document.getElementById('fileInfo').classList.remove('visible');
        }

        // =============================================
        // UI UPDATE
        // =============================================
        function updateUI() {
            updateStats();
            updateDateFilter();
            filterOrders();
            renderUpcomingDates();
            renderHuitres();
        }

        function updateStats() {
            const orders = ShopifyData.orders;
            const pending = orders.filter(o => !o.processed);
            const processed = orders.filter(o => o.processed);
            const nyon = orders.filter(o => o.locationType === 'nyon' && !o.processed);
            const coinsins = orders.filter(o => o.locationType === 'coinsins' && !o.processed);
            const shipping = orders.filter(o => o.locationType === 'shipping' && !o.processed);
            const totalCA = orders.reduce((sum, o) => sum + o.total, 0);

            document.getElementById('stat-total').textContent = orders.length;
            document.getElementById('stat-pending').textContent = pending.length;
            document.getElementById('stat-processed').textContent = processed.length;
            document.getElementById('stat-nyon').textContent = nyon.length;
            document.getElementById('stat-coinsins').textContent = coinsins.length;
            document.getElementById('stat-shipping').textContent = shipping.length;
            document.getElementById('stat-ca').textContent = formatNumber(totalCA);

            // Badges
            document.getElementById('badge-total').textContent = orders.length;
            document.getElementById('badge-pending').textContent = pending.length;

            // Sync status
            if (orders.length > 0) {
                document.getElementById('syncDot').classList.remove('warning');
                document.getElementById('syncText').textContent = `${orders.length} commandes`;
            } else {
                document.getElementById('syncDot').classList.add('warning');
                document.getElementById('syncText').textContent = 'Aucune donn√©e';
            }
        }

        function updateDateFilter() {
            const dates = [...new Set(ShopifyData.orders.map(o => o.dueDate).filter(d => d))].sort();
            const select = document.getElementById('filterDate');
            
            // Garder la s√©lection actuelle
            const current = select.value;
            
            select.innerHTML = '<option value="">Toutes les dates</option>';
            dates.forEach(date => {
                const formatted = formatDateShort(date);
                select.innerHTML += `<option value="${date}">${formatted}</option>`;
            });
            
            select.value = current;
        }

        function filterOrders() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const locationFilter = document.getElementById('filterLocation').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const dateFilter = document.getElementById('filterDate').value;

            ShopifyData.filteredOrders = ShopifyData.orders.filter(order => {
                // Search
                if (search) {
                    const searchStr = `${order.orderNumber} ${order.customerName} ${order.email} ${order.phone}`.toLowerCase();
                    if (!searchStr.includes(search)) return false;
                }

                // Location
                if (locationFilter && order.locationType !== locationFilter) return false;

                // Status
                if (statusFilter === 'pending' && order.processed) return false;
                if (statusFilter === 'processed' && !order.processed) return false;

                // Date
                if (dateFilter && order.dueDate !== dateFilter) return false;

                return true;
            });

            // Trier par date puis par heure
            ShopifyData.filteredOrders.sort((a, b) => {
                if (a.dueDate !== b.dueDate) return a.dueDate.localeCompare(b.dueDate);
                return (a.dueTime || '').localeCompare(b.dueTime || '');
            });

            renderOrdersTable();
        }

        function renderOrdersTable() {
            const tbody = document.getElementById('ordersBody');
            const orders = ShopifyData.filteredOrders;

            document.getElementById('orders-count').textContent = `(${orders.length})`;

            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">
                            Aucune commande trouv√©e
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr class="${order.processed ? 'processed' : ''}" onclick="openOrderModal('${order.orderNumber}')">
                    <td onclick="event.stopPropagation()">
                        <input type="checkbox" class="order-check" value="${order.orderNumber}">
                    </td>
                    <td>
                        <span class="order-number">${order.orderNumber}</span>
                    </td>
                    <td>
                        <div class="order-customer">
                            ${order.customerName}
                            <small>${order.email || order.phone || ''}</small>
                        </div>
                    </td>
                    <td>
                        <div class="order-date">
                            ${formatDateShort(order.dueDate)}
                            ${order.dueTime ? `<div class="time">${order.dueTime}</div>` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="order-location">
                            <span class="location-badge ${order.locationType}">
                                ${getLocationIcon(order.locationType)} ${getLocationName(order.locationType)}
                            </span>
                        </div>
                    </td>
                    <td>
                        <span class="order-total">${order.total.toFixed(2)} CHF</span>
                    </td>
                    <td>
                        <span class="status-badge ${order.processed ? 'processed' : 'pending'}">
                            ${order.processed ? '‚úÖ Trait√©e' : '‚è≥ √Ä traiter'}
                        </span>
                    </td>
                    <td onclick="event.stopPropagation()">
                        <button class="btn ${order.processed ? 'btn-secondary' : 'btn-success'} btn-action" 
                                onclick="toggleOrderProcessed('${order.orderNumber}')">
                            ${order.processed ? '‚Ü©Ô∏è' : '‚úÖ'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderUpcomingDates() {
            const container = document.getElementById('upcoming-dates');
            const orders = ShopifyData.orders.filter(o => !o.processed);

            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üì¶</div>
                        <h4>Aucune commande √† traiter</h4>
                        <p>Toutes les commandes ont √©t√© trait√©es !</p>
                    </div>
                `;
                return;
            }

            // Grouper par date
            const byDate = {};
            orders.forEach(order => {
                const date = order.dueDate || 'Non d√©finie';
                if (!byDate[date]) byDate[date] = [];
                byDate[date].push(order);
            });

            // Trier les dates
            const sortedDates = Object.keys(byDate).sort();

            container.innerHTML = sortedDates.map(date => {
                const dateOrders = byDate[date];
                const totalAmount = dateOrders.reduce((sum, o) => sum + o.total, 0);
                
                // Grouper par lieu
                const byLocation = {};
                dateOrders.forEach(o => {
                    const loc = o.locationType || 'other';
                    if (!byLocation[loc]) byLocation[loc] = [];
                    byLocation[loc].push(o);
                });

                return `
                    <div class="date-section fade-in">
                        <div class="date-header">
                            <h4>
                                üìÖ ${formatDateLong(date)}
                            </h4>
                            <div style="display:flex; gap:12px; align-items:center;">
                                <span style="color:var(--text-muted);">
                                    üí∞ ${formatNumber(totalAmount)} CHF
                                </span>
                                <span class="count">${dateOrders.length} cmd</span>
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                            ${Object.entries(byLocation).map(([loc, locOrders]) => `
                                <div style="background:var(--bg-tertiary); padding:16px; border-radius:10px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                        <span class="location-badge ${loc}">
                                            ${getLocationIcon(loc)} ${getLocationName(loc)}
                                        </span>
                                        <strong style="color:var(--shopify-green);">${locOrders.length}</strong>
                                    </div>
                                    <div style="font-size:12px; color:var(--text-muted);">
                                        ${locOrders.slice(0, 3).map(o => o.customerName).join(', ')}
                                        ${locOrders.length > 3 ? `... +${locOrders.length - 3}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderHuitres() {
            const container = document.getElementById('huitres-recap');
            const orders = ShopifyData.orders.filter(o => !o.processed);

            // Pour l'instant, afficher un message si pas d'items d√©taill√©s
            // TODO: Parser les items des commandes pour calculer les hu√Ætres
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ü¶™</div>
                        <h4>Aucune commande</h4>
                        <p>Importez des commandes pour voir le r√©capitulatif hu√Ætres</p>
                    </div>
                `;
                return;
            }

            // Grouper par date
            const byDate = {};
            orders.forEach(order => {
                const date = order.dueDate || 'Non d√©finie';
                if (!byDate[date]) byDate[date] = { count: 0, total: 0 };
                byDate[date].count++;
                byDate[date].total += order.total;
            });

            const sortedDates = Object.keys(byDate).sort();

            container.innerHTML = `
                <div style="color:var(--text-muted); margin-bottom:16px; font-size:14px;">
                    ‚ö†Ô∏è Le calcul d√©taill√© des hu√Ætres n√©cessite les items des commandes. 
                    Actuellement, seul le r√©capitulatif par date est disponible.
                </div>
                <div class="huitres-grid">
                    ${sortedDates.map(date => `
                        <div class="huitre-card">
                            <h4>${formatDateShort(date)}</h4>
                            <div class="total">${byDate[date].count}</div>
                            <div style="color:var(--text-muted); font-size:13px;">commandes</div>
                            <div style="margin-top:8px; color:var(--shopify-green); font-weight:700;">
                                ${formatNumber(byDate[date].total)} CHF
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('badge-huitres').textContent = orders.length;
        }

        // =============================================
        // ORDER ACTIONS
        // =============================================
        function openOrderModal(orderNumber) {
            const order = ShopifyData.orders.find(o => o.orderNumber === orderNumber);
            if (!order) return;

            ShopifyData.currentOrder = order;

            document.getElementById('modalOrderNumber').textContent = `Commande ${order.orderNumber}`;
            document.getElementById('modalProcessBtn').textContent = order.processed ? '‚Ü©Ô∏è Marquer non trait√©e' : '‚úÖ Marquer trait√©e';
            document.getElementById('modalProcessBtn').className = order.processed ? 'btn btn-secondary' : 'btn btn-success';

            document.getElementById('modalBody').innerHTML = `
                <div class="order-detail-row">
                    <span class="order-detail-label">Client</span>
                    <span class="order-detail-value">${order.customerName}</span>
                </div>
                <div class="order-detail-row">
                    <span class="order-detail-label">Email</span>
                    <span class="order-detail-value">${order.email || '-'}</span>
                </div>
                <div class="order-detail-row">
                    <span class="order-detail-label">T√©l√©phone</span>
                    <span class="order-detail-value">${order.phone || '-'}</span>
                </div>
                <div class="order-detail-row">
                    <span class="order-detail-label">Date de retrait</span>
                    <span class="order-detail-value">${formatDateLong(order.dueDate)} ${order.dueTime || ''}</span>
                </div>
                <div class="order-detail-row">
                    <span class="order-detail-label">Lieu</span>
                    <span class="order-detail-value">
                        <span class="location-badge ${order.locationType}">
                            ${getLocationIcon(order.locationType)} ${order.location || getLocationName(order.locationType)}
                        </span>
                    </span>
                </div>
                <div class="order-detail-row">
                    <span class="order-detail-label">Type</span>
                    <span class="order-detail-value">${order.fulfillmentType || '-'}</span>
                </div>
                ${order.shipTo ? `
                    <div class="order-detail-row">
                        <span class="order-detail-label">Adresse</span>
                        <span class="order-detail-value" style="white-space:pre-line; text-align:right;">${order.shipTo}</span>
                    </div>
                ` : ''}
                <div class="order-detail-row">
                    <span class="order-detail-label">Paiement</span>
                    <span class="order-detail-value">${order.payment || '-'}</span>
                </div>
                <div class="order-detail-row" style="border-bottom:none;">
                    <span class="order-detail-label" style="font-size:16px; font-weight:700;">Total</span>
                    <span class="order-detail-value" style="font-size:24px; color:var(--shopify-green); font-weight:800;">
                        ${order.total.toFixed(2)} ${order.currency}
                    </span>
                </div>
                ${order.notes && order.notes !== 'N/A' ? `
                    <div style="margin-top:16px; padding:12px; background:var(--bg-tertiary); border-radius:8px;">
                        <div style="font-size:12px; color:var(--text-muted); margin-bottom:6px;">üìù Notes</div>
                        <div>${order.notes}</div>
                    </div>
                ` : ''}
            `;

            document.getElementById('orderModal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
            ShopifyData.currentOrder = null;
        }

        function toggleProcessed() {
            if (ShopifyData.currentOrder) {
                toggleOrderProcessed(ShopifyData.currentOrder.orderNumber);
                closeOrderModal();
            }
        }

        function toggleOrderProcessed(orderNumber) {
            const order = ShopifyData.orders.find(o => o.orderNumber === orderNumber);
            if (!order) return;

            order.processed = !order.processed;

            if (order.processed) {
                if (!ShopifyData.processedOrders.includes(orderNumber)) {
                    ShopifyData.processedOrders.push(orderNumber);
                }
                showToast(`‚úÖ Commande ${orderNumber} trait√©e`, 'success');
            } else {
                ShopifyData.processedOrders = ShopifyData.processedOrders.filter(n => n !== orderNumber);
                showToast(`‚Ü©Ô∏è Commande ${orderNumber} remise en attente`, 'warning');
            }

            saveToStorage();
            updateUI();
        }

        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.order-check').forEach(cb => cb.checked = checked);
        }

        function markSelectedProcessed() {
            const selected = Array.from(document.querySelectorAll('.order-check:checked')).map(cb => cb.value);
            
            if (selected.length === 0) {
                showToast('‚ö†Ô∏è S√©lectionnez des commandes', 'warning');
                return;
            }

            selected.forEach(orderNumber => {
                const order = ShopifyData.orders.find(o => o.orderNumber === orderNumber);
                if (order && !order.processed) {
                    order.processed = true;
                    if (!ShopifyData.processedOrders.includes(orderNumber)) {
                        ShopifyData.processedOrders.push(orderNumber);
                    }
                }
            });

            saveToStorage();
            updateUI();
            document.getElementById('selectAll').checked = false;
            showToast(`‚úÖ ${selected.length} commandes trait√©es`, 'success');
        }

        function resetProcessed() {
            if (!confirm('Remettre toutes les commandes en "√Ä traiter" ?')) return;

            ShopifyData.orders.forEach(order => order.processed = false);
            ShopifyData.processedOrders = [];
            
            saveToStorage();
            updateUI();
            showToast('üîÑ Toutes les commandes remises en attente', 'warning');
        }

        // =============================================
        // EXPORT & PRINT
        // =============================================
        function exportOrders() {
            const orders = ShopifyData.filteredOrders.length > 0 ? ShopifyData.filteredOrders : ShopifyData.orders;
            
            if (orders.length === 0) {
                showToast('‚ö†Ô∏è Aucune commande √† exporter', 'warning');
                return;
            }

            let csv = 'N¬∞ Commande,Client,Email,T√©l√©phone,Date Retrait,Heure,Lieu,Total,Statut\n';
            orders.forEach(o => {
                const status = o.processed ? 'Trait√©e' : '√Ä traiter';
                csv += `"${o.orderNumber}","${o.customerName}","${o.email}","${o.phone}","${o.dueDate}","${o.dueTime}","${o.location}","${o.total}","${status}"\n`;
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `shopify_export_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();

            showToast(`üì• ${orders.length} commandes export√©es`, 'success');
        }

        function printDashboard() {
            window.print();
        }

        function printOrder() {
            const order = ShopifyData.currentOrder;
            if (!order) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Commande ${order.orderNumber}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
                        h1 { color: #96bf48; border-bottom: 2px solid #96bf48; padding-bottom: 10px; }
                        .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
                        .label { color: #666; }
                        .value { font-weight: bold; text-align: right; }
                        .total { font-size: 24px; color: #96bf48; margin-top: 20px; text-align: right; }
                        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; }
                        .nyon { background: #e0f2fe; color: #0284c7; }
                        .coinsins { background: #ede9fe; color: #7c3aed; }
                        .shipping { background: #ffedd5; color: #ea580c; }
                    </style>
                </head>
                <body>
                    <h1>üõçÔ∏è Commande ${order.orderNumber}</h1>
                    <div class="row"><span class="label">Client</span><span class="value">${order.customerName}</span></div>
                    <div class="row"><span class="label">Email</span><span class="value">${order.email || '-'}</span></div>
                    <div class="row"><span class="label">T√©l√©phone</span><span class="value">${order.phone || '-'}</span></div>
                    <div class="row"><span class="label">Date de retrait</span><span class="value">${formatDateLong(order.dueDate)} ${order.dueTime || ''}</span></div>
                    <div class="row"><span class="label">Lieu</span><span class="value"><span class="badge ${order.locationType}">${order.location || getLocationName(order.locationType)}</span></span></div>
                    ${order.shipTo ? `<div class="row"><span class="label">Adresse</span><span class="value" style="white-space:pre-line;">${order.shipTo}</span></div>` : ''}
                    <div class="total">TOTAL: ${order.total.toFixed(2)} ${order.currency}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // =============================================
        // TABS
        // =============================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('content-' + tabName).classList.add('active');
        }

        // =============================================
        // UTILITIES
        // =============================================
        function formatNumber(num) {
            return new Intl.NumberFormat('fr-CH', { maximumFractionDigits: 0 }).format(num);
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fr-CH', { weekday: 'short', day: 'numeric', month: 'short' });
            } catch {
                return dateStr;
            }
        }

        function formatDateLong(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fr-CH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            } catch {
                return dateStr;
            }
        }

        function getLocationIcon(type) {
            switch(type) {
                case 'nyon': return 'üè™';
                case 'coinsins': return 'üî¨';
                case 'shipping': return 'üöö';
                default: return 'üìç';
            }
        }

        function getLocationName(type) {
            switch(type) {
                case 'nyon': return 'Nyon';
                case 'coinsins': return 'Coinsins';
                case 'shipping': return 'Exp√©dition';
                default: return 'Autre';
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è' };
            
            document.getElementById('toastIcon').textContent = icons[type] || '‚úÖ';
            document.getElementById('toastMessage').textContent = message;
            
            toast.className = 'toast ' + type;
            toast.classList.add('visible');
            
            setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }

        // Close modal on outside click
        document.getElementById('orderModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOrderModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeOrderModal();
            }
        });
    </script>
</body>
</html>

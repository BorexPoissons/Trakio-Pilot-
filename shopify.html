<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO Shopify v5.1.0</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõçÔ∏è</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: #1e293b;
            --bg-hover: #2d3a4f;
            --border: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-cyan: #06b6d4;
            --accent-teal: #14b8a6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --shopify: #95BF47;
            --shopify-dark: #5E8E3E;
            --nyon: #ef4444;
            --nyon-dark: #b91c1c;
            --coinsins: #3b82f6;
            --coinsins-dark: #1d4ed8;
            --shipping: #f97316;
            --shipping-dark: #c2410c;
            --myfish: #8b5cf6;
            --myfish-dark: #7c3aed;
            --gradient-header: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
            --gradient-shopify: linear-gradient(135deg, #95BF47 0%, #5E8E3E 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* HEADER - identique √† index.html */
        .unified-header {
            height: 50px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-left { display: flex; align-items: center; gap: 12px; }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-right: 16px;
            border-right: 1px solid var(--border);
        }

        .logo-icon { font-size: 24px; }
        .logo-text {
            font-weight: 800;
            font-size: 16px;
            background: var(--gradient-header);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-version {
            font-size: 9px;
            background: var(--accent-cyan);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .nav-links { display: flex; align-items: center; gap: 4px; }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-link:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-link.active { background: var(--accent-cyan); color: #000; }
        .nav-link .nav-icon { font-size: 16px; }

        @media (max-width: 1200px) {
            .nav-link span:last-child { display: none; }
            .nav-link { padding: 8px 10px; }
        }

        .header-right { display: flex; align-items: center; gap: 12px; }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 11px;
        }

        .sync-dot { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            background: var(--success);
            animation: pulse 2s infinite;
        }
        .sync-dot.offline { background: var(--error); animation: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-dropdown { position: relative; }

        .user-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .user-btn:hover { border-color: var(--accent-cyan); }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: var(--gradient-header);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            color: #000;
        }

        .user-info { text-align: left; }
        .user-name { font-size: 12px; font-weight: 600; }
        .user-role { font-size: 10px; color: var(--text-muted); }

        .hamburger-btn {
            display: none;
            width: 36px;
            height: 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
                position: fixed;
                top: 50px;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--bg-secondary);
                flex-direction: column;
                padding: 20px;
                gap: 8px;
                z-index: 999;
            }
            .nav-links.mobile-open { display: flex; }
            .nav-link { width: 100%; padding: 14px 16px; }
            .nav-link span:last-child { display: inline; }
            .hamburger-btn { display: flex; }
            .sync-status { display: none; }
        }

        /* MAIN LAYOUT - Split view */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            height: calc(100vh - 50px);
        }

        @media (max-width: 1100px) {
            .main-container { grid-template-columns: 1fr; }
            .detail-panel { display: none; }
            .detail-panel.mobile-active { 
                display: flex; 
                position: fixed; 
                top: 50px; 
                left: 0; 
                right: 0; 
                bottom: 0; 
                z-index: 100; 
            }
        }

        /* LEFT PANEL - Liste des commandes */
        .orders-panel {
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .panel-header {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .panel-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .import-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-shopify {
            background: var(--gradient-shopify);
            color: #000;
        }
        .btn-shopify:hover { box-shadow: 0 4px 15px rgba(149, 191, 71, 0.4); transform: translateY(-1px); }

        .btn-myfish {
            background: linear-gradient(135deg, var(--myfish) 0%, var(--myfish-dark) 100%);
            color: #fff;
        }
        .btn-myfish:hover { box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); transform: translateY(-1px); }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover { background: var(--bg-hover); }

        .btn-danger {
            background: var(--error);
            color: #fff;
        }

        /* Stats */
        .stats-bar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .stat-chip {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .stat-chip.total { background: var(--bg-tertiary); color: var(--text-primary); }
        .stat-chip.nyon { background: rgba(239, 68, 68, 0.2); color: var(--nyon); }
        .stat-chip.coinsins { background: rgba(59, 130, 246, 0.2); color: var(--coinsins); }
        .stat-chip.shipping { background: rgba(249, 115, 22, 0.2); color: var(--shipping); }
        .stat-chip.myfish { background: rgba(139, 92, 246, 0.2); color: var(--myfish); }

        /* Filters */
        .filters-bar {
            padding: 12px 20px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-select, .filter-input {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
        }
        .filter-input { flex: 1; min-width: 150px; }
        .filter-select:focus, .filter-input:focus { outline: none; border-color: var(--accent-cyan); }

        /* Orders List */
        .orders-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .date-group {
            margin-bottom: 16px;
        }

        .date-header {
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .date-badges { display: flex; gap: 6px; }

        .mini-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
        }
        .mini-badge.nyon { background: var(--nyon); }
        .mini-badge.coinsins { background: var(--coinsins); }
        .mini-badge.shipping { background: var(--shipping); }
        .mini-badge.myfish { background: var(--myfish); }

        .order-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        .order-item:hover { background: var(--bg-hover); transform: translateX(4px); }
        .order-item.selected { background: var(--bg-hover); box-shadow: 0 0 0 2px var(--shopify); }
        .order-item.nyon { border-left-color: var(--nyon); }
        .order-item.coinsins { border-left-color: var(--coinsins); }
        .order-item.shipping { border-left-color: var(--shipping); }
        .order-item.myfish { border-left-color: var(--myfish); }
        .order-item.prepared { opacity: 0.5; }
        .order-item.distributed { opacity: 0.3; text-decoration: line-through; }

        .order-number {
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: 700;
            font-family: monospace;
            font-size: 11px;
            color: #fff;
            min-width: 75px;
            text-align: center;
        }
        .order-number.nyon { background: var(--nyon); }
        .order-number.coinsins { background: var(--coinsins); }
        .order-number.shipping { background: var(--shipping); }
        .order-number.myfish { background: var(--myfish); }

        .order-info { flex: 1; min-width: 0; }
        .order-customer { font-weight: 600; font-size: 14px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .order-meta { font-size: 12px; color: var(--text-muted); display: flex; gap: 8px; }

        .order-count {
            background: var(--bg-tertiary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .order-status {
            font-size: 18px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--text-muted);
            text-align: center;
        }
        .empty-state .icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { font-size: 18px; margin-bottom: 8px; color: var(--text-secondary); }

        /* RIGHT PANEL - D√©tails */
        .detail-panel {
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .detail-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            padding: 40px;
            text-align: center;
        }
        .detail-empty .icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        .detail-empty h3 { font-size: 18px; margin-bottom: 8px; color: var(--text-secondary); }

        .detail-content {
            flex: 1;
            overflow-y: auto;
            display: none;
            flex-direction: column;
        }
        .detail-content.active { display: flex; }

        .detail-header {
            padding: 20px;
            color: #fff;
            position: relative;
        }
        .detail-header.nyon { background: linear-gradient(135deg, var(--nyon) 0%, var(--nyon-dark) 100%); }
        .detail-header.coinsins { background: linear-gradient(135deg, var(--coinsins) 0%, var(--coinsins-dark) 100%); }
        .detail-header.shipping { background: linear-gradient(135deg, var(--shipping) 0%, var(--shipping-dark) 100%); }
        .detail-header.myfish { background: linear-gradient(135deg, var(--myfish) 0%, var(--myfish-dark) 100%); }

        .detail-header h2 { font-size: 22px; margin-bottom: 4px; }
        .detail-header .subtitle { opacity: 0.9; font-size: 14px; }

        .close-detail {
            display: none;
            position: absolute;
            top: 16px;
            right: 16px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }
        @media (max-width: 1100px) {
            .close-detail { display: flex; align-items: center; justify-content: center; }
        }

        .detail-body {
            flex: 1;
            overflow-y: auto;
        }

        .detail-section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .client-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
        }
        .client-card h3 { font-size: 18px; margin-bottom: 10px; }
        .client-card .info { 
            font-size: 13px; 
            color: var(--text-secondary); 
            margin-bottom: 6px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }

        .product-list { display: flex; flex-direction: column; gap: 8px; }

        .product-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        .product-qty {
            background: var(--shopify);
            color: #000;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            min-width: 50px;
            text-align: center;
        }

        .product-name { flex: 1; font-size: 14px; }
        .product-price { font-weight: 600; color: var(--shopify); font-size: 14px; }

        .total-bar {
            background: var(--gradient-shopify);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #000;
        }
        .total-bar .label { font-weight: 600; font-size: 16px; }
        .total-bar .amount { font-size: 28px; font-weight: 800; }

        /* Action buttons */
        .action-buttons {
            padding: 16px 20px;
            display: flex;
            gap: 12px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .btn-action {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-prepare {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: #fff;
        }
        .btn-prepare:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }

        .btn-distribute {
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-teal) 100%);
            color: #000;
        }
        .btn-distribute:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4); }

        /* Hidden file inputs */
        .hidden-input { display: none; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background: var(--success);
            color: #fff;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: var(--error); }

        /* Print styles */
        @media print {
            .unified-header, .filters-bar, .import-buttons, .action-buttons, .detail-panel { display: none !important; }
            .main-container { display: block; }
            .orders-panel { border: none; }
            body { background: white; color: black; }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="unified-header">
        <div class="header-left">
            <button class="hamburger-btn" onclick="toggleMobileMenu()">‚ò∞</button>
            <div class="logo-section">
                <span class="logo-icon">üêü</span>
                <span class="logo-text">TRAKIO</span>
                <span class="nav-version">v5.1.0</span>
            </div>
            <nav class="nav-links" id="navLinks">
                <a href="index.html" class="nav-link"><span class="nav-icon">üè†</span><span>Dashboard</span></a>
                <a href="articles.html" class="nav-link"><span class="nav-icon">üì¶</span><span>Articles</span></a>
                <a href="clients.html" class="nav-link"><span class="nav-icon">üë•</span><span>Clients</span></a>
                <a href="commandes.html" class="nav-link"><span class="nav-icon">üìã</span><span>Commandes</span></a>
                <a href="caisse.html" class="nav-link"><span class="nav-icon">üí∞</span><span>Caisse</span></a>
                <a href="shopify.html" class="nav-link active"><span class="nav-icon">üõçÔ∏è</span><span>Shopify</span></a>
                <a href="myfish.html" class="nav-link"><span class="nav-icon">üêü</span><span>MyFish</span></a>
            </nav>
        </div>
        <div class="header-right">
            <div class="sync-status">
                <span class="sync-dot" id="syncDot"></span>
                <span id="syncText">Connexion...</span>
            </div>
            <div class="user-dropdown">
                <button class="user-btn" id="userBtn">
                    <div class="user-avatar" id="userAvatar">P</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Pascal</div>
                        <div class="user-role" id="userRole">Admin</div>
                    </div>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <div class="main-container">
        <!-- LEFT: Orders List -->
        <div class="orders-panel">
            <div class="panel-header">
                <div class="panel-title">üìã Articles √† pr√©parer</div>
                <div class="import-buttons">
                    <button class="btn btn-shopify" onclick="document.getElementById('shopifyInput').click()">
                        üõçÔ∏è Import Shopify
                    </button>
                    <button class="btn btn-myfish" onclick="document.getElementById('myfishInput').click()">
                        üêü Import MyFish
                    </button>
                    <button class="btn btn-secondary" onclick="generatePDF()">üìÑ PDF</button>
                    <button class="btn btn-secondary" onclick="clearAllOrders()">üóëÔ∏è Vider</button>
                </div>
                <div class="stats-bar">
                    <span class="stat-chip total">üì¶ <span id="statTotal">0</span></span>
                    <span class="stat-chip nyon">üè™ <span id="statNyon">0</span></span>
                    <span class="stat-chip coinsins">üè≠ <span id="statCoinsins">0</span></span>
                    <span class="stat-chip shipping">üöö <span id="statShipping">0</span></span>
                    <span class="stat-chip myfish">üêü <span id="statMyfish">0</span></span>
                </div>
            </div>
            <div class="filters-bar">
                <select class="filter-select" id="filterLocation" onchange="filterOrders()">
                    <option value="">Tous les lieux</option>
                    <option value="nyon">üè™ Nyon</option>
                    <option value="coinsins">üè≠ Coinsins</option>
                    <option value="shipping">üöö Livraison</option>
                    <option value="myfish">üêü MyFish</option>
                </select>
                <select class="filter-select" id="filterStatus" onchange="filterOrders()">
                    <option value="">Tous statuts</option>
                    <option value="pending">‚è≥ √Ä pr√©parer</option>
                    <option value="prepared">‚úÖ Pr√©par√©</option>
                    <option value="distributed">üì¶ Distribu√©</option>
                </select>
                <input type="text" class="filter-input" id="filterSearch" placeholder="üîç Rechercher..." oninput="filterOrders()">
            </div>
            <div class="orders-list" id="ordersList"></div>
        </div>

        <!-- RIGHT: Order Detail -->
        <div class="detail-panel" id="detailPanel">
            <div class="detail-empty" id="detailEmpty">
                <div class="icon">üëÜ</div>
                <h3>S√©lectionnez une commande</h3>
                <p>Cliquez sur une commande pour voir les d√©tails</p>
            </div>
            <div class="detail-content" id="detailContent">
                <div class="detail-header" id="detailHeader">
                    <button class="close-detail" onclick="closeDetail()">‚úï</button>
                    <h2 id="detailTitle">Commande</h2>
                    <div class="subtitle" id="detailSubtitle">Client</div>
                </div>
                <div class="detail-body">
                    <div class="detail-section">
                        <div class="section-title">üë§ Client</div>
                        <div class="client-card" id="clientCard"></div>
                    </div>
                    <div class="detail-section">
                        <div class="section-title">üì¶ Produits</div>
                        <div class="product-list" id="productList"></div>
                    </div>
                </div>
                <div class="total-bar">
                    <span class="label">TOTAL</span>
                    <span class="amount" id="totalAmount">CHF 0.00</span>
                </div>
                <div class="action-buttons">
                    <button class="btn-action btn-prepare" onclick="markPrepared()">‚úÖ Pr√©par√©</button>
                    <button class="btn-action btn-distribute" onclick="markDistributed()">üì¶ Distribu√©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden inputs -->
    <input type="file" id="shopifyInput" class="hidden-input" accept=".csv" onchange="importShopify(event)">
    <input type="file" id="myfishInput" class="hidden-input" accept=".csv,.json" onchange="importMyfish(event)">

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyExample",
            authDomain: "trakio-pilot-6e97a.firebaseapp.com",
            databaseURL: "https://trakio-pilot-6e97a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "trakio-pilot-6e97a",
            storageBucket: "trakio-pilot-6e97a.appspot.com",
            messagingSenderId: "256841216130",
            appId: "1:256841216130:web:4ea5a967ba39c120d8849b"
        };

        let db = null;
        let isOnline = navigator.onLine;

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            updateSyncStatus(true);
        } catch (e) {
            console.log('Firebase init error:', e);
            updateSyncStatus(false);
        }

        // ========== DATA ==========
        let allOrders = {};
        let selectedOrderId = null;
        const STORAGE_KEY = 'trakio_shopify_orders';

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderOrders();
            setupNetworkListeners();
        });

        function setupNetworkListeners() {
            window.addEventListener('online', () => {
                isOnline = true;
                updateSyncStatus(true);
                syncToFirebase();
            });
            window.addEventListener('offline', () => {
                isOnline = false;
                updateSyncStatus(false);
            });
        }

        function updateSyncStatus(online) {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');
            if (online) {
                dot.classList.remove('offline');
                text.textContent = 'En ligne';
            } else {
                dot.classList.add('offline');
                text.textContent = 'Hors ligne';
            }
        }

        // ========== MOBILE MENU ==========
        function toggleMobileMenu() {
            document.getElementById('navLinks').classList.toggle('mobile-open');
        }

        // ========== DATA PERSISTENCE ==========
        function saveData() {
            // LocalStorage
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allOrders));
            // Firebase sync
            syncToFirebase();
        }

        function loadData() {
            // Load from localStorage first
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    allOrders = JSON.parse(saved);
                } catch (e) {
                    allOrders = {};
                }
            }
            // Then try to sync from Firebase
            syncFromFirebase();
        }

        function syncToFirebase() {
            if (!db || !isOnline) return;
            try {
                db.ref('shopify_orders').set(allOrders);
            } catch (e) {
                console.log('Firebase sync error:', e);
            }
        }

        function syncFromFirebase() {
            if (!db) return;
            try {
                db.ref('shopify_orders').once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Merge with local data (Firebase takes priority for conflicts)
                        Object.keys(data).forEach(key => {
                            if (!allOrders[key] || data[key].updatedAt > (allOrders[key].updatedAt || 0)) {
                                allOrders[key] = data[key];
                            }
                        });
                        saveToLocalOnly();
                        renderOrders();
                    }
                });
            } catch (e) {
                console.log('Firebase read error:', e);
            }
        }

        function saveToLocalOnly() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allOrders));
        }

        // ========== IMPORT SHOPIFY ==========
        function importShopify(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => parseShopifyCSV(e.target.result);
            reader.readAsText(file);
            event.target.value = '';
        }

        function parseShopifyCSV(text) {
            const lines = [];
            let currentLine = '';
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                    currentLine += char;
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (currentLine.trim()) lines.push(currentLine);
                    currentLine = '';
                    if (char === '\r' && text[i + 1] === '\n') i++;
                } else {
                    currentLine += char;
                }
            }
            if (currentLine.trim()) lines.push(currentLine);

            const headers = parseCSVLine(lines[0]);
            let imported = 0;

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length < 5) continue;
                
                const row = {};
                headers.forEach((h, idx) => row[h.trim()] = (values[idx] || '').trim());
                
                const orderName = row['Name'] || '';
                if (!orderName || !orderName.includes('#')) continue;
                
                const fulfillment = (row['Fulfillment Status'] || '').toLowerCase();
                if (fulfillment === 'fulfilled') continue;
                
                const product = {
                    qty: parseInt(row['Lineitem quantity']) || 1,
                    name: row['Lineitem name'] || 'Article',
                    price: parseFloat(row['Lineitem price']) || 0,
                    sku: row['Lineitem sku'] || ''
                };
                
                if (!allOrders[orderName]) {
                    imported++;
                    const noteAttr = row['Note Attributes'] || '';
                    const shippingMethod = row['Shipping Method'] || '';
                    
                    let location = 'shipping';
                    if (noteAttr.includes('Magasin de Nyon') || noteAttr.includes('Nyon')) {
                        location = 'nyon';
                    } else if (noteAttr.includes('Laboratoire de Coinsins') || noteAttr.includes('Coinsins')) {
                        location = 'coinsins';
                    } else if (shippingMethod.includes('Swiss Post') || shippingMethod.includes('Shipping') || shippingMethod.includes('Forfait')) {
                        location = 'shipping';
                    } else if (noteAttr.includes('Store Pickup')) {
                        location = 'coinsins';
                    }
                    
                    const dueDateMatch = noteAttr.match(/Order Due Date:\s*(\w+),\s*(\d+)\s+(\w+)\s+(\d{4})/);
                    let dueDate = new Date().toISOString();
                    if (dueDateMatch) {
                        const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
                        dueDate = new Date(parseInt(dueDateMatch[4]), months[dueDateMatch[3]], parseInt(dueDateMatch[2])).toISOString();
                    }
                    
                    const timeMatch = noteAttr.match(/Order Due Time:\s*([^\n]+)/);
                    const timeSlot = timeMatch ? timeMatch[1].trim() : '';
                    
                    allOrders[orderName] = {
                        id: orderName,
                        source: 'shopify',
                        email: row['Email'] || '',
                        customer: row['Billing Name'] || row['Shipping Name'] || 'Client',
                        phone: row['Billing Phone'] || row['Shipping Phone'] || row['Phone'] || '',
                        address: [
                            row['Shipping Address1'] || row['Billing Address1'],
                            row['Shipping City'] || row['Billing City'],
                            (row['Shipping Zip'] || row['Billing Zip'] || '').replace("'", '')
                        ].filter(Boolean).join(', '),
                        total: parseFloat(row['Total']) || 0,
                        location: location,
                        dueDate: dueDate,
                        timeSlot: timeSlot,
                        products: [],
                        notes: row['Notes'] || '',
                        status: 'pending',
                        updatedAt: Date.now()
                    };
                }
                
                if (product.name && product.name !== 'Article') {
                    allOrders[orderName].products.push(product);
                }
            }

            saveData();
            renderOrders();
            showToast(`‚úÖ ${imported} commandes Shopify import√©es`);
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current);
            return values;
        }

        // ========== IMPORT MYFISH ==========
        function importMyfish(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    parseMyfishJSON(data);
                } catch {
                    parseMyfishCSV(e.target.result);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function parseMyfishJSON(data) {
            const orders = Array.isArray(data) ? data : (data.orders || data.commandes || []);
            let imported = 0;
            
            orders.forEach(order => {
                const id = 'MF#' + (order.id || order.numero || Date.now() + Math.random().toString(36).substr(2, 5));
                if (!allOrders[id]) {
                    imported++;
                    allOrders[id] = {
                        id: id,
                        source: 'myfish',
                        email: order.email || '',
                        customer: order.customer || order.client || order.name || order.nom || 'Client MyFish',
                        phone: order.phone || order.tel || order.telephone || '',
                        address: order.address || order.adresse || '',
                        total: parseFloat(order.total) || 0,
                        location: 'myfish',
                        dueDate: order.date ? new Date(order.date).toISOString() : new Date().toISOString(),
                        timeSlot: order.time || order.heure || '',
                        products: (order.products || order.produits || order.items || order.articles || []).map(p => ({
                            qty: parseInt(p.qty || p.quantite || p.quantity) || 1,
                            name: p.name || p.nom || p.product || p.produit || 'Article',
                            price: parseFloat(p.price || p.prix) || 0
                        })),
                        notes: order.notes || order.remarques || '',
                        status: 'pending',
                        updatedAt: Date.now()
                    };
                }
            });
            
            saveData();
            renderOrders();
            showToast(`‚úÖ ${imported} commandes MyFish import√©es`);
        }

        function parseMyfishCSV(text) {
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) return;
            
            const headers = lines[0].split(/[,;]/).map(h => h.trim().toLowerCase());
            let imported = 0;
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(/[,;]/);
                const row = {};
                headers.forEach((h, idx) => row[h] = (values[idx] || '').trim());
                
                const id = 'MF#' + (row.id || row.numero || Date.now() + i);
                if (!allOrders[id]) {
                    imported++;
                    allOrders[id] = {
                        id: id,
                        source: 'myfish',
                        email: row.email || '',
                        customer: row.customer || row.client || row.nom || 'Client MyFish',
                        phone: row.phone || row.tel || '',
                        address: row.address || row.adresse || '',
                        total: parseFloat(row.total) || 0,
                        location: 'myfish',
                        dueDate: row.date ? new Date(row.date).toISOString() : new Date().toISOString(),
                        timeSlot: row.time || row.heure || '',
                        products: [{
                            qty: parseInt(row.qty || row.quantite) || 1,
                            name: row.product || row.produit || row.article || 'Article',
                            price: parseFloat(row.price || row.prix) || 0
                        }],
                        notes: row.notes || '',
                        status: 'pending',
                        updatedAt: Date.now()
                    };
                }
            }
            
            saveData();
            renderOrders();
            showToast(`‚úÖ ${imported} commandes MyFish import√©es`);
        }

        // ========== RENDER ==========
        function renderOrders() {
            const container = document.getElementById('ordersList');
            const orders = Object.values(allOrders);
            
            // Update stats
            let stats = { total: 0, nyon: 0, coinsins: 0, shipping: 0, myfish: 0 };
            orders.forEach(o => {
                if (o.status !== 'distributed') {
                    stats.total++;
                    stats[o.location]++;
                }
            });
            
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statNyon').textContent = stats.nyon;
            document.getElementById('statCoinsins').textContent = stats.coinsins;
            document.getElementById('statShipping').textContent = stats.shipping;
            document.getElementById('statMyfish').textContent = stats.myfish;
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üì•</div>
                        <h3>Aucune commande</h3>
                        <p>Importez un fichier CSV Shopify ou MyFish</p>
                    </div>
                `;
                return;
            }
            
            // Apply filters
            const filterLoc = document.getElementById('filterLocation').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const filterSearch = document.getElementById('filterSearch').value.toLowerCase();
            
            let filtered = orders.filter(o => {
                if (filterLoc && o.location !== filterLoc) return false;
                if (filterStatus && o.status !== filterStatus) return false;
                if (filterSearch) {
                    const searchStr = `${o.id} ${o.customer} ${o.email}`.toLowerCase();
                    if (!searchStr.includes(filterSearch)) return false;
                }
                return true;
            });
            
            // Group by date
            const byDate = {};
            filtered.forEach(order => {
                const dateKey = order.dueDate ? order.dueDate.split('T')[0] : 'unknown';
                if (!byDate[dateKey]) byDate[dateKey] = [];
                byDate[dateKey].push(order);
            });
            
            const sortedDates = Object.keys(byDate).sort();
            
            let html = '';
            sortedDates.forEach(dateKey => {
                const dateOrders = byDate[dateKey];
                const date = new Date(dateKey);
                const dateStr = formatDateFr(date);
                
                // Count by location
                const locCounts = { nyon: 0, coinsins: 0, shipping: 0, myfish: 0 };
                dateOrders.forEach(o => locCounts[o.location]++);
                
                html += `<div class="date-group">
                    <div class="date-header">
                        <span>üìÖ ${dateStr}</span>
                        <div class="date-badges">
                            ${locCounts.nyon > 0 ? `<span class="mini-badge nyon">${locCounts.nyon}</span>` : ''}
                            ${locCounts.coinsins > 0 ? `<span class="mini-badge coinsins">${locCounts.coinsins}</span>` : ''}
                            ${locCounts.shipping > 0 ? `<span class="mini-badge shipping">${locCounts.shipping}</span>` : ''}
                            ${locCounts.myfish > 0 ? `<span class="mini-badge myfish">${locCounts.myfish}</span>` : ''}
                        </div>
                    </div>`;
                
                // Sort by time slot, then location
                dateOrders.sort((a, b) => (a.timeSlot || '').localeCompare(b.timeSlot || ''));
                
                dateOrders.forEach(order => {
                    const productCount = order.products ? order.products.reduce((sum, p) => sum + (p.qty || 1), 0) : 0;
                    const statusIcon = order.status === 'distributed' ? 'üì¶' : order.status === 'prepared' ? '‚úÖ' : '‚è≥';
                    const selectedClass = selectedOrderId === order.id ? 'selected' : '';
                    const statusClass = order.status || '';
                    
                    html += `<div class="order-item ${order.location} ${selectedClass} ${statusClass}" onclick="selectOrder('${order.id}')">
                        <div class="order-number ${order.location}">${order.id}</div>
                        <div class="order-info">
                            <div class="order-customer">${order.customer}</div>
                            <div class="order-meta">
                                <span>${order.timeSlot || 'Pas d\'heure'}</span>
                                <span>‚Ä¢</span>
                                <span>${productCount} art.</span>
                            </div>
                        </div>
                        <div class="order-count">CHF ${(order.total || 0).toFixed(0)}</div>
                        <div class="order-status">${statusIcon}</div>
                    </div>`;
                });
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        function formatDateFr(date) {
            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            const months = ['jan', 'f√©v', 'mar', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sep', 'oct', 'nov', 'd√©c'];
            return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
        }

        function filterOrders() {
            renderOrders();
        }

        // ========== SELECT ORDER ==========
        function selectOrder(orderId) {
            selectedOrderId = orderId;
            const order = allOrders[orderId];
            if (!order) return;
            
            // Update list selection
            document.querySelectorAll('.order-item').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            // Show detail panel
            document.getElementById('detailEmpty').style.display = 'none';
            document.getElementById('detailContent').classList.add('active');
            document.getElementById('detailPanel').classList.add('mobile-active');
            
            // Update header
            const header = document.getElementById('detailHeader');
            header.className = `detail-header ${order.location}`;
            document.getElementById('detailTitle').textContent = order.id;
            document.getElementById('detailSubtitle').textContent = order.customer;
            
            // Update client card
            document.getElementById('clientCard').innerHTML = `
                <h3>${order.customer}</h3>
                ${order.email ? `<div class="info">üìß ${order.email}</div>` : ''}
                ${order.phone ? `<div class="info">üì± ${order.phone}</div>` : ''}
                ${order.address ? `<div class="info">üìç ${order.address}</div>` : ''}
                <div class="info">üìÖ ${formatDateFr(new Date(order.dueDate))} ${order.timeSlot ? `‚Ä¢ ‚è∞ ${order.timeSlot}` : ''}</div>
                ${order.notes ? `<div class="info">üìù ${order.notes}</div>` : ''}
            `;
            
            // Update products
            const productList = document.getElementById('productList');
            if (order.products && order.products.length > 0) {
                productList.innerHTML = order.products.map(p => `
                    <div class="product-item">
                        <div class="product-qty">${p.qty}x</div>
                        <div class="product-name">${p.name}</div>
                        <div class="product-price">CHF ${(p.qty * p.price).toFixed(2)}</div>
                    </div>
                `).join('');
            } else {
                productList.innerHTML = '<div class="empty-state"><p>Aucun produit</p></div>';
            }
            
            // Update total
            document.getElementById('totalAmount').textContent = `CHF ${(order.total || 0).toFixed(2)}`;
        }

        function closeDetail() {
            document.getElementById('detailPanel').classList.remove('mobile-active');
            document.getElementById('detailContent').classList.remove('active');
            document.getElementById('detailEmpty').style.display = 'flex';
            selectedOrderId = null;
            document.querySelectorAll('.order-item').forEach(el => el.classList.remove('selected'));
        }

        // ========== ACTIONS ==========
        function markPrepared() {
            if (!selectedOrderId || !allOrders[selectedOrderId]) return;
            allOrders[selectedOrderId].status = 'prepared';
            allOrders[selectedOrderId].updatedAt = Date.now();
            saveData();
            renderOrders();
            showToast('‚úÖ Commande marqu√©e comme pr√©par√©e');
        }

        function markDistributed() {
            if (!selectedOrderId || !allOrders[selectedOrderId]) return;
            allOrders[selectedOrderId].status = 'distributed';
            allOrders[selectedOrderId].updatedAt = Date.now();
            saveData();
            renderOrders();
            closeDetail();
            showToast('üì¶ Commande distribu√©e');
        }

        function clearAllOrders() {
            if (!confirm('Supprimer toutes les commandes ?')) return;
            allOrders = {};
            selectedOrderId = null;
            saveData();
            renderOrders();
            closeDetail();
            showToast('üóëÔ∏è Toutes les commandes supprim√©es');
        }

        // ========== PDF ==========
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 12;
            let y = margin;

            const orders = Object.values(allOrders).filter(o => o.status !== 'distributed');
            
            if (orders.length === 0) {
                showToast('Aucune commande √† exporter', true);
                return;
            }
            
            const byDate = {};
            orders.forEach(order => {
                const key = order.dueDate ? order.dueDate.split('T')[0] : 'unknown';
                if (!byDate[key]) byDate[key] = [];
                byDate[key].push(order);
            });
            const sortedDates = Object.keys(byDate).sort();

            // Title
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text('Commandes - Borex Poissons', margin, y);
            y += 7;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-CH')} - ${orders.length} commandes`, margin, y);
            y += 10;

            const colors = {
                nyon: [239, 68, 68],
                coinsins: [59, 130, 246],
                shipping: [249, 115, 22],
                myfish: [139, 92, 246]
            };

            sortedDates.forEach(dateKey => {
                const dateOrders = byDate[dateKey];
                const date = new Date(dateKey);

                if (y > pageHeight - 50) {
                    doc.addPage();
                    y = margin;
                }

                // Date header
                doc.setFillColor(71, 85, 105);
                doc.rect(margin, y, pageWidth - 2 * margin, 8, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(255);
                doc.text(`${formatDateFr(date)} - ${dateOrders.length} cmd`, margin + 3, y + 5.5);
                y += 11;

                dateOrders.sort((a, b) => (a.timeSlot || '').localeCompare(b.timeSlot || ''));

                dateOrders.forEach(order => {
                    const color = colors[order.location] || [100, 100, 100];
                    const lineHeight = 8 + (order.products ? order.products.length * 3.5 : 0);
                    
                    if (y + lineHeight > pageHeight - 10) {
                        doc.addPage();
                        y = margin;
                    }

                    // Order number badge
                    doc.setFillColor(...color);
                    doc.roundedRect(margin, y, 24, 5, 1, 1, 'F');
                    doc.setTextColor(255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(order.id.replace('Web ', '').replace('MF', 'MF'), margin + 2, y + 3.5);
                    
                    // Customer
                    doc.setTextColor(0);
                    doc.setFontSize(9);
                    doc.text(order.customer, margin + 28, y + 3.5);
                    
                    // Time
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(100);
                    doc.setFontSize(8);
                    doc.text(order.timeSlot || '', margin + 28, y + 7);
                    
                    // Total
                    doc.setTextColor(0);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`CHF ${(order.total || 0).toFixed(2)}`, pageWidth - margin - 22, y + 3.5);
                    
                    y += 9;

                    // Products
                    if (order.products && order.products.length > 0) {
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(7);
                        doc.setTextColor(60);
                        order.products.forEach(p => {
                            const prodText = `  ${p.qty}x ${p.name}`;
                            const truncated = prodText.length > 85 ? prodText.substring(0, 82) + '...' : prodText;
                            doc.text(truncated, margin + 28, y);
                            y += 3.5;
                        });
                    }
                    
                    y += 2;
                });

                y += 5;
            });

            doc.save(`Commandes_${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('üìÑ PDF g√©n√©r√©');
        }

        // ========== TOAST ==========
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>

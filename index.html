<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<<<<<<< HEAD
    <title>TRAKIO - Module COMPTA v1.0.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
=======
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TRAKIO v3.2.2 - Gestion Compl√®te</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configurer PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
>>>>>>> parent of 327a79d (Update index.html)
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #dbeafe;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
            --radius: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo i {
            font-size: 1.75rem;
        }

        .module-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .sync-status.syncing i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .admin-badge {
            background: var(--warning);
            color: var(--gray-900);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .btn-back {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-back:hover {
            background: rgba(255,255,255,0.25);
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: white;
            padding: 0 2rem;
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-500);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: var(--primary);
            background: var(--gray-50);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .nav-tab .badge {
            background: var(--danger);
            color: white;
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .kpi-icon.blue { background: var(--primary-light); color: var(--primary); }
        .kpi-icon.green { background: var(--success-light); color: var(--success); }
        .kpi-icon.orange { background: var(--warning-light); color: var(--warning); }
        .kpi-icon.red { background: var(--danger-light); color: var(--danger); }

        .kpi-trend {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-weight: 500;
        }

        .kpi-trend.up { background: var(--success-light); color: var(--success); }
        .kpi-trend.down { background: var(--danger-light); color: var(--danger); }
        .kpi-trend.neutral { background: var(--gray-100); color: var(--gray-500); }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .kpi-label {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chart-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            border: 1px solid var(--gray-200);
            background: white;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-btn:hover, .chart-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Tables */
        .table-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .table-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .table-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: 0.875rem;
            width: 250px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .search-box i {
            position: absolute;
            left: 0.875rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .filter-select {
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-200);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--gray-50);
            padding: 0.875rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.875rem;
            vertical-align: middle;
        }

        .data-table tbody tr:hover {
            background: var(--gray-50);
        }

        .data-table .actions {
            display: flex;
            gap: 0.5rem;
        }

        .data-table .actions button {
            padding: 0.375rem 0.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: var(--radius);
            color: var(--gray-500);
            transition: all 0.2s;
        }

        .data-table .actions button:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .data-table .actions button.delete:hover {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }

        .status-badge.paid { background: var(--success-light); color: var(--success); }
        .status-badge.pending { background: var(--warning-light); color: var(--warning); }
        .status-badge.overdue { background: var(--danger-light); color: var(--danger); }

        /* Category Tag */
        .category-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: modalSlide 0.3s ease;
        }

        .modal.large {
            max-width: 800px;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.95) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--gray-400);
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--gray-600);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background: var(--gray-50);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .form-label .required {
            color: var(--danger);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.375rem;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .file-upload i {
            font-size: 2rem;
            color: var(--gray-400);
            margin-bottom: 0.5rem;
        }

        .file-upload p {
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .file-upload input {
            display: none;
        }

        .file-list {
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }

        .file-item-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .file-item-icon {
            width: 36px;
            height: 36px;
            background: var(--danger-light);
            color: var(--danger);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-item-name {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .file-item-size {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Category Cards */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .category-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .category-card:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .category-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .category-card-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            margin-bottom: 0.75rem;
        }

        .category-card-name {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .category-card-count {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .category-card-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-top: 0.5rem;
        }

        .category-card-actions {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: none;
        }

        .category-card:hover .category-card-actions {
            display: flex;
            gap: 0.25rem;
        }

        .category-card-actions button {
            padding: 0.25rem;
            border: none;
            background: var(--gray-100);
            border-radius: 4px;
            cursor: pointer;
            color: var(--gray-500);
            font-size: 0.75rem;
        }

        .category-card-actions button:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert-warning {
            background: var(--warning-light);
            border: 1px solid var(--warning);
        }

        .alert-warning i {
            color: var(--warning);
        }

        .alert-danger {
            background: var(--danger-light);
            border: 1px solid var(--danger);
        }

        .alert-danger i {
            color: var(--danger);
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-message {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        /* Recommendations */
        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .recommendation-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary);
        }

        .recommendation-card.warning {
            border-left-color: var(--warning);
        }

        .recommendation-card.danger {
            border-left-color: var(--danger);
        }

        .recommendation-card.success {
            border-left-color: var(--success);
        }

        .recommendation-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .recommendation-text {
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.5;
        }

        .recommendation-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-top: 0.75rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .login-logo {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: var(--gray-500);
            margin-bottom: 2rem;
        }

        .pin-inputs {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .pin-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            transition: all 0.2s;
        }

        .pin-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .login-error {
            color: var(--danger);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 3000;
        }

        .toast {
            background: var(--gray-800);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: toastSlide 0.3s ease;
            min-width: 300px;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); color: var(--gray-900); }

        @keyframes toastSlide {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .nav-tabs {
                padding: 0 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box input {
                width: 100%;
            }

            .modal {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }
        }

        /* Color palette for categories */
        .color-blue { background: #dbeafe; color: #2563eb; }
        .color-green { background: #d1fae5; color: #059669; }
        .color-yellow { background: #fef3c7; color: #d97706; }
        .color-red { background: #fee2e2; color: #dc2626; }
        .color-purple { background: #ede9fe; color: #7c3aed; }
        .color-pink { background: #fce7f3; color: #db2777; }
        .color-indigo { background: #e0e7ff; color: #4f46e5; }
        .color-teal { background: #ccfbf1; color: #0d9488; }
        .color-orange { background: #ffedd5; color: #ea580c; }
        .color-gray { background: #f3f4f6; color: #4b5563; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-lock"></i>
            </div>
            <h1 class="login-title">Module COMPTA</h1>
            <p class="login-subtitle">Acc√®s r√©serv√© √† l'administrateur</p>
            <div class="pin-inputs">
                <input type="password" class="pin-input" maxlength="1" data-index="0" inputmode="numeric">
                <input type="password" class="pin-input" maxlength="1" data-index="1" inputmode="numeric">
                <input type="password" class="pin-input" maxlength="1" data-index="2" inputmode="numeric">
                <input type="password" class="pin-input" maxlength="1" data-index="3" inputmode="numeric">
            </div>
<<<<<<< HEAD
            <p class="login-error" id="loginError">Code PIN incorrect</p>
            <button class="btn btn-primary" style="width: 100%;" onclick="verifyPin()">
                <i class="fas fa-sign-in-alt"></i> Connexion
=======
            
            <!-- Footer -->
            <div style="text-align:center; margin-top:28px; padding-top:20px; border-top:1px solid var(--border-color);">
                <p style="font-size:11px; color:var(--text-muted);">v3.0.0 ‚Ä¢ D√©connexion auto apr√®s 1h</p>
            </div>
            
        </div>
    </div>
    
    <!-- Modal de mise √† jour bloquant -->
    <div id="update-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:100000; display:none; align-items:center; justify-content:center;">
        <div style="background:var(--bg-card); border:2px solid var(--accent-primary); border-radius:24px; padding:48px; max-width:450px; text-align:center; box-shadow:0 30px 100px rgba(6,214,160,0.4);">
            <!-- Animation de chargement -->
            <div id="update-loader" style="margin-bottom:24px;">
                <div style="width:80px; height:80px; margin:0 auto; border:4px solid var(--border-color); border-top-color:var(--accent-primary); border-radius:50%; animation:spin 1s linear infinite;"></div>
            </div>
            
            <h2 style="font-size:24px; font-weight:800; margin-bottom:12px; color:var(--accent-primary);">
                <span id="update-icon">üîÑ</span> Mise √† jour en cours
            </h2>
            
            <p id="update-message" style="color:var(--text-secondary); font-size:15px; line-height:1.6; margin-bottom:24px;">
                Une nouvelle version de TRAKIO est disponible.<br>
                Veuillez patienter pendant la mise √† jour...
            </p>
            
            <div id="update-version-info" style="background:var(--bg-primary); border-radius:12px; padding:16px; margin-bottom:24px;">
                <div style="display:flex; justify-content:center; align-items:center; gap:16px;">
                    <div>
                        <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase;">Actuelle</div>
                        <div id="update-current-version" style="font-family:'Space Mono',monospace; font-size:18px; font-weight:700; color:var(--text-muted);">v3.2.2</div>
                    </div>
                    <div style="font-size:24px;">‚Üí</div>
                    <div>
                        <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase;">Nouvelle</div>
                        <div id="update-new-version" style="font-family:'Space Mono',monospace; font-size:18px; font-weight:700; color:var(--accent-primary);">v3.2.2</div>
                    </div>
                </div>
            </div>
            
            <div id="update-progress" style="background:var(--bg-primary); border-radius:10px; height:8px; overflow:hidden; margin-bottom:20px;">
                <div id="update-progress-bar" style="width:0%; height:100%; background:linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); transition:width 0.5s; animation:progress-pulse 2s ease-in-out infinite;"></div>
            </div>
            
            <p style="font-size:12px; color:var(--text-muted);">
                ‚è≥ Ne fermez pas cette fen√™tre
            </p>
            
            <!-- Bouton de rechargement (appara√Æt quand pr√™t) -->
            <button id="update-reload-btn" onclick="forceHardReload()" style="display:none; margin-top:20px; width:100%; padding:16px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border:none; border-radius:12px; color:white; font-size:16px; font-weight:700; cursor:pointer;">
                üöÄ Recharger maintenant
>>>>>>> parent of 327a79d (Update index.html)
            </button>
        </div>
    </div>

<<<<<<< HEAD
    <!-- Main App -->
    <div class="app" id="mainApp" style="display: none;">
=======
    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">TR</div>
            <span class="logo-text">TRAKIO</span>
            <span id="nav-version" style="font-size:10px; color:var(--text-muted); margin-left:6px; font-family:'Space Mono',monospace;">v3.2.2</span>
        </div>

        <button class="sidebar-toggle" id="sidebarToggle">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
        </button>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <div class="nav-item active" data-page="dashboard">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="9" rx="1"/>
                        <rect x="14" y="3" width="7" height="5" rx="1"/>
                        <rect x="14" y="12" width="7" height="9" rx="1"/>
                        <rect x="3" y="16" width="7" height="5" rx="1"/>
                    </svg>
                    <span class="nav-text">Accueil</span>
                </div>
                <div class="nav-item" data-page="analyses">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M18 9l-5 5-4-4-4 4"/>
                    </svg>
                    <span class="nav-text">üìä Analyses</span>
                </div>
                <div class="nav-item" data-page="orders">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                        <rect x="9" y="3" width="6" height="4" rx="1"/>
                        <path d="M9 12h6m-6 4h6"/>
                    </svg>
                    <span class="nav-text">Cmd en cours</span>
                    <span class="nav-badge" id="orders-badge">0</span>
                </div>
                <div class="nav-item" data-page="tracking">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <span class="nav-text">Suivi</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title collapsible collapsed" onclick="toggleNavSection(this)">
                    <span>üõ†Ô∏è Outils</span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="nav-section-content collapsed" id="tools-section">
                <div class="nav-item" data-page="nutriscore">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    <span class="nav-text">Nutri-Score</span>
                </div>
                <div class="nav-item" data-page="prix-traversette">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                    </svg>
                    <span class="nav-text">Prix Traversette</span>
                </div>
                <div class="nav-item" data-page="cours-poissons">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6.5 12c3-7 14-7 14 0s-11 7-14 0z"/>
                        <circle cx="17" cy="12" r="1" fill="currentColor"/>
                        <path d="M2 12l4-3v6z"/>
                    </svg>
                    <span class="nav-text">Cours Poissons</span>
                </div>
                <div class="nav-item" data-page="prix-fournisseurs">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2"/>
                        <line x1="8" y1="21" x2="16" y2="21"/>
                        <line x1="12" y1="17" x2="12" y2="21"/>
                        <path d="M7 8h2M7 11h4M15 8h2M15 11h2"/>
                    </svg>
                    <span class="nav-text">üí∞ Prix Fournisseurs</span>
                </div>
                <div class="nav-item" data-page="myfish">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6.5 12c3-7 14-7 14 0s-11 7-14 0z"/>
                        <circle cx="17" cy="12" r="1" fill="currentColor"/>
                        <path d="M2 12l4-3v6z"/>
                        <path d="M12 8v8M8 12h8" stroke-width="1.5"/>
                    </svg>
                    <span class="nav-text">üêü MyFish</span>
                </div>
                <div class="nav-item" data-page="shop">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15.5 2.5L14 10l-4 1 1.5-8.5M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
                        <path d="M14 10l4 1-5 10-1-6-5-1 7-12"/>
                    </svg>
                    <span class="nav-text">üõçÔ∏è Shop Hub</span>
                </div>
                <div class="nav-item" data-page="quickorder">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    <span class="nav-text">‚ö° Prise cmd</span>
                </div>
                <div class="nav-item" data-page="clients">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                    <span class="nav-text">üë• Clients</span>
                </div>
                <div class="nav-item" data-page="articles">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span class="nav-text">üì¶ Articles</span>
                </div>
                <div class="nav-item" data-page="reports">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    <span class="nav-text">Rapports</span>
                </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Syst√®me</div>
                <div class="nav-item" data-page="rh" data-permission="admin">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                    <span class="nav-text">RH Personnel</span>
                </div>
                <div class="nav-item" data-page="settings">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                    <span class="nav-text">Param√®tres</span>
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
>>>>>>> parent of 327a79d (Update index.html)
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-chart-pie"></i>
                    TRAKIO COMPTA
                </div>
                <span class="module-badge">v1.0.0</span>
            </div>
            <div class="header-right">
                <div class="sync-status" id="syncStatus">
                    <i class="fas fa-cloud"></i>
                    <span>Connect√©</span>
                </div>
                <span class="admin-badge">
                    <i class="fas fa-shield-alt"></i>
                    Admin
                </span>
                <button class="btn-back" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i>
                    Retour TRAKIO
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </div>
            <div class="nav-tab" data-tab="charges">
                <i class="fas fa-file-invoice-dollar"></i>
                Charges
                <span class="badge" id="chargesPending">0</span>
            </div>
            <div class="nav-tab" data-tab="postes">
                <i class="fas fa-folder"></i>
                Postes
            </div>
            <div class="nav-tab" data-tab="fournisseurs">
                <i class="fas fa-building"></i>
                Fournisseurs
            </div>
            <div class="nav-tab" data-tab="analyses">
                <i class="fas fa-chart-line"></i>
                Analyses
            </div>
            <div class="nav-tab" data-tab="budget">
                <i class="fas fa-calculator"></i>
                Budget
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="tab-dashboard">
                <!-- Alerts -->
                <div id="dashboardAlerts"></div>

                <!-- KPI Cards -->
                <div class="dashboard-grid">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon blue">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <span class="kpi-trend neutral" id="kpiMonthTrend">-</span>
                        </div>
                        <div class="kpi-value" id="kpiMonthTotal">CHF 0.00</div>
                        <div class="kpi-label">Charges ce mois</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon green">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <span class="kpi-trend neutral" id="kpiYearTrend">-</span>
                        </div>
                        <div class="kpi-value" id="kpiYearTotal">CHF 0.00</div>
                        <div class="kpi-label">Charges cette ann√©e</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon orange">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpiPending">0</div>
                        <div class="kpi-label">Factures en attente</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon red">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                        </div>
                        <div class="kpi-value" id="kpiOverdue">0</div>
                        <div class="kpi-label">Factures en retard</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">√âvolution mensuelle</h3>
                            <div class="chart-actions">
                                <button class="chart-btn active" data-period="6">6 mois</button>
                                <button class="chart-btn" data-period="12">12 mois</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="evolutionChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">R√©partition par poste</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="repartitionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Charges -->
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">Derni√®res charges</h3>
                        <button class="btn btn-primary" onclick="openModal('chargeModal')">
                            <i class="fas fa-plus"></i> Nouvelle charge
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Libell√©</th>
                                <th>Poste</th>
                                <th>Fournisseur</th>
                                <th>Montant</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentChargesTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Charges Tab -->
            <div class="tab-content" id="tab-charges">
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">Registre des charges</h3>
                        <div class="table-actions">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Rechercher..." id="chargesSearch" onkeyup="filterCharges()">
                            </div>
                            <select class="filter-select" id="chargesFilterPoste" onchange="filterCharges()">
                                <option value="">Tous les postes</option>
                            </select>
                            <select class="filter-select" id="chargesFilterStatus" onchange="filterCharges()">
                                <option value="">Tous statuts</option>
                                <option value="paid">‚úÖ Pay√©</option>
                                <option value="pending">‚è≥ En attente</option>
                                <option value="overdue">üî¥ En retard</option>
                            </select>
                            <select class="filter-select" id="chargesFilterPeriod" onchange="filterCharges()">
                                <option value="">Toutes p√©riodes</option>
                                <option value="month">Ce mois</option>
                                <option value="quarter">Ce trimestre</option>
                                <option value="year">Cette ann√©e</option>
                            </select>
                            <button class="btn btn-secondary" onclick="exportCharges()">
                                <i class="fas fa-download"></i> Exporter
                            </button>
                            <button class="btn btn-primary" onclick="openModal('chargeModal')">
                                <i class="fas fa-plus"></i> Nouvelle charge
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>√âch√©ance</th>
                                <th>Libell√©</th>
                                <th>Poste</th>
                                <th>Fournisseur</th>
                                <th>HT</th>
                                <th>TVA</th>
                                <th>TTC</th>
                                <th>R√©currence</th>
                                <th>Statut</th>
                                <th>Pi√®ce</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="chargesTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Postes Tab -->
            <div class="tab-content" id="tab-postes">
                <div class="table-card" style="padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 class="table-title">Postes de charges</h3>
                        <button class="btn btn-primary" onclick="openModal('posteModal')">
                            <i class="fas fa-plus"></i> Nouveau poste
                        </button>
                    </div>
                    <div class="categories-grid" id="postesGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Fournisseurs Tab -->
            <div class="tab-content" id="tab-fournisseurs">
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">Fournisseurs & Prestataires</h3>
                        <div class="table-actions">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Rechercher..." id="fournisseursSearch" onkeyup="filterFournisseurs()">
                            </div>
                            <button class="btn btn-primary" onclick="openModal('fournisseurModal')">
                                <i class="fas fa-plus"></i> Nouveau fournisseur
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Cat√©gorie</th>
                                <th>Contact</th>
                                <th>Email</th>
                                <th>T√©l√©phone</th>
                                <th>Conditions</th>
                                <th>Total ann√©e</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fournisseursTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analyses Tab -->
            <div class="tab-content" id="tab-analyses">
                <div class="dashboard-grid" style="margin-bottom: 2rem;">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon blue">
                                <i class="fas fa-balance-scale"></i>
                            </div>
                        </div>
                        <div class="kpi-value" id="seuilRentabilite">CHF 0</div>
                        <div class="kpi-label">Seuil de rentabilit√© / mois</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon green">
                                <i class="fas fa-percentage"></i>
                            </div>
                        </div>
                        <div class="kpi-value" id="margeNecessaire">0%</div>
                        <div class="kpi-label">Marge moyenne n√©cessaire</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon orange">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="kpi-value" id="tendance">-</div>
                        <div class="kpi-label">Tendance charges</div>
                    </div>
                </div>

                <div class="chart-card" style="margin-bottom: 2rem;">
                    <div class="chart-header">
                        <h3 class="chart-title">Comparaison N vs N-1</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="comparaisonChart"></canvas>
                    </div>
                </div>

                <h3 style="margin-bottom: 1rem; color: var(--gray-800);">
                    <i class="fas fa-lightbulb" style="color: var(--warning);"></i>
                    Recommandations
                </h3>
                <div class="recommendations-grid" id="recommendationsGrid">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Budget Tab -->
            <div class="tab-content" id="tab-budget">
                <div class="table-card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 class="table-title">Budget pr√©visionnel par poste</h3>
                        <button class="btn btn-primary" onclick="saveBudget()">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Poste</th>
                                <th>Budget mensuel</th>
                                <th>D√©pens√© ce mois</th>
                                <th>√âcart</th>
                                <th>Progression</th>
                            </tr>
                        </thead>
                        <tbody id="budgetTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Nouvelle Charge -->
    <div class="modal-overlay" id="chargeModal">
        <div class="modal large">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span id="chargeModalTitle">Nouvelle charge</span>
                </h3>
                <button class="modal-close" onclick="closeModal('chargeModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="chargeId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Libell√© <span class="required">*</span></label>
                        <input type="text" class="form-input" id="chargeLibelle" placeholder="Ex: Loyer novembre 2024">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Poste <span class="required">*</span></label>
                        <select class="form-select" id="chargePoste">
                            <option value="">S√©lectionner...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fournisseur</label>
                        <select class="form-select" id="chargeFournisseur">
                            <option value="">S√©lectionner...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">R√©currence</label>
                        <select class="form-select" id="chargeRecurrence">
                            <option value="ponctuel">Ponctuel</option>
                            <option value="mensuel">Mensuel</option>
                            <option value="trimestriel">Trimestriel</option>
                            <option value="annuel">Annuel</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Montant HT <span class="required">*</span></label>
                        <input type="number" step="0.01" class="form-input" id="chargeMontantHT" placeholder="0.00" onchange="calculateTTC()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Taux TVA</label>
                        <select class="form-select" id="chargeTVA" onchange="calculateTTC()">
                            <option value="0">Sans TVA</option>
                            <option value="2.6">2.6% (R√©duit)</option>
                            <option value="3.8">3.8% (H√©berg.)</option>
                            <option value="8.1" selected>8.1% (Normal)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Montant TTC</label>
                        <input type="number" step="0.01" class="form-input" id="chargeMontantTTC" readonly style="background: var(--gray-50);">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date facture <span class="required">*</span></label>
                        <input type="date" class="form-input" id="chargeDateFacture">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date √©ch√©ance</label>
                        <input type="date" class="form-input" id="chargeDateEcheance">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Statut</label>
                        <select class="form-select" id="chargeStatut">
                            <option value="pending">‚è≥ En attente</option>
                            <option value="paid">‚úÖ Pay√©</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="chargeNotes" placeholder="Informations compl√©mentaires..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Pi√®ce jointe (facture)</label>
                    <div class="file-upload" onclick="document.getElementById('chargeFile').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Cliquez pour ajouter un fichier PDF ou image</p>
                        <input type="file" id="chargeFile" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload(this)">
                    </div>
                    <div class="file-list" id="chargeFileList"></div>
                </div>
            </div>
<<<<<<< HEAD
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('chargeModal')">Annuler</button>
                <button class="btn btn-primary" onclick="saveCharge()">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
=======

            <!-- Modal D√©tails Articles/Clients -->
            <div id="art-detail-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center; padding:20px;">
                <div style="background:var(--bg-card); border-radius:16px; max-width:800px; width:100%; max-height:85vh; overflow:hidden; display:flex; flex-direction:column;">
                    <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h2 id="art-detail-title" style="font-size:22px; font-weight:700; margin-bottom:4px;"></h2>
                            <p id="art-detail-subtitle" style="color:var(--text-muted); font-size:13px;"></p>
                        </div>
                        <button onclick="closeArtDetailModal()" style="width:40px; height:40px; border-radius:50%; background:var(--bg-hover); border:none; cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center;">‚úï</button>
                    </div>
                    <div id="art-detail-content" style="padding:20px; overflow-y:auto; flex:1;"></div>
                </div>
            </div>

            <!-- Modal Action Client -->
            <div id="client-action-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center; padding:20px;" onclick="if(event.target === this) closeClientActionModal()">
                <div style="background:var(--bg-card); border-radius:16px; max-width:450px; width:100%; overflow:hidden;">
                    <div style="padding:24px; border-bottom:1px solid var(--border-color); text-align:center;">
                        <div style="font-size:50px; margin-bottom:12px;">üë§</div>
                        <h2 id="client-action-name" style="font-size:24px; font-weight:700; margin-bottom:8px;"></h2>
                        <div id="client-action-info" style="margin-bottom:12px;"></div>
                        <div id="client-action-details"></div>
                    </div>
                    <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                        <button onclick="startOrderFromClient(parseInt(document.getElementById('client-action-modal').dataset.clientId))" style="width:100%; padding:16px; background:var(--accent-primary); color:#000; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition:all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform=''">
                            ‚ö° Cr√©er une commande
                        </button>
                        <button onclick="editClientFromModal()" style="width:100%; padding:14px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; font-size:14px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
                            ‚úèÔ∏è Modifier la fiche
                        </button>
                        <button onclick="closeClientActionModal()" style="width:100%; padding:12px; background:transparent; color:var(--text-muted); border:none; border-radius:10px; font-size:13px; cursor:pointer;">
                            Annuler
                        </button>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div class="module-page" id="page-reports">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">‚Üê Accueil</span></div>
                <div class="report-grid">
                    <div class="report-card">
                        <div class="report-icon" style="background: rgba(6, 214, 160, 0.15); color: var(--accent-primary);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"/>
                                <line x1="12" y1="20" x2="12" y2="4"/>
                                <line x1="6" y1="20" x2="6" y2="14"/>
                            </svg>
                        </div>
                        <div class="report-name">Rapport des ventes</div>
                        <div class="report-desc">Analyse des ventes par p√©riode, produit et client</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon" style="background: rgba(255, 209, 102, 0.15); color: var(--accent-warning);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                                <path d="M16 3.13a4 4 0 010 7.75"/>
                            </svg>
                        </div>
                        <div class="report-name">Analyse clients</div>
                        <div class="report-desc">Comportement d'achat et segmentation client√®le</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon" style="background: rgba(157, 78, 221, 0.15); color: var(--accent-purple);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="3" width="15" height="13"/>
                                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                                <circle cx="5.5" cy="18.5" r="2.5"/>
                                <circle cx="18.5" cy="18.5" r="2.5"/>
                            </svg>
                        </div>
                        <div class="report-name">Suivi livraisons</div>
                        <div class="report-desc">Performance des livraisons et d√©lais</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon" style="background: rgba(239, 71, 111, 0.15); color: var(--accent-danger);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                        </div>
                        <div class="report-name">Rapport financier</div>
                        <div class="report-desc">Chiffre d'affaires, marges et rentabilit√©</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon" style="background: rgba(255, 107, 53, 0.15); color: var(--accent-orange);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                <path d="M2 17l10 5 10-5"/>
                                <path d="M2 12l10 5 10-5"/>
                            </svg>
                        </div>
                        <div class="report-name">Nutri-Score</div>
                        <div class="report-desc">Analyse nutritionnelle des produits</div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 üë• PAGE RH - GESTION DU PERSONNEL (Admin Only)
                 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="module-page" id="page-rh" data-permission="admin">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">‚Üê Accueil</span></div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:12px;">
                    <h2 style="font-size:24px; font-weight:700; margin:0;">üë• RH Personnel</h2>
                    <div style="display:flex; gap:10px;">
                        <button onclick="openRHEmployeeModal()" class="btn btn-primary" style="padding:10px 16px;">
                            ‚ûï Ajouter employ√©
                        </button>
                        <button onclick="printRHReport()" class="btn btn-secondary" style="padding:10px 16px;">
                            üñ®Ô∏è Imprimer
                        </button>
                    </div>
                </div>

                <!-- Param√®tres RH -->
                <div style="background:linear-gradient(135deg, rgba(155,89,182,0.1), rgba(142,68,173,0.05)); border:1px solid rgba(155,89,182,0.3); border-radius:16px; padding:16px; margin-bottom:20px;">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                        <span style="font-size:20px;">‚öôÔ∏è</span>
                        <span style="font-weight:700; color:#9b59b6;">Configuration horaire</span>
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:16px;">
                        <div style="text-align:center; padding:12px; background:var(--bg-card); border-radius:10px;">
                            <div style="font-size:20px; font-weight:700; color:var(--accent-primary); font-family:'Space Mono',monospace;">8h30</div>
                            <div style="font-size:11px; color:var(--text-muted);">Par jour</div>
                        </div>
                        <div style="text-align:center; padding:12px; background:var(--bg-card); border-radius:10px;">
                            <div style="font-size:20px; font-weight:700; color:var(--accent-secondary); font-family:'Space Mono',monospace;">42.5h</div>
                            <div style="font-size:11px; color:var(--text-muted);">Par semaine</div>
                        </div>
                        <div style="text-align:center; padding:12px; background:var(--bg-card); border-radius:10px;">
                            <div style="font-size:20px; font-weight:700; color:#e74c3c; font-family:'Space Mono',monospace;">20j</div>
                            <div style="font-size:11px; color:var(--text-muted);">Vacances/an</div>
                        </div>
                        <div style="text-align:center; padding:12px; background:var(--bg-card); border-radius:10px;">
                            <div style="font-size:20px; font-weight:700; color:#f39c12; font-family:'Space Mono',monospace;">4 sem</div>
                            <div style="font-size:11px; color:var(--text-muted);">Cong√©s pay√©s</div>
                        </div>
                    </div>
                </div>

                <!-- S√©lection mois/ann√©e et employ√© -->
                <div style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
                    <select id="rh-employee-filter" onchange="renderRHCalendar()" style="padding:12px 16px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:10px; color:var(--text-primary); font-size:14px; min-width:200px;">
                        <option value="all">üë• Tous les employ√©s</option>
                    </select>
                    <select id="rh-month-select" onchange="renderRHCalendar()" style="padding:12px 16px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:10px; color:var(--text-primary); font-size:14px;">
                        <option value="0">Janvier</option>
                        <option value="1">F√©vrier</option>
                        <option value="2">Mars</option>
                        <option value="3">Avril</option>
                        <option value="4">Mai</option>
                        <option value="5">Juin</option>
                        <option value="6">Juillet</option>
                        <option value="7">Ao√ªt</option>
                        <option value="8">Septembre</option>
                        <option value="9">Octobre</option>
                        <option value="10">Novembre</option>
                        <option value="11">D√©cembre</option>
                    </select>
                    <select id="rh-year-select" onchange="renderRHCalendar()" style="padding:12px 16px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:10px; color:var(--text-primary); font-size:14px;">
                    </select>
                    <button onclick="addRHAbsence()" class="btn" style="padding:12px 20px; background:linear-gradient(135deg, #e74c3c, #c0392b); border:none; color:white; border-radius:10px; font-weight:600;">
                        üìÖ Ajouter absence
                    </button>
                </div>

                <div class="grid-2" style="gap:20px;">
                    <!-- Colonne gauche - Calendrier -->
                    <div>
                        <div class="card">
                            <div class="card-header" style="background:linear-gradient(135deg, #9b59b6, #8e44ad);">
                                <h3 class="card-title" style="color:white;">üìÖ Calendrier <span id="rh-calendar-title"></span></h3>
                            </div>
                            <div class="card-body" style="padding:12px;">
                                <!-- L√©gende -->
                                <div style="display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; font-size:11px;">
                                    <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#27ae60; border-radius:3px;"></span> Travail</span>
                                    <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#3498db; border-radius:3px;"></span> Vacances</span>
                                    <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#e74c3c; border-radius:3px;"></span> Maladie</span>
                                    <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#f39c12; border-radius:3px;"></span> Cong√©</span>
                                    <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#95a5a6; border-radius:3px;"></span> Weekend</span>
                                </div>
                                <!-- Grille calendrier -->
                                <div id="rh-calendar-grid" style="display:grid; grid-template-columns:repeat(7, 1fr); gap:4px;">
                                    <!-- G√©n√©r√© par JS -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- R√©capitulatif mensuel -->
                        <div class="card" style="margin-top:16px;">
                            <div class="card-header">
                                <h3 class="card-title">üìä R√©capitulatif mensuel</h3>
                            </div>
                            <div class="card-body">
                                <div id="rh-monthly-summary" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;">
                                    <!-- G√©n√©r√© par JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Colonne droite - Liste personnel -->
                    <div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üë• Personnel & Soldes</h3>
                            </div>
                            <div class="card-body" style="padding:0;">
                                <div id="rh-employees-list" style="max-height:500px; overflow-y:auto;">
                                    <!-- G√©n√©r√© par JS -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Absences r√©centes -->
                        <div class="card" style="margin-top:16px;">
                            <div class="card-header">
                                <h3 class="card-title">üìã Absences r√©centes</h3>
                            </div>
                            <div class="card-body" style="padding:0;">
                                <div id="rh-absences-list" style="max-height:250px; overflow-y:auto;">
                                    <!-- G√©n√©r√© par JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- D√©compte annuel -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-header" style="background:linear-gradient(135deg, #2c3e50, #34495e);">
                        <h3 class="card-title" style="color:white;">üìà D√©compte annuel <span id="rh-year-title"></span></h3>
                    </div>
                    <div class="card-body">
                        <div id="rh-annual-summary" style="overflow-x:auto;">
                            <!-- Tableau g√©n√©r√© par JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Employ√© RH -->
            <div id="rh-employee-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center; padding:20px;">
                <div style="background:var(--bg-card); border-radius:20px; width:100%; max-width:500px; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
                    <div style="padding:20px; background:linear-gradient(135deg, #9b59b6, #8e44ad); color:white; flex-shrink:0;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 id="rh-employee-modal-title" style="font-weight:700; margin:0;">‚ûï Nouvel employ√©</h3>
                            <button onclick="closeRHEmployeeModal()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">√ó</button>
                        </div>
                    </div>
                    <div style="padding:24px; overflow-y:auto; flex:1;">
                        <input type="hidden" id="rh-emp-edit-id">
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Nom complet *</label>
                            <input type="text" id="rh-emp-name" placeholder="Jean Dupont" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Date d'entr√©e</label>
                                <input type="date" id="rh-emp-start-date" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </div>
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Taux d'activit√© %</label>
                                <input type="number" id="rh-emp-rate" value="100" min="10" max="100" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Vacances/an (jours)</label>
                                <input type="number" id="rh-emp-vacation-days" value="20" min="0" max="30" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </div>
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Solde vacances actuel</label>
                                <input type="number" id="rh-emp-vacation-balance" value="20" step="0.5" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </div>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Poste / Fonction</label>
                            <input type="text" id="rh-emp-position" placeholder="Vendeur, Manager..." style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                <input type="checkbox" id="rh-emp-active" checked style="width:20px; height:20px; accent-color:var(--accent-primary);">
                                <span>Employ√© actif</span>
                            </label>
                        </div>
                        <button onclick="saveRHEmployee()" class="btn btn-primary" style="width:100%; padding:14px; font-weight:700;">
                            üíæ Enregistrer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal Absence RH -->
            <div id="rh-absence-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center; padding:20px;">
                <div style="background:var(--bg-card); border-radius:20px; width:100%; max-width:450px; overflow:hidden;">
                    <div style="padding:20px; background:linear-gradient(135deg, #e74c3c, #c0392b); color:white;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="font-weight:700; margin:0;">üìÖ Ajouter une absence</h3>
                            <button onclick="closeRHAbsenceModal()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">√ó</button>
                        </div>
                    </div>
                    <div style="padding:24px;">
                        <input type="hidden" id="rh-absence-edit-id">
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Employ√© *</label>
                            <select id="rh-absence-employee" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </select>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Type d'absence *</label>
                            <select id="rh-absence-type" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                                <option value="vacation">üèñÔ∏è Vacances</option>
                                <option value="sick">ü§í Maladie</option>
                                <option value="leave">üìã Cong√© (autre)</option>
                                <option value="unpaid">üí∏ Sans solde</option>
                            </select>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Date d√©but *</label>
                                <input type="date" id="rh-absence-start" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </div>
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Date fin *</label>
                                <input type="date" id="rh-absence-end" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </div>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Remarque</label>
                            <textarea id="rh-absence-note" rows="2" placeholder="Optionnel..." style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary); resize:none;"></textarea>
                        </div>
                        <button onclick="saveRHAbsence()" class="btn btn-primary" style="width:100%; padding:14px; font-weight:700; background:linear-gradient(135deg, #e74c3c, #c0392b);">
                            üíæ Enregistrer l'absence
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="module-page" id="page-settings">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">‚Üê Accueil</span></div>

                <h2 style="font-size:24px; font-weight:700; margin-bottom:20px;">‚öôÔ∏è Param√®tres</h2>

                <div class="grid-2">
                    <!-- Colonne gauche -->
                    <div>
                        <!-- Pr√©f√©rences g√©n√©rales -->
                        <div class="card" style="margin-bottom:20px;">
                            <div class="card-header">
                                <h3 class="card-title">üé® Pr√©f√©rences g√©n√©rales</h3>
                            </div>
                            <div class="card-body">
                                <div class="settings-section">
                                    <div class="setting-row">
                                        <div class="setting-info">
                                            <h4>Mode sombre</h4>
                                            <p>Activer le th√®me sombre de l'interface</p>
                                        </div>
                                        <div class="toggle active" id="darkModeToggle"></div>
                                    </div>
                                    <div class="setting-row">
                                        <div class="setting-info">
                                            <h4>Notifications</h4>
                                            <p>Recevoir des alertes pour les nouvelles commandes</p>
                                        </div>
                                        <div class="toggle active"></div>
                                    </div>
                                    <div class="setting-row">
                                        <div class="setting-info">
                                            <h4>Sons</h4>
                                            <p>Activer les sons de notification</p>
                                        </div>
                                        <div class="toggle"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Param√®tres du compte -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üè¢ Param√®tres entreprise</h3>
                            </div>
                            <div class="card-body">
                                <div class="settings-form">
                                    <div class="form-group">
                                        <label>Nom de l'entreprise</label>
                                        <input type="text" id="settings-company" value="La Traversette" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary);">
                                    </div>
                                    <div class="form-group">
                                        <label>Email</label>
                                        <input type="email" id="settings-email" value="contact@traversette.ch" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary);">
                                    </div>
                                    <div class="form-group">
                                        <label>T√©l√©phone</label>
                                        <input type="tel" id="settings-phone" value="+41 21 XXX XX XX" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary);">
                                    </div>
                                    <div class="form-group">
                                        <label>Devise</label>
                                        <select id="settings-currency" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary);">
                                            <option value="CHF" selected>CHF (Fr.)</option>
                                            <option value="EUR">EUR (‚Ç¨)</option>
                                            <option value="USD">USD ($)</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" onclick="saveCompanySettings()" style="width:100%;">üíæ Enregistrer</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Colonne droite - Dropbox -->
                    <div>
                        <div class="card" style="border:2px solid var(--accent-secondary);" data-permission="settings:dropbox">
                            <div class="card-header" style="background:var(--accent-secondary)15;">
                                <h3 class="card-title" style="display:flex; align-items:center; gap:10px;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="color:var(--accent-secondary);">
                                        <path d="M12 2L6 6l6 4-6 4 6 4 6-4-6-4 6-4-6-4zm0 8.5L6 14.5l6 4 6-4-6-4z"/>
                                    </svg>
                                    Dropbox - Sauvegarde Cloud
                                </h3>
                            </div>
                            <div class="card-body">
                                <!-- Status connexion -->
                                <div id="dropbox-status" style="padding:12px 16px; border-radius:10px; margin-bottom:16px; display:flex; align-items:center; gap:10px; background:var(--bg-primary);">
                                    <span id="dropbox-status-icon" style="font-size:20px;">‚ö™</span>
                                    <div style="flex:1;">
                                        <div id="dropbox-status-text" style="font-weight:600;">Non connect√©</div>
                                        <div id="dropbox-status-detail" style="font-size:12px; color:var(--text-muted);">Cliquez sur "Se connecter" pour lier votre compte</div>
                                    </div>
                                    <button id="dropbox-disconnect-btn" onclick="disconnectDropbox()" style="display:none; padding:6px 12px; background:var(--accent-danger); color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:12px;">
                                        D√©connecter
                                    </button>
                                </div>

                                <!-- Bouton OAuth -->
                                <div id="dropbox-auth-section" style="margin-bottom:16px;">
                                    <button onclick="startDropboxOAuth()" class="btn" style="width:100%; padding:16px; background:linear-gradient(135deg, #0061FF, #0D2481); color:#fff; border:none; font-weight:700; border-radius:10px; font-size:15px; display:flex; align-items:center; justify-content:center; gap:10px;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L6 6l6 4-6 4 6 4 6-4-6-4 6-4-6-4z"/></svg>
                                        Se connecter √† Dropbox
                                    </button>
                                    <div style="font-size:11px; color:var(--text-muted); text-align:center; margin-top:8px;">
                                        üîí Connexion s√©curis√©e OAuth 2.0 - Token automatiquement renouvel√©
                                    </div>
                                </div>

                                <!-- Token manuel (cach√© par d√©faut, pour debug) -->
                                <details style="margin-bottom:16px;">
                                    <summary style="cursor:pointer; font-size:12px; color:var(--text-muted);">‚öôÔ∏è Configuration avanc√©e (token manuel)</summary>
                                    <div style="padding:12px; margin-top:8px; background:var(--bg-primary); border-radius:8px;">
                                        <input type="password" id="dropbox-token" placeholder="sl.xxxxxxxxxxxxxxx..."
                                            style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--border-color); background:var(--bg-card); color:var(--text-primary); font-family:monospace; font-size:12px; margin-bottom:8px;">
                                        <button onclick="saveManualToken()" class="btn btn-secondary" style="width:100%; padding:8px; font-size:12px;">
                                            Sauvegarder token manuel
                                        </button>
                                    </div>
                                </details>

                                <!-- Chemin de base -->
                                <div class="form-group" style="margin-bottom:16px;">
                                    <label style="margin-bottom:8px; display:block;">üìÅ Chemin de base dans Dropbox</label>
                                    <input type="text" id="dropbox-base-path" value="/TRAKIO" placeholder="/TRAKIO"
                                        style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary);">
                                </div>

                                <!-- Toggle synchronisation -->
                                <div class="setting-row" style="padding:12px 0; border-top:1px solid var(--border-color); border-bottom:1px solid var(--border-color); margin-bottom:16px;">
                                    <div class="setting-info">
                                        <h4>Synchronisation automatique</h4>
                                        <p>Sync toutes les 5 min. pour travail multi-utilisateurs</p>
                                    </div>
                                    <div class="toggle" id="dropbox-auto-sync"></div>
                                </div>

                                <!-- Info multi-utilisateurs -->
                                <div style="padding:14px; background:linear-gradient(135deg, var(--accent-primary)15, var(--accent-secondary)10); border-radius:10px; margin-bottom:16px; border-left:4px solid var(--accent-primary);">
                                    <div style="font-weight:700; color:var(--accent-primary); margin-bottom:6px;">üë• Mode Multi-Utilisateurs</div>
                                    <div style="font-size:12px; color:var(--text-secondary); line-height:1.6;">
                                        Activez la sync automatique pour permettre √† plusieurs personnes de travailler simultan√©ment sur diff√©rents appareils.<br>
                                        Les donn√©es sont synchronis√©es toutes les 5 minutes.
                                    </div>
                                </div>

                                <!-- Boutons actions -->
                                <div style="display:flex; flex-direction:column; gap:10px;">
                                    <button onclick="testDropboxConnection()" class="btn btn-secondary" style="width:100%; padding:12px; display:flex; align-items:center; justify-content:center; gap:8px;">
                                        üîó Tester la connexion
                                    </button>
                                    <button onclick="createDropboxFolders()" class="btn btn-secondary" style="width:100%; padding:12px; display:flex; align-items:center; justify-content:center; gap:8px;">
                                        üìÇ Cr√©er les dossiers
                                    </button>
                                    <button onclick="saveDropboxSettings()" class="btn btn-primary" style="width:100%; padding:14px; font-weight:700;">
                                        üíæ Enregistrer la configuration
                                    </button>
                                    <div style="border-top:1px solid var(--border-color); padding-top:12px; margin-top:6px;">
                                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                            <button onclick="syncFromDropbox(false)" class="btn" style="padding:12px; background:var(--accent-secondary); color:#fff; border:none; font-weight:600; border-radius:10px;">
                                                üì• R√©cup√©rer
                                            </button>
                                            <button onclick="syncAllToDropbox()" class="btn" style="padding:12px; background:var(--accent-primary); color:#000; border:none; font-weight:600; border-radius:10px;">
                                                üì§ Envoyer
                                            </button>
                                        </div>
                                        <button onclick="forceSyncNow()" class="btn" style="width:100%; padding:14px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color:#000; border:none; font-weight:700; border-radius:10px; margin-top:10px;">
                                            üîÑ Synchronisation compl√®te
                                        </button>
                                        <div style="font-size:11px; color:var(--text-muted); text-align:center; margin-top:6px;">
                                            T√©l√©charge puis envoie toutes les donn√©es
                                        </div>
                                    </div>
                                </div>

                                <!-- Structure des dossiers -->
                                <div style="margin-top:20px; padding:16px; background:var(--bg-primary); border-radius:10px;">
                                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:10px; text-transform:uppercase;">Structure des dossiers</div>
                                    <div style="font-family:monospace; font-size:13px; line-height:1.8; color:var(--text-secondary);">
                                        <div>üìÅ <span id="dropbox-path-display">/TRAKIO</span></div>
                                        <div style="padding-left:20px;">‚îú‚îÄ‚îÄ üìÅ Commandes</div>
                                        <div style="padding-left:40px;">‚îî‚îÄ‚îÄ üìÅ <span style="color:var(--text-muted);">YYYY-MM</span></div>
                                        <div style="padding-left:20px;">‚îú‚îÄ‚îÄ üìÅ Clients</div>
                                        <div style="padding-left:20px;">‚îú‚îÄ‚îÄ üìÅ Articles</div>
                                        <div style="padding-left:20px;">‚îú‚îÄ‚îÄ üìÅ Factures</div>
                                        <div style="padding-left:20px;">‚îú‚îÄ‚îÄ üìÅ Rapports</div>
                                        <div style="padding-left:20px;">‚îî‚îÄ‚îÄ üìÅ System <span style="font-size:11px; color:var(--accent-primary);">(sync multi-users)</span></div>
                                        <div style="padding-left:40px;">‚îî‚îÄ‚îÄ üìÅ <span style="color:var(--accent-warning);">Backups</span> <span style="font-size:11px; color:var(--accent-warning);">(sauvegardes compl√®tes)</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gestion des utilisateurs -->
                        <div class="card" style="margin-top:20px;" id="users-management-card">
                            <div class="card-header">
                                <h3 class="card-title">üë• Gestion des Utilisateurs</h3>
                            </div>
                            <div class="card-body">
                                <!-- Bouton Ajouter bien visible -->
                                <button onclick="showAddUserModal()" class="btn btn-primary" style="width:100%; padding:14px; margin-bottom:20px; font-size:15px; font-weight:600;">
                                    ‚ûï Ajouter un utilisateur
                                </button>

                                <!-- R√¥les expliqu√©s -->
                                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:20px;">
                                    <div style="padding:14px; background:var(--accent-danger)10; border:2px solid var(--accent-danger); border-radius:10px; text-align:center;">
                                        <div style="font-size:24px; margin-bottom:6px;">üëë</div>
                                        <div style="font-weight:700; color:var(--accent-danger);">Admin</div>
                                        <div style="font-size:11px; color:var(--text-muted); margin-top:4px;">Acc√®s complet √† tout</div>
                                    </div>
                                    <div style="padding:14px; background:var(--accent-warning)10; border:2px solid var(--accent-warning); border-radius:10px; text-align:center;">
                                        <div style="font-size:24px; margin-bottom:6px;">‚≠ê</div>
                                        <div style="font-weight:700; color:var(--accent-warning);">Super-User</div>
                                        <div style="font-size:11px; color:var(--text-muted); margin-top:4px;">Modules + certains param.</div>
                                    </div>
                                    <div style="padding:14px; background:var(--accent-primary)10; border:2px solid var(--accent-primary); border-radius:10px; text-align:center;">
                                        <div style="font-size:24px; margin-bottom:6px;">üë§</div>
                                        <div style="font-weight:700; color:var(--accent-primary);">User</div>
                                        <div style="font-size:11px; color:var(--text-muted); margin-top:4px;">Modules autoris√©s uniquement</div>
                                    </div>
                                </div>

                                <!-- Liste des utilisateurs -->
                                <div id="users-list" style="display:flex; flex-direction:column; gap:10px;">
                                    <!-- G√©n√©r√© par JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Num√©rotation et Pr√©fixes -->
                        <div class="card" style="margin-top:20px; border:2px solid var(--accent-orange);" data-permission="settings:numbering">
                            <div class="card-header">
                                <h3 class="card-title">üî¢ Num√©rotation & Pr√©fixes</h3>
                            </div>
                            <div class="card-body">
                                <p style="color:var(--text-muted); margin-bottom:20px; font-size:13px;">
                                    Configurez les pr√©fixes et tranches de num√©ros pour chaque type d'√©l√©ment.
                                </p>

                                <!-- Commandes -->
                                <div style="background:var(--bg-primary); border-radius:10px; padding:16px; margin-bottom:16px; border-left:4px solid var(--accent-primary);">
                                    <div style="font-weight:700; color:var(--accent-primary); margin-bottom:12px;">üìã Commandes</div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Pr√©fixe</label>
                                            <input type="text" id="num-order-prefix" value="CMD" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">D√©but tranche</label>
                                            <input type="number" id="num-order-start" value="1" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Prochain N¬∞</label>
                                            <input type="number" id="num-order-next" value="1" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-weight:700; color:var(--accent-primary);">
                                        </div>
                                    </div>
                                    <div style="margin-top:8px; font-size:11px; color:var(--text-muted);">
                                        Format: <span id="num-order-preview" style="font-family:'Space Mono',monospace; color:var(--accent-primary);">CMD-20241128-001</span>
                                    </div>
                                </div>

                                <!-- Clients -->
                                <div style="background:var(--bg-primary); border-radius:10px; padding:16px; margin-bottom:16px; border-left:4px solid var(--accent-secondary);">
                                    <div style="font-weight:700; color:var(--accent-secondary); margin-bottom:12px;">üë• Clients</div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Pr√©fixe</label>
                                            <input type="text" id="num-client-prefix" value="CLI" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">D√©but tranche</label>
                                            <input type="number" id="num-client-start" value="1000" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Prochain N¬∞</label>
                                            <input type="number" id="num-client-next" value="1000" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-weight:700; color:var(--accent-secondary);">
                                        </div>
                                    </div>
                                    <div style="margin-top:8px; font-size:11px; color:var(--text-muted);">
                                        Format: <span id="num-client-preview" style="font-family:'Space Mono',monospace; color:var(--accent-secondary);">CLI-1000</span>
                                    </div>
                                </div>

                                <!-- Articles -->
                                <div style="background:var(--bg-primary); border-radius:10px; padding:16px; margin-bottom:16px; border-left:4px solid var(--accent-warning);">
                                    <div style="font-weight:700; color:var(--accent-warning); margin-bottom:12px;">üì¶ Articles</div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Pr√©fixe</label>
                                            <input type="text" id="num-article-prefix" value="ART" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">D√©but tranche</label>
                                            <input type="number" id="num-article-start" value="100" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Prochain N¬∞</label>
                                            <input type="number" id="num-article-next" value="100" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-weight:700; color:var(--accent-warning);">
                                        </div>
                                    </div>
                                    <div style="margin-top:8px; font-size:11px; color:var(--text-muted);">
                                        Format: <span id="num-article-preview" style="font-family:'Space Mono',monospace; color:var(--accent-warning);">ART-100</span>
                                    </div>
                                </div>

                                <!-- Options -->
                                <div style="background:var(--bg-primary); border-radius:10px; padding:16px; margin-bottom:16px;">
                                    <div style="font-weight:700; color:var(--text-primary); margin-bottom:12px;">‚öôÔ∏è Options</div>
                                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin-bottom:8px;">
                                        <input type="checkbox" id="num-include-date" checked style="width:18px; height:18px; accent-color:var(--accent-primary);">
                                        <span>Inclure la date dans les num√©ros de commande (YYYYMMDD)</span>
                                    </label>
                                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                        <input type="checkbox" id="num-zero-padding" checked style="width:18px; height:18px; accent-color:var(--accent-primary);">
                                        <span>Ajouter des z√©ros devant (ex: 001, 002...)</span>
                                    </label>
                                </div>

                                <button onclick="saveNumberingConfig()" class="btn btn-primary" style="width:100%; padding:14px;">
                                    üíæ Enregistrer la configuration
                                </button>
                            </div>
                        </div>

                        <!-- Donn√©es locales -->
                        <div class="card" style="margin-top:20px;">
                            <div class="card-header">
                                <h3 class="card-title">üíæ Donn√©es locales</h3>
                            </div>
                            <div class="card-body">
                                <!-- Note importante sur la persistance -->
                                <div style="padding:14px; background:linear-gradient(135deg, var(--accent-primary)15, var(--accent-secondary)10); border-radius:10px; margin-bottom:16px; border-left:4px solid var(--accent-primary);">
                                    <div style="font-weight:700; color:var(--accent-primary); margin-bottom:6px;">üìå Vos donn√©es sont sauvegard√©es automatiquement</div>
                                    <div style="font-size:12px; color:var(--text-secondary); line-height:1.6;">
                                        Les clients, articles et commandes sont stock√©s dans le navigateur (localStorage).<br>
                                        <strong>Ils ne seront jamais effac√©s</strong> lors des mises √† jour de TRAKIO.<br>
                                        Pour une sauvegarde externe, utilisez Dropbox ou exportez en JSON ci-dessous.
                                    </div>
                                </div>

                                <div style="display:flex; flex-direction:column; gap:10px;">
                                    <button onclick="exportAllData()" class="btn btn-secondary" style="width:100%; padding:12px;" data-permission="settings:export-data">
                                        üì§ Exporter toutes les donn√©es (JSON)
                                    </button>
                                    <button onclick="document.getElementById('import-data-file').click()" class="btn btn-secondary" style="width:100%; padding:12px;" data-permission="settings:import-data">
                                        üì• Importer des donn√©es
                                    </button>
                                    <input type="file" id="import-data-file" accept=".json" onchange="importAllData(this)" style="display:none;">
                                    <button onclick="clearAllData()" class="btn btn-secondary" style="width:100%; padding:12px; color:var(--accent-danger);" data-permission="settings:reset-data">
                                        üóëÔ∏è R√©initialiser toutes les donn√©es
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- MISE √Ä JOUR TRAKIO - Admin uniquement -->
                        <div class="card" style="margin-top:20px; border:2px solid var(--accent-warning);" data-permission="admin">
                            <div class="card-header" style="background:linear-gradient(135deg, var(--accent-warning), var(--accent-orange));">
                                <h3 class="card-title" style="color:#000;">üîÑ Mise √† jour TRAKIO</h3>
                            </div>
                            <div class="card-body">
                                <!-- Avertissement -->
                                <div style="padding:14px; background:linear-gradient(135deg, var(--accent-warning)20, var(--accent-orange)10); border-radius:10px; margin-bottom:16px; border-left:4px solid var(--accent-warning);">
                                    <div style="font-weight:700; color:var(--accent-warning); margin-bottom:6px;">‚ö†Ô∏è Proc√©dure de mise √† jour</div>
                                    <div style="font-size:12px; color:var(--text-secondary); line-height:1.8;">
                                        <strong>1.</strong> Cliquez sur "Cr√©er une sauvegarde" ci-dessous<br>
                                        <strong>2.</strong> T√©l√©chargez la nouvelle version de TRAKIO<br>
                                        <strong>3.</strong> Remplacez l'ancien fichier par le nouveau<br>
                                        <strong>4.</strong> Rafra√Æchissez la page - vos donn√©es sont conserv√©es !<br>
                                        <strong>5.</strong> Si probl√®me, restaurez depuis la sauvegarde
                                    </div>
                                </div>

                                <!-- Version actuelle -->
                                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:var(--bg-primary); border-radius:10px; margin-bottom:16px;">
                                    <div>
                                        <div style="font-size:12px; color:var(--text-muted);">Version install√©e</div>
                                        <div style="font-weight:700; font-family:'Space Mono',monospace; color:var(--accent-primary);" id="trakio-version">v3.2.2</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-size:12px; color:var(--text-muted);">Derni√®re mise √† jour</div>
                                        <div style="font-weight:600;" id="trakio-update-date">-</div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div style="display:flex; flex-direction:column; gap:10px;">
                                    <button onclick="createTrakioBackup()" class="btn" style="width:100%; padding:14px; background:var(--accent-primary); color:#000; border:none; font-weight:700; border-radius:10px;">
                                        üíæ Cr√©er une sauvegarde compl√®te
                                    </button>
                                    <button onclick="document.getElementById('restore-backup-file').click()" class="btn btn-secondary" style="width:100%; padding:12px;">
                                        üì• Restaurer depuis une sauvegarde
                                    </button>
                                    <input type="file" id="restore-backup-file" accept=".json" onchange="restoreTrakioBackup(this)" style="display:none;">
                                    
                                    <!-- Publier une mise √† jour -->
                                    <div style="border-top:1px solid var(--border-color); margin-top:10px; padding-top:16px;">
                                        <div style="font-size:12px; color:var(--text-muted); margin-bottom:10px;">üì¢ Publier une mise √† jour (notifie tous les utilisateurs)</div>
                                        <button onclick="showPublishUpdateModal()" class="btn" style="width:100%; padding:14px; background:linear-gradient(135deg, #e74c3c, #c0392b); color:#fff; border:none; font-weight:700; border-radius:10px;">
                                            üöÄ Publier cette version aux utilisateurs
                                        </button>
                                    </div>
                                </div>

                                <!-- Historique des sauvegardes -->
                                <div style="margin-top:16px; padding:12px; background:var(--bg-primary); border-radius:10px;">
                                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:8px;">üìã Derni√®res sauvegardes</div>
                                    <div id="backup-history" style="font-size:12px; color:var(--text-secondary);">
                                        Aucune sauvegarde r√©cente
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- HISTORIQUE DES CONNEXIONS - Admin uniquement -->
                        <div class="card" style="margin-top:20px; border:2px solid #9c88ff;" data-permission="admin">
                            <div class="card-header" style="background:linear-gradient(135deg, #9c88ff, #7158e2);">
                                <h3 class="card-title" style="color:#fff;">üîê Historique des connexions</h3>
                            </div>
                            <div class="card-body">
                                <!-- Stats rapides -->
                                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-bottom:16px;">
                                    <div style="text-align:center; padding:12px; background:rgba(6,214,160,0.15); border-radius:10px;">
                                        <div id="log-count-login" style="font-size:20px; font-weight:700; color:var(--accent-primary);">0</div>
                                        <div style="font-size:10px; color:var(--text-muted);">Connexions</div>
                                    </div>
                                    <div style="text-align:center; padding:12px; background:rgba(17,138,178,0.15); border-radius:10px;">
                                        <div id="log-count-logout" style="font-size:20px; font-weight:700; color:#118ab2;">0</div>
                                        <div style="font-size:10px; color:var(--text-muted);">D√©connexions</div>
                                    </div>
                                    <div style="text-align:center; padding:12px; background:rgba(255,183,77,0.15); border-radius:10px;">
                                        <div id="log-count-auto" style="font-size:20px; font-weight:700; color:#ffb74d;">0</div>
                                        <div style="font-size:10px; color:var(--text-muted);">Auto (1h)</div>
                                    </div>
                                    <div style="text-align:center; padding:12px; background:rgba(255,107,107,0.15); border-radius:10px;">
                                        <div id="log-count-failed" style="font-size:20px; font-weight:700; color:#ff6b6b;">0</div>
                                        <div style="font-size:10px; color:var(--text-muted);">√âchecs</div>
                                    </div>
                                </div>
                                
                                <!-- Liste des connexions -->
                                <div style="max-height:300px; overflow-y:auto; border:1px solid var(--border-color); border-radius:10px;">
                                    <table style="width:100%; border-collapse:collapse; font-size:12px;">
                                        <thead style="background:var(--bg-primary); position:sticky; top:0;">
                                            <tr>
                                                <th style="padding:10px; text-align:left; font-weight:600;">Utilisateur</th>
                                                <th style="padding:10px; text-align:center; font-weight:600;">Action</th>
                                                <th style="padding:10px; text-align:center; font-weight:600;">Date</th>
                                                <th style="padding:10px; text-align:center; font-weight:600;">Heure</th>
                                            </tr>
                                        </thead>
                                        <tbody id="connection-logs-tbody">
                                            <!-- G√©n√©r√© par JS -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Actions -->
                                <div style="margin-top:12px; display:flex; gap:10px;">
                                    <button onclick="refreshConnectionLogs()" class="btn btn-secondary" style="flex:1; padding:10px; font-size:12px;">
                                        üîÑ Rafra√Æchir
                                    </button>
                                    <button onclick="exportConnectionLogs()" class="btn btn-secondary" style="flex:1; padding:10px; font-size:12px;">
                                        üì§ Exporter
                                    </button>
                                    <button onclick="clearConnectionLogs()" class="btn btn-secondary" style="flex:1; padding:10px; font-size:12px; color:#ff6b6b;">
                                        üóëÔ∏è Vider
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Ajout/Modification Utilisateur -->
    <div id="user-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:2000; display:none; align-items:center; justify-content:center;">
        <div style="background:var(--bg-card); border-radius:20px; width:90%; max-width:500px; max-height:90vh; display:flex; flex-direction:column; overflow:hidden;">
            <!-- Header fixe -->
            <div style="padding:20px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color:#000; flex-shrink:0;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 id="user-modal-title" style="font-weight:700;">‚ûï Nouvel Utilisateur</h3>
                    <button onclick="closeUserModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">√ó</button>
                </div>
            </div>

            <!-- Contenu scrollable -->
            <div style="padding:24px; overflow-y:auto; flex:1;">
                <input type="hidden" id="user-edit-id">

                <div style="margin-bottom:16px;">
                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Nom complet *</label>
                    <input type="text" id="user-name" placeholder="Pascal Dupont" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                </div>

                <div style="display:flex; gap:16px; margin-bottom:16px;">
                    <div>
                        <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Initiales</label>
                        <input type="text" id="user-initials" placeholder="PD" maxlength="3" style="width:80px; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary); text-transform:uppercase; text-align:center; font-weight:700;">
                    </div>
                    <div>
                        <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Code PIN *</label>
                        <input type="password" id="user-pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" style="width:100px; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary); text-align:center; font-size:18px; letter-spacing:6px;">
                    </div>
                </div>

                <div style="margin-bottom:16px;">
                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">R√¥le *</label>
                    <select id="user-role" onchange="updatePermissionsVisibility()" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                        <option value="user">üë§ User - Acc√®s limit√©</option>
                        <option value="superuser">‚≠ê Super-User - Acc√®s √©tendu</option>
                        <option value="admin">üëë Admin - Acc√®s complet</option>
                    </select>
                </div>

                <!-- Permissions dynamiques pour User et Super-User -->
                <div id="user-permissions-section" style="padding:16px; background:var(--bg-primary); border-radius:10px;">
                    <!-- Boutons rapides -->
                    <div style="display:flex; gap:8px; margin-bottom:12px;">
                        <button type="button" onclick="toggleAllPermissions(true)" style="flex:1; padding:8px; background:var(--accent-primary); color:#000; border:none; border-radius:6px; cursor:pointer; font-size:12px;">‚úÖ Tout cocher</button>
                        <button type="button" onclick="toggleAllPermissions(false)" style="flex:1; padding:8px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; font-size:12px;">‚¨ú Tout d√©cocher</button>
                    </div>

                    <!-- Modules -->
                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:13px; font-weight:600; color:var(--accent-primary); margin-bottom:10px;">üì± Modules</label>
                        <div id="permissions-modules" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <!-- G√©n√©r√© dynamiquement -->
                        </div>
                    </div>

                    <!-- Actions/Fonctionnalit√©s -->
                    <div style="margin-bottom:16px; padding-top:16px; border-top:1px solid var(--border-color);">
                        <label style="display:block; font-size:13px; font-weight:600; color:var(--accent-warning); margin-bottom:10px;">‚öôÔ∏è Actions</label>
                        <div id="permissions-actions" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <!-- G√©n√©r√© dynamiquement -->
                        </div>
                    </div>

                    <!-- Param√®tres sensibles (Super-User uniquement) -->
                    <div id="superuser-settings" style="padding-top:16px; border-top:1px solid var(--border-color); display:none;">
                        <label style="display:block; font-size:13px; font-weight:600; color:var(--accent-danger); margin-bottom:10px;">üîí Param√®tres sensibles</label>
                        <div id="permissions-settings" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <!-- G√©n√©r√© dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer fixe avec boutons -->
            <div style="padding:16px 24px; background:var(--bg-card); border-top:1px solid var(--border-color); display:flex; gap:12px; flex-shrink:0;">
                <button onclick="saveUser()" class="btn btn-primary" style="flex:1; padding:14px; font-weight:600;">üíæ Enregistrer</button>
                <button onclick="closeUserModal()" class="btn btn-secondary" style="padding:14px;">Annuler</button>
>>>>>>> parent of 327a79d (Update index.html)
            </div>
        </div>
    </div>

    <!-- Modal: Nouveau Poste -->
    <div class="modal-overlay" id="posteModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-folder-plus"></i>
                    <span id="posteModalTitle">Nouveau poste</span>
                </h3>
                <button class="modal-close" onclick="closeModal('posteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="posteId">
                <div class="form-group">
                    <label class="form-label">Nom du poste <span class="required">*</span></label>
                    <input type="text" class="form-input" id="posteNom" placeholder="Ex: Assurances">
                </div>
                <div class="form-group">
                    <label class="form-label">Ic√¥ne</label>
                    <select class="form-select" id="posteIcon">
                        <option value="fa-home">üè† Immobilier</option>
                        <option value="fa-car">üöó V√©hicule</option>
                        <option value="fa-shield-alt">üõ°Ô∏è Assurance</option>
                        <option value="fa-users">üë• Personnel</option>
                        <option value="fa-phone">üì± T√©l√©com</option>
                        <option value="fa-bolt">‚ö° √ânergie</option>
                        <option value="fa-tools">üîß Entretien</option>
                        <option value="fa-box">üì¶ Marchandise</option>
                        <option value="fa-file-invoice">üìÑ Administratif</option>
                        <option value="fa-ellipsis-h">‚ãØ Divers</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Couleur</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <label style="cursor: pointer;"><input type="radio" name="posteColor" value="blue" checked style="display:none;"><span class="category-tag color-blue" style="padding: 0.5rem 1rem;">Bleu</span></label>
                        <label style="cursor: pointer;"><input type="radio" name="posteColor" value="green" style="display:none;"><span class="category-tag color-green" style="padding: 0.5rem 1rem;">Vert</span></label>
                        <label style="cursor: pointer;"><input type="radio" name="posteColor" value="yellow" style="display:none;"><span class="category-tag color-yellow" style="padding: 0.5rem 1rem;">Jaune</span></label>
                        <label style="cursor: pointer;"><input type="radio" name="posteColor" value="red" style="display:none;"><span class="category-tag color-red" style="padding: 0.5rem 1rem;">Rouge</span></label>
                        <label style="cursor: pointer;"><input type="radio" name="posteColor" value="purple" style="display:none;"><span class="category-tag color-purple" style="padding: 0.5rem 1rem;">Violet</span></label>
                        <label style="cursor: pointer;"><input type="radio" name="posteColor" value="teal" style="display:none;"><span class="category-tag color-teal" style="padding: 0.5rem 1rem;">Turquoise</span></label>
                        <label style="cursor: pointer;"><input type="radio" name="posteColor" value="orange" style="display:none;"><span class="category-tag color-orange" style="padding: 0.5rem 1rem;">Orange</span></label>
                        <label style="cursor: pointer;"><input type="radio" name="posteColor" value="pink" style="display:none;"><span class="category-tag color-pink" style="padding: 0.5rem 1rem;">Rose</span></label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Budget mensuel pr√©visionnel</label>
                    <input type="number" step="0.01" class="form-input" id="posteBudget" placeholder="0.00">
                    <p class="form-hint">Laissez vide si pas de budget d√©fini</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('posteModal')">Annuler</button>
                <button class="btn btn-primary" onclick="savePoste()">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Nouveau Fournisseur -->
    <div class="modal-overlay" id="fournisseurModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-building"></i>
                    <span id="fournisseurModalTitle">Nouveau fournisseur</span>
                </h3>
                <button class="modal-close" onclick="closeModal('fournisseurModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="fournisseurId">
                <div class="form-group">
                    <label class="form-label">Nom <span class="required">*</span></label>
                    <input type="text" class="form-input" id="fournisseurNom" placeholder="Nom de l'entreprise">
                </div>
                <div class="form-group">
                    <label class="form-label">Cat√©gorie</label>
                    <select class="form-select" id="fournisseurCategorie">
                        <option value="">S√©lectionner...</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Contact</label>
                        <input type="text" class="form-input" id="fournisseurContact" placeholder="Nom du contact">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="fournisseurEmail" placeholder="email@exemple.ch">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">T√©l√©phone</label>
                        <input type="tel" class="form-input" id="fournisseurTel" placeholder="+41 XX XXX XX XX">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Conditions de paiement</label>
                        <select class="form-select" id="fournisseurConditions">
                            <option value="immediate">Imm√©diat</option>
                            <option value="10">10 jours</option>
                            <option value="30" selected>30 jours</option>
                            <option value="60">60 jours</option>
                            <option value="90">90 jours</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Adresse</label>
                    <textarea class="form-textarea" id="fournisseurAdresse" placeholder="Adresse compl√®te"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="fournisseurNotes" placeholder="Informations compl√©mentaires..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('fournisseurModal')">Annuler</button>
                <button class="btn btn-primary" onclick="saveFournisseur()">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ============================================
        // TRAKIO COMPTA - Module Gestion des Charges
        // Version 1.0.0
        // ============================================

        // Configuration
        const CONFIG = {
            ADMIN_PIN: '1234', // √Ä changer !
            DROPBOX_PATH: '/TRAKIO/Compta/',
            SYNC_INTERVAL: 5 * 60 * 1000, // 5 minutes
            VERSION: '1.0.0'
        };

        // √âtat global
        let state = {
            charges: [],
            postes: [],
            fournisseurs: [],
            budgets: {},
            isAuthenticated: false,
            lastSync: null
        };

        // Charts
        let evolutionChart = null;
        let repartitionChart = null;
        let comparaisonChart = null;

        // ============================================
        // INITIALISATION
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            initPinInputs();
            loadFromLocalStorage();
            
            // Si d√©j√† authentifi√© (session)
            if (sessionStorage.getItem('compta_auth') === 'true') {
                showApp();
            }
        });

        function initPinInputs() {
            const inputs = document.querySelectorAll('.pin-input');
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1) {
                        if (index < inputs.length - 1) {
                            inputs[index + 1].focus();
                        }
                    }
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                    if (e.key === 'Enter') {
                        verifyPin();
                    }
                });
            });
            inputs[0].focus();
        }

        function verifyPin() {
            const inputs = document.querySelectorAll('.pin-input');
            const pin = Array.from(inputs).map(i => i.value).join('');
            
            if (pin === CONFIG.ADMIN_PIN) {
                sessionStorage.setItem('compta_auth', 'true');
                showApp();
            } else {
                document.getElementById('loginError').classList.add('show');
                inputs.forEach(i => {
                    i.value = '';
                    i.style.borderColor = 'var(--danger)';
                });
                inputs[0].focus();
                setTimeout(() => {
                    inputs.forEach(i => i.style.borderColor = '');
                    document.getElementById('loginError').classList.remove('show');
                }, 2000);
            }
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            state.isAuthenticated = true;
            initApp();
        }

        function initApp() {
            initTabs();
            initDefaultPostes();
            renderAll();
            initCharts();
            startSync();
        }

        // ============================================
        // NAVIGATION
        // ============================================

        function initTabs() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`tab-${tabId}`).classList.add('active');
                    
                    // Refresh charts si n√©cessaire
                    if (tabId === 'dashboard') {
                        updateCharts();
                    } else if (tabId === 'analyses') {
                        updateComparaisonChart();
                    }
                });
            });
        }

        function goBack() {
            // Retour vers TRAKIO principal
            window.location.href = 'index.html';
        }

        // ============================================
        // POSTES DE CHARGES
        // ============================================

        function initDefaultPostes() {
            if (state.postes.length === 0) {
                state.postes = [
                    { id: 1, nom: 'Loyer', icon: 'fa-home', color: 'blue', budget: 0 },
                    { id: 2, nom: 'Salaires', icon: 'fa-users', color: 'green', budget: 0 },
                    { id: 3, nom: 'Assurances', icon: 'fa-shield-alt', color: 'purple', budget: 0 },
                    { id: 4, nom: 'V√©hicules', icon: 'fa-car', color: 'orange', budget: 0 },
                    { id: 5, nom: 'T√©l√©phone', icon: 'fa-phone', color: 'teal', budget: 0 },
                    { id: 6, nom: '√ânergie', icon: 'fa-bolt', color: 'yellow', budget: 0 },
                    { id: 7, nom: 'Entretien', icon: 'fa-tools', color: 'red', budget: 0 },
                    { id: 8, nom: 'Marchandises', icon: 'fa-box', color: 'pink', budget: 0 },
                    { id: 9, nom: 'Divers', icon: 'fa-ellipsis-h', color: 'gray', budget: 0 }
                ];
                saveToLocalStorage();
            }
        }

        function renderPostes() {
            const grid = document.getElementById('postesGrid');
            grid.innerHTML = state.postes.map(p => {
                const totalMonth = getPosteTotal(p.id, 'month');
                const count = state.charges.filter(c => c.posteId === p.id).length;
                return `
                    <div class="category-card" onclick="filterByPoste(${p.id})">
                        <div class="category-card-actions">
                            <button onclick="event.stopPropagation(); editPoste(${p.id})" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deletePoste(${p.id})" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="category-card-icon color-${p.color}">
                            <i class="fas ${p.icon}"></i>
                        </div>
                        <div class="category-card-name">${p.nom}</div>
                        <div class="category-card-count">${count} facture${count > 1 ? 's' : ''}</div>
                        <div class="category-card-amount">CHF ${formatNumber(totalMonth)}</div>
                    </div>
                `;
            }).join('');

            // Mettre √† jour les selects
            updatePosteSelects();
        }

        function updatePosteSelects() {
            const options = state.postes.map(p => `<option value="${p.id}">${p.nom}</option>`).join('');
            
            document.getElementById('chargePoste').innerHTML = '<option value="">S√©lectionner...</option>' + options;
            document.getElementById('chargesFilterPoste').innerHTML = '<option value="">Tous les postes</option>' + options;
            document.getElementById('fournisseurCategorie').innerHTML = '<option value="">S√©lectionner...</option>' + options;
        }

        function savePoste() {
            const id = document.getElementById('posteId').value;
            const nom = document.getElementById('posteNom').value.trim();
            const icon = document.getElementById('posteIcon').value;
            const color = document.querySelector('input[name="posteColor"]:checked').value;
            const budget = parseFloat(document.getElementById('posteBudget').value) || 0;

            if (!nom) {
                showToast('Veuillez entrer un nom', 'error');
                return;
            }

            if (id) {
                // Modification
                const index = state.postes.findIndex(p => p.id === parseInt(id));
                if (index > -1) {
                    state.postes[index] = { ...state.postes[index], nom, icon, color, budget };
                }
            } else {
                // Cr√©ation
                const newId = Math.max(0, ...state.postes.map(p => p.id)) + 1;
                state.postes.push({ id: newId, nom, icon, color, budget });
            }

            saveToLocalStorage();
            renderAll();
            closeModal('posteModal');
            showToast('Poste enregistr√©', 'success');
        }

        function editPoste(id) {
            const poste = state.postes.find(p => p.id === id);
            if (!poste) return;

            document.getElementById('posteId').value = poste.id;
            document.getElementById('posteNom').value = poste.nom;
            document.getElementById('posteIcon').value = poste.icon;
            document.getElementById('posteBudget').value = poste.budget || '';
            document.querySelector(`input[name="posteColor"][value="${poste.color}"]`).checked = true;
            document.getElementById('posteModalTitle').textContent = 'Modifier le poste';

            openModal('posteModal');
        }

        function deletePoste(id) {
            const chargesCount = state.charges.filter(c => c.posteId === id).length;
            if (chargesCount > 0) {
                if (!confirm(`Ce poste contient ${chargesCount} charge(s). Supprimer quand m√™me ?`)) return;
            }

            state.postes = state.postes.filter(p => p.id !== id);
            saveToLocalStorage();
            renderAll();
            showToast('Poste supprim√©', 'success');
        }

        // ============================================
        // FOURNISSEURS
        // ============================================

        function renderFournisseurs() {
            const tbody = document.getElementById('fournisseursTable');
            
            if (state.fournisseurs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="fas fa-building"></i>
                                <h3>Aucun fournisseur</h3>
                                <p>Ajoutez vos fournisseurs et prestataires</p>
                                <button class="btn btn-primary" onclick="openModal('fournisseurModal')">
                                    <i class="fas fa-plus"></i> Ajouter un fournisseur
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = state.fournisseurs.map(f => {
                const poste = state.postes.find(p => p.id === f.posteId);
                const totalYear = getFournisseurTotal(f.id, 'year');
                const conditions = f.conditions === 'immediate' ? 'Imm√©diat' : `${f.conditions} jours`;
                
                return `
                    <tr>
                        <td><strong>${f.nom}</strong></td>
                        <td>${poste ? `<span class="category-tag color-${poste.color}">${poste.nom}</span>` : '-'}</td>
                        <td>${f.contact || '-'}</td>
                        <td>${f.email ? `<a href="mailto:${f.email}">${f.email}</a>` : '-'}</td>
                        <td>${f.tel || '-'}</td>
                        <td>${conditions}</td>
                        <td><strong>CHF ${formatNumber(totalYear)}</strong></td>
                        <td class="actions">
                            <button onclick="editFournisseur(${f.id})" title="Modifier"><i class="fas fa-edit"></i></button>
                            <button onclick="viewFournisseurCharges(${f.id})" title="Voir les charges"><i class="fas fa-file-invoice"></i></button>
                            <button class="delete" onclick="deleteFournisseur(${f.id})" title="Supprimer"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Mettre √† jour le select fournisseur dans le modal charge
            updateFournisseurSelect();
        }

        function updateFournisseurSelect() {
            const options = state.fournisseurs.map(f => `<option value="${f.id}">${f.nom}</option>`).join('');
            document.getElementById('chargeFournisseur').innerHTML = '<option value="">S√©lectionner...</option>' + options;
        }

        function saveFournisseur() {
            const id = document.getElementById('fournisseurId').value;
            const data = {
                nom: document.getElementById('fournisseurNom').value.trim(),
                posteId: parseInt(document.getElementById('fournisseurCategorie').value) || null,
                contact: document.getElementById('fournisseurContact').value.trim(),
                email: document.getElementById('fournisseurEmail').value.trim(),
                tel: document.getElementById('fournisseurTel').value.trim(),
                conditions: document.getElementById('fournisseurConditions').value,
                adresse: document.getElementById('fournisseurAdresse').value.trim(),
                notes: document.getElementById('fournisseurNotes').value.trim()
            };

            if (!data.nom) {
                showToast('Veuillez entrer un nom', 'error');
                return;
            }

            if (id) {
                const index = state.fournisseurs.findIndex(f => f.id === parseInt(id));
                if (index > -1) {
                    state.fournisseurs[index] = { ...state.fournisseurs[index], ...data };
                }
            } else {
                const newId = Math.max(0, ...state.fournisseurs.map(f => f.id)) + 1;
                state.fournisseurs.push({ id: newId, ...data });
            }

            saveToLocalStorage();
            renderAll();
            closeModal('fournisseurModal');
            showToast('Fournisseur enregistr√©', 'success');
        }

        function editFournisseur(id) {
            const f = state.fournisseurs.find(x => x.id === id);
            if (!f) return;

            document.getElementById('fournisseurId').value = f.id;
            document.getElementById('fournisseurNom').value = f.nom;
            document.getElementById('fournisseurCategorie').value = f.posteId || '';
            document.getElementById('fournisseurContact').value = f.contact || '';
            document.getElementById('fournisseurEmail').value = f.email || '';
            document.getElementById('fournisseurTel').value = f.tel || '';
            document.getElementById('fournisseurConditions').value = f.conditions || '30';
            document.getElementById('fournisseurAdresse').value = f.adresse || '';
            document.getElementById('fournisseurNotes').value = f.notes || '';
            document.getElementById('fournisseurModalTitle').textContent = 'Modifier le fournisseur';

            openModal('fournisseurModal');
        }

        function deleteFournisseur(id) {
            if (!confirm('Supprimer ce fournisseur ?')) return;
            state.fournisseurs = state.fournisseurs.filter(f => f.id !== id);
            saveToLocalStorage();
            renderAll();
            showToast('Fournisseur supprim√©', 'success');
        }

        function filterFournisseurs() {
            const search = document.getElementById('fournisseursSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#fournisseursTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function viewFournisseurCharges(id) {
            // Aller √† l'onglet charges avec filtre
            document.querySelector('[data-tab="charges"]').click();
            // TODO: Impl√©menter le filtre par fournisseur
        }

        // ============================================
        // CHARGES
        // ============================================

        function renderCharges() {
            renderChargesTable('chargesTable', state.charges);
            renderChargesTable('recentChargesTable', state.charges.slice(-5).reverse());
            updateChargesBadge();
        }

        function renderChargesTable(tableId, charges) {
            const tbody = document.getElementById(tableId);
            const isRecent = tableId === 'recentChargesTable';

            if (charges.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${isRecent ? 7 : 12}">
                            <div class="empty-state">
                                <i class="fas fa-file-invoice-dollar"></i>
                                <h3>Aucune charge enregistr√©e</h3>
                                <p>Commencez par ajouter vos premi√®res charges</p>
                                <button class="btn btn-primary" onclick="openModal('chargeModal')">
                                    <i class="fas fa-plus"></i> Ajouter une charge
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = charges.map(c => {
                const poste = state.postes.find(p => p.id === c.posteId);
                const fournisseur = state.fournisseurs.find(f => f.id === c.fournisseurId);
                const statusClass = c.status === 'paid' ? 'paid' : (isOverdue(c) ? 'overdue' : 'pending');
                const statusText = c.status === 'paid' ? '‚úÖ Pay√©' : (isOverdue(c) ? 'üî¥ En retard' : '‚è≥ En attente');
                const recurrenceText = { ponctuel: 'Ponctuel', mensuel: 'Mensuel', trimestriel: 'Trim.', annuel: 'Annuel' }[c.recurrence] || '-';

                if (isRecent) {
                    return `
                        <tr>
                            <td>${formatDate(c.dateFacture)}</td>
                            <td><strong>${c.libelle}</strong></td>
                            <td>${poste ? `<span class="category-tag color-${poste.color}">${poste.nom}</span>` : '-'}</td>
                            <td>${fournisseur ? fournisseur.nom : '-'}</td>
                            <td><strong>CHF ${formatNumber(c.montantTTC)}</strong></td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td class="actions">
                                <button onclick="editCharge(${c.id})" title="Modifier"><i class="fas fa-edit"></i></button>
                                ${c.status !== 'paid' ? `<button onclick="markAsPaid(${c.id})" title="Marquer pay√©"><i class="fas fa-check"></i></button>` : ''}
                            </td>
                        </tr>
                    `;
                }

                return `
                    <tr>
                        <td>${formatDate(c.dateFacture)}</td>
                        <td>${c.dateEcheance ? formatDate(c.dateEcheance) : '-'}</td>
                        <td><strong>${c.libelle}</strong></td>
                        <td>${poste ? `<span class="category-tag color-${poste.color}">${poste.nom}</span>` : '-'}</td>
                        <td>${fournisseur ? fournisseur.nom : '-'}</td>
                        <td>CHF ${formatNumber(c.montantHT)}</td>
                        <td>${c.tva}%</td>
                        <td><strong>CHF ${formatNumber(c.montantTTC)}</strong></td>
                        <td>${recurrenceText}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${c.files && c.files.length ? `<i class="fas fa-paperclip" title="${c.files.length} fichier(s)"></i>` : '-'}</td>
                        <td class="actions">
                            <button onclick="editCharge(${c.id})" title="Modifier"><i class="fas fa-edit"></i></button>
                            ${c.status !== 'paid' ? `<button onclick="markAsPaid(${c.id})" title="Marquer pay√©"><i class="fas fa-check"></i></button>` : ''}
                            <button class="delete" onclick="deleteCharge(${c.id})" title="Supprimer"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateChargesBadge() {
            const pending = state.charges.filter(c => c.status !== 'paid').length;
            document.getElementById('chargesPending').textContent = pending;
            document.getElementById('chargesPending').style.display = pending > 0 ? 'inline' : 'none';
        }

        function calculateTTC() {
            const ht = parseFloat(document.getElementById('chargeMontantHT').value) || 0;
            const tva = parseFloat(document.getElementById('chargeTVA').value) || 0;
            const ttc = ht * (1 + tva / 100);
            document.getElementById('chargeMontantTTC').value = ttc.toFixed(2);
        }

        function saveCharge() {
            const id = document.getElementById('chargeId').value;
            const data = {
                libelle: document.getElementById('chargeLibelle').value.trim(),
                posteId: parseInt(document.getElementById('chargePoste').value) || null,
                fournisseurId: parseInt(document.getElementById('chargeFournisseur').value) || null,
                recurrence: document.getElementById('chargeRecurrence').value,
                montantHT: parseFloat(document.getElementById('chargeMontantHT').value) || 0,
                tva: parseFloat(document.getElementById('chargeTVA').value) || 0,
                montantTTC: parseFloat(document.getElementById('chargeMontantTTC').value) || 0,
                dateFacture: document.getElementById('chargeDateFacture').value,
                dateEcheance: document.getElementById('chargeDateEcheance').value,
                status: document.getElementById('chargeStatut').value,
                notes: document.getElementById('chargeNotes').value.trim(),
                files: [] // TODO: G√©rer les fichiers
            };

            if (!data.libelle || !data.montantHT || !data.dateFacture) {
                showToast('Veuillez remplir les champs obligatoires', 'error');
                return;
            }

            if (id) {
                const index = state.charges.findIndex(c => c.id === parseInt(id));
                if (index > -1) {
                    state.charges[index] = { ...state.charges[index], ...data };
                }
            } else {
                const newId = Math.max(0, ...state.charges.map(c => c.id)) + 1;
                state.charges.push({ id: newId, ...data, createdAt: new Date().toISOString() });
            }

            saveToLocalStorage();
            renderAll();
            updateCharts();
            closeModal('chargeModal');
            showToast('Charge enregistr√©e', 'success');
        }

        function editCharge(id) {
            const c = state.charges.find(x => x.id === id);
            if (!c) return;

            document.getElementById('chargeId').value = c.id;
            document.getElementById('chargeLibelle').value = c.libelle;
            document.getElementById('chargePoste').value = c.posteId || '';
            document.getElementById('chargeFournisseur').value = c.fournisseurId || '';
            document.getElementById('chargeRecurrence').value = c.recurrence || 'ponctuel';
            document.getElementById('chargeMontantHT').value = c.montantHT;
            document.getElementById('chargeTVA').value = c.tva;
            document.getElementById('chargeMontantTTC').value = c.montantTTC;
            document.getElementById('chargeDateFacture').value = c.dateFacture;
            document.getElementById('chargeDateEcheance').value = c.dateEcheance || '';
            document.getElementById('chargeStatut').value = c.status;
            document.getElementById('chargeNotes').value = c.notes || '';
            document.getElementById('chargeModalTitle').textContent = 'Modifier la charge';

            openModal('chargeModal');
        }

        function deleteCharge(id) {
            if (!confirm('Supprimer cette charge ?')) return;
            state.charges = state.charges.filter(c => c.id !== id);
            saveToLocalStorage();
            renderAll();
            updateCharts();
            showToast('Charge supprim√©e', 'success');
        }

        function markAsPaid(id) {
            const charge = state.charges.find(c => c.id === id);
            if (charge) {
                charge.status = 'paid';
                charge.paidAt = new Date().toISOString();
                saveToLocalStorage();
                renderAll();
                showToast('Charge marqu√©e comme pay√©e', 'success');
            }
        }

        function filterCharges() {
            const search = document.getElementById('chargesSearch').value.toLowerCase();
            const poste = document.getElementById('chargesFilterPoste').value;
            const status = document.getElementById('chargesFilterStatus').value;
            const period = document.getElementById('chargesFilterPeriod').value;

            let filtered = [...state.charges];

            if (search) {
                filtered = filtered.filter(c => c.libelle.toLowerCase().includes(search));
            }

            if (poste) {
                filtered = filtered.filter(c => c.posteId === parseInt(poste));
            }

            if (status) {
                if (status === 'overdue') {
                    filtered = filtered.filter(c => c.status !== 'paid' && isOverdue(c));
                } else {
                    filtered = filtered.filter(c => c.status === status);
                }
            }

            if (period) {
                const now = new Date();
                filtered = filtered.filter(c => {
                    const date = new Date(c.dateFacture);
                    if (period === 'month') {
                        return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                    } else if (period === 'quarter') {
                        const q1 = Math.floor(now.getMonth() / 3);
                        const q2 = Math.floor(date.getMonth() / 3);
                        return q1 === q2 && date.getFullYear() === now.getFullYear();
                    } else if (period === 'year') {
                        return date.getFullYear() === now.getFullYear();
                    }
                    return true;
                });
            }

            renderChargesTable('chargesTable', filtered);
        }

        function filterByPoste(posteId) {
            document.querySelector('[data-tab="charges"]').click();
            document.getElementById('chargesFilterPoste').value = posteId;
            filterCharges();
        }

        function handleFileUpload(input) {
            const files = input.files;
            const fileList = document.getElementById('chargeFileList');
            
            Array.from(files).forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <div class="file-item-info">
                        <div class="file-item-icon"><i class="fas fa-file-pdf"></i></div>
                        <div>
                            <div class="file-item-name">${file.name}</div>
                            <div class="file-item-size">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileList.appendChild(item);
            });
        }

        function exportCharges() {
            // Export CSV
            const headers = ['Date', '√âch√©ance', 'Libell√©', 'Poste', 'Fournisseur', 'HT', 'TVA', 'TTC', 'Statut'];
            const rows = state.charges.map(c => {
                const poste = state.postes.find(p => p.id === c.posteId);
                const fournisseur = state.fournisseurs.find(f => f.id === c.fournisseurId);
                return [
                    c.dateFacture,
                    c.dateEcheance || '',
                    c.libelle,
                    poste ? poste.nom : '',
                    fournisseur ? fournisseur.nom : '',
                    c.montantHT,
                    c.tva + '%',
                    c.montantTTC,
                    c.status === 'paid' ? 'Pay√©' : 'En attente'
                ].join(';');
            });

            const csv = [headers.join(';'), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `charges_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Export termin√©', 'success');
        }

        // ============================================
        // DASHBOARD & KPIs
        // ============================================

        function updateDashboard() {
            const now = new Date();
            const thisMonth = state.charges.filter(c => {
                const d = new Date(c.dateFacture);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            const lastMonth = state.charges.filter(c => {
                const d = new Date(c.dateFacture);
                const last = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                return d.getMonth() === last.getMonth() && d.getFullYear() === last.getFullYear();
            });
            const thisYear = state.charges.filter(c => {
                const d = new Date(c.dateFacture);
                return d.getFullYear() === now.getFullYear();
            });

            const monthTotal = thisMonth.reduce((s, c) => s + c.montantTTC, 0);
            const lastMonthTotal = lastMonth.reduce((s, c) => s + c.montantTTC, 0);
            const yearTotal = thisYear.reduce((s, c) => s + c.montantTTC, 0);
            const pending = state.charges.filter(c => c.status !== 'paid').length;
            const overdue = state.charges.filter(c => c.status !== 'paid' && isOverdue(c)).length;

            document.getElementById('kpiMonthTotal').textContent = `CHF ${formatNumber(monthTotal)}`;
            document.getElementById('kpiYearTotal').textContent = `CHF ${formatNumber(yearTotal)}`;
            document.getElementById('kpiPending').textContent = pending;
            document.getElementById('kpiOverdue').textContent = overdue;

            // Tendances
            if (lastMonthTotal > 0) {
                const diff = ((monthTotal - lastMonthTotal) / lastMonthTotal * 100).toFixed(1);
                const trend = document.getElementById('kpiMonthTrend');
                if (diff > 0) {
                    trend.className = 'kpi-trend up';
                    trend.innerHTML = `<i class="fas fa-arrow-up"></i> +${diff}%`;
                } else if (diff < 0) {
                    trend.className = 'kpi-trend down';
                    trend.innerHTML = `<i class="fas fa-arrow-down"></i> ${diff}%`;
                } else {
                    trend.className = 'kpi-trend neutral';
                    trend.innerHTML = `= 0%`;
                }
            }

            // Alertes
            renderAlerts(overdue, pending);
        }

        function renderAlerts(overdue, pending) {
            const container = document.getElementById('dashboardAlerts');
            let html = '';

            if (overdue > 0) {
                html += `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="alert-content">
                            <div class="alert-title">${overdue} facture(s) en retard</div>
                            <div class="alert-message">Des factures ont d√©pass√© leur date d'√©ch√©ance</div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // ============================================
        // ANALYSES
        // ============================================

        function updateAnalyses() {
            const monthlyCharges = getMonthlyTotal();
            
            // Seuil de rentabilit√© (charges mensuelles moyennes)
            document.getElementById('seuilRentabilite').textContent = `CHF ${formatNumber(monthlyCharges)}`;
            
            // Marge n√©cessaire (estimation bas√©e sur 30% de marge pour couvrir les charges)
            // Formule simplifi√©e : si charges = 10000, il faut vendre pour 10000/0.3 = 33333 avec 30% de marge
            const margeEstimee = monthlyCharges > 0 ? 35 : 0;
            document.getElementById('margeNecessaire').textContent = `${margeEstimee}%`;
            
            // Tendance
            const trend = calculateTrend();
            document.getElementById('tendance').textContent = trend > 0 ? `‚Üó +${trend.toFixed(1)}%` : trend < 0 ? `‚Üò ${trend.toFixed(1)}%` : '‚Üí Stable';

            renderRecommendations(monthlyCharges);
        }

        function renderRecommendations(monthlyCharges) {
            const container = document.getElementById('recommendationsGrid');
            const overdue = state.charges.filter(c => c.status !== 'paid' && isOverdue(c)).length;
            
            let recommendations = [];

            if (monthlyCharges > 0) {
                recommendations.push({
                    type: 'primary',
                    icon: 'fa-bullseye',
                    title: 'Objectif de ventes',
                    text: `Pour couvrir vos charges avec une marge de 35%, visez un CA mensuel minimum de :`,
                    value: `CHF ${formatNumber(monthlyCharges / 0.35)}`
                });
            }

            if (overdue > 0) {
                recommendations.push({
                    type: 'danger',
                    icon: 'fa-exclamation-circle',
                    title: 'Factures en retard',
                    text: `${overdue} facture(s) impay√©e(s) d√©passe(nt) leur √©ch√©ance. R√©gularisez rapidement pour √©viter les p√©nalit√©s.`,
                    value: null
                });
            }

            const biggestPoste = getBiggestPoste();
            if (biggestPoste) {
                recommendations.push({
                    type: 'warning',
                    icon: 'fa-chart-pie',
                    title: 'Poste principal',
                    text: `"${biggestPoste.nom}" repr√©sente votre plus gros poste de charges. √âvaluez les possibilit√©s d'optimisation.`,
                    value: `CHF ${formatNumber(biggestPoste.total)}/mois`
                });
            }

            container.innerHTML = recommendations.map(r => `
                <div class="recommendation-card ${r.type}">
                    <div class="recommendation-title">
                        <i class="fas ${r.icon}"></i>
                        ${r.title}
                    </div>
                    <p class="recommendation-text">${r.text}</p>
                    ${r.value ? `<div class="recommendation-value">${r.value}</div>` : ''}
                </div>
            `).join('');
        }

        // ============================================
        // BUDGET
        // ============================================

        function renderBudget() {
            const tbody = document.getElementById('budgetTable');
            const now = new Date();

            tbody.innerHTML = state.postes.map(p => {
                const spent = getPosteTotal(p.id, 'month');
                const budget = p.budget || 0;
                const ecart = budget - spent;
                const progress = budget > 0 ? Math.min((spent / budget) * 100, 100) : 0;
                const progressColor = progress > 90 ? 'var(--danger)' : progress > 70 ? 'var(--warning)' : 'var(--success)';

                return `
                    <tr>
                        <td>
                            <span class="category-tag color-${p.color}">
                                <i class="fas ${p.icon}"></i> ${p.nom}
                            </span>
                        </td>
                        <td>
                            <input type="number" class="form-input" style="width: 150px;" 
                                value="${budget || ''}" 
                                onchange="updatePosteBudget(${p.id}, this.value)"
                                placeholder="Non d√©fini">
                        </td>
                        <td><strong>CHF ${formatNumber(spent)}</strong></td>
                        <td style="color: ${ecart >= 0 ? 'var(--success)' : 'var(--danger)'}">
                            ${budget > 0 ? (ecart >= 0 ? '+' : '') + formatNumber(ecart) : '-'}
                        </td>
                        <td style="width: 200px;">
                            ${budget > 0 ? `
                                <div style="background: var(--gray-200); border-radius: 10px; height: 10px; overflow: hidden;">
                                    <div style="background: ${progressColor}; width: ${progress}%; height: 100%; transition: width 0.3s;"></div>
                                </div>
                                <small style="color: var(--gray-500);">${progress.toFixed(0)}%</small>
                            ` : '<small style="color: var(--gray-400);">Pas de budget</small>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updatePosteBudget(posteId, value) {
            const poste = state.postes.find(p => p.id === posteId);
            if (poste) {
                poste.budget = parseFloat(value) || 0;
            }
        }

        function saveBudget() {
            saveToLocalStorage();
            showToast('Budget enregistr√©', 'success');
        }

        // ============================================
        // GRAPHIQUES
        // ============================================

        function initCharts() {
            // √âvolution mensuelle
            const ctxEvolution = document.getElementById('evolutionChart').getContext('2d');
            evolutionChart = new Chart(ctxEvolution, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Charges TTC',
                        data: [],
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => 'CHF ' + value.toLocaleString()
                            }
                        }
                    }
                }
            });

            // R√©partition par poste
            const ctxRepartition = document.getElementById('repartitionChart').getContext('2d');
            repartitionChart = new Chart(ctxRepartition, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#2563eb', '#10b981', '#f59e0b', '#ef4444',
                            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });

            // Comparaison N vs N-1
            const ctxComparaison = document.getElementById('comparaisonChart').getContext('2d');
            comparaisonChart = new Chart(ctxComparaison, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Ann√©e en cours',
                            data: [],
                            backgroundColor: '#2563eb'
                        },
                        {
                            label: 'Ann√©e pr√©c√©dente',
                            data: [],
                            backgroundColor: '#94a3b8'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => 'CHF ' + value.toLocaleString()
                            }
                        }
                    }
                }
            });

            updateCharts();
        }

        function updateCharts() {
            // Donn√©es √©volution
            const months = getLastMonths(6);
            evolutionChart.data.labels = months.map(m => m.label);
            evolutionChart.data.datasets[0].data = months.map(m => m.total);
            evolutionChart.update();

            // Donn√©es r√©partition
            const postesData = state.postes.map(p => ({
                label: p.nom,
                total: getPosteTotal(p.id, 'year')
            })).filter(p => p.total > 0);

            repartitionChart.data.labels = postesData.map(p => p.label);
            repartitionChart.data.datasets[0].data = postesData.map(p => p.total);
            repartitionChart.update();
        }

        function updateComparaisonChart() {
            const monthNames = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
            const now = new Date();
            const currentYear = now.getFullYear();
            const lastYear = currentYear - 1;

            const dataCurrentYear = [];
            const dataLastYear = [];

            for (let m = 0; m < 12; m++) {
                const currentTotal = state.charges
                    .filter(c => {
                        const d = new Date(c.dateFacture);
                        return d.getMonth() === m && d.getFullYear() === currentYear;
                    })
                    .reduce((s, c) => s + c.montantTTC, 0);

                const lastTotal = state.charges
                    .filter(c => {
                        const d = new Date(c.dateFacture);
                        return d.getMonth() === m && d.getFullYear() === lastYear;
                    })
                    .reduce((s, c) => s + c.montantTTC, 0);

                dataCurrentYear.push(currentTotal);
                dataLastYear.push(lastTotal);
            }

            comparaisonChart.data.labels = monthNames;
            comparaisonChart.data.datasets[0].data = dataCurrentYear;
            comparaisonChart.data.datasets[0].label = `${currentYear}`;
            comparaisonChart.data.datasets[1].data = dataLastYear;
            comparaisonChart.data.datasets[1].label = `${lastYear}`;
            comparaisonChart.update();
        }

        // ============================================
        // UTILITAIRES
        // ============================================

        function getLastMonths(count) {
            const months = [];
            const now = new Date();
            const monthNames = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];

            for (let i = count - 1; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const total = state.charges
                    .filter(c => {
                        const cd = new Date(c.dateFacture);
                        return cd.getMonth() === d.getMonth() && cd.getFullYear() === d.getFullYear();
                    })
                    .reduce((s, c) => s + c.montantTTC, 0);

                months.push({
                    label: monthNames[d.getMonth()],
                    total
                });
            }

            return months;
        }

        function getPosteTotal(posteId, period) {
            const now = new Date();
            return state.charges
                .filter(c => {
                    if (c.posteId !== posteId) return false;
                    const d = new Date(c.dateFacture);
                    if (period === 'month') {
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    } else if (period === 'year') {
                        return d.getFullYear() === now.getFullYear();
                    }
                    return true;
                })
                .reduce((s, c) => s + c.montantTTC, 0);
        }

        function getFournisseurTotal(fournisseurId, period) {
            const now = new Date();
            return state.charges
                .filter(c => {
                    if (c.fournisseurId !== fournisseurId) return false;
                    const d = new Date(c.dateFacture);
                    if (period === 'year') {
                        return d.getFullYear() === now.getFullYear();
                    }
                    return true;
                })
                .reduce((s, c) => s + c.montantTTC, 0);
        }

        function getMonthlyTotal() {
            const now = new Date();
            const thisMonth = state.charges.filter(c => {
                const d = new Date(c.dateFacture);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            return thisMonth.reduce((s, c) => s + c.montantTTC, 0);
        }

        function getBiggestPoste() {
            let biggest = null;
            let maxTotal = 0;

            state.postes.forEach(p => {
                const total = getPosteTotal(p.id, 'month');
                if (total > maxTotal) {
                    maxTotal = total;
                    biggest = { ...p, total };
                }
            });

            return biggest;
        }

        function calculateTrend() {
            const months = getLastMonths(3);
            if (months.length < 2) return 0;
            
            const first = months[0].total;
            const last = months[months.length - 1].total;
            
            if (first === 0) return 0;
            return ((last - first) / first) * 100;
        }

        function isOverdue(charge) {
            if (!charge.dateEcheance) return false;
            return new Date(charge.dateEcheance) < new Date();
        }

        function formatNumber(num) {
            return num.toLocaleString('fr-CH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-CH');
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ============================================
        // MODALS
        // ============================================

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            
            // Reset form si nouveau
            if (modalId === 'chargeModal' && !document.getElementById('chargeId').value) {
                document.getElementById('chargeModalTitle').textContent = 'Nouvelle charge';
                document.getElementById('chargeDateFacture').valueAsDate = new Date();
                resetChargeForm();
            }
            if (modalId === 'posteModal' && !document.getElementById('posteId').value) {
                document.getElementById('posteModalTitle').textContent = 'Nouveau poste';
                resetPosteForm();
            }
            if (modalId === 'fournisseurModal' && !document.getElementById('fournisseurId').value) {
                document.getElementById('fournisseurModalTitle').textContent = 'Nouveau fournisseur';
                resetFournisseurForm();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            if (modalId === 'chargeModal') resetChargeForm();
            if (modalId === 'posteModal') resetPosteForm();
            if (modalId === 'fournisseurModal') resetFournisseurForm();
        }

        function resetChargeForm() {
            document.getElementById('chargeId').value = '';
            document.getElementById('chargeLibelle').value = '';
            document.getElementById('chargePoste').value = '';
            document.getElementById('chargeFournisseur').value = '';
            document.getElementById('chargeRecurrence').value = 'ponctuel';
            document.getElementById('chargeMontantHT').value = '';
            document.getElementById('chargeTVA').value = '8.1';
            document.getElementById('chargeMontantTTC').value = '';
            document.getElementById('chargeDateEcheance').value = '';
            document.getElementById('chargeStatut').value = 'pending';
            document.getElementById('chargeNotes').value = '';
            document.getElementById('chargeFileList').innerHTML = '';
        }

        function resetPosteForm() {
            document.getElementById('posteId').value = '';
            document.getElementById('posteNom').value = '';
            document.getElementById('posteIcon').value = 'fa-home';
            document.getElementById('posteBudget').value = '';
            document.querySelector('input[name="posteColor"][value="blue"]').checked = true;
        }

        function resetFournisseurForm() {
            document.getElementById('fournisseurId').value = '';
            document.getElementById('fournisseurNom').value = '';
            document.getElementById('fournisseurCategorie').value = '';
            document.getElementById('fournisseurContact').value = '';
            document.getElementById('fournisseurEmail').value = '';
            document.getElementById('fournisseurTel').value = '';
            document.getElementById('fournisseurConditions').value = '30';
            document.getElementById('fournisseurAdresse').value = '';
            document.getElementById('fournisseurNotes').value = '';
        }

        // Fermer modal sur clic ext√©rieur
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // ============================================
        // NOTIFICATIONS
        // ============================================

<<<<<<< HEAD
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
=======
        // ===== VERSION DE L'APPLICATION =====
        const APP_VERSION = '3.2.2';
        const APP_VERSION_DATE = '2025-12-01';
        
        // ===== UTILISATEURS PAR D√âFAUT =====
        (function initDefaultUsers() {
            let users = JSON.parse(localStorage.getItem('trakio_users') || '[]');
            
            // V√©rifier si les IDs sont des strings (ancien format) - migration n√©cessaire
            const needsMigration = users.length > 0 && typeof users[0].id === 'string';
            
            if (users.length === 0 || needsMigration) {
                const defaultUsers = [
                    {
                        id: 1,
                        name: 'Pascal Admin',
                        pin: '1277',
                        role: 'admin',
                        active: true,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: 'C√©line',
                        pin: '1277',
                        role: 'superuser',
                        active: true,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 3,
                        name: 'Hayat',
                        pin: '1260',
                        role: 'user',
                        active: true,
                        createdAt: new Date().toISOString()
                    }
                ];
                localStorage.setItem('trakio_users', JSON.stringify(defaultUsers));
                console.log('‚úÖ Utilisateurs par d√©faut cr√©√©s: Pascal Admin (1277), C√©line (1277), Hayat (1260)');
            }
        })();

        // Changelog des versions (pour affichage)
        const VERSION_CHANGELOG = {
            '3.2.2': [
                'üÜï Badge version en attente visible √† c√¥t√© du d√©compte',
                'üëÅÔ∏è Affiche "üü¢ 4:32 üÜï v3.2.3" quand une MAJ est disponible',
                'üñ±Ô∏è Clic sur le badge ‚Üí ouvre directement le modal de mise √† jour'
            ],
            '3.2.1': [
                'üì¢ Publication automatique de la version par l\'admin',
                'üîÑ version.json cr√©√©/mis √† jour automatiquement sur Dropbox',
                '‚úÖ Les autres utilisateurs re√ßoivent la notification de mise √† jour',
                '‚ö° Pas besoin de publier manuellement dans Param√®tres'
            ],
            '3.2.0': [
                'üêõ Correction compteurs "Commandes en cours" sur le dashboard',
                'üìä Dashboard synchronis√© avec le badge sidebar',
                'üîÑ Compteurs mis √† jour apr√®s chaque sync Dropbox',
                '‚úÖ Statut "pending" correctement comptabilis√©'
            ],
            '3.1.9': [
                'üì¶ Sync produits commandes rapides (QOData.products)',
                'üí∞ Sync listes de prix (pricelists) et remises (discounts)',
                'üìÇ Sync cat√©gories articles compl√®tes',
                'üîÑ Toutes les donn√©es partag√©es entre appareils'
            ],
            '3.1.8': [
                '‚òÅÔ∏è Sync automatique activ√©e par d√©faut',
                'üì¶ Synchronisation de TOUS les modules (Prix Fournisseurs, Cours Poissons, RH)',
                'üîÑ D√©marrage auto de la sync au chargement',
                'üíæ Donn√©es partag√©es entre tous les appareils',
                '‚è±Ô∏è D√©compte sync visible dans la barre'
            ],
            '3.1.7': [
                'üö´ Modal mise √† jour supprim√© au chargement/rafra√Æchissement',
                '‚úÖ Modal uniquement lors de la sync auto (5 min)',
                'üîß Ne bloque plus l\'utilisateur au d√©marrage'
            ],
            '3.1.6': [
                'üêõ Correction bug CSS affich√© en texte sur la page',
                '‚úÖ Modal mise √† jour uniquement lors sync auto',
                'üîß Nettoyage balises style dupliqu√©es'
            ],
            '3.1.5': [
                'üîá Modal mise √† jour uniquement lors de sync auto (5 min)',
                '‚è≥ Si commande en cours ‚Üí notification discr√®te',
                'üö´ Plus de modal au d√©marrage de la page'
            ],
            '3.1.4': [
                '‚úÖ Mise √† jour ne redemande plus apr√®s installation',
                'üîÑ Cache bust forc√© lors du rechargement',
                'üì¢ Notification de succ√®s apr√®s mise √† jour'
            ],
            '3.1.3': [
                '‚è±Ô∏è D√©compte visible avant prochaine sync (ex: 4:32)',
                'üîÑ Syst√®me de mise √† jour automatique',
                'üöÄ Bouton pour publier une mise √† jour (admin)',
                'üîí Bloque les utilisateurs pendant une mise √† jour'
            ],
            '3.1.2': [
                '‚è±Ô∏è Sync Dropbox pass√©e de 30 sec √† 5 min',
                'üìä Respecte les limites API Dropbox (300 appels/h)',
                'üîÑ √âvite les erreurs 429 (rate limit)'
            ],
            '3.1.1': [
                '‚òÅÔ∏è Dropbox - Refresh token automatique en arri√®re-plan',
                'üîÑ Plus de d√©connexion apr√®s 4h',
                '‚ú® Fonctions isAvailable() et canSync() pour v√©rifications simplifi√©es'
            ],
            '3.1.0': [
                '‚òÅÔ∏è Dropbox: refresh automatique du token en arri√®re-plan',
                'üîÑ Plus de d√©connexion toutes les 4h !',
                '‚ú® Affichage du temps restant avant refresh',
                'üîê Reconnexion automatique au chargement'
            ],
            '3.0.8': [
                'üìÑ Parseur PDF intelligent - s√©pare automatiquement les lignes fusionn√©es',
                'üîç D√©tection de plusieurs prix sur une m√™me ligne',
                '‚ú® Debug am√©lior√© dans la console'
            ],
            '3.0.7': [
                'üìÑ Parseur PDF corrig√© - s√©paration correcte des 2 colonnes',
                'üîç Recherche globale inclut Prix Fournisseurs',
                '‚ú® D√©tection automatique du gap entre colonnes PDF'
            ],
            '3.0.6': [
                'üìÑ Parseur PDF am√©lior√© - g√®re les 2 colonnes',
                'üîç Recherche am√©lior√©e (mots multiples, surlignage)',
                'üìä Affichage jusqu\'√† 500 produits au lieu de 100',
                '‚ú® Affiche "Rupture" pour les prix √† 0'
            ],
            '3.0.5': [
                'üìÑ VRAI parseur PDF pour Prix Fournisseurs',
                'üîç Extraction automatique des produits et prix',
                'üì• Support PDF, CSV, Excel (tous les produits !)',
                'üîÑ Mise √† jour des prix existants + historique'
            ],
            '3.0.4': [
                'üî¢ Num√©ro de version affich√© √† c√¥t√© du logo',
                'üìã Version synchronis√©e dans Param√®tres > Mise √† jour',
                'üîÑ Toutes les versions utilisent APP_VERSION'
            ],
            '3.0.3': [
                'üì• Modal import clients avec choix du mode',
                'üîÑ Option "Remplacer tout" (vide + importe)',
                '‚ûï Option "Mettre √† jour / Ajouter" (conserve existants)',
                'üìä Affichage du nombre de clients actuels'
            ],
            '3.0.2': [
                'üîÑ Import clients intelligent (mise √† jour au lieu de doublons)',
                'üîç D√©tection par num√©ro client ou nom',
                'üìä Affichage s√©par√©: ajout√©s vs mis √† jour'
            ],
            '3.0.1': [
                'üë§ Utilisateurs par d√©faut int√©gr√©s au code',
                'üîê Pascal Admin (1277), C√©line (1277), Hayat (1260)',
                'üöÄ Plus besoin de console pour cr√©er les comptes'
            ],
            '3.0.0': [
                'üë• Module RH Personnel complet (Admin only)',
                'üìÖ Calendrier mensuel des absences',
                'üèñÔ∏è Gestion vacances, cong√©s, maladies',
                '‚è∞ Config: 8h30/jour, 42.5h/sem, 4 sem vacances',
                'üìä D√©compte annuel avec soldes par employ√©',
                'üñ®Ô∏è Impression par personnel/mois/ann√©e',
                'üóëÔ∏è Suppression de TRAKIO Pilot (s√©par√©)'
            ],
            '2.9.9': [
                'üîê √âcran de connexion √©l√©gant avec s√©lection utilisateur',
                'üîí Authentification par code PIN s√©curis√©',
                '‚è∞ D√©connexion automatique apr√®s 1h d\'inactivit√©',
                'üìä Historique des connexions (Admin only)'
            ],
            '2.9.8': [
                'üè† Dashboard PRO - Nouveau design √©l√©gant et organis√©',
                'üî¥ Zone urgente avec statuts en temps r√©el',
                '‚ö° Acc√®s rapides - 6 tuiles principales avec animations',
                'üõ†Ô∏è Section Outils r√©tractable pour modules secondaires'
            ]
        };

        // V√©rifier si une mise √† jour est n√©cessaire
        // NOTE: Ne PAS afficher de modal ici ! Le modal n'appara√Æt que lors de la sync auto Dropbox
        function checkVersionUpdate() {
            const savedVersion = localStorage.getItem('trakio_version');

            if (!savedVersion) {
                // Premi√®re installation
                localStorage.setItem('trakio_version', APP_VERSION);
                return;
            }

            if (savedVersion !== APP_VERSION) {
                // Nouvelle version d√©tect√©e - juste mettre √† jour localStorage
                // PAS de modal ici - le modal n'appara√Æt que lors de la sync auto
                console.log(`üì¶ Version mise √† jour: ${savedVersion} ‚Üí ${APP_VERSION}`);
                localStorage.setItem('trakio_version', APP_VERSION);
            }
        }

        // Modal de mise √† jour
        function showUpdateModal(oldVersion, newVersion) {
            const changes = VERSION_CHANGELOG[newVersion] || ['Am√©liorations diverses'];

            const modal = document.createElement('div');
            modal.id = 'update-modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:10000; display:flex; justify-content:center; align-items:center; padding:20px;';
            modal.innerHTML = `
                <div style="background:var(--bg-card); border-radius:20px; max-width:450px; width:100%; overflow:hidden; animation:slideUp 0.3s ease;">
                    <div style="padding:24px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); text-align:center;">
                        <div style="font-size:50px; margin-bottom:10px;">üöÄ</div>
                        <h2 style="color:#000; font-weight:700; margin:0;">Nouvelle version !</h2>
                        <p style="color:#000; opacity:0.8; margin:8px 0 0;">TRAKIO ${newVersion}</p>
                    </div>

                    <div style="padding:24px;">
                        <p style="color:var(--text-muted); font-size:13px; margin-bottom:16px;">
                            Vous passez de <strong>v${oldVersion}</strong> √† <strong>v${newVersion}</strong>
                        </p>

                        <div style="background:var(--bg-primary); border-radius:12px; padding:16px; margin-bottom:20px;">
                            <div style="font-weight:600; margin-bottom:12px; color:var(--accent-primary);">üìã Nouveaut√©s :</div>
                            ${changes.map(c => `<div style="font-size:13px; padding:6px 0; border-bottom:1px solid var(--border-color);">${c}</div>`).join('')}
                        </div>

                        <div style="background:#f39c1220; border:1px solid #f39c12; border-radius:10px; padding:12px; margin-bottom:20px;">
                            <div style="font-size:13px; color:#f39c12;">
                                ‚ö†Ô∏è <strong>Mise √† jour recommand√©e</strong><br>
                                <span style="font-size:12px; opacity:0.9;">Les permissions des utilisateurs Admin seront mises √† jour avec les nouveaux modules.</span>
                            </div>
                        </div>

                        <div style="display:flex; gap:12px;">
                            <button onclick="skipUpdate()" style="flex:1; padding:14px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; font-weight:600; cursor:pointer;">
                                Plus tard
                            </button>
                            <button onclick="applyUpdate()" style="flex:2; padding:14px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color:#000; border:none; border-radius:10px; font-weight:700; cursor:pointer;">
                                ‚úÖ Mettre √† jour
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Appliquer la mise √† jour
        function applyUpdate() {
            // Mettre √† jour les permissions des admins
            const allModules = MODULES_CONFIG.modules.map(m => m.id);
            const allActions = MODULES_CONFIG.actions.map(a => a.id);
            const allSettings = MODULES_CONFIG.settings.map(s => s.id);

            let updated = 0;
            UsersData.users.forEach(user => {
                if (user.role === 'admin') {
                    user.permissions = {
                        modules: allModules,
                        actions: allActions,
                        settings: allSettings
                    };
                    updated++;
                }
            });

            // Sauvegarder
            saveUsersData();
            localStorage.setItem('trakio_version', APP_VERSION);

            // Fermer le modal
            document.getElementById('update-modal')?.remove();

            // Notification
            showToast(`‚úÖ Mise √† jour v${APP_VERSION} appliqu√©e ! ${updated} admin(s) mis √† jour.`);

            // Rafra√Æchir l'interface
            if (UsersData.currentUser?.role === 'admin') {
                UsersData.currentUser.permissions = { modules: allModules, actions: allActions, settings: allSettings };
                applyUserPermissions();
            }
        }

        // Ignorer la mise √† jour (pour cette session)
        function skipUpdate() {
            document.getElementById('update-modal')?.remove();
            // On ne sauvegarde pas la version, le modal r√©appara√Ætra au prochain chargement
        }

        // ===== CONFIGURATION CENTRALIS√âE DES MODULES =====
        // Ajouter un nouveau module ici = il appara√Æt automatiquement dans les permissions
        const MODULES_CONFIG = {
            // Modules principaux (pages/navigation)
            modules: [
                { id: 'dashboard', name: 'Dashboard', icon: 'üè†', description: 'Accueil' },
                { id: 'quickorder', name: 'Prise de commande', icon: '‚ö°', description: 'Cr√©er des commandes' },
                { id: 'orders', name: 'Commandes en cours', icon: 'üìã', description: 'G√©rer les commandes' },
                { id: 'articles', name: 'Articles', icon: 'üì¶', description: 'Gestion des produits' },
                { id: 'clients', name: 'Clients', icon: 'üë•', description: 'Gestion des clients' },
                { id: 'myfish', name: 'MyFish', icon: 'üêü', description: 'Commandes clients priv√©s B2C' },
                { id: 'cours-poissons', name: 'Cours Poissons Frais', icon: 'üé£', description: 'Tarifs et marges poissons' },
                { id: 'prix-fournisseurs', name: 'Prix Fournisseurs', icon: 'üíµ', description: 'Comparaison prix fournisseurs' },
                { id: 'analyses', name: 'Analyses', icon: 'üìä', description: 'Statistiques et analyses' },
                { id: 'shop', name: 'Shop Hub', icon: 'üõçÔ∏è', description: 'Shopify, Nutri-Score, Fiches Produit' },
                { id: 'prix-traversette', name: 'Prix Traversette', icon: 'üí∞', description: 'Calcul prix Traversette' },
                { id: 'tracking', name: 'Suivi', icon: 'üìç', description: 'Suivi des livraisons' },
                { id: 'reports', name: 'Rapports', icon: 'üìà', description: 'Statistiques et rapports' },
                { id: 'settings', name: 'Param√®tres', icon: '‚öôÔ∏è', description: 'Configuration' }
            ],
            // Actions/Fonctionnalit√©s
            actions: [
                { id: 'articles-add', name: 'Ajouter articles', icon: '‚ûï', description: 'Cr√©er de nouveaux articles' },
                { id: 'articles-edit', name: 'Modifier articles', icon: '‚úèÔ∏è', description: 'Modifier les articles existants' },
                { id: 'articles-delete', name: 'Supprimer articles', icon: 'üóëÔ∏è', description: 'Supprimer des articles' },
                { id: 'articles-import', name: 'Import articles', icon: 'üì•', description: 'Importer des articles CSV/XLS' },
                { id: 'articles-export', name: 'Export articles', icon: 'üì§', description: 'Exporter les articles' },
                { id: 'clients-add', name: 'Ajouter clients', icon: '‚ûï', description: 'Cr√©er de nouveaux clients' },
                { id: 'clients-edit', name: 'Modifier clients', icon: '‚úèÔ∏è', description: 'Modifier les clients existants' },
                { id: 'clients-delete', name: 'Supprimer clients', icon: 'üóëÔ∏è', description: 'Supprimer des clients' },
                { id: 'clients-import', name: 'Import clients', icon: 'üì•', description: 'Importer des clients CSV/XLS' },
                { id: 'clients-export', name: 'Export clients', icon: 'üì§', description: 'Exporter les clients' },
                { id: 'orders-create', name: 'Cr√©er commandes', icon: 'üìù', description: 'Cr√©er de nouvelles commandes' },
                { id: 'orders-edit', name: 'Modifier commandes', icon: '‚úèÔ∏è', description: 'Modifier les commandes' },
                { id: 'orders-delete', name: 'Supprimer commandes', icon: 'üóëÔ∏è', description: 'Supprimer des commandes' },
                { id: 'orders-pdf', name: 'G√©n√©rer PDF', icon: 'üìÑ', description: 'G√©n√©rer des PDF de commande' },
                { id: 'myfish-create', name: 'Cr√©er commande MyFish', icon: 'üêü', description: 'Cr√©er commandes clients priv√©s' },
                { id: 'myfish-edit', name: 'Modifier MyFish', icon: '‚úèÔ∏è', description: 'Modifier commandes MyFish' },
                { id: 'myfish-delete', name: 'Supprimer MyFish', icon: 'üóëÔ∏è', description: 'Supprimer commandes MyFish' },
                { id: 'cpf-edit', name: 'Modifier Cours Poissons', icon: 'üé£', description: 'Modifier les prix poissons' },
                { id: 'cpf-sync', name: 'Sync Prix Fournisseurs', icon: 'üîÑ', description: 'Synchroniser depuis fournisseurs' },
                { id: 'pf-import', name: 'Import Prix Fournisseurs', icon: 'üì•', description: 'Importer liste de prix' },
                { id: 'pf-order', name: 'Commander Fournisseurs', icon: 'üõí', description: 'Passer des commandes fournisseurs' },
                { id: 'shop-nutri', name: 'Nutri-Score', icon: 'üè∑Ô∏è', description: 'G√©n√©rer √©tiquettes Nutri-Score' },
                { id: 'shop-fiches', name: 'Fiches Produit', icon: 'üìù', description: 'Cr√©er fiches produit Shopify' },
                { id: 'prix-confidential', name: 'Voir prix confidentiels', icon: 'üîí', description: 'Voir les marges et PA' }
            ],
            // Param√®tres sensibles (Super-User et Admin)
            settings: [
                { id: 'dropbox', name: 'Dropbox', icon: '‚òÅÔ∏è', description: 'Configuration Dropbox' },
                { id: 'numbering', name: 'Num√©rotation', icon: 'üî¢', description: 'Pr√©fixes et tranches de num√©ros' },
                { id: 'export-data', name: 'Export donn√©es', icon: 'üì§', description: 'Exporter toutes les donn√©es' },
                { id: 'import-data', name: 'Import donn√©es', icon: 'üì•', description: 'Importer des donn√©es' },
                { id: 'reset-data', name: 'R√©initialiser', icon: 'üóëÔ∏è', description: 'R√©initialiser les donn√©es', danger: true },
                { id: 'users', name: 'Gestion utilisateurs', icon: 'üë•', description: 'G√©rer les utilisateurs', adminOnly: true }
            ]
        };

        // Donn√©es des utilisateurs
        let UsersData = {
            users: JSON.parse(localStorage.getItem('trakio_users') || '[]'),
            currentUser: JSON.parse(localStorage.getItem('trakio_current_user') || 'null'),
            connectionLogs: JSON.parse(localStorage.getItem('trakio_connection_logs') || '[]')
        };
        
        // Timer de d√©connexion automatique (1h = 3600000ms)
        let autoLogoutTimer = null;
        const AUTO_LOGOUT_DELAY = 60 * 60 * 1000; // 1 heure
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üîê SYST√àME DE LOGIN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function populateLoginUsersList() {
            const select = document.getElementById('login-user-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">S√©lectionnez...</option>';
            UsersData.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name + (user.role === 'admin' ? ' üëë' : '');
                select.appendChild(option);
            });
        }
        
        function updateLoginAvatar() {
            const select = document.getElementById('login-user-select');
            const userId = parseInt(select.value);
            // Focus sur le PIN apr√®s s√©lection
            if (userId) {
                document.getElementById('login-pin-input').focus();
            }
        }
        
        function togglePinVisibility() {
            const input = document.getElementById('login-pin-input');
            const icon = document.getElementById('pin-eye-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
            } else {
                input.type = 'password';
                icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
            }
        }
        
        function attemptLogin() {
            const select = document.getElementById('login-user-select');
            const pinInput = document.getElementById('login-pin-input');
            const errorDiv = document.getElementById('login-error');
            
            const userId = parseInt(select.value);
            const pin = pinInput.value;
            
            if (!userId) {
                errorDiv.innerHTML = '<span style="color:#ff6b6b; font-size:13px; font-weight:500;">‚ö†Ô∏è S√©lectionnez un utilisateur</span>';
                errorDiv.style.display = 'block';
                return;
            }
            
            const user = UsersData.users.find(u => u.id === userId);
            if (!user) {
                errorDiv.innerHTML = '<span style="color:#ff6b6b; font-size:13px; font-weight:500;">‚ùå Utilisateur introuvable</span>';
                errorDiv.style.display = 'block';
                return;
            }
            
            // V√©rifier le PIN
            if (user.pin !== pin) {
                errorDiv.innerHTML = '<span style="color:#ff6b6b; font-size:13px; font-weight:500;">‚ùå Code PIN incorrect</span>';
                errorDiv.style.display = 'block';
                pinInput.value = '';
                pinInput.focus();
                
                // Log de tentative √©chou√©e
                logConnection(user.name, 'failed');
                return;
            }
            
            // Connexion r√©ussie !
            errorDiv.style.display = 'none';
            UsersData.currentUser = user;
            localStorage.setItem('trakio_current_user', JSON.stringify(user));
            localStorage.setItem('trakio_session_start', Date.now().toString());
            
            // Log de connexion
            logConnection(user.name, 'login');
            
            // Masquer l'√©cran de login
            document.getElementById('login-screen').style.display = 'none';
            
            // D√©marrer le timer de d√©connexion auto
            startAutoLogoutTimer();
            
            // Mettre √† jour l'interface
            updateUserInterface();
            applyUserPermissions();
            
            // SI ADMIN: Publier automatiquement la version sur Dropbox
            if (user.role === 'admin' || user.isAdmin) {
                setTimeout(() => autoPublishVersionIfAdmin(), 2000);
            }
            
            // Message de bienvenue
            showToast('üëã Bienvenue ' + user.name + ' !', 'success');
        }
        
        function logConnection(userName, type) {
            const now = new Date();
            const log = {
                user: userName,
                type: type, // 'login', 'logout', 'auto_logout', 'failed'
                date: now.toISOString().split('T')[0],
                time: now.toTimeString().split(' ')[0].substring(0, 5),
                timestamp: now.toISOString()
            };
            
            UsersData.connectionLogs.unshift(log);
            
            // Garder les 500 derniers logs
            if (UsersData.connectionLogs.length > 500) {
                UsersData.connectionLogs = UsersData.connectionLogs.slice(0, 500);
            }
            
            localStorage.setItem('trakio_connection_logs', JSON.stringify(UsersData.connectionLogs));
        }
        
        function startAutoLogoutTimer() {
            // Annuler le timer pr√©c√©dent
            if (autoLogoutTimer) clearTimeout(autoLogoutTimer);
            
            // Nouveau timer
            autoLogoutTimer = setTimeout(() => {
                autoLogout();
            }, AUTO_LOGOUT_DELAY);
            
            // R√©initialiser le timer sur activit√©
            document.addEventListener('click', resetAutoLogoutTimer);
            document.addEventListener('keypress', resetAutoLogoutTimer);
            document.addEventListener('touchstart', resetAutoLogoutTimer);
        }
        
        function resetAutoLogoutTimer() {
            if (UsersData.currentUser) {
                localStorage.setItem('trakio_session_start', Date.now().toString());
                if (autoLogoutTimer) clearTimeout(autoLogoutTimer);
                autoLogoutTimer = setTimeout(() => {
                    autoLogout();
                }, AUTO_LOGOUT_DELAY);
            }
        }
        
        function autoLogout() {
            if (UsersData.currentUser) {
                logConnection(UsersData.currentUser.name, 'auto_logout');
                performLogout('‚è∞ Session expir√©e apr√®s 1h d\'inactivit√©');
            }
        }
        
        function logout() {
            if (UsersData.currentUser) {
                logConnection(UsersData.currentUser.name, 'logout');
                performLogout('üëã D√©connexion r√©ussie');
            }
        }
        
        function performLogout(message) {
            // Nettoyer
            UsersData.currentUser = null;
            localStorage.removeItem('trakio_current_user');
            localStorage.removeItem('trakio_session_start');
            
            if (autoLogoutTimer) clearTimeout(autoLogoutTimer);
            
            // Afficher l'√©cran de login
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-pin-input').value = '';
            document.getElementById('login-error').style.display = 'none';
            
            if (message) {
                showToast(message, 'info');
            }
        }
        
        function showToast(message, type = 'info') {
>>>>>>> parent of 327a79d (Update index.html)
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'toastSlide 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============================================
        // STOCKAGE LOCAL
        // ============================================

        function saveToLocalStorage() {
            localStorage.setItem('trakio_compta', JSON.stringify({
                charges: state.charges,
                postes: state.postes,
                fournisseurs: state.fournisseurs,
                budgets: state.budgets,
                lastSync: state.lastSync
            }));
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem('trakio_compta');
            if (data) {
                const parsed = JSON.parse(data);
                state.charges = parsed.charges || [];
                state.postes = parsed.postes || [];
                state.fournisseurs = parsed.fournisseurs || [];
                state.budgets = parsed.budgets || {};
                state.lastSync = parsed.lastSync;
            }
        }

        // ============================================
        // SYNCHRONISATION DROPBOX
        // ============================================

        function startSync() {
            // Sync imm√©diate
            syncWithDropbox();
            
            // Sync p√©riodique
            setInterval(syncWithDropbox, CONFIG.SYNC_INTERVAL);
        }

        async function syncWithDropbox() {
            const status = document.getElementById('syncStatus');
            status.classList.add('syncing');
            status.innerHTML = '<i class="fas fa-sync"></i><span>Synchronisation...</span>';

            try {
                // TODO: Impl√©menter la vraie sync Dropbox
                // Pour l'instant, simulation
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                state.lastSync = new Date().toISOString();
                saveToLocalStorage();

                status.classList.remove('syncing');
                status.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><span>Synchronis√©</span>';
            } catch (error) {
                console.error('Sync error:', error);
                status.classList.remove('syncing');
                status.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Erreur sync</span>';
            }
        }

<<<<<<< HEAD
        // ============================================
        // RENDU GLOBAL
        // ============================================
=======
        // Products Management
        function openQOProductsModal() {
            renderQOProductsTable();
            document.getElementById('qo-products-modal').style.display = 'flex';
        }

        function closeQOProductsModal() { document.getElementById('qo-products-modal').style.display = 'none'; }

        function renderQOProductsTable(filter = '', catFilter = '') {
            const tbody = document.getElementById('qo-products-tbody');
            let products = QOData.products;

            // Filtrer par recherche
            if (filter) {
                const q = filter.toLowerCase();
                products = products.filter(p =>
                    p.code.toLowerCase().includes(q) ||
                    p.name.toLowerCase().includes(q)
                );
            }

            // Filtrer par cat√©gorie
            if (catFilter) {
                products = products.filter(p => p.category === catFilter);
            }

            document.getElementById('qo-products-count').textContent = `(${products.length}/${QOData.products.length} produits)`;

            tbody.innerHTML = products.map(p => `
                <tr style="${!p.active ? 'opacity:0.5;' : ''}">
                    <td><strong style="color:var(--accent-orange);">${p.code}</strong></td>
                    <td>${p.name}</td>
                    <td>${getCategoryIcon(p.category)} ${p.category || '-'}</td>
                    <td style="font-family:'Space Mono',monospace; color:var(--accent-warning);">${(p.priceB2C || 0).toFixed(2)}</td>
                    <td style="font-family:'Space Mono',monospace; color:var(--accent-secondary);">${(p.priceB2B || 0).toFixed(2)}</td>
                    <td>${p.unit}</td>
                    <td>${p.active ? '‚úÖ' : '‚ùå'}</td>
                    <td>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="editQOProduct(${p.id})">‚úèÔ∏è</button>
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px; color:var(--accent-danger);" onclick="deleteQOProduct(${p.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterQOProductsTable(query) {
            const catFilter = document.getElementById('qo-prod-cat-filter').value;
            renderQOProductsTable(query, catFilter);
        }

        function showQOProductForm() {
            document.getElementById('qo-product-form').style.display = 'block';
            document.getElementById('qo-prod-edit-id').value = '';
            document.getElementById('qo-prod-code').value = '';
            document.getElementById('qo-prod-name').value = '';
            document.getElementById('qo-prod-price-b2c').value = '';
            document.getElementById('qo-prod-price-b2b').value = '';
            document.getElementById('qo-prod-cost').value = '';
            document.getElementById('qo-prod-unit').value = 'kg';
            document.getElementById('qo-prod-cat').value = 'poisson';
            document.getElementById('qo-prod-active').checked = true;
        }

        function hideQOProductForm() { document.getElementById('qo-product-form').style.display = 'none'; }

        function editQOProduct(id) {
            const p = QOData.products.find(x => x.id === id);
            if (!p) return;

            document.getElementById('qo-product-form').style.display = 'block';
            document.getElementById('qo-prod-edit-id').value = id;
            document.getElementById('qo-prod-code').value = p.code;
            document.getElementById('qo-prod-name').value = p.name;
            document.getElementById('qo-prod-price-b2c').value = p.priceB2C || '';
            document.getElementById('qo-prod-price-b2b').value = p.priceB2B || '';
            document.getElementById('qo-prod-cost').value = p.cost || '';
            document.getElementById('qo-prod-unit').value = p.unit;
            document.getElementById('qo-prod-cat').value = p.category || 'poisson';
            document.getElementById('qo-prod-active').checked = p.active;
        }

        function saveQOProduct() {
            const id = document.getElementById('qo-prod-edit-id').value;
            const priceB2C = parseFloat(document.getElementById('qo-prod-price-b2c').value) || 0;
            const priceB2B = parseFloat(document.getElementById('qo-prod-price-b2b').value) || 0;

            const product = {
                id: id ? parseInt(id) : Date.now(),
                code: document.getElementById('qo-prod-code').value.trim(),
                name: document.getElementById('qo-prod-name').value.trim(),
                category: document.getElementById('qo-prod-cat').value,
                priceB2C: priceB2C,
                priceB2B: priceB2B || priceB2C * 0.8, // Par d√©faut -20% si pas de B2B
                cost: parseFloat(document.getElementById('qo-prod-cost').value) || 0,
                unit: document.getElementById('qo-prod-unit').value,
                lot: '',
                active: document.getElementById('qo-prod-active').checked
            };

            if (!product.code || !product.name) {
                alert('Code et d√©signation requis');
                return;
            }

            if (id) {
                const index = QOData.products.findIndex(p => p.id === parseInt(id));
                if (index !== -1) QOData.products[index] = product;
            } else {
                QOData.products.push(product);
            }

            saveQOData('products');
            hideQOProductForm();
            renderQOProductsTable();
        }

        function deleteQOProduct(id) {
            if (!confirm('Supprimer ce produit ?')) return;
            QOData.products = QOData.products.filter(p => p.id !== id);
            saveQOData('products');
            renderQOProductsTable();
        }

        // Import Lightspeed (B2C)
        function importQOLightspeed(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n').filter(l => l.trim());
                const header = lines[0].split(';');

                // Trouver les index des colonnes
                const colSKU = header.findIndex(h => h.toLowerCase().includes('sku') && !h.toLowerCase().includes('parent'));
                const colNom = header.findIndex(h => h.toLowerCase().includes('nom') && !h.toLowerCase().includes('bouton'));
                const colType = header.findIndex(h => h.toLowerCase().includes('type'));
                const colPrix = header.findIndex(h => h.toLowerCase().includes('prix par d√©faut') || h.toLowerCase().includes('prix'));
                const colDept = header.findIndex(h => h.toLowerCase().includes('d√©partement'));
                const colCost = header.findIndex(h => h.toLowerCase().includes('prix de revient') || h.toLowerCase().includes('cost'));

                let added = 0, updated = 0;

                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(';');
                    const sku = cols[colSKU]?.trim();
                    const nom = cols[colNom]?.trim();
                    const type = cols[colType]?.trim().toLowerCase();
                    const prix = parseFloat(cols[colPrix]) || 0;
                    const dept = cols[colDept]?.trim().toUpperCase() || '';
                    const cost = parseFloat(cols[colCost]) || 0;

                    // Seulement les articles avec nom
                    if (type !== 'article' || !nom || !sku) continue;

                    // D√©terminer cat√©gorie
                    let cat = 'autre';
                    if (dept.includes('CRUSTACE')) cat = 'crustace';
                    else if (dept.includes('COQUILLAGE')) cat = 'coquillage';
                    else if (dept.includes('POISSONS FRAIS')) cat = 'poisson';
                    else if (dept.includes('FUME')) cat = 'fume';
                    else if (dept.includes('CONSERVE')) cat = 'conserve';
                    else if (dept.includes('PREPARATION') || dept.includes('EPICERIE')) cat = 'preparation';
                    else if (dept.includes('SURGELE')) cat = 'surgele';

                    // Chercher si existe d√©j√†
                    const existing = QOData.products.find(p => p.code === sku);
                    if (existing) {
                        existing.name = nom;
                        existing.priceB2C = prix;
                        existing.cost = cost || existing.cost;
                        existing.category = cat;
                        existing.active = prix > 0;
                        updated++;
                    } else {
                        QOData.products.push({
                            id: Date.now() + i,
                            code: sku,
                            name: nom,
                            category: cat,
                            priceB2C: prix,
                            priceB2B: 0,
                            cost: cost,
                            unit: 'kg',
                            lot: '',
                            active: prix > 0
                        });
                        added++;
                    }
                }

                saveQOData('products');
                renderQOProductsTable();
                alert(`Import Lightspeed B2C termin√© !\n\n‚úÖ ${added} produits ajout√©s\nüîÑ ${updated} produits mis √† jour`);
            };
            reader.readAsText(file);
            input.value = '';
        }

        // Import Infoniqa/Sage (B2B)
        function importQOInfoniqa(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                // D√©tecter le s√©parateur
                const sep = content.includes(';') ? ';' : ',';
                const lines = content.split('\n').filter(l => l.trim());
                const header = lines[0].split(sep).map(h => h.toLowerCase().trim());

                // Trouver les index des colonnes (adapter selon format Infoniqa)
                const colCode = header.findIndex(h => h.includes('code') || h.includes('article') || h.includes('sku') || h.includes('num√©ro'));
                const colNom = header.findIndex(h => h.includes('d√©signation') || h.includes('nom') || h.includes('libell√©'));
                const colPrix = header.findIndex(h => h.includes('prix') || h.includes('tarif'));

                if (colCode < 0 || colPrix < 0) {
                    alert('Format non reconnu. Colonnes requises: Code/Article et Prix');
                    return;
                }

                let updated = 0, notFound = 0;

                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(sep);
                    const code = cols[colCode]?.trim();
                    const prix = parseFloat(cols[colPrix]?.replace(',', '.')) || 0;

                    if (!code || prix <= 0) continue;

                    // Chercher le produit existant par code
                    const existing = QOData.products.find(p => p.code === code);
                    if (existing) {
                        existing.priceB2B = prix;
                        updated++;
                    } else {
                        notFound++;
                    }
                }

                saveQOData('products');
                renderQOProductsTable();
                alert(`Import Infoniqa B2B termin√© !\n\nüîÑ ${updated} prix B2B mis √† jour\n‚ö†Ô∏è ${notFound} codes non trouv√©s`);
            };
            reader.readAsText(file);
            input.value = '';
        }

        // Export produits CSV
        function exportQOProductsCSV() {
            const headers = ['Code', 'D√©signation', 'Cat√©gorie', 'Prix B2C', 'Prix B2B', 'Co√ªt', 'Unit√©', 'Actif'];
            const rows = QOData.products.map(p => [
                p.code, p.name, p.category, p.priceB2C, p.priceB2B, p.cost || 0, p.unit, p.active ? 'Oui' : 'Non'
            ].map(v => `"${v}"`).join(';'));

            const csv = [headers.join(';'), ...rows].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'produits_export_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
        }

        // R√©initialiser produits
        function resetQOProductsToDefault() {
            if (!confirm('‚ö†Ô∏è R√©initialiser la base produits ?\n\nCette action remplacera tous les produits actuels.')) return;
            loadQODefaultProducts();
            renderQOProductsTable();
            alert('‚úÖ Base produits r√©initialis√©e !');
        }

        // =====================================================
        // MODULE CLIENTS (page d√©di√©e)
        // =====================================================
        function initClientsModule() {
            // S'assurer que les donn√©es clients sont charg√©es
            if (!QOData.clients || QOData.clients.length === 0) {
                const saved = localStorage.getItem('qo_clients');
                if (saved) {
                    QOData.clients = JSON.parse(saved);
                }
                // Si toujours vide, charger les clients par d√©faut
                if (!QOData.clients || QOData.clients.length < 50) {
                    loadQODefaultClients();
                }
            }
            // Charger ArticlesData si pas encore fait
            if (!ArticlesData || !ArticlesData.pricelists) {
                loadArticlesData();
            }
            updateClientPricelistSelect();
            renderClientsTable();
        }

        function updateClientPricelistSelect() {
            const sel = document.getElementById('clients-pricelist');
            if (sel && typeof ArticlesData !== 'undefined') {
                sel.innerHTML = '<option value="">-- Standard --</option>' +
                    (ArticlesData.pricelists || []).map(p =>
                        `<option value="${p.id}">${p.name} (-${p.discount}%)</option>`
                    ).join('');
            }
        }

        function renderClientsTable(filter = '', typeFilter = '') {
            let clients = QOData.clients || [];

            // Filtrer par recherche
            if (filter) {
                const q = filter.toLowerCase();
                clients = clients.filter(c =>
                    (c.name && c.name.toLowerCase().includes(q)) ||
                    (c.lastname && c.lastname.toLowerCase().includes(q)) ||
                    (c.firstname && c.firstname.toLowerCase().includes(q)) ||
                    (c.contact && c.contact.toLowerCase().includes(q)) ||
                    (c.city && c.city.toLowerCase().includes(q)) ||
                    (c.phone && c.phone.includes(q)) ||
                    (c.mobile && c.mobile.includes(q)) ||
                    (c.email && c.email.toLowerCase().includes(q)) ||
                    (c.num && c.num.includes(q))
                );
            }

            // Filtrer par type
            if (typeFilter) {
                clients = clients.filter(c => (c.clientType || 'b2b').toLowerCase() === typeFilter.toLowerCase());
            }

            // Stats
            const allClients = QOData.clients || [];
            const b2bCount = allClients.filter(c => (c.clientType || 'b2b').toLowerCase() === 'b2b').length;
            const b2cCount = allClients.filter(c => (c.clientType || '').toLowerCase() === 'b2c').length;
            const activeCount = allClients.filter(c => c.ordersCount > 0).length;

            document.getElementById('clients-total').textContent = allClients.length;
            document.getElementById('clients-b2b-count').textContent = b2bCount;
            document.getElementById('clients-b2c-count').textContent = b2cCount;
            document.getElementById('clients-active').textContent = activeCount;

            const tbody = document.getElementById('clients-tbody');
            tbody.innerHTML = clients.slice(0, 200).map(c => {
                const type = (c.clientType || 'b2b').toLowerCase();
                const typeIcon = type === 'b2c' ? 'üè†' : 'üè¢';
                const typeColor = type === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)';
                const typeLabel = type === 'b2c' ? 'Part.' : 'Pro';
                // Nom : pour B2B c'est name, pour B2C c'est lastname + firstname
                const displayName = c.name || `${c.lastname || ''} ${c.firstname || ''}`.trim() || '-';
                const displayContact = c.contact || (c.name ? `${c.lastname || ''} ${c.firstname || ''}`.trim() : '') || '-';
                const pricelist = c.pricelistId && typeof ArticlesData !== 'undefined' ?
                    ArticlesData.pricelists?.find(p => p.id === c.pricelistId) : null;
                return `
                <tr style="cursor:pointer;" onclick="showClientActionModal(${c.id})" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                    <td><strong style="color:var(--accent-orange);">${c.num || c.id}</strong></td>
                    <td><span style="padding:4px 10px; background:${typeColor}20; color:${typeColor}; border-radius:20px; font-size:11px; white-space:nowrap;">${typeIcon} ${typeLabel}</span></td>
                    <td><strong style="color:var(--accent-primary);">${displayName}</strong></td>
                    <td>${displayContact}</td>
                    <td>${c.city || '-'}</td>
                    <td onclick="event.stopPropagation()">${pricelist ? `<span onclick="goToPricelistFromClient(${pricelist.id})" style="padding:4px 8px; background:var(--accent-warning)20; color:var(--accent-warning); border-radius:12px; font-size:11px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='var(--accent-warning)'; this.style.color='#000'" onmouseout="this.style.background='var(--accent-warning)20'; this.style.color='var(--accent-warning)'">${pricelist.name} (-${pricelist.discount}%)</span>` : '<span style="color:var(--text-muted);">Standard</span>'}</td>
                    <td>${c.phone || c.mobile || '-'}</td>
                    <td onclick="event.stopPropagation()">
                        <div style="display:flex; gap:6px;">
                            <button class="btn btn-primary" style="padding:6px 10px; font-size:12px;" onclick="startOrderFromClient(${c.id})" title="Nouvelle commande">‚ö°</button>
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="editClientPage(${c.id})" title="Modifier">‚úèÔ∏è</button>
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="toggleClientType(${c.id})">${type === 'b2c' ? 'üè¢' : 'üè†'}</button>
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px; color:var(--accent-danger);" onclick="deleteClientPage(${c.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `}).join('') || '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">Aucun client trouv√©</td></tr>';
        }

        // Modal action client
        function showClientActionModal(clientId) {
            const client = QOData.clients.find(c => c.id === clientId);
            if (!client) return;

            const type = client.clientType || 'b2b';
            const typeIcon = type === 'b2c' ? 'üè†' : 'üè¢';
            const typeLabel = type === 'b2c' ? 'Particulier' : 'Professionnel';
            const pricelist = client.pricelistId && typeof ArticlesData !== 'undefined' ?
                ArticlesData.pricelists?.find(p => p.id === client.pricelistId) : null;

            const modal = document.getElementById('client-action-modal');
            document.getElementById('client-action-name').textContent = client.name;
            document.getElementById('client-action-info').innerHTML = `
                <span style="padding:4px 10px; background:${type === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)'}20; color:${type === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)'}; border-radius:20px; font-size:12px;">${typeIcon} ${typeLabel}</span>
                ${pricelist ? `<span style="padding:4px 10px; background:var(--accent-warning)20; color:var(--accent-warning); border-radius:20px; font-size:12px; margin-left:8px;">üí∞ ${pricelist.name}</span>` : ''}
            `;
            document.getElementById('client-action-details').innerHTML = `
                <div style="font-size:13px; color:var(--text-muted);">
                    ${client.address ? `üìç ${client.address}, ${client.zip} ${client.city}` : ''}
                    ${client.phone ? `<br>üìû ${client.phone}` : ''}
                    ${client.email ? `<br>‚úâÔ∏è ${client.email}` : ''}
                </div>
            `;
            modal.dataset.clientId = clientId;
            modal.style.display = 'flex';
        }

        function closeClientActionModal() {
            document.getElementById('client-action-modal').style.display = 'none';
        }

        function startOrderFromClient(clientId) {
            closeClientActionModal();
            navigateTo('quickorder');
            setTimeout(() => {
                selectQOClient(clientId);
            }, 200);
        }

        function editClientFromModal() {
            const clientId = parseInt(document.getElementById('client-action-modal').dataset.clientId);
            closeClientActionModal();
            editClientPage(clientId);
        }

        // Naviguer vers la liste de prix depuis Clients
        function goToPricelistFromClient(pricelistId) {
            navigateTo('articles');
            setTimeout(() => {
                switchArtTab('pricelists');
                setTimeout(() => showPricelistClients(pricelistId), 200);
            }, 100);
        }

        function filterClientsPage(query) {
            const typeFilter = document.getElementById('clients-type-filter').value;
            renderClientsTable(query, typeFilter);
        }

        function showClientsForm() {
            document.getElementById('clients-form').style.display = 'block';
            document.getElementById('clients-edit-id').value = '';
            document.getElementById('clients-num').value = '';
            document.getElementById('clients-name').value = '';
            document.getElementById('clients-contact').value = '';
            document.getElementById('clients-type').value = 'b2b';
            document.getElementById('clients-address').value = '';
            document.getElementById('clients-address2').value = '';
            document.getElementById('clients-zip').value = '';
            document.getElementById('clients-city').value = '';
            document.getElementById('clients-phone').value = '';
            document.getElementById('clients-mobile').value = '';
            document.getElementById('clients-email').value = '';
            document.getElementById('clients-credit').value = '';
            document.getElementById('clients-payment').value = '30 jours fin de mois';
            document.getElementById('clients-pricelist').value = '';
            document.getElementById('clients-form').scrollIntoView({ behavior: 'smooth' });
        }

        function hideClientsForm() {
            document.getElementById('clients-form').style.display = 'none';
        }

        function editClientPage(id) {
            const c = QOData.clients.find(x => x.id === id);
            if (!c) return;

            document.getElementById('clients-form').style.display = 'block';
            document.getElementById('clients-edit-id').value = id;
            document.getElementById('clients-num').value = c.num || '';
            document.getElementById('clients-name').value = c.name || '';
            document.getElementById('clients-contact').value = c.contact || '';
            document.getElementById('clients-type').value = c.clientType || 'b2b';
            document.getElementById('clients-address').value = c.address || '';
            document.getElementById('clients-address2').value = c.address2 || '';
            document.getElementById('clients-zip').value = c.zip || '';
            document.getElementById('clients-city').value = c.city || '';
            document.getElementById('clients-phone').value = c.phone || '';
            document.getElementById('clients-mobile').value = c.mobile || '';
            document.getElementById('clients-email').value = c.email || '';
            document.getElementById('clients-credit').value = c.credit || '';
            document.getElementById('clients-payment').value = c.payment || '30 jours fin de mois';
            document.getElementById('clients-pricelist').value = c.pricelistId || '';
            document.getElementById('clients-form').scrollIntoView({ behavior: 'smooth' });
        }

        function saveClientForm() {
            const id = document.getElementById('clients-edit-id').value;
            const client = {
                id: id ? parseInt(id) : Date.now(),
                num: document.getElementById('clients-num').value.trim() || String(Date.now()).slice(-6),
                name: document.getElementById('clients-name').value.trim(),
                contact: document.getElementById('clients-contact').value.trim(),
                clientType: document.getElementById('clients-type').value,
                address: document.getElementById('clients-address').value.trim(),
                address2: document.getElementById('clients-address2').value.trim(),
                zip: document.getElementById('clients-zip').value.trim(),
                city: document.getElementById('clients-city').value.trim(),
                phone: document.getElementById('clients-phone').value.trim(),
                mobile: document.getElementById('clients-mobile').value.trim(),
                email: document.getElementById('clients-email').value.trim(),
                credit: parseFloat(document.getElementById('clients-credit').value) || 0,
                payment: document.getElementById('clients-payment').value,
                pricelistId: parseInt(document.getElementById('clients-pricelist').value) || null,
                ordersCount: 0,
                history: []
            };

            if (!client.name) {
                alert('Le nom/soci√©t√© est requis');
                return;
            }

            if (id) {
                const index = QOData.clients.findIndex(c => c.id === parseInt(id));
                if (index !== -1) {
                    client.ordersCount = QOData.clients[index].ordersCount || 0;
                    client.history = QOData.clients[index].history || [];
                    QOData.clients[index] = client;
                }
            } else {
                QOData.clients.push(client);
            }

            saveQOData('clients');

            // Upload sur Dropbox si configur√©
            if (DropboxConfig.canSync()) {
                saveClientToDropbox(client);
            }

            hideClientsForm();
            renderClientsTable();
        }

        function deleteClientPage(id) {
            if (!confirm('Supprimer ce client ?')) return;
            QOData.clients = QOData.clients.filter(c => c.id !== id);
            saveQOData('clients');
            renderClientsTable();
        }

        function toggleClientType(id) {
            const client = QOData.clients.find(c => c.id === id);
            if (!client) return;
            client.clientType = (client.clientType || 'b2b') === 'b2c' ? 'b2b' : 'b2c';
            saveQOData('clients');
            renderClientsTable(document.getElementById('clients-search').value, document.getElementById('clients-type-filter').value);
        }

        function exportAllClientsCSV() {
            const headers = ['Num√©ro', 'Type', 'Nom', 'Contact', 'Adresse', 'Code postal', 'Ville', 'T√©l√©phone', 'Mobile', 'Email', 'Cr√©dit', '√âch√©ance', 'Commandes'];
            const rows = QOData.clients.map(c => [
                c.num, c.clientType || 'b2b', c.name, c.contact || '', c.address || '', c.zip || '', c.city || '', c.phone || '', c.mobile || '', c.email || '', c.credit || 0, c.payment || '', c.ordersCount || 0
            ].map(v => `"${v}"`).join(';'));

            const csv = [headers.join(';'), ...rows].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'clients_export_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
        }

        // Variable pour stocker le mode d'import s√©lectionn√©
        let clientsImportMode = 'replace';
        
        function showImportClientsModal() {
            document.getElementById('import-current-count').textContent = QOData.clients.length;
            selectImportMode('replace'); // Mode par d√©faut
            document.getElementById('import-clients-modal').style.display = 'flex';
        }
        
        function closeImportClientsModal() {
            document.getElementById('import-clients-modal').style.display = 'none';
        }
        
        function selectImportMode(mode) {
            clientsImportMode = mode;
            
            const replaceDiv = document.getElementById('import-mode-replace');
            const updateDiv = document.getElementById('import-mode-update');
            const checkReplace = document.getElementById('import-check-replace');
            const checkUpdate = document.getElementById('import-check-update');
            
            if (mode === 'replace') {
                replaceDiv.style.border = '2px solid var(--accent-primary)';
                replaceDiv.querySelector('div > div').style.background = 'var(--accent-primary)';
                checkReplace.style.display = 'flex';
                
                updateDiv.style.border = '2px solid var(--border-color)';
                updateDiv.querySelector('div > div').style.background = 'var(--bg-hover)';
                checkUpdate.style.display = 'none';
            } else {
                updateDiv.style.border = '2px solid var(--accent-primary)';
                updateDiv.querySelector('div > div').style.background = 'var(--accent-primary)';
                checkUpdate.style.display = 'flex';
                
                replaceDiv.style.border = '2px solid var(--border-color)';
                replaceDiv.querySelector('div > div').style.background = 'var(--bg-hover)';
                checkReplace.style.display = 'none';
            }
        }
        
        function confirmImportClients() {
            closeImportClientsModal();
            document.getElementById('clients-import-file').click();
        }

        function importClientsFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                let content = fixEncoding(e.target.result);
                const sep = content.includes(';') ? ';' : ',';
                const lines = content.split('\n').filter(l => l.trim());

                let added = 0;
                let updated = 0;
                let deleted = 0;
                
                // Mode "Remplacer tout" : vider les clients existants
                if (clientsImportMode === 'replace') {
                    deleted = QOData.clients.length;
                    QOData.clients = [];
                }
                
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(sep).map(c => c.replace(/"/g, '').trim());
                    if (cols.length >= 2 && cols[1]) {
                        const clientNum = cols[0] || '';
                        const clientName = cols[1] || cols[2] || 'Client import√©';
                        
                        // Chercher si le client existe d√©j√† (par num√©ro ou par nom)
                        let existingIndex = -1;
                        if (clientsImportMode === 'update') {
                            if (clientNum) {
                                existingIndex = QOData.clients.findIndex(c => c.num === clientNum);
                            }
                            if (existingIndex === -1) {
                                existingIndex = QOData.clients.findIndex(c => 
                                    c.name.toLowerCase().trim() === clientName.toLowerCase().trim()
                                );
                            }
                        }
                        
                        const clientData = {
                            num: clientNum || String(Date.now() + i).slice(-6),
                            name: clientName,
                            contact: cols[3] || '',
                            clientType: (cols[1] || '').toLowerCase().includes('b2c') ? 'b2c' : 'b2b',
                            address: cols[4] || '',
                            address2: cols[5] || '',
                            zip: cols[6] || '',
                            city: cols[7] || '',
                            phone: cols[8] || '',
                            mobile: cols[9] || '',
                            email: cols[10] || '',
                            credit: parseFloat(cols[11]) || 0,
                            payment: cols[12] || '30 jours fin de mois'
                        };
                        
                        if (existingIndex !== -1) {
                            // Mettre √† jour le client existant (garder id, ordersCount, history)
                            QOData.clients[existingIndex] = {
                                ...QOData.clients[existingIndex],
                                ...clientData
                            };
                            updated++;
                        } else {
                            // Ajouter nouveau client
                            QOData.clients.push({
                                id: Date.now() + i,
                                ...clientData,
                                ordersCount: 0,
                                history: []
                            });
                            added++;
                        }
                    }
                }

                saveQOData('clients');
                renderClientsTable();
                
                // Message selon le mode
                let message = '‚úÖ Import termin√© !\n\n';
                if (clientsImportMode === 'replace') {
                    message += `üóëÔ∏è ${deleted} anciens clients supprim√©s\n`;
                    message += `üì• ${added} clients import√©s`;
                } else {
                    message += `üì• ${added} clients ajout√©s\n`;
                    message += `üîÑ ${updated} clients mis √† jour`;
                }
                alert(message);
            };
            reader.readAsText(file, 'ISO-8859-1');
            input.value = '';
        }

        // =====================================================
        // MODULE ARTICLES
        // =====================================================

        function loadArticlesData() {
            const saved = localStorage.getItem('trakio_articles');
            if (saved) {
                const parsed = JSON.parse(saved);
                ArticlesData = { ...ArticlesData, ...parsed };
            }
            if (!ArticlesData.articles || ArticlesData.articles.length === 0) {
                loadDefaultArticles();
            }
        }

        function saveArticlesData(key) {
            localStorage.setItem('trakio_articles', JSON.stringify(ArticlesData));
            // Sync automatique vers Dropbox si activ√©
            if (DropboxConfig.autoSync && DropboxConfig.connected && !DropboxSync.isSyncing) {
                syncToDropbox('articles');
            }
        }

        function loadDefaultArticles() {
            ArticlesData.articles = [
                { id: 1, num: '001', name: 'Filet de perches du L√©man', latin: 'Perca fluviatilis', categoryId: 1, origin: 'Suisse', lot: '', pcs: 1, unit: 'kg', priceB2C: 80.00, priceB2B: 65.00, cost: 45.00, tva: 2.6, active: true },
                { id: 2, num: '002', name: 'Filet de f√©ra', latin: 'Coregonus fera', categoryId: 1, origin: 'Lac L√©man', lot: '', pcs: 1, unit: 'kg', priceB2C: 55.00, priceB2B: 45.00, cost: 32.00, tva: 2.6, active: true },
                { id: 3, num: '003', name: 'Omble chevalier entier', latin: 'Salvelinus alpinus', categoryId: 1, origin: 'Suisse', lot: '', pcs: 1, unit: 'kg', priceB2C: 48.00, priceB2B: 38.00, cost: 28.00, tva: 2.6, active: true },
                { id: 4, num: '004', name: 'Truite arc-en-ciel', latin: 'Oncorhynchus mykiss', categoryId: 1, origin: 'Suisse', lot: '', pcs: 1, unit: 'kg', priceB2C: 22.00, priceB2B: 18.00, cost: 12.00, tva: 2.6, active: true },
                { id: 5, num: '005', name: 'Bar de ligne', latin: 'Dicentrarchus labrax', categoryId: 1, origin: 'FAO27', lot: '', pcs: 1, unit: 'kg', priceB2C: 65.00, priceB2B: 52.00, cost: 38.00, tva: 2.6, active: true },
                { id: 6, num: '006', name: 'Dorade royale', latin: 'Sparus aurata', categoryId: 1, origin: 'M√©diterran√©e', lot: '', pcs: 1, unit: 'kg', priceB2C: 32.00, priceB2B: 26.00, cost: 18.00, tva: 2.6, active: true },
                { id: 7, num: '010', name: 'Crevettes roses cuites', latin: 'Penaeus vannamei', categoryId: 2, origin: '√âquateur', lot: '', pcs: 1, unit: 'kg', priceB2C: 28.00, priceB2B: 22.00, cost: 15.00, tva: 2.6, active: true },
                { id: 8, num: '011', name: 'Gambas crues 16/20', latin: 'Penaeus monodon', categoryId: 2, origin: 'Madagascar', lot: '', pcs: 16, unit: 'kg', priceB2C: 38.00, priceB2B: 30.00, cost: 22.00, tva: 2.6, active: true },
                { id: 9, num: '012', name: 'Homard bleu vivant', latin: 'Homarus gammarus', categoryId: 2, origin: 'Bretagne', lot: '', pcs: 1, unit: 'pce', priceB2C: 75.00, priceB2B: 60.00, cost: 42.00, tva: 2.6, active: true },
                { id: 10, num: '020', name: 'Hu√Ætres Gillardeau n¬∞3', latin: 'Crassostrea gigas', categoryId: 3, origin: 'France', lot: '', pcs: 12, unit: 'dz', priceB2C: 36.00, priceB2B: 28.00, cost: 18.00, tva: 2.6, active: true },
                { id: 11, num: '021', name: 'Moules de bouchot', latin: 'Mytilus edulis', categoryId: 3, origin: 'Mont St-Michel', lot: '', pcs: 1, unit: 'kg', priceB2C: 8.50, priceB2B: 6.80, cost: 4.50, tva: 2.6, active: true },
                { id: 12, num: '022', name: 'Saint-Jacques avec corail', latin: 'Pecten maximus', categoryId: 3, origin: 'Normandie', lot: '', pcs: 1, unit: 'pce', priceB2C: 6.50, priceB2B: 5.20, cost: 3.50, tva: 2.6, active: true },
                { id: 13, num: '030', name: 'Saumon fum√© tranch√©', latin: 'Salmo salar', categoryId: 4, origin: '√âcosse', lot: '', pcs: 1, unit: 'kg', priceB2C: 58.00, priceB2B: 46.00, cost: 32.00, tva: 2.6, active: true },
                { id: 14, num: '031', name: 'Truite fum√©e filet', latin: 'Oncorhynchus mykiss', categoryId: 4, origin: 'Suisse', lot: '', pcs: 1, unit: 'kg', priceB2C: 48.00, priceB2B: 38.00, cost: 26.00, tva: 2.6, active: true },
                { id: 15, num: '050', name: 'Huile olive vierge extra', latin: '', categoryId: 8, origin: 'Espagne', lot: '', pcs: 1, unit: 'pce', priceB2C: 18.00, priceB2B: 14.00, cost: 9.00, tva: 2.6, active: true },
                { id: 16, num: '051', name: 'Citrons bio (filet 500g)', latin: '', categoryId: 8, origin: 'Sicile', lot: '', pcs: 1, unit: 'pce', priceB2C: 4.50, priceB2B: 3.50, cost: 2.00, tva: 2.6, active: true }
            ];
            saveArticlesData();
        }

        function initArticlesModule() {
            loadArticlesData();
            updateCategorySelects();
            updatePricelistSelects();
            renderArticlesTable();
            renderCategoriesGrid();
            renderPricelistsGrid();
            renderDiscountsGrid();
            updateArticleStats();
        }

        function switchArtTab(tabName) {
            document.querySelectorAll('.art-tab').forEach(t => {
                t.style.background = 'var(--bg-card)';
                t.style.color = 'var(--text-primary)';
                t.style.border = '1px solid var(--border-color)';
                t.classList.remove('active');
            });
            document.querySelectorAll('.art-tab-content').forEach(c => c.style.display = 'none');

            const activeTab = document.querySelector(`.art-tab[onclick*="${tabName}"]`);
            if (activeTab) {
                activeTab.style.background = 'var(--accent-primary)';
                activeTab.style.color = '#000';
                activeTab.style.border = 'none';
                activeTab.classList.add('active');
            }
            document.getElementById(`art-tab-${tabName}`).style.display = 'block';
        }

        function updateArticleStats() {
            document.getElementById('art-total').textContent = ArticlesData.articles.length;
            document.getElementById('art-categories-count').textContent = ArticlesData.categories.length;
            document.getElementById('art-pricelists-count').textContent = ArticlesData.pricelists.length;
            document.getElementById('art-discounts-count').textContent = ArticlesData.discounts.length;
        }

        function updateCategorySelects() {
            const options = '<option value="">-- Choisir --</option>' + ArticlesData.categories.map(c =>
                `<option value="${c.id}">${c.icon} ${c.name}</option>`
            ).join('');

            const artCat = document.getElementById('art-category');
            const discCat = document.getElementById('disc-category');
            const filterCat = document.getElementById('art-cat-filter');

            if (artCat) artCat.innerHTML = options;
            if (discCat) discCat.innerHTML = options;
            if (filterCat) filterCat.innerHTML = '<option value="">Toutes cat√©gories</option>' + ArticlesData.categories.map(c =>
                `<option value="${c.id}">${c.icon} ${c.name}</option>`
            ).join('');
        }

        function updatePricelistSelects() {
            const discPl = document.getElementById('disc-pricelist');
            if (discPl) {
                discPl.innerHTML = '<option value="">Toutes les listes</option>' + ArticlesData.pricelists.map(p =>
                    `<option value="${p.id}">${p.name} (${p.discount}%)</option>`
                ).join('');
            }
        }

        // === ARTICLES ===
        function renderArticlesTable() {
            let articles = ArticlesData.articles;
            const search = document.getElementById('art-search')?.value.toLowerCase() || '';
            const catFilter = document.getElementById('art-cat-filter')?.value || '';

            if (search) {
                articles = articles.filter(a =>
                    a.num.toLowerCase().includes(search) ||
                    a.name.toLowerCase().includes(search) ||
                    (a.latin && a.latin.toLowerCase().includes(search)) ||
                    (a.origin && a.origin.toLowerCase().includes(search)) ||
                    (a.barcode && a.barcode.toLowerCase().includes(search))
                );
            }
            if (catFilter) {
                articles = articles.filter(a => a.categoryId == catFilter);
            }

            const tbody = document.getElementById('art-tbody');
            tbody.innerHTML = articles.map(a => {
                const stock = a.stock || 0;
                const stockColor = stock <= 0 ? 'var(--accent-danger)' : stock < 10 ? 'var(--accent-warning)' : 'var(--accent-primary)';
                const unit = a.unit === 'kg' ? 'kg' : a.unit === 'pce' ? 'pce' : a.unit;
                return `
                <tr style="opacity:${a.active !== false ? 1 : 0.5}">
                    <td><strong style="color:var(--accent-orange); font-family:monospace;">${a.num}</strong></td>
                    <td>
                        <div><strong>${a.name}</strong></div>
                        ${a.latin ? `<div style="font-size:11px; font-style:italic; color:var(--text-muted);">${a.latin}</div>` : ''}
                        ${a.barcode ? `<div style="font-size:10px; color:var(--text-muted); font-family:monospace;">üîñ ${a.barcode}</div>` : ''}
                    </td>
                    <td style="font-size:12px;">${a.origin || '-'}</td>
                    <td>${unit}</td>
                    <td style="font-weight:600; color:var(--accent-warning);">${(a.priceB2C || 0).toFixed(2)}</td>
                    <td style="color:var(--text-muted);">${(a.cost || 0).toFixed(2)}</td>
                    <td style="font-weight:600; color:${stockColor};">${stock.toFixed(1)}</td>
                    <td>
                        <div style="display:flex; gap:4px;">
                            <button onclick="editArticle(${a.id})" style="padding:4px 8px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:4px; cursor:pointer;">‚úèÔ∏è</button>
                            <button onclick="deleteArticle(${a.id})" style="padding:4px 8px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:4px; cursor:pointer; color:var(--accent-danger);">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `}).join('') || '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">Aucun article</td></tr>';

            updateArticleStats();
        }

        function filterArticles() {
            renderArticlesTable();
        }

        function showArticleForm() {
            document.getElementById('art-form').style.display = 'block';
            document.getElementById('art-edit-id').value = '';
            // Pr√©-remplir avec le prochain num√©ro d'article
            const nextNum = `${NumberingConfig.article.prefix}-${NumberingConfig.article.next}`;
            document.getElementById('art-num').value = nextNum;
            document.getElementById('art-name').value = '';
            document.getElementById('art-latin').value = '';
            document.getElementById('art-category').value = '';
            document.getElementById('art-origin').value = '';
            document.getElementById('art-lot').value = '';
            document.getElementById('art-pcs').value = '';
            document.getElementById('art-unit').value = 'kg';
            document.getElementById('art-price-b2c').value = '';
            document.getElementById('art-price-b2b').value = '';
            document.getElementById('art-cost').value = '';
            document.getElementById('art-tva').value = '2.6';
            document.getElementById('art-stock').value = '';
            document.getElementById('art-stock-default').value = '';
            document.getElementById('art-tva-code').value = '';
            document.getElementById('art-barcode').value = '';
            document.getElementById('art-active').checked = true;
            document.getElementById('art-form').scrollIntoView({ behavior: 'smooth' });
        }

        function hideArticleForm() {
            document.getElementById('art-form').style.display = 'none';
        }

        function editArticle(id) {
            const a = ArticlesData.articles.find(x => x.id === id);
            if (!a) return;

            document.getElementById('art-form').style.display = 'block';
            document.getElementById('art-edit-id').value = id;
            document.getElementById('art-num').value = a.num || '';
            document.getElementById('art-name').value = a.name || '';
            document.getElementById('art-latin').value = a.latin || '';
            document.getElementById('art-category').value = a.categoryId || '';
            document.getElementById('art-origin').value = a.origin || '';
            document.getElementById('art-lot').value = a.lot || '';
            document.getElementById('art-pcs').value = a.pcs || '';
            document.getElementById('art-unit').value = a.unit || 'kg';
            document.getElementById('art-price-b2c').value = a.priceB2C || '';
            document.getElementById('art-price-b2b').value = a.priceB2B || '';
            document.getElementById('art-cost').value = a.cost || '';
            document.getElementById('art-tva').value = a.tva || 2.6;
            document.getElementById('art-stock').value = a.stock || '';
            document.getElementById('art-stock-default').value = a.stockDefault || '';
            document.getElementById('art-tva-code').value = a.tvaCode || '';
            document.getElementById('art-barcode').value = a.barcode || '';
            document.getElementById('art-active').checked = a.active !== false;
            document.getElementById('art-form').scrollIntoView({ behavior: 'smooth' });
        }

        function saveArticle() {
            const id = document.getElementById('art-edit-id').value;
            const article = {
                id: id ? parseInt(id) : Date.now(),
                num: document.getElementById('art-num').value.trim(),
                name: document.getElementById('art-name').value.trim(),
                latin: document.getElementById('art-latin').value.trim(),
                categoryId: parseInt(document.getElementById('art-category').value) || null,
                origin: document.getElementById('art-origin').value.trim(),
                lot: document.getElementById('art-lot').value.trim(),
                pcs: parseInt(document.getElementById('art-pcs').value) || 1,
                unit: document.getElementById('art-unit').value,
                priceB2C: parseFloat(document.getElementById('art-price-b2c').value) || 0,
                priceB2B: parseFloat(document.getElementById('art-price-b2b').value) || 0,
                cost: parseFloat(document.getElementById('art-cost').value) || 0,
                tva: parseFloat(document.getElementById('art-tva').value) || 2.6,
                stock: parseFloat(document.getElementById('art-stock').value) || 0,
                stockDefault: parseFloat(document.getElementById('art-stock-default').value) || 0,
                tvaCode: document.getElementById('art-tva-code').value.trim(),
                barcode: document.getElementById('art-barcode').value.trim(),
                active: document.getElementById('art-active').checked
            };

            if (!article.num || !article.name) {
                alert('N¬∞ article et d√©signation requis');
                return;
            }

            if (id) {
                const idx = ArticlesData.articles.findIndex(a => a.id === parseInt(id));
                if (idx !== -1) ArticlesData.articles[idx] = article;
            } else {
                ArticlesData.articles.push(article);
                // Incr√©menter le compteur d'article si le num√©ro correspond au format auto
                if (article.num.startsWith(NumberingConfig.article.prefix + '-')) {
                    NumberingConfig.article.next++;
                    localStorage.setItem('num_article_next', NumberingConfig.article.next);
                }
            }

            saveArticlesData();

            // Upload sur Dropbox si configur√©
            if (DropboxConfig.canSync()) {
                saveArticleToDropbox(article);
            }

            hideArticleForm();
            renderArticlesTable();
        }

        function deleteArticle(id) {
            if (!confirm('Supprimer cet article ?')) return;
            ArticlesData.articles = ArticlesData.articles.filter(a => a.id !== id);
            saveArticlesData();
            renderArticlesTable();
        }

        function exportArticlesCSV() {
            // Format compatible avec le fichier de gestion existant
            const headers = ['Num√©ro article', 'Description', 'Nom 2 fran√ßais', 'Unit√© de la quantit√©', 'PV hors TVA', 'PV inclus TVA', 'Stock actuel', 'PA hors TVA', 'PA inclus TVA', 'Quantit√© achet√©e', 'Stock par d√©faut', 'Code TVA - Recettes', 'Code barre'];

            const rows = ArticlesData.articles.map(a => {
                const tvaRate = (a.tva || 2.6) / 100;
                const pvTTC = a.priceB2C ? (a.priceB2C * (1 + tvaRate)).toFixed(2) + '  CHF' : '';
                const pvHT = a.priceB2C ? a.priceB2C.toFixed(2) + '  CHF' : '';
                const paTTC = a.cost ? (a.cost * (1 + tvaRate)).toFixed(2) + '  CHF' : '';
                const paHT = a.cost ? a.cost.toFixed(2) + '  CHF' : '';

                // Mapper l'unit√©
                let unite = a.unit || 'Pi√®ce';
                if (unite === 'kg') unite = 'Kilo';
                if (unite === 'pce') unite = 'Pi√®ce';
                if (unite === 'l') unite = 'Litre';

                return [
                    a.num || '',                          // Num√©ro article
                    a.name || '',                         // Description
                    a.origin || a.latin || '',            // Nom 2 fran√ßais (origine/info compl√©mentaire)
                    unite,                                // Unit√©
                    pvHT,                                 // PV hors TVA
                    pvTTC,                                // PV inclus TVA
                    a.stock !== undefined ? a.stock : '', // Stock actuel
                    paHT,                                 // PA hors TVA
                    paTTC,                                // PA inclus TVA
                    a.qtyPurchased || '',                 // Quantit√© achet√©e
                    a.stockDefault || '',                 // Stock par d√©faut
                    a.tvaCode || '',                      // Code TVA
                    a.barcode || ''                       // Code barre
                ].map(v => `${v}`).join(';');
            });

            const csv = [headers.join(';'), ...rows].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Articles_export_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
        }

        function importArticlesFile(input) {
            const file = input.files[0];
            if (!file) return;

            // Essayer d'abord en ISO-8859-1 (Latin1) car la plupart des fichiers Excel/anciens sont dans ce format
            const reader = new FileReader();
            reader.onload = function(e) {
                let content = e.target.result;

                // Nettoyer les caract√®res sp√©ciaux mal encod√©s
                content = fixEncoding(content);

                const lines = content.split('\n').filter(l => l.trim());
                let added = 0, updated = 0;

                // D√©tecter le format (mon format ou format externe)
                const header = lines[0].toLowerCase();
                const isExternalFormat = header.includes('pv hors tva') || header.includes('num') || header.includes('article');

                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(';').map(c => c.replace(/"/g, '').trim());
                    if (cols.length < 2 || !cols[1]) continue;

                    // Parser les prix (enlever "CHF" et espaces)
                    const parsePrice = (str) => {
                        if (!str) return 0;
                        return parseFloat(str.replace(/CHF/gi, '').replace(/\s/g, '').replace(',', '.')) || 0;
                    };

                    // Mapper l'unit√©
                    let unit = (cols[3] || 'pce').toLowerCase();
                    if (unit.includes('kilo') || unit === 'kg') unit = 'kg';
                    else if (unit.includes('pi√®ce') || unit.includes('piece') || unit.includes('pi√®') || unit === 'pi') unit = 'pce';
                    else if (unit.includes('litre')) unit = 'l';
                    else if (unit.includes('heure')) unit = 'h';
                    else if (unit.includes('p.pers') || unit.includes('pers')) unit = 'pers';
                    else if (unit.includes('unit')) unit = 'pce';
                    else unit = 'pce';

                    const articleData = {
                        num: cols[0] || String(Date.now() + i).slice(-6),
                        name: cols[1],
                        origin: cols[2] || '',                    // Nom 2 fran√ßais = origine/compl√©ment
                        latin: '',
                        categoryId: null,
                        lot: '',
                        pcs: 1,
                        unit: unit,
                        priceB2C: parsePrice(cols[4]),            // PV hors TVA
                        priceB2B: parsePrice(cols[4]) * 0.85,     // Prix B2B = -15% par d√©faut
                        cost: parsePrice(cols[7]),                // PA hors TVA
                        stock: parseFloat(cols[6]) || 0,          // Stock actuel
                        stockDefault: parseFloat(cols[10]) || 0,  // Stock par d√©faut
                        tvaCode: cols[11] || '',                  // Code TVA
                        barcode: cols[12] || '',                  // Code barre
                        tva: 2.6,
                        active: true
                    };

                    // V√©rifier si l'article existe d√©j√† (par num√©ro)
                    const existingIdx = ArticlesData.articles.findIndex(a => a.num === articleData.num);
                    if (existingIdx !== -1) {
                        // Mettre √† jour l'article existant (conserver l'ID)
                        articleData.id = ArticlesData.articles[existingIdx].id;
                        ArticlesData.articles[existingIdx] = articleData;
                        updated++;
                    } else {
                        // Ajouter un nouvel article
                        articleData.id = Date.now() + i;
                        ArticlesData.articles.push(articleData);
                        added++;
                    }
                }

                saveArticlesData();
                renderArticlesTable();
                updateArticleStats();

                let msg = `‚úÖ Import termin√© !\n\n`;
                if (added > 0) msg += `üì¶ ${added} nouveaux articles ajout√©s\n`;
                if (updated > 0) msg += `üîÑ ${updated} articles mis √† jour`;
                alert(msg);
            };
            // Lire en ISO-8859-1 (Latin1) pour bien g√©rer les accents fran√ßais
            reader.readAsText(file, 'ISO-8859-1');
            input.value = '';
        }

        // Fonction pour corriger les probl√®mes d'encodage
        function fixEncoding(str) {
            // Remplacements pour les caract√®res mal encod√©s
            const replacements = {
                // Caract√®res courants mal encod√©s
                '√É¬©': '√©', '√É¬®': '√®', '√É¬™': '√™', '√É¬´': '√´',
                '√É ': '√†', '√É¬¢': '√¢', '√É¬§': '√§',
                '√É¬π': '√π', '√É¬ª': '√ª', '√É¬º': '√º',
                '√É¬Æ': '√Æ', '√É¬Ø': '√Ø', '√É¬¥': '√¥',
                '√É¬ß': '√ß', '√Ö"': '≈ì', '√É': '√†',
                '√¢‚Ç¨‚Ñ¢': "'", '√¢‚Ç¨"': '-', '√¢‚Ç¨≈ì': '"', '√¢‚Ç¨': '"',
                '\\x84': '"', '\\x93': '"', '\\x94': '"',
                '\\x91': "'", '\\x92': "'",
                '\\xe9': '√©', '\\xe8': '√®', '\\xea': '√™', '\\xeb': '√´',
                '\\xe0': '√†', '\\xe2': '√¢', '\\xe4': '√§',
                '\\xf9': '√π', '\\xfb': '√ª', '\\xfc': '√º',
                '\\xee': '√Æ', '\\xef': '√Ø', '\\xf4': '√¥',
                '\\xe7': '√ß', '\\xf1': '√±'
            };

            for (const [bad, good] of Object.entries(replacements)) {
                str = str.split(bad).join(good);
            }

            return str;
        }

        // =====================================================
        // SAUVEGARDE MANUELLE DROPBOX
        // =====================================================

        async function saveAllArticlesToDropbox() {
            if (!DropboxConfig.isAvailable()) {
                alert('‚ùå Dropbox non configur√©.\n\nAllez dans Param√®tres > Dropbox pour vous connecter.');
                return;
            }

            // Obtenir un token valide (refresh auto si n√©cessaire)
            const token = await getValidDropboxToken();
            if (!token) {
                alert('‚ùå Impossible d\'obtenir un token Dropbox valide.\n\nReconnectez-vous dans Param√®tres > Dropbox.');
                return;
            }

            const basePath = DropboxConfig.basePath;
            let success = 0, errors = 0;

            // Afficher progression
            const total = ArticlesData.articles.length + 1;

            // Sauvegarder le fichier complet
            const allArticlesJson = JSON.stringify(ArticlesData, null, 2);
            const allResult = await uploadToDropboxDirect(basePath + '/Articles/_all_articles.json', allArticlesJson);
            if (allResult) success++;
            else errors++;

            // Sauvegarder chaque article individuellement
            for (const article of ArticlesData.articles) {
                const fileName = article.num + '_' + article.name.replace(/[^a-zA-Z0-9√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ß]/gi, '_').substring(0, 30) + '.json';
                const result = await uploadToDropboxDirect(basePath + '/Articles/' + fileName, JSON.stringify(article, null, 2));
                if (result) success++;
                else errors++;
            }

            if (errors === 0) {
                alert(`‚úÖ Articles sauvegard√©s sur Dropbox !\n\nüì¶ ${ArticlesData.articles.length} articles\nüìÅ ${basePath}/Articles/`);
            } else {
                alert(`‚ö†Ô∏è Sauvegarde partielle\n\n‚úÖ ${success} fichiers OK\n‚ùå ${errors} erreurs`);
            }
        }

        async function saveAllClientsToDropbox() {
            if (!DropboxConfig.isAvailable()) {
                alert('‚ùå Dropbox non configur√©.\n\nAllez dans Param√®tres > Dropbox pour vous connecter.');
                return;
            }

            // Obtenir un token valide (refresh auto si n√©cessaire)
            const token = await getValidDropboxToken();
            if (!token) {
                alert('‚ùå Impossible d\'obtenir un token Dropbox valide.\n\nReconnectez-vous dans Param√®tres > Dropbox.');
                return;
            }

            const basePath = DropboxConfig.basePath;
            let success = 0, errors = 0;

            // Sauvegarder le fichier complet
            const allClientsJson = JSON.stringify(QOData.clients, null, 2);
            const allResult = await uploadToDropboxDirect(basePath + '/Clients/_all_clients.json', allClientsJson);
            if (allResult) success++;
            else errors++;

            // Sauvegarder chaque client individuellement
            for (const client of QOData.clients) {
                const fileName = client.num + '_' + client.name.replace(/[^a-zA-Z0-9√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ß]/gi, '_').substring(0, 30) + '.json';
                const result = await uploadToDropboxDirect(basePath + '/Clients/' + fileName, JSON.stringify(client, null, 2));
                if (result) success++;
                else errors++;
            }

            if (errors === 0) {
                alert(`‚úÖ Clients sauvegard√©s sur Dropbox !\n\nüë• ${QOData.clients.length} clients\nüìÅ ${basePath}/Clients/`);
            } else {
                alert(`‚ö†Ô∏è Sauvegarde partielle\n\n‚úÖ ${success} fichiers OK\n‚ùå ${errors} erreurs`);
            }
        }

        // === CAT√âGORIES ===
        function renderCategoriesGrid() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = ArticlesData.categories.map(c => {
                const count = ArticlesData.articles.filter(a => a.categoryId === c.id).length;
                return `
                <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; padding:20px; display:flex; align-items:center; gap:16px; cursor:pointer; transition:all 0.2s;" onclick="showCategoryArticles(${c.id})" onmouseover="this.style.borderColor='var(--accent-primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform=''">
                    <div style="font-size:40px;">${c.icon}</div>
                    <div style="flex:1;">
                        <div style="font-weight:700;">${c.name}</div>
                        <div style="font-size:12px; color:var(--text-muted);">Code: ${c.code}</div>
                        <span style="display:inline-block; margin-top:6px; font-size:11px; padding:4px 10px; background:var(--accent-primary)20; color:var(--accent-primary); border-radius:12px;">üì¶ ${count} article${count > 1 ? 's' : ''}</span>
                    </div>
                    <div style="display:flex; gap:6px;">
                        <button onclick="event.stopPropagation(); editCategory(${c.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">‚úèÔ∏è</button>
                        <button onclick="event.stopPropagation(); deleteCategory(${c.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; color:var(--accent-danger);">üóëÔ∏è</button>
                    </div>
                </div>
            `}).join('');
        }

        // Afficher les articles d'une cat√©gorie
        function showCategoryArticles(categoryId) {
            const cat = ArticlesData.categories.find(c => c.id === categoryId);
            if (!cat) return;

            const articles = ArticlesData.articles.filter(a => a.categoryId === categoryId);

            const modal = document.getElementById('art-detail-modal');
            document.getElementById('art-detail-title').innerHTML = `${cat.icon} ${cat.name}`;
            document.getElementById('art-detail-subtitle').textContent = `${articles.length} article${articles.length > 1 ? 's' : ''} dans cette cat√©gorie`;

            const content = document.getElementById('art-detail-content');
            if (articles.length === 0) {
                content.innerHTML = '<p style="text-align:center; color:var(--text-muted); padding:40px;">Aucun article dans cette cat√©gorie</p>';
            } else {
                content.innerHTML = `
                    <table style="width:100%; font-size:13px;">
                        <thead>
                            <tr>
                                <th>N¬∞</th>
                                <th>D√©signation</th>
                                <th>Origine</th>
                                <th style="color:var(--accent-warning);">B2C</th>
                                <th style="color:var(--accent-secondary);">B2B</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${articles.map(a => `
                                <tr style="opacity:${a.active ? 1 : 0.5}">
                                    <td><strong style="color:var(--accent-orange);">${a.num}</strong></td>
                                    <td>
                                        <div><strong>${a.name}</strong></div>
                                        ${a.latin ? `<div style="font-size:11px; font-style:italic; color:var(--text-muted);">${a.latin}</div>` : ''}
                                    </td>
                                    <td>${a.origin || '-'}</td>
                                    <td style="font-weight:600; color:var(--accent-warning);">${a.priceB2C.toFixed(2)}</td>
                                    <td style="font-weight:600; color:var(--accent-secondary);">${a.priceB2B.toFixed(2)}</td>
                                    <td>
                                        <button onclick="closeArtDetailModal(); switchArtTab('articles'); setTimeout(() => editArticle(${a.id}), 200)" style="padding:4px 8px; background:var(--accent-primary); color:#000; border:none; border-radius:4px; cursor:pointer; font-size:11px;">√âditer ‚Üí</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            modal.style.display = 'flex';
        }

        // Fermer le modal de d√©tails
        function closeArtDetailModal() {
            document.getElementById('art-detail-modal').style.display = 'none';
        }

        function showCategoryForm() {
            document.getElementById('cat-form').style.display = 'block';
            document.getElementById('cat-edit-id').value = '';
            document.getElementById('cat-code').value = '';
            document.getElementById('cat-name').value = '';
            document.getElementById('cat-icon').value = 'üì¶';
        }

        function hideCategoryForm() {
            document.getElementById('cat-form').style.display = 'none';
        }

        function editCategory(id) {
            const c = ArticlesData.categories.find(x => x.id === id);
            if (!c) return;
            document.getElementById('cat-form').style.display = 'block';
            document.getElementById('cat-edit-id').value = id;
            document.getElementById('cat-code').value = c.code || '';
            document.getElementById('cat-name').value = c.name || '';
            document.getElementById('cat-icon').value = c.icon || 'üì¶';
        }

        function saveCategory() {
            const id = document.getElementById('cat-edit-id').value;
            const cat = {
                id: id ? parseInt(id) : Date.now(),
                code: document.getElementById('cat-code').value.trim().toUpperCase() || 'CAT' + Date.now(),
                name: document.getElementById('cat-name').value.trim(),
                icon: document.getElementById('cat-icon').value
            };
            if (!cat.name) { alert('Nom requis'); return; }

            if (id) {
                const idx = ArticlesData.categories.findIndex(c => c.id === parseInt(id));
                if (idx !== -1) ArticlesData.categories[idx] = cat;
            } else {
                ArticlesData.categories.push(cat);
            }
            saveArticlesData();
            hideCategoryForm();
            updateCategorySelects();
            renderCategoriesGrid();
            updateArticleStats();
        }

        function deleteCategory(id) {
            if (!confirm('Supprimer cette cat√©gorie ?')) return;
            ArticlesData.categories = ArticlesData.categories.filter(c => c.id !== id);
            saveArticlesData();
            updateCategorySelects();
            renderCategoriesGrid();
            updateArticleStats();
        }

        // === LISTES DE PRIX ===
        function renderPricelistsGrid() {
            const grid = document.getElementById('pricelists-grid');
            grid.innerHTML = ArticlesData.pricelists.map(p => {
                const clientCount = (QOData.clients || []).filter(c => c.pricelistId === p.id).length;
                return `
                <div style="background:var(--bg-card); border:2px solid ${p.discount > 0 ? 'var(--accent-warning)' : 'var(--border-color)'}; border-radius:12px; padding:20px; cursor:pointer; transition:all 0.2s;" onclick="showPricelistClients(${p.id})" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                        <div>
                            <div style="font-weight:700; font-size:18px;">${p.name}</div>
                            <div style="font-size:12px; color:var(--text-muted);">Code: ${p.code}</div>
                        </div>
                        <div style="background:${p.discount > 0 ? 'var(--accent-warning)' : 'var(--bg-hover)'}; color:${p.discount > 0 ? '#000' : 'var(--text-primary)'}; padding:6px 12px; border-radius:20px; font-weight:700;">
                            -${p.discount}%
                        </div>
                    </div>
                    <p style="color:var(--text-muted); font-size:13px; margin-bottom:12px;">${p.desc || 'Aucune description'}</p>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:12px; padding:6px 12px; background:var(--accent-secondary)20; color:var(--accent-secondary); border-radius:20px; cursor:pointer;" onclick="event.stopPropagation(); showPricelistClients(${p.id})">üë• ${clientCount} client${clientCount > 1 ? 's' : ''}</span>
                        <div style="display:flex; gap:6px;">
                            <button onclick="event.stopPropagation(); editPricelist(${p.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">‚úèÔ∏è</button>
                            <button onclick="event.stopPropagation(); deletePricelist(${p.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; color:var(--accent-danger);">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Afficher les clients d'une liste de prix
        function showPricelistClients(pricelistId) {
            const pl = ArticlesData.pricelists.find(p => p.id === pricelistId);
            if (!pl) return;

            const clients = (QOData.clients || []).filter(c => c.pricelistId === pricelistId);

            const modal = document.getElementById('art-detail-modal');
            document.getElementById('art-detail-title').innerHTML = `üí∞ ${pl.name} <span style="font-size:14px; color:var(--text-muted);">(-${pl.discount}%)</span>`;
            document.getElementById('art-detail-subtitle').textContent = `${clients.length} client${clients.length > 1 ? 's' : ''} avec cette liste de prix`;

            const content = document.getElementById('art-detail-content');
            if (clients.length === 0) {
                content.innerHTML = '<p style="text-align:center; color:var(--text-muted); padding:40px;">Aucun client assign√© √† cette liste de prix</p>';
            } else {
                content.innerHTML = `
                    <table style="width:100%; font-size:13px;">
                        <thead>
                            <tr>
                                <th>N¬∞</th>
                                <th>Type</th>
                                <th>Nom / Soci√©t√©</th>
                                <th>Ville</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clients.map(c => {
                                const type = c.clientType || 'b2b';
                                const typeIcon = type === 'b2c' ? 'üè†' : 'üè¢';
                                const typeColor = type === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)';
                                return `
                                <tr>
                                    <td><strong style="color:var(--accent-orange);">${c.num || c.id}</strong></td>
                                    <td><span style="padding:3px 8px; background:${typeColor}20; color:${typeColor}; border-radius:12px; font-size:11px;">${typeIcon}</span></td>
                                    <td><strong>${c.name}</strong></td>
                                    <td>${c.city || '-'}</td>
                                    <td>
                                        <button onclick="closeArtDetailModal(); navigateTo('clients'); setTimeout(() => editClientPage(${c.id}), 200)" style="padding:4px 8px; background:var(--accent-primary); color:#000; border:none; border-radius:4px; cursor:pointer; font-size:11px;">Voir ‚Üí</button>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                `;
            }

            modal.style.display = 'flex';
        }

        function showPricelistForm() {
            document.getElementById('pricelist-form').style.display = 'block';
            document.getElementById('pl-edit-id').value = '';
            document.getElementById('pl-code').value = '';
            document.getElementById('pl-name').value = '';
            document.getElementById('pl-discount').value = '0';
            document.getElementById('pl-desc').value = '';
        }

        function hidePricelistForm() {
            document.getElementById('pricelist-form').style.display = 'none';
        }

        function editPricelist(id) {
            const p = ArticlesData.pricelists.find(x => x.id === id);
            if (!p) return;
            document.getElementById('pricelist-form').style.display = 'block';
            document.getElementById('pl-edit-id').value = id;
            document.getElementById('pl-code').value = p.code || '';
            document.getElementById('pl-name').value = p.name || '';
            document.getElementById('pl-discount').value = p.discount || 0;
            document.getElementById('pl-desc').value = p.desc || '';
        }

        function savePricelist() {
            const id = document.getElementById('pl-edit-id').value;
            const pl = {
                id: id ? parseInt(id) : Date.now(),
                code: document.getElementById('pl-code').value.trim().toUpperCase() || 'PL' + Date.now(),
                name: document.getElementById('pl-name').value.trim(),
                discount: parseFloat(document.getElementById('pl-discount').value) || 0,
                desc: document.getElementById('pl-desc').value.trim()
            };
            if (!pl.name) { alert('Nom requis'); return; }

            if (id) {
                const idx = ArticlesData.pricelists.findIndex(p => p.id === parseInt(id));
                if (idx !== -1) ArticlesData.pricelists[idx] = pl;
            } else {
                ArticlesData.pricelists.push(pl);
            }
            saveArticlesData();
            hidePricelistForm();
            updatePricelistSelects();
            renderPricelistsGrid();
            updateArticleStats();
        }

        function deletePricelist(id) {
            if (!confirm('Supprimer cette liste de prix ?')) return;
            ArticlesData.pricelists = ArticlesData.pricelists.filter(p => p.id !== id);
            saveArticlesData();
            updatePricelistSelects();
            renderPricelistsGrid();
            updateArticleStats();
        }

        // === RABAIS ===
        function renderDiscountsGrid() {
            const grid = document.getElementById('discounts-grid');
            grid.innerHTML = ArticlesData.discounts.map(d => {
                const cat = ArticlesData.categories.find(c => c.id === d.categoryId);
                const pl = d.pricelistId ? ArticlesData.pricelists.find(p => p.id === d.pricelistId) : null;
                const tiersHtml = (d.tiers || []).map(t =>
                    `<span style="display:inline-block; padding:4px 10px; background:var(--bg-hover); border-radius:20px; font-size:12px; margin:2px;">D√®s ${t.qty} pce ‚Üí <strong>-${t.pct}%</strong></span>`
                ).join(' ');

                return `
                <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; padding:16px; margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <span style="font-size:24px;">${cat?.icon || 'üì¶'}</span>
                            <div>
                                <div style="font-weight:700;">${cat?.name || 'Cat√©gorie inconnue'}</div>
                                <div style="font-size:12px; color:var(--text-muted);">${pl ? `Liste: ${pl.name}` : 'Toutes les listes'}</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:6px;">
                            <button onclick="editDiscount(${d.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">‚úèÔ∏è</button>
                            <button onclick="deleteDiscount(${d.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; color:var(--accent-danger);">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div>${tiersHtml || '<span style="color:var(--text-muted);">Aucun palier d√©fini</span>'}</div>
                </div>
            `}).join('') || '<p style="color:var(--text-muted); text-align:center; padding:40px;">Aucune r√®gle de rabais configur√©e</p>';
        }

        function showDiscountForm() {
            document.getElementById('discount-form').style.display = 'block';
            document.getElementById('disc-edit-id').value = '';
            document.getElementById('disc-category').value = '';
            document.getElementById('disc-pricelist').value = '';
            document.getElementById('disc-tiers').innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center;">
                    <input type="number" placeholder="D√®s X pi√®ces" class="disc-qty" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                    <input type="number" step="0.1" placeholder="% rabais" class="disc-pct" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                    <button type="button" onclick="removeDiscountTier(this)" style="padding:8px 12px; background:var(--accent-danger); color:#fff; border:none; border-radius:6px; cursor:pointer;">‚úï</button>
                </div>
            `;
        }

        function hideDiscountForm() {
            document.getElementById('discount-form').style.display = 'none';
        }

        function addDiscountTier() {
            const container = document.getElementById('disc-tiers');
            const div = document.createElement('div');
            div.style.cssText = 'display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center;';
            div.innerHTML = `
                <input type="number" placeholder="D√®s X pi√®ces" class="disc-qty" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                <input type="number" step="0.1" placeholder="% rabais" class="disc-pct" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                <button type="button" onclick="removeDiscountTier(this)" style="padding:8px 12px; background:var(--accent-danger); color:#fff; border:none; border-radius:6px; cursor:pointer;">‚úï</button>
            `;
            container.appendChild(div);
        }

        function removeDiscountTier(btn) {
            const rows = document.querySelectorAll('#disc-tiers > div');
            if (rows.length > 1) btn.parentElement.remove();
        }

        function editDiscount(id) {
            const d = ArticlesData.discounts.find(x => x.id === id);
            if (!d) return;

            document.getElementById('discount-form').style.display = 'block';
            document.getElementById('disc-edit-id').value = id;
            document.getElementById('disc-category').value = d.categoryId || '';
            document.getElementById('disc-pricelist').value = d.pricelistId || '';

            const container = document.getElementById('disc-tiers');
            container.innerHTML = (d.tiers || []).map(t => `
                <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center;">
                    <input type="number" placeholder="D√®s X pi√®ces" class="disc-qty" value="${t.qty}" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                    <input type="number" step="0.1" placeholder="% rabais" class="disc-pct" value="${t.pct}" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                    <button type="button" onclick="removeDiscountTier(this)" style="padding:8px 12px; background:var(--accent-danger); color:#fff; border:none; border-radius:6px; cursor:pointer;">‚úï</button>
                </div>
            `).join('') || `
                <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center;">
                    <input type="number" placeholder="D√®s X pi√®ces" class="disc-qty" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                    <input type="number" step="0.1" placeholder="% rabais" class="disc-pct" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                    <button type="button" onclick="removeDiscountTier(this)" style="padding:8px 12px; background:var(--accent-danger); color:#fff; border:none; border-radius:6px; cursor:pointer;">‚úï</button>
                </div>
            `;
        }

        function saveDiscount() {
            const id = document.getElementById('disc-edit-id').value;
            const categoryId = parseInt(document.getElementById('disc-category').value);
            if (!categoryId) { alert('Cat√©gorie requise'); return; }

            const tiers = [];
            document.querySelectorAll('#disc-tiers > div').forEach(row => {
                const qty = parseInt(row.querySelector('.disc-qty').value);
                const pct = parseFloat(row.querySelector('.disc-pct').value);
                if (qty > 0 && pct > 0) tiers.push({ qty, pct });
            });
            tiers.sort((a, b) => a.qty - b.qty);

            const disc = {
                id: id ? parseInt(id) : Date.now(),
                categoryId: categoryId,
                pricelistId: parseInt(document.getElementById('disc-pricelist').value) || null,
                tiers: tiers
            };

            if (id) {
                const idx = ArticlesData.discounts.findIndex(d => d.id === parseInt(id));
                if (idx !== -1) ArticlesData.discounts[idx] = disc;
            } else {
                ArticlesData.discounts.push(disc);
            }
            saveArticlesData();
            hideDiscountForm();
            renderDiscountsGrid();
            updateArticleStats();
        }

        function deleteDiscount(id) {
            if (!confirm('Supprimer cette r√®gle ?')) return;
            ArticlesData.discounts = ArticlesData.discounts.filter(d => d.id !== id);
            saveArticlesData();
            renderDiscountsGrid();
            updateArticleStats();
        }

        // Calcul du prix avec rabais
        function calculatePriceWithDiscount(article, qty, clientType, pricelistId) {
            let basePrice = clientType === 'b2c' ? article.priceB2C : article.priceB2B;

            // Appliquer remise liste de prix
            if (pricelistId) {
                const pl = ArticlesData.pricelists.find(p => p.id === pricelistId);
                if (pl && pl.discount > 0) {
                    basePrice = basePrice * (1 - pl.discount / 100);
                }
            }

            // Appliquer rabais quantit√© par cat√©gorie
            const discount = ArticlesData.discounts.find(d =>
                d.categoryId === article.categoryId &&
                (!d.pricelistId || d.pricelistId === pricelistId)
            );

            if (discount && discount.tiers) {
                const applicableTier = discount.tiers
                    .filter(t => qty >= t.qty)
                    .sort((a, b) => b.qty - a.qty)[0];

                if (applicableTier) {
                    basePrice = basePrice * (1 - applicableTier.pct / 100);
                }
            }

            return basePrice;
        }

        // Init QuickOrder
        function initQuickOrder() {
            // Ne pas r√©initialiser si on est en mode √©dition
            if (QOData.editingOrderId) {
                console.log('‚è≠Ô∏è Skip initQuickOrder - mode √©dition actif');
                return;
            }

            initQOSampleData();
            document.getElementById('qo-step-client').style.display = 'block';
            document.getElementById('qo-step-order').style.display = 'none';
            document.getElementById('qo-selected-client').style.display = 'none';
            document.getElementById('qo-btn-next-step').style.display = 'none';
            QOData.cart = [];
            QOData.selectedClient = null;
        }

        // ========================================
        // GESTION CLIENTS - Modal & CRUD
        // ========================================

        function openQOClientsModal() {
            renderQOClientsTable();
            document.getElementById('qo-clients-modal').style.display = 'flex';
        }

        function closeQOClientsModal() {
            document.getElementById('qo-clients-modal').style.display = 'none';
        }

        function renderQOClientsTable(filter = '') {
            const tbody = document.getElementById('qo-clients-tbody');
            let clients = QOData.clients;

            if (filter) {
                const q = filter.toLowerCase();
                clients = clients.filter(c =>
                    c.name.toLowerCase().includes(q) ||
                    (c.contact && c.contact.toLowerCase().includes(q)) ||
                    (c.city && c.city.toLowerCase().includes(q)) ||
                    (c.phone && c.phone.includes(q)) ||
                    (c.num && c.num.includes(q))
                );
            }

            const b2bCount = clients.filter(c => (c.clientType || 'b2b') === 'b2b').length;
            const b2cCount = clients.filter(c => c.clientType === 'b2c').length;

            document.getElementById('qo-clients-count').textContent = clients.length;
            document.getElementById('qo-clients-b2b').textContent = b2bCount;
            document.getElementById('qo-clients-b2c').textContent = b2cCount;

            tbody.innerHTML = clients.slice(0, 100).map(c => {
                const type = c.clientType || 'b2b';
                const typeIcon = type === 'b2c' ? 'üè†' : 'üè¢';
                const typeColor = type === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)';
                return `
                <tr>
                    <td><strong style="color:var(--accent-orange);">${c.num || c.id}</strong></td>
                    <td><span style="color:${typeColor};" title="${type === 'b2c' ? 'Particulier' : 'Professionnel'}">${typeIcon}</span></td>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.contact || '-'}</td>
                    <td>${c.city || '-'}</td>
                    <td>${c.phone || c.mobile || '-'}</td>
                    <td>${c.ordersCount || 0}</td>
                    <td>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="editQOClient(${c.id})">‚úèÔ∏è</button>
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px; color:var(--accent-danger);" onclick="deleteQOClient(${c.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `}).join('') || '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">Aucun client</td></tr>';
        }

        function filterQOClientsTable(query) {
            renderQOClientsTable(query);
        }

        function showQOClientForm() {
            document.getElementById('qo-client-form').style.display = 'block';
            document.getElementById('qo-client-edit-id').value = '';
            document.getElementById('qo-client-num').value = '';
            document.getElementById('qo-client-company').value = '';
            document.getElementById('qo-client-contact').value = '';
            document.getElementById('qo-client-type').value = 'b2b';
            document.getElementById('qo-client-address').value = '';
            document.getElementById('qo-client-address2').value = '';
            document.getElementById('qo-client-zip').value = '';
            document.getElementById('qo-client-city').value = '';
            document.getElementById('qo-client-tel').value = '';
            document.getElementById('qo-client-mobile').value = '';
            document.getElementById('qo-client-email2').value = '';
            document.getElementById('qo-client-credit').value = '';
            document.getElementById('qo-client-payment').value = '30 jours fin de mois';
        }

        function hideQOClientForm() {
            document.getElementById('qo-client-form').style.display = 'none';
        }

        function editQOClient(id) {
            const c = QOData.clients.find(x => x.id === id);
            if (!c) return;

            document.getElementById('qo-client-form').style.display = 'block';
            document.getElementById('qo-client-edit-id').value = id;
            document.getElementById('qo-client-num').value = c.num || '';
            document.getElementById('qo-client-company').value = c.name || '';
            document.getElementById('qo-client-contact').value = c.contact || '';
            document.getElementById('qo-client-type').value = c.clientType || 'b2b';
            document.getElementById('qo-client-address').value = c.address || '';
            document.getElementById('qo-client-address2').value = c.address2 || '';
            document.getElementById('qo-client-zip').value = c.zip || '';
            document.getElementById('qo-client-city').value = c.city || '';
            document.getElementById('qo-client-tel').value = c.phone || '';
            document.getElementById('qo-client-mobile').value = c.mobile || '';
            document.getElementById('qo-client-email2').value = c.email || '';
            document.getElementById('qo-client-credit').value = c.credit || '';
            document.getElementById('qo-client-payment').value = c.payment || '30 jours fin de mois';
        }

        function saveQOClient() {
            const id = document.getElementById('qo-client-edit-id').value;
            const client = {
                id: id ? parseInt(id) : Date.now(),
                num: document.getElementById('qo-client-num').value.trim() || String(Date.now()).slice(-6),
                name: document.getElementById('qo-client-company').value.trim(),
                contact: document.getElementById('qo-client-contact').value.trim(),
                clientType: document.getElementById('qo-client-type').value,
                address: document.getElementById('qo-client-address').value.trim(),
                address2: document.getElementById('qo-client-address2').value.trim(),
                zip: document.getElementById('qo-client-zip').value.trim(),
                city: document.getElementById('qo-client-city').value.trim(),
                phone: document.getElementById('qo-client-tel').value.trim(),
                mobile: document.getElementById('qo-client-mobile').value.trim(),
                email: document.getElementById('qo-client-email2').value.trim(),
                credit: parseFloat(document.getElementById('qo-client-credit').value) || 0,
                payment: document.getElementById('qo-client-payment').value,
                ordersCount: 0,
                history: []
            };

            if (!client.name) {
                alert('Le nom/soci√©t√© est requis');
                return;
            }

            if (id) {
                const index = QOData.clients.findIndex(c => c.id === parseInt(id));
                if (index !== -1) {
                    client.ordersCount = QOData.clients[index].ordersCount || 0;
                    client.history = QOData.clients[index].history || [];
                    QOData.clients[index] = client;
                }
            } else {
                QOData.clients.push(client);
            }

            saveQOData('clients');
            hideQOClientForm();
            renderQOClientsTable();
        }

        function deleteQOClient(id) {
            if (!confirm('Supprimer ce client ?')) return;
            QOData.clients = QOData.clients.filter(c => c.id !== id);
            saveQOData('clients');
            renderQOClientsTable();
        }

        // ========================================
        // IMPORT / EXPORT CSV
        // ========================================

        function importQOClientsFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                let content = e.target.result;

                // Appliquer la correction d'encodage pour les fichiers CSV
                if (file.name.endsWith('.csv')) {
                    content = fixEncoding(content);
                    parseQOClientsCSV(content);
                } else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                    parseQOClientsXLS(e.target.result);
                }
            };

            if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                reader.readAsArrayBuffer(file);
            } else {
                // Lire en ISO-8859-1 (Latin1) pour les fichiers CSV avec accents
                reader.readAsText(file, 'ISO-8859-1');
            }

            input.value = ''; // Reset input
        }

        function parseQOClientsCSV(content) {
            const lines = content.split('\n');
            if (lines.length < 2) {
                alert('Fichier CSV vide ou invalide');
                return;
            }

            // D√©tecter le s√©parateur (virgule ou point-virgule)
            const separator = lines[0].includes(';') ? ';' : ',';

            // Parser le header pour trouver les colonnes
            const header = lines[0].split(separator).map(h => h.trim().toLowerCase().replace(/"/g, ''));

            // Mapping des colonnes possibles
            const colMap = {
                num: header.findIndex(h => h.includes('num') || h.includes('client') || h.includes('code')),
                name: header.findIndex(h => h.includes('nom') || h.includes('soci') || h.includes('name') || h.includes('company')),
                contact: header.findIndex(h => h.includes('pr') || h.includes('contact') || h.includes('firstname')),
                address: header.findIndex(h => h.includes('adresse 1') || h.includes('address') || h.includes('rue')),
                address2: header.findIndex(h => h.includes('adresse 2')),
                zip: header.findIndex(h => h.includes('postal') || h.includes('zip') || h.includes('cp')),
                city: header.findIndex(h => h.includes('ville') || h.includes('city') || h.includes('localit')),
                phone: header.findIndex(h => h.includes('phone 1') || h.includes('phone') || h.includes('tel') && !h.includes('portable')),
                mobile: header.findIndex(h => h.includes('portable') || h.includes('mobile') || h.includes('cell')),
                email: header.findIndex(h => h.includes('email') || h.includes('mail')),
                credit: header.findIndex(h => h.includes('cr') && h.includes('dit') || h.includes('limit')),
                payment: header.findIndex(h => h.includes('ch') && h.includes('ance') || h.includes('payment'))
            };

            let imported = 0;
            let updated = 0;

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const cols = line.split(separator).map(c => c.trim().replace(/^"|"$/g, ''));

                const clientNum = colMap.num >= 0 ? cols[colMap.num] : '';
                const clientName = colMap.name >= 0 ? cols[colMap.name] : '';

                if (!clientName) continue;

                const newClient = {
                    id: clientNum ? parseInt(clientNum) || Date.now() + i : Date.now() + i,
                    num: clientNum || String(Date.now() + i).slice(-6),
                    name: clientName,
                    contact: colMap.contact >= 0 ? cols[colMap.contact] || '' : '',
                    address: colMap.address >= 0 ? cols[colMap.address] || '' : '',
                    address2: colMap.address2 >= 0 ? cols[colMap.address2] || '' : '',
                    zip: colMap.zip >= 0 ? cols[colMap.zip] || '' : '',
                    city: colMap.city >= 0 ? cols[colMap.city] || '' : '',
                    phone: colMap.phone >= 0 ? cols[colMap.phone] || '' : '',
                    mobile: colMap.mobile >= 0 ? cols[colMap.mobile] || '' : '',
                    email: colMap.email >= 0 ? cols[colMap.email] || '' : '',
                    credit: colMap.credit >= 0 ? parseFloat(cols[colMap.credit]) || 0 : 0,
                    payment: colMap.payment >= 0 ? cols[colMap.payment] || '30 jours fin de mois' : '30 jours fin de mois',
                    ordersCount: 0,
                    history: []
                };

                // V√©rifier si le client existe d√©j√† (par num√©ro ou nom)
                const existingIndex = QOData.clients.findIndex(c =>
                    (c.num && c.num === newClient.num) ||
                    c.name.toLowerCase() === newClient.name.toLowerCase()
                );

                if (existingIndex >= 0) {
                    // Mettre √† jour en pr√©servant ordersCount et history
                    newClient.ordersCount = QOData.clients[existingIndex].ordersCount || 0;
                    newClient.history = QOData.clients[existingIndex].history || [];
                    newClient.id = QOData.clients[existingIndex].id;
                    QOData.clients[existingIndex] = newClient;
                    updated++;
                } else {
                    QOData.clients.push(newClient);
                    imported++;
                }
            }

            saveQOData('clients');
            renderQOClientsTable();
            alert(`Import termin√© !\n${imported} clients ajout√©s\n${updated} clients mis √† jour`);
        }

        function parseQOClientsXLS(data) {
            if (typeof XLSX === 'undefined') {
                alert('Biblioth√®que Excel non charg√©e. Utilisez un fichier CSV.');
                return;
            }

            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const csvContent = XLSX.utils.sheet_to_csv(firstSheet, { FS: ';' });
            parseQOClientsCSV(csvContent);
        }

        function exportQOClientsCSV() {
            const headers = ['Num√©ro de client', 'Nom/soci√©t√©', 'Pr√©nom', 'Adresse 1', 'Adresse 2', 'Code postal', 'Ville', 'T√©l√©phone 1', 'Portable', 'Email', 'Limite de cr√©dit', '√âch√©ance', 'Nb commandes'];

            const rows = QOData.clients.map(c => [
                c.num || c.id,
                c.name || '',
                c.contact || '',
                c.address || '',
                c.address2 || '',
                c.zip || '',
                c.city || '',
                c.phone || '',
                c.mobile || '',
                c.email || '',
                c.credit || 0,
                c.payment || '30 jours fin de mois',
                c.ordersCount || 0
            ]);

            const csvContent = [headers.join(';'), ...rows.map(r => r.map(v => `"${v}"`).join(';'))].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'clients_export_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function downloadQOImportTemplate() {
            const headers = ['Num√©ro de client', 'Nom/soci√©t√©', 'Pr√©nom', 'Adresse 1', 'Adresse 2', 'Code postal', 'Ville', 'T√©l√©phone 1', 'Portable', 'Email', 'Limite de cr√©dit', '√âch√©ance'];
            const example = ['123456', 'Restaurant Example', 'Jean Dupont', 'Rue de la Gare 15', '', '1260', 'Nyon', '022 123 45 67', '079 123 45 67', 'contact@example.ch', '2000', '30 jours fin de mois'];

            const csvContent = [headers.join(';'), example.map(v => `"${v}"`).join(';')].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'modele_import_clients.csv';
            link.click();
        }

        function resetQOClientsToDefault() {
            if (!confirm('‚ö†Ô∏è R√©initialiser la base clients avec les 277 clients par d√©faut ?\n\nCette action remplacera tous les clients actuels.')) return;
            loadQODefaultClients();
            renderQOClientsTable();
            alert('‚úÖ Base clients r√©initialis√©e avec 277 clients !');
        }

        // Auto-init when QuickOrder tab is clicked
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.dataset.page === 'quickorder') {
                    setTimeout(initQuickOrder, 100);
                }
            });
        });

        // Init ArticlesData and QOData on page load
        loadArticlesData();

        // Charger les clients au d√©marrage si pas dans localStorage
        if (!QOData.clients || QOData.clients.length < 50) {
            loadQODefaultClients();
        }

        // Close modals on click outside
        document.addEventListener('click', function(e) {
            if (e.target.id === 'qo-client-results') return;
            if (!e.target.closest('#qo-client-search') && !e.target.closest('#qo-client-results')) {
                document.getElementById('qo-client-results').style.display = 'none';
            }
        });

        // =====================================================
        // BARRE FLOTTANTE COMMANDE EN COURS
        // =====================================================

        function updateOrderFloatingBar() {
            const bar = document.getElementById('floating-order-bar');
            const currentPage = document.querySelector('.module-page[style*="display: block"]')?.id?.replace('page-', '') || 'dashboard';

            // Cacher si on est sur QuickOrder ou si pas de commande en cours
            if (currentPage === 'quickorder' || (!QOData.selectedClient && QOData.cart.length === 0)) {
                bar.style.display = 'none';
                return;
            }

            // Calculer le total
            let total = 0;
            QOData.cart.forEach(item => total += item.total);
            const tva = total * 0.026;
            const ttc = total + tva;

            // Mettre √† jour le contenu
            const clientName = QOData.selectedClient ? QOData.selectedClient.name : 'Client non s√©lectionn√©';

            document.getElementById('floating-order-client').textContent = clientName;
            document.getElementById('floating-order-total').textContent = ttc.toFixed(2);

            bar.style.display = 'block';
        }

        function goToCurrentOrder() {
            closeFinalizeModal();
            navigateTo('quickorder');
        }

        function hideFloatingOrderBar() {
            const bar = document.getElementById('floating-order-bar');
            bar.style.display = 'none';
            // M√©moriser que l'utilisateur a ferm√© la barre
            sessionStorage.setItem('floatingBarHidden', 'true');
        }

        function showFloatingOrderBarIfNeeded() {
            // Si l'utilisateur a ferm√© manuellement, ne pas r√©afficher
            if (sessionStorage.getItem('floatingBarHidden') === 'true') return;
            updateOrderFloatingBar();
        }

        // =====================================================
        // MODAL FINALISATION
        // =====================================================

        function showFinalizeModal() {
            if (!QOData.selectedClient || QOData.cart.length === 0) {
                alert('Aucune commande en cours');
                return;
            }

            const client = QOData.selectedClient;
            const type = client.clientType || 'b2b';

            // Client info
            document.getElementById('finalize-client-icon').textContent = type === 'b2c' ? 'üè†' : 'üè¢';
            document.getElementById('finalize-client-name').textContent = client.name;
            document.getElementById('finalize-client-info').innerHTML = `
                ${client.address ? client.address + ', ' : ''}${client.zip || ''} ${client.city || ''}
                ${client.phone ? '<br>üìû ' + client.phone : ''}
            `;

            // Articles list
            const itemsList = document.getElementById('finalize-items-list');
            itemsList.innerHTML = QOData.cart.map(item => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--border-color);">
                    <div style="flex:1;">
                        <div style="font-weight:600; font-size:14px;">${item.name}</div>
                        <div style="font-size:12px; color:var(--text-muted);">${item.code} ‚Ä¢ ${item.origin || ''}</div>
                    </div>
                    <div style="text-align:center; padding:0 16px;">
                        <div style="font-size:14px; font-weight:600;">${item.qty}</div>
                        <div style="font-size:11px; color:var(--text-muted);">${item.unit}</div>
                    </div>
                    <div style="text-align:right; min-width:80px;">
                        <div style="font-family:'Space Mono',monospace; font-weight:600;">${item.total.toFixed(2)}</div>
                        <div style="font-size:11px; color:var(--text-muted);">CHF</div>
                    </div>
                </div>
            `).join('');

            // Totaux
            let totalHT = 0;
            QOData.cart.forEach(item => totalHT += item.total);
            const tva = totalHT * 0.026;
            const ttc = totalHT + tva;

            document.getElementById('finalize-total-ht').textContent = totalHT.toFixed(2) + ' CHF';
            document.getElementById('finalize-total-tva').textContent = tva.toFixed(2) + ' CHF';
            document.getElementById('finalize-total-ttc').textContent = ttc.toFixed(2) + ' CHF';

            document.getElementById('finalize-modal').style.display = 'flex';
        }

        function closeFinalizeModal() {
            document.getElementById('finalize-modal').style.display = 'none';
        }

        function confirmAndFinalizeOrder() {
            if (!QOData.selectedClient || QOData.cart.length === 0) return;

            // Calculer les totaux
            let totalHT = 0;
            QOData.cart.forEach(item => totalHT += item.total);
            const tva = totalHT * 0.026;
            const totalTTC = totalHT + tva;

            const now = new Date();
            const currentUser = UsersData.currentUser?.name || 'Inconnu';

            // Mode √©dition ?
            if (QOData.editingOrderId) {
                // Mise √† jour d'une commande existante
                const order = QOData.orders.find(o => o.id === QOData.editingOrderId);
                if (order) {
                    order.items = [...QOData.cart];
                    order.totalHT = totalHT;
                    order.tva = tva;
                    order.totalTTC = totalTTC;
                    order.updatedAt = now.toISOString();
                    order.updatedBy = currentUser;

                    saveQOData('orders');
                    closeFinalizeModal();

                    // R√©g√©n√©rer le PDF
                    generateProPDF(order, false);

                    // Reset
                    const orderId = QOData.editingOrderId;
                    QOData.editingOrderId = null;
                    QOData.cart = [];
                    QOData.selectedClient = null;
                    updateQOCart();
                    updateOrderFloatingBar();

                    // Supprimer le banner d'√©dition
                    const banner = document.getElementById('edit-order-banner');
                    if (banner) banner.remove();

                    const dropboxMsg = DropboxConfig.autoSync ? '\nüì§ PDF mis √† jour sur Dropbox' : '';
                    alert('‚úÖ Commande ' + orderId + ' mise √† jour !\n\n‚úèÔ∏è Modifi√©e par: ' + currentUser + dropboxMsg);

                    // Retour √† l'√©tape client
                    document.getElementById('qo-step-order').style.display = 'none';
                    document.getElementById('qo-step-client').style.display = 'block';
                    document.getElementById('qo-selected-client').style.display = 'none';
                }
                return;
            }

            // Nouvelle commande
            const orderNum = generateOrderNumber();

            const order = {
                id: orderNum,
                clientId: QOData.selectedClient.id,
                clientName: QOData.selectedClient.name,
                clientType: QOData.selectedClient.clientType || 'b2b',
                clientAddress: QOData.selectedClient.address || '',
                clientZip: QOData.selectedClient.zip || '',
                clientCity: QOData.selectedClient.city || '',
                clientPhone: QOData.selectedClient.phone || '',
                clientEmail: QOData.selectedClient.email || '',
                pricelistId: QOData.selectedClient.pricelistId || null,
                items: [...QOData.cart],
                totalHT: totalHT,
                tva: tva,
                totalTTC: totalTTC,
                date: now.toISOString(),
                createdAt: now.toISOString(),
                createdBy: currentUser,
                updatedAt: null,
                updatedBy: null,
                status: 'pending',
                statusLabel: 'En attente'
            };

            // Update client
            const client = QOData.clients.find(c => c.id === QOData.selectedClient.id);
            if (client) {
                client.ordersCount = (client.ordersCount || 0) + 1;
                client.lastOrderDate = now.toISOString();
                client.lastOrderId = order.id;
                if (!client.history) client.history = [];
                QOData.cart.forEach(item => {
                    if (!client.history.includes(item.productId)) {
                        client.history.push(item.productId);
                    }
                });
                saveQOData('clients');
            }

            // Save order
            QOData.orders.push(order);
            saveQOData('orders');

            // Update badges
            updateOrdersBadge();

            // Fermer le modal
            closeFinalizeModal();

            // G√©n√©rer le PDF (sans ouvrir, sauvegarde Dropbox auto)
            generateProPDF(order, false);

            // Reset panier
            QOData.cart = [];
            QOData.selectedClient = null;
            updateQOCart();
            updateOrderFloatingBar();

            // Message de confirmation
            const dropboxMsg = DropboxConfig.autoSync ? '\nüì§ PDF sauvegard√© sur Dropbox' : '';
            alert('‚úÖ Commande ' + order.id + ' enregistr√©e !\n\nüìù Cr√©√©e par: ' + currentUser + dropboxMsg);
        }

        // =====================================================
        // PDF PROFESSIONNEL A4
        // =====================================================

        function generateProPDF(order, openForPrint = false) {
            if (typeof window.jspdf === 'undefined') {
                console.log('jsPDF non charg√©');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const margin = 15;

            // === HEADER ===
            doc.setFillColor(10, 14, 23);
            doc.rect(0, 0, pageWidth, 50, 'F');

            // Logo / Nom entreprise
            doc.setTextColor(6, 214, 160);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('TRAKIO', margin, 22);

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Gestion des commandes', margin, 30);

            // Num√©ro de commande
            doc.setTextColor(6, 214, 160);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(order.id, pageWidth - margin, 22, { align: 'right' });

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const dateFormatted = new Date(order.date).toLocaleDateString('fr-CH', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            doc.text(dateFormatted, pageWidth - margin, 30, { align: 'right' });
            doc.text(new Date(order.date).toLocaleTimeString('fr-CH', { hour: '2-digit', minute: '2-digit' }), pageWidth - margin, 36, { align: 'right' });

            // === CLIENT INFO ===
            let y = 60;

            doc.setTextColor(100, 100, 100);
            doc.setFontSize(9);
            doc.text('FACTURER √Ä', margin, y);

            doc.setTextColor(30, 30, 30);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(order.clientName, margin, y + 8);

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            if (order.clientAddress) {
                doc.text(order.clientAddress, margin, y + 15);
            }
            if (order.clientZip || order.clientCity) {
                doc.text((order.clientZip || '') + ' ' + (order.clientCity || ''), margin, y + 21);
            }
            if (order.clientPhone) {
                doc.text('T√©l: ' + order.clientPhone, margin, y + 27);
            }

            // Type client badge
            const typeLabel = order.clientType === 'b2c' ? 'Particulier' : 'Professionnel';
            doc.setFillColor(order.clientType === 'b2c' ? 255 : 59, order.clientType === 'b2c' ? 170 : 130, order.clientType === 'b2c' ? 0 : 246);
            doc.roundedRect(pageWidth - margin - 30, y, 30, 7, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text(typeLabel, pageWidth - margin - 15, y + 5, { align: 'center' });

            // === TABLE DES ARTICLES ===
            y = 95;

            // Header de table
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, y, pageWidth - 2*margin, 10, 'F');

            doc.setTextColor(80, 80, 80);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('Article', margin + 3, y + 7);
            doc.text('Qt√©', 130, y + 7);
            doc.text('P.U.', 150, y + 7);
            doc.text('Total', pageWidth - margin - 3, y + 7, { align: 'right' });

            y += 14;
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(30, 30, 30);

            // Articles
            order.items.forEach((item, index) => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }

                // Ligne altern√©e
                if (index % 2 === 1) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(margin, y - 4, pageWidth - 2*margin, 12, 'F');
                }

                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(30, 30, 30);
                doc.text(item.name.substring(0, 45), margin + 3, y + 2);

                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(120, 120, 120);
                let subtext = item.code;
                if (item.origin) subtext += ' ‚Ä¢ ' + item.origin;
                if (item.lot) subtext += ' ‚Ä¢ Lot: ' + item.lot;
                doc.text(subtext.substring(0, 60), margin + 3, y + 7);

                doc.setTextColor(30, 30, 30);
                doc.setFontSize(10);
                doc.text(item.qty.toString() + ' ' + item.unit, 130, y + 4);
                doc.text(item.price.toFixed(2), 150, y + 4);
                doc.setFont('helvetica', 'bold');
                doc.text(item.total.toFixed(2) + ' CHF', pageWidth - margin - 3, y + 4, { align: 'right' });

                y += 14;
            });

            // === TOTAUX ===
            y += 5;
            doc.setDrawColor(200, 200, 200);
            doc.line(120, y, pageWidth - margin, y);
            y += 8;

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(80, 80, 80);
            doc.text('Total HT', 130, y);
            doc.setTextColor(30, 30, 30);
            doc.text(order.totalHT.toFixed(2) + ' CHF', pageWidth - margin - 3, y, { align: 'right' });

            y += 7;
            doc.setTextColor(80, 80, 80);
            doc.text('TVA (2.6%)', 130, y);
            doc.setTextColor(30, 30, 30);
            doc.text(order.tva.toFixed(2) + ' CHF', pageWidth - margin - 3, y, { align: 'right' });

            y += 3;
            doc.setDrawColor(6, 214, 160);
            doc.setLineWidth(0.5);
            doc.line(120, y, pageWidth - margin, y);
            y += 8;

            doc.setFillColor(6, 214, 160);
            doc.roundedRect(120, y - 5, pageWidth - margin - 120, 12, 2, 2, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('TOTAL TTC', 125, y + 3);
            doc.text(order.totalTTC.toFixed(2) + ' CHF', pageWidth - margin - 5, y + 3, { align: 'right' });

            // === FOOTER ===
            const footerY = 275;

            // M√©tadonn√©es cr√©√©/modifi√©
            doc.setTextColor(150, 150, 150);
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');

            if (order.createdBy) {
                const createdDate = order.createdAt ? new Date(order.createdAt).toLocaleString('fr-CH') : '';
                doc.text(`Cr√©√©e par: ${order.createdBy} le ${createdDate}`, margin, footerY);
            }
            if (order.updatedBy) {
                const updatedDate = order.updatedAt ? new Date(order.updatedAt).toLocaleString('fr-CH') : '';
                doc.text(`Modifi√©e par: ${order.updatedBy} le ${updatedDate}`, margin, footerY + 4);
            }

            doc.setFontSize(8);
            doc.text('Document g√©n√©r√© automatiquement par TRAKIO', pageWidth / 2, footerY + 10, { align: 'center' });
            doc.text('Page 1/1', pageWidth - margin, footerY + 10, { align: 'right' });

            // Upload sur Dropbox si configur√© (toujours)
            if (DropboxConfig.token) {
                const pdfBlob = doc.output('blob');
                uploadOrderPDFToDropbox(order, pdfBlob);
            }

            // Ouvrir pour impression si demand√©
            if (openForPrint) {
                doc.autoPrint();
                window.open(doc.output('bloburl'), '_blank');
            }
        }

        // Upload PDF commande vers Dropbox
        async function uploadOrderPDFToDropbox(order, pdfBlob) {
            // Obtenir un token valide
            const token = await getValidDropboxToken();
            if (!token) return;

            try {
                const monthYear = new Date(order.date).toISOString().slice(0, 7); // YYYY-MM
                const pdfPath = `${DropboxConfig.basePath}/Commandes/${monthYear}/${order.id}.pdf`;

                const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Dropbox-API-Arg': JSON.stringify({
                            path: pdfPath,
                            mode: 'overwrite',
                            autorename: false,
                            mute: true
                        }),
                        'Content-Type': 'application/octet-stream'
                    },
                    body: pdfBlob
                });

                if (response.ok) {
                    console.log('‚úÖ PDF commande sauvegard√© sur Dropbox:', pdfPath);
                } else {
                    console.error('‚ùå Erreur upload PDF Dropbox:', await response.text());
                }
            } catch (error) {
                console.error('Erreur upload PDF:', error);
            }
        }

        // Mettre √† jour la barre quand on change de page
        const originalNavigateTo = navigateTo;
        navigateTo = function(pageName) {
            originalNavigateTo(pageName);
            setTimeout(updateOrderFloatingBar, 150);
        };

        // Mettre √† jour apr√®s chaque modification du panier
        const originalUpdateQOCart = updateQOCart;
        updateQOCart = function() {
            originalUpdateQOCart();
            updateOrderFloatingBar();
        };

        // =====================================================
        // SHOPIFY INTEGRATION - Import CSV
        // =====================================================

        let ShopifyData = {
            orders: [],
            filteredOrders: [],
            currentOrder: null,
            processedOrders: JSON.parse(localStorage.getItem('shopify_processed') || '[]')
        };

        function initShopifyModule() {
            // Charger les donn√©es pr√©c√©demment import√©es
            const savedOrders = localStorage.getItem('shopify_orders');
            if (savedOrders) {
                try {
                    ShopifyData.orders = JSON.parse(savedOrders);
                    ShopifyData.filteredOrders = [...ShopifyData.orders];
                    if (ShopifyData.orders.length > 0) {
                        showShopifyData();
                        updateShopifyStats();
                        renderShopifyOrders();
                    }
                } catch(e) { console.error('Erreur chargement Shopify:', e); }
            }
        }

        // Parser un CSV
        function parseCSV(text) {
            const lines = [];
            let currentLine = [];
            let currentField = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        currentField += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        currentLine.push(currentField);
                        currentField = '';
                    } else if (char === '\n' || (char === '\r' && nextChar === '\n')) {
                        currentLine.push(currentField);
                        if (currentLine.length > 1) lines.push(currentLine);
                        currentLine = [];
                        currentField = '';
                        if (char === '\r') i++;
                    } else if (char !== '\r') {
                        currentField += char;
                    }
                }
            }
            if (currentField || currentLine.length > 0) {
                currentLine.push(currentField);
                if (currentLine.length > 1) lines.push(currentLine);
            }
            return lines;
        }

        // =============================================
        // SHOP HUB - Fonctions
        // =============================================
        
        let generatedFicheHTML = '';
        
        // Conservation texts
        const ficheConservationTexts = {
            congele: { temp: "-18¬∞C", detail: "Conserver au cong√©lateur √† -18¬∞C. Ne jamais recongeler." },
            frais: { temp: "0¬∞C √† +4¬∞C", detail: "Conserver au r√©frig√©rateur. Consommer sous 2-3 jours." },
            both: { temp: "-18¬∞C / 0¬∞C √† +4¬∞C", detail: "Cong√©lateur -18¬∞C. Apr√®s d√©cong√©lation: frigo 0-4¬∞C, consommer sous 48h." }
        };
        
        // Switch tabs in Shop Hub
        function switchShopTab(tab) {
            // Update buttons
            ['sync', 'nutri', 'fiches'].forEach(t => {
                const btn = document.getElementById('shop-tab-' + t);
                const content = document.getElementById('shop-content-' + t);
                if (btn && content) {
                    if (t === tab) {
                        btn.style.background = 'var(--accent-primary)';
                        btn.style.color = 'white';
                        content.style.display = 'block';
                    } else {
                        btn.style.background = 'transparent';
                        btn.style.color = 'var(--text-muted)';
                        content.style.display = 'none';
                    }
                }
            });
        }
        
        // Parse import text for Fiche
        function parseFicheImport() {
            const text = document.getElementById('fiche-import-text')?.value?.trim();
            if (!text) { showToast('Collez un texte d\'abord', 'warning'); return; }
            
            const found = [];
            
            // Description
            const descMatch = text.match(/Description du Produit\s*:?\s*\n?([\s\S]*?)(?=CONSEILS|Conseils|$)/i);
            if (descMatch) { 
                document.getElementById('fiche-description').value = descMatch[1].trim(); 
                found.push('Description'); 
            }
            
            // Conseils
            const conseilsMatch = text.match(/CONSEILS?\s*(?:DE\s*)?PR[E√â]PARATION[^:]*:?\s*\n?([\s\S]*?)(?=Servez|Choisissez|$)/i);
            if (conseilsMatch) { 
                document.getElementById('fiche-conseils').value = conseilsMatch[1].trim(); 
                found.push('Conseils'); 
            }
            
            // Certification
            if (text.match(/\bMSC\b/i)) { 
                document.getElementById('fiche-certification').value = 'msc'; 
                found.push('MSC'); 
            } else if (text.match(/\bBIO\b/i)) { 
                document.getElementById('fiche-certification').value = 'bio'; 
                found.push('BIO'); 
            } else if (text.match(/\bASC\b/i)) { 
                document.getElementById('fiche-certification').value = 'asc'; 
                found.push('ASC'); 
            }
            
            // Type
            if (text.match(/sauvage/i)) { 
                document.getElementById('fiche-type').value = 'sauvage'; 
                found.push('Sauvage'); 
            }
            
            if (found.length > 0) {
                showToast('Import r√©ussi: ' + found.join(', '), 'success');
            } else {
                document.getElementById('fiche-description').value = text;
                showToast('Texte copi√© en description', 'info');
            }
        }
        
        // Get badge HTML
        function getFicheCertBadge(cert) {
            const badges = {
                'bio': '<span class="badge badge-bio">BIO</span>',
                'msc': '<span class="badge badge-msc">MSC</span>',
                'asc': '<span class="badge badge-asc">ASC</span>',
                'label-rouge': '<span class="badge badge-label-rouge">Label Rouge</span>',
                'premium': '<span class="badge badge-premium">Premium</span>',
                'aucune': '<span class="badge badge-aucune">Aucune</span>'
            };
            return badges[cert] || badges['aucune'];
        }
        
        function getFicheTypeBadge(type) {
            return type === 'sauvage' 
                ? '<span class="badge badge-sauvage">Sauvage</span>' 
                : '<span class="badge badge-elevage">√âlevage</span>';
        }
        
        // Generate Fiche HTML
        function generateFicheHTML() {
            const getValue = (id) => document.getElementById(id)?.value?.trim() || '';
            
            const conservation = getValue('fiche-conservation');
            const conservData = ficheConservationTexts[conservation] || { temp: '', detail: '' };
            
            const data = {
                description: getValue('fiche-description'),
                presentation: getValue('fiche-presentation'),
                poids: getValue('fiche-poids'),
                type: getValue('fiche-type'),
                certification: getValue('fiche-certification'),
                origine: getValue('fiche-origine'),
                zoneFao: getValue('fiche-zone-fao'),
                methodePeche: getValue('fiche-methode-peche'),
                texteVendeur: getValue('fiche-vendeur'),
                conseils: getValue('fiche-conseils'),
                accords: getValue('fiche-accords'),
                dlc: getValue('fiche-dlc'),
                lien: getValue('fiche-lien'),
                conservationTemp: conservData.temp,
                conservationDetail: conservData.detail
            };
            
            generatedFicheHTML = `<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
<style>
.trakio-fiche-produit { font-family: 'Amiri', serif; max-width: 800px; margin: 0 auto; color: #333; line-height: 1.7; }
.trakio-fiche-produit h2 { color: #1a5f7a; border-bottom: 3px solid #1a5f7a; padding-bottom: 10px; margin-top: 25px; font-size: 1.4em; }
.trakio-fiche-produit .presentation { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #1a5f7a; }
.trakio-fiche-produit table { width: 100%; border-collapse: collapse; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
.trakio-fiche-produit table tr:nth-child(even) { background-color: #f8f9fa; }
.trakio-fiche-produit table td { padding: 12px 15px; border-bottom: 1px solid #dee2e6; }
.trakio-fiche-produit table td:first-child { font-weight: 600; color: #1a5f7a; width: 35%; background-color: rgba(26, 95, 122, 0.05); }
.trakio-fiche-produit .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; color: white; }
.trakio-fiche-produit .badge-bio { background: #4caf50; }
.trakio-fiche-produit .badge-msc { background: #2196f3; }
.trakio-fiche-produit .badge-asc { background: #00bcd4; }
.trakio-fiche-produit .badge-label-rouge { background: #f44336; }
.trakio-fiche-produit .badge-premium { background: linear-gradient(135deg, #d4af37, #f4e5a1); color: #000; }
.trakio-fiche-produit .badge-aucune { background: #9e9e9e; }
.trakio-fiche-produit .badge-sauvage { background: #2196f3; }
.trakio-fiche-produit .badge-elevage { background: #ff9800; }
.trakio-fiche-produit .conseils-box { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin: 15px 0; }
.trakio-fiche-produit .conseils-box h3 { color: #856404; margin-top: 0; font-size: 1.1em; }
.trakio-fiche-produit .accords-vins { background: #f8f0fc; border: 1px solid #9c27b0; border-radius: 8px; padding: 15px; margin: 15px 0; display: flex; align-items: center; gap: 15px; }
.trakio-fiche-produit .vin-icon { font-size: 2.5em; }
.trakio-fiche-produit .conservation-box { background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin: 15px 0; }
.trakio-fiche-produit .conservation-box h3 { color: #1565c0; margin-top: 0; font-size: 1.1em; }
</style>

<div class="trakio-fiche-produit">

${data.description ? `<h2>Description du Produit</h2>
<div class="presentation"><p>${data.description}</p></div>` : ''}

${data.presentation ? `<p>${data.presentation}</p>` : ''}

<h2>üìã Caract√©ristiques</h2>
<table>
${data.poids ? `<tr><td>‚öñÔ∏è Unit√© / Poids</td><td><strong>${data.poids}</strong></td></tr>` : ''}
<tr><td>üêü Type</td><td>${getFicheTypeBadge(data.type)}</td></tr>
<tr><td>‚úÖ Certification</td><td>${getFicheCertBadge(data.certification)}</td></tr>
${data.methodePeche ? `<tr><td>üé£ M√©thode de P√™che</td><td>${data.methodePeche}</td></tr>` : ''}
${data.origine ? `<tr><td>üåç Origine</td><td><strong>${data.origine}</strong></td></tr>` : ''}
${data.zoneFao ? `<tr><td>üó∫Ô∏è Zone FAO</td><td>${data.zoneFao}</td></tr>` : ''}
${data.lien ? `<tr><td>üîó Plus d'infos</td><td><a href="${data.lien}" target="_blank" style="color: #1a5f7a;">En savoir plus ‚Üó</a></td></tr>` : ''}
</table>

${data.texteVendeur ? `<h2>üí¨ Notre Engagement</h2>
<div class="presentation"><p>${data.texteVendeur}</p></div>` : ''}

${data.conseils ? `<div class="conseils-box"><h3>üë®‚Äçüç≥ Conseils de Pr√©paration</h3><p>${data.conseils}</p></div>` : ''}

${data.accords ? `<div class="accords-vins"><div class="vin-icon">üç∑</div><div><strong>Accords Mets & Vins</strong><br>${data.accords}</div></div>` : ''}

<div class="conservation-box">
<h3>‚ùÑÔ∏è Conservation</h3>
<table style="box-shadow: none; margin: 10px 0;">
${data.dlc ? `<tr><td style="background: transparent;">üìÖ DLC</td><td>${data.dlc}</td></tr>` : ''}
${data.conservationTemp || data.conservationDetail ? `<tr><td style="background: transparent;">üßä Conservation</td><td>${data.conservationTemp ? '<strong>' + data.conservationTemp + '</strong>' : ''}${data.conservationDetail ? '<br>' + data.conservationDetail : ''}</td></tr>` : ''}
</table>
</div>

</div>`;

            // Show preview
            document.getElementById('fiche-preview-section').style.display = 'block';
            document.getElementById('fiche-preview-content').innerHTML = generatedFicheHTML;
            document.getElementById('fiche-code-content').textContent = generatedFicheHTML;
            showFicheTab('preview');
            
            showToast('Fiche g√©n√©r√©e !', 'success');
        }
        
        // Show preview or code tab
        function showFicheTab(tab) {
            const previewContent = document.getElementById('fiche-preview-content');
            const codeContent = document.getElementById('fiche-code-content');
            const btnPreview = document.getElementById('fiche-btn-preview');
            const btnCode = document.getElementById('fiche-btn-code');
            
            if (tab === 'preview') {
                previewContent.style.display = 'block';
                codeContent.style.display = 'none';
                btnPreview.style.background = 'var(--accent-primary)';
                btnPreview.style.color = '#000';
                btnCode.style.background = 'var(--bg-hover)';
                btnCode.style.color = 'var(--text-primary)';
            } else {
                previewContent.style.display = 'none';
                codeContent.style.display = 'block';
                btnCode.style.background = 'var(--accent-primary)';
                btnCode.style.color = '#000';
                btnPreview.style.background = 'var(--bg-hover)';
                btnPreview.style.color = 'var(--text-primary)';
            }
        }
        
        // Copy Fiche HTML
        function copyFicheHTML() {
            if (!generatedFicheHTML) {
                showToast('G√©n√©rez d\'abord une fiche !', 'warning');
                return;
            }
            navigator.clipboard.writeText(generatedFicheHTML).then(() => {
                showToast('Code HTML copi√© !', 'success');
            });
        }
        
        // Reset Fiche form
        function resetFicheForm() {
            const fields = ['fiche-description', 'fiche-presentation', 'fiche-poids', 'fiche-origine', 
                           'fiche-vendeur', 'fiche-conseils', 'fiche-accords', 'fiche-lien', 'fiche-import-text'];
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            // Reset selects
            ['fiche-type', 'fiche-certification', 'fiche-zone-fao', 'fiche-methode-peche', 'fiche-conservation', 'fiche-dlc'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.selectedIndex = 0;
            });
            
            // Hide preview
            document.getElementById('fiche-preview-section').style.display = 'none';
            generatedFicheHTML = '';
            
            showToast('Formulaire r√©initialis√©', 'info');
        }

        // Importer le CSV Shopify
        function importShopifyCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const statusEl = document.getElementById('shopify-import-status');
            statusEl.innerHTML = '<span style="color:var(--accent-warning);">‚è≥ Importation en cours...</span>';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = parseCSV(text);

                    if (lines.length < 2) {
                        statusEl.innerHTML = '<span style="color:var(--accent-danger);">‚ùå Fichier vide ou invalide</span>';
                        return;
                    }

                    const headers = lines[0];
                    const orders = {};

                    // Index des colonnes
                    const idx = {
                        name: headers.indexOf('Name'),
                        email: headers.indexOf('Email'),
                        financialStatus: headers.indexOf('Financial Status'),
                        fulfillmentStatus: headers.indexOf('Fulfillment Status'),
                        currency: headers.indexOf('Currency'),
                        total: headers.indexOf('Total'),
                        shippingMethod: headers.indexOf('Shipping Method'),
                        createdAt: headers.indexOf('Created at'),
                        lineitemQty: headers.indexOf('Lineitem quantity'),
                        lineitemName: headers.indexOf('Lineitem name'),
                        lineitemPrice: headers.indexOf('Lineitem price'),
                        lineitemSku: headers.indexOf('Lineitem sku'),
                        billingName: headers.indexOf('Billing Name'),
                        billingPhone: headers.indexOf('Billing Phone'),
                        billingAddress: headers.indexOf('Billing Address1'),
                        billingCity: headers.indexOf('Billing City'),
                        billingZip: headers.indexOf('Billing Zip'),
                        shippingName: headers.indexOf('Shipping Name'),
                        shippingPhone: headers.indexOf('Shipping Phone'),
                        shippingAddress: headers.indexOf('Shipping Address1'),
                        shippingCity: headers.indexOf('Shipping City'),
                        shippingZip: headers.indexOf('Shipping Zip'),
                        notes: headers.indexOf('Notes'),
                        tags: headers.indexOf('Tags'),
                        id: headers.indexOf('Id')
                    };

                    // Parser les lignes
                    for (let i = 1; i < lines.length; i++) {
                        const row = lines[i];
                        const orderName = row[idx.name];

                        if (!orderName) continue;

                        if (!orders[orderName]) {
                            const tags = row[idx.tags] || '';
                            const pickupInfo = parsePickupInfo(tags);

                            orders[orderName] = {
                                id: row[idx.id] || orderName,
                                name: orderName,
                                email: row[idx.email] || '',
                                financialStatus: row[idx.financialStatus] || '',
                                fulfillmentStatus: row[idx.fulfillmentStatus] || '',
                                currency: row[idx.currency] || 'CHF',
                                total: parseFloat(row[idx.total]) || 0,
                                shippingMethod: row[idx.shippingMethod] || '',
                                createdAt: row[idx.createdAt] || '',
                                billingName: row[idx.billingName] || '',
                                billingPhone: row[idx.billingPhone] || '',
                                billingAddress: row[idx.billingAddress] || '',
                                billingCity: row[idx.billingCity] || '',
                                billingZip: row[idx.billingZip] || '',
                                shippingName: row[idx.shippingName] || '',
                                shippingPhone: row[idx.shippingPhone] || '',
                                shippingAddress: row[idx.shippingAddress] || '',
                                shippingCity: row[idx.shippingCity] || '',
                                shippingZip: row[idx.shippingZip] || '',
                                notes: row[idx.notes] || '',
                                tags: tags,
                                pickupDate: pickupInfo.date,
                                pickupTime: pickupInfo.time,
                                pickupLocation: pickupInfo.location,
                                isPickup: pickupInfo.isPickup,
                                items: [],
                                processed: ShopifyData.processedOrders.includes(orderName)
                            };
                        }

                        // Ajouter l'article
                        const itemName = row[idx.lineitemName];
                        if (itemName) {
                            orders[orderName].items.push({
                                name: itemName,
                                quantity: parseInt(row[idx.lineitemQty]) || 1,
                                price: parseFloat(row[idx.lineitemPrice]) || 0,
                                sku: row[idx.lineitemSku] || ''
                            });
                        }
                    }

                    // Convertir en tableau et trier par date
                    ShopifyData.orders = Object.values(orders).sort((a, b) => {
                        const dateA = new Date(a.createdAt);
                        const dateB = new Date(b.createdAt);
                        return dateB - dateA;
                    });

                    ShopifyData.filteredOrders = [...ShopifyData.orders];

                    // Sauvegarder
                    localStorage.setItem('shopify_orders', JSON.stringify(ShopifyData.orders));

                    // Afficher
                    showShopifyData();
                    updateShopifyStats();
                    populatePickupDateFilter();
                    renderShopifyOrders();

                    statusEl.innerHTML = `<span style="color:var(--accent-primary);">‚úÖ ${ShopifyData.orders.length} commandes import√©es</span>`;

                } catch(err) {
                    console.error('Erreur import CSV:', err);
                    statusEl.innerHTML = `<span style="color:var(--accent-danger);">‚ùå Erreur: ${err.message}</span>`;
                }
            };
            reader.readAsText(file, 'UTF-8');
            input.value = '';
        }

        // Parser les infos de retrait depuis les tags
        function parsePickupInfo(tags) {
            const result = {
                date: '',
                time: '',
                location: '',
                isPickup: false
            };

            if (!tags) return result;

            const tagList = tags.split(',').map(t => t.trim());

            // D√©tecter le type
            if (tags.includes('Store Pickup')) {
                result.isPickup = true;
            }

            // Extraire le lieu
            if (tags.includes('Laboratoire')) {
                result.location = 'Laboratoire de Coinsins';
            } else if (tags.includes('Magasin de Nyon')) {
                result.location = 'Magasin de Nyon';
            } else if (tags.includes('Standard Shipping')) {
                result.location = 'Livraison';
            }

            // Extraire la date (format: "19 Dec 2025")
            const dateMatch = tags.match(/(\d{1,2}\s+(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4})/i);
            if (dateMatch) {
                result.date = dateMatch[1];
            }

            // Extraire l'heure (format: "9:00 AM - 10:00 AM")
            const timeMatch = tags.match(/(\d{1,2}:\d{2}\s*(?:AM|PM)\s*-\s*\d{1,2}:\d{2}\s*(?:AM|PM))/i);
            if (timeMatch) {
                result.time = timeMatch[1];
            }

            return result;
        }

        function showShopifyData() {
            document.getElementById('shopify-empty').style.display = 'none';
            document.getElementById('shopify-stats').style.display = 'grid';
            document.getElementById('shopify-filters').style.display = 'flex';
            document.getElementById('shopify-table-container').style.display = 'block';
            document.getElementById('shopify-alerts').style.display = 'block';
        }

        function updateShopifyStats() {
            const orders = ShopifyData.orders;

            const total = orders.length;
            const urgent = orders.filter(o => o.financialStatus === 'paid' && o.fulfillmentStatus === 'unfulfilled' && !o.processed).length;
            const pending = orders.filter(o => o.financialStatus === 'pending').length;
            const fulfilled = orders.filter(o => o.fulfillmentStatus === 'fulfilled' || o.processed).length;
            const pickup = orders.filter(o => o.isPickup).length;
            const revenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);

            document.getElementById('shopify-stat-total').textContent = total;
            document.getElementById('shopify-stat-urgent').textContent = urgent;
            document.getElementById('shopify-stat-pending').textContent = pending;
            document.getElementById('shopify-stat-fulfilled').textContent = fulfilled;
            document.getElementById('shopify-stat-pickup').textContent = pickup;
            document.getElementById('shopify-stat-revenue').textContent = revenue.toFixed(0);

            // Alertes
            const alertUrgent = document.getElementById('shopify-alert-urgent');
            const alertToday = document.getElementById('shopify-alert-today');

            if (urgent > 0) {
                alertUrgent.style.display = 'block';
                document.getElementById('shopify-urgent-count').textContent = urgent;
            } else {
                alertUrgent.style.display = 'none';
            }

            // Commandes aujourd'hui
            const today = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            const todayOrders = orders.filter(o => o.pickupDate && o.pickupDate.includes(today.split(' ')[0]) && !o.processed);
            if (todayOrders.length > 0) {
                alertToday.style.display = 'block';
                document.getElementById('shopify-today-count').textContent = todayOrders.length;
            } else {
                alertToday.style.display = 'none';
            }

            // Mettre √† jour le badge sur le Dashboard
            updateShopifyDashboardBadge();
            updateDayAlerts();
        }

        function populatePickupDateFilter() {
            const dates = new Set();
            ShopifyData.orders.forEach(o => {
                if (o.pickupDate) dates.add(o.pickupDate);
            });

            const select = document.getElementById('shopify-filter-pickup-date');
            select.innerHTML = '<option value="">Toutes les dates</option>';

            // Trier les dates
            const sortedDates = Array.from(dates).sort((a, b) => {
                const dateA = new Date(a);
                const dateB = new Date(b);
                return dateA - dateB;
            });

            sortedDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = 'üìÖ ' + date;
                select.appendChild(option);
            });
        }

        function applyShopifyFilters() {
            const statusFilter = document.getElementById('shopify-filter-status').value;
            const locationFilter = document.getElementById('shopify-filter-location').value;
            const dateFilter = document.getElementById('shopify-filter-pickup-date').value;
            const searchFilter = document.getElementById('shopify-search').value.toLowerCase();

            ShopifyData.filteredOrders = ShopifyData.orders.filter(order => {
                // Filtre statut
                if (statusFilter === 'urgent') {
                    if (!(order.financialStatus === 'paid' && order.fulfillmentStatus === 'unfulfilled' && !order.processed)) return false;
                } else if (statusFilter === 'pending') {
                    if (order.financialStatus !== 'pending') return false;
                } else if (statusFilter === 'fulfilled') {
                    if (order.fulfillmentStatus !== 'fulfilled' && !order.processed) return false;
                } else if (statusFilter === 'refunded') {
                    if (order.financialStatus !== 'refunded') return false;
                }

                // Filtre lieu
                if (locationFilter) {
                    if (locationFilter === 'Shipping') {
                        if (order.isPickup) return false;
                    } else if (!order.pickupLocation?.includes(locationFilter)) {
                        return false;
                    }
                }

                // Filtre date
                if (dateFilter && order.pickupDate !== dateFilter) return false;

                // Filtre recherche
                if (searchFilter) {
                    const searchIn = `${order.name} ${order.billingName} ${order.shippingName} ${order.email}`.toLowerCase();
                    if (!searchIn.includes(searchFilter)) return false;
                }

                return true;
            });

            renderShopifyOrders();
        }

        function filterShopifyOrders(type) {
            document.getElementById('shopify-filter-status').value = type === 'all' ? '' : type;
            applyShopifyFilters();
        }

        function filterShopifyByUrgent() {
            document.getElementById('shopify-filter-status').value = 'urgent';
            document.getElementById('shopify-filter-location').value = '';
            document.getElementById('shopify-filter-pickup-date').value = '';
            document.getElementById('shopify-search').value = '';
            applyShopifyFilters();
        }

        function filterShopifyByToday() {
            const today = new Date();
            const options = document.getElementById('shopify-filter-pickup-date').options;
            for (let i = 0; i < options.length; i++) {
                const optDate = options[i].value;
                if (optDate && optDate.includes(today.getDate().toString())) {
                    document.getElementById('shopify-filter-pickup-date').value = optDate;
                    break;
                }
            }
            applyShopifyFilters();
        }

        function resetShopifyFilters() {
            document.getElementById('shopify-filter-status').value = '';
            document.getElementById('shopify-filter-location').value = '';
            document.getElementById('shopify-filter-pickup-date').value = '';
            document.getElementById('shopify-search').value = '';
            ShopifyData.filteredOrders = [...ShopifyData.orders];
            renderShopifyOrders();
        }

        function renderShopifyOrders() {
            const tbody = document.getElementById('shopify-orders-tbody');
            let orders = [...ShopifyData.filteredOrders];

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px; color:var(--text-muted);">Aucune commande trouv√©e</td></tr>';
                return;
            }

            // Trier par date de retrait (plus proche d'abord)
            orders.sort((a, b) => {
                const dateA = parsePickupDateForSort(a.pickupDate);
                const dateB = parsePickupDateForSort(b.pickupDate);
                if (!dateA && !dateB) return 0;
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            });

            tbody.innerHTML = orders.map(order => {
                const isUrgent = order.financialStatus === 'paid' && order.fulfillmentStatus === 'unfulfilled' && !order.processed;
                const isPending = order.financialStatus === 'pending';
                const isProcessed = order.processed || order.fulfillmentStatus === 'fulfilled';
                const isRefunded = order.financialStatus === 'refunded';

                // Couleur de la ligne
                let rowStyle = '';
                if (isUrgent) rowStyle = 'background:rgba(231,76,60,0.1); border-left:4px solid var(--accent-danger);';
                else if (isPending) rowStyle = 'background:rgba(241,196,15,0.1);';
                else if (isProcessed) rowStyle = 'opacity:0.6;';

                // Badge statut
                let statusBadge = '';
                if (isRefunded) {
                    statusBadge = '<span style="padding:4px 8px; background:var(--accent-danger); color:#fff; border-radius:4px; font-size:10px;">‚Ü©Ô∏è Rembours√©e</span>';
                } else if (isProcessed) {
                    statusBadge = '<span style="padding:4px 8px; background:var(--accent-secondary); color:#fff; border-radius:4px; font-size:10px;">‚úÖ Trait√©e</span>';
                } else if (isUrgent) {
                    statusBadge = '<span style="padding:4px 8px; background:var(--accent-danger); color:#fff; border-radius:4px; font-size:10px;">üö® √Ä traiter</span>';
                } else if (isPending) {
                    statusBadge = '<span style="padding:4px 8px; background:var(--accent-warning); color:#000; border-radius:4px; font-size:10px;">‚è≥ Paiement</span>';
                } else {
                    statusBadge = '<span style="padding:4px 8px; background:var(--text-muted); color:#fff; border-radius:4px; font-size:10px;">' + order.financialStatus + '</span>';
                }

                // Lieu avec ic√¥ne
                let locationBadge = '';
                if (order.pickupLocation === 'Laboratoire de Coinsins') {
                    locationBadge = '<span style="color:var(--accent-primary);">üî¨ Labo</span>';
                } else if (order.pickupLocation === 'Magasin de Nyon') {
                    locationBadge = '<span style="color:var(--accent-secondary);">üè™ Nyon</span>';
                } else if (order.isPickup) {
                    locationBadge = '<span style="color:var(--text-muted);">üìç Retrait</span>';
                } else {
                    locationBadge = '<span style="color:var(--accent-warning);">üì¶ Livraison</span>';
                }

                // Articles r√©sum√©
                const itemsCount = order.items.length;

                // Date de commande format√©e
                const orderDate = order.createdAt ? formatOrderDate(order.createdAt) : '-';

                return `
                    <tr style="${rowStyle}" onclick="showShopifyOrderDetail('${order.name}')" class="clickable-row">
                        <td onclick="event.stopPropagation()"><input type="checkbox" class="shopify-order-check" data-order="${order.name}"></td>
                        <td><strong style="color:#96bf48;">${order.name}</strong></td>
                        <td style="font-size:12px; color:var(--text-muted);">${orderDate}</td>
                        <td>
                            <div style="font-weight:600;">${order.billingName || order.shippingName || 'N/A'}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${order.billingCity || order.shippingCity || ''}</div>
                        </td>
                        <td>
                            <div style="font-weight:600; color:${isUrgent ? 'var(--accent-danger)' : 'var(--text-primary)'};">${order.pickupDate || '-'}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${order.pickupTime || ''}</div>
                        </td>
                        <td>${locationBadge}</td>
                        <td>
                            <div style="font-size:12px;">${itemsCount} article(s)</div>
                        </td>
                        <td style="font-family:'Space Mono',monospace; font-weight:600;">${order.total.toFixed(2)} ${order.currency}</td>
                        <td>${statusBadge}</td>
                        <td onclick="event.stopPropagation()">
                            <button onclick="showShopifyOrderDetail('${order.name}')" style="padding:6px 10px; background:var(--accent-secondary); color:#fff; border:none; border-radius:4px; cursor:pointer; margin-right:4px;">üëÅÔ∏è</button>
                            ${!isProcessed && !isRefunded ? `<button onclick="markOrderProcessed('${order.name}')" style="padding:6px 10px; background:var(--accent-primary); color:#000; border:none; border-radius:4px; cursor:pointer;">‚úì</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Parser la date de retrait pour le tri
        function parsePickupDateForSort(dateStr) {
            if (!dateStr) return null;
            // Format: "19 Dec 2025"
            const months = { 'Jan':0, 'Feb':1, 'Mar':2, 'Apr':3, 'May':4, 'Jun':5, 'Jul':6, 'Aug':7, 'Sep':8, 'Oct':9, 'Nov':10, 'Dec':11 };
            const match = dateStr.match(/(\d{1,2})\s+(\w{3})\s+(\d{4})/);
            if (match) {
                const day = parseInt(match[1]);
                const month = months[match[2]];
                const year = parseInt(match[3]);
                if (month !== undefined) {
                    return new Date(year, month, day);
                }
            }
            return null;
        }

        // Formater la date de commande
        function formatOrderDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fr-CH', { day: '2-digit', month: '2-digit', year: '2-digit' });
            } catch(e) {
                return dateStr.substring(0, 10);
            }
        }


        function showShopifyOrderDetail(orderName) {
            const order = ShopifyData.orders.find(o => o.name === orderName);
            if (!order) return;

            ShopifyData.currentOrder = order;

            const isUrgent = order.financialStatus === 'paid' && order.fulfillmentStatus === 'unfulfilled' && !order.processed;

            document.getElementById('shopify-modal-order-id').textContent = order.name;

            // Changer la couleur du header si urgent
            const header = document.getElementById('shopify-modal-header');
            if (isUrgent) {
                header.style.background = 'linear-gradient(135deg, var(--accent-danger), #c0392b)';
            } else {
                header.style.background = 'linear-gradient(135deg, #96bf48, #5c8e24)';
            }

            // Contenu
            const itemsHtml = order.items.map(item => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--bg-primary); border-radius:8px; margin-bottom:8px;">
                    <div style="flex:1;">
                        <div style="font-weight:600;">${item.name}</div>
                        <div style="font-size:11px; color:var(--text-muted);">SKU: ${item.sku || '-'}</div>
                    </div>
                    <div style="text-align:center; padding:0 16px;">
                        <div style="font-weight:700; font-size:18px;">√ó${item.quantity}</div>
                    </div>
                    <div style="text-align:right; min-width:100px;">
                        <div style="font-family:'Space Mono',monospace; font-weight:600;">${item.price.toFixed(2)} CHF</div>
                        <div style="font-size:11px; color:var(--text-muted);">= ${(item.quantity * item.price).toFixed(2)} CHF</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('shopify-modal-content').innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <!-- Retrait -->
                    <div style="background:${isUrgent ? 'rgba(231,76,60,0.1)' : 'var(--bg-primary)'}; padding:16px; border-radius:12px; ${isUrgent ? 'border:2px solid var(--accent-danger);' : ''}">
                        <div style="font-weight:600; color:${isUrgent ? 'var(--accent-danger)' : 'var(--accent-primary)'}; margin-bottom:12px;">üìÖ Retrait / Livraison</div>
                        <div style="font-size:18px; font-weight:700; margin-bottom:4px;">${order.pickupDate || 'Non sp√©cifi√©'}</div>
                        <div style="color:var(--text-muted);">${order.pickupTime || ''}</div>
                        <div style="margin-top:8px; padding:8px; background:var(--bg-card); border-radius:6px;">
                            <strong>${order.pickupLocation || order.shippingMethod || 'N/A'}</strong>
                        </div>
                    </div>
                    <!-- Client -->
                    <div style="background:var(--bg-primary); padding:16px; border-radius:12px;">
                        <div style="font-weight:600; color:var(--accent-secondary); margin-bottom:12px;">üë§ Client</div>
                        <div style="font-size:16px; font-weight:600;">${order.billingName || order.shippingName}</div>
                        <div style="color:var(--text-muted); margin-top:4px;">${order.email}</div>
                        <div style="color:var(--text-muted);">${order.billingPhone || order.shippingPhone || ''}</div>
                        <div style="margin-top:8px; font-size:13px;">
                            ${order.shippingAddress || order.billingAddress}<br>
                            ${order.shippingZip || order.billingZip} ${order.shippingCity || order.billingCity}
                        </div>
                    </div>
                </div>

                ${order.notes ? `
                <div style="background:var(--accent-warning)15; padding:16px; border-radius:12px; margin-bottom:20px; border-left:4px solid var(--accent-warning);">
                    <div style="font-weight:600; color:var(--accent-warning); margin-bottom:8px;">üìù Note du client</div>
                    <div>${order.notes}</div>
                </div>
                ` : ''}

                <!-- Articles -->
                <div style="margin-bottom:20px;">
                    <div style="font-weight:600; margin-bottom:12px;">üì¶ Articles (${order.items.length})</div>
                    ${itemsHtml}
                </div>

                <!-- Total -->
                <div style="background:var(--bg-primary); padding:16px; border-radius:12px;">
                    <div style="display:flex; justify-content:space-between; font-weight:700; font-size:20px;">
                        <span>Total</span>
                        <span style="font-family:'Space Mono',monospace; color:#96bf48;">${order.total.toFixed(2)} ${order.currency}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:8px; color:var(--text-muted); font-size:13px;">
                        <span>Statut paiement</span>
                        <span>${order.financialStatus === 'paid' ? '‚úÖ Pay√©e' : order.financialStatus}</span>
                    </div>
                </div>
            `;

            document.getElementById('shopify-order-modal').style.display = 'flex';
        }

        function closeShopifyOrderModal() {
            document.getElementById('shopify-order-modal').style.display = 'none';
        }

        function markOrderProcessed(orderName) {
            const order = ShopifyData.orders.find(o => o.name === orderName);
            if (!order) return;

            order.processed = true;

            // Sauvegarder dans la liste des commandes trait√©es
            if (!ShopifyData.processedOrders.includes(orderName)) {
                ShopifyData.processedOrders.push(orderName);
                localStorage.setItem('shopify_processed', JSON.stringify(ShopifyData.processedOrders));
            }

            localStorage.setItem('shopify_orders', JSON.stringify(ShopifyData.orders));

            updateShopifyStats();
            renderShopifyOrders();
        }

        function markAsProcessed() {
            if (!ShopifyData.currentOrder) return;
            markOrderProcessed(ShopifyData.currentOrder.name);
            closeShopifyOrderModal();
        }

        function toggleSelectAllShopify() {
            const selectAll = document.getElementById('shopify-select-all').checked;
            document.querySelectorAll('.shopify-order-check').forEach(cb => cb.checked = selectAll);
        }

        function printShopifyOrder() {
            if (!ShopifyData.currentOrder) return;
            const order = ShopifyData.currentOrder;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Commande ${order.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #96bf48; }
                        .info { margin: 10px 0; }
                        .items { margin: 20px 0; }
                        .item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
                        .total { font-size: 20px; font-weight: bold; margin-top: 20px; text-align: right; }
                        .urgent { color: #e74c3c; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>üõçÔ∏è Commande ${order.name}</h1>
                    <div class="info"><strong>Client:</strong> ${order.billingName || order.shippingName}</div>
                    <div class="info"><strong>Email:</strong> ${order.email}</div>
                    <div class="info"><strong>T√©l√©phone:</strong> ${order.billingPhone || order.shippingPhone || '-'}</div>
                    <div class="info"><strong>Adresse:</strong> ${order.shippingAddress || order.billingAddress}, ${order.shippingZip || order.billingZip} ${order.shippingCity || order.billingCity}</div>
                    <hr>
                    <div class="info ${order.financialStatus === 'paid' && order.fulfillmentStatus === 'unfulfilled' ? 'urgent' : ''}">
                        <strong>üìÖ Date de retrait:</strong> ${order.pickupDate || 'Non sp√©cifi√©'} ${order.pickupTime || ''}
                    </div>
                    <div class="info"><strong>üìç Lieu:</strong> ${order.pickupLocation || order.shippingMethod}</div>
                    ${order.notes ? `<div class="info"><strong>üìù Note:</strong> ${order.notes}</div>` : ''}
                    <hr>
                    <div class="items">
                        <h3>Articles</h3>
                        ${order.items.map(item => `
                            <div class="item">
                                <span>${item.quantity}x ${item.name}</span>
                                <span>${(item.quantity * item.price).toFixed(2)} CHF</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="total">Total: ${order.total.toFixed(2)} ${order.currency}</div>
                    <script>window.print();${'<'}/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function exportShopifyFiltered() {
            const orders = ShopifyData.filteredOrders;
            if (orders.length === 0) {
                alert('Aucune commande √† exporter');
                return;
            }

            // Cr√©er CSV
            const headers = ['N¬∞ Commande', 'Client', 'Email', 'T√©l√©phone', 'Date Retrait', 'Heure', 'Lieu', 'Articles', 'Total', 'Statut Paiement', 'Statut Traitement'];
            const rows = orders.map(o => [
                o.name,
                o.billingName || o.shippingName,
                o.email,
                o.billingPhone || o.shippingPhone,
                o.pickupDate,
                o.pickupTime,
                o.pickupLocation || o.shippingMethod,
                o.items.map(i => `${i.quantity}x ${i.name}`).join(' | '),
                o.total.toFixed(2),
                o.financialStatus,
                o.processed ? 'Trait√©e' : 'Non trait√©e'
            ]);

            const csv = [headers, ...rows].map(r => r.map(c => `"${(c || '').replace(/"/g, '""')}"`).join(',')).join('\n');

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shopify-commandes-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // =====================================================
        // NUM√âROTATION & PR√âFIXES
        // =====================================================

        const NumberingConfig = {
            order: {
                prefix: localStorage.getItem('num_order_prefix') || 'CMD',
                start: parseInt(localStorage.getItem('num_order_start')) || 1,
                next: parseInt(localStorage.getItem('num_order_next')) || 1
            },
            client: {
                prefix: localStorage.getItem('num_client_prefix') || 'CLI',
                start: parseInt(localStorage.getItem('num_client_start')) || 1000,
                next: parseInt(localStorage.getItem('num_client_next')) || 1000
            },
            article: {
                prefix: localStorage.getItem('num_article_prefix') || 'ART',
                start: parseInt(localStorage.getItem('num_article_start')) || 100,
                next: parseInt(localStorage.getItem('num_article_next')) || 100
            },
            includeDate: localStorage.getItem('num_include_date') !== 'false',
            zeroPadding: localStorage.getItem('num_zero_padding') !== 'false'
        };

        function initNumberingSettings() {
            // Charger les valeurs dans les champs
            document.getElementById('num-order-prefix').value = NumberingConfig.order.prefix;
            document.getElementById('num-order-start').value = NumberingConfig.order.start;
            document.getElementById('num-order-next').value = NumberingConfig.order.next;

            document.getElementById('num-client-prefix').value = NumberingConfig.client.prefix;
            document.getElementById('num-client-start').value = NumberingConfig.client.start;
            document.getElementById('num-client-next').value = NumberingConfig.client.next;

            document.getElementById('num-article-prefix').value = NumberingConfig.article.prefix;
            document.getElementById('num-article-start').value = NumberingConfig.article.start;
            document.getElementById('num-article-next').value = NumberingConfig.article.next;

            document.getElementById('num-include-date').checked = NumberingConfig.includeDate;
            document.getElementById('num-zero-padding').checked = NumberingConfig.zeroPadding;

            // Mettre √† jour les aper√ßus
            updateNumberingPreviews();

            // Ajouter les √©v√©nements pour mise √† jour en temps r√©el
            ['num-order-prefix', 'num-order-next', 'num-client-prefix', 'num-client-next', 'num-article-prefix', 'num-article-next', 'num-include-date', 'num-zero-padding'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateNumberingPreviews);
                if (el) el.addEventListener('change', updateNumberingPreviews);
            });
        }

        function updateNumberingPreviews() {
            const includeDate = document.getElementById('num-include-date')?.checked;
            const zeroPadding = document.getElementById('num-zero-padding')?.checked;
            const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');

            // Commandes
            const orderPrefix = document.getElementById('num-order-prefix')?.value || 'CMD';
            const orderNext = parseInt(document.getElementById('num-order-next')?.value) || 1;
            const orderNum = zeroPadding ? String(orderNext).padStart(3, '0') : orderNext;
            const orderPreview = includeDate ? `${orderPrefix}-${dateStr}-${orderNum}` : `${orderPrefix}-${orderNum}`;
            const orderEl = document.getElementById('num-order-preview');
            if (orderEl) orderEl.textContent = orderPreview;

            // Clients
            const clientPrefix = document.getElementById('num-client-prefix')?.value || 'CLI';
            const clientNext = parseInt(document.getElementById('num-client-next')?.value) || 1000;
            const clientPreview = `${clientPrefix}-${clientNext}`;
            const clientEl = document.getElementById('num-client-preview');
            if (clientEl) clientEl.textContent = clientPreview;

            // Articles
            const articlePrefix = document.getElementById('num-article-prefix')?.value || 'ART';
            const articleNext = parseInt(document.getElementById('num-article-next')?.value) || 100;
            const articlePreview = `${articlePrefix}-${articleNext}`;
            const articleEl = document.getElementById('num-article-preview');
            if (articleEl) articleEl.textContent = articlePreview;
        }

        function saveNumberingConfig() {
            // R√©cup√©rer les valeurs
            NumberingConfig.order.prefix = document.getElementById('num-order-prefix').value.trim() || 'CMD';
            NumberingConfig.order.start = parseInt(document.getElementById('num-order-start').value) || 1;
            NumberingConfig.order.next = parseInt(document.getElementById('num-order-next').value) || 1;

            NumberingConfig.client.prefix = document.getElementById('num-client-prefix').value.trim() || 'CLI';
            NumberingConfig.client.start = parseInt(document.getElementById('num-client-start').value) || 1000;
            NumberingConfig.client.next = parseInt(document.getElementById('num-client-next').value) || 1000;

            NumberingConfig.article.prefix = document.getElementById('num-article-prefix').value.trim() || 'ART';
            NumberingConfig.article.start = parseInt(document.getElementById('num-article-start').value) || 100;
            NumberingConfig.article.next = parseInt(document.getElementById('num-article-next').value) || 100;

            NumberingConfig.includeDate = document.getElementById('num-include-date').checked;
            NumberingConfig.zeroPadding = document.getElementById('num-zero-padding').checked;

            // Sauvegarder dans localStorage
            localStorage.setItem('num_order_prefix', NumberingConfig.order.prefix);
            localStorage.setItem('num_order_start', NumberingConfig.order.start);
            localStorage.setItem('num_order_next', NumberingConfig.order.next);

            localStorage.setItem('num_client_prefix', NumberingConfig.client.prefix);
            localStorage.setItem('num_client_start', NumberingConfig.client.start);
            localStorage.setItem('num_client_next', NumberingConfig.client.next);

            localStorage.setItem('num_article_prefix', NumberingConfig.article.prefix);
            localStorage.setItem('num_article_start', NumberingConfig.article.start);
            localStorage.setItem('num_article_next', NumberingConfig.article.next);

            localStorage.setItem('num_include_date', NumberingConfig.includeDate);
            localStorage.setItem('num_zero_padding', NumberingConfig.zeroPadding);

            alert('‚úÖ Configuration de num√©rotation enregistr√©e !');
        }

        // G√©n√©rer un num√©ro de commande
        function generateOrderNumber() {
            const prefix = NumberingConfig.order.prefix;
            const num = NumberingConfig.order.next;
            const padded = NumberingConfig.zeroPadding ? String(num).padStart(3, '0') : num;

            let orderNum;
            if (NumberingConfig.includeDate) {
                const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                orderNum = `${prefix}-${dateStr}-${padded}`;
            } else {
                orderNum = `${prefix}-${padded}`;
            }

            // Incr√©menter le prochain num√©ro
            NumberingConfig.order.next++;
            localStorage.setItem('num_order_next', NumberingConfig.order.next);

            return orderNum;
        }

        // G√©n√©rer un num√©ro de client
        function generateClientNumber() {
            const prefix = NumberingConfig.client.prefix;
            const num = NumberingConfig.client.next;
            const clientNum = `${prefix}-${num}`;

            // Incr√©menter le prochain num√©ro
            NumberingConfig.client.next++;
            localStorage.setItem('num_client_next', NumberingConfig.client.next);

            return clientNum;
        }

        // G√©n√©rer un num√©ro d'article
        function generateArticleNumber() {
            const prefix = NumberingConfig.article.prefix;
            const num = NumberingConfig.article.next;
            const articleNum = `${prefix}-${num}`;

            // Incr√©menter le prochain num√©ro
            NumberingConfig.article.next++;
            localStorage.setItem('num_article_next', NumberingConfig.article.next);

            return articleNum;
        }

        // =====================================================
        // DROPBOX INTEGRATION
        // =====================================================

        // =====================================================
        // DROPBOX OAUTH 2.0 avec REFRESH TOKEN AUTOMATIQUE
        // =====================================================
        
        const DROPBOX_APP_KEY = 'hitg2j5cfahg23h';
        const DROPBOX_APP_SECRET = 'rsyvs10ig62u7ax';
        const DROPBOX_REDIRECT_URI = window.location.origin + window.location.pathname;
        
        const DropboxConfig = {
            token: localStorage.getItem('dropbox_token') || '',
            refreshToken: localStorage.getItem('dropbox_refresh_token') || '',
            tokenExpiresAt: parseInt(localStorage.getItem('dropbox_token_expires_at') || '0'),
            basePath: localStorage.getItem('dropbox_base_path') || '/TRAKIO',
            // AUTO SYNC = TRUE par d√©faut si Dropbox est connect√© (sauf si explicitement d√©sactiv√©)
            autoSync: localStorage.getItem('dropbox_auto_sync') !== 'false',
            connected: false,
            userEmail: localStorage.getItem('dropbox_user_email') || '',
            
            // V√©rifie si Dropbox est disponible (token ou refresh token)
            isAvailable() {
                return !!(this.token || this.refreshToken);
            },
            
            // V√©rifie si on peut synchroniser
            canSync() {
                return this.autoSync && this.isAvailable();
            }
        };

        // Au d√©marrage, rafra√Æchir le token si on a un refresh token
        (async function initDropboxToken() {
            if (DropboxConfig.refreshToken && !DropboxConfig.token) {
                console.log('üîÑ Dropbox: r√©cup√©ration du token au d√©marrage...');
                await refreshDropboxToken();
            } else if (DropboxConfig.refreshToken) {
                // V√©rifier si le token est expir√©
                const isExpired = DropboxConfig.tokenExpiresAt && Date.now() > DropboxConfig.tokenExpiresAt;
                if (isExpired) {
                    console.log('üîÑ Dropbox: token expir√©, rafra√Æchissement...');
                    await refreshDropboxToken();
                }
            }
            
            if (DropboxConfig.token || DropboxConfig.refreshToken) {
                DropboxConfig.connected = true;
            }
        })();

        // G√©n√©rer un code verifier pour PKCE
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // G√©n√©rer le code challenge √† partir du verifier
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // D√©marrer l'authentification OAuth Dropbox
        async function startDropboxOAuth() {
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            // Sauvegarder le code verifier pour l'√©change
            sessionStorage.setItem('dropbox_code_verifier', codeVerifier);
            
            // Construire l'URL d'autorisation
            const authUrl = 'https://www.dropbox.com/oauth2/authorize?' + new URLSearchParams({
                client_id: DROPBOX_APP_KEY,
                response_type: 'code',
                redirect_uri: DROPBOX_REDIRECT_URI,
                code_challenge: codeChallenge,
                code_challenge_method: 'S256',
                token_access_type: 'offline' // IMPORTANT: pour obtenir un refresh token
            });
            
            // Rediriger vers Dropbox
            window.location.href = authUrl;
        }

        // G√©rer le callback OAuth (appel√© au chargement si code pr√©sent dans URL)
        async function handleDropboxOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                console.error('Erreur OAuth Dropbox:', error);
                alert('‚ùå Erreur de connexion Dropbox: ' + error);
                // Nettoyer l'URL
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            if (!code) return; // Pas de code OAuth, rien √† faire
            
            const codeVerifier = sessionStorage.getItem('dropbox_code_verifier');
            if (!codeVerifier) {
                console.error('Code verifier manquant');
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            try {
                // √âchanger le code contre les tokens
                const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        code: code,
                        grant_type: 'authorization_code',
                        redirect_uri: DROPBOX_REDIRECT_URI,
                        client_id: DROPBOX_APP_KEY,
                        client_secret: DROPBOX_APP_SECRET,
                        code_verifier: codeVerifier
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error_description || 'Erreur √©change token');
                }
                
                const data = await response.json();
                
                // Sauvegarder les tokens
                DropboxConfig.token = data.access_token;
                DropboxConfig.refreshToken = data.refresh_token;
                DropboxConfig.tokenExpiresAt = Date.now() + (data.expires_in * 1000) - 60000; // 1 min de marge
                DropboxConfig.connected = true;
                
                localStorage.setItem('dropbox_token', data.access_token);
                localStorage.setItem('dropbox_refresh_token', data.refresh_token);
                localStorage.setItem('dropbox_token_expires_at', DropboxConfig.tokenExpiresAt.toString());
                
                // Nettoyer
                sessionStorage.removeItem('dropbox_code_verifier');
                
                // Nettoyer l'URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // R√©cup√©rer les infos du compte
                await updateDropboxAccountInfo();
                
                console.log('‚úÖ Dropbox connect√© avec refresh token');
                alert('‚úÖ Connexion Dropbox r√©ussie !\n\nVotre compte est maintenant li√©.\nLe token sera renouvel√© automatiquement.');
                
                // D√©marrer le refresh automatique
                startDropboxAutoRefresh();
                
                // Mettre √† jour l'interface
                updateDropboxUI();
                
            } catch (error) {
                console.error('Erreur OAuth:', error);
                alert('‚ùå Erreur de connexion: ' + error.message);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Rafra√Æchir le token d'acc√®s automatiquement
        async function refreshDropboxToken() {
            if (!DropboxConfig.refreshToken) {
                console.warn('Pas de refresh token disponible');
                return false;
            }
            
            try {
                console.log('üîÑ Rafra√Æchissement du token Dropbox...');
                
                const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'refresh_token',
                        refresh_token: DropboxConfig.refreshToken,
                        client_id: DROPBOX_APP_KEY,
                        client_secret: DROPBOX_APP_SECRET
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erreur refresh:', errorData);
                    
                    // Si le refresh token est invalide, on doit se reconnecter
                    if (errorData.error === 'invalid_grant') {
                        disconnectDropbox();
                        return false;
                    }
                    throw new Error(errorData.error_description || 'Erreur refresh token');
                }
                
                const data = await response.json();
                
                // Mettre √† jour le token
                DropboxConfig.token = data.access_token;
                DropboxConfig.tokenExpiresAt = Date.now() + (data.expires_in * 1000) - 60000;
                
                localStorage.setItem('dropbox_token', data.access_token);
                localStorage.setItem('dropbox_token_expires_at', DropboxConfig.tokenExpiresAt.toString());
                
                console.log('‚úÖ Token Dropbox rafra√Æchi');
                return true;
                
            } catch (error) {
                console.error('Erreur refresh token:', error);
                return false;
            }
        }

        // Obtenir un token valide (rafra√Æchit automatiquement si expir√©)
        async function getValidDropboxToken() {
            // Si pas de token du tout
            if (!DropboxConfig.token && !DropboxConfig.refreshToken) {
                return null;
            }
            
            // V√©rifier si le token est expir√© (ou expire dans moins de 5 minutes)
            const isExpired = DropboxConfig.tokenExpiresAt && Date.now() > (DropboxConfig.tokenExpiresAt - 300000);
            
            if (isExpired && DropboxConfig.refreshToken) {
                const refreshed = await refreshDropboxToken();
                if (!refreshed) {
                    return null;
                }
            }
            
            return DropboxConfig.token;
        }

        // D√©connecter Dropbox
        function disconnectDropbox() {
            DropboxConfig.token = '';
            DropboxConfig.refreshToken = '';
            DropboxConfig.tokenExpiresAt = 0;
            DropboxConfig.connected = false;
            DropboxConfig.userEmail = '';
            
            localStorage.removeItem('dropbox_token');
            localStorage.removeItem('dropbox_refresh_token');
            localStorage.removeItem('dropbox_token_expires_at');
            localStorage.removeItem('dropbox_user_email');
            
            // Arr√™ter le refresh automatique
            if (window._dropboxRefreshInterval) {
                clearInterval(window._dropboxRefreshInterval);
                window._dropboxRefreshInterval = null;
            }
            
            updateDropboxUI();
            alert('‚úÖ Dropbox d√©connect√©');
        }

        // =====================================================
        // REFRESH AUTOMATIQUE EN ARRI√àRE-PLAN
        // =====================================================
        
        // D√©marrer le syst√®me de refresh automatique
        function startDropboxAutoRefresh() {
            // V√©rifier toutes les 30 minutes
            const CHECK_INTERVAL = 30 * 60 * 1000; // 30 minutes
            const REFRESH_BEFORE_EXPIRY = 60 * 60 * 1000; // Rafra√Æchir 1h avant expiration
            
            // Arr√™ter l'ancien interval s'il existe
            if (window._dropboxRefreshInterval) {
                clearInterval(window._dropboxRefreshInterval);
            }
            
            // Fonction de v√©rification et refresh
            async function checkAndRefresh() {
                // Ignorer si pas de refresh token
                if (!DropboxConfig.refreshToken) return;
                
                // V√©rifier si le token expire bient√¥t
                const timeUntilExpiry = DropboxConfig.tokenExpiresAt - Date.now();
                
                if (timeUntilExpiry < REFRESH_BEFORE_EXPIRY) {
                    console.log('üîÑ Refresh automatique du token Dropbox...');
                    const success = await refreshDropboxToken();
                    if (success) {
                        console.log('‚úÖ Token Dropbox renouvel√© automatiquement');
                        updateDropboxUI();
                    }
                }
            }
            
            // V√©rifier imm√©diatement au d√©marrage
            checkAndRefresh();
            
            // Puis toutes les 30 minutes
            window._dropboxRefreshInterval = setInterval(checkAndRefresh, CHECK_INTERVAL);
            
            console.log('üîÅ Refresh automatique Dropbox activ√© (toutes les 30 min)');
        }
        
        // Au chargement: reconnecter automatiquement si refresh token disponible
        async function initDropboxConnection() {
            // Si on a un refresh token mais pas de token valide, rafra√Æchir
            if (DropboxConfig.refreshToken) {
                const timeUntilExpiry = DropboxConfig.tokenExpiresAt - Date.now();
                
                // Token expir√© ou expiration imminente (< 10 min)
                if (!DropboxConfig.token || timeUntilExpiry < 10 * 60 * 1000) {
                    console.log('üîÑ Reconnexion automatique Dropbox...');
                    const success = await refreshDropboxToken();
                    if (success) {
                        DropboxConfig.connected = true;
                        await updateDropboxAccountInfo();
                        console.log('‚úÖ Dropbox reconnect√© automatiquement');
                    }
                } else {
                    // Token encore valide
                    DropboxConfig.connected = true;
                }
                
                // D√©marrer le refresh automatique
                startDropboxAutoRefresh();
                
                // D√âMARRER AUTOMATIQUEMENT LA SYNC SI DROPBOX EST CONNECT√â
                if (DropboxConfig.connected && DropboxConfig.autoSync) {
                    console.log('üîÑ D√©marrage automatique de la synchronisation...');
                    startDropboxSync();
                    
                    // SI ADMIN: Publier automatiquement la version sur Dropbox
                    setTimeout(() => {
                        autoPublishVersionIfAdmin();
                    }, 3000); // Attendre que l'utilisateur soit connect√©
                }
            }
            
            updateDropboxUI();
        }

        // Mettre √† jour les infos du compte
        async function updateDropboxAccountInfo() {
            const token = await getValidDropboxToken();
            if (!token) return;
            
            try {
                const response = await fetch('https://api.dropboxapi.com/2/users/get_current_account', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    DropboxConfig.userEmail = data.email;
                    DropboxConfig.connected = true;
                    localStorage.setItem('dropbox_user_email', data.email);
                }
            } catch (e) {
                console.error('Erreur r√©cup√©ration compte:', e);
            }
        }

        // Mettre √† jour l'interface Dropbox
        function updateDropboxUI() {
            const statusIcon = document.getElementById('dropbox-status-icon');
            const statusText = document.getElementById('dropbox-status-text');
            const statusDetail = document.getElementById('dropbox-status-detail');
            const disconnectBtn = document.getElementById('dropbox-disconnect-btn');
            const authSection = document.getElementById('dropbox-auth-section');
            
            if (DropboxConfig.connected || DropboxConfig.refreshToken) {
                if (statusIcon) statusIcon.textContent = 'üü¢';
                if (statusText) statusText.textContent = 'Connect√©';
                
                // Calculer le temps restant avant refresh
                let detailText = DropboxConfig.userEmail || 'Compte li√©';
                if (DropboxConfig.tokenExpiresAt) {
                    const timeLeft = DropboxConfig.tokenExpiresAt - Date.now();
                    if (timeLeft > 0) {
                        const hoursLeft = Math.floor(timeLeft / (60 * 60 * 1000));
                        const minsLeft = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
                        detailText += ` ‚Ä¢ üîÑ Auto-refresh dans ${hoursLeft}h${minsLeft.toString().padStart(2, '0')}`;
                    } else {
                        detailText += ' ‚Ä¢ üîÑ Refresh en cours...';
                    }
                }
                
                if (statusDetail) statusDetail.textContent = detailText;
                if (disconnectBtn) disconnectBtn.style.display = 'block';
                if (authSection) authSection.style.display = 'none';
            } else if (DropboxConfig.token) {
                // Token manuel (ancien syst√®me)
                if (statusIcon) statusIcon.textContent = 'üü°';
                if (statusText) statusText.textContent = 'Token manuel';
                if (statusDetail) statusDetail.textContent = '‚ö†Ô∏è Token sans refresh auto (expire dans 4h)';
                if (disconnectBtn) disconnectBtn.style.display = 'block';
                if (authSection) authSection.style.display = 'none';
            } else {
                if (statusIcon) statusIcon.textContent = '‚ö™';
                if (statusText) statusText.textContent = 'Non connect√©';
                if (statusDetail) statusDetail.textContent = 'Cliquez sur "Se connecter" pour lier votre compte';
                if (disconnectBtn) disconnectBtn.style.display = 'none';
                if (authSection) authSection.style.display = 'block';
            }
        }

        // Sauvegarder un token manuel (mode avanc√©)
        function saveManualToken() {
            const token = document.getElementById('dropbox-token').value.trim();
            if (!token) {
                alert('‚ùå Veuillez entrer un token');
                return;
            }
            
            DropboxConfig.token = token;
            DropboxConfig.refreshToken = ''; // Pas de refresh pour token manuel
            DropboxConfig.tokenExpiresAt = 0;
            
            localStorage.setItem('dropbox_token', token);
            localStorage.removeItem('dropbox_refresh_token');
            localStorage.removeItem('dropbox_token_expires_at');
            
            testDropboxConnection(false);
        }

        function initDropboxSettings() {
            // Charger les param√®tres
            const tokenInput = document.getElementById('dropbox-token');
            if (tokenInput) tokenInput.value = DropboxConfig.token;
            
            const basePathInput = document.getElementById('dropbox-base-path');
            if (basePathInput) basePathInput.value = DropboxConfig.basePath;
            
            const pathDisplay = document.getElementById('dropbox-path-display');
            if (pathDisplay) pathDisplay.textContent = DropboxConfig.basePath;

            if (DropboxConfig.autoSync) {
                const autoSyncToggle = document.getElementById('dropbox-auto-sync');
                if (autoSyncToggle) autoSyncToggle.classList.add('active');
            }

            // Mettre √† jour le chemin affich√© en temps r√©el
            const basePathEl = document.getElementById('dropbox-base-path');
            if (basePathEl) {
                basePathEl.addEventListener('input', function() {
                    const display = document.getElementById('dropbox-path-display');
                    if (display) display.textContent = this.value || '/TRAKIO';
                });
            }

            // V√©rifier la connexion si token ou refresh token existe
            if (DropboxConfig.refreshToken || DropboxConfig.token) {
                testDropboxConnection(true);
            }
            
            // Mettre √† jour l'interface
            updateDropboxUI();
        }

        function toggleDropboxSync() {
            // Fonction appel√©e si n√©cessaire - le toggle est g√©r√© automatiquement
            DropboxConfig.autoSync = document.getElementById('dropbox-auto-sync').classList.contains('active');
        }

        function saveDropboxSettings() {
            DropboxConfig.token = document.getElementById('dropbox-token').value.trim();
            DropboxConfig.basePath = document.getElementById('dropbox-base-path').value.trim() || '/TRAKIO';
            DropboxConfig.autoSync = document.getElementById('dropbox-auto-sync').classList.contains('active');

            localStorage.setItem('dropbox_token', DropboxConfig.token);
            localStorage.setItem('dropbox_base_path', DropboxConfig.basePath);
            localStorage.setItem('dropbox_auto_sync', DropboxConfig.autoSync);

            // G√©rer la sync automatique
            if (DropboxConfig.autoSync && DropboxConfig.connected) {
                startDropboxSync();
                alert('‚úÖ Configuration enregistr√©e !\n\nüîÑ Synchronisation automatique activ√©e.\nLes donn√©es seront synchronis√©es toutes les 5 minutes.');
            } else if (!DropboxConfig.autoSync) {
                stopDropboxSync();
                alert('‚úÖ Configuration Dropbox enregistr√©e !\n\n‚èπÔ∏è Synchronisation automatique d√©sactiv√©e.');
            } else {
                alert('‚úÖ Configuration Dropbox enregistr√©e !');
            }

            if (DropboxConfig.token) {
                testDropboxConnection(true).then(connected => {
                    if (connected && DropboxConfig.autoSync) {
                        startDropboxSync();
                    }
                });
            }
        }

        async function testDropboxConnection(silent = false) {
            // Utiliser le syst√®me de refresh automatique
            let token = await getValidDropboxToken();
            
            // Fallback sur le token manuel si pas de refresh token
            if (!token) {
                const manualToken = document.getElementById('dropbox-token')?.value.trim();
                if (manualToken) {
                    token = manualToken;
                }
            }

            if (!token) {
                updateDropboxStatus('error', 'Non connect√©', 'Connectez-vous √† Dropbox');
                if (!silent) alert('‚ùå Veuillez vous connecter √† Dropbox');
                return false;
            }

            updateDropboxStatus('loading', 'Test en cours...', 'Connexion √† Dropbox...');

            try {
                const response = await fetch('https://api.dropboxapi.com/2/users/get_current_account', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    body: null
                });

                if (response.ok) {
                    const data = await response.json();
                    DropboxConfig.connected = true;
                    DropboxConfig.token = token;
                    DropboxConfig.userEmail = data.email;
                    localStorage.setItem('dropbox_user_email', data.email);
                    
                    const hasRefresh = DropboxConfig.refreshToken ? ' (auto-refresh ‚úì)' : '';
                    updateDropboxStatus('success', 'Connect√©' + hasRefresh, 'Compte: ' + data.email);
                    updateDropboxUI();
                    
                    if (!silent) alert('‚úÖ Connexion r√©ussie !\n\nCompte: ' + data.name.display_name + '\nEmail: ' + data.email + (hasRefresh ? '\n\nüîÑ Refresh automatique actif' : ''));
                    return true;
                } else {
                    // Token expir√© ou invalide
                    let errorMsg = 'Token invalide ou expir√©';
                    try {
                        const errorData = await response.json();
                        if (errorData.error_summary) {
                            errorMsg = errorData.error_summary;
                        }
                    } catch(e) {}
                    
                    // Si on a un refresh token, essayer de rafra√Æchir
                    if (DropboxConfig.refreshToken && response.status === 401) {
                        console.log('Token expir√©, tentative de refresh...');
                        const refreshed = await refreshDropboxToken();
                        if (refreshed) {
                            return await testDropboxConnection(silent);
                        }
                    }

                    DropboxConfig.connected = false;
                    updateDropboxStatus('error', 'Erreur', errorMsg);
                    updateDropboxUI();
                    if (!silent) alert('‚ùå Erreur de connexion:\n' + errorMsg + '\n\nReconnectez-vous √† Dropbox.');
                    return false;
                }
            } catch (error) {
                DropboxConfig.connected = false;
                updateDropboxStatus('error', 'Erreur r√©seau', error.message);
                updateDropboxUI();
                if (!silent) alert('‚ùå Erreur de connexion:\n' + error.message);
                return false;
            }
        }

        function updateDropboxStatus(status, text, detail) {
            const icons = { success: 'üü¢', error: 'üî¥', loading: 'üü°', default: '‚ö™' };
            document.getElementById('dropbox-status-icon').textContent = icons[status] || icons.default;
            document.getElementById('dropbox-status-text').textContent = text;
            document.getElementById('dropbox-status-detail').textContent = detail;

            const statusDiv = document.getElementById('dropbox-status');
            statusDiv.style.background = status === 'success' ? 'var(--accent-primary)15' :
                                         status === 'error' ? 'var(--accent-danger)15' : 'var(--bg-primary)';
        }

        async function createDropboxFolders() {
            const token = document.getElementById('dropbox-token').value.trim() || DropboxConfig.token;
            const basePath = document.getElementById('dropbox-base-path').value.trim() || DropboxConfig.basePath;

            if (!token) {
                alert('‚ùå Veuillez d\'abord configurer le token Dropbox');
                return;
            }

            const folders = ['Commandes', 'Clients', 'Articles', 'Factures', 'Rapports', 'System', 'System/Backups'];
            let created = 0;
            let errors = [];

            for (const folder of folders) {
                const path = basePath + '/' + folder;
                try {
                    const response = await fetch('https://api.dropboxapi.com/2/files/create_folder_v2', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ path: path, autorename: false })
                    });

                    if (response.ok || response.status === 409) { // 409 = dossier existe d√©j√†
                        created++;
                    } else {
                        errors.push(folder);
                    }
                } catch (e) {
                    errors.push(folder);
                }
            }

            if (errors.length === 0) {
                alert('‚úÖ Structure cr√©√©e avec succ√®s !\n\n' + basePath + '\n‚îú‚îÄ‚îÄ Commandes\n‚îú‚îÄ‚îÄ Clients\n‚îú‚îÄ‚îÄ Articles\n‚îú‚îÄ‚îÄ Factures\n‚îú‚îÄ‚îÄ Rapports\n‚îî‚îÄ‚îÄ System\n    ‚îî‚îÄ‚îÄ Backups (sauvegardes compl√®tes)');
            } else {
                alert('‚ö†Ô∏è Dossiers cr√©√©s: ' + created + '/' + folders.length + '\nErreurs: ' + errors.join(', '));
            }
        }

        async function uploadToDropbox(filePath, content, contentType = 'application/json') {
            // Obtenir un token valide
            const token = await getValidDropboxToken();
            if (!token) return false;
            // Pour les uploads automatiques, v√©rifier autoSync
            // Les uploads manuels passent forceUpload=true
            if (!DropboxConfig.autoSync && !DropboxConfig._forceUpload) return false;

            try {
                const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/octet-stream',
                        'Dropbox-API-Arg': JSON.stringify({
                            path: filePath,
                            mode: 'overwrite',
                            autorename: false,
                            mute: true
                        })
                    },
                    body: content
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Dropbox error:', response.status, errorData);
                }

                return response.ok;
            } catch (error) {
                console.error('Dropbox upload error:', error);
                return false;
            }
        }

        // Upload direct (pour boutons manuels - ignore autoSync)
        async function uploadToDropboxDirect(filePath, content) {
            // Obtenir un token valide
            const token = await getValidDropboxToken();
            if (!token) return false;

            try {
                const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/octet-stream',
                        'Dropbox-API-Arg': JSON.stringify({
                            path: filePath,
                            mode: 'overwrite',
                            autorename: false,
                            mute: true
                        })
                    },
                    body: content
                });

                return response.ok;
            } catch (error) {
                console.error('Dropbox upload error:', error);
                return false;
            }
        }

        async function saveOrderToDropbox(order) {
            // getValidDropboxToken rafra√Æchit automatiquement si expir√©
            const token = await getValidDropboxToken();
            if (!DropboxConfig.autoSync || !token) return;

            const basePath = DropboxConfig.basePath;
            const date = new Date(order.date);
            const yearMonth = date.toISOString().slice(0, 7); // YYYY-MM

            // Sauvegarder le JSON de la commande
            const jsonPath = basePath + '/Commandes/' + yearMonth + '/' + order.id + '.json';
            await uploadToDropbox(jsonPath, JSON.stringify(order, null, 2));

            console.log('üì§ Commande sauvegard√©e sur Dropbox:', order.id);
        }

        async function saveClientToDropbox(client) {
            const token = await getValidDropboxToken();
            if (!DropboxConfig.autoSync || !token) return;

            const basePath = DropboxConfig.basePath;
            const jsonPath = basePath + '/Clients/' + client.num + '_' + client.name.replace(/[^a-zA-Z0-9]/g, '_') + '.json';
            await uploadToDropbox(jsonPath, JSON.stringify(client, null, 2));

            console.log('üì§ Client sauvegard√© sur Dropbox:', client.name);
        }

        async function saveArticleToDropbox(article) {
            if (!DropboxConfig.canSync()) return;

            const basePath = DropboxConfig.basePath;
            const jsonPath = basePath + '/Articles/' + article.num + '_' + article.name.replace(/[^a-zA-Z0-9]/g, '_') + '.json';
            await uploadToDropbox(jsonPath, JSON.stringify(article, null, 2));

            console.log('üì§ Article sauvegard√© sur Dropbox:', article.name);
        }

        // Sauvegarder toutes les donn√©es
        async function syncAllToDropbox() {
            if (!DropboxConfig.isAvailable()) {
                alert('‚ùå Dropbox non configur√©');
                return;
            }
            
            // Obtenir un token valide
            const token = await getValidDropboxToken();
            if (!token) {
                alert('‚ùå Impossible d\'obtenir un token Dropbox valide');
                return;
            }

            const basePath = DropboxConfig.basePath;

            // Clients
            const clientsJson = JSON.stringify(QOData.clients, null, 2);
            await uploadToDropbox(basePath + '/Clients/_all_clients.json', clientsJson);

            // Articles
            const articlesJson = JSON.stringify(ArticlesData, null, 2);
            await uploadToDropbox(basePath + '/Articles/_all_articles.json', articlesJson);

            // Commandes
            const ordersJson = JSON.stringify(QOData.orders, null, 2);
            await uploadToDropbox(basePath + '/Commandes/_all_orders.json', ordersJson);

            // Utilisateurs (pour multi-appareils)
            const usersJson = JSON.stringify(UsersData.users, null, 2);
            await uploadToDropbox(basePath + '/System/_users.json', usersJson);

            // Timestamp de derni√®re sync
            const syncMeta = { lastSync: new Date().toISOString(), device: navigator.userAgent.substring(0, 50) };
            await uploadToDropbox(basePath + '/System/_sync_meta.json', JSON.stringify(syncMeta, null, 2));

            DropboxSync.lastSync = new Date();
            updateSyncIndicator('success');
            alert('‚úÖ Toutes les donn√©es synchronis√©es sur Dropbox !');
        }

        // =====================================================
        // SYNCHRONISATION DROPBOX MULTI-UTILISATEURS
        // =====================================================

        const DropboxSync = {
            enabled: false,
            interval: null,
            countdownInterval: null,
            syncFrequency: 300000, // 5 minutes (respecte les limites Dropbox)
            lastSync: null,
            nextSyncTime: null,
            isSyncing: false
        };

        // =====================================================
        // SYST√àME DE D√âCOMPTE SYNC
        // =====================================================

        function startSyncCountdown() {
            // D√©finir le prochain sync
            DropboxSync.nextSyncTime = Date.now() + DropboxSync.syncFrequency;
            
            // Mettre √† jour le d√©compte toutes les secondes
            if (DropboxSync.countdownInterval) {
                clearInterval(DropboxSync.countdownInterval);
            }
            
            DropboxSync.countdownInterval = setInterval(() => {
                updateSyncCountdown();
            }, 1000);
            
            updateSyncCountdown();
        }

        function updateSyncCountdown() {
            const countdownEl = document.getElementById('sync-countdown');
            const updateBadge = document.getElementById('sync-update-badge');
            if (!countdownEl) return;
            
            // G√©rer le badge de mise √† jour en attente
            if (updateBadge) {
                if (UpdateSystem.updateAvailable && UpdateSystem.newVersion) {
                    updateBadge.textContent = 'üÜï v' + UpdateSystem.newVersion;
                    updateBadge.style.display = 'inline';
                    updateBadge.title = 'Mise √† jour disponible ! Cliquez pour recharger.';
                } else {
                    updateBadge.style.display = 'none';
                }
            }
            
            if (!DropboxConfig.canSync()) {
                countdownEl.textContent = 'Off';
                return;
            }
            
            if (DropboxSync.isSyncing) {
                countdownEl.textContent = 'Sync...';
                return;
            }
            
            if (!DropboxSync.nextSyncTime) {
                countdownEl.textContent = 'Sync';
                return;
            }
            
            const remaining = Math.max(0, DropboxSync.nextSyncTime - Date.now());
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // =====================================================
        // SYST√àME DE MISE √Ä JOUR AUTOMATIQUE
        // =====================================================

        const UpdateSystem = {
            checking: false,
            updateAvailable: false,
            newVersion: null,
            // Pages o√π on ne doit PAS interrompre l'utilisateur
            protectedPages: ['quickorder', 'myfish', 'commande'],
            // Stocker la version d√©j√† install√©e/vue pour ne pas redemander
            acknowledgedVersion: localStorage.getItem('trakio_acknowledged_version') || ''
        };

        // Au chargement, nettoyer l'URL et v√©rifier si mise √† jour r√©ussie
        (function cleanupAfterUpdate() {
            const url = new URL(window.location.href);
            
            // Si on a un param√®tre _v, c'est qu'on vient de recharger pour mise √† jour
            if (url.searchParams.has('_v')) {
                // Nettoyer l'URL
                url.searchParams.delete('_v');
                window.history.replaceState({}, document.title, url.pathname + url.search);
                
                // V√©rifier si la mise √† jour a r√©ussi
                const acknowledgedVersion = localStorage.getItem('trakio_acknowledged_version');
                if (acknowledgedVersion && acknowledgedVersion === APP_VERSION) {
                    // Mise √† jour r√©ussie ! Nettoyer
                    localStorage.removeItem('trakio_acknowledged_version');
                    console.log('‚úÖ Mise √† jour vers v' + APP_VERSION + ' r√©ussie !');
                    
                    // Afficher une notification
                    setTimeout(() => {
                        showToast('‚úÖ Mise √† jour v' + APP_VERSION + ' install√©e !');
                    }, 1000);
                }
            }
        })();

        // V√©rifier si l'utilisateur est sur une page prot√©g√©e (commande en cours)
        function isUserBusy() {
            // V√©rifier la page actuelle
            if (UpdateSystem.protectedPages.includes(currentPage)) {
                return true;
            }
            
            // V√©rifier s'il y a un panier en cours
            if (typeof QOData !== 'undefined' && QOData.cart && QOData.cart.length > 0) {
                return true;
            }
            
            return false;
        }

        // V√©rifier si une mise √† jour est disponible (appel√© UNIQUEMENT par sync auto)
        async function checkForUpdate() {
            if (UpdateSystem.checking) return;
            if (!DropboxConfig.isAvailable()) return;
            
            UpdateSystem.checking = true;
            
            try {
                const token = await getValidDropboxToken();
                if (!token) return;
                
                // T√©l√©charger le fichier version.json depuis Dropbox
                const versionData = await downloadFromDropbox(DropboxConfig.basePath + '/System/version.json');
                
                if (versionData && versionData.version) {
                    const currentVersion = APP_VERSION;
                    const serverVersion = versionData.version;
                    
                    // Si on a d√©j√† la bonne version, rien √† faire
                    if (serverVersion === currentVersion) {
                        UpdateSystem.updateAvailable = false;
                        UpdateSystem.newVersion = null;
                        // Nettoyer l'acknowledged version si on est √† jour
                        localStorage.removeItem('trakio_acknowledged_version');
                        // Mettre √† jour le badge (le cacher)
                        updateSyncCountdown();
                        return;
                    }
                    
                    // Comparer les versions
                    if (isNewerVersion(serverVersion, currentVersion)) {
                        console.log('üÜï Mise √† jour disponible:', currentVersion, '‚Üí', serverVersion);
                        UpdateSystem.updateAvailable = true;
                        UpdateSystem.newVersion = serverVersion;
                        
                        // Mettre √† jour le badge dans la barre de sync
                        updateSyncCountdown();
                        
                        // Si l'utilisateur est occup√© (sur une commande), attendre
                        if (isUserBusy()) {
                            console.log('‚è≥ Utilisateur occup√© - mise √† jour report√©e √† la prochaine sync');
                            // Petite notification discr√®te en bas
                            showUpdateNotification(serverVersion);
                            return;
                        }
                        
                        // Afficher le modal de mise √† jour
                        showUpdateModal(currentVersion, serverVersion, versionData.changelog || []);
                    }
                }
            } catch (error) {
                console.log('Erreur v√©rification mise √† jour:', error);
            } finally {
                UpdateSystem.checking = false;
            }
        }

        // Afficher une notification discr√®te (au lieu du modal bloquant)
        function showUpdateNotification(newVersion) {
            // V√©rifier si la notification existe d√©j√†
            if (document.getElementById('update-notification')) return;
            
            const notif = document.createElement('div');
            notif.id = 'update-notification';
            notif.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                color: #000;
                padding: 16px 20px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(6,214,160,0.4);
                z-index: 9999;
                cursor: pointer;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            notif.innerHTML = `
                <div style="font-weight:700; margin-bottom:4px;">üÜï Mise √† jour v${newVersion}</div>
                <div style="font-size:12px; opacity:0.9;">Terminez votre commande, puis rechargez</div>
            `;
            notif.onclick = () => {
                notif.remove();
                // Si plus occup√©, proposer la mise √† jour
                if (!isUserBusy()) {
                    showUpdateModal(APP_VERSION, newVersion, []);
                }
            };
            
            document.body.appendChild(notif);
            
            // Auto-hide apr√®s 10 secondes
            setTimeout(() => {
                if (notif.parentNode) notif.remove();
            }, 10000);
        }

        // Forcer un rechargement complet sans cache
        function forceHardReload() {
            // Marquer la version qu'on va installer
            const targetVersion = UpdateSystem.newVersion || '';
            if (targetVersion) {
                localStorage.setItem('trakio_acknowledged_version', targetVersion);
            }
            
            // Vider le cache si possible
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            
            // Cache bust avec timestamp dans l'URL
            const url = new URL(window.location.href);
            url.searchParams.set('_v', Date.now());
            
            // Rediriger
            window.location.href = url.toString();
        }

        // Comparer les versions (ex: "3.1.3" > "3.1.2")
        function isNewerVersion(newV, currentV) {
            const newParts = newV.split('.').map(n => parseInt(n) || 0);
            const currentParts = currentV.split('.').map(n => parseInt(n) || 0);
            
            for (let i = 0; i < Math.max(newParts.length, currentParts.length); i++) {
                const a = newParts[i] || 0;
                const b = currentParts[i] || 0;
                if (a > b) return true;
                if (a < b) return false;
            }
            return false;
        }

        // Afficher le modal de mise √† jour bloquant
        function showUpdateModal(currentVersion, newVersion, changelog) {
            const modal = document.getElementById('update-modal');
            if (!modal) return;
            
            document.getElementById('update-current-version').textContent = 'v' + currentVersion;
            document.getElementById('update-new-version').textContent = 'v' + newVersion;
            
            modal.style.display = 'flex';
            
            // Simuler le chargement
            let progress = 0;
            const progressBar = document.getElementById('update-progress-bar');
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    
                    // Mise √† jour termin√©e
                    document.getElementById('update-loader').innerHTML = '<div style="font-size:60px;">‚úÖ</div>';
                    document.getElementById('update-icon').textContent = '‚úÖ';
                    document.getElementById('update-message').innerHTML = 'Mise √† jour pr√™te !<br>Cliquez sur le bouton pour recharger.';
                    document.getElementById('update-reload-btn').style.display = 'block';
                }
            }, 200);
        }

        // Publier une mise √† jour (pour admin)
        async function publishUpdate(version, changelog, silent = false) {
            if (!DropboxConfig.isAvailable()) {
                if (!silent) alert('‚ùå Dropbox non configur√©');
                return false;
            }
            
            const token = await getValidDropboxToken();
            if (!token) {
                if (!silent) alert('‚ùå Token Dropbox invalide');
                return false;
            }
            
            const versionData = {
                version: version,
                publishedAt: new Date().toISOString(),
                changelog: changelog || [],
                publishedBy: UsersData.currentUser?.name || 'Admin'
            };
            
            try {
                const result = await uploadToDropboxDirect(
                    DropboxConfig.basePath + '/System/version.json',
                    JSON.stringify(versionData, null, 2)
                );
                
                if (result) {
                    console.log(`‚úÖ Version ${version} publi√©e sur Dropbox`);
                    if (!silent) {
                        alert(`‚úÖ Mise √† jour v${version} publi√©e !\n\nTous les utilisateurs recevront la notification lors de leur prochaine synchronisation (max 5 min).`);
                    }
                    return true;
                } else {
                    if (!silent) alert('‚ùå Erreur lors de la publication');
                    return false;
                }
            } catch (error) {
                console.error('Erreur publication:', error);
                if (!silent) alert('‚ùå Erreur: ' + error.message);
                return false;
            }
        }

        // AUTO-PUBLICATION: Si admin, v√©rifier et publier automatiquement la nouvelle version
        async function autoPublishVersionIfAdmin() {
            // Attendre que tout soit initialis√©
            if (!DropboxConfig.isAvailable() || !DropboxConfig.connected) return;
            
            // V√©rifier si l'utilisateur est admin
            const user = UsersData.currentUser;
            const isAdmin = user?.role === 'admin' || user?.isAdmin;
            if (!isAdmin) {
                console.log('üë§ Utilisateur non-admin, pas de publication automatique');
                return;
            }
            
            try {
                const token = await getValidDropboxToken();
                if (!token) return;
                
                // T√©l√©charger la version actuelle sur Dropbox
                const remoteVersion = await downloadFromDropbox(DropboxConfig.basePath + '/System/version.json');
                
                // Si pas de version.json ou version plus ancienne ‚Üí publier
                if (!remoteVersion || !remoteVersion.version) {
                    console.log('üì¢ Admin: Aucune version sur Dropbox, publication de v' + APP_VERSION);
                    await publishUpdate(APP_VERSION, VERSION_CHANGELOG[APP_VERSION] || [], true);
                    showToast(`üì¢ Version ${APP_VERSION} publi√©e sur Dropbox`);
                } else if (isNewerVersion(APP_VERSION, remoteVersion.version)) {
                    console.log('üì¢ Admin: Nouvelle version d√©tect√©e, publication de v' + APP_VERSION);
                    await publishUpdate(APP_VERSION, VERSION_CHANGELOG[APP_VERSION] || [], true);
                    showToast(`üì¢ Mise √† jour ${APP_VERSION} publi√©e automatiquement`);
                } else {
                    console.log('‚úÖ Version Dropbox d√©j√† √† jour: v' + remoteVersion.version);
                }
            } catch (error) {
                console.log('Erreur auto-publication:', error);
            }
        }

        // Afficher le modal de publication
        function showPublishUpdateModal() {
            if (!confirm(`üì¢ Publier la version ${APP_VERSION} ?\n\nCette action va notifier TOUS les utilisateurs connect√©s qu'une mise √† jour est disponible.\n\nIls devront recharger leur page pour obtenir la nouvelle version.\n\nContinuer ?`)) {
                return;
            }
            
            // Demander les notes de version
            const changelog = prompt('Notes de version (optionnel):\nExemple: Correction bug sync, Nouvelle fonction X', '');
            
            const changelogArray = changelog ? changelog.split(',').map(s => s.trim()) : [];
            
            publishUpdate(APP_VERSION, changelogArray);
        }

        // Forcer la sync maintenant (clic manuel - ne v√©rifie PAS les mises √† jour)
        async function forceSyncNow() {
            if (DropboxSync.isSyncing) {
                showToast('‚è≥ Synchronisation d√©j√† en cours...');
                return;
            }
            
            if (!DropboxConfig.isAvailable()) {
                showToast('‚ö†Ô∏è Dropbox non configur√©');
                return;
            }
            
            // Reset du d√©compte
            DropboxSync.nextSyncTime = Date.now() + DropboxSync.syncFrequency;
            updateSyncCountdown();
            
            // Sync manuelle - PAS de v√©rification de mise √† jour
            // (les mises √† jour sont v√©rifi√©es uniquement lors de la sync auto)
            showSyncNotification('üîÑ Synchronisation en cours...');
            
            DropboxSync.isSyncing = true;
            updateSyncIndicator('syncing');
            
            try {
                // 1. T√©l√©charger depuis Dropbox
                await syncFromDropbox(true);
                
                // 2. Envoyer les modifications locales
                await syncToDropbox('all');
                
                updateSyncIndicator('success');
                DropboxSync.lastSync = new Date();
                showSyncNotification('‚úÖ Synchronisation termin√©e !');
            } catch (error) {
                console.error('Erreur sync:', error);
                updateSyncIndicator('error');
                showSyncNotification('‚ö†Ô∏è Erreur de sync');
            } finally {
                DropboxSync.isSyncing = false;
                updateSyncCountdown();
            }
        }

        // T√©l√©charger un fichier depuis Dropbox
        async function downloadFromDropbox(path) {
            // Obtenir un token valide
            const token = await getValidDropboxToken();
            if (!token) return null;

            try {
                const response = await fetch('https://content.dropboxapi.com/2/files/download', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Dropbox-API-Arg': JSON.stringify({ path: path })
                    }
                });

                if (response.ok) {
                    const text = await response.text();
                    return JSON.parse(text);
                } else if (response.status === 409) {
                    // Fichier n'existe pas
                    return null;
                }
                return null;
            } catch (error) {
                console.log('Dropbox download error:', error);
                return null;
            }
        }

        // Synchroniser depuis Dropbox (t√©l√©charger les donn√©es)
        async function syncFromDropbox(silent = true) {
            // Obtenir un token valide
            const token = await getValidDropboxToken();
            if (!token || !DropboxConfig.connected) {
                if (!silent) alert('‚ùå Dropbox non connect√©');
                return false;
            }

            if (DropboxSync.isSyncing) return false;
            DropboxSync.isSyncing = true;
            updateSyncIndicator('syncing');

            const basePath = DropboxConfig.basePath;
            let updated = false;

            try {
                // T√©l√©charger les clients
                const remoteClients = await downloadFromDropbox(basePath + '/Clients/_all_clients.json');
                if (remoteClients && Array.isArray(remoteClients) && remoteClients.length > 0) {
                    // Fusionner les donn√©es (garder les plus r√©centes)
                    const mergedClients = mergeData(QOData.clients, remoteClients, 'id');
                    if (JSON.stringify(mergedClients) !== JSON.stringify(QOData.clients)) {
                        QOData.clients = mergedClients;
                        saveQOData('clients');
                        updated = true;
                    }
                }

                // T√©l√©charger les produits pour commandes rapides (QOData.products)
                const remoteProducts = await downloadFromDropbox(basePath + '/System/_qo_products.json');
                if (remoteProducts && Array.isArray(remoteProducts) && remoteProducts.length > 0) {
                    const mergedProducts = mergeData(QOData.products, remoteProducts, 'id');
                    if (JSON.stringify(mergedProducts) !== JSON.stringify(QOData.products)) {
                        QOData.products = mergedProducts;
                        saveQOData('products');
                        updated = true;
                    }
                }

                // T√©l√©charger les articles (ArticlesData complet avec categories, pricelists, discounts)
                const remoteArticles = await downloadFromDropbox(basePath + '/Articles/_all_articles.json');
                if (remoteArticles && remoteArticles.articles) {
                    const mergedArticles = mergeData(ArticlesData.articles, remoteArticles.articles, 'id');
                    if (JSON.stringify(mergedArticles) !== JSON.stringify(ArticlesData.articles)) {
                        ArticlesData.articles = mergedArticles;
                        updated = true;
                    }
                    // Charger aussi les categories, pricelists et discounts
                    if (remoteArticles.categories && remoteArticles.categories.length > 0) {
                        ArticlesData.categories = remoteArticles.categories;
                    }
                    if (remoteArticles.pricelists && remoteArticles.pricelists.length > 0) {
                        ArticlesData.pricelists = remoteArticles.pricelists;
                    }
                    if (remoteArticles.discounts && remoteArticles.discounts.length > 0) {
                        ArticlesData.discounts = remoteArticles.discounts;
                    }
                    saveArticlesData();
                }

                // T√©l√©charger les commandes
                const remoteOrders = await downloadFromDropbox(basePath + '/Commandes/_all_orders.json');
                if (remoteOrders && Array.isArray(remoteOrders)) {
                    const mergedOrders = mergeData(QOData.orders, remoteOrders, 'id');
                    if (JSON.stringify(mergedOrders) !== JSON.stringify(QOData.orders)) {
                        QOData.orders = mergedOrders;
                        saveQOData('orders');
                        updated = true;
                    }
                }

                // T√©l√©charger les utilisateurs
                const remoteUsers = await downloadFromDropbox(basePath + '/System/_users.json');
                if (remoteUsers && Array.isArray(remoteUsers) && remoteUsers.length > 0) {
                    const mergedUsers = mergeData(UsersData.users, remoteUsers, 'id');
                    if (JSON.stringify(mergedUsers) !== JSON.stringify(UsersData.users)) {
                        UsersData.users = mergedUsers;
                        // Mettre √† jour l'utilisateur courant si modifi√©
                        const currentFromList = UsersData.users.find(u => u.id === UsersData.currentUser?.id);
                        if (currentFromList) {
                            UsersData.currentUser = currentFromList;
                        }
                        saveUsersData();
                        updated = true;
                    }
                }

                // =====================================================
                // CHARGER TOUS LES MODULES ADDITIONNELS
                // =====================================================

                // Prix Fournisseurs
                const remotePF = await downloadFromDropbox(basePath + '/System/_prix_fournisseurs.json');
                if (remotePF) {
                    if (remotePF.suppliers && remotePF.suppliers.length > 0) {
                        PFData.suppliers = mergeData(PFData.suppliers, remotePF.suppliers, 'id');
                    }
                    if (remotePF.products && remotePF.products.length > 0) {
                        PFData.products = mergeData(PFData.products, remotePF.products, 'id');
                    }
                    if (remotePF.priceHistory) {
                        PFData.priceHistory = remotePF.priceHistory;
                    }
                    if (remotePF.orders && remotePF.orders.length > 0) {
                        PFData.orders = mergeData(PFData.orders, remotePF.orders, 'id');
                    }
                    savePFData();
                    updated = true;
                }

                // Cours Poissons Frais
                const remoteCPF = await downloadFromDropbox(basePath + '/System/_cours_poissons.json');
                if (remoteCPF) {
                    if (remoteCPF.products && remoteCPF.products.length > 0) {
                        CPF.products = mergeData(CPF.products, remoteCPF.products, 'id');
                    }
                    if (remoteCPF.favorites) {
                        // Fusionner les favoris (union)
                        const allFavorites = [...new Set([...CPF.favorites, ...remoteCPF.favorites])];
                        CPF.favorites = allFavorites;
                    }
                    if (remoteCPF.history && remoteCPF.history.length > 0) {
                        CPF.history = mergeData(CPF.history, remoteCPF.history, 'id');
                    }
                    CPF.save();
                    updated = true;
                }

                // Ressources Humaines
                const remoteRH = await downloadFromDropbox(basePath + '/System/_rh_data.json');
                if (remoteRH) {
                    if (remoteRH.employees && remoteRH.employees.length > 0) {
                        RHData.employees = mergeData(RHData.employees, remoteRH.employees, 'id');
                    }
                    if (remoteRH.absences && remoteRH.absences.length > 0) {
                        RHData.absences = mergeData(RHData.absences, remoteRH.absences, 'id');
                    }
                    saveRHData();
                    updated = true;
                }

                // Param√®tres
                const remoteSettings = await downloadFromDropbox(basePath + '/System/_settings.json');
                if (remoteSettings) {
                    if (remoteSettings.numbering) {
                        NumberingConfig.order = remoteSettings.numbering.order || NumberingConfig.order;
                        NumberingConfig.client = remoteSettings.numbering.client || NumberingConfig.client;
                        NumberingConfig.article = remoteSettings.numbering.article || NumberingConfig.article;
                        localStorage.setItem('num_order_next', NumberingConfig.order.next);
                        localStorage.setItem('num_client_next', NumberingConfig.client.next);
                        localStorage.setItem('num_article_next', NumberingConfig.article.next);
                    }
                }

                DropboxSync.lastSync = new Date();
                updateSyncIndicator('success');

                // Mettre √† jour les compteurs apr√®s la sync
                if (updated) {
                    updateOrdersBadge();
                    updateDashboardSummary();
                }

                if (updated && !silent) {
                    showSyncNotification('üì• Donn√©es synchronis√©es depuis Dropbox');
                }

                return true;
            } catch (error) {
                console.error('Sync from Dropbox error:', error);
                updateSyncIndicator('error');
                return false;
            } finally {
                DropboxSync.isSyncing = false;
            }
        }

        // Fusionner les donn√©es locales et distantes
        function mergeData(localData, remoteData, idField = 'id') {
            if (!localData || !Array.isArray(localData)) localData = [];
            if (!remoteData || !Array.isArray(remoteData)) return localData;

            const merged = new Map();

            // Ajouter les donn√©es locales
            localData.forEach(item => {
                if (item && item[idField]) {
                    merged.set(item[idField], item);
                }
            });

            // Fusionner avec les donn√©es distantes (distant gagne si plus r√©cent ou si local n'existe pas)
            remoteData.forEach(item => {
                if (item && item[idField]) {
                    const existing = merged.get(item[idField]);
                    if (!existing) {
                        // Nouvel √©l√©ment depuis le distant
                        merged.set(item[idField], item);
                    } else {
                        // Comparer les dates de modification si disponibles
                        const localDate = existing.updatedAt || existing.createdAt || 0;
                        const remoteDate = item.updatedAt || item.createdAt || 0;
                        if (new Date(remoteDate) > new Date(localDate)) {
                            merged.set(item[idField], item);
                        }
                    }
                }
            });

            return Array.from(merged.values());
        }

        // Envoyer les donn√©es vers Dropbox (upload)
        async function syncToDropbox(dataType = 'all') {
            if (!DropboxConfig.isAvailable()) return false;
            if (DropboxSync.isSyncing) return false;

            DropboxSync.isSyncing = true;
            updateSyncIndicator('syncing');

            const basePath = DropboxConfig.basePath;

            try {
                if (dataType === 'all' || dataType === 'clients') {
                    const clientsJson = JSON.stringify(QOData.clients, null, 2);
                    await uploadToDropboxDirect(basePath + '/Clients/_all_clients.json', clientsJson);
                }

                if (dataType === 'all' || dataType === 'products') {
                    // Produits pour commandes rapides (QOData.products)
                    const productsJson = JSON.stringify(QOData.products, null, 2);
                    await uploadToDropboxDirect(basePath + '/System/_qo_products.json', productsJson);
                }

                if (dataType === 'all' || dataType === 'articles') {
                    // ArticlesData complet (articles, categories, pricelists, discounts)
                    const articlesJson = JSON.stringify(ArticlesData, null, 2);
                    await uploadToDropboxDirect(basePath + '/Articles/_all_articles.json', articlesJson);
                }

                if (dataType === 'all' || dataType === 'orders') {
                    const ordersJson = JSON.stringify(QOData.orders, null, 2);
                    await uploadToDropboxDirect(basePath + '/Commandes/_all_orders.json', ordersJson);
                }

                if (dataType === 'all' || dataType === 'users') {
                    const usersJson = JSON.stringify(UsersData.users, null, 2);
                    await uploadToDropboxDirect(basePath + '/System/_users.json', usersJson);
                }

                // =====================================================
                // SYNC DE TOUS LES MODULES ADDITIONNELS
                // =====================================================

                if (dataType === 'all' || dataType === 'pf') {
                    // Prix Fournisseurs
                    const pfJson = JSON.stringify({
                        suppliers: PFData.suppliers,
                        products: PFData.products,
                        priceHistory: PFData.priceHistory,
                        orders: PFData.orders
                    }, null, 2);
                    await uploadToDropboxDirect(basePath + '/System/_prix_fournisseurs.json', pfJson);
                }

                if (dataType === 'all' || dataType === 'cpf') {
                    // Cours Poissons Frais
                    const cpfJson = JSON.stringify({
                        products: CPF.products,
                        favorites: CPF.favorites,
                        history: CPF.history
                    }, null, 2);
                    await uploadToDropboxDirect(basePath + '/System/_cours_poissons.json', cpfJson);
                }

                if (dataType === 'all' || dataType === 'rh') {
                    // Ressources Humaines
                    const rhJson = JSON.stringify(RHData, null, 2);
                    await uploadToDropboxDirect(basePath + '/System/_rh_data.json', rhJson);
                }

                if (dataType === 'all' || dataType === 'settings') {
                    // Param√®tres g√©n√©raux (num√©rotation, config, etc.)
                    const settingsJson = JSON.stringify({
                        numbering: NumberingConfig,
                        dropboxBasePath: DropboxConfig.basePath,
                        autoSync: DropboxConfig.autoSync
                    }, null, 2);
                    await uploadToDropboxDirect(basePath + '/System/_settings.json', settingsJson);
                }

                DropboxSync.lastSync = new Date();
                updateSyncIndicator('success');
                return true;
            } catch (error) {
                console.error('Sync to Dropbox error:', error);
                updateSyncIndicator('error');
                return false;
            } finally {
                DropboxSync.isSyncing = false;
            }
        }

        // D√©marrer la synchronisation automatique
        function startDropboxSync() {
            if (DropboxSync.interval) {
                clearInterval(DropboxSync.interval);
            }

            DropboxSync.enabled = true;
            
            // D√©marrer le d√©compte
            startSyncCountdown();
            
            // Sync automatique toutes les 5 minutes
            DropboxSync.interval = setInterval(async () => {
                if (DropboxConfig.canSync()) {
                    // Reset du d√©compte d'abord
                    DropboxSync.nextSyncTime = Date.now() + DropboxSync.syncFrequency;
                    
                    // V√©rifier les mises √† jour UNIQUEMENT lors de la sync auto
                    await checkForUpdate();
                    
                    // Si pas de mise √† jour bloquante, faire la sync normale
                    if (!UpdateSystem.updateAvailable || isUserBusy()) {
                        await performDropboxSync();
                    }
                }
            }, DropboxSync.syncFrequency);

            // Au d√©marrage : sync des donn√©es SANS v√©rifier les mises √† jour
            // Les mises √† jour seront v√©rifi√©es √† la prochaine sync auto (5 min)
            setTimeout(async () => {
                if (DropboxConfig.canSync()) {
                    await performDropboxSync();
                }
            }, 5000);

            console.log('üîÑ Dropbox sync started (every ' + (DropboxSync.syncFrequency / 60000) + ' min)');
        }

        // Effectuer la synchronisation Dropbox
        async function performDropboxSync() {
            if (DropboxSync.isSyncing) return;
            
            DropboxSync.isSyncing = true;
            updateSyncIndicator('syncing');
            updateSyncCountdown();
            
            try {
                await syncFromDropbox(true);
                updateSyncIndicator('success');
                DropboxSync.lastSync = new Date();
            } catch (error) {
                console.error('Erreur sync:', error);
                updateSyncIndicator('error');
            } finally {
                DropboxSync.isSyncing = false;
                updateSyncCountdown();
            }
        }

        // Arr√™ter la synchronisation automatique
        function stopDropboxSync() {
            if (DropboxSync.interval) {
                clearInterval(DropboxSync.interval);
                DropboxSync.interval = null;
            }
            if (DropboxSync.countdownInterval) {
                clearInterval(DropboxSync.countdownInterval);
                DropboxSync.countdownInterval = null;
            }
            DropboxSync.enabled = false;
            DropboxSync.nextSyncTime = null;
            updateSyncCountdown();
            console.log('‚èπÔ∏è Dropbox sync stopped');
        }

        // Mettre √† jour l'indicateur de sync dans le header
        function updateSyncIndicator(status) {
            const indicator = document.getElementById('sync-indicator');
            if (!indicator) return;

            const icons = {
                'success': 'üü¢',
                'syncing': 'üîÑ',
                'error': 'üî¥',
                'offline': '‚ö™'
            };

            indicator.textContent = icons[status] || '‚ö™';
            indicator.title = status === 'success' ? 'Synchronis√©' :
                             status === 'syncing' ? 'Synchronisation...' :
                             status === 'error' ? 'Erreur de sync' : 'Non connect√©';

            // Animation pour syncing
            if (status === 'syncing') {
                indicator.style.animation = 'spin 1s linear infinite';
            } else {
                indicator.style.animation = 'none';
            }
        }

        // Notification de sync
        function showSyncNotification(message) {
            const notif = document.createElement('div');
            notif.style.cssText = 'position:fixed; bottom:20px; right:20px; padding:12px 20px; background:var(--accent-primary); color:#000; border-radius:10px; font-weight:600; z-index:9999; animation:slideIn 0.3s ease;';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        // forceSyncNow est d√©finie plus haut avec le syst√®me de mise √† jour

        // Initialiser la sync au chargement si Dropbox est configur√©
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (DropboxConfig.canSync()) {
                    // Rafra√Æchir le token si n√©cessaire puis tester
                    getValidDropboxToken().then(token => {
                        if (token) {
                            startDropboxSync();
                        }
                    });
                }
            }, 2000); // Attendre 2s apr√®s le chargement
        });

        // =====================================================
        // SETTINGS - Company & Data Management
        // =====================================================

        function saveCompanySettings() {
            const settings = {
                company: document.getElementById('settings-company').value,
                email: document.getElementById('settings-email').value,
                phone: document.getElementById('settings-phone').value,
                currency: document.getElementById('settings-currency').value
            };
            localStorage.setItem('trakio_company_settings', JSON.stringify(settings));
            alert('‚úÖ Param√®tres entreprise enregistr√©s !');
        }

        function loadCompanySettings() {
            const saved = localStorage.getItem('trakio_company_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                if (document.getElementById('settings-company')) {
                    document.getElementById('settings-company').value = settings.company || 'La Traversette';
                    document.getElementById('settings-email').value = settings.email || '';
                    document.getElementById('settings-phone').value = settings.phone || '';
                    document.getElementById('settings-currency').value = settings.currency || 'CHF';
                }
            }
        }

        function exportAllData() {
            const data = {
                clients: QOData.clients,
                orders: QOData.orders,
                products: QOData.products,
                articles: ArticlesData,
                settings: JSON.parse(localStorage.getItem('trakio_company_settings') || '{}'),
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'trakio_backup_' + new Date().toISOString().slice(0, 10) + '.json';
            link.click();
        }

        function importAllData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (data.clients) {
                        QOData.clients = data.clients;
                        saveQOData('clients');
                    }
                    if (data.orders) {
                        QOData.orders = data.orders;
                        saveQOData('orders');
                    }
                    if (data.articles) {
                        ArticlesData = { ...ArticlesData, ...data.articles };
                        saveArticlesData();
                    }
                    if (data.settings) {
                        localStorage.setItem('trakio_company_settings', JSON.stringify(data.settings));
                    }

                    alert('‚úÖ Donn√©es import√©es avec succ√®s !\n\nClients: ' + (data.clients?.length || 0) + '\nCommandes: ' + (data.orders?.length || 0));
                    location.reload();
                } catch (error) {
                    alert('‚ùå Erreur lors de l\'import: ' + error.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è ATTENTION !\n\nCette action va supprimer TOUTES les donn√©es:\n- Clients\n- Commandes\n- Articles\n- Param√®tres\n\n√ätes-vous s√ªr ?')) return;
            if (!confirm('üî¥ DERNI√àRE CONFIRMATION\n\nToutes les donn√©es seront perdues d√©finitivement.\n\nConfirmer la suppression ?')) return;

            localStorage.clear();
            alert('‚úÖ Toutes les donn√©es ont √©t√© supprim√©es.\n\nLa page va se recharger.');
            location.reload();
        }

        // =====================================================
        // SYST√àME DE MISE √Ä JOUR TRAKIO - Sauvegarde compl√®te
        // =====================================================

        // Utiliser les m√™mes constantes que APP_VERSION
        const TRAKIO_VERSION = APP_VERSION;
        const TRAKIO_BUILD_DATE = APP_VERSION_DATE;

        function initTrakioVersionInfo() {
            const versionEl = document.getElementById('trakio-version');
            const dateEl = document.getElementById('trakio-update-date');
            const navVersionEl = document.getElementById('nav-version');

            if (versionEl) versionEl.textContent = 'v' + TRAKIO_VERSION;
            if (dateEl) dateEl.textContent = TRAKIO_BUILD_DATE;
            if (navVersionEl) navVersionEl.textContent = 'v' + TRAKIO_VERSION;

            // Charger l'historique des sauvegardes
            loadBackupHistory();
        }

        async function createTrakioBackup(silent = false) {
            // Collecter TOUTES les donn√©es du localStorage
            const backup = {
                _meta: {
                    type: 'TRAKIO_FULL_BACKUP',
                    version: TRAKIO_VERSION,
                    createdAt: new Date().toISOString(),
                    device: navigator.userAgent.substring(0, 50)
                },
                localStorage: {}
            };

            // Sauvegarder toutes les cl√©s du localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                try {
                    backup.localStorage[key] = localStorage.getItem(key);
                } catch (e) {
                    console.warn('Impossible de sauvegarder:', key);
                }
            }

            // Cr√©er le fichier
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `TRAKIO_BACKUP_${timestamp}.json`;

            // T√©l√©charger localement si pas en mode silencieux
            if (!silent) {
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
            }

            // Envoyer sur Dropbox
            const dropboxSuccess = await uploadBackupToDropbox(backup, filename);

            // Enregistrer dans l'historique
            saveBackupToHistory(filename, dropboxSuccess);

            // Notification
            if (!silent) {
                if (dropboxSuccess) {
                    showToast('‚úÖ Sauvegarde cr√©√©e et envoy√©e sur Dropbox', 'success');
                } else {
                    showToast('‚úÖ Sauvegarde locale cr√©√©e (Dropbox non connect√©)', 'success');
                }
            }

            return dropboxSuccess;
        }

        async function uploadBackupToDropbox(backup, filename) {
            if (!DropboxConfig.accessToken) {
                console.log('Dropbox non configur√©, sauvegarde locale uniquement');
                return false;
            }

            try {
                const path = `${DropboxConfig.basePath}/System/Backups/${filename}`;

                const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${DropboxConfig.accessToken}`,
                        'Content-Type': 'application/octet-stream',
                        'Dropbox-API-Arg': JSON.stringify({
                            path: path,
                            mode: 'overwrite',
                            autorename: false
                        })
                    },
                    body: JSON.stringify(backup, null, 2)
                });

                if (response.ok) {
                    console.log('‚úÖ Backup envoy√© sur Dropbox:', path);
                    return true;
                } else {
                    console.error('‚ùå Erreur upload backup Dropbox:', await response.text());
                    return false;
                }
            } catch (error) {
                console.error('Erreur upload backup:', error);
                return false;
            }
        }

        function restoreTrakioBackup(input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm('‚ö†Ô∏è RESTAURATION\n\nCette action va remplacer toutes vos donn√©es actuelles par celles de la sauvegarde.\n\nVoulez-vous continuer ?')) {
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);

                    // V√©rifier que c'est une sauvegarde TRAKIO valide
                    if (!backup._meta || backup._meta.type !== 'TRAKIO_FULL_BACKUP') {
                        // Essayer l'ancien format
                        if (backup.clients || backup.orders || backup.articles) {
                            importAllData({ files: [file] });
                            return;
                        }
                        throw new Error('Ce fichier n\'est pas une sauvegarde TRAKIO valide');
                    }

                    // Restaurer toutes les donn√©es du localStorage
                    let restoredCount = 0;
                    for (const [key, value] of Object.entries(backup.localStorage)) {
                        try {
                            localStorage.setItem(key, value);
                            restoredCount++;
                        } catch (e) {
                            console.warn('Impossible de restaurer:', key);
                        }
                    }

                    alert(`‚úÖ Restauration termin√©e !\n\n` +
                          `Version sauvegarde: ${backup._meta.version}\n` +
                          `Date sauvegarde: ${new Date(backup._meta.createdAt).toLocaleString('fr-CH')}\n` +
                          `Donn√©es restaur√©es: ${restoredCount} √©l√©ments\n\n` +
                          `La page va se recharger.`);

                    location.reload();

                } catch (error) {
                    alert('‚ùå Erreur lors de la restauration:\n' + error.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function saveBackupToHistory(filename, dropboxSynced = false) {
            const history = JSON.parse(localStorage.getItem('trakio_backup_history') || '[]');
            history.unshift({
                filename: filename,
                date: new Date().toISOString(),
                version: TRAKIO_VERSION,
                dropbox: dropboxSynced
            });
            // Garder seulement les 5 derni√®res
            localStorage.setItem('trakio_backup_history', JSON.stringify(history.slice(0, 5)));
            loadBackupHistory();
        }

        function loadBackupHistory() {
            const historyEl = document.getElementById('backup-history');
            if (!historyEl) return;

            const history = JSON.parse(localStorage.getItem('trakio_backup_history') || '[]');

            if (history.length === 0) {
                historyEl.innerHTML = '<div style="color:var(--text-muted);">Aucune sauvegarde r√©cente</div>';
                return;
            }

            historyEl.innerHTML = history.map(h => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid var(--border-color);">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <span style="font-size:14px;">${h.dropbox ? '‚òÅÔ∏è' : 'üíæ'}</span>
                        <span style="font-family:'Space Mono',monospace; font-size:11px;">${h.filename.substring(0, 25)}...</span>
                    </div>
                    <span style="color:var(--text-muted); font-size:11px;">${new Date(h.date).toLocaleDateString('fr-CH')}</span>
                </div>
            `).join('');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position:fixed; bottom:100px; left:50%; transform:translateX(-50%);
                padding:16px 24px; border-radius:12px; z-index:99999;
                font-weight:600; box-shadow:0 8px 32px rgba(0,0,0,0.3);
                animation: slideUp 0.3s ease;
                ${type === 'success' ? 'background:var(--accent-primary); color:#000;' :
                  type === 'error' ? 'background:var(--accent-danger); color:#fff;' :
                  'background:var(--bg-card); color:var(--text-primary); border:1px solid var(--border-color);'}
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // =====================================================
        // ANALYTICS - Graphiques et Statistiques
        // =====================================================

        let analyticsCharts = {};

        function initAnalytics() {
            // D√©truire les anciens charts s'ils existent
            Object.values(analyticsCharts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            analyticsCharts = {};

            updateAnalytics();
        }

        function updateAnalytics() {
            const period = parseInt(document.getElementById('analysis-period')?.value || 30);

            // Collecter les donn√©es
            const data = collectAnalyticsData(period);

            // Mettre √† jour les KPIs
            updateKPIs(data);

            // Cr√©er les graphiques
            createRevenueChart(data);
            createSourcesChart(data);
            createOrdersDayChart(data);
            createTopClientsChart(data);

            // Mettre √† jour les tableaux
            updateRecentOrdersTable(data);
            updateStatsDetails(data);
        }

        function collectAnalyticsData(days) {
            const now = new Date();
            const startDate = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));

            // Commandes QuickOrder
            const qoOrders = (typeof QOData !== 'undefined' && QOData.orders) ? QOData.orders : [];
            const qoClients = (typeof QOData !== 'undefined' && QOData.clients) ? QOData.clients : [];

            // Commandes Shopify
            const shopifyOrders = JSON.parse(localStorage.getItem('shopify_orders') || '[]');
            const shopifyProcessed = JSON.parse(localStorage.getItem('shopify_processed') || '[]');

            // Articles
            const articles = (typeof ArticlesData !== 'undefined' && ArticlesData.items) ? ArticlesData.items : [];

            // Filtrer par p√©riode
            const filteredQO = qoOrders.filter(o => {
                if (!o.createdAt) return false;
                return new Date(o.createdAt) >= startDate;
            });

            const filteredShopify = shopifyOrders.filter(o => {
                if (!o.createdAt) return true; // Garder si pas de date
                return new Date(o.createdAt) >= startDate;
            });

            // Calculer les revenus
            const qoRevenue = filteredQO.reduce((sum, o) => sum + (parseFloat(o.totalTTC) || 0), 0);
            const shopifyRevenue = filteredShopify.reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);

            // Grouper par jour pour les graphiques
            const revenueByDay = {};
            const ordersByDay = {};

            for (let i = 0; i < days; i++) {
                const date = new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));
                const dateStr = date.toISOString().slice(0, 10);
                revenueByDay[dateStr] = 0;
                ordersByDay[dateStr] = 0;
            }

            filteredQO.forEach(o => {
                if (o.createdAt) {
                    const dateStr = new Date(o.createdAt).toISOString().slice(0, 10);
                    if (revenueByDay[dateStr] !== undefined) {
                        revenueByDay[dateStr] += parseFloat(o.totalTTC) || 0;
                        ordersByDay[dateStr]++;
                    }
                }
            });

            filteredShopify.forEach(o => {
                if (o.createdAt) {
                    const dateStr = new Date(o.createdAt).toISOString().slice(0, 10);
                    if (revenueByDay[dateStr] !== undefined) {
                        revenueByDay[dateStr] += parseFloat(o.total) || 0;
                        ordersByDay[dateStr]++;
                    }
                }
            });

            // Top clients
            const clientRevenue = {};
            filteredQO.forEach(o => {
                const name = o.clientName || 'Inconnu';
                clientRevenue[name] = (clientRevenue[name] || 0) + (parseFloat(o.totalTTC) || 0);
            });

            const topClients = Object.entries(clientRevenue)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // Shopify stats
            const shopifyUrgent = filteredShopify.filter(o =>
                o.financialStatus === 'paid' &&
                o.fulfillmentStatus === 'unfulfilled' &&
                !o.processed &&
                !shopifyProcessed.includes(o.name)
            ).length;

            const shopifyPending = filteredShopify.filter(o => o.financialStatus === 'pending').length;
            const shopifyDone = filteredShopify.filter(o => o.processed || o.fulfillmentStatus === 'fulfilled').length;

            // B2B vs B2C
            const b2b = qoClients.filter(c => c.type === 'B2B').length;
            const b2c = qoClients.filter(c => c.type === 'B2C').length;

            return {
                period: days,
                totalRevenue: qoRevenue + shopifyRevenue,
                qoRevenue,
                shopifyRevenue,
                totalOrders: filteredQO.length + filteredShopify.length,
                qoOrders: filteredQO.length,
                shopifyOrders: filteredShopify.length,
                totalClients: qoClients.length,
                totalArticles: articles.length,
                revenueByDay,
                ordersByDay,
                topClients,
                b2b,
                b2c,
                shopifyUrgent,
                shopifyPending,
                shopifyDone,
                avgBasket: (filteredQO.length + filteredShopify.length) > 0
                    ? (qoRevenue + shopifyRevenue) / (filteredQO.length + filteredShopify.length)
                    : 0,
                ordersPerDay: (filteredQO.length + filteredShopify.length) / days,
                recentOrders: [...filteredQO.map(o => ({...o, source: 'QuickOrder'})),
                               ...filteredShopify.map(o => ({...o, source: 'Shopify'}))]
                    .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))
                    .slice(0, 10)
            };
        }

        function updateKPIs(data) {
            document.getElementById('kpi-revenue').textContent = formatNumber(data.totalRevenue);
            document.getElementById('kpi-orders').textContent = data.totalOrders;
            document.getElementById('kpi-clients').textContent = data.totalClients;
            document.getElementById('kpi-shopify').textContent = data.shopifyOrders;
            document.getElementById('kpi-articles').textContent = data.totalArticles;
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.round(num).toLocaleString('fr-CH');
        }

        function createRevenueChart(data) {
            const ctx = document.getElementById('chart-revenue');
            if (!ctx) return;

            if (analyticsCharts.revenue) analyticsCharts.revenue.destroy();

            const labels = Object.keys(data.revenueByDay).sort();
            const values = labels.map(d => data.revenueByDay[d]);

            analyticsCharts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(d => {
                        const date = new Date(d);
                        return date.toLocaleDateString('fr-CH', { day: '2-digit', month: 'short' });
                    }),
                    datasets: [{
                        label: 'CA (CHF)',
                        data: values,
                        borderColor: '#06d6a0',
                        backgroundColor: 'rgba(6, 214, 160, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888', maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function createSourcesChart(data) {
            const ctx = document.getElementById('chart-sources');
            if (!ctx) return;

            if (analyticsCharts.sources) analyticsCharts.sources.destroy();

            analyticsCharts.sources = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['QuickOrder', 'Shopify'],
                    datasets: [{
                        data: [data.qoRevenue, data.shopifyRevenue],
                        backgroundColor: ['#06d6a0', '#96bf48'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#888', padding: 20 }
                        }
                    }
                }
            });
        }

        function createOrdersDayChart(data) {
            const ctx = document.getElementById('chart-orders-day');
            if (!ctx) return;

            if (analyticsCharts.ordersDay) analyticsCharts.ordersDay.destroy();

            const labels = Object.keys(data.ordersByDay).sort().slice(-14); // 2 derni√®res semaines
            const values = labels.map(d => data.ordersByDay[d]);

            analyticsCharts.ordersDay = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(d => {
                        const date = new Date(d);
                        return date.toLocaleDateString('fr-CH', { day: '2-digit', month: 'short' });
                    }),
                    datasets: [{
                        label: 'Commandes',
                        data: values,
                        backgroundColor: '#118ab2',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888', stepSize: 1 }
                        }
                    }
                }
            });
        }

        function createTopClientsChart(data) {
            const ctx = document.getElementById('chart-top-clients');
            if (!ctx) return;

            if (analyticsCharts.topClients) analyticsCharts.topClients.destroy();

            const labels = data.topClients.map(c => c[0].substring(0, 20));
            const values = data.topClients.map(c => c[1]);

            if (labels.length === 0) {
                labels.push('Aucune donn√©e');
                values.push(0);
            }

            analyticsCharts.topClients = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'CA (CHF)',
                        data: values,
                        backgroundColor: ['#06d6a0', '#118ab2', '#ffd166', '#9c88ff', '#ff6b6b'],
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function updateRecentOrdersTable(data) {
            const tbody = document.getElementById('table-recent-orders');
            if (!tbody) return;

            if (data.recentOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--text-muted); padding:20px;">Aucune commande</td></tr>';
                return;
            }

            tbody.innerHTML = data.recentOrders.map(o => {
                const date = o.createdAt ? new Date(o.createdAt).toLocaleDateString('fr-CH') : '-';
                const amount = o.source === 'Shopify' ? (o.total || 0).toFixed(2) : (o.totalTTC || 0).toFixed(2);
                const orderNum = o.source === 'Shopify' ? o.name : (o.id || '-');
                const client = o.source === 'Shopify' ? (o.billingName || o.shippingName || '-') : (o.clientName || '-');
                const sourceColor = o.source === 'Shopify' ? '#96bf48' : 'var(--accent-primary)';
                const sourceIcon = o.source === 'Shopify' ? 'üõçÔ∏è' : '‚ö°';

                return `
                    <tr>
                        <td style="font-weight:600;">${orderNum}</td>
                        <td>${client}</td>
                        <td style="color:var(--text-muted);">${date}</td>
                        <td style="font-family:'Space Mono',monospace; font-weight:600;">${amount} CHF</td>
                        <td><span style="padding:3px 8px; background:${sourceColor}20; color:${sourceColor}; border-radius:4px; font-size:11px;">${sourceIcon} ${o.source}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function updateStatsDetails(data) {
            document.getElementById('stat-avg-basket').textContent = data.avgBasket.toFixed(2) + ' CHF';
            document.getElementById('stat-b2b').textContent = data.b2b;
            document.getElementById('stat-b2c').textContent = data.b2c;
            document.getElementById('stat-orders-day').textContent = data.ordersPerDay.toFixed(1);

            document.getElementById('stat-shopify-urgent').textContent = data.shopifyUrgent;
            document.getElementById('stat-shopify-pending').textContent = data.shopifyPending;
            document.getElementById('stat-shopify-done').textContent = data.shopifyDone;
            document.getElementById('stat-shopify-revenue').textContent = data.shopifyRevenue.toFixed(0) + ' CHF';

            // Tendance
            const trend = document.getElementById('stat-trend');
            if (data.totalOrders > 0) {
                const shopifyPct = ((data.shopifyOrders / data.totalOrders) * 100).toFixed(0);
                const qoPct = ((data.qoOrders / data.totalOrders) * 100).toFixed(0);
                trend.innerHTML = `
                    Sur les ${data.period} derniers jours:<br>
                    ‚Ä¢ <strong>${data.totalOrders}</strong> commandes pour <strong>${data.totalRevenue.toFixed(0)} CHF</strong><br>
                    ‚Ä¢ Shopify: ${shopifyPct}% des commandes<br>
                    ‚Ä¢ QuickOrder: ${qoPct}% des commandes<br>
                    ‚Ä¢ Panier moyen: <strong>${data.avgBasket.toFixed(2)} CHF</strong>
                `;
            } else {
                trend.innerHTML = 'Aucune donn√©e disponible pour cette p√©riode.';
            }
        }

        // =====================================================
        // TRACKING - Suivi des commandes
        // =====================================================

        let trackingWeekOffset = 0;
        let allTrackingOrders = [];

        function initTracking() {
            trackingWeekOffset = 0;
            updateTrackingView();
        }

        function updateTrackingView() {
            const sourceFilter = document.getElementById('tracking-source-filter')?.value || 'all';

            // Collecter toutes les commandes
            allTrackingOrders = collectAllOrders(sourceFilter);

            // Mettre √† jour les KPIs
            updateTrackingKPIs(allTrackingOrders);

            // Mettre √† jour le pipeline
            updateTrackingPipeline(allTrackingOrders);

            // Mettre √† jour le calendrier
            updateTrackingCalendar(allTrackingOrders);

            // Mettre √† jour la timeline
            updateTrackingTimeline(allTrackingOrders);

            // Mettre √† jour le tableau
            updateTrackingTable(allTrackingOrders);
        }

        function collectAllOrders(sourceFilter) {
            let orders = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // QuickOrder
            if (sourceFilter === 'all' || sourceFilter === 'quickorder') {
                const qoOrders = (typeof QOData !== 'undefined' && QOData.orders) ? QOData.orders : [];
                qoOrders.forEach(o => {
                    orders.push({
                        id: o.id || 'QO-' + Math.random().toString(36).substr(2, 6),
                        source: 'quickorder',
                        sourceIcon: '‚ö°',
                        sourceColor: '#06d6a0',
                        orderNumber: o.id || '-',
                        client: o.clientName || 'Client inconnu',
                        clientPhone: o.clientPhone || '',
                        deliveryDate: o.deliveryDate ? new Date(o.deliveryDate) : null,
                        deliveryDateStr: o.deliveryDate || '',
                        location: o.deliveryAddress || '√Ä d√©finir',
                        amount: parseFloat(o.totalTTC) || 0,
                        status: mapQOStatus(o.status),
                        rawStatus: o.status,
                        createdAt: o.createdAt ? new Date(o.createdAt) : new Date(),
                        items: o.items || [],
                        notes: o.notes || ''
                    });
                });
            }

            // Shopify
            if (sourceFilter === 'all' || sourceFilter === 'shopify') {
                const shopifyOrders = JSON.parse(localStorage.getItem('shopify_orders') || '[]');
                const shopifyProcessed = JSON.parse(localStorage.getItem('shopify_processed') || '[]');

                shopifyOrders.forEach(o => {
                    const pickupDate = parseShopifyPickupDate(o.pickupDate);
                    const isProcessed = o.processed || shopifyProcessed.includes(o.name);

                    orders.push({
                        id: o.name || 'SH-' + Math.random().toString(36).substr(2, 6),
                        source: 'shopify',
                        sourceIcon: 'üõçÔ∏è',
                        sourceColor: '#96bf48',
                        orderNumber: o.name || '-',
                        client: o.billingName || o.shippingName || 'Client Shopify',
                        clientPhone: o.phone || '',
                        deliveryDate: pickupDate,
                        deliveryDateStr: o.pickupDate || '',
                        location: o.pickupLocation || 'Retrait magasin',
                        amount: parseFloat(o.total) || 0,
                        status: mapShopifyStatus(o, isProcessed),
                        rawStatus: o.fulfillmentStatus,
                        createdAt: o.createdAt ? new Date(o.createdAt) : new Date(),
                        items: o.lineItems || [],
                        notes: o.notes || '',
                        pickupTime: o.pickupTime || ''
                    });
                });
            }

            // MyFish
            if (sourceFilter === 'all' || sourceFilter === 'myfish') {
                const myfishOrders = JSON.parse(localStorage.getItem('myfish_orders') || '[]');
                myfishOrders.forEach(o => {
                    orders.push({
                        id: o.id || 'MF-' + Math.random().toString(36).substr(2, 6),
                        source: 'myfish',
                        sourceIcon: 'üêü',
                        sourceColor: '#118ab2',
                        orderNumber: o.orderNumber || o.id || '-',
                        client: o.clientName || 'Client MyFish',
                        clientPhone: o.clientPhone || '',
                        deliveryDate: o.deliveryDate ? new Date(o.deliveryDate) : null,
                        deliveryDateStr: o.deliveryDate || '',
                        location: o.store || o.deliveryAddress || '√Ä d√©finir',
                        amount: parseFloat(o.total) || 0,
                        status: mapMyFishStatus(o.status),
                        rawStatus: o.status,
                        createdAt: o.createdAt ? new Date(o.createdAt) : new Date(),
                        items: o.items || [],
                        notes: o.notes || ''
                    });
                });
            }

            // Trier par date de livraison
            orders.sort((a, b) => {
                if (!a.deliveryDate && !b.deliveryDate) return 0;
                if (!a.deliveryDate) return 1;
                if (!b.deliveryDate) return -1;
                return a.deliveryDate - b.deliveryDate;
            });

            return orders;
        }

        function parseShopifyPickupDate(dateStr) {
            if (!dateStr) return null;
            const months = { 'Jan':0, 'Feb':1, 'Mar':2, 'Apr':3, 'May':4, 'Jun':5, 'Jul':6, 'Aug':7, 'Sep':8, 'Oct':9, 'Nov':10, 'Dec':11 };
            const match = dateStr.match(/(\d{1,2})\s+(\w{3})\s+(\d{4})/);
            if (match) {
                const day = parseInt(match[1]);
                const month = months[match[2]];
                const year = parseInt(match[3]);
                if (month !== undefined) return new Date(year, month, day);
            }
            return null;
        }

        function mapQOStatus(status) {
            const map = {
                'pending': 'pending',
                'confirmed': 'preparing',
                'preparing': 'preparing',
                'ready': 'ready',
                'shipped': 'ready',
                'delivered': 'delivered',
                'cancelled': 'cancelled'
            };
            return map[status] || 'pending';
        }

        function mapShopifyStatus(order, isProcessed) {
            if (order.fulfillmentStatus === 'fulfilled' || isProcessed) return 'delivered';
            if (order.financialStatus === 'paid') return 'preparing';
            return 'pending';
        }

        function mapMyFishStatus(status) {
            const map = {
                'new': 'pending',
                'confirmed': 'preparing',
                'production': 'preparing',
                'ready': 'ready',
                'delivered': 'delivered',
                'cancelled': 'cancelled'
            };
            return map[status] || 'pending';
        }

        function updateTrackingKPIs(orders) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const pending = orders.filter(o => o.status === 'pending').length;
            const preparing = orders.filter(o => o.status === 'preparing').length;
            const ready = orders.filter(o => o.status === 'ready').length;
            const delivered = orders.filter(o => o.status === 'delivered').length;
            const todayOrders = orders.filter(o => {
                if (!o.deliveryDate) return false;
                return o.deliveryDate >= today && o.deliveryDate < tomorrow;
            }).length;

            document.getElementById('tracking-pending').textContent = pending;
            document.getElementById('tracking-preparing').textContent = preparing;
            document.getElementById('tracking-ready').textContent = ready;
            document.getElementById('tracking-delivered').textContent = delivered;
            document.getElementById('tracking-today').textContent = todayOrders;
        }

        function updateTrackingPipeline(orders) {
            const columns = {
                pending: document.getElementById('pipeline-pending'),
                preparing: document.getElementById('pipeline-preparing'),
                ready: document.getElementById('pipeline-ready'),
                delivered: document.getElementById('pipeline-delivered')
            };

            const counts = {
                pending: 0,
                preparing: 0,
                ready: 0,
                delivered: 0
            };

            // Vider les colonnes
            Object.values(columns).forEach(col => { if (col) col.innerHTML = ''; });

            // Limiter aux 30 derniers jours pour la vue pipeline
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            orders.filter(o => o.status !== 'cancelled').forEach(order => {
                const col = columns[order.status];
                if (!col) return;

                counts[order.status]++;

                // Limiter le nombre affich√© par colonne
                if (counts[order.status] > 10 && order.status === 'delivered') return;

                const dateStr = order.deliveryDate
                    ? order.deliveryDate.toLocaleDateString('fr-CH', { day: '2-digit', month: 'short' })
                    : '-';

                const isToday = order.deliveryDate && isDateToday(order.deliveryDate);
                const isLate = order.deliveryDate && order.deliveryDate < new Date() && order.status !== 'delivered';

                col.innerHTML += `
                    <div class="tracking-card" style="background:var(--bg-card); border-radius:8px; padding:10px; border-left:3px solid ${order.sourceColor}; ${isLate ? 'border:1px solid #ff6b6b;' : ''}" onclick="showTrackingOrderDetail('${order.id}', '${order.source}')">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <span style="font-size:11px; background:${order.sourceColor}20; color:${order.sourceColor}; padding:2px 6px; border-radius:4px;">${order.sourceIcon} ${order.orderNumber}</span>
                            ${isToday ? '<span style="font-size:10px; background:#ff6b6b; color:#fff; padding:2px 6px; border-radius:4px;">AUJOURD\'HUI</span>' : ''}
                            ${isLate ? '<span style="font-size:10px; background:#ff6b6b; color:#fff; padding:2px 6px; border-radius:4px;">‚ö†Ô∏è RETARD</span>' : ''}
                        </div>
                        <div style="font-weight:600; font-size:13px; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${order.client}</div>
                        <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--text-muted);">
                            <span>üìÖ ${dateStr}</span>
                            <span style="font-weight:600; color:var(--accent-primary);">${order.amount.toFixed(0)} CHF</span>
                        </div>
                        ${order.location ? `<div style="font-size:10px; color:var(--text-muted); margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">üìç ${order.location}</div>` : ''}
                    </div>
                `;
            });

            // Mettre √† jour les compteurs
            document.getElementById('pipeline-pending-count').textContent = counts.pending;
            document.getElementById('pipeline-preparing-count').textContent = counts.preparing;
            document.getElementById('pipeline-ready-count').textContent = counts.ready;
            document.getElementById('pipeline-delivered-count').textContent = counts.delivered;
        }

        function isDateToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        function updateTrackingCalendar(orders) {
            const calendar = document.getElementById('tracking-calendar');
            const label = document.getElementById('tracking-week-label');
            if (!calendar) return;

            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (trackingWeekOffset * 7)); // Lundi

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            if (label) {
                const startStr = startOfWeek.toLocaleDateString('fr-CH', { day: '2-digit', month: 'short' });
                const endStr = endOfWeek.toLocaleDateString('fr-CH', { day: '2-digit', month: 'short' });
                label.textContent = `${startStr} - ${endStr}`;
            }

            const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            let html = '';

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);

                const dayOrders = orders.filter(o => {
                    if (!o.deliveryDate || o.status === 'delivered' || o.status === 'cancelled') return false;
                    return o.deliveryDate.toDateString() === date.toDateString();
                });

                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today && !isToday;

                html += `
                    <div style="background:${isToday ? 'linear-gradient(135deg, var(--accent-primary)20, var(--accent-secondary)20)' : 'var(--bg-primary)'}; border-radius:10px; padding:10px; ${isToday ? 'border:2px solid var(--accent-primary);' : ''} ${isPast ? 'opacity:0.5;' : ''}">
                        <div style="text-align:center; margin-bottom:8px;">
                            <div style="font-size:11px; color:var(--text-muted);">${days[i]}</div>
                            <div style="font-size:18px; font-weight:700; ${isToday ? 'color:var(--accent-primary);' : ''}">${date.getDate()}</div>
                        </div>
                        <div style="min-height:60px;">
                            ${dayOrders.slice(0, 3).map(o => `
                                <div style="font-size:10px; background:${o.sourceColor}20; color:${o.sourceColor}; padding:3px 6px; border-radius:4px; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${o.client}">
                                    ${o.sourceIcon} ${o.client.substring(0, 12)}...
                                </div>
                            `).join('')}
                            ${dayOrders.length > 3 ? `<div style="font-size:10px; color:var(--text-muted); text-align:center;">+${dayOrders.length - 3} autres</div>` : ''}
                            ${dayOrders.length === 0 ? `<div style="font-size:10px; color:var(--text-muted); text-align:center;">-</div>` : ''}
                        </div>
                    </div>
                `;
            }

            calendar.innerHTML = html;
        }

        function changeTrackingWeek(delta) {
            trackingWeekOffset += delta;
            updateTrackingCalendar(allTrackingOrders);
        }

        function updateTrackingTimeline(orders) {
            const timeline = document.getElementById('tracking-timeline');
            if (!timeline) return;

            // G√©n√©rer des √©v√©nements bas√©s sur les commandes
            const events = [];
            const now = new Date();

            orders.forEach(o => {
                // √âv√©nement de cr√©ation
                if (o.createdAt) {
                    events.push({
                        date: o.createdAt,
                        type: 'created',
                        icon: 'üì•',
                        text: `Nouvelle commande ${o.orderNumber} (${o.client})`,
                        source: o.source,
                        color: o.sourceColor
                    });
                }

                // √âv√©nement de livraison pr√©vue aujourd'hui
                if (o.deliveryDate && isDateToday(o.deliveryDate) && o.status !== 'delivered') {
                    events.push({
                        date: o.deliveryDate,
                        type: 'delivery_today',
                        icon: 'üì¶',
                        text: `Livraison pr√©vue: ${o.orderNumber} (${o.client})`,
                        source: o.source,
                        color: '#ff6b6b',
                        highlight: true
                    });
                }

                // √âv√©nement livr√©
                if (o.status === 'delivered' && o.deliveryDate) {
                    events.push({
                        date: o.deliveryDate,
                        type: 'delivered',
                        icon: '‚úÖ',
                        text: `Livr√©: ${o.orderNumber} (${o.client})`,
                        source: o.source,
                        color: '#06d6a0'
                    });
                }
            });

            // Trier par date d√©croissante et limiter
            events.sort((a, b) => b.date - a.date);
            const recentEvents = events.slice(0, 15);

            if (recentEvents.length === 0) {
                timeline.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">Aucun √©v√©nement r√©cent</div>';
                return;
            }

            timeline.innerHTML = recentEvents.map(e => {
                const timeAgo = getTimeAgo(e.date);
                return `
                    <div class="timeline-item ${e.highlight ? 'warning' : ''}">
                        <div class="timeline-time">${timeAgo}</div>
                        <div class="timeline-content">
                            <span style="margin-right:6px;">${e.icon}</span>
                            ${e.text}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return '√Ä l\'instant';
            if (minutes < 60) return `Il y a ${minutes} min`;
            if (hours < 24) return `Il y a ${hours}h`;
            if (days < 7) return `Il y a ${days} jour${days > 1 ? 's' : ''}`;
            return date.toLocaleDateString('fr-CH');
        }

        function updateTrackingTable(orders) {
            const tbody = document.getElementById('tracking-table-body');
            if (!tbody) return;

            const activeOrders = orders.filter(o => o.status !== 'cancelled');

            if (activeOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:var(--text-muted); padding:30px;">Aucune commande en cours</td></tr>';
                return;
            }

            tbody.innerHTML = activeOrders.map(o => {
                const dateStr = o.deliveryDate
                    ? o.deliveryDate.toLocaleDateString('fr-CH')
                    : '-';

                const statusColors = {
                    pending: { bg: '#ffd16620', color: '#ffd166', text: 'En attente' },
                    preparing: { bg: '#118ab220', color: '#118ab2', text: 'En pr√©paration' },
                    ready: { bg: '#9c88ff20', color: '#9c88ff', text: 'Pr√™t' },
                    delivered: { bg: '#06d6a020', color: '#06d6a0', text: 'Livr√©' }
                };
                const st = statusColors[o.status] || statusColors.pending;

                return `
                    <tr>
                        <td><span style="padding:3px 8px; background:${o.sourceColor}20; color:${o.sourceColor}; border-radius:4px; font-size:11px;">${o.sourceIcon}</span></td>
                        <td style="font-weight:600;">${o.orderNumber}</td>
                        <td>${o.client}</td>
                        <td>${dateStr}</td>
                        <td style="font-size:12px; color:var(--text-muted);">${(o.location || '-').substring(0, 25)}</td>
                        <td style="font-family:'Space Mono',monospace; font-weight:600;">${o.amount.toFixed(2)} CHF</td>
                        <td><span style="padding:4px 10px; background:${st.bg}; color:${st.color}; border-radius:6px; font-size:11px; font-weight:600;">${st.text}</span></td>
                        <td>
                            <div style="display:flex; gap:4px;">
                                ${o.status !== 'delivered' ? `
                                    <button onclick="updateOrderStatus('${o.id}', '${o.source}', 'next')" style="padding:4px 8px; background:var(--accent-primary); color:#000; border:none; border-radius:4px; cursor:pointer; font-size:11px;" title="√âtape suivante">‚ñ∂</button>
                                    <button onclick="updateOrderStatus('${o.id}', '${o.source}', 'delivered')" style="padding:4px 8px; background:var(--accent-secondary); color:#000; border:none; border-radius:4px; cursor:pointer; font-size:11px;" title="Marquer livr√©">‚úì</button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterTrackingTable() {
            const search = document.getElementById('tracking-search')?.value.toLowerCase() || '';
            const filtered = allTrackingOrders.filter(o =>
                o.orderNumber.toLowerCase().includes(search) ||
                o.client.toLowerCase().includes(search) ||
                o.location.toLowerCase().includes(search)
            );
            updateTrackingTable(filtered);
        }

        function updateOrderStatus(orderId, source, action) {
            const statusFlow = ['pending', 'preparing', 'ready', 'delivered'];

            if (source === 'quickorder') {
                const order = QOData.orders.find(o => o.id === orderId);
                if (order) {
                    if (action === 'delivered') {
                        order.status = 'delivered';
                    } else if (action === 'next') {
                        const currentIdx = statusFlow.indexOf(mapQOStatus(order.status));
                        if (currentIdx < statusFlow.length - 1) {
                            const qoStatusMap = { pending: 'pending', preparing: 'preparing', ready: 'ready', delivered: 'delivered' };
                            order.status = Object.keys(qoStatusMap).find(k => qoStatusMap[k] === statusFlow[currentIdx + 1]) || 'delivered';
                        }
                    }
                    saveQOData('orders');
                }
            } else if (source === 'shopify') {
                const shopifyOrders = JSON.parse(localStorage.getItem('shopify_orders') || '[]');
                const order = shopifyOrders.find(o => o.name === orderId);
                if (order) {
                    if (action === 'delivered' || action === 'next') {
                        order.processed = true;
                        order.fulfillmentStatus = 'fulfilled';
                        localStorage.setItem('shopify_orders', JSON.stringify(shopifyOrders));

                        // Ajouter √† la liste des trait√©s
                        const processed = JSON.parse(localStorage.getItem('shopify_processed') || '[]');
                        if (!processed.includes(orderId)) {
                            processed.push(orderId);
                            localStorage.setItem('shopify_processed', JSON.stringify(processed));
                        }
                    }
                }
            } else if (source === 'myfish') {
                const myfishOrders = JSON.parse(localStorage.getItem('myfish_orders') || '[]');
                const order = myfishOrders.find(o => o.id === orderId);
                if (order) {
                    if (action === 'delivered') {
                        order.status = 'delivered';
                    } else if (action === 'next') {
                        const mfStatusMap = { new: 'confirmed', confirmed: 'production', production: 'ready', ready: 'delivered' };
                        order.status = mfStatusMap[order.status] || 'delivered';
                    }
                    localStorage.setItem('myfish_orders', JSON.stringify(myfishOrders));
                }
            }

            showToast('‚úÖ Statut mis √† jour', 'success');
            updateTrackingView();
        }

        function showTrackingOrderDetail(orderId, source) {
            // Rediriger vers le module appropri√©
            if (source === 'quickorder') {
                navigateTo('orders');
            } else if (source === 'shopify') {
                navigateTo('shopify');
                setTimeout(() => showShopifyOrderDetail(orderId), 200);
            } else if (source === 'myfish') {
                navigateTo('myfish');
            }
        }

        // Initialiser le tracking quand on va sur la page
        const originalNavigateToTracking = navigateTo;
        navigateTo = function(pageName) {
            originalNavigateToTracking(pageName);
            if (pageName === 'tracking') {
                setTimeout(initTracking, 100);
            }
        };

        // =====================================================

        // Initialiser les analytics quand on va sur la page
        const originalNavigateToAnalytics = navigateTo;
        navigateTo = function(pageName) {
            originalNavigateToAnalytics(pageName);
            if (pageName === 'analyses') {
                setTimeout(initAnalytics, 100);
            }
        };

        // Init version info au chargement
        document.addEventListener('DOMContentLoaded', initTrakioVersionInfo);
        setTimeout(initTrakioVersionInfo, 1000);

        // =====================================================

        // Init settings quand on va sur la page
        const originalNavigateToSettings = navigateTo;
        navigateTo = function(pageName) {
            originalNavigateToSettings(pageName);
            if (pageName === 'settings') {
                setTimeout(() => {
                    initDropboxSettings();
                    initNumberingSettings();
                    loadCompanySettings();
                }, 100);
            }
        };

        // =====================================================
        // NOTIFICATIONS JOUR J & BADGES DASHBOARD
        // =====================================================

        function toggleNotifications(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('notifications-dropdown');
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                updateDayAlerts();
            }
        }

        // Fermer les notifications en cliquant ailleurs
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('notifications-dropdown');
            const btn = document.getElementById('notificationBtn');
            if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        function updateDayAlerts() {
            const today = new Date();
            const todayStr = today.toLocaleDateString('fr-CH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('notif-date').textContent = todayStr;

            const alerts = [];

            // 1. Commandes Shopify du jour
            const shopifyOrders = JSON.parse(localStorage.getItem('shopify_orders') || '[]');
            const shopifyProcessed = JSON.parse(localStorage.getItem('shopify_processed') || '[]');
            const todayShopify = shopifyOrders.filter(o => {
                if (o.processed || shopifyProcessed.includes(o.name)) return false;
                if (!o.pickupDate) return false;
                const pickupDate = parsePickupDateForSort(o.pickupDate);
                if (!pickupDate) return false;
                return pickupDate.toDateString() === today.toDateString();
            });

            todayShopify.forEach(order => {
                alerts.push({
                    type: 'shopify',
                    icon: 'üõçÔ∏è',
                    color: '#96bf48',
                    title: `Shopify ${order.name}`,
                    subtitle: order.billingName || order.shippingName,
                    time: order.pickupTime || '',
                    location: order.pickupLocation || 'Livraison',
                    action: () => { navigateTo('shopify'); setTimeout(() => showShopifyOrderDetail(order.name), 200); }
                });
            });

            // 2. Commandes QuickOrder du jour (commandes B2B/B2C)
            if (typeof QOData !== 'undefined' && QOData.orders) {
                const todayQO = QOData.orders.filter(o => {
                    if (o.status === 'delivered' || o.status === 'cancelled') return false;
                    if (!o.deliveryDate) return false;
                    const deliveryDate = new Date(o.deliveryDate);
                    return deliveryDate.toDateString() === today.toDateString();
                });

                todayQO.forEach(order => {
                    alerts.push({
                        type: 'quickorder',
                        icon: '‚ö°',
                        color: 'var(--accent-primary)',
                        title: `Cmd ${order.id}`,
                        subtitle: order.clientName,
                        time: order.deliveryTime || '',
                        location: order.deliveryAddress || '',
                        action: () => { navigateTo('orders'); }
                    });
                });
            }

            // 3. Commandes MyFish du jour
            const myfishOrders = JSON.parse(localStorage.getItem('myfish_orders') || '[]');
            const todayMyfish = myfishOrders.filter(o => {
                if (o.status === 'delivered' || o.status === 'cancelled') return false;
                if (!o.deliveryDate) return false;
                const deliveryDate = new Date(o.deliveryDate);
                return deliveryDate.toDateString() === today.toDateString();
            });

            todayMyfish.forEach(order => {
                alerts.push({
                    type: 'myfish',
                    icon: 'üêü',
                    color: 'var(--accent-secondary)',
                    title: `MyFish ${order.id || order.orderNum}`,
                    subtitle: order.clientName,
                    time: '',
                    location: order.store || '',
                    action: () => { navigateTo('myfish'); }
                });
            });

            // Mettre √† jour le badge
            const badge = document.getElementById('notif-badge');
            if (alerts.length > 0) {
                badge.style.display = 'flex';
                badge.textContent = alerts.length;
            } else {
                badge.style.display = 'none';
            }

            // Afficher la liste
            const list = document.getElementById('notifications-list');
            if (alerts.length === 0) {
                list.innerHTML = '<div style="padding:30px; text-align:center; color:var(--text-muted);"><div style="font-size:36px; margin-bottom:10px;">‚úÖ</div>Aucune livraison/retrait pr√©vu aujourd\'hui</div>';
            } else {
                list.innerHTML = alerts.map((alert, idx) => `
                    <div onclick="notificationAlerts[${idx}].action()" style="display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid var(--border-color); cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                        <div style="width:40px; height:40px; background:${alert.color}20; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px;">
                            ${alert.icon}
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:600; color:var(--text-primary);">${alert.title}</div>
                            <div style="font-size:12px; color:var(--text-muted);">${alert.subtitle}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:12px; font-weight:600; color:${alert.color};">${alert.time}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${alert.location}</div>
                        </div>
                    </div>
                `).join('');
            }

            // Stocker les actions pour les appeler au clic
            window.notificationAlerts = alerts;
        }

        // Mettre √† jour le badge Shopify sur le Dashboard
        function updateShopifyDashboardBadge() {
            const orders = JSON.parse(localStorage.getItem('shopify_orders') || '[]');
            const processed = JSON.parse(localStorage.getItem('shopify_processed') || '[]');

            const urgentCount = orders.filter(o =>
                o.financialStatus === 'paid' &&
                o.fulfillmentStatus === 'unfulfilled' &&
                !o.processed &&
                !processed.includes(o.name)
            ).length;

            const badge = document.getElementById('dashboard-shopify-badge');
            const count = document.getElementById('dashboard-shopify-count');

            if (badge && count) {
                if (urgentCount > 0) {
                    badge.style.display = 'block';
                    count.textContent = urgentCount + ' √† traiter';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Init au chargement
        setTimeout(() => {
            updateOrderFloatingBar();
            updateOrdersBadge();
            updateShopifyDashboardBadge();
            updateDayAlerts();
            updateDashboardSummary();
        }, 500);

        // =============================================
        // PRIX FOURNISSEURS - Module de gestion
        // =============================================

        const PFData = {
            suppliers: JSON.parse(localStorage.getItem('pf_suppliers') || '[]'),
            products: JSON.parse(localStorage.getItem('pf_products') || '[]'),
            priceHistory: JSON.parse(localStorage.getItem('pf_price_history') || '[]'),
            orders: JSON.parse(localStorage.getItem('pf_orders') || '[]'),
            currentOrder: { supplier: null, items: [], notes: '', deliveryDate: '' }
        };

        // Initialiser avec donn√©es Delmeer par d√©faut
        function initPFData() {
            if (PFData.suppliers.length === 0) {
                PFData.suppliers = [{
                    id: 'delmeer',
                    name: 'DELMEER SISSELN',
                    phone: '062 873 27 27',
                    fax: '062 873 27 29',
                    email: 'delmeer@delmeer.ch',
                    minOrder: 0,
                    deliveryDays: ['mardi', 'jeudi'],
                    active: true
                }];
                savePFData();
            }
            // Initialiser le panier si pas fait
            if (!PFData.currentOrder || !PFData.currentOrder.items) {
                PFData.currentOrder = { supplierId: null, items: [], notes: '', deliveryDate: '' };
            }
            renderPFCatalogue();
            renderPFSuppliers();
            updatePFStats();
            populatePFSupplierSelects();
            updatePFCartBadge();
        }

        function savePFData() {
            localStorage.setItem('pf_suppliers', JSON.stringify(PFData.suppliers));
            localStorage.setItem('pf_products', JSON.stringify(PFData.products));
            localStorage.setItem('pf_price_history', JSON.stringify(PFData.priceHistory));
            localStorage.setItem('pf_orders', JSON.stringify(PFData.orders));
        }

        // Onglets
        function switchPFTab(tab) {
            document.querySelectorAll('.pf-tab').forEach(t => {
                t.style.background = 'var(--bg-card)';
                t.style.color = 'var(--text-primary)';
                t.style.border = '1px solid var(--border-color)';
            });
            document.querySelectorAll('.pf-content').forEach(c => c.style.display = 'none');

            const activeTab = document.getElementById('pf-tab-' + tab);
            if (activeTab) {
                activeTab.style.background = 'var(--accent-primary)';
                activeTab.style.color = '#000';
                activeTab.style.border = 'none';
            }

            const content = document.getElementById('pf-content-' + tab);
            if (content) content.style.display = 'block';

            if (tab === 'fournisseurs') renderPFSuppliers();
            if (tab === 'commandes') renderPFOrders();
            if (tab === 'historique') renderPFHistory();
        }

        // Render catalogue
        function renderPFCatalogue() {
            const tbody = document.getElementById('pf-catalogue-tbody');
            if (!tbody) return;

            let products = [...PFData.products];
            const search = (document.getElementById('pf-search')?.value || '').toLowerCase().trim();
            const supplierFilter = document.getElementById('pf-filter-supplier')?.value || '';

            // Filtrer par recherche (plus flexible)
            if (search) {
                products = products.filter(p => {
                    const name = (p.name || '').toLowerCase();
                    const nameShort = (p.nameShort || '').toLowerCase();
                    const code = (p.code || '').toLowerCase();
                    const origin = (p.origin || '').toLowerCase();
                    
                    // Recherche par mots (tous les mots doivent √™tre pr√©sents)
                    const searchWords = search.split(' ').filter(w => w.length > 0);
                    return searchWords.every(word => 
                        name.includes(word) || 
                        nameShort.includes(word) || 
                        code.includes(word) ||
                        origin.includes(word)
                    );
                });
            }

            if (supplierFilter) {
                products = products.filter(p => p.supplierId === supplierFilter);
            }

            // Tri alphab√©tique par nom
            products.sort((a, b) => (a.name || a.nameShort || '').localeCompare(b.name || b.nameShort || '', 'fr'));
>>>>>>> parent of 327a79d (Update index.html)

        function renderAll() {
            renderPostes();
            renderFournisseurs();
            renderCharges();
            renderBudget();
            updateDashboard();
            updateAnalyses();
        }
    </script>
</body>
</html>

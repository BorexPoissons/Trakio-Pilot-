<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TRAKIO v3.0.3 - Gestion Complète</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2234;
            --bg-hover: #243049;
            --accent-primary: #06d6a0;
            --accent-secondary: #118ab2;
            --accent-warning: #ffd166;
            --accent-danger: #ef476f;
            --accent-purple: #9d4edd;
            --accent-orange: #ff6b35;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2d3a4f;
            --sidebar-width: 280px;
            --sidebar-collapsed: 80px;
            --header-height: 70px;
            --radius: 16px;
            --radius-sm: 10px;
            --shadow: 0 8px 32px rgba(0,0,0,0.4);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="light"] {
            --bg-primary: #f1f5f9;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --shadow: 0 8px 32px rgba(0,0,0,0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 1000;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        .sidebar-header {
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 14px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            width: 46px;
            height: 46px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 18px;
            color: var(--bg-primary);
            flex-shrink: 0;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: var(--transition);
        }

        .sidebar.collapsed .logo-text {
            opacity: 0;
            width: 0;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 12px;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            padding: 0 14px;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        /* Section repliable */
        .nav-section-title.collapsible {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 8px 14px;
            margin: 0 8px 10px 8px;
            background: var(--bg-hover);
            border-radius: 8px;
            user-select: none;
        }

        .nav-section-title.collapsible:hover {
            background: var(--border-color);
        }

        .nav-section-title .toggle-icon {
            font-size: 10px;
            transition: transform 0.3s ease;
        }

        .nav-section-title.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .nav-section-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 1000px;
            opacity: 1;
        }

        .nav-section-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .sidebar.collapsed .nav-section-title {
            opacity: 0;
            height: 0;
            margin: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
            margin-bottom: 4px;
            position: relative;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(6, 214, 160, 0.15), rgba(17, 138, 178, 0.15));
            color: var(--accent-primary);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: var(--accent-primary);
            border-radius: 0 4px 4px 0;
        }

        .nav-icon {
            width: 22px;
            height: 22px;
            flex-shrink: 0;
        }

        .nav-text {
            font-weight: 500;
            font-size: 15px;
            white-space: nowrap;
            transition: var(--transition);
        }

        .sidebar.collapsed .nav-text {
            opacity: 0;
            width: 0;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--accent-danger);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 20px;
            transition: var(--transition);
        }

        .sidebar.collapsed .nav-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 2px 6px;
            font-size: 10px;
        }

        /* Toggle Button */
        .sidebar-toggle {
            position: absolute;
            right: -14px;
            top: 85px;
            width: 28px;
            height: 28px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            z-index: 10;
        }

        .sidebar-toggle:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        .sidebar-toggle svg {
            width: 16px;
            height: 16px;
            transition: var(--transition);
        }

        .sidebar.collapsed .sidebar-toggle svg {
            transform: rotate(180deg);
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: var(--transition);
        }

        .sidebar.collapsed ~ .main-content {
            margin-left: var(--sidebar-collapsed);
        }

        /* Header */
        .header {
            height: var(--header-height);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .page-title {
            font-size: 22px;
            font-weight: 600;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 10px 18px;
            width: 320px;
            transition: var(--transition);
        }

        .search-box:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(6, 214, 160, 0.1);
        }

        .search-box input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-btn {
            width: 42px;
            height: 42px;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
            position: relative;
        }

        .header-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .header-btn .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: var(--accent-danger);
            border-radius: 50%;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 12px 6px 6px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .user-profile:hover {
            background: var(--bg-hover);
        }

        .user-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-orange));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-name {
            font-weight: 500;
            font-size: 14px;
        }

        /* Menu utilisateur déroulant */
        .user-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 280px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
            overflow: hidden;
        }

        .user-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-menu-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--accent-primary)20, var(--accent-secondary)20);
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .user-menu-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-orange));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 24px;
            margin: 0 auto 10px;
            border: 3px solid var(--bg-card);
        }

        .user-menu-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .user-menu-role {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
        }

        .role-admin { background: var(--accent-danger)20; color: var(--accent-danger); }
        .role-superuser { background: var(--accent-warning)20; color: var(--accent-warning); }
        .role-user { background: var(--accent-primary)20; color: var(--accent-primary); }

        .user-menu-body {
            padding: 8px;
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .user-menu-item:hover {
            background: var(--bg-hover);
        }

        .user-menu-item.danger {
            color: var(--accent-danger);
        }

        .user-menu-item.danger:hover {
            background: var(--accent-danger)15;
        }

        .user-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 8px 0;
        }

        /* Page Content */
        .page-content {
            padding: 32px;
        }

        .module-page {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .module-page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(20px); opacity: 0; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 24px;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon.green { background: rgba(6, 214, 160, 0.15); color: var(--accent-primary); }
        .stat-icon.blue { background: rgba(17, 138, 178, 0.15); color: var(--accent-secondary); }
        .stat-icon.yellow { background: rgba(255, 209, 102, 0.15); color: var(--accent-warning); }
        .stat-icon.red { background: rgba(239, 71, 111, 0.15); color: var(--accent-danger); }
        .stat-icon.purple { background: rgba(157, 78, 221, 0.15); color: var(--accent-purple); }
        .stat-icon.orange { background: rgba(255, 107, 53, 0.15); color: var(--accent-orange); }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            font-weight: 500;
        }

        .stat-trend.up { color: var(--accent-primary); }
        .stat-trend.down { color: var(--accent-danger); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 6px;
            font-family: 'Space Mono', monospace;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .card-body {
            padding: 24px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6, 214, 160, 0.3);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover td {
            background: var(--bg-hover);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.success { background: rgba(6, 214, 160, 0.15); color: var(--accent-primary); }
        .status-badge.warning { background: rgba(255, 209, 102, 0.15); color: var(--accent-warning); }
        .status-badge.danger { background: rgba(239, 71, 111, 0.15); color: var(--accent-danger); }
        .status-badge.info { background: rgba(17, 138, 178, 0.15); color: var(--accent-secondary); }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 32px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }

        .timeline-item {
            position: relative;
            padding-bottom: 24px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -28px;
            top: 4px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent-primary);
            border: 3px solid var(--bg-card);
        }

        .timeline-item.warning::before { background: var(--accent-warning); }
        .timeline-item.danger::before { background: var(--accent-danger); }

        .timeline-time {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .timeline-content {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Form Groups (used in Settings) */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select {
            padding: 14px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(6, 214, 160, 0.1);
        }

        /* Prix Traversette Module */
        .prix-config-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
            padding: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
        }

        .prix-config-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .prix-config-item label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .prix-config-item input {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            padding: 12px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .prix-config-item input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(6, 214, 160, 0.15);
        }

        .prix-config-value {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-primary);
            padding: 12px 14px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }

        .prix-search-container {
            position: relative;
            margin-bottom: 24px;
        }

        .prix-search-container svg {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .prix-search-container input {
            width: 100%;
            padding: 16px 18px 16px 50px;
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .prix-search-container input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(6, 214, 160, 0.1);
        }

        .prix-search-container input::placeholder {
            color: var(--text-muted);
        }

        .prix-search-stats {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            color: var(--text-muted);
            font-family: 'Space Mono', monospace;
        }

        .prix-table-wrapper {
            overflow-x: auto;
        }

        .prix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .prix-table thead {
            background: var(--bg-primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .prix-table th {
            padding: 14px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .prix-table th.prix-num {
            text-align: center;
            width: 50px;
        }

        .prix-table th.prix-check-col,
        .prix-table td.prix-check-col {
            text-align: center;
            width: 40px;
        }

        .prix-row-check {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .prix-table tr:has(.prix-row-check:checked) {
            background: rgba(6, 214, 160, 0.08);
        }

        .prix-table tr:has(.prix-row-check:checked) .prix-product-name,
        .prix-table tr:has(.prix-row-check:checked) .prix-art-code {
            opacity: 0.6;
        }

        .prix-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .prix-table tbody tr:hover {
            background: rgba(6, 214, 160, 0.03);
        }

        .prix-table tbody tr:last-child td {
            border-bottom: none;
        }

        .prix-row-num {
            text-align: center;
            font-family: 'Space Mono', monospace;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 12px;
        }

        .prix-art-code {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--accent-orange);
            font-weight: 600;
        }

        .prix-product-name {
            font-weight: 500;
        }

        .prix-qty {
            text-align: center;
            font-family: 'Space Mono', monospace;
            font-weight: 600;
            font-size: 14px;
        }

        .prix-eur {
            font-family: 'Space Mono', monospace;
            text-align: right;
            color: var(--text-muted);
        }

        .prix-chf {
            font-family: 'Space Mono', monospace;
            text-align: right;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .prix-customs {
            font-family: 'Space Mono', monospace;
            text-align: right;
            color: var(--accent-warning);
        }

        .prix-marge {
            font-family: 'Space Mono', monospace;
            text-align: right;
            color: var(--accent-purple);
        }

        .prix-tva {
            font-family: 'Space Mono', monospace;
            text-align: right;
            color: var(--accent-secondary);
        }

        .prix-final {
            font-family: 'Space Mono', monospace;
            text-align: right;
            font-weight: 700;
            font-size: 14px;
            color: #22c55e;
        }

        .prix-ean-input {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            padding: 8px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            width: 130px;
            transition: var(--transition);
        }

        .prix-ean-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .prix-ean-input::placeholder {
            color: var(--text-muted);
            font-size: 10px;
        }

        .prix-btn-copy {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
            margin-left: 6px;
        }

        .prix-btn-copy:hover {
            background: var(--border-color);
            border-color: var(--accent-primary);
        }

        .prix-btn-copy.copied {
            background: #22c55e;
            border-color: #22c55e;
        }

        .prix-cell-copy {
            white-space: nowrap;
        }

        .prix-badge-degust {
            display: inline-block;
            font-size: 10px;
            padding: 2px 8px;
            background: var(--accent-warning);
            color: var(--bg-primary);
            border-radius: 4px;
            font-weight: 600;
            margin-left: 8px;
        }

        .prix-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .prix-summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
        }

        .prix-summary-card.highlight {
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(6, 214, 160, 0.1), transparent);
        }

        .prix-summary-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .prix-summary-value {
            font-family: 'Space Mono', monospace;
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .prix-summary-card.highlight .prix-summary-value {
            color: var(--accent-primary);
        }

        .prix-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        /* Settings */
        .settings-form {
            display: grid;
            gap: 20px;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-info h4 {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .setting-info p {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            width: 52px;
            height: 28px;
            background: var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle.active {
            background: var(--accent-primary);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle.active::after {
            left: 27px;
        }

        /* Report Cards */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .report-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 24px;
            cursor: pointer;
            transition: var(--transition);
        }

        .report-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
        }

        .report-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .report-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .report-desc {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Mobile */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .mobile-menu-btn {
                display: flex !important;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
            }

            .search-box {
                display: none;
            }

            .page-content {
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .user-name {
                display: none;
            }
        }

        /* ========== MYFISH PRO RESPONSIVE ========== */

        /* Compacter les boutons B2B/B2C sur mobile */
        @media (max-width: 768px) {
            .mf-type-btn {
                padding: 12px !important;
            }
            .mf-type-btn > div:first-child {
                font-size: 24px !important;
                margin-bottom: 4px !important;
            }
            .mf-type-btn > div:nth-child(2) {
                font-size: 14px !important;
            }
            .mf-type-btn > div:nth-child(3) {
                display: none !important;
            }

            /* Input recherche plus compact */
            #mf-client-search {
                padding: 14px 16px !important;
                font-size: 16px !important;
                border-width: 2px !important;
                border-radius: 12px !important;
            }

            /* Client sélectionné compact */
            #mf-selected-client {
                padding: 12px !important;
                border-radius: 10px !important;
            }
            #mf-selected-client h3 {
                font-size: 16px !important;
            }

            /* Formulaire client compact */
            #mf-quick-client-form {
                padding: 16px !important;
                border-radius: 12px !important;
            }
            #mf-quick-client-form input,
            #mf-quick-client-form textarea {
                padding: 10px !important;
            }

            /* Grilles compact sur mobile */
            .mf-step-content .grid-2 {
                grid-template-columns: 1fr !important;
                gap: 8px !important;
            }

            /* Cards MyFish compact */
            .mf-step-content .card {
                border-radius: 12px !important;
            }
            .mf-step-content .card-header {
                padding: 12px 16px !important;
            }
            .mf-step-content .card-body {
                padding: 12px 16px !important;
            }
            .mf-step-content .card-title {
                font-size: 16px !important;
            }

            /* Barre progression compact */
            #mf-view-neworder > div:first-child {
                padding: 12px !important;
                border-radius: 12px !important;
            }

            /* Stats grid compact */
            #page-myfish .stats-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }
            #page-myfish .stat-card {
                padding: 12px !important;
            }
            #page-myfish .stat-value {
                font-size: 24px !important;
            }

            /* Boutons navigation étapes */
            .mf-step-content button.btn {
                padding: 10px 16px !important;
                font-size: 14px !important;
            }

            /* Articles liste compact */
            #mf-articles-grid {
                gap: 6px !important;
            }
            .mf-article-item {
                padding: 10px !important;
            }

            /* Panier compact */
            #mf-cart-items > div {
                padding: 10px !important;
                margin-bottom: 6px !important;
            }

            /* Tableau commandes responsive */
            #mf-orders-tbody td {
                padding: 8px 6px !important;
                font-size: 12px !important;
            }
        }

        /* Tablette */
        @media (max-width: 1024px) and (min-width: 769px) {
            .mf-type-btn {
                padding: 16px !important;
            }
            #page-myfish .stats-grid {
                grid-template-columns: repeat(4, 1fr) !important;
            }
        }

        /* Très petit écran (smartphone) */
        @media (max-width: 480px) {
            #page-myfish .stats-grid {
                grid-template-columns: 1fr 1fr !important;
            }
            #page-myfish .stat-card {
                padding: 10px !important;
            }
            #page-myfish .stat-value {
                font-size: 20px !important;
            }
            #page-myfish .stat-label {
                font-size: 10px !important;
            }

            /* Masquer certaines colonnes tableau */
            .hide-mobile,
            #mf-orders-tbody td:nth-child(5),
            #mf-orders-tbody th:nth-child(5) {
                display: none !important;
            }

            /* Boutons B2B/B2C en colonne sur très petit écran */
            #mf-step-1 > .card > .card-body > div:first-child {
                flex-direction: column !important;
            }

            /* Grille magasins */
            .grid-3 {
                grid-template-columns: 1fr 1fr !important;
            }
        }

        .mobile-menu-btn {
            display: none;
            width: 42px;
            height: 42px;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-primary);
        }

        /* Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* ========================================
           PRIX POISSONS MODULE - TrakioManager
           ======================================== */

        .trakio-poissons-container {
            font-family: 'Outfit', sans-serif;
            max-width: 100%;
            padding: 0;
            background: transparent;
            min-height: auto;
            color: var(--text-primary);
        }

        .trakio-poissons-header {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem 2rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .trakio-poissons-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .trakio-poissons-header .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .trakio-poissons-container .btn {
            padding: 0.65rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            min-height: 40px;
            font-family: 'Outfit', sans-serif;
        }

        .trakio-poissons-container .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
            box-shadow: 0 4px 15px rgba(6, 214, 160, 0.3);
        }

        .trakio-poissons-container .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(6, 214, 160, 0.4);
        }

        .trakio-poissons-container .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .trakio-poissons-container .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .trakio-poissons-container .btn-outline {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
        }

        .trakio-poissons-container .btn-outline:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .trakio-poissons-container .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            min-height: auto;
        }

        .trakio-poissons-container .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .trakio-poissons-container .nav-tab {
            padding: 0.85rem 1.5rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
        }

        .trakio-poissons-container .nav-tab.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        .trakio-poissons-container .nav-tab:hover:not(.active) {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .trakio-poissons-container .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
        }

        .trakio-poissons-container .card-header {
            padding: 1.25rem 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .trakio-poissons-container .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
            color: var(--text-primary);
        }

        .trakio-poissons-container .card-content {
            padding: 1.25rem 1.5rem;
        }

        .trakio-poissons-container .auto-save {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .trakio-poissons-container .search-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }

        .trakio-poissons-container .search-container {
            flex: 1;
            position: relative;
        }

        .trakio-poissons-container .search-input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: 'Outfit', sans-serif;
        }

        .trakio-poissons-container .search-input::placeholder {
            color: var(--text-muted);
        }

        .trakio-poissons-container .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-hover);
        }

        .trakio-poissons-container .search-clear {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0.25rem;
            border-radius: 50%;
            display: none;
        }

        .trakio-poissons-container .search-clear.visible {
            display: block;
        }

        .trakio-poissons-container .search-clear:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .trakio-poissons-container .table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius-sm);
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-height: 60vh;
            overflow-y: auto;
        }

        .trakio-poissons-container table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            min-width: 1100px;
        }

        .trakio-poissons-container th {
            background: linear-gradient(135deg, #0a0e17, #1a2234);
            padding: 0.5rem 0.4rem;
            font-weight: 600;
            color: var(--accent-primary);
            text-align: center;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--accent-primary);
        }

        .trakio-poissons-container td {
            padding: 0.4rem 0.4rem;
            text-align: center;
            border-bottom: 1px solid #f1f5f9;
            color: #1e293b;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            line-height: 1.2;
        }

        .trakio-poissons-container tbody tr:nth-child(odd) {
            background: #ffffff;
        }

        .trakio-poissons-container tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .trakio-poissons-container tbody tr:hover {
            background: #e2e8f0 !important;
        }

        .trakio-poissons-container .product-name {
            text-align: left !important;
            max-width: 220px;
            font-weight: 500;
            color: #0f172a;
        }

        .trakio-poissons-container .editable {
            background: #e5e7eb;
            cursor: pointer;
            border-radius: 3px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .trakio-poissons-container .editable:hover {
            background: #d1d5db;
            border-color: #9ca3af;
        }

        .trakio-poissons-container .final-price {
            font-weight: 700;
            background: linear-gradient(135deg, #06d6a0, #118ab2);
            color: #0a0e17;
            border-radius: 3px;
        }

        .trakio-poissons-container .favorite-btn {
            background: transparent;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.3rem;
            border-radius: 3px;
            transition: all 0.2s ease;
            width: 1.8rem;
            height: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }

        .trakio-poissons-container .favorite-btn:hover {
            background: #f3f4f6;
            color: #6b7280;
        }

        .trakio-poissons-container .favorite-btn.active {
            background: var(--accent-primary);
            color: #0a0e17;
        }

        .trakio-poissons-container .new-row {
            background: rgba(16, 185, 129, 0.1) !important;
            border-left: 4px solid #10b981;
        }

        .trakio-poissons-container .status {
            padding: 1rem 1.25rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 0.75rem;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
        }

        .trakio-poissons-container .status.success {
            background: rgba(6, 214, 160, 0.2);
            color: var(--accent-primary);
            border: 2px solid rgba(6, 214, 160, 0.3);
        }

        .trakio-poissons-container .status.error {
            background: rgba(239, 71, 111, 0.2);
            color: var(--accent-danger);
            border: 2px solid rgba(239, 71, 111, 0.3);
        }

        .trakio-poissons-container .status.warning {
            background: rgba(255, 209, 102, 0.2);
            color: var(--accent-warning);
            border: 2px solid rgba(255, 209, 102, 0.3);
        }

        .trakio-poissons-container .week-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .trakio-poissons-container .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 1.25rem;
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .trakio-poissons-container .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            color: var(--accent-primary);
        }

        .trakio-poissons-container .stat-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .trakio-poissons-container .week-save-section {
            background: rgba(6, 214, 160, 0.1);
            border: 1px solid rgba(6, 214, 160, 0.2);
            padding: 1.25rem;
            border-radius: var(--radius-sm);
            margin-bottom: 1.5rem;
        }

        .trakio-poissons-container .week-save-section h4 {
            margin-bottom: 1rem;
            color: var(--accent-primary);
        }

        .trakio-poissons-container .form-input {
            width: 100%;
            padding: 0.65rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
        }

        .trakio-poissons-container .form-input::placeholder {
            color: var(--text-muted);
        }

        .trakio-poissons-container .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .trakio-poissons-container .hidden {
            display: none !important;
        }

        .trakio-poissons-container .tab-content {
            display: block;
        }

        .trakio-poissons-container .tab-content.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .trakio-poissons-container { padding: 0.5rem; }
            .trakio-poissons-header { padding: 1rem; text-align: center; }
            .trakio-poissons-header h1 { font-size: 1.25rem; }
            .trakio-poissons-container .nav-tabs { flex-direction: column; }
            .trakio-poissons-header .header-actions { justify-content: center; }
            .trakio-poissons-container table { font-size: 0.7rem; }
            .trakio-poissons-container th, .trakio-poissons-container td { padding: 0.4rem; }
        }

        /* Shopify clickable rows */
        .clickable-row { cursor: pointer; transition: all 0.2s; }
        .clickable-row:hover { background: var(--bg-hover) !important; }
    </style>
</head>
<body>
    <!-- ═══════════════════════════════════════════════════════════════════════
         🔐 ÉCRAN DE CONNEXION
         ═══════════════════════════════════════════════════════════════════════ -->
    <div id="login-screen" style="position:fixed; inset:0; background:linear-gradient(135deg, #0a0f1a 0%, #1a2332 50%, #0d1520 100%); z-index:99999; display:flex; align-items:center; justify-content:center; padding:20px;">
        
        <!-- Particules décoratives -->
        <div style="position:absolute; inset:0; overflow:hidden; pointer-events:none;">
            <div style="position:absolute; width:300px; height:300px; background:radial-gradient(circle, rgba(6,214,160,0.1) 0%, transparent 70%); top:10%; left:10%; animation:float 6s ease-in-out infinite;"></div>
            <div style="position:absolute; width:400px; height:400px; background:radial-gradient(circle, rgba(17,138,178,0.08) 0%, transparent 70%); bottom:10%; right:10%; animation:float 8s ease-in-out infinite reverse;"></div>
        </div>
        
        <!-- Modal de login -->
        <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:24px; padding:40px 36px; width:100%; max-width:380px; box-shadow:0 25px 80px rgba(0,0,0,0.5); position:relative; z-index:1;">
            
            <!-- Logo -->
            <div style="text-align:center; margin-bottom:32px;">
                <div style="width:80px; height:80px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius:20px; display:flex; align-items:center; justify-content:center; margin:0 auto 16px; box-shadow:0 10px 30px rgba(6,214,160,0.3);">
                    <span style="font-size:36px;">🐟</span>
                </div>
                <h1 style="font-size:28px; font-weight:800; margin-bottom:4px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">TRAKIO</h1>
                <p style="color:var(--text-muted); font-size:13px;">Gestion Borex Poissons</p>
            </div>
            
            <!-- Formulaire -->
            <div style="display:flex; flex-direction:column; gap:20px;">
                
                <!-- Sélection utilisateur -->
                <div>
                    <label style="display:block; font-size:12px; font-weight:600; color:var(--text-muted); margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px;">👤 Utilisateur</label>
                    <select id="login-user-select" style="width:100%; padding:14px 16px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:12px; color:var(--text-primary); font-size:15px; font-weight:500; cursor:pointer; transition:all 0.2s;" onchange="updateLoginAvatar()">
                        <option value="">Sélectionnez...</option>
                    </select>
                </div>
                
                <!-- Code PIN -->
                <div>
                    <label style="display:block; font-size:12px; font-weight:600; color:var(--text-muted); margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px;">🔒 Code PIN</label>
                    <div style="position:relative;">
                        <input type="password" id="login-pin-input" maxlength="6" placeholder="••••" style="width:100%; padding:14px 50px 14px 16px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:12px; color:var(--text-primary); font-size:20px; font-weight:600; letter-spacing:8px; text-align:center; transition:all 0.2s;" onkeypress="if(event.key==='Enter') attemptLogin()">
                        <button onclick="togglePinVisibility()" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-muted); cursor:pointer; padding:4px;">
                            <svg id="pin-eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Message d'erreur -->
                <div id="login-error" style="display:none; background:rgba(255,107,107,0.15); border:1px solid rgba(255,107,107,0.3); border-radius:10px; padding:12px 16px; text-align:center;">
                    <span style="color:#ff6b6b; font-size:13px; font-weight:500;">❌ Code PIN incorrect</span>
                </div>
                
                <!-- Bouton connexion -->
                <button id="login-btn" onclick="attemptLogin()" style="width:100%; padding:16px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border:none; border-radius:12px; color:white; font-size:16px; font-weight:700; cursor:pointer; transition:all 0.3s; box-shadow:0 6px 20px rgba(6,214,160,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(6,214,160,0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 6px 20px rgba(6,214,160,0.3)'">
                    🚀 Se connecter
                </button>
                
            </div>
            
            <!-- Footer -->
            <div style="text-align:center; margin-top:28px; padding-top:20px; border-top:1px solid var(--border-color);">
                <p style="font-size:11px; color:var(--text-muted);">v3.0.0 • Déconnexion auto après 1h</p>
            </div>
            
        </div>
    </div>
    
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        #login-user-select:focus, #login-pin-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(6,214,160,0.2);
        }
        #login-user-select option {
            background: var(--bg-card);
            padding: 10px;
        }
    </style>

    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">TR</div>
            <span class="logo-text">TRAKIO</span>
            <span id="nav-version" style="font-size:10px; color:var(--text-muted); margin-left:6px; font-family:'Space Mono',monospace;">v3.0.0</span>
        </div>

        <button class="sidebar-toggle" id="sidebarToggle">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
        </button>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <div class="nav-item active" data-page="dashboard">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="9" rx="1"/>
                        <rect x="14" y="3" width="7" height="5" rx="1"/>
                        <rect x="14" y="12" width="7" height="9" rx="1"/>
                        <rect x="3" y="16" width="7" height="5" rx="1"/>
                    </svg>
                    <span class="nav-text">Accueil</span>
                </div>
                <div class="nav-item" data-page="analyses">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M18 9l-5 5-4-4-4 4"/>
                    </svg>
                    <span class="nav-text">📊 Analyses</span>
                </div>
                <div class="nav-item" data-page="orders">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                        <rect x="9" y="3" width="6" height="4" rx="1"/>
                        <path d="M9 12h6m-6 4h6"/>
                    </svg>
                    <span class="nav-text">Cmd en cours</span>
                    <span class="nav-badge" id="orders-badge">0</span>
                </div>
                <div class="nav-item" data-page="tracking">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <span class="nav-text">Suivi</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title collapsible collapsed" onclick="toggleNavSection(this)">
                    <span>🛠️ Outils</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="nav-section-content collapsed" id="tools-section">
                <div class="nav-item" data-page="nutriscore">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    <span class="nav-text">Nutri-Score</span>
                </div>
                <div class="nav-item" data-page="prix-traversette">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                    </svg>
                    <span class="nav-text">Prix Traversette</span>
                </div>
                <div class="nav-item" data-page="cours-poissons">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6.5 12c3-7 14-7 14 0s-11 7-14 0z"/>
                        <circle cx="17" cy="12" r="1" fill="currentColor"/>
                        <path d="M2 12l4-3v6z"/>
                    </svg>
                    <span class="nav-text">Cours Poissons</span>
                </div>
                <div class="nav-item" data-page="prix-fournisseurs">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2"/>
                        <line x1="8" y1="21" x2="16" y2="21"/>
                        <line x1="12" y1="17" x2="12" y2="21"/>
                        <path d="M7 8h2M7 11h4M15 8h2M15 11h2"/>
                    </svg>
                    <span class="nav-text">💰 Prix Fournisseurs</span>
                </div>
                <div class="nav-item" data-page="myfish">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6.5 12c3-7 14-7 14 0s-11 7-14 0z"/>
                        <circle cx="17" cy="12" r="1" fill="currentColor"/>
                        <path d="M2 12l4-3v6z"/>
                        <path d="M12 8v8M8 12h8" stroke-width="1.5"/>
                    </svg>
                    <span class="nav-text">🐟 MyFish</span>
                </div>
                <div class="nav-item" data-page="shop">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15.5 2.5L14 10l-4 1 1.5-8.5M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
                        <path d="M14 10l4 1-5 10-1-6-5-1 7-12"/>
                    </svg>
                    <span class="nav-text">🛍️ Shop Hub</span>
                </div>
                <div class="nav-item" data-page="quickorder">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    <span class="nav-text">⚡ Prise cmd</span>
                </div>
                <div class="nav-item" data-page="clients">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                    <span class="nav-text">👥 Clients</span>
                </div>
                <div class="nav-item" data-page="articles">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span class="nav-text">📦 Articles</span>
                </div>
                <div class="nav-item" data-page="reports">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    <span class="nav-text">Rapports</span>
                </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Système</div>
                <div class="nav-item" data-page="rh" data-permission="admin">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                    <span class="nav-text">RH Personnel</span>
                </div>
                <div class="nav-item" data-page="settings">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                    <span class="nav-text">Paramètres</span>
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="search-box" style="position:relative;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="text" id="global-search-input" placeholder="Rechercher clients, articles, commandes..." oninput="globalSearch(this.value)" onfocus="showGlobalSearchResults()" autocomplete="off">
                    <div id="global-search-results" style="display:none; position:absolute; top:calc(100% + 8px); left:0; right:0; min-width:400px; max-height:500px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; box-shadow:0 15px 50px rgba(0,0,0,0.4); overflow:hidden; z-index:9999;">
                        <div id="global-search-content" style="max-height:460px; overflow-y:auto;"></div>
                        <div style="padding:10px; border-top:1px solid var(--border-color); background:var(--bg-primary); font-size:11px; color:var(--text-muted); text-align:center;">
                            💡 Tapez pour rechercher dans clients, articles, commandes...
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <!-- Indicateur de synchronisation Dropbox -->
                <div class="sync-status" onclick="forceSyncNow()" title="Cliquez pour synchroniser" style="display:flex; align-items:center; gap:6px; padding:6px 12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:20px; cursor:pointer; margin-right:8px;">
                    <span id="sync-indicator" style="font-size:14px;">⚪</span>
                    <span style="font-size:11px; color:var(--text-muted);">Sync</span>
                </div>
                <button class="header-btn" id="themeToggle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                    </svg>
                </button>
                <!-- Notifications Jour J -->
                <div style="position:relative;">
                    <button class="header-btn" id="notificationBtn" onclick="toggleNotifications(event)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                            <path d="M13.73 21a2 2 0 01-3.46 0"/>
                        </svg>
                        <span class="badge" id="notif-badge" style="display:none;">0</span>
                    </button>
                    <!-- Dropdown Notifications -->
                    <div id="notifications-dropdown" style="display:none; position:absolute; top:calc(100% + 10px); right:0; width:380px; max-height:500px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.3); overflow:hidden; z-index:9999;">
                        <div style="padding:16px; background:linear-gradient(135deg, var(--accent-danger), #c0392b); color:#fff;">
                            <div style="font-weight:700; font-size:16px;">🔔 Alertes du Jour</div>
                            <div style="font-size:12px; opacity:0.9;" id="notif-date">-</div>
                        </div>
                        <div id="notifications-list" style="max-height:400px; overflow-y:auto;">
                            <div style="padding:20px; text-align:center; color:var(--text-muted);">
                                Aucune alerte pour aujourd'hui
                            </div>
                        </div>
                    </div>
                </div>
                <div class="user-profile" onclick="toggleUserMenu(event)">
                    <div class="user-avatar" id="header-user-avatar">PA</div>
                    <span class="user-name" id="header-user-name">Pascal</span>

                    <!-- Menu déroulant utilisateur -->
                    <div class="user-menu" id="user-menu">
                        <div class="user-menu-header">
                            <div class="user-menu-avatar" id="menu-user-avatar">PA</div>
                            <div class="user-menu-name" id="menu-user-name">Pascal</div>
                            <span class="user-menu-role role-admin" id="menu-user-role">👑 Administrateur</span>
                        </div>
                        <div class="user-menu-body">
                            <div class="user-menu-item" onclick="showUserProfile()">
                                <span>👤</span>
                                <span>Mon profil</span>
                            </div>
                            <div class="user-menu-item" onclick="navigateTo('settings')">
                                <span>⚙️</span>
                                <span>Paramètres</span>
                            </div>
                            <div class="user-menu-item" onclick="showUserManagement()" id="menu-users-btn">
                                <span>👥</span>
                                <span>Gestion utilisateurs</span>
                            </div>
                            <div class="user-menu-divider"></div>
                            <div class="user-menu-item" onclick="switchUser()">
                                <span>🔄</span>
                                <span>Changer d'utilisateur</span>
                            </div>
                            <div class="user-menu-item danger" onclick="logoutUser()">
                                <span>🚪</span>
                                <span>Déconnexion</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="page-content">
            <!-- Dashboard Page - Accueil PRO -->
            <div class="module-page active" id="page-dashboard">
                
                <!-- ═══════════════════════════════════════════════════════════════
                     🔴 ZONE URGENTE - Commandes en cours avec statuts
                     ═══════════════════════════════════════════════════════════════ -->
                <div id="urgent-zone" style="background:linear-gradient(135deg, rgba(255,107,107,0.08), rgba(255,159,67,0.05)); border:1px solid rgba(255,107,107,0.3); border-radius:16px; padding:16px; margin-bottom:20px;">
                    
                    <!-- Header zone urgente -->
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:14px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="width:36px; height:36px; background:linear-gradient(135deg, #ff6b6b, #ff9f43); border-radius:10px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(255,107,107,0.35);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            </div>
                            <div>
                                <div style="font-size:15px; font-weight:700; color:#ff6b6b;">Commandes en cours</div>
                                <div style="font-size:11px; color:var(--text-muted);">À traiter aujourd'hui</div>
                            </div>
                        </div>
                        <div id="urgent-total-badge" style="background:#ff6b6b; color:white; padding:6px 14px; border-radius:20px; font-size:14px; font-weight:700; font-family:'Space Mono',monospace; box-shadow:0 3px 10px rgba(255,107,107,0.4);">0</div>
                    </div>
                    
                    <!-- Statuts en ligne -->
                    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;">
                        
                        <!-- Nouvelles -->
                        <div onclick="navigateTo('orders'); setTimeout(()=>filterOrdersByStatus && filterOrdersByStatus('new'), 100)" style="cursor:pointer; background:rgba(255,193,7,0.15); border:1px solid rgba(255,193,7,0.4); border-radius:12px; padding:12px 8px; text-align:center; transition:all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255,193,7,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="font-size:22px; margin-bottom:4px;">🆕</div>
                            <div id="status-new-count" style="font-size:18px; font-weight:800; color:#ffc107; font-family:'Space Mono',monospace;">0</div>
                            <div style="font-size:9px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Nouvelles</div>
                        </div>
                        
                        <!-- En préparation -->
                        <div onclick="navigateTo('orders'); setTimeout(()=>filterOrdersByStatus && filterOrdersByStatus('preparing'), 100)" style="cursor:pointer; background:rgba(17,138,178,0.15); border:1px solid rgba(17,138,178,0.4); border-radius:12px; padding:12px 8px; text-align:center; transition:all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(17,138,178,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="font-size:22px; margin-bottom:4px;">🔄</div>
                            <div id="status-preparing-count" style="font-size:18px; font-weight:800; color:#118ab2; font-family:'Space Mono',monospace;">0</div>
                            <div style="font-size:9px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Prépa</div>
                        </div>
                        
                        <!-- Prêtes -->
                        <div onclick="navigateTo('orders'); setTimeout(()=>filterOrdersByStatus && filterOrdersByStatus('ready'), 100)" style="cursor:pointer; background:rgba(6,214,160,0.15); border:1px solid rgba(6,214,160,0.4); border-radius:12px; padding:12px 8px; text-align:center; transition:all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(6,214,160,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="font-size:22px; margin-bottom:4px;">✅</div>
                            <div id="status-ready-count" style="font-size:18px; font-weight:800; color:#06d6a0; font-family:'Space Mono',monospace;">0</div>
                            <div style="font-size:9px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Prêtes</div>
                        </div>
                        
                        <!-- MyFish -->
                        <div onclick="navigateTo('myfish')" style="cursor:pointer; background:rgba(156,136,255,0.15); border:1px solid rgba(156,136,255,0.4); border-radius:12px; padding:12px 8px; text-align:center; transition:all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(156,136,255,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="font-size:22px; margin-bottom:4px;">🐟</div>
                            <div id="status-myfish-count" style="font-size:18px; font-weight:800; color:#9c88ff; font-family:'Space Mono',monospace;">0</div>
                            <div style="font-size:9px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">MyFish</div>
                        </div>
                        
                    </div>
                </div>

                <!-- ═══════════════════════════════════════════════════════════════
                     🟢 ACCÈS RAPIDES - Modules quotidiens
                     ═══════════════════════════════════════════════════════════════ -->
                <div style="margin-bottom:20px;">
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                        <span style="font-size:14px;">⚡</span>
                        <span style="font-size:13px; font-weight:600; color:var(--text-primary);">Accès rapides</span>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;">
                        
                        <!-- Prise de Commande - PRINCIPAL -->
                        <div onclick="navigateTo('quickorder')" class="dash-tile-main" style="cursor:pointer; background:linear-gradient(145deg, rgba(6,214,160,0.15), rgba(17,138,178,0.1)); border:2px solid var(--accent-primary); border-radius:16px; padding:18px 12px; text-align:center; transition:all 0.25s; position:relative; overflow:hidden;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(6,214,160,0.35)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="position:absolute; top:0; left:0; right:0; height:3px; background:linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));"></div>
                            <div style="width:52px; height:52px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius:14px; display:flex; align-items:center; justify-content:center; margin:0 auto 10px; box-shadow:0 6px 18px rgba(6,214,160,0.4);">
                                <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
                            </div>
                            <div style="font-size:13px; font-weight:700; color:var(--accent-primary);">Commande</div>
                            <div style="font-size:10px; color:var(--text-muted); margin-top:2px;">Nouvelle prise</div>
                        </div>
                        
                        <!-- Articles -->
                        <div onclick="navigateTo('articles')" style="cursor:pointer; background:linear-gradient(145deg, rgba(255,107,107,0.12), rgba(255,159,67,0.08)); border:2px solid #ff6b6b; border-radius:16px; padding:18px 12px; text-align:center; transition:all 0.25s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(255,107,107,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="width:52px; height:52px; background:linear-gradient(135deg, #ff6b6b, #ff9f43); border-radius:14px; display:flex; align-items:center; justify-content:center; margin:0 auto 10px; box-shadow:0 6px 18px rgba(255,107,107,0.35);">
                                <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                            </div>
                            <div style="font-size:13px; font-weight:700; color:#ff6b6b;">Articles</div>
                            <div style="font-size:10px; color:var(--text-muted); margin-top:2px;">Catalogue</div>
                        </div>
                        
                        <!-- Clients -->
                        <div onclick="navigateTo('clients')" style="cursor:pointer; background:linear-gradient(145deg, rgba(255,183,77,0.12), rgba(255,152,0,0.08)); border:2px solid #ffb74d; border-radius:16px; padding:18px 12px; text-align:center; transition:all 0.25s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(255,183,77,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="width:52px; height:52px; background:linear-gradient(135deg, #ffb74d, #ff9800); border-radius:14px; display:flex; align-items:center; justify-content:center; margin:0 auto 10px; box-shadow:0 6px 18px rgba(255,183,77,0.35);">
                                <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                            </div>
                            <div style="font-size:13px; font-weight:700; color:#ffb74d;">Clients</div>
                            <div style="font-size:10px; color:var(--text-muted); margin-top:2px;">Fichier client</div>
                        </div>
                        
                        <!-- MyFish -->
                        <div onclick="navigateTo('myfish')" style="cursor:pointer; background:linear-gradient(145deg, rgba(17,138,178,0.12), rgba(6,214,160,0.08)); border:2px solid #118ab2; border-radius:16px; padding:18px 12px; text-align:center; transition:all 0.25s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(17,138,178,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="width:52px; height:52px; background:linear-gradient(135deg, #118ab2, #06d6a0); border-radius:14px; display:flex; align-items:center; justify-content:center; margin:0 auto 10px; box-shadow:0 6px 18px rgba(17,138,178,0.35);">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c1.4 0 2.7-.3 3.9-.8-.4-.9-.6-1.9-.6-3 0-3.9 3.1-7 7-7 .3 0 .6 0 .9.1C22.4 6.5 17.7 2 12 2z"/><circle cx="8" cy="10" r="1.5"/></svg>
                            </div>
                            <div style="font-size:13px; font-weight:700; color:#118ab2;">MyFish</div>
                            <div style="font-size:10px; color:var(--text-muted); margin-top:2px;">Clients privés</div>
                        </div>
                        
                        <!-- Cours Poissons -->
                        <div onclick="navigateTo('cours-poissons')" style="cursor:pointer; background:linear-gradient(145deg, rgba(0,206,201,0.12), rgba(129,236,236,0.08)); border:2px solid #00cec9; border-radius:16px; padding:18px 12px; text-align:center; transition:all 0.25s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(0,206,201,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="width:52px; height:52px; background:linear-gradient(135deg, #00cec9, #81ecec); border-radius:14px; display:flex; align-items:center; justify-content:center; margin:0 auto 10px; box-shadow:0 6px 18px rgba(0,206,201,0.35);">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M12 2C7 2 3 5 3 9c0 3 2.5 5.5 6 6.5V22l3-3 3 3v-6.5c3.5-1 6-3.5 6-6.5 0-4-4-7-9-7zm-2 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                            </div>
                            <div style="font-size:13px; font-weight:700; color:#00cec9;">Cours</div>
                            <div style="font-size:10px; color:var(--text-muted); margin-top:2px;">Prix du jour</div>
                        </div>
                        
                        <!-- Analyses -->
                        <div onclick="navigateTo('analyses')" style="cursor:pointer; background:linear-gradient(145deg, rgba(156,136,255,0.12), rgba(113,88,226,0.08)); border:2px solid #9c88ff; border-radius:16px; padding:18px 12px; text-align:center; transition:all 0.25s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(156,136,255,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="width:52px; height:52px; background:linear-gradient(135deg, #9c88ff, #7158e2); border-radius:14px; display:flex; align-items:center; justify-content:center; margin:0 auto 10px; box-shadow:0 6px 18px rgba(156,136,255,0.35);">
                                <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                            </div>
                            <div style="font-size:13px; font-weight:700; color:#9c88ff;">Analyses</div>
                            <div style="font-size:10px; color:var(--text-muted); margin-top:2px;">Statistiques</div>
                        </div>
                        
                    </div>
                </div>

                <!-- ═══════════════════════════════════════════════════════════════
                     ⚙️ OUTILS - Modules hebdomadaires regroupés
                     ═══════════════════════════════════════════════════════════════ -->
                <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:16px; padding:14px;">
                    
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; cursor:pointer;" onclick="toggleToolsSection()">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:14px;">🛠️</span>
                            <span style="font-size:13px; font-weight:600; color:var(--text-muted);">Outils & Configuration</span>
                        </div>
                        <svg id="tools-chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" style="transition:transform 0.3s;"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    
                    <div id="tools-section" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;">
                        
                        <!-- Liste Commandes -->
                        <div onclick="navigateTo('orders')" style="cursor:pointer; background:var(--bg-hover); border-radius:12px; padding:14px 8px; text-align:center; transition:all 0.2s;" onmouseover="this.style.background='rgba(9,132,227,0.15)'" onmouseout="this.style.background='var(--bg-hover)'">
                            <div style="width:38px; height:38px; background:linear-gradient(135deg, #0984e3, #74b9ff); border-radius:10px; display:flex; align-items:center; justify-content:center; margin:0 auto 8px; box-shadow:0 3px 10px rgba(9,132,227,0.3);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>
                            </div>
                            <div style="font-size:11px; font-weight:600;">Commandes</div>
                        </div>
                        
                        <!-- Suivi -->
                        <div onclick="navigateTo('tracking')" style="cursor:pointer; background:var(--bg-hover); border-radius:12px; padding:14px 8px; text-align:center; transition:all 0.2s;" onmouseover="this.style.background='rgba(108,92,231,0.15)'" onmouseout="this.style.background='var(--bg-hover)'">
                            <div style="width:38px; height:38px; background:linear-gradient(135deg, #6c5ce7, #a29bfe); border-radius:10px; display:flex; align-items:center; justify-content:center; margin:0 auto 8px; box-shadow:0 3px 10px rgba(108,92,231,0.3);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            </div>
                            <div style="font-size:11px; font-weight:600;">Suivi</div>
                        </div>
                        
                        <!-- Prix Traversette -->
                        <div onclick="navigateTo('prix-traversette')" style="cursor:pointer; background:var(--bg-hover); border-radius:12px; padding:14px 8px; text-align:center; transition:all 0.2s;" onmouseover="this.style.background='rgba(253,203,110,0.15)'" onmouseout="this.style.background='var(--bg-hover)'">
                            <div style="width:38px; height:38px; background:linear-gradient(135deg, #fdcb6e, #f39c12); border-radius:10px; display:flex; align-items:center; justify-content:center; margin:0 auto 8px; box-shadow:0 3px 10px rgba(253,203,110,0.3);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                            </div>
                            <div style="font-size:11px; font-weight:600;">Prix Vente</div>
                        </div>
                        
                        <!-- Prix Fournisseurs -->
                        <div onclick="navigateTo('prix-fournisseurs')" style="cursor:pointer; background:var(--bg-hover); border-radius:12px; padding:14px 8px; text-align:center; transition:all 0.2s;" onmouseover="this.style.background='rgba(231,76,60,0.15)'" onmouseout="this.style.background='var(--bg-hover)'">
                            <div style="width:38px; height:38px; background:linear-gradient(135deg, #e74c3c, #f39c12); border-radius:10px; display:flex; align-items:center; justify-content:center; margin:0 auto 8px; box-shadow:0 3px 10px rgba(231,76,60,0.3);">
                                <span style="font-size:16px;">💰</span>
                            </div>
                            <div style="font-size:11px; font-weight:600;">Fournisseurs</div>
                        </div>
                        
                        <!-- Shop Hub -->
                        <div onclick="navigateTo('shop')" style="cursor:pointer; background:var(--bg-hover); border-radius:12px; padding:14px 8px; text-align:center; transition:all 0.2s;" onmouseover="this.style.background='rgba(150,191,72,0.15)'" onmouseout="this.style.background='var(--bg-hover)'">
                            <div style="width:38px; height:38px; background:linear-gradient(135deg, #96bf48, #5c8e24); border-radius:10px; display:flex; align-items:center; justify-content:center; margin:0 auto 8px; box-shadow:0 3px 10px rgba(150,191,72,0.3);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>
                            </div>
                            <div style="font-size:11px; font-weight:600;">Shop Hub</div>
                        </div>
                        
                        <!-- Rapports -->
                        <div onclick="navigateTo('reports')" style="cursor:pointer; background:var(--bg-hover); border-radius:12px; padding:14px 8px; text-align:center; transition:all 0.2s;" onmouseover="this.style.background='rgba(225,112,85,0.15)'" onmouseout="this.style.background='var(--bg-hover)'">
                            <div style="width:38px; height:38px; background:linear-gradient(135deg, #e17055, #fab1a0); border-radius:10px; display:flex; align-items:center; justify-content:center; margin:0 auto 8px; box-shadow:0 3px 10px rgba(225,112,85,0.3);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                            </div>
                            <div style="font-size:11px; font-weight:600;">Rapports</div>
                        </div>
                        
                        <!-- Paramètres -->
                        <div onclick="navigateTo('settings')" style="cursor:pointer; background:var(--bg-hover); border-radius:12px; padding:14px 8px; text-align:center; transition:all 0.2s;" onmouseover="this.style.background='rgba(99,110,114,0.15)'" onmouseout="this.style.background='var(--bg-hover)'">
                            <div style="width:38px; height:38px; background:linear-gradient(135deg, #636e72, #b2bec3); border-radius:10px; display:flex; align-items:center; justify-content:center; margin:0 auto 8px; box-shadow:0 3px 10px rgba(99,110,114,0.3);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                            </div>
                            <div style="font-size:11px; font-weight:600;">Paramètres</div>
                        </div>
                        
                        <!-- Gestion RH (Admin only) -->
                        <div onclick="navigateTo('rh')" data-permission="admin" style="cursor:pointer; background:var(--bg-hover); border-radius:12px; padding:14px 8px; text-align:center; transition:all 0.2s;" onmouseover="this.style.background='rgba(155,89,182,0.15)'" onmouseout="this.style.background='var(--bg-hover)'">
                            <div style="width:38px; height:38px; background:linear-gradient(135deg, #9b59b6, #8e44ad); border-radius:10px; display:flex; align-items:center; justify-content:center; margin:0 auto 8px; box-shadow:0 3px 10px rgba(155,89,182,0.3);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                            </div>
                            <div style="font-size:11px; font-weight:600;">RH</div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- CA du jour - Bandeau discret -->
                <div onclick="navigateTo('analyses')" style="cursor:pointer; margin-top:16px; background:linear-gradient(135deg, rgba(6,214,160,0.08), rgba(17,138,178,0.05)); border:1px solid rgba(6,214,160,0.2); border-radius:12px; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:18px;">💰</span>
                        <span style="font-size:12px; color:var(--text-muted);">Chiffre d'affaires du jour</span>
                    </div>
                    <div id="summary-ca-today" style="font-size:16px; font-weight:700; color:var(--accent-primary); font-family:'Space Mono',monospace;">0 CHF</div>
                </div>
                
            </div>

            <!-- Analyses Page (ancien Dashboard) -->
            <div class="module-page" id="page-analyses">
                <div style="margin-bottom:16px;">
                    <span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                    <div>
                        <h2 style="font-size:24px; font-weight:700;">📊 Analyses & Statistiques</h2>
                        <p style="color:var(--text-muted);">Données en temps réel de votre activité</p>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <select id="analysis-period" onchange="updateAnalytics()" style="padding:10px 16px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            <option value="7">7 derniers jours</option>
                            <option value="30" selected>30 derniers jours</option>
                            <option value="90">3 mois</option>
                            <option value="365">12 mois</option>
                        </select>
                        <button onclick="updateAnalytics()" class="btn btn-primary" style="padding:10px 20px;">🔄 Actualiser</button>
                    </div>
                </div>

                <!-- KPIs principaux -->
                <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:16px; margin-bottom:24px;">
                    <div style="background:linear-gradient(135deg, var(--accent-primary)20, var(--accent-primary)10); border:2px solid var(--accent-primary); border-radius:16px; padding:20px; text-align:center;">
                        <div style="font-size:32px; font-weight:800; color:var(--accent-primary);" id="kpi-revenue">0</div>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">💰 CA Total (CHF)</div>
                    </div>
                    <div style="background:linear-gradient(135deg, var(--accent-secondary)20, var(--accent-secondary)10); border:2px solid var(--accent-secondary); border-radius:16px; padding:20px; text-align:center;">
                        <div style="font-size:32px; font-weight:800; color:var(--accent-secondary);" id="kpi-orders">0</div>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">📦 Commandes</div>
                    </div>
                    <div style="background:linear-gradient(135deg, var(--accent-warning)20, var(--accent-warning)10); border:2px solid var(--accent-warning); border-radius:16px; padding:20px; text-align:center;">
                        <div style="font-size:32px; font-weight:800; color:var(--accent-warning);" id="kpi-clients">0</div>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">👥 Clients</div>
                    </div>
                    <div style="background:linear-gradient(135deg, #96bf4820, #96bf4810); border:2px solid #96bf48; border-radius:16px; padding:20px; text-align:center;">
                        <div style="font-size:32px; font-weight:800; color:#96bf48;" id="kpi-shopify">0</div>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">🛍️ Shopify</div>
                    </div>
                    <div style="background:linear-gradient(135deg, #9c88ff20, #9c88ff10); border:2px solid #9c88ff; border-radius:16px; padding:20px; text-align:center;">
                        <div style="font-size:32px; font-weight:800; color:#9c88ff;" id="kpi-articles">0</div>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">📦 Articles</div>
                    </div>
                </div>

                <!-- Graphiques principaux -->
                <div style="display:grid; grid-template-columns:2fr 1fr; gap:20px; margin-bottom:24px;">
                    <!-- Courbe CA -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📈 Évolution du Chiffre d'Affaires</h3>
                        </div>
                        <div class="card-body" style="height:300px;">
                            <canvas id="chart-revenue"></canvas>
                        </div>
                    </div>

                    <!-- Camembert Sources -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🎯 Répartition par source</h3>
                        </div>
                        <div class="card-body" style="height:300px;">
                            <canvas id="chart-sources"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Graphiques secondaires -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px;">
                    <!-- Barres Commandes par jour -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📊 Commandes par jour</h3>
                        </div>
                        <div class="card-body" style="height:250px;">
                            <canvas id="chart-orders-day"></canvas>
                        </div>
                    </div>

                    <!-- Top Clients -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🏆 Top 5 Clients</h3>
                        </div>
                        <div class="card-body" style="height:250px;">
                            <canvas id="chart-top-clients"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Tableaux détaillés -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <!-- Dernières commandes -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📋 Dernières commandes</h3>
                        </div>
                        <div class="card-body" style="max-height:350px; overflow-y:auto;">
                            <table style="width:100%;">
                                <thead>
                                    <tr>
                                        <th>N°</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Montant</th>
                                        <th>Source</th>
                                    </tr>
                                </thead>
                                <tbody id="table-recent-orders">
                                    <tr><td colspan="5" style="text-align:center; color:var(--text-muted);">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Statistiques détaillées -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📊 Statistiques détaillées</h3>
                        </div>
                        <div class="card-body">
                            <div id="stats-details">
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                    <div style="padding:16px; background:var(--bg-primary); border-radius:10px;">
                                        <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase;">Panier moyen</div>
                                        <div style="font-size:24px; font-weight:700; color:var(--accent-primary);" id="stat-avg-basket">0 CHF</div>
                                    </div>
                                    <div style="padding:16px; background:var(--bg-primary); border-radius:10px;">
                                        <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase;">Clients B2B</div>
                                        <div style="font-size:24px; font-weight:700; color:var(--accent-secondary);" id="stat-b2b">0</div>
                                    </div>
                                    <div style="padding:16px; background:var(--bg-primary); border-radius:10px;">
                                        <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase;">Clients B2C</div>
                                        <div style="font-size:24px; font-weight:700; color:var(--accent-warning);" id="stat-b2c">0</div>
                                    </div>
                                    <div style="padding:16px; background:var(--bg-primary); border-radius:10px;">
                                        <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase;">Cmd/jour (moy)</div>
                                        <div style="font-size:24px; font-weight:700; color:#9c88ff;" id="stat-orders-day">0</div>
                                    </div>
                                </div>

                                <div style="margin-top:16px; padding:16px; background:linear-gradient(135deg, var(--accent-primary)10, var(--accent-secondary)10); border-radius:10px; border-left:4px solid var(--accent-primary);">
                                    <div style="font-weight:700; color:var(--accent-primary); margin-bottom:8px;">📈 Tendance</div>
                                    <div id="stat-trend" style="font-size:13px; color:var(--text-secondary);">
                                        Analyse en cours...
                                    </div>
                                </div>

                                <!-- Répartition Shopify -->
                                <div style="margin-top:16px; padding:16px; background:var(--bg-primary); border-radius:10px;">
                                    <div style="font-weight:700; color:#96bf48; margin-bottom:12px;">🛍️ Shopify - Détails</div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px;">
                                        <div style="display:flex; justify-content:space-between;">
                                            <span style="color:var(--text-muted);">À traiter:</span>
                                            <span style="font-weight:600; color:var(--accent-danger);" id="stat-shopify-urgent">0</span>
                                        </div>
                                        <div style="display:flex; justify-content:space-between;">
                                            <span style="color:var(--text-muted);">En attente:</span>
                                            <span style="font-weight:600; color:var(--accent-warning);" id="stat-shopify-pending">0</span>
                                        </div>
                                        <div style="display:flex; justify-content:space-between;">
                                            <span style="color:var(--text-muted);">Traitées:</span>
                                            <span style="font-weight:600; color:var(--accent-secondary);" id="stat-shopify-done">0</span>
                                        </div>
                                        <div style="display:flex; justify-content:space-between;">
                                            <span style="color:var(--text-muted);">CA Shopify:</span>
                                            <span style="font-weight:600; color:#96bf48;" id="stat-shopify-revenue">0 CHF</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Page -->
            <div class="module-page" id="page-orders">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span></div>

                <h2 style="font-size:24px; font-weight:700; margin-bottom:20px;">📋 Commandes en cours</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue">⏳</div>
                        </div>
                        <div class="stat-value" id="orders-stat-pending">0</div>
                        <div class="stat-label">En attente</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon yellow">🔄</div>
                        </div>
                        <div class="stat-value" id="orders-stat-preparing">0</div>
                        <div class="stat-label">En préparation</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green">✅</div>
                        </div>
                        <div class="stat-value" id="orders-stat-ready">0</div>
                        <div class="stat-label">Prêtes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background:var(--accent-primary)20; color:var(--accent-primary);">📦</div>
                        </div>
                        <div class="stat-value" id="orders-stat-total">0</div>
                        <div class="stat-label">Total ce mois</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Liste des commandes</h3>
                        <div style="display:flex; gap:12px;">
                            <select id="orders-filter-status" onchange="renderOrdersTable()" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-card); color:var(--text-primary);">
                                <option value="">Tous les statuts</option>
                                <option value="pending">⏳ En attente</option>
                                <option value="preparing">🔄 En préparation</option>
                                <option value="ready">✅ Prête</option>
                                <option value="delivered">📦 Livrée</option>
                            </select>
                            <button class="btn btn-primary" onclick="navigateTo('quickorder')">
                                ⚡ Nouvelle commande
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>N° Commande</th>
                                    <th>Client</th>
                                    <th>Date / Créé par</th>
                                    <th>Articles</th>
                                    <th>Total TTC</th>
                                    <th>Statut</th>
                                    <th>Changer</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-tbody">
                                <tr><td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">Aucune commande</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tracking Page -->
            <div class="module-page" id="page-tracking">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span></div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                    <div>
                        <h2 style="font-size:24px; font-weight:700;">📍 Suivi des Commandes</h2>
                        <p style="color:var(--text-muted);">Gérez vos livraisons et retraits en temps réel</p>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <select id="tracking-source-filter" onchange="updateTrackingView()" style="padding:10px 16px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            <option value="all">🔄 Toutes les sources</option>
                            <option value="quickorder">⚡ QuickOrder</option>
                            <option value="shopify">🛍️ Shopify</option>
                            <option value="myfish">🐟 MyFish</option>
                        </select>
                        <button onclick="updateTrackingView()" class="btn btn-primary" style="padding:10px 20px;">🔄 Actualiser</button>
                    </div>
                </div>

                <!-- KPIs Suivi -->
                <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:16px; margin-bottom:24px;">
                    <div style="background:linear-gradient(135deg, #ffd16620, #ffd16610); border:2px solid #ffd166; border-radius:16px; padding:20px; text-align:center;">
                        <div style="font-size:36px; font-weight:800; color:#ffd166;" id="tracking-pending">0</div>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">⏳ En attente</div>
                    </div>
                    <div style="background:linear-gradient(135deg, #118ab220, #118ab210); border:2px solid #118ab2; border-radius:16px; padding:20px; text-align:center;">
                        <div style="font-size:36px; font-weight:800; color:#118ab2;" id="tracking-preparing">0</div>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">🔧 En préparation</div>
                    </div>
                    <div style="background:linear-gradient(135deg, #9c88ff20, #9c88ff10); border:2px solid #9c88ff; border-radius:16px; padding:20px; text-align:center;">
                        <div style="font-size:36px; font-weight:800; color:#9c88ff;" id="tracking-ready">0</div>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">📦 Prêt</div>
                    </div>
                    <div style="background:linear-gradient(135deg, #06d6a020, #06d6a010); border:2px solid #06d6a0; border-radius:16px; padding:20px; text-align:center;">
                        <div style="font-size:36px; font-weight:800; color:#06d6a0;" id="tracking-delivered">0</div>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">✅ Livré</div>
                    </div>
                    <div style="background:linear-gradient(135deg, #ff6b6b20, #ff6b6b10); border:2px solid #ff6b6b; border-radius:16px; padding:20px; text-align:center;">
                        <div style="font-size:36px; font-weight:800; color:#ff6b6b;" id="tracking-today">0</div>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">📅 Aujourd'hui</div>
                    </div>
                </div>

                <!-- Pipeline visuel -->
                <div class="card" style="margin-bottom:24px;">
                    <div class="card-header">
                        <h3 class="card-title">🔄 Pipeline des commandes</h3>
                        <div style="display:flex; gap:8px;">
                            <span style="font-size:11px; color:var(--text-muted);">Glissez pour changer le statut</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:16px; min-height:300px;">
                            <!-- Colonne En attente -->
                            <div style="background:var(--bg-primary); border-radius:12px; padding:12px;">
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #ffd166;">
                                    <span style="font-size:18px;">⏳</span>
                                    <span style="font-weight:700; color:#ffd166;">En attente</span>
                                    <span id="pipeline-pending-count" style="margin-left:auto; background:#ffd16630; color:#ffd166; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:700;">0</span>
                                </div>
                                <div id="pipeline-pending" style="display:flex; flex-direction:column; gap:8px; max-height:400px; overflow-y:auto;">
                                    <!-- Cards will be inserted here -->
                                </div>
                            </div>

                            <!-- Colonne En préparation -->
                            <div style="background:var(--bg-primary); border-radius:12px; padding:12px;">
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #118ab2;">
                                    <span style="font-size:18px;">🔧</span>
                                    <span style="font-weight:700; color:#118ab2;">En préparation</span>
                                    <span id="pipeline-preparing-count" style="margin-left:auto; background:#118ab230; color:#118ab2; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:700;">0</span>
                                </div>
                                <div id="pipeline-preparing" style="display:flex; flex-direction:column; gap:8px; max-height:400px; overflow-y:auto;">
                                </div>
                            </div>

                            <!-- Colonne Prêt -->
                            <div style="background:var(--bg-primary); border-radius:12px; padding:12px;">
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #9c88ff;">
                                    <span style="font-size:18px;">📦</span>
                                    <span style="font-weight:700; color:#9c88ff;">Prêt / Expédié</span>
                                    <span id="pipeline-ready-count" style="margin-left:auto; background:#9c88ff30; color:#9c88ff; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:700;">0</span>
                                </div>
                                <div id="pipeline-ready" style="display:flex; flex-direction:column; gap:8px; max-height:400px; overflow-y:auto;">
                                </div>
                            </div>

                            <!-- Colonne Livré -->
                            <div style="background:var(--bg-primary); border-radius:12px; padding:12px;">
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #06d6a0;">
                                    <span style="font-size:18px;">✅</span>
                                    <span style="font-weight:700; color:#06d6a0;">Livré / Retiré</span>
                                    <span id="pipeline-delivered-count" style="margin-left:auto; background:#06d6a030; color:#06d6a0; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:700;">0</span>
                                </div>
                                <div id="pipeline-delivered" style="display:flex; flex-direction:column; gap:8px; max-height:400px; overflow-y:auto;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendrier et Timeline -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <!-- Calendrier des livraisons -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📅 Calendrier des livraisons</h3>
                            <div style="display:flex; gap:8px;">
                                <button onclick="changeTrackingWeek(-1)" class="btn btn-secondary" style="padding:6px 12px;">◀</button>
                                <span id="tracking-week-label" style="padding:6px 12px; color:var(--text-secondary);">Semaine actuelle</span>
                                <button onclick="changeTrackingWeek(1)" class="btn btn-secondary" style="padding:6px 12px;">▶</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="tracking-calendar" style="display:grid; grid-template-columns:repeat(7, 1fr); gap:8px;">
                                <!-- Calendar days will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Timeline récente -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🕐 Activité récente</h3>
                        </div>
                        <div class="card-body" style="max-height:400px; overflow-y:auto;">
                            <div id="tracking-timeline" class="timeline">
                                <!-- Timeline items will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Liste détaillée -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-header">
                        <h3 class="card-title">📋 Toutes les commandes en cours</h3>
                        <div class="search-box" style="width:300px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                            <input type="text" id="tracking-search" placeholder="Rechercher..." oninput="filterTrackingTable()">
                        </div>
                    </div>
                    <div class="card-body" style="max-height:500px; overflow-y:auto;">
                        <table style="width:100%;">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>N° Commande</th>
                                    <th>Client</th>
                                    <th>Date livraison</th>
                                    <th>Lieu</th>
                                    <th>Montant</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tracking-table-body">
                                <tr><td colspan="8" style="text-align:center; color:var(--text-muted); padding:30px;">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Nutri-Score Page -->
            <div class="module-page" id="page-nutriscore">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('shop')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Shop Hub</span></div>
                <div id="nutrition-root"></div>
            </div>

            <!-- Prix Traversette Page -->
            <div class="module-page" id="page-prix-traversette">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span></div>
                <!-- Config Panel -->
                <div class="prix-config-panel">
                    <div class="prix-config-item">
                        <label>Taux EUR → CHF</label>
                        <input type="number" id="tauxChange" value="0.9350" step="0.0001" min="0">
                    </div>
                    <div class="prix-config-item">
                        <label>TVA Suisse (%)</label>
                        <input type="number" id="tauxTVA" value="2.6" step="0.1" min="0">
                    </div>
                    <div class="prix-config-item">
                        <label>Frais Dédouanement (CHF)</label>
                        <input type="number" id="fraisDedouanement" value="0.00" step="0.01" min="0">
                    </div>
                    <div class="prix-config-item">
                        <label>Total Pièces Achetées</label>
                        <div class="prix-config-value" id="totalPieces">496</div>
                    </div>
                    <div class="prix-config-item">
                        <label>Frais / Pièce (CHF)</label>
                        <div class="prix-config-value" id="fraisParPiece">0.00</div>
                    </div>
                    <div class="prix-config-item">
                        <label>Marge / Pourcentage (%)</label>
                        <input type="number" id="pourcentageMarge" value="0" step="0.1" min="0">
                    </div>
                </div>

                <!-- Search -->
                <div class="prix-search-container">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="text" id="prixSearchInput" placeholder="Rechercher par code EAN, désignation ou N° article...">
                    <span class="prix-search-stats" id="prixSearchStats">41 produits</span>
                </div>

                <!-- Table -->
                <div class="card" style="overflow: hidden;">
                    <div class="prix-table-wrapper">
                        <table class="prix-table">
                            <thead>
                                <tr>
                                    <th class="prix-check-col">✓</th>
                                    <th class="prix-num">#</th>
                                    <th>N° Art</th>
                                    <th>Désignation</th>
                                    <th>Qté</th>
                                    <th>PU HT €</th>
                                    <th>PU CHF</th>
                                    <th>+Frais</th>
                                    <th>+Marge%</th>
                                    <th>+TVA</th>
                                    <th>Prix Final</th>
                                    <th>Code EAN</th>
                                </tr>
                            </thead>
                            <tbody id="prixProductTable">
                                <!-- Products will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Summary -->
                <div class="prix-summary-grid">
                    <div class="prix-summary-card">
                        <div class="prix-summary-label">Total Produits</div>
                        <div class="prix-summary-value" id="prixSumProducts">41</div>
                    </div>
                    <div class="prix-summary-card">
                        <div class="prix-summary-label">Total Pièces</div>
                        <div class="prix-summary-value" id="prixSumQty">496</div>
                    </div>
                    <div class="prix-summary-card">
                        <div class="prix-summary-label">Total HT EUR</div>
                        <div class="prix-summary-value" id="prixSumEur">€ 0.00</div>
                    </div>
                    <div class="prix-summary-card highlight">
                        <div class="prix-summary-label">Total CHF (avec frais)</div>
                        <div class="prix-summary-value" id="prixSumChf">CHF 0.00</div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="prix-actions">
                    <button class="btn btn-primary" onclick="exportPrixData()">📥 Exporter CSV</button>
                    <button class="btn btn-secondary" onclick="window.print()">🖨️ Imprimer</button>
                    <button class="btn btn-secondary" onclick="savePrixEanCodes()">💾 Sauvegarder EAN</button>
                </div>
            </div>

            <!-- Cours Poissons Frais Page -->
            <div class="module-page" id="page-cours-poissons">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span></div>

                <!-- Header -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:12px;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="width:50px; height:50px; background:linear-gradient(135deg, #00cec9, #81ecec); border-radius:14px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 15px rgba(0,206,201,0.3);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="white">
                                <path d="M12 2C7 2 3 5 3 9c0 3 2.5 5.5 6 6.5V22l3-3 3 3v-6.5c3.5-1 6-3.5 6-6.5 0-4-4-7-9-7zm-2 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 style="font-size:22px; font-weight:700; margin:0;">Cours Poissons Frais</h2>
                            <p style="color:var(--text-muted); font-size:12px; margin:0;">Gestion des tarifs et marges</p>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn" onclick="CPF.showImportFromPFModal()" style="padding:10px 14px; background:linear-gradient(135deg, #f39c12, #e74c3c); color:#fff; border:none; border-radius:10px; font-weight:600; cursor:pointer;">
                            🔄 Sync Prix Fournisseurs
                        </button>
                        <button class="btn btn-secondary" onclick="CPF.importExcel()" style="padding:10px 14px;">
                            📥 Importer
                        </button>
                        <button class="btn btn-secondary" onclick="CPF.exportExcel()" style="padding:10px 14px;">
                            📤 Exporter
                        </button>
                        <button class="btn btn-primary" onclick="CPF.showAddModal()" style="padding:10px 16px;">
                            ➕ Nouveau produit
                        </button>
                        <input type="file" id="cpf-file-input" accept=".xlsx,.xls,.csv" style="display:none;" onchange="CPF.handleFileImport(event)">
                    </div>
                </div>

                <!-- Onglets -->
                <div style="display:flex; gap:4px; margin-bottom:20px; background:var(--bg-card); padding:4px; border-radius:12px; border:1px solid var(--border-color);">
                    <button onclick="CPF.switchTab('catalogue')" id="cpf-tab-catalogue" class="cpf-tab active" style="flex:1; padding:12px; border:none; background:var(--accent-primary); color:white; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.2s;">
                        📦 Catalogue
                    </button>
                    <button onclick="CPF.switchTab('favoris')" id="cpf-tab-favoris" class="cpf-tab" style="flex:1; padding:12px; border:none; background:transparent; color:var(--text-muted); border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.2s;">
                        ⭐ Favoris <span id="cpf-fav-count" style="background:var(--accent-warning); color:#000; padding:2px 8px; border-radius:10px; font-size:11px; margin-left:4px;">0</span>
                    </button>
                    <button onclick="CPF.switchTab('historique')" id="cpf-tab-historique" class="cpf-tab" style="flex:1; padding:12px; border:none; background:transparent; color:var(--text-muted); border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.2s;">
                        📅 Historique
                    </button>
                </div>

                <!-- Stats rapides -->
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:12px; margin-bottom:20px;">
                    <div style="background:var(--bg-card); border-radius:12px; padding:16px; text-align:center; border:1px solid var(--border-color);">
                        <div style="font-size:28px; font-weight:700; color:var(--accent-primary);" id="cpf-stat-total">0</div>
                        <div style="font-size:11px; color:var(--text-muted);">PRODUITS</div>
                    </div>
                    <div style="background:var(--bg-card); border-radius:12px; padding:16px; text-align:center; border:1px solid var(--border-color);">
                        <div style="font-size:28px; font-weight:700; color:var(--accent-warning);" id="cpf-stat-favoris">0</div>
                        <div style="font-size:11px; color:var(--text-muted);">FAVORIS</div>
                    </div>
                    <div style="background:var(--bg-card); border-radius:12px; padding:16px; text-align:center; border:1px solid var(--border-color);">
                        <div style="font-size:28px; font-weight:700; color:var(--accent-secondary);" id="cpf-stat-semaine">-</div>
                        <div style="font-size:11px; color:var(--text-muted);">SEMAINE</div>
                    </div>
                    <div style="background:var(--bg-card); border-radius:12px; padding:16px; text-align:center; border:1px solid var(--border-color);">
                        <div style="font-size:28px; font-weight:700; color:#e17055;" id="cpf-stat-fiches">0</div>
                        <div style="font-size:11px; color:var(--text-muted);">FICHES</div>
                    </div>
                </div>

                <!-- Contenu des onglets -->
                <div id="cpf-content-catalogue">
                    <div class="card">
                        <div class="card-header" style="flex-wrap:wrap; gap:12px;">
                            <h3 class="card-title">📋 Liste des produits</h3>
                            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                <div style="position:relative;">
                                    <input type="text" id="cpf-search" placeholder="🔍 Rechercher..." oninput="CPF.filterProducts()" style="padding:10px 16px; width:220px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <select id="cpf-sort" onchange="CPF.filterProducts()" style="padding:10px 12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                    <option value="name">Tri: Nom A-Z</option>
                                    <option value="name-desc">Tri: Nom Z-A</option>
                                    <option value="code">Tri: Code article</option>
                                    <option value="plu">Tri: PLU</option>
                                    <option value="price">Tri: Prix ↑</option>
                                    <option value="price-desc">Tri: Prix ↓</option>
                                    <option value="origin">Tri: Origine</option>
                                </select>
                                <select id="cpf-filter-origin" onchange="CPF.filterProducts()" style="padding:10px 12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                    <option value="">Toutes origines</option>
                                </select>
                                <button onclick="CPF.printList()" class="btn btn-secondary" style="padding:10px 14px;">🖨️ Imprimer</button>
                            </div>
                        </div>
                        <div style="overflow-x:auto;">
                            <table style="width:100%; border-collapse:collapse; font-size:13px;">
                                <thead>
                                    <tr style="background:var(--bg-hover); border-bottom:2px solid var(--accent-primary);">
                                        <th style="padding:12px 8px; text-align:center; width:40px;">⭐</th>
                                        <th style="padding:12px 8px; text-align:left;">PLU</th>
                                        <th style="padding:12px 8px; text-align:left;">CODE</th>
                                        <th style="padding:12px 8px; text-align:left;">DÉSIGNATION</th>
                                        <th style="padding:12px 8px; text-align:center;">ORIGINE</th>
                                        <th style="padding:12px 8px; text-align:right;">P.A. HT</th>
                                        <th style="padding:12px 8px; text-align:center;">PERTE</th>
                                        <th style="padding:12px 8px; text-align:right;">REVIENT</th>
                                        <th style="padding:12px 8px; text-align:right; color:#fdcb6e;">+30%</th>
                                        <th style="padding:12px 8px; text-align:right; color:#e17055;">+40%</th>
                                        <th style="padding:12px 8px; text-align:right; color:var(--accent-primary); font-weight:700;">PUBLIC</th>
                                        <th style="padding:12px 8px; text-align:center; width:60px;">ACTION</th>
                                    </tr>
                                </thead>
                                <tbody id="cpf-products-tbody">
                                    <!-- Généré dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                        <div id="cpf-no-results" style="display:none; padding:40px; text-align:center; color:var(--text-muted);">
                            <div style="font-size:48px; margin-bottom:12px;">🐟</div>
                            <p>Aucun produit trouvé. Importez un fichier Excel ou ajoutez manuellement.</p>
                        </div>
                    </div>
                </div>

                <!-- Onglet Favoris -->
                <div id="cpf-content-favoris" style="display:none;">
                    <div class="card">
                        <div class="card-header" style="flex-wrap:wrap; gap:12px;">
                            <h3 class="card-title">⭐ Produits favoris</h3>
                            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                <input type="text" id="cpf-search-fav" placeholder="🔍 Rechercher..." oninput="CPF.renderFavorites()" style="padding:10px 16px; width:200px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                <button onclick="CPF.printFavorites()" class="btn btn-secondary" style="padding:10px 14px;">🖨️ Imprimer</button>
                            </div>
                        </div>
                        <div style="overflow-x:auto;">
                            <table style="width:100%; border-collapse:collapse; font-size:13px;">
                                <thead>
                                    <tr style="background:var(--bg-hover); border-bottom:2px solid var(--accent-warning);">
                                        <th style="padding:12px 8px; text-align:center; width:40px;">⭐</th>
                                        <th style="padding:12px 8px; text-align:left;">PLU</th>
                                        <th style="padding:12px 8px; text-align:left;">CODE</th>
                                        <th style="padding:12px 8px; text-align:left;">DÉSIGNATION</th>
                                        <th style="padding:12px 8px; text-align:center;">ORIGINE</th>
                                        <th style="padding:12px 8px; text-align:right;">P.A. HT</th>
                                        <th style="padding:12px 8px; text-align:center;">PERTE</th>
                                        <th style="padding:12px 8px; text-align:right;">REVIENT</th>
                                        <th style="padding:12px 8px; text-align:right; color:#fdcb6e;">+30%</th>
                                        <th style="padding:12px 8px; text-align:right; color:#e17055;">+40%</th>
                                        <th style="padding:12px 8px; text-align:right; color:var(--accent-primary); font-weight:700;">PUBLIC</th>
                                        <th style="padding:12px 8px; text-align:center; width:60px;">ACTION</th>
                                    </tr>
                                </thead>
                                <tbody id="cpf-favorites-tbody">
                                </tbody>
                            </table>
                        </div>
                        <div id="cpf-no-favorites" style="display:none; padding:40px; text-align:center; color:var(--text-muted);">
                            <div style="font-size:48px; margin-bottom:12px;">⭐</div>
                            <p>Aucun favori. Cliquez sur l'étoile d'un produit pour l'ajouter.</p>
                        </div>
                    </div>
                </div>

                <!-- Onglet Historique -->
                <div id="cpf-content-historique" style="display:none;">
                    <div class="card">
                        <div class="card-header" style="flex-wrap:wrap; gap:12px;">
                            <h3 class="card-title">📅 Historique des fiches</h3>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <select id="cpf-history-filter" onchange="CPF.filterHistory()" style="padding:10px 12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                    <option value="all">Toutes les périodes</option>
                                    <option value="week">Cette semaine</option>
                                    <option value="month">Ce mois</option>
                                    <option value="year">Cette année</option>
                                </select>
                                <button onclick="CPF.saveCurrentWeek()" class="btn btn-primary" style="padding:10px 16px;">💾 Sauver semaine actuelle</button>
                            </div>
                        </div>
                        <div id="cpf-history-list" style="padding:16px;">
                            <!-- Liste des fiches historiques -->
                        </div>
                        <div id="cpf-no-history" style="display:none; padding:40px; text-align:center; color:var(--text-muted);">
                            <div style="font-size:48px; margin-bottom:12px;">📁</div>
                            <p>Aucun historique. Sauvegardez votre première fiche de prix.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Édition Produit -->
            <div id="cpf-edit-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); z-index:3000; overflow-y:auto; padding:20px;">
                <div style="background:var(--bg-card); border-radius:16px; max-width:900px; margin:20px auto; overflow:hidden;">
                    <!-- Header modal -->
                    <div style="padding:20px; background:linear-gradient(135deg, #00cec9, #81ecec); display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0; color:white; font-size:18px;" id="cpf-modal-title">🐟 Édition du produit</h3>
                        <button onclick="CPF.closeEditModal()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:36px; height:36px; border-radius:50%; font-size:20px; cursor:pointer;">×</button>
                    </div>

                    <div style="padding:24px;">
                        <!-- Infos principales -->
                        <div style="display:grid; grid-template-columns:1fr 150px; gap:20px; margin-bottom:24px;">
                            <div>
                                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:16px;">
                                    <div>
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">PLU</label>
                                        <input type="text" id="cpf-edit-plu" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">CODE ARTICLE *</label>
                                        <input type="text" id="cpf-edit-code" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);" required>
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">CODE EAN</label>
                                        <input type="text" id="cpf-edit-ean" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);" placeholder="Code-barres">
                                    </div>
                                </div>
                                <div style="margin-bottom:16px;">
                                    <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">DÉSIGNATION *</label>
                                    <input type="text" id="cpf-edit-name" style="width:100%; padding:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); font-size:15px;" required>
                                </div>
                                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;">
                                    <div>
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">ORIGINE</label>
                                        <input type="text" id="cpf-edit-origin" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);" placeholder="CH, FR, IS...">
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">DÉCOUPE</label>
                                        <input type="text" id="cpf-edit-cut" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">CATÉGORIE</label>
                                        <select id="cpf-edit-category" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                            <option value="">Sélectionner</option>
                                            <option value="Filet">Filet</option>
                                            <option value="Dos">Dos</option>
                                            <option value="Entier">Entier</option>
                                            <option value="Pavé">Pavé</option>
                                            <option value="Steak">Steak</option>
                                            <option value="Autre">Autre</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- Photo -->
                            <div style="text-align:center;">
                                <div id="cpf-edit-photo-preview" style="width:140px; height:140px; background:var(--bg-primary); border:2px dashed var(--border-color); border-radius:12px; display:flex; align-items:center; justify-content:center; margin:0 auto 8px; overflow:hidden; cursor:pointer;" onclick="document.getElementById('cpf-edit-photo-input').click()">
                                    <span style="color:var(--text-muted); font-size:12px;">📷 Ajouter photo</span>
                                </div>
                                <input type="file" id="cpf-edit-photo-input" accept="image/*" style="display:none;" onchange="CPF.handlePhotoUpload(event)">
                                <button onclick="CPF.removePhoto()" style="padding:4px 8px; font-size:11px; background:transparent; border:1px solid var(--border-color); border-radius:4px; color:var(--text-muted); cursor:pointer;">Supprimer</button>
                            </div>
                        </div>

                        <!-- Prix et calculs -->
                        <div style="background:var(--bg-primary); border-radius:12px; padding:20px; margin-bottom:20px;">
                            <h4 style="margin:0 0 16px 0; font-size:14px; color:var(--accent-primary);">💰 Prix et marges</h4>
                            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; margin-bottom:16px;">
                                <div>
                                    <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">PRIX ACHAT HT *</label>
                                    <input type="number" step="0.01" id="cpf-edit-price" oninput="CPF.calculatePrices()" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--accent-primary); border-radius:8px; color:var(--accent-primary); font-size:16px; font-weight:700;" required>
                                </div>
                                <div>
                                    <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">PERTE %</label>
                                    <input type="number" step="0.1" id="cpf-edit-loss" value="2.0" oninput="CPF.calculatePrices()" style="width:100%; padding:12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); font-size:16px;">
                                </div>
                                <div>
                                    <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">TVA %</label>
                                    <input type="number" step="0.1" id="cpf-edit-vat" value="2.6" oninput="CPF.calculatePrices()" style="width:100%; padding:12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); font-size:16px;">
                                </div>
                                <div>
                                    <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">PRIX REVIENT</label>
                                    <div id="cpf-calc-revient" style="padding:12px; background:var(--bg-hover); border-radius:8px; font-size:16px; font-weight:700; color:var(--accent-secondary);">0.00 CHF</div>
                                </div>
                            </div>

                            <!-- Grille des marges -->
                            <div style="display:grid; grid-template-columns:repeat(8, 1fr); gap:8px;">
                                <div style="text-align:center; padding:10px; background:var(--bg-card); border-radius:8px;">
                                    <div style="font-size:10px; color:var(--text-muted);">+15%</div>
                                    <div id="cpf-calc-m15" style="font-weight:700; color:#a29bfe;">0.00</div>
                                </div>
                                <div style="text-align:center; padding:10px; background:var(--bg-card); border-radius:8px;">
                                    <div style="font-size:10px; color:var(--text-muted);">+20%</div>
                                    <div id="cpf-calc-m20" style="font-weight:700; color:#74b9ff;">0.00</div>
                                </div>
                                <div style="text-align:center; padding:10px; background:var(--bg-card); border-radius:8px;">
                                    <div style="font-size:10px; color:var(--text-muted);">+25%</div>
                                    <div id="cpf-calc-m25" style="font-weight:700; color:#55efc4;">0.00</div>
                                </div>
                                <div style="text-align:center; padding:10px; background:var(--bg-card); border-radius:8px; border:1px solid var(--accent-primary);">
                                    <div style="font-size:10px; color:var(--text-muted);">+30% RESTO</div>
                                    <div id="cpf-calc-m30" style="font-weight:700; color:var(--accent-primary);">0.00</div>
                                </div>
                                <div style="text-align:center; padding:10px; background:var(--bg-card); border-radius:8px;">
                                    <div style="font-size:10px; color:var(--text-muted);">+40%</div>
                                    <div id="cpf-calc-m40" style="font-weight:700; color:#fdcb6e;">0.00</div>
                                </div>
                                <div style="text-align:center; padding:10px; background:var(--bg-card); border-radius:8px;">
                                    <div style="font-size:10px; color:var(--text-muted);">+50%</div>
                                    <div id="cpf-calc-m50" style="font-weight:700; color:#fab1a0;">0.00</div>
                                </div>
                                <div style="text-align:center; padding:10px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius:8px;">
                                    <div style="font-size:10px; color:rgba(255,255,255,0.8);">+100% PUBLIC</div>
                                    <div id="cpf-calc-m100" style="font-weight:700; color:white; font-size:16px;">0.00</div>
                                </div>
                                <div style="text-align:center; padding:10px; background:var(--accent-warning); border-radius:8px;">
                                    <div style="font-size:10px; color:rgba(0,0,0,0.6);">TTC 2.6%</div>
                                    <div id="cpf-calc-ttc" style="font-weight:700; color:#000; font-size:16px;">0.00</div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div style="margin-bottom:20px;">
                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">NOTES / INFORMATIONS COMPLÉMENTAIRES</label>
                            <textarea id="cpf-edit-notes" rows="3" style="width:100%; padding:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); resize:vertical;" placeholder="Allergènes, fournisseur, remarques..."></textarea>
                        </div>

                        <!-- Actions -->
                        <div style="display:flex; justify-content:space-between; gap:12px;">
                            <button onclick="CPF.deleteProduct()" id="cpf-delete-btn" style="padding:12px 20px; background:rgba(239,71,111,0.15); border:1px solid var(--accent-danger); border-radius:8px; color:var(--accent-danger); cursor:pointer; display:none;">
                                🗑️ Supprimer
                            </button>
                            <div style="display:flex; gap:12px; margin-left:auto;">
                                <button onclick="CPF.closeEditModal()" style="padding:12px 24px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); cursor:pointer;">
                                    Annuler
                                </button>
                                <button onclick="CPF.saveProduct()" class="btn btn-primary" style="padding:12px 32px;">
                                    💾 Enregistrer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =============================================
                 PRIX FOURNISSEURS - Gestion des prix d'achat
                 ============================================= -->
            <div class="module-page" id="page-prix-fournisseurs">
                <div style="margin-bottom:12px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:12px; display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:16px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span></div>

                <!-- Header -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:12px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:48px; height:48px; background:linear-gradient(135deg, #f39c12, #e74c3c); border-radius:14px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(243,156,18,0.3);">
                            <span style="font-size:24px;">💰</span>
                        </div>
                        <div>
                            <h1 style="font-size:20px; font-weight:700; margin:0;">Prix Fournisseurs</h1>
                            <p style="color:var(--text-muted); font-size:12px; margin:0;">Comparaison & Commandes</p>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                        <button onclick="showPFImportModal()" style="padding:10px 16px; background:var(--bg-card); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px;">
                            📥 Import
                        </button>
                        <button onclick="showPFOrderModal()" style="padding:10px 20px; background:var(--accent-secondary); color:#fff; border:none; border-radius:10px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:8px; position:relative;">
                            🛒 Panier
                            <span id="pf-cart-badge" style="display:none; position:absolute; top:-8px; right:-8px; background:#e74c3c; color:#fff; font-size:11px; font-weight:700; min-width:20px; height:20px; border-radius:50%; align-items:center; justify-content:center;">0</span>
                        </button>
                    </div>
                </div>

                <!-- Onglets -->
                <div style="display:flex; gap:6px; margin-bottom:16px; overflow-x:auto; padding-bottom:4px;">
                    <button class="pf-tab active" onclick="switchPFTab('catalogue')" id="pf-tab-catalogue" style="padding:10px 18px; background:var(--accent-primary); color:#000; border:none; border-radius:8px; font-weight:600; cursor:pointer; white-space:nowrap;">📋 Catalogue</button>
                    <button class="pf-tab" onclick="switchPFTab('fournisseurs')" id="pf-tab-fournisseurs" style="padding:10px 18px; background:var(--bg-card); color:var(--text-primary); border:1px solid var(--border-color); border-radius:8px; font-weight:600; cursor:pointer; white-space:nowrap;">🏭 Fournisseurs</button>
                    <button class="pf-tab" onclick="switchPFTab('commandes')" id="pf-tab-commandes" style="padding:10px 18px; background:var(--bg-card); color:var(--text-primary); border:1px solid var(--border-color); border-radius:8px; font-weight:600; cursor:pointer; white-space:nowrap;">📦 Commandes</button>
                    <button class="pf-tab" onclick="switchPFTab('historique')" id="pf-tab-historique" style="padding:10px 18px; background:var(--bg-card); color:var(--text-primary); border:1px solid var(--border-color); border-radius:8px; font-weight:600; cursor:pointer; white-space:nowrap;">📈 Historique</button>
                </div>

                <!-- Contenu onglet Catalogue -->
                <div id="pf-content-catalogue" class="pf-content">
                    <!-- Barre de recherche -->
                    <div style="display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap;">
                        <input type="text" id="pf-search" placeholder="🔍 Rechercher un produit..." oninput="filterPFCatalogue()" style="flex:1; min-width:200px; padding:12px 16px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; color:var(--text-primary); font-size:14px;">
                        <select id="pf-filter-supplier" onchange="filterPFCatalogue()" style="padding:12px 16px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; color:var(--text-primary); font-size:14px;">
                            <option value="">Tous les fournisseurs</option>
                        </select>
                        <select id="pf-filter-category" onchange="filterPFCatalogue()" style="padding:12px 16px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; color:var(--text-primary); font-size:14px;">
                            <option value="">Toutes catégories</option>
                            <option value="poisson">Poissons</option>
                            <option value="crustace">Crustacés</option>
                            <option value="coquillage">Coquillages</option>
                            <option value="fume">Fumés</option>
                            <option value="autre">Autres</option>
                        </select>
                    </div>

                    <!-- Stats rapides -->
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-bottom:16px;">
                        <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; padding:12px; text-align:center;">
                            <div style="font-size:22px; font-weight:700; color:var(--accent-primary);" id="pf-stat-products">0</div>
                            <div style="font-size:11px; color:var(--text-muted);">Produits</div>
                        </div>
                        <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; padding:12px; text-align:center;">
                            <div style="font-size:22px; font-weight:700; color:var(--accent-secondary);" id="pf-stat-suppliers">0</div>
                            <div style="font-size:11px; color:var(--text-muted);">Fournisseurs</div>
                        </div>
                        <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; padding:12px; text-align:center;">
                            <div style="font-size:22px; font-weight:700; color:var(--accent-warning);" id="pf-stat-updates">0</div>
                            <div style="font-size:11px; color:var(--text-muted);">Màj cette sem.</div>
                        </div>
                        <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; padding:12px; text-align:center;">
                            <div style="font-size:22px; font-weight:700; color:#e74c3c;" id="pf-stat-pending">0</div>
                            <div style="font-size:11px; color:var(--text-muted);">Cmd en cours</div>
                        </div>
                    </div>

                    <!-- Tableau des produits -->
                    <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; overflow:hidden;">
                        <div style="overflow-x:auto;">
                            <table style="width:100%; border-collapse:collapse; font-size:13px;">
                                <thead>
                                    <tr style="background:var(--bg-primary); border-bottom:1px solid var(--border-color);">
                                        <th style="padding:12px 10px; text-align:left; font-weight:600; color:var(--text-muted); font-size:11px;">PRODUIT</th>
                                        <th style="padding:12px 10px; text-align:left; font-weight:600; color:var(--text-muted); font-size:11px;">ORIGINE</th>
                                        <th style="padding:12px 10px; text-align:right; font-weight:600; color:var(--text-muted); font-size:11px;">PRIX HT</th>
                                        <th style="padding:12px 10px; text-align:center; font-weight:600; color:var(--text-muted); font-size:11px;">FOURNISSEUR</th>
                                        <th style="padding:12px 10px; text-align:center; font-weight:600; color:var(--text-muted); font-size:11px;">ÉVOLUTION</th>
                                        <th style="padding:12px 10px; text-align:center; font-weight:600; color:var(--text-muted); font-size:11px;">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody id="pf-catalogue-tbody">
                                    <tr><td colspan="6" style="padding:40px; text-align:center; color:var(--text-muted);">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Contenu onglet Fournisseurs -->
                <div id="pf-content-fournisseurs" class="pf-content" style="display:none;">
                    <div style="display:flex; justify-content:flex-end; margin-bottom:16px;">
                        <button onclick="showPFAddSupplierModal()" style="padding:10px 16px; background:var(--accent-primary); color:#000; border:none; border-radius:10px; font-weight:600; cursor:pointer;">+ Ajouter Fournisseur</button>
                    </div>
                    <div id="pf-suppliers-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:12px;">
                        <!-- Fournisseurs générés dynamiquement -->
                    </div>
                </div>

                <!-- Contenu onglet Commandes -->
                <div id="pf-content-commandes" class="pf-content" style="display:none;">
                    <div style="display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap;">
                        <select id="pf-orders-filter-status" onchange="filterPFOrders()" style="padding:10px 14px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            <option value="">Tous les statuts</option>
                            <option value="draft">Brouillon</option>
                            <option value="sent">Envoyée</option>
                            <option value="confirmed">Confirmée</option>
                            <option value="received">Reçue</option>
                        </select>
                        <select id="pf-orders-filter-supplier" onchange="filterPFOrders()" style="padding:10px 14px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            <option value="">Tous les fournisseurs</option>
                        </select>
                    </div>
                    <div id="pf-orders-list" style="display:flex; flex-direction:column; gap:10px;">
                        <!-- Commandes générées dynamiquement -->
                    </div>
                </div>

                <!-- Contenu onglet Historique -->
                <div id="pf-content-historique" class="pf-content" style="display:none;">
                    <div style="display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap;">
                        <input type="text" id="pf-history-search" placeholder="🔍 Rechercher un produit..." style="flex:1; min-width:200px; padding:10px 14px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                        <select id="pf-history-period" style="padding:10px 14px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            <option value="4">4 dernières semaines</option>
                            <option value="8">8 dernières semaines</option>
                            <option value="12">12 dernières semaines</option>
                        </select>
                    </div>
                    <div id="pf-history-chart" style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; padding:20px; margin-bottom:16px;">
                        <canvas id="pf-price-chart" height="200"></canvas>
                    </div>
                    <div id="pf-history-table" style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; overflow:hidden;">
                        <!-- Tableau historique -->
                    </div>
                </div>
            </div>

            <!-- Modal Import Prix -->
            <div id="pf-import-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center; padding:20px;" onclick="if(event.target === this) closePFImportModal()">
                <div style="background:var(--bg-card); border-radius:16px; max-width:500px; width:100%; max-height:90vh; overflow:auto;">
                    <div style="padding:20px; border-bottom:1px solid var(--border-color);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h2 style="font-size:18px; font-weight:700;">📥 Importer une liste de prix</h2>
                            <button onclick="closePFImportModal()" style="background:none; border:none; color:var(--text-muted); font-size:24px; cursor:pointer;">×</button>
                        </div>
                    </div>
                    <div style="padding:20px;">
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:13px; color:var(--text-muted); margin-bottom:6px;">Fournisseur</label>
                            <select id="pf-import-supplier" style="width:100%; padding:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                <option value="">Sélectionner un fournisseur</option>
                            </select>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:13px; color:var(--text-muted); margin-bottom:6px;">Date de la liste</label>
                            <input type="date" id="pf-import-date" style="width:100%; padding:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:13px; color:var(--text-muted); margin-bottom:6px;">Fichier (CSV, Excel, PDF)</label>
                            <input type="file" id="pf-import-file" accept=".csv,.xlsx,.xls,.pdf" style="width:100%; padding:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                        </div>
                        <div style="background:var(--bg-primary); border-radius:8px; padding:12px; margin-bottom:16px;">
                            <p style="font-size:12px; color:var(--text-muted); margin:0;">💡 Le format attendu: Nom produit, Prix HT, Unité, Origine (optionnel)</p>
                        </div>
                        <button onclick="processPFImport()" style="width:100%; padding:14px; background:var(--accent-primary); color:#000; border:none; border-radius:10px; font-weight:700; font-size:15px; cursor:pointer;">Importer</button>
                    </div>
                </div>
            </div>

            <!-- Modal Nouvelle Commande -->
            <div id="pf-order-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center; padding:20px;" onclick="if(event.target === this) closePFOrderModal()">
                <div style="background:var(--bg-card); border-radius:16px; max-width:800px; width:100%; max-height:90vh; overflow:auto;">
                    <div style="padding:20px; border-bottom:1px solid var(--border-color); background:linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h2 style="font-size:18px; font-weight:700; color:#fff;">🛒 Nouvelle Commande Fournisseur</h2>
                            <button onclick="closePFOrderModal()" style="background:rgba(255,255,255,0.2); border:none; color:#fff; width:32px; height:32px; border-radius:50%; font-size:18px; cursor:pointer;">×</button>
                        </div>
                    </div>
                    <div style="padding:20px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                            <div>
                                <label style="display:block; font-size:13px; color:var(--text-muted); margin-bottom:6px;">Fournisseur *</label>
                                <select id="pf-order-supplier" onchange="loadPFSupplierProducts()" style="width:100%; padding:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                    <option value="">Sélectionner...</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block; font-size:13px; color:var(--text-muted); margin-bottom:6px;">Date de livraison souhaitée</label>
                                <input type="date" id="pf-order-delivery-date" style="width:100%; padding:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            </div>
                        </div>

                        <!-- Recherche produit -->
                        <div style="margin-bottom:16px;">
                            <input type="text" id="pf-order-search" placeholder="🔍 Rechercher un produit à ajouter..." oninput="searchPFOrderProduct()" style="width:100%; padding:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            <div id="pf-order-search-results" style="display:none; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; margin-top:4px; max-height:200px; overflow-y:auto;"></div>
                        </div>

                        <!-- Panier commande -->
                        <div style="background:var(--bg-primary); border-radius:12px; padding:16px; margin-bottom:16px;">
                            <h4 style="font-size:14px; margin-bottom:12px;">📦 Articles commandés</h4>
                            <div id="pf-order-cart" style="max-height:250px; overflow-y:auto;">
                                <p style="color:var(--text-muted); font-size:13px; text-align:center; padding:20px;">Aucun article ajouté</p>
                            </div>
                            <div style="border-top:1px solid var(--border-color); margin-top:12px; padding-top:12px; display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-weight:600;">Total HT estimé:</span>
                                <span id="pf-order-total" style="font-size:20px; font-weight:700; color:var(--accent-primary); font-family:'Space Mono',monospace;">0.00 CHF</span>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:13px; color:var(--text-muted); margin-bottom:6px;">Notes / Instructions</label>
                            <textarea id="pf-order-notes" rows="2" placeholder="Instructions particulières..." style="width:100%; padding:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); resize:vertical;"></textarea>
                        </div>

                        <!-- Actions -->
                        <div style="display:flex; gap:10px;">
                            <button onclick="clearPFCart()" style="padding:14px; background:var(--bg-hover); color:var(--text-muted); border:1px solid var(--border-color); border-radius:10px; font-weight:600; cursor:pointer;">🗑️</button>
                            <button onclick="savePFOrderDraft()" style="flex:1; padding:14px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; font-weight:600; cursor:pointer;">💾 Brouillon</button>
                            <button onclick="confirmPFOrder()" style="flex:2; padding:14px; background:var(--accent-primary); color:#000; border:none; border-radius:10px; font-weight:700; cursor:pointer;">✅ Valider la commande</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Détail Produit -->
            <div id="pf-product-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center; padding:20px;" onclick="if(event.target === this) closePFProductModal()">
                <div style="background:var(--bg-card); border-radius:16px; max-width:600px; width:100%; max-height:90vh; overflow:auto;">
                    <div id="pf-product-modal-content">
                        <!-- Contenu dynamique -->
                    </div>
                </div>
            </div>

            <!-- =============================================
                 MYFISH PRO - Commandes Clients Privés B2C
                 ============================================= -->
            <div class="module-page" id="page-myfish">
                <div style="margin-bottom:12px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:12px; display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:16px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span></div>

                <!-- Header MyFish PRO compact -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:12px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:28px;">🐟</span>
                        <div>
                            <h2 style="font-size:20px; font-weight:700;">MyFish PRO</h2>
                            <p style="color:var(--text-muted); font-size:11px;">Commandes clients</p>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-secondary" onclick="showMFClientsModal()" style="padding:8px 12px; font-size:12px;" title="Clients">👥</button>
                        <button class="btn btn-secondary" onclick="showMFArticlesViewModal()" style="padding:8px 12px; font-size:12px;" title="Articles">📦</button>
                        <button class="btn btn-secondary" onclick="showMFStoresModal()" style="padding:8px 12px; font-size:12px;" title="Magasins">🏪</button>
                        <button class="btn btn-primary" onclick="startMFNewOrder()" style="padding:10px 16px; font-size:14px;">
                            ➕ Nouvelle
                        </button>
                    </div>
                </div>

                <!-- Vue Dashboard (par défaut) -->
                <div id="mf-view-dashboard">
                    <!-- Points de retrait en premier - GRANDE VISIBILITÉ -->
                    <div id="mf-stores-dashboard" style="margin-bottom:20px;">
                        <!-- Généré dynamiquement -->
                    </div>

                    <!-- Stats globales en ligne compacte -->
                    <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;">
                        <div onclick="filterMFOrdersByStatus('')" style="flex:1; min-width:70px; cursor:pointer; background:var(--bg-card); border-radius:10px; padding:10px; text-align:center; border:1px solid var(--border-color);">
                            <div style="font-size:22px; font-weight:700; color:var(--text-primary);" id="mf-stat-total">0</div>
                            <div style="font-size:9px; color:var(--text-muted);">TOTAL</div>
                        </div>
                        <div onclick="filterMFOrdersByStatus('pending')" style="flex:1; min-width:70px; cursor:pointer; background:var(--bg-card); border-radius:10px; padding:10px; text-align:center; border:2px solid #f4a261;">
                            <div style="font-size:22px; font-weight:700; color:#f4a261;" id="mf-stat-pending">0</div>
                            <div style="font-size:9px; color:var(--text-muted);">ATTENTE</div>
                        </div>
                        <div onclick="filterMFOrdersByStatus('confirmed')" style="flex:1; min-width:70px; cursor:pointer; background:var(--bg-card); border-radius:10px; padding:10px; text-align:center; border:2px solid #118ab2;">
                            <div style="font-size:22px; font-weight:700; color:#118ab2;" id="mf-stat-confirmed">0</div>
                            <div style="font-size:9px; color:var(--text-muted);">CONFIRMÉES</div>
                        </div>
                        <div onclick="filterMFOrdersByStatus('ready')" style="flex:1; min-width:70px; cursor:pointer; background:var(--bg-card); border-radius:10px; padding:10px; text-align:center; border:2px solid #06d6a0;">
                            <div style="font-size:22px; font-weight:700; color:#06d6a0;" id="mf-stat-ready">0</div>
                            <div style="font-size:9px; color:var(--text-muted);">PRÊTES</div>
                        </div>
                    </div>

                    <!-- Liste des commandes -->
                    <div class="card">
                        <div class="card-header" style="padding:12px 16px; flex-wrap:wrap; gap:8px;">
                            <h3 class="card-title" style="font-size:14px;">📋 Commandes</h3>
                            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                                <select id="mf-filter-store" onchange="renderMFOrders()" style="padding:6px 10px; font-size:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                    <option value="">Tous magasins</option>
                                </select>
                                <select id="mf-filter-status" onchange="renderMFOrders()" style="padding:6px 10px; font-size:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                    <option value="">Tous statuts</option>
                                    <option value="pending">⏳ En attente</option>
                                    <option value="confirmed">✅ Confirmée</option>
                                    <option value="ready">🎉 Prête</option>
                                    <option value="delivered">🤝 Remise</option>
                                </select>
                                <input type="date" id="mf-filter-date" onchange="renderMFOrders()" style="padding:6px 10px; font-size:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                            </div>
                        </div>
                        <div class="table-container" style="font-size:13px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="padding:8px 6px;">N°</th>
                                        <th style="padding:8px 6px;">Client</th>
                                        <th style="padding:8px 6px;">Lieu</th>
                                        <th style="padding:8px 6px;">Date</th>
                                        <th style="padding:8px 6px;" class="hide-mobile">Heure</th>
                                        <th style="padding:8px 6px;">Total</th>
                                        <th style="padding:8px 6px;">Statut</th>
                                        <th style="padding:8px 6px;">Act.</th>
                                    </tr>
                                </thead>
                                <tbody id="mf-orders-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Vue Nouvelle Commande (5 étapes) -->
                <div id="mf-view-neworder" style="display:none;">
                    <!-- Barre de progression compacte -->
                    <div style="background:var(--bg-card); border-radius:12px; padding:12px 16px; margin-bottom:16px; border:1px solid var(--border-color);">
                        <div style="display:flex; justify-content:space-between; align-items:center; position:relative;">
                            <!-- Ligne de connexion -->
                            <div style="position:absolute; top:50%; left:8%; right:8%; height:2px; background:var(--border-color); z-index:0;"></div>
                            <div id="mf-progress-line" style="position:absolute; top:50%; left:8%; height:2px; background:var(--accent-primary); z-index:1; width:0%; transition:width 0.3s;"></div>

                            <!-- Étapes compactes -->
                            <div class="mf-step active" data-step="1" onclick="goToMFStep(1)" style="z-index:2; text-align:center; cursor:pointer;">
                                <div style="width:36px; height:36px; border-radius:50%; background:var(--accent-primary); color:#000; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; margin:0 auto 4px; transition:all 0.3s;">1</div>
                                <div style="font-size:10px; font-weight:600; color:var(--accent-primary);">Client</div>
                            </div>
                            <div class="mf-step" data-step="2" onclick="goToMFStep(2)" style="z-index:2; text-align:center; cursor:pointer;">
                                <div style="width:36px; height:36px; border-radius:50%; background:var(--bg-hover); color:var(--text-muted); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; margin:0 auto 4px; border:2px solid var(--border-color); transition:all 0.3s;">2</div>
                                <div style="font-size:10px; color:var(--text-muted);">Lieu</div>
                            </div>
                            <div class="mf-step" data-step="3" onclick="goToMFStep(3)" style="z-index:2; text-align:center; cursor:pointer;">
                                <div style="width:36px; height:36px; border-radius:50%; background:var(--bg-hover); color:var(--text-muted); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; margin:0 auto 4px; border:2px solid var(--border-color); transition:all 0.3s;">3</div>
                                <div style="font-size:10px; color:var(--text-muted);">Articles</div>
                            </div>
                            <div class="mf-step" data-step="4" onclick="goToMFStep(4)" style="z-index:2; text-align:center; cursor:pointer;">
                                <div style="width:36px; height:36px; border-radius:50%; background:var(--bg-hover); color:var(--text-muted); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; margin:0 auto 4px; border:2px solid var(--border-color); transition:all 0.3s;">4</div>
                                <div style="font-size:10px; color:var(--text-muted);">Récap</div>
                            </div>
                            <div class="mf-step" data-step="5" onclick="goToMFStep(5)" style="z-index:2; text-align:center; cursor:pointer;">
                                <div style="width:36px; height:36px; border-radius:50%; background:var(--bg-hover); color:var(--text-muted); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; margin:0 auto 4px; border:2px solid var(--border-color); transition:all 0.3s;">5</div>
                                <div style="font-size:10px; color:var(--text-muted);">OK</div>
                            </div>
                        </div>
                    </div>

                    <!-- ÉTAPE 1: Client -->
                    <div id="mf-step-1" class="mf-step-content">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">👤 Client</h3>
                                <button class="btn btn-secondary" onclick="cancelMFOrder()" style="padding:8px 14px;">✕</button>
                            </div>
                            <div class="card-body">
                                <!-- Sélecteur B2B / B2C compact -->
                                <div style="display:flex; gap:8px; margin-bottom:16px;">
                                    <button id="mf-type-b2c" onclick="setMFClientType('B2C')" class="mf-type-btn" style="flex:1; padding:14px 12px; border-radius:12px; border:2px solid var(--accent-primary); background:rgba(6,214,160,0.15); cursor:pointer; transition:all 0.2s;">
                                        <div style="font-size:24px; margin-bottom:4px;">👤</div>
                                        <div style="font-size:14px; font-weight:700; color:var(--accent-primary);">Particulier</div>
                                        <div style="font-size:11px; color:var(--text-muted);">B2C</div>
                                    </button>
                                    <button id="mf-type-b2b" onclick="setMFClientType('B2B')" class="mf-type-btn" style="flex:1; padding:14px 12px; border-radius:12px; border:2px solid var(--border-color); background:var(--bg-primary); cursor:pointer; transition:all 0.2s;">
                                        <div style="font-size:24px; margin-bottom:4px;">🏢</div>
                                        <div style="font-size:14px; font-weight:700; color:var(--text-primary);">Professionnel</div>
                                        <div style="font-size:11px; color:var(--text-muted);">B2B</div>
                                    </button>
                                </div>

                                <!-- Recherche client compact -->
                                <div style="position:relative; margin-bottom:16px;">
                                    <input type="text" id="mf-client-search" placeholder="🔍 Rechercher nom, entreprise, tél..."
                                        style="width:100%; padding:14px 16px; font-size:16px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:10px; color:var(--text-primary);"
                                        oninput="searchMFClients(this.value)" autocomplete="off">
                                    <div id="mf-client-results" style="display:none; position:absolute; top:100%; left:0; right:0; background:var(--bg-card); border:2px solid var(--border-color); border-radius:10px; max-height:250px; overflow-y:auto; z-index:100; margin-top:4px; box-shadow:0 8px 24px rgba(0,0,0,0.3);"></div>
                                </div>

                                <!-- Client sélectionné compact -->
                                <div id="mf-selected-client" style="display:none; padding:14px; background:linear-gradient(135deg, rgba(6,214,160,0.1), rgba(17,138,178,0.1)); border:2px solid var(--accent-primary); border-radius:10px; margin-bottom:16px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                                        <div style="flex:1; min-width:0;">
                                            <h3 id="mf-client-display-name" style="font-size:16px; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></h3>
                                            <p style="color:var(--text-muted); font-size:12px;">
                                                📞 <span id="mf-client-display-phone"></span> •
                                                📧 <span id="mf-client-display-email"></span>
                                            </p>
                                            <p id="mf-client-display-address" style="color:var(--text-muted); font-size:11px; margin-top:2px;"></p>
                                            <p id="mf-client-display-allergies" style="color:var(--accent-danger); font-size:11px; margin-top:2px; display:none;"></p>
                                        </div>
                                        <button class="btn btn-secondary" onclick="clearMFClient()" style="padding:6px 12px; font-size:12px;">✕</button>
                                    </div>
                                </div>

                                <!-- Bouton création rapide -->
                                <div style="text-align:center; margin-bottom:16px;">
                                    <button class="btn btn-secondary" onclick="showMFQuickClientForm()" style="padding:10px 20px; font-size:13px;">
                                        ➕ Nouveau client
                                    </button>
                                </div>

                                <!-- Formulaire création rapide -->
                                <div id="mf-quick-client-form" style="display:none; padding:24px; background:var(--bg-primary); border-radius:16px; border:2px dashed var(--accent-primary);">
                                    <h4 id="mf-form-title" style="color:var(--accent-primary); margin-bottom:20px; display:flex; align-items:center; gap:8px;">
                                        <span>➕</span> Nouveau client particulier
                                    </h4>

                                    <!-- Champs B2B uniquement -->
                                    <div id="mf-b2b-fields" style="display:none; margin-bottom:16px;">
                                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                                            <div style="grid-column:1/-1;">
                                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">🏢 Nom entreprise *</label>
                                                <input type="text" id="mf-new-company" placeholder="Restaurant Le Léman, Boulangerie Müller..." style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--accent-secondary); border-radius:8px; color:var(--text-primary); font-weight:600;">
                                            </div>
                                            <div style="grid-column:1/-1;">
                                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Contact / Responsable</label>
                                                <input type="text" id="mf-new-contact" placeholder="M. Dupont, Mme Martin..." style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Champs B2C (Nom/Prénom) -->
                                    <div id="mf-b2c-fields" style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Nom *</label>
                                            <input type="text" id="mf-new-lastname" placeholder="Dupont" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Prénom *</label>
                                            <input type="text" id="mf-new-firstname" placeholder="Jean" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                    </div>

                                    <!-- Champs communs -->
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                                        <div style="grid-column:1/-1;">
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Adresse</label>
                                            <input type="text" id="mf-new-address" placeholder="Rue de la Gare 12" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">NPA</label>
                                            <input type="text" id="mf-new-zip" placeholder="1000" maxlength="6" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Lieu *</label>
                                            <input type="text" id="mf-new-city" placeholder="Lausanne" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Tél. portable *</label>
                                            <input type="tel" id="mf-new-mobile" placeholder="+41 79 xxx xx xx" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Tél. fixe</label>
                                            <input type="tel" id="mf-new-phone" placeholder="+41 21 xxx xx xx" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div style="grid-column:1/-1;">
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Email</label>
                                            <input type="email" id="mf-new-email" placeholder="jean.dupont@email.ch" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div style="grid-column:1/-1;">
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">⚠️ Allergies</label>
                                            <input type="text" id="mf-new-allergies" placeholder="Crustacés, sulfites..." style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--accent-danger)40; border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div style="grid-column:1/-1;">
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Notes</label>
                                            <textarea id="mf-new-notes" rows="2" placeholder="Notes internes..." style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary); resize:vertical;"></textarea>
                                        </div>
                                    </div>
                                    <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:20px;">
                                        <button class="btn btn-secondary" onclick="hideMFQuickClientForm()">Annuler</button>
                                        <button class="btn btn-primary" onclick="saveMFQuickClient()">💾 Créer et sélectionner</button>
                                    </div>
                                </div>

                                <!-- Bouton suivant -->
                                <div id="mf-step1-next" style="display:none; margin-top:24px; text-align:right;">
                                    <button class="btn btn-primary" onclick="goToMFStep(2)" style="padding:16px 32px; font-size:16px;">
                                        Continuer → Lieu de retrait
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÉTAPE 2: Lieu de retrait -->
                    <div id="mf-step-2" class="mf-step-content" style="display:none;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">📍 Lieu de retrait</h3>
                                <button class="btn btn-secondary" onclick="goToMFStep(1)">← Retour client</button>
                            </div>
                            <div class="card-body">
                                <!-- Récap client -->
                                <div style="padding:12px 16px; background:var(--bg-primary); border-radius:10px; margin-bottom:24px; display:flex; align-items:center; gap:12px;">
                                    <span style="font-size:24px;">👤</span>
                                    <div>
                                        <div id="mf-step2-client" style="font-weight:600;"></div>
                                        <div id="mf-step2-client-phone" style="font-size:12px; color:var(--text-muted);"></div>
                                    </div>
                                </div>

                                <!-- Sélection magasin -->
                                <h4 style="margin-bottom:16px;">Sélectionnez le point de retrait :</h4>
                                <div id="mf-stores-selection" class="grid-2" style="margin-bottom:24px;">
                                    <!-- Généré dynamiquement -->
                                </div>

                                <!-- Date et heure -->
                                <div id="mf-datetime-section" style="display:none; padding:16px; background:var(--bg-primary); border-radius:10px; margin-bottom:20px;">
                                    <h4 style="margin-bottom:12px; color:var(--accent-primary); font-size:14px;">📅 Date et créneau de retrait</h4>

                                    <!-- Date -->
                                    <div style="margin-bottom:16px;">
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Date *</label>
                                        <input type="date" id="mf-pickup-date" onchange="updateMFTimeSlots()" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary); font-size:14px;">
                                    </div>

                                    <!-- Info jour (normal/exceptionnel/fermé) -->
                                    <div id="mf-day-info" style="display:none; padding:10px; border-radius:8px; margin-bottom:12px; font-size:12px;"></div>

                                    <!-- Créneaux horaires -->
                                    <div>
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:8px;">Créneau horaire *</label>
                                        <div id="mf-time-slots" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:8px;">
                                            <!-- Créneaux générés dynamiquement -->
                                        </div>
                                        <input type="hidden" id="mf-pickup-time" value="">
                                    </div>
                                </div>

                                <!-- Boutons navigation -->
                                <div style="display:flex; justify-content:space-between; margin-top:20px;">
                                    <button class="btn btn-secondary" onclick="goToMFStep(1)" style="padding:10px 16px; font-size:13px;">← Client</button>
                                    <button id="mf-step2-next" class="btn btn-primary" onclick="goToMFStep(3)" style="padding:12px 24px; font-size:14px; display:none;">
                                        Articles →
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÉTAPE 3: Articles - Nouveau Design -->
                    <div id="mf-step-3" class="mf-step-content" style="display:none;">
                        <div class="card">
                            <div class="card-header" style="padding:16px;">
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <button class="btn btn-secondary" onclick="goToMFStep(2)" style="padding:8px 14px;">← Lieu</button>
                                    <h3 class="card-title" style="margin:0;">🛒 Commande</h3>
                                </div>
                                <button onclick="openMFArticlesModal()" class="btn btn-primary" style="padding:12px 24px; font-size:15px; display:flex; align-items:center; gap:8px;">
                                    <span style="font-size:20px;">📦</span> Ouvrir catalogue
                                </button>
                            </div>

                            <div class="card-body" style="padding:16px;">
                                <!-- Panier éditable -->
                                <div id="mf-cart-container">
                                    <div id="mf-cart-items-editable">
                                        <div style="text-align:center; padding:60px 20px; color:var(--text-muted);">
                                            <div style="font-size:64px; margin-bottom:16px; opacity:0.3;">📦</div>
                                            <div style="font-size:16px; margin-bottom:8px;">Aucun article dans le panier</div>
                                            <div style="font-size:13px;">Cliquez sur "Ouvrir catalogue" pour ajouter des produits</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Totaux avec TVA -->
                                <div id="mf-cart-totals" style="display:none; margin-top:20px; padding:16px; background:linear-gradient(135deg, var(--accent-primary)10, var(--accent-secondary)10); border-radius:12px; border:2px solid var(--accent-primary);">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px;">
                                        <span>Sous-total HT</span>
                                        <span id="mf-cart-subtotal" style="font-family:'Space Mono',monospace; font-weight:600;">0.00 CHF</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px; color:var(--text-muted);">
                                        <span>TVA (2.6%)</span>
                                        <span id="mf-cart-tva" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; font-size:22px; font-weight:700; color:var(--accent-primary); padding-top:12px; border-top:2px solid var(--accent-primary);">
                                        <span>TOTAL TTC</span>
                                        <span id="mf-cart-total" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                                    </div>
                                </div>

                                <!-- Navigation -->
                                <div style="display:flex; justify-content:space-between; margin-top:20px;">
                                    <button class="btn btn-secondary" onclick="goToMFStep(2)">← Lieu</button>
                                    <button id="mf-step3-next" class="btn btn-primary" onclick="goToMFStep(4)" style="padding:14px 28px; font-size:15px; display:none;">
                                        Récapitulatif →
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MODAL CATALOGUE ARTICLES PLEIN ÉCRAN -->
                    <div id="mf-articles-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg-primary); z-index:3000; overflow:hidden;">
                        <div style="height:100%; display:flex; flex-direction:column;">
                            <!-- Header modal -->
                            <div style="padding:16px; background:var(--bg-card); border-bottom:2px solid var(--accent-primary); display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
                                <div style="display:flex; align-items:center; gap:16px;">
                                    <button onclick="closeMFArticlesModal()" style="padding:10px 16px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); font-size:14px; cursor:pointer;">
                                        ✕ Fermer
                                    </button>
                                    <h2 style="margin:0; font-size:18px;">📦 Catalogue articles</h2>
                                </div>
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <span id="mf-selection-count" style="padding:8px 16px; background:var(--accent-primary)20; border:2px solid var(--accent-primary); border-radius:20px; font-weight:700; color:var(--accent-primary);">
                                        0 sélectionné(s)
                                    </span>
                                    <button onclick="validateMFSelection()" id="mf-validate-selection-btn" class="btn btn-primary" style="padding:12px 24px; font-size:15px; display:none;">
                                        ✓ Valider la sélection
                                    </button>
                                </div>
                            </div>

                            <!-- Barre de recherche -->
                            <div style="padding:16px; background:var(--bg-card); border-bottom:1px solid var(--border-color); flex-shrink:0;">
                                <div style="display:flex; gap:12px; align-items:center; max-width:800px; margin:0 auto;">
                                    <div style="flex:1; position:relative;">
                                        <span style="position:absolute; left:16px; top:50%; transform:translateY(-50%); font-size:20px;">🔍</span>
                                        <input type="text" id="mf-modal-search" placeholder="Rechercher par code, nom, catégorie..."
                                            style="width:100%; padding:14px 14px 14px 50px; font-size:16px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:12px; color:var(--text-primary);"
                                            oninput="filterMFModalArticles()">
                                    </div>
                                    <select id="mf-modal-category" onchange="filterMFModalArticles()" style="padding:14px 20px; font-size:14px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:12px; color:var(--text-primary);">
                                        <option value="">Toutes catégories</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Liste articles tableau -->
                            <div style="flex:1; overflow-y:auto; padding:16px;">
                                <table style="width:100%; border-collapse:collapse;" id="mf-articles-table">
                                    <thead style="position:sticky; top:0; background:var(--bg-card); z-index:10;">
                                        <tr style="border-bottom:2px solid var(--accent-primary);">
                                            <th style="padding:12px 8px; text-align:left; font-size:12px; color:var(--text-muted); width:50px;">SEL</th>
                                            <th style="padding:12px 8px; text-align:left; font-size:12px; color:var(--text-muted); width:100px;">N° ARTICLE</th>
                                            <th style="padding:12px 8px; text-align:left; font-size:12px; color:var(--text-muted);">DÉSIGNATION</th>
                                            <th style="padding:12px 8px; text-align:left; font-size:12px; color:var(--text-muted); width:100px;">CATÉGORIE</th>
                                            <th style="padding:12px 8px; text-align:right; font-size:12px; color:var(--text-muted); width:100px;">PRIX HT</th>
                                            <th style="padding:12px 8px; text-align:center; font-size:12px; color:var(--text-muted); width:80px;">UNITÉ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mf-articles-tbody">
                                        <!-- Généré dynamiquement -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ÉTAPE 4: Récapitulatif -->
                    <div id="mf-step-4" class="mf-step-content" style="display:none;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">📋 Récapitulatif de la commande</h3>
                                <button class="btn btn-secondary" onclick="goToMFStep(3)">← Retour articles</button>
                            </div>
                            <div class="card-body">
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:24px;">
                                    <!-- Infos client -->
                                    <div style="padding:20px; background:var(--bg-primary); border-radius:12px;">
                                        <h4 style="color:var(--accent-primary); margin-bottom:12px;">👤 Client</h4>
                                        <div id="mf-recap-client"></div>
                                    </div>
                                    <!-- Infos retrait -->
                                    <div style="padding:20px; background:var(--bg-primary); border-radius:12px;">
                                        <h4 style="color:var(--accent-primary); margin-bottom:12px;">📍 Retrait</h4>
                                        <div id="mf-recap-pickup"></div>
                                    </div>
                                </div>

                                <!-- Détail articles -->
                                <div style="margin-bottom:24px;">
                                    <h4 style="margin-bottom:12px;">🛒 Articles commandés</h4>
                                    <div id="mf-recap-items" style="background:var(--bg-primary); border-radius:12px; overflow:hidden;"></div>
                                </div>

                                <!-- Totaux avec TVA -->
                                <div style="padding:20px; background:linear-gradient(135deg, rgba(6,214,160,0.1), rgba(17,138,178,0.1)); border-radius:12px; border:2px solid var(--accent-primary);">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                        <span>Sous-total HT</span>
                                        <span id="mf-recap-subtotal" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:var(--text-muted);">
                                        <span>TVA (2.6%)</span>
                                        <span id="mf-recap-tva" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; font-size:24px; font-weight:700; color:var(--accent-primary); padding-top:12px; border-top:2px solid var(--accent-primary);">
                                        <span>TOTAL TTC</span>
                                        <span id="mf-recap-total" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                                    </div>
                                </div>

                                <!-- Notes commande -->
                                <div style="margin-top:24px;">
                                    <label style="display:block; font-size:13px; color:var(--text-muted); margin-bottom:8px;">📝 Notes pour cette commande</label>
                                    <textarea id="mf-order-notes" rows="3" placeholder="Instructions spéciales, remarques..." style="width:100%; padding:14px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:12px; color:var(--text-primary); resize:vertical;"></textarea>
                                </div>

                                <!-- Boutons navigation -->
                                <div style="display:flex; justify-content:space-between; margin-top:24px;">
                                    <button class="btn btn-secondary" onclick="goToMFStep(3)">← Articles</button>
                                    <button class="btn btn-primary" onclick="goToMFStep(5)" style="padding:16px 32px; font-size:16px;">
                                        Continuer → Validation
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÉTAPE 5: Validation -->
                    <div id="mf-step-5" class="mf-step-content" style="display:none;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">✅ Validation et envoi</h3>
                                <button class="btn btn-secondary" onclick="goToMFStep(4)">← Retour récap</button>
                            </div>
                            <div class="card-body">
                                <!-- Résumé final -->
                                <div style="padding:24px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius:16px; color:#000; margin-bottom:24px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
                                        <div>
                                            <div style="font-size:14px; opacity:0.8;">Commande pour</div>
                                            <div id="mf-final-client" style="font-size:24px; font-weight:700;"></div>
                                        </div>
                                        <div style="text-align:right;">
                                            <div style="font-size:14px; opacity:0.8;">Total TTC</div>
                                            <div id="mf-final-total" style="font-size:32px; font-weight:700; font-family:'Space Mono',monospace;"></div>
                                        </div>
                                    </div>
                                    <div style="margin-top:16px; padding-top:16px; border-top:2px solid rgba(0,0,0,0.2);">
                                        <span id="mf-final-pickup" style="font-size:14px;"></span>
                                    </div>
                                </div>

                                <!-- Options d'envoi -->
                                <div style="margin-bottom:24px;">
                                    <h4 style="margin-bottom:16px;">📧 Envoi de confirmation</h4>
                                    <div style="display:flex; flex-direction:column; gap:12px;">
                                        <label style="display:flex; align-items:center; gap:12px; padding:16px; background:var(--bg-primary); border-radius:12px; cursor:pointer; border:2px solid var(--border-color);">
                                            <input type="checkbox" id="mf-send-email" checked style="width:20px; height:20px;">
                                            <div>
                                                <div style="font-weight:600;">Envoyer par email au client</div>
                                                <div id="mf-email-to" style="font-size:13px; color:var(--text-muted);"></div>
                                            </div>
                                        </label>
                                        <label style="display:flex; align-items:center; gap:12px; padding:16px; background:var(--bg-primary); border-radius:12px; cursor:pointer; border:2px solid var(--border-color);">
                                            <input type="checkbox" id="mf-send-copy" checked style="width:20px; height:20px;">
                                            <div>
                                                <div style="font-weight:600;">Copie au magasin</div>
                                                <div id="mf-email-store" style="font-size:13px; color:var(--text-muted);"></div>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <!-- Boutons actions -->
                                <div style="display:flex; gap:16px; flex-wrap:wrap;">
                                    <button class="btn btn-secondary" onclick="goToMFStep(4)" style="flex:1; padding:16px;">
                                        ← Modifier
                                    </button>
                                    <button class="btn btn-secondary" onclick="printMFOrder()" style="flex:1; padding:16px;">
                                        🖨️ Imprimer
                                    </button>
                                    <button class="btn btn-primary" onclick="validateMFOrder()" style="flex:2; padding:16px; font-size:18px;">
                                        ✅ Valider la commande
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Gestion Clients -->
                <div id="mf-clients-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:16px; max-width:1200px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                            <h3>👥 Gestion des clients</h3>
                            <button onclick="closeMFClientsModal()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">&times;</button>
                        </div>
                        <!-- Stats clients -->
                        <div style="padding:16px; display:flex; gap:12px; flex-wrap:wrap; border-bottom:1px solid var(--border-color);">
                            <div id="mf-filter-all" style="flex:1; min-width:120px; padding:12px; background:var(--bg-primary); border-radius:10px; text-align:center; cursor:pointer; border:2px solid var(--accent-primary);" onclick="filterMFClientsType('')">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-primary);" id="mf-clients-total">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">TOUS</div>
                            </div>
                            <div id="mf-filter-b2b" style="flex:1; min-width:120px; padding:12px; background:rgba(17,138,178,0.15); border-radius:10px; text-align:center; cursor:pointer; border:2px solid transparent;" onclick="filterMFClientsType('b2b')">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-secondary);" id="mf-clients-b2b">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">B2B</div>
                            </div>
                            <div id="mf-filter-b2c" style="flex:1; min-width:120px; padding:12px; background:rgba(255,183,77,0.15); border-radius:10px; text-align:center; cursor:pointer; border:2px solid transparent;" onclick="filterMFClientsType('b2c')">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-warning);" id="mf-clients-b2c">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">B2C</div>
                            </div>
                        </div>
                        <div style="padding:16px; border-bottom:1px solid var(--border-color); display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                            <input type="text" id="mf-clients-filter" placeholder="🔍 Rechercher nom, téléphone, ville..." oninput="filterMFClientsTable()" style="flex:1; min-width:200px; padding:10px 16px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            <select id="mf-clients-type-filter" onchange="filterMFClientsTable()" style="padding:10px 16px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                <option value="">Tous les types</option>
                                <option value="b2b">🏢 B2B</option>
                                <option value="b2c">🏠 B2C</option>
                            </select>
                            <button class="btn btn-primary" onclick="showMFClientForm()">➕ Nouveau client</button>
                        </div>
                        <div style="flex:1; overflow-y:auto; padding:16px;">
                            <table style="width:100%;">
                                <thead><tr><th>Type</th><th>Nom / Société</th><th>Contact</th><th>Téléphone</th><th>Email</th><th>Ville</th><th>Actif</th><th>Actions</th></tr></thead>
                                <tbody id="mf-clients-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Modal Formulaire Client -->
                <div id="mf-client-form-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2100; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:16px; max-width:650px; width:100%; max-height:90vh; overflow-y:auto;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;">
                            <h3 id="mf-client-form-title">Client</h3>
                            <button onclick="closeMFClientForm()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">&times;</button>
                        </div>
                        <div style="padding:20px;">
                            <input type="hidden" id="mf-edit-client-id">

                            <!-- Sélecteur Type B2B / B2C -->
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                                <div id="mf-edit-type-b2b" onclick="setMFEditClientType('b2b')" style="padding:16px; background:var(--bg-primary); border:3px solid var(--border-color); border-radius:12px; text-align:center; cursor:pointer; transition:all 0.2s;">
                                    <div style="font-size:28px; margin-bottom:4px;">🏢</div>
                                    <div style="font-weight:700; color:var(--accent-secondary);">Professionnel</div>
                                    <div style="font-size:11px; color:var(--text-muted);">B2B</div>
                                </div>
                                <div id="mf-edit-type-b2c" onclick="setMFEditClientType('b2c')" style="padding:16px; background:rgba(255,183,77,0.15); border:3px solid var(--accent-warning); border-radius:12px; text-align:center; cursor:pointer; transition:all 0.2s;">
                                    <div style="font-size:28px; margin-bottom:4px;">🏠</div>
                                    <div style="font-weight:700; color:var(--accent-warning);">Particulier</div>
                                    <div style="font-size:11px; color:var(--text-muted);">B2C</div>
                                </div>
                            </div>
                            <input type="hidden" id="mf-edit-client-type" value="b2c">

                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                                <!-- Champs B2B (société) -->
                                <div id="mf-edit-field-company" style="display:none; grid-column:1/-1;">
                                    <label style="display:block; font-size:12px; color:var(--accent-secondary); margin-bottom:6px; font-weight:600;">🏢 Nom de la société *</label>
                                    <input type="text" id="mf-edit-company" placeholder="Ex: Restaurant du Lac SA" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--accent-secondary); border-radius:8px; color:var(--text-primary);">
                                </div>

                                <!-- Champs B2C (nom/prénom) ou Contact B2B -->
                                <div id="mf-edit-field-lastname">
                                    <label id="mf-edit-label-lastname" style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Nom *</label>
                                    <input type="text" id="mf-edit-lastname" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div id="mf-edit-field-firstname">
                                    <label id="mf-edit-label-firstname" style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Prénom</label>
                                    <input type="text" id="mf-edit-firstname" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>

                                <div style="grid-column:1/-1;">
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Adresse</label>
                                    <input type="text" id="mf-edit-address" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">NPA</label>
                                    <input type="text" id="mf-edit-zip" maxlength="6" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Lieu *</label>
                                    <input type="text" id="mf-edit-city" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Tél. portable *</label>
                                    <input type="tel" id="mf-edit-mobile" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Tél. fixe</label>
                                    <input type="tel" id="mf-edit-phone" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div style="grid-column:1/-1;">
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Email</label>
                                    <input type="email" id="mf-edit-email" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div style="grid-column:1/-1;">
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">⚠️ Allergies</label>
                                    <input type="text" id="mf-edit-allergies" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--accent-danger)40; border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div style="grid-column:1/-1;">
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Notes</label>
                                    <textarea id="mf-edit-notes" rows="2" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary); resize:vertical;"></textarea>
                                </div>
                                <div style="grid-column:1/-1;">
                                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                        <input type="checkbox" id="mf-edit-active" checked style="width:20px; height:20px;">
                                        <span>Client actif</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div style="padding:16px 20px; border-top:1px solid var(--border-color); display:flex; justify-content:flex-end; gap:12px;">
                            <button class="btn btn-secondary" onclick="closeMFClientForm()">Annuler</button>
                            <button class="btn btn-primary" onclick="saveMFClient()">💾 Enregistrer</button>
                        </div>
                    </div>
                </div>

                <!-- Modal Consultation Articles (depuis dashboard) -->
                <div id="mf-articles-view-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:16px; max-width:1200px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                            <h3>📦 Articles disponibles</h3>
                            <button onclick="closeMFArticlesViewModal()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">&times;</button>
                        </div>
                        <!-- Stats articles -->
                        <div style="padding:16px; display:flex; gap:12px; flex-wrap:wrap; border-bottom:1px solid var(--border-color);">
                            <div style="flex:1; min-width:120px; padding:12px; background:var(--bg-primary); border-radius:10px; text-align:center;">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-primary);" id="mf-view-articles-total">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">TOTAL</div>
                            </div>
                            <div style="flex:1; min-width:120px; padding:12px; background:rgba(6,214,160,0.15); border-radius:10px; text-align:center;">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-primary);" id="mf-view-articles-active">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">ACTIFS</div>
                            </div>
                        </div>
                        <div style="padding:16px; border-bottom:1px solid var(--border-color); display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                            <input type="text" id="mf-view-articles-filter" placeholder="🔍 Rechercher code, nom, catégorie..." oninput="filterMFViewArticlesTable()" style="flex:1; min-width:200px; padding:10px 16px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            <select id="mf-view-articles-cat-filter" onchange="filterMFViewArticlesTable()" style="padding:10px 16px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                <option value="">Toutes catégories</option>
                            </select>
                            <a href="#" onclick="navigateTo('articles'); closeMFArticlesViewModal(); return false;" class="btn btn-secondary" style="text-decoration:none;">⚙️ Gérer dans Outils</a>
                        </div>
                        <div style="flex:1; overflow-y:auto; padding:16px;">
                            <table style="width:100%;">
                                <thead><tr><th>Code</th><th>Désignation</th><th>Catégorie</th><th style="color:var(--accent-warning);">Prix B2C</th><th style="color:var(--accent-secondary);">Prix B2B</th><th>Unité</th><th>Actif</th></tr></thead>
                                <tbody id="mf-view-articles-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Modal Sélection Rapide Client (Nouvelle Commande) -->
                <div id="mf-quick-select-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:16px; max-width:600px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                            <h3>➕ Nouvelle commande</h3>
                            <button onclick="closeMFQuickSelectModal()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">&times;</button>
                        </div>

                        <!-- Sélecteur Type Client avec compteurs -->
                        <div style="padding:16px; border-bottom:1px solid var(--border-color);">
                            <div style="font-size:12px; color:var(--text-muted); margin-bottom:10px; text-transform:uppercase;">Type de client</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                <div id="mf-qs-type-b2c" onclick="setMFQuickSelectType('b2c')" style="padding:16px; background:rgba(255,183,77,0.15); border:3px solid var(--accent-warning); border-radius:12px; text-align:center; cursor:pointer; transition:all 0.2s;">
                                    <div style="font-size:28px; margin-bottom:4px;">🏠</div>
                                    <div style="font-weight:700; color:var(--accent-warning);">Particulier</div>
                                    <div style="font-size:20px; font-weight:700; color:var(--accent-warning); margin-top:4px;" id="mf-qs-count-b2c">0</div>
                                    <div style="font-size:10px; color:var(--text-muted);">clients actifs</div>
                                </div>
                                <div id="mf-qs-type-b2b" onclick="setMFQuickSelectType('b2b')" style="padding:16px; background:var(--bg-primary); border:3px solid var(--border-color); border-radius:12px; text-align:center; cursor:pointer; transition:all 0.2s;">
                                    <div style="font-size:28px; margin-bottom:4px;">🏢</div>
                                    <div style="font-weight:700; color:var(--accent-secondary);">Professionnel</div>
                                    <div style="font-size:20px; font-weight:700; color:var(--accent-secondary); margin-top:4px;" id="mf-qs-count-b2b">0</div>
                                    <div style="font-size:10px; color:var(--text-muted);">clients actifs</div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Clients -->
                        <div style="padding:16px; flex:1; overflow-y:auto;">
                            <div style="font-size:12px; color:var(--text-muted); margin-bottom:10px; text-transform:uppercase;">⭐ Clients fréquents</div>
                            <div id="mf-qs-top-clients" style="display:flex; flex-direction:column; gap:8px;">
                                <!-- Généré dynamiquement -->
                            </div>
                        </div>

                        <!-- Actions -->
                        <div style="padding:16px; border-top:1px solid var(--border-color); display:flex; gap:12px;">
                            <button onclick="mfQuickSelectNewClient()" class="btn btn-secondary" style="flex:1;">
                                ➕ Nouveau client
                            </button>
                            <button onclick="mfQuickSelectSearchClient()" class="btn btn-primary" style="flex:1;">
                                🔍 Rechercher
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal Gestion Magasins -->
                <div id="mf-stores-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:16px; max-width:800px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                            <h3>🏪 Gestion des magasins</h3>
                            <button onclick="closeMFStoresModal()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">&times;</button>
                        </div>
                        <div style="padding:16px; border-bottom:1px solid var(--border-color);">
                            <button class="btn btn-primary" onclick="showMFStoreForm()">➕ Nouveau magasin</button>
                        </div>
                        <div style="flex:1; overflow-y:auto; padding:16px;">
                            <table style="width:100%;">
                                <thead><tr><th>Nom</th><th>Adresse</th><th>Email</th><th>Téléphone</th><th>Actions</th></tr></thead>
                                <tbody id="mf-stores-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Modal Formulaire Magasin COMPLET avec horaires -->
                <div id="mf-store-form-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2100; align-items:center; justify-content:center; padding:12px; overflow-y:auto;">
                    <div style="background:var(--bg-card); border-radius:12px; max-width:700px; width:100%; max-height:95vh; overflow-y:auto; margin:auto;">
                        <div style="padding:16px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; position:sticky; top:0; background:var(--bg-card); z-index:10;">
                            <h3 id="mf-store-form-title" style="font-size:16px;">🏪 Magasin</h3>
                            <button onclick="closeMFStoreForm()" style="background:none; border:none; color:var(--text-muted); font-size:24px; cursor:pointer;">&times;</button>
                        </div>
                        <div style="padding:16px;">
                            <input type="hidden" id="mf-edit-store-id">

                            <!-- Infos générales -->
                            <div style="background:var(--bg-primary); border-radius:10px; padding:14px; margin-bottom:16px;">
                                <h4 style="font-size:13px; color:var(--accent-primary); margin-bottom:12px;">📋 Informations générales</h4>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                    <div style="grid-column:1/-1;">
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Nom du magasin *</label>
                                        <input type="text" id="mf-edit-store-name" placeholder="Borex Lausanne" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:14px;">
                                    </div>
                                    <div style="grid-column:1/-1;">
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Adresse</label>
                                        <input type="text" id="mf-edit-store-address" placeholder="Rue du Lac 15, 1000 Lausanne" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:14px;">
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Email entreprise *</label>
                                        <input type="email" id="mf-edit-store-email" placeholder="lausanne@borex-poissons.ch" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:14px;">
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Téléphone</label>
                                        <input type="tel" id="mf-edit-store-phone" placeholder="+41 21 xxx xx xx" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:14px;">
                                    </div>
                                </div>
                            </div>

                            <!-- Horaires d'ouverture -->
                            <div style="background:var(--bg-primary); border-radius:10px; padding:14px; margin-bottom:16px;">
                                <h4 style="font-size:13px; color:var(--accent-secondary); margin-bottom:12px;">🕐 Horaires d'ouverture</h4>
                                <div id="mf-store-hours" style="display:grid; gap:8px;">
                                    <!-- Lundi -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Lundi</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-mon-open" checked onchange="toggleMFDayHours('mon')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-mon-times" style="display:flex; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-mon-start" value="08:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">à</span>
                                            <input type="time" id="mf-hour-mon-end" value="18:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                    </div>
                                    <!-- Mardi -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Mardi</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-tue-open" checked onchange="toggleMFDayHours('tue')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-tue-times" style="display:flex; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-tue-start" value="08:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">à</span>
                                            <input type="time" id="mf-hour-tue-end" value="18:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                    </div>
                                    <!-- Mercredi -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Mercredi</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-wed-open" checked onchange="toggleMFDayHours('wed')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-wed-times" style="display:flex; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-wed-start" value="08:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">à</span>
                                            <input type="time" id="mf-hour-wed-end" value="18:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                    </div>
                                    <!-- Jeudi -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Jeudi</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-thu-open" checked onchange="toggleMFDayHours('thu')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-thu-times" style="display:flex; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-thu-start" value="08:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">à</span>
                                            <input type="time" id="mf-hour-thu-end" value="18:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                    </div>
                                    <!-- Vendredi -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Vendredi</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-fri-open" checked onchange="toggleMFDayHours('fri')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-fri-times" style="display:flex; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-fri-start" value="08:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">à</span>
                                            <input type="time" id="mf-hour-fri-end" value="18:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                    </div>
                                    <!-- Samedi -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Samedi</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-sat-open" checked onchange="toggleMFDayHours('sat')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-sat-times" style="display:flex; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-sat-start" value="08:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">à</span>
                                            <input type="time" id="mf-hour-sat-end" value="12:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                    </div>
                                    <!-- Dimanche -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Dimanche</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-sun-open" onchange="toggleMFDayHours('sun')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-sun-times" style="display:none; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-sun-start" value="09:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">à</span>
                                            <input type="time" id="mf-hour-sun-end" value="12:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                        <span id="mf-hour-sun-closed" style="color:var(--accent-danger); font-size:11px;">Fermé</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Créneaux de retrait -->
                            <div style="background:var(--bg-primary); border-radius:10px; padding:14px; margin-bottom:16px;">
                                <h4 style="font-size:13px; color:var(--accent-primary); margin-bottom:12px;">⏰ Créneaux de retrait commandes</h4>
                                <p style="font-size:11px; color:var(--text-muted); margin-bottom:12px;">Définir la durée des créneaux horaires proposés aux clients</p>
                                <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                                    <label style="font-size:12px;">Durée d'un créneau :</label>
                                    <select id="mf-edit-store-slot" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:13px;">
                                        <option value="30">30 minutes</option>
                                        <option value="60" selected>1 heure</option>
                                        <option value="120">2 heures</option>
                                    </select>
                                    <span style="font-size:11px; color:var(--text-muted);">Ex: 9h-10h, 10h-11h...</span>
                                </div>
                            </div>

                            <!-- Jours exceptionnels -->
                            <div style="background:var(--bg-primary); border-radius:10px; padding:14px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                    <h4 style="font-size:13px; color:var(--accent-danger);">🎄 Jours exceptionnels</h4>
                                    <button type="button" onclick="addMFExceptionalDay()" class="btn btn-secondary" style="padding:6px 12px; font-size:11px;">➕ Ajouter</button>
                                </div>
                                <p style="font-size:11px; color:var(--text-muted); margin-bottom:12px;">Fermetures ou horaires spéciaux (Noël, vacances, jours fériés...)</p>
                                <div id="mf-exceptional-days" style="display:grid; gap:8px;">
                                    <!-- Jours exceptionnels générés dynamiquement -->
                                </div>
                                <div id="mf-no-exceptional" style="text-align:center; padding:12px; color:var(--text-muted); font-size:12px;">
                                    Aucun jour exceptionnel défini
                                </div>
                            </div>
                        </div>
                        <div style="padding:12px 16px; border-top:1px solid var(--border-color); display:flex; justify-content:flex-end; gap:10px; position:sticky; bottom:0; background:var(--bg-card);">
                            <button class="btn btn-secondary" onclick="closeMFStoreForm()" style="padding:10px 16px; font-size:13px;">Annuler</button>
                            <button class="btn btn-primary" onclick="saveMFStore()" style="padding:10px 16px; font-size:13px;">💾 Enregistrer</button>
                        </div>
                    </div>
                </div>

                <!-- Modal Détail Commande -->
                <div id="mf-order-detail-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:16px; max-width:800px; width:100%; max-height:90vh; overflow-y:auto;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;">
                            <h3>Commande <span id="mf-detail-order-id"></span></h3>
                            <button onclick="closeMFOrderDetail()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">&times;</button>
                        </div>
                        <div id="mf-order-detail-content" style="padding:20px;"></div>
                        <div id="mf-order-detail-actions" style="padding:16px 20px; border-top:1px solid var(--border-color); display:flex; justify-content:flex-end; gap:12px;"></div>
                    </div>
                </div>
            </div>

            <!-- =============================================
                 SHOP HUB - Portail E-commerce
                 ============================================= -->
            <div class="module-page" id="page-shop">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span></div>
                
                <!-- Header -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:12px;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="width:50px; height:50px; background:linear-gradient(135deg, #96bf48, #5c8e24); border-radius:14px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 15px rgba(150,191,72,0.3);">
                            <span style="font-size:26px;">🛍️</span>
                        </div>
                        <div>
                            <h2 style="font-size:22px; font-weight:700; margin:0;">Portail E-commerce</h2>
                            <p style="color:var(--text-muted); font-size:12px; margin:0;">Shopify • Nutri-Score • Fiches Produit</p>
                        </div>
                    </div>
                </div>
                
                <!-- Onglets -->
                <div style="display:flex; gap:4px; margin-bottom:20px; background:var(--bg-card); padding:4px; border-radius:12px; border:1px solid var(--border-color); flex-wrap:wrap;">
                    <button onclick="switchShopTab('sync')" id="shop-tab-sync" style="flex:1; min-width:120px; padding:12px; border:none; background:var(--accent-primary); color:white; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.2s;">
                        🔄 Shopify Sync
                    </button>
                    <button onclick="switchShopTab('nutri')" id="shop-tab-nutri" style="flex:1; min-width:120px; padding:12px; border:none; background:transparent; color:var(--text-muted); border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.2s;">
                        🏷️ Nutri-Score
                    </button>
                    <button onclick="switchShopTab('fiches')" id="shop-tab-fiches" style="flex:1; min-width:120px; padding:12px; border:none; background:transparent; color:var(--text-muted); border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.2s;">
                        📝 Fiches Produit
                    </button>
                </div>
                
                <!-- Contenu Onglet Sync -->
                <div id="shop-content-sync" style="display:block;">
                    <div style="background:var(--bg-card); border-radius:16px; border:1px solid var(--border-color); padding:24px;">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
                            <div style="width:40px; height:40px; background:linear-gradient(135deg, #96bf48, #5c8e24); border-radius:10px; display:flex; align-items:center; justify-content:center;">
                                <span style="font-size:20px;">🔄</span>
                            </div>
                            <div>
                                <h3 style="margin:0; font-size:18px;">Synchronisation Shopify</h3>
                                <p style="margin:0; font-size:12px; color:var(--text-muted);">Import commandes CSV, suivi et traitement</p>
                            </div>
                        </div>
                        <button onclick="navigateTo('shopify')" style="width:100%; padding:16px; background:linear-gradient(135deg, #96bf48, #5c8e24); color:#fff; border:none; border-radius:10px; font-weight:700; font-size:15px; cursor:pointer;">
                            Ouvrir Shopify Sync →
                        </button>
                    </div>
                </div>
                
                <!-- Contenu Onglet Nutri-Score -->
                <div id="shop-content-nutri" style="display:none;">
                    <div style="background:var(--bg-card); border-radius:16px; border:1px solid var(--border-color); padding:24px;">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
                            <div style="width:40px; height:40px; background:linear-gradient(135deg, #038141, #02a855); border-radius:10px; display:flex; align-items:center; justify-content:center;">
                                <span style="font-size:20px;">🏷️</span>
                            </div>
                            <div>
                                <h3 style="margin:0; font-size:18px;">Générateur Nutri-Score</h3>
                                <p style="margin:0; font-size:12px; color:var(--text-muted);">Étiquettes nutritionnelles avec calcul Nutri-Score</p>
                            </div>
                        </div>
                        <button onclick="navigateTo('nutriscore')" style="width:100%; padding:16px; background:linear-gradient(135deg, #038141, #02a855); color:#fff; border:none; border-radius:10px; font-weight:700; font-size:15px; cursor:pointer;">
                            Ouvrir Nutri-Score →
                        </button>
                    </div>
                </div>
                
                <!-- Contenu Onglet Fiches Produit -->
                <div id="shop-content-fiches" style="display:none;">
                    <div style="background:var(--bg-card); border-radius:16px; border:1px solid var(--border-color); overflow:hidden;">
                        <!-- Header Fiches -->
                        <div style="padding:20px; background:linear-gradient(135deg, #667eea20, #764ba220); border-bottom:1px solid var(--border-color);">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <div style="width:40px; height:40px; background:linear-gradient(135deg, #667eea, #764ba2); border-radius:10px; display:flex; align-items:center; justify-content:center;">
                                    <span style="font-size:20px;">📝</span>
                                </div>
                                <div>
                                    <h3 style="margin:0; font-size:18px;">Générateur Fiches Produit Shopify</h3>
                                    <p style="margin:0; font-size:12px; color:var(--text-muted);">Créez des fiches produits professionnelles pour Shopify</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Formulaire Fiche -->
                        <div style="padding:20px;">
                            <!-- Import rapide -->
                            <div style="background:#fff3cd; border:2px dashed #ffc107; border-radius:10px; padding:16px; margin-bottom:20px;">
                                <h4 style="color:#856404; margin:0 0 8px 0;">📋 Import rapide depuis Shopify ou Gemini</h4>
                                <textarea id="fiche-import-text" placeholder="Collez votre texte ici..." style="width:100%; min-height:60px; padding:10px; border:1px solid #ddd; border-radius:8px; font-family:inherit; margin-bottom:10px; background:var(--bg-primary); color:var(--text-primary);"></textarea>
                                <button onclick="parseFicheImport()" style="padding:10px 20px; background:#ffc107; color:#000; border:none; border-radius:6px; font-weight:600; cursor:pointer;">🔄 Analyser et remplir</button>
                            </div>
                            
                            <!-- Grille formulaire -->
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                                <!-- Colonne 1 -->
                                <div>
                                    <div style="margin-bottom:14px;">
                                        <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">📄 Description du Produit</label>
                                        <textarea id="fiche-description" placeholder="Description principale..." style="width:100%; min-height:80px; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);"></textarea>
                                    </div>
                                    
                                    <div style="margin-bottom:14px;">
                                        <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">💬 Texte de Présentation</label>
                                        <textarea id="fiche-presentation" placeholder="Texte commercial..." style="width:100%; min-height:60px; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);"></textarea>
                                    </div>
                                    
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px;">
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">⚖️ Unité / Poids</label>
                                            <input type="text" id="fiche-poids" placeholder="Ex: 1kg brut" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">🐟 Type</label>
                                            <select id="fiche-type" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);">
                                                <option value="sauvage">Sauvage</option>
                                                <option value="elevage">Élevage</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px;">
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">✅ Certification</label>
                                            <select id="fiche-certification" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);">
                                                <option value="aucune">Aucune</option>
                                                <option value="bio">BIO</option>
                                                <option value="msc">MSC</option>
                                                <option value="asc">ASC</option>
                                                <option value="label-rouge">Label Rouge</option>
                                                <option value="premium">Premium</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">🌍 Origine</label>
                                            <input type="text" id="fiche-origine" placeholder="Vietnam, Suisse..." style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);">
                                        </div>
                                    </div>
                                    
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px;">
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">🗺️ Zone FAO</label>
                                            <select id="fiche-zone-fao" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);">
                                                <option value="">-- Optionnel --</option>
                                                <option value="FAO 27 - Atlantique Nord-Est">FAO 27 - Atlantique Nord-Est</option>
                                                <option value="FAO 37 - Méditerranée">FAO 37 - Méditerranée</option>
                                                <option value="FAO 21 - Atlantique Nord-Ouest">FAO 21 - Atlantique Nord-Ouest</option>
                                                <option value="FAO 34 - Atlantique Centre-Est">FAO 34 - Atlantique Centre-Est</option>
                                                <option value="FAO 51 - Océan Indien Ouest">FAO 51 - Océan Indien Ouest</option>
                                                <option value="FAO 61 - Pacifique Nord-Ouest">FAO 61 - Pacifique Nord-Ouest</option>
                                                <option value="FAO 71 - Pacifique Centre-Ouest">FAO 71 - Pacifique Centre-Ouest</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">🎣 Méthode Pêche</label>
                                            <select id="fiche-methode-peche" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);">
                                                <option value="">-- Sélectionner --</option>
                                                <option value="N/A - Produit d'élevage">N/A - Élevage</option>
                                                <option value="Ligne">Ligne</option>
                                                <option value="Filet">Filet</option>
                                                <option value="Chalut">Chalut</option>
                                                <option value="Casier">Casier</option>
                                                <option value="Senne">Senne</option>
                                                <option value="Palangre">Palangre</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Colonne 2 -->
                                <div>
                                    <div style="margin-bottom:14px;">
                                        <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">🎯 Texte Vendeur / Engagement</label>
                                        <textarea id="fiche-vendeur" placeholder="Argumentaire commercial..." style="width:100%; min-height:60px; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);"></textarea>
                                    </div>
                                    
                                    <div style="margin-bottom:14px;">
                                        <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">👨‍🍳 Conseils de Préparation</label>
                                        <textarea id="fiche-conseils" placeholder="Comment préparer..." style="width:100%; min-height:60px; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);"></textarea>
                                    </div>
                                    
                                    <div style="margin-bottom:14px;">
                                        <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">🍷 Accords Mets & Vins</label>
                                        <textarea id="fiche-accords" placeholder="Chasselas, Fendant, Chablis..." style="width:100%; min-height:40px; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);"></textarea>
                                    </div>
                                    
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px;">
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">❄️ Conservation</label>
                                            <select id="fiche-conservation" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);">
                                                <option value="">-- Sélectionner --</option>
                                                <option value="congele">🧊 Congelé (-18°C)</option>
                                                <option value="frais">❄️ Frais (0°C à +4°C)</option>
                                                <option value="both">🧊❄️ Congelé puis réfrigéré</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">📅 DLC</label>
                                            <select id="fiche-dlc" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);">
                                                <option value="Voir emballage">Voir emballage</option>
                                                <option value="À consommer rapidement">À consommer rapidement</option>
                                                <option value="3 à 5 jours">3 à 5 jours</option>
                                                <option value="10 à 15 jours">10 à 15 jours</option>
                                                <option value="15 à 20 jours">15 à 20 jours</option>
                                                <option value="21 jours">21 jours</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom:14px;">
                                        <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">🔗 Lien externe (optionnel)</label>
                                        <input type="text" id="fiche-lien" placeholder="https://..." style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Boutons -->
                            <div style="display:flex; gap:12px; margin-top:20px;">
                                <button onclick="generateFicheHTML()" style="flex:2; padding:14px; background:linear-gradient(135deg, #667eea, #764ba2); color:#fff; border:none; border-radius:10px; font-weight:700; cursor:pointer;">
                                    ⚡ Générer la Fiche HTML
                                </button>
                                <button onclick="resetFicheForm()" style="flex:1; padding:14px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; font-weight:600; cursor:pointer;">
                                    🔄 Réinitialiser
                                </button>
                            </div>
                        </div>
                        
                        <!-- Prévisualisation -->
                        <div id="fiche-preview-section" style="display:none; border-top:1px solid var(--border-color);">
                            <div style="padding:20px; background:var(--bg-primary);">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                    <h4 style="margin:0;">👁️ Prévisualisation</h4>
                                    <div style="display:flex; gap:8px;">
                                        <button onclick="showFicheTab('preview')" id="fiche-btn-preview" style="padding:8px 16px; background:var(--accent-primary); color:#000; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Aperçu</button>
                                        <button onclick="showFicheTab('code')" id="fiche-btn-code" style="padding:8px 16px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">Code HTML</button>
                                        <button onclick="copyFicheHTML()" style="padding:8px 16px; background:#28a745; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600;">📋 Copier</button>
                                    </div>
                                </div>
                                <div id="fiche-preview-content" style="background:#fff; padding:20px; border-radius:10px; max-height:400px; overflow-y:auto;"></div>
                                <div id="fiche-code-content" style="display:none; background:#1e1e1e; color:#d4d4d4; padding:16px; border-radius:10px; font-family:monospace; font-size:11px; max-height:300px; overflow:auto; white-space:pre-wrap;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =============================================
                 SHOPIFY MODULE - Intégration Shopify
                 ============================================= -->
            <div class="module-page" id="page-shopify">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('shop')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Shop Hub</span></div>

                <div class="card" style="margin-bottom:20px; border:2px solid #96bf48;">
                    <div class="card-header" style="background:linear-gradient(135deg, #96bf48, #5c8e24);">
                        <h3 class="card-title" style="color:#fff;">🛍️ Shopify - Gestion des Commandes</h3>
                    </div>
                    <div class="card-body">
                        <!-- Import CSV -->
                        <div style="margin-bottom:24px; padding:20px; background:linear-gradient(135deg, rgba(150,191,72,0.1), rgba(92,142,36,0.1)); border:2px dashed #96bf48; border-radius:12px; text-align:center;">
                            <div style="font-size:36px; margin-bottom:12px;">📄</div>
                            <div style="font-weight:600; color:#96bf48; margin-bottom:8px;">Importer les commandes Shopify</div>
                            <div style="font-size:12px; color:var(--text-muted); margin-bottom:16px;">
                                Dans Shopify : Commandes → Exporter → CSV<br>
                                Puis importez le fichier ici
                            </div>
                            <input type="file" id="shopify-csv-input" accept=".csv" onchange="importShopifyCSV(this)" style="display:none;">
                            <button onclick="document.getElementById('shopify-csv-input').click()" class="btn btn-primary" style="padding:14px 28px; background:#96bf48;">
                                📥 Importer un fichier CSV
                            </button>
                            <span id="shopify-import-status" style="display:block; margin-top:12px; font-size:13px;"></span>
                        </div>

                        <!-- Alertes commandes urgentes -->
                        <div id="shopify-alerts" style="display:none; margin-bottom:20px;">
                            <div id="shopify-alert-urgent" style="display:none; padding:16px; background:linear-gradient(135deg, var(--accent-danger), #c0392b); color:#fff; border-radius:12px; margin-bottom:12px;">
                                <div style="display:flex; align-items:center; justify-content:space-between;">
                                    <div>
                                        <strong>🚨 Commandes payées non traitées !</strong>
                                        <span id="shopify-urgent-count" style="background:rgba(255,255,255,0.3); padding:2px 10px; border-radius:20px; margin-left:10px;">0</span>
                                    </div>
                                    <button onclick="filterShopifyByUrgent()" style="padding:8px 16px; background:rgba(255,255,255,0.2); border:none; color:#fff; border-radius:6px; cursor:pointer;">Voir →</button>
                                </div>
                            </div>
                            <div id="shopify-alert-today" style="display:none; padding:16px; background:linear-gradient(135deg, var(--accent-warning), var(--accent-orange)); color:#000; border-radius:12px;">
                                <div style="display:flex; align-items:center; justify-content:space-between;">
                                    <div>
                                        <strong>📅 Retraits aujourd'hui</strong>
                                        <span id="shopify-today-count" style="background:rgba(0,0,0,0.2); padding:2px 10px; border-radius:20px; margin-left:10px;">0</span>
                                    </div>
                                    <button onclick="filterShopifyByToday()" style="padding:8px 16px; background:rgba(0,0,0,0.1); border:none; color:#000; border-radius:6px; cursor:pointer;">Voir →</button>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div id="shopify-stats" style="display:none; display:grid; grid-template-columns:repeat(6, 1fr); gap:12px; margin-bottom:20px;">
                            <div onclick="filterShopifyOrders('all')" style="background:var(--bg-primary); padding:16px; border-radius:10px; text-align:center; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-size:24px; font-weight:700; color:#96bf48;" id="shopify-stat-total">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">Total</div>
                            </div>
                            <div onclick="filterShopifyByUrgent()" style="background:var(--bg-primary); padding:16px; border-radius:10px; text-align:center; cursor:pointer; border:2px solid transparent; transition:all 0.2s;" id="shopify-stat-urgent-box" onmouseover="this.style.borderColor='var(--accent-danger)'" onmouseout="this.style.borderColor='transparent'">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-danger);" id="shopify-stat-urgent">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">🚨 À traiter</div>
                            </div>
                            <div onclick="filterShopifyOrders('pending')" style="background:var(--bg-primary); padding:16px; border-radius:10px; text-align:center; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-warning);" id="shopify-stat-pending">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">⏳ En attente</div>
                            </div>
                            <div onclick="filterShopifyOrders('fulfilled')" style="background:var(--bg-primary); padding:16px; border-radius:10px; text-align:center; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-secondary);" id="shopify-stat-fulfilled">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">✅ Traitées</div>
                            </div>
                            <div style="background:var(--bg-primary); padding:16px; border-radius:10px; text-align:center;">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-primary);" id="shopify-stat-pickup">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">🏪 Retrait</div>
                            </div>
                            <div style="background:var(--bg-primary); padding:16px; border-radius:10px; text-align:center;">
                                <div style="font-size:24px; font-weight:700; color:var(--text-primary);" id="shopify-stat-revenue">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">CHF Total</div>
                            </div>
                        </div>

                        <!-- Filtres -->
                        <div id="shopify-filters" style="display:none; display:flex; gap:12px; flex-wrap:wrap; margin-bottom:20px; padding:16px; background:var(--bg-primary); border-radius:12px;">
                            <select id="shopify-filter-status" onchange="applyShopifyFilters()" style="padding:10px 16px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                <option value="">Tous les statuts</option>
                                <option value="urgent">🚨 Payées non traitées</option>
                                <option value="pending">⏳ En attente paiement</option>
                                <option value="fulfilled">✅ Traitées</option>
                                <option value="refunded">↩️ Remboursées</option>
                            </select>
                            <select id="shopify-filter-location" onchange="applyShopifyFilters()" style="padding:10px 16px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                <option value="">Tous les lieux</option>
                                <option value="Laboratoire">🔬 Laboratoire Coinsins</option>
                                <option value="Magasin">🏪 Magasin Nyon</option>
                                <option value="Shipping">📦 Livraison</option>
                            </select>
                            <select id="shopify-filter-pickup-date" onchange="applyShopifyFilters()" style="padding:10px 16px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                <option value="">Toutes les dates</option>
                                <!-- Rempli dynamiquement -->
                            </select>
                            <input type="text" id="shopify-search" placeholder="🔍 Rechercher client, commande..." oninput="applyShopifyFilters()" style="flex:1; min-width:200px; padding:10px 16px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            <button onclick="resetShopifyFilters()" class="btn btn-secondary" style="padding:10px 16px;">
                                ✕ Reset
                            </button>
                            <button onclick="exportShopifyFiltered()" class="btn btn-secondary" style="padding:10px 16px;">
                                📤 Exporter
                            </button>
                        </div>

                        <!-- Liste des commandes -->
                        <div id="shopify-table-container" style="display:none;" class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width:40px;"><input type="checkbox" id="shopify-select-all" onchange="toggleSelectAllShopify()"></th>
                                        <th>N° Cmd</th>
                                        <th>📆 Commandé</th>
                                        <th>Client</th>
                                        <th>📅 Retrait</th>
                                        <th>📍 Lieu</th>
                                        <th>Articles</th>
                                        <th>Total</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="shopify-orders-tbody">
                                </tbody>
                            </table>
                        </div>

                        <!-- Message vide -->
                        <div id="shopify-empty" style="text-align:center; padding:40px; color:var(--text-muted);">
                            <div style="font-size:48px; margin-bottom:16px;">📄</div>
                            <div>Importez un fichier CSV Shopify pour commencer</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Détail Commande Shopify -->
            <div id="shopify-order-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center; padding:20px;" onclick="if(event.target === this) closeShopifyOrderModal()">
                <div style="background:var(--bg-card); border-radius:20px; max-width:900px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
                    <div id="shopify-modal-header" style="padding:20px 24px; background:linear-gradient(135deg, #96bf48, #5c8e24); color:#fff;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-size:12px; opacity:0.8;">COMMANDE SHOPIFY</div>
                                <h2 id="shopify-modal-order-id" style="font-size:22px; font-weight:700; margin:0;">#0000</h2>
                            </div>
                            <button onclick="closeShopifyOrderModal()" style="background:rgba(255,255,255,0.2); border:none; color:#fff; width:36px; height:36px; border-radius:50%; font-size:20px; cursor:pointer;">×</button>
                        </div>
                    </div>
                    <div id="shopify-modal-content" style="flex:1; overflow-y:auto; padding:24px;">
                        <!-- Contenu dynamique -->
                    </div>
                    <div style="padding:16px 24px; background:var(--bg-primary); border-top:1px solid var(--border-color); display:flex; gap:12px; justify-content:flex-end;">
                        <button onclick="printShopifyOrder()" class="btn btn-secondary" style="padding:12px 24px;">🖨️ Imprimer</button>
                        <button onclick="markAsProcessed()" class="btn btn-primary" style="padding:12px 24px; background:var(--accent-primary);">✅ Marquer traitée</button>
                    </div>
                </div>
            </div>

            <!-- =============================================
                 QUICKORDER MODULE - Prise de Commandes Rapide
                 ============================================= -->
            <div class="module-page" id="page-quickorder">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span></div>
                <!-- Étape 1: Sélection Client -->
                <div id="qo-step-client" class="qo-step active">
                    <div class="card" style="max-width:800px; margin:0 auto;">
                        <div class="card-header">
                            <h3 class="card-title">⚡ Nouvelle Commande - Sélection Client</h3>
                        </div>
                        <div class="card-body">
                            <div style="position:relative; margin-bottom:24px;">
                                <input type="text" id="qo-client-search" placeholder="🔍 Rechercher client B2B (nom, téléphone, ville...)"
                                    style="width:100%; padding:20px 24px; font-size:18px; background:var(--bg-primary); border:3px solid var(--border-color); border-radius:16px; color:var(--text-primary);"
                                    oninput="searchQOClients(this.value)" autocomplete="off">
                                <div id="qo-client-results" style="display:none; position:absolute; top:100%; left:0; right:0; background:var(--bg-card); border:2px solid var(--border-color); border-radius:12px; max-height:300px; overflow-y:auto; z-index:100; margin-top:4px;"></div>
                            </div>
                            <div id="qo-selected-client" style="display:none; padding:20px; background:linear-gradient(135deg, rgba(6,214,160,0.1), rgba(17,138,178,0.1)); border:2px solid var(--accent-primary); border-radius:16px; margin-bottom:24px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <h3 id="qo-client-name" style="font-size:20px; margin-bottom:4px;"></h3>
                                        <p style="color:var(--text-muted);"><span id="qo-client-phone"></span> • <span id="qo-client-email"></span></p>
                                        <p onclick="showClientOrders()" style="font-size:13px; color:var(--accent-primary); margin-top:8px; cursor:pointer; text-decoration:underline;" title="Cliquez pour voir les commandes">📋 <span id="qo-client-orders-count">0</span> commandes précédentes</p>
                                    </div>
                                    <button class="btn btn-secondary" onclick="clearQOClient()">✕ Changer</button>
                                </div>
                            </div>
                            <div style="display:flex; gap:12px; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                                <button class="btn btn-secondary" onclick="showQONewClientForm()">➕ Nouveau client</button>
                                <button class="btn btn-primary" id="qo-btn-next-step" style="padding:16px 32px; font-size:16px; display:none;" onclick="goToQOStep2()">Continuer → Commande</button>
                            </div>
                            <!-- Formulaire nouveau client -->
                            <div id="qo-new-client-form" style="display:none; margin-top:24px; padding:20px; background:var(--bg-primary); border-radius:12px; border:2px dashed var(--accent-primary);">
                                <h4 style="color:var(--accent-primary); margin-bottom:16px;">➕ Nouveau client</h4>

                                <!-- Type client B2B/B2C -->
                                <div style="display:flex; gap:12px; margin-bottom:20px;">
                                    <label style="flex:1; cursor:pointer;">
                                        <input type="radio" name="qo-new-type" value="b2b" checked style="display:none;">
                                        <div id="qo-type-b2b" onclick="selectQOClientType('b2b')" style="padding:14px; background:var(--accent-secondary); color:#fff; border-radius:10px; text-align:center; font-weight:600; transition:all 0.2s;">
                                            🏢 Professionnel (B2B)
                                        </div>
                                    </label>
                                    <label style="flex:1; cursor:pointer;">
                                        <input type="radio" name="qo-new-type" value="b2c" style="display:none;">
                                        <div id="qo-type-b2c" onclick="selectQOClientType('b2c')" style="padding:14px; background:var(--bg-card); color:var(--text-muted); border:2px solid var(--border-color); border-radius:10px; text-align:center; font-weight:600; transition:all 0.2s;">
                                            🏠 Particulier (B2C)
                                        </div>
                                    </label>
                                </div>

                                <!-- Infos personnelles -->
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                    <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Nom *</label><input type="text" id="qo-new-name" placeholder="Nom de famille" style="width:100%; padding:10px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Prénom</label><input type="text" id="qo-new-firstname" placeholder="Prénom" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                                </div>

                                <!-- Téléphones -->
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                    <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Téléphone fixe *</label><input type="tel" id="qo-new-phone" placeholder="+41 21 xxx xx xx" style="width:100%; padding:10px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Téléphone portable</label><input type="tel" id="qo-new-mobile" placeholder="+41 79 xxx xx xx" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                                </div>

                                <!-- Email & Entreprise -->
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                    <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Email *</label><input type="email" id="qo-new-email" placeholder="email@exemple.ch" style="width:100%; padding:10px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Entreprise</label><input type="text" id="qo-new-company" placeholder="Nom de l'entreprise" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                                </div>

                                <!-- Adresse -->
                                <div style="margin-bottom:12px;">
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Adresse *</label>
                                    <input type="text" id="qo-new-address" placeholder="Rue et numéro" style="width:100%; padding:10px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>

                                <!-- NPA, Ville, Canton -->
                                <div style="display:grid; grid-template-columns:100px 1fr 150px; gap:12px; margin-bottom:12px;">
                                    <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">NPA *</label><input type="text" id="qo-new-zip" placeholder="1000" maxlength="6" style="width:100%; padding:10px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Ville *</label><input type="text" id="qo-new-city" placeholder="Lausanne" style="width:100%; padding:10px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Canton</label><select id="qo-new-canton" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);"><option value="">--</option><option value="AG">AG</option><option value="AI">AI</option><option value="AR">AR</option><option value="BE">BE</option><option value="BL">BL</option><option value="BS">BS</option><option value="FR">FR</option><option value="GE">GE</option><option value="GL">GL</option><option value="GR">GR</option><option value="JU">JU</option><option value="LU">LU</option><option value="NE">NE</option><option value="NW">NW</option><option value="OW">OW</option><option value="SG">SG</option><option value="SH">SH</option><option value="SO">SO</option><option value="SZ">SZ</option><option value="TG">TG</option><option value="TI">TI</option><option value="UR">UR</option><option value="VD" selected>VD</option><option value="VS">VS</option><option value="ZG">ZG</option><option value="ZH">ZH</option></select></div>
                                </div>

                                <!-- Pays -->
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                                    <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Pays</label><select id="qo-new-country" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);"><option value="Suisse" selected>🇨🇭 Suisse</option><option value="France">🇫🇷 France</option><option value="Allemagne">🇩🇪 Allemagne</option><option value="Italie">🇮🇹 Italie</option><option value="Autriche">🇦🇹 Autriche</option><option value="Autre">Autre</option></select></div>
                                    <div><label style="display:block; font-size:12px; color:var(--accent-warning); margin-bottom:4px; font-weight:600;">💰 Liste de prix</label><select id="qo-new-pricelist" style="width:100%; padding:10px; background:var(--bg-card); border:2px solid var(--accent-warning); border-radius:8px; color:var(--text-primary);"></select></div>
                                </div>

                                <div style="display:flex; gap:12px;">
                                    <button class="btn btn-primary" onclick="saveQONewClient()">✓ Créer et sélectionner</button>
                                    <button class="btn btn-secondary" onclick="hideQONewClientForm()">Annuler</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Étape 2: Prise de commande -->
                <div id="qo-step-order" class="qo-step" style="display:none;">
                    <div style="display:flex; gap:12px; margin-bottom:20px; align-items:center; flex-wrap:wrap;">
                        <button class="btn btn-secondary" onclick="goBackToQOStep1()">← Retour client</button>
                        <div style="flex:1; text-align:center;">
                            <span style="font-size:14px; color:var(--text-muted);">Client:</span>
                            <strong id="qo-header-client" style="color:var(--accent-primary); margin-left:8px;"></strong>
                        </div>
                        <button id="qo-btn-validate" class="btn btn-primary" onclick="showFinalizeModal()" style="padding:14px 28px; font-size:16px;">✅ Valider la commande</button>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 400px; gap:20px;">
                        <!-- Colonne gauche: Recherche & Suggestions -->
                        <div>
                            <!-- Recherche produit -->
                            <div class="card" style="margin-bottom:20px;">
                                <div class="card-header"><h3 class="card-title">🔍 Recherche Produit</h3></div>
                                <div class="card-body">
                                    <input type="text" id="qo-product-search" placeholder="Cliquez ou tapez pour rechercher..."
                                        style="width:100%; padding:14px 18px; font-size:16px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:10px; color:var(--text-primary);"
                                        onfocus="showQOProductsByCategory()"
                                        oninput="searchQOProducts(this.value)">
                                    <!-- Filtre par catégorie -->
                                    <div id="qo-category-filter" style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;"></div>
                                    <div id="qo-product-results" style="margin-top:12px; max-height:350px; overflow-y:auto;"></div>
                                </div>
                            </div>

                            <!-- Historique client -->
                            <div class="card" style="margin-bottom:20px;">
                                <div class="card-header"><h3 class="card-title">📋 Déjà commandé par ce client</h3></div>
                                <div class="card-body" style="max-height:200px; overflow-y:auto;">
                                    <div id="qo-client-history">Aucun historique</div>
                                </div>
                            </div>

                            <!-- Suggestions -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">💡 Suggestions (jamais commandé)</h3>
                                    <button class="btn btn-secondary" style="padding:6px 12px; font-size:12px;" onclick="refreshQOSuggestions()">🔄</button>
                                </div>
                                <div class="card-body" style="max-height:200px; overflow-y:auto;">
                                    <div id="qo-suggestions">Chargement...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Colonne droite: Panier -->
                        <div class="card" style="position:sticky; top:20px; max-height:calc(100vh - 200px); display:flex; flex-direction:column;">
                            <div class="card-header"><h3 class="card-title">🛒 Commande en cours</h3><span id="qo-cart-count" style="color:var(--text-muted);">0 article(s)</span></div>
                            <div class="card-body" style="flex:1; overflow-y:auto; padding:12px;">
                                <div id="qo-cart-items">
                                    <div style="text-align:center; color:var(--text-muted); padding:40px;">Ajoutez des produits</div>
                                </div>
                            </div>

                            <!-- Section Caisse repliable -->
                            <div id="qo-caisse" style="border-top:2px solid var(--accent-primary);">
                                <!-- Info rabais client (visible si client sélectionné) -->
                                <div id="qo-discount-info" style="display:none; padding:12px 16px; background:linear-gradient(135deg, #ffd16610, #06d6a008); border-bottom:1px solid var(--border-color);">
                                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                                        <div style="display:flex; align-items:center; gap:8px;">
                                            <span style="font-size:14px;">🏷️</span>
                                            <span style="font-weight:600; color:#ffd166; font-size:12px;">Rabais appliqués</span>
                                        </div>
                                        <span id="qo-pricelist-badge" style="display:none; padding:3px 10px; background:#ffd16620; color:#ffd166; border-radius:12px; font-size:11px; font-weight:600;"></span>
                                    </div>
                                    <!-- Simulation des paliers -->
                                    <div id="qo-discount-simulation" style="font-size:12px;">
                                        <!-- Généré dynamiquement -->
                                    </div>
                                </div>

                                <!-- Barre compacte (toujours visible) -->
                                <div onclick="toggleQOCaisse()" style="padding:14px 16px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:all 0.3s;">
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <span style="font-size:20px;">💳</span>
                                        <span style="font-weight:700; color:#000;">TOTAL</span>
                                    </div>
                                    <div style="display:flex; align-items:center; gap:12px;">
                                        <span id="qo-total-ttc-compact" style="font-family:'Space Mono',monospace; font-weight:700; font-size:22px; color:#000;">0.00 CHF</span>
                                        <span id="qo-caisse-arrow" style="font-size:16px; color:#000; transition:transform 0.3s;">▲</span>
                                    </div>
                                </div>

                                <!-- Détails (repliés par défaut) -->
                                <div id="qo-caisse-details" style="display:none; padding:16px; background:var(--bg-hover);">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px;">
                                        <span style="color:var(--text-muted);">📦 Articles</span>
                                        <span id="qo-total-items" style="font-weight:600;">0</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px;">
                                        <span style="color:var(--text-muted);">⚖️ Poids total</span>
                                        <span id="qo-total-weight" style="font-weight:600;">0.00 kg</span>
                                    </div>
                                    <div style="border-top:1px dashed var(--border-color); padding-top:10px; margin-top:10px;">
                                        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px;">
                                            <span>Total HT</span>
                                            <span id="qo-total-price" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                                        </div>
                                        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px; color:var(--text-muted);">
                                            <span>TVA (2.6%)</span>
                                            <span id="qo-total-tva" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                                        </div>
                                    </div>
                                    <div style="border-top:2px solid var(--accent-primary); padding-top:12px; margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
                                        <span style="font-weight:700; font-size:16px; color:var(--accent-primary);">TOTAL TTC</span>
                                        <span id="qo-total-ttc" style="font-family:'Space Mono',monospace; font-weight:700; font-size:24px; color:var(--accent-primary);">0.00 CHF</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal: Modifier ligne commande -->
                <div id="qo-edit-line-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:var(--radius); max-width:600px; width:100%; border:1px solid var(--border-color);">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;">
                            <h3>✏️ Modifier article</h3>
                            <button onclick="closeQOEditModal()" style="background:none; border:none; color:var(--text-muted); font-size:24px; cursor:pointer;">&times;</button>
                        </div>
                        <div style="padding:20px;">
                            <input type="hidden" id="qo-edit-index">
                            <div style="margin-bottom:16px; padding:16px; background:var(--bg-primary); border-radius:8px;">
                                <strong id="qo-edit-product-name" style="font-size:18px;"></strong>
                                <div style="font-size:13px; color:var(--text-muted); margin-top:4px;" id="qo-edit-product-code"></div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                                <div><label style="display:block; font-size:13px; color:var(--text-secondary); margin-bottom:6px;">Origine</label><input type="text" id="qo-edit-origin" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                                <div><label style="display:block; font-size:13px; color:var(--text-secondary); margin-bottom:6px;">Nom latin</label><input type="text" id="qo-edit-latin" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px;">
                                <div><label style="display:block; font-size:13px; color:var(--text-secondary); margin-bottom:6px;">N° Lot</label><input type="text" id="qo-edit-lot" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                                <div><label style="display:block; font-size:13px; color:var(--text-secondary); margin-bottom:6px;">Prix unitaire (CHF)</label><input type="number" step="0.05" id="qo-edit-price" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                                <div><label style="display:block; font-size:13px; color:var(--text-secondary); margin-bottom:6px;">Quantité</label><input type="number" step="0.1" id="qo-edit-qty" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);"></div>
                            </div>
                        </div>
                        <div style="padding:16px 20px; border-top:1px solid var(--border-color); display:flex; justify-content:space-between;">
                            <button class="btn btn-secondary" style="color:var(--accent-danger);" onclick="removeQOCartItem()">🗑️ Supprimer</button>
                            <div style="display:flex; gap:12px;">
                                <button class="btn btn-secondary" onclick="closeQOEditModal()">Annuler</button>
                                <button class="btn btn-primary" onclick="saveQOEditLine()">💾 Enregistrer</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal: Gestion Produits -->
                <div id="qo-products-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:var(--radius); max-width:1100px; width:100%; max-height:90vh; overflow:hidden; border:1px solid var(--border-color); display:flex; flex-direction:column;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
                            <h3>📦 Gestion des Produits <span id="qo-products-count" style="font-size:14px; color:var(--text-muted);"></span></h3>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn btn-primary" onclick="showQOProductForm()">➕ Nouveau</button>
                                <button class="btn btn-secondary" onclick="document.getElementById('qo-import-lightspeed').click()" style="color:var(--accent-warning);">📥 Lightspeed B2C</button>
                                <button class="btn btn-secondary" onclick="document.getElementById('qo-import-infoniqa').click()" style="color:var(--accent-secondary);">📥 Infoniqa B2B</button>
                                <button class="btn btn-secondary" onclick="exportQOProductsCSV()">📤 Export CSV</button>
                                <button class="btn btn-secondary" onclick="resetQOProductsToDefault()" style="color:var(--accent-warning);">🔄 Réinit.</button>
                                <button onclick="closeQOProductsModal()" style="background:none; border:none; color:var(--text-muted); font-size:24px; cursor:pointer;">&times;</button>
                            </div>
                            <input type="file" id="qo-import-lightspeed" accept=".csv" style="display:none;" onchange="importQOLightspeed(this)">
                            <input type="file" id="qo-import-infoniqa" accept=".csv,.xls,.xlsx" style="display:none;" onchange="importQOInfoniqa(this)">
                        </div>
                        <!-- Filtres -->
                        <div style="padding:12px 20px; background:var(--bg-primary); display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                            <input type="text" id="qo-prod-search-filter" placeholder="🔍 Rechercher..." oninput="filterQOProductsTable(this.value)" style="flex:1; min-width:200px; padding:8px 12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                            <select id="qo-prod-cat-filter" onchange="filterQOProductsTable(document.getElementById('qo-prod-search-filter').value)" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                <option value="">Toutes catégories</option>
                                <option value="poisson">🐟 Poissons</option>
                                <option value="crustace">🦐 Crustacés</option>
                                <option value="coquillage">🦪 Coquillages</option>
                                <option value="fume">🔥 Fumés</option>
                                <option value="conserve">🥫 Conserves</option>
                                <option value="preparation">🍽️ Préparations</option>
                                <option value="surgele">❄️ Surgelés</option>
                            </select>
                        </div>
                        <div style="padding:20px; flex:1; overflow-y:auto;">
                            <div id="qo-product-form" style="display:none; margin-bottom:20px; padding:20px; background:var(--bg-primary); border-radius:12px; border:2px solid var(--accent-primary);">
                                <input type="hidden" id="qo-prod-edit-id">
                                <div style="display:grid; grid-template-columns:120px 1fr 1fr; gap:12px; margin-bottom:12px;">
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Code/SKU *</label><input type="text" id="qo-prod-code" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                    <div style="grid-column:span 2;"><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Désignation *</label><input type="text" id="qo-prod-name" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                </div>
                                <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:12px; margin-bottom:12px;">
                                    <div><label style="display:block; font-size:12px; color:var(--accent-warning); margin-bottom:4px;">💰 Prix B2C (CHF)</label><input type="number" step="0.05" id="qo-prod-price-b2c" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--accent-warning); border-radius:6px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--accent-secondary); margin-bottom:4px;">💼 Prix B2B (CHF)</label><input type="number" step="0.05" id="qo-prod-price-b2b" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--accent-secondary); border-radius:6px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Coût achat</label><input type="number" step="0.01" id="qo-prod-cost" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Unité</label><select id="qo-prod-unit" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"><option value="kg">Au kg</option><option value="pce">À la pièce</option><option value="lot">Au lot</option></select></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Catégorie</label><select id="qo-prod-cat" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"><option value="poisson">🐟 Poisson</option><option value="crustace">🦐 Crustacé</option><option value="coquillage">🦪 Coquillage</option><option value="fume">🔥 Fumé</option><option value="conserve">🥫 Conserve</option><option value="preparation">🍽️ Préparation</option><option value="surgele">❄️ Surgelé</option><option value="autre">📦 Autre</option></select></div>
                                </div>
                                <div style="display:flex; gap:12px; align-items:center;">
                                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="checkbox" id="qo-prod-active" checked> Actif</label>
                                    <div style="flex:1;"></div>
                                    <button class="btn btn-primary" onclick="saveQOProduct()">💾 Enregistrer</button>
                                    <button class="btn btn-secondary" onclick="hideQOProductForm()">Annuler</button>
                                </div>
                            </div>
                            <div class="table-container"><table><thead><tr><th>Code</th><th>Désignation</th><th>Cat.</th><th style="color:var(--accent-warning);">B2C</th><th style="color:var(--accent-secondary);">B2B</th><th>Unité</th><th>Actif</th><th>Actions</th></tr></thead><tbody id="qo-products-tbody"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <!-- Modal: Gestion Clients -->
                <div id="qo-clients-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:var(--radius); max-width:1000px; width:100%; max-height:90vh; overflow:hidden; border:1px solid var(--border-color); display:flex; flex-direction:column;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
                            <h3>👥 Gestion des Clients</h3>
                            <div style="display:flex; gap:12px; flex-wrap:wrap;">
                                <button class="btn btn-secondary" onclick="showQOClientForm()">➕ Nouveau</button>
                                <button class="btn btn-secondary" onclick="document.getElementById('qo-import-file').click()">📥 Importer CSV/XLS</button>
                                <button class="btn btn-secondary" onclick="exportQOClientsCSV()">📤 Exporter CSV</button>
                                <button class="btn" onclick="saveAllClientsToDropbox()" style="background:var(--accent-secondary); color:#fff; border:none;">☁️ Dropbox</button>
                                <button class="btn btn-secondary" onclick="downloadQOImportTemplate()">📋 Modèle import</button>
                                <button class="btn btn-secondary" onclick="resetQOClientsToDefault()" style="color:var(--accent-warning);">🔄 Réinitialiser base</button>
                                <button onclick="closeQOClientsModal()" style="background:none; border:none; color:var(--text-muted); font-size:24px; cursor:pointer;">&times;</button>
                            </div>
                            <input type="file" id="qo-import-file" accept=".csv,.xls,.xlsx" style="display:none;" onchange="importQOClientsFile(this)">
                        </div>
                        <div style="padding:20px; flex:1; overflow-y:auto;">
                            <!-- Formulaire client -->
                            <div id="qo-client-form" style="display:none; margin-bottom:20px; padding:20px; background:var(--bg-primary); border-radius:12px; border:2px solid var(--accent-primary);">
                                <h4 style="color:var(--accent-primary); margin-bottom:16px;">📝 Fiche Client</h4>
                                <input type="hidden" id="qo-client-edit-id">
                                <div style="display:grid; grid-template-columns:100px 1fr 1fr 150px; gap:12px; margin-bottom:12px;">
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">N° Client</label><input type="text" id="qo-client-num" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Nom / Société *</label><input type="text" id="qo-client-company" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Contact / Prénom</label><input type="text" id="qo-client-contact" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; font-weight:600; color:var(--accent-primary); margin-bottom:4px;">Type client</label><select id="qo-client-type" style="width:100%; padding:10px; background:var(--bg-card); border:2px solid var(--accent-primary); border-radius:6px; color:var(--text-primary); font-weight:600;"><option value="b2b">🏢 Professionnel (B2B)</option><option value="b2c">🏠 Particulier (B2C)</option></select></div>
                                </div>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Adresse</label><input type="text" id="qo-client-address" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Adresse 2</label><input type="text" id="qo-client-address2" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                </div>
                                <div style="display:grid; grid-template-columns:100px 1fr 1fr 1fr; gap:12px; margin-bottom:12px;">
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Code postal</label><input type="text" id="qo-client-zip" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Ville</label><input type="text" id="qo-client-city" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Téléphone</label><input type="tel" id="qo-client-tel" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Portable</label><input type="tel" id="qo-client-mobile" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                </div>
                                <div style="display:grid; grid-template-columns:1fr 120px 150px; gap:12px; margin-bottom:12px;">
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Email</label><input type="email" id="qo-client-email2" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Limite crédit</label><input type="number" id="qo-client-credit" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                                    <div><label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Échéance</label><select id="qo-client-payment" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"><option value="30 jours fin de mois">30j fin mois</option><option value="Comptant">Comptant</option><option value="15 jours">15 jours</option><option value="60 jours">60 jours</option></select></div>
                                </div>
                                <div style="display:flex; gap:12px;">
                                    <button class="btn btn-primary" onclick="saveQOClient()">💾 Enregistrer</button>
                                    <button class="btn btn-secondary" onclick="hideQOClientForm()">Annuler</button>
                                </div>
                            </div>
                            <!-- Barre de recherche -->
                            <div style="margin-bottom:16px;">
                                <input type="text" id="qo-clients-filter" placeholder="🔍 Rechercher par nom, téléphone, ville..."
                                    style="width:100%; padding:12px 16px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);"
                                    oninput="filterQOClientsTable(this.value)">
                            </div>
                            <!-- Stats -->
                            <div style="display:flex; gap:16px; margin-bottom:16px; flex-wrap:wrap;">
                                <div style="background:var(--bg-primary); padding:12px 20px; border-radius:8px;"><strong id="qo-clients-count">0</strong> <span style="color:var(--text-muted);">clients</span></div>
                                <div style="background:rgba(17,138,178,0.2); padding:12px 20px; border-radius:8px;"><strong id="qo-clients-b2b">0</strong> <span style="color:var(--accent-secondary);">B2B</span></div>
                                <div style="background:rgba(255,183,77,0.2); padding:12px 20px; border-radius:8px;"><strong id="qo-clients-b2c">0</strong> <span style="color:var(--accent-warning);">B2C</span></div>
                            </div>
                            <!-- Table -->
                            <div class="table-container" style="max-height:400px; overflow-y:auto;">
                                <table><thead><tr><th>N°</th><th>Type</th><th>Nom / Société</th><th>Contact</th><th>Ville</th><th>Téléphone</th><th>Cmd</th><th>Actions</th></tr></thead><tbody id="qo-clients-tbody"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Boutons flottants subtils -->
                <div id="qo-floating-menu" style="position:fixed; bottom:20px; right:20px; z-index:100;">
                    <!-- Bouton principal qui ouvre le menu -->
                    <div id="qo-float-expanded" style="display:flex; flex-direction:column; gap:8px; margin-bottom:8px; opacity:0; transform:translateY(10px); transition:all 0.3s; pointer-events:none;">
                        <button onclick="openQOClientsModal()" style="width:44px; height:44px; border-radius:10px; background:var(--bg-card); border:1px solid var(--border-color); color:var(--text-secondary); font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s;" onmouseover="this.style.background='var(--accent-secondary)'; this.style.color='#fff'; this.style.borderColor='var(--accent-secondary)'" onmouseout="this.style.background='var(--bg-card)'; this.style.color='var(--text-secondary)'; this.style.borderColor='var(--border-color)'" title="Gérer les clients">👥</button>
                        <button onclick="openQOProductsModal()" style="width:44px; height:44px; border-radius:10px; background:var(--bg-card); border:1px solid var(--border-color); color:var(--text-secondary); font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s;" onmouseover="this.style.background='var(--accent-primary)'; this.style.color='#000'; this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.background='var(--bg-card)'; this.style.color='var(--text-secondary)'; this.style.borderColor='var(--border-color)'" title="Gérer les produits">📦</button>
                    </div>
                    <button onclick="toggleQOFloatMenu()" id="qo-float-toggle" style="width:44px; height:44px; border-radius:10px; background:var(--bg-card); border:1px solid var(--border-color); color:var(--text-muted); font-size:16px; cursor:pointer; transition:all 0.3s;" title="Outils">⚙️</button>
                </div>
            </div>

            <!-- Clients Page -->
            <div class="module-page" id="page-clients">
                <!-- Breadcrumb subtil -->
                <div style="margin-bottom:20px;">
                    <span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">
                        ← Accueil
                    </span>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:16px;">
                    <div>
                        <h2 style="font-size:24px; font-weight:700; margin-bottom:4px;">👥 Gestion des Clients</h2>
                        <p style="color:var(--text-muted);">Clients professionnels (B2B) et particuliers (B2C)</p>
                    </div>
                    <div style="display:flex; gap:12px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="showClientsForm()">➕ Nouveau client</button>
                        <button class="btn btn-secondary" onclick="showImportClientsModal()">📥 Importer</button>
                        <button class="btn btn-secondary" onclick="exportAllClientsCSV()">📤 Exporter</button>
                        <button class="btn" onclick="saveAllClientsToDropbox()" style="background:var(--accent-secondary); color:#fff; border:none;">☁️ Dropbox</button>
                        <input type="file" id="clients-import-file" accept=".csv,.xls,.xlsx" style="display:none;" onchange="importClientsFile(this)">
                    </div>
                </div>

                <!-- Stats -->
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:16px; margin-bottom:24px;">
                    <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; padding:20px; text-align:center;">
                        <div style="font-size:32px; font-weight:700; color:var(--accent-primary);" id="clients-total">0</div>
                        <div style="color:var(--text-muted); font-size:13px;">Total clients</div>
                    </div>
                    <div style="background:linear-gradient(135deg, rgba(17,138,178,0.1), rgba(17,138,178,0.05)); border:2px solid var(--accent-secondary); border-radius:12px; padding:20px; text-align:center;">
                        <div style="font-size:32px; font-weight:700; color:var(--accent-secondary);" id="clients-b2b-count">0</div>
                        <div style="color:var(--text-muted); font-size:13px;">🏢 Professionnels</div>
                    </div>
                    <div style="background:linear-gradient(135deg, rgba(255,183,77,0.1), rgba(255,183,77,0.05)); border:2px solid var(--accent-warning); border-radius:12px; padding:20px; text-align:center;">
                        <div style="font-size:32px; font-weight:700; color:var(--accent-warning);" id="clients-b2c-count">0</div>
                        <div style="color:var(--text-muted); font-size:13px;">🏠 Particuliers</div>
                    </div>
                    <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; padding:20px; text-align:center;">
                        <div style="font-size:32px; font-weight:700; color:var(--accent-primary);" id="clients-active">0</div>
                        <div style="color:var(--text-muted); font-size:13px;">Actifs ce mois</div>
                    </div>
                </div>

                <!-- Filtres -->
                <div style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
                    <input type="text" id="clients-search" placeholder="🔍 Rechercher par nom, ville, téléphone..."
                        style="flex:1; min-width:250px; padding:12px 16px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);"
                        oninput="filterClientsPage(this.value)">
                    <select id="clients-type-filter" onchange="filterClientsPage(document.getElementById('clients-search').value)" style="padding:12px 16px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                        <option value="">Tous les types</option>
                        <option value="b2b">🏢 Professionnels (B2B)</option>
                        <option value="b2c">🏠 Particuliers (B2C)</option>
                    </select>
                </div>

                <!-- Formulaire client -->
                <div id="clients-form" style="display:none; margin-bottom:24px; padding:24px; background:var(--bg-card); border:2px solid var(--accent-primary); border-radius:12px;">
                    <h3 style="color:var(--accent-primary); margin-bottom:20px;">📝 Fiche Client</h3>
                    <input type="hidden" id="clients-edit-id">
                    <div style="display:grid; grid-template-columns:100px 1fr 1fr 180px; gap:12px; margin-bottom:12px;">
                        <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">N° Client</label><input type="text" id="clients-num" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                        <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Nom / Société *</label><input type="text" id="clients-name" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                        <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Contact</label><input type="text" id="clients-contact" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                        <div><label style="display:block; font-size:12px; font-weight:600; color:var(--accent-primary); margin-bottom:4px;">Type *</label><select id="clients-type" style="width:100%; padding:10px; background:var(--bg-primary); border:2px solid var(--accent-primary); border-radius:6px; color:var(--text-primary); font-weight:600;"><option value="b2b">🏢 Professionnel (B2B)</option><option value="b2c">🏠 Particulier (B2C)</option></select></div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Adresse</label><input type="text" id="clients-address" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                        <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Adresse 2</label><input type="text" id="clients-address2" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                    </div>
                    <div style="display:grid; grid-template-columns:100px 1fr 1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Code postal</label><input type="text" id="clients-zip" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                        <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Ville</label><input type="text" id="clients-city" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                        <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Téléphone</label><input type="tel" id="clients-phone" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                        <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Mobile</label><input type="tel" id="clients-mobile" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 120px 150px 180px; gap:12px; margin-bottom:16px;">
                        <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Email</label><input type="email" id="clients-email" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                        <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Limite crédit</label><input type="number" id="clients-credit" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                        <div><label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:4px;">Échéance</label><select id="clients-payment" style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"><option value="30 jours fin de mois">30j fin mois</option><option value="Comptant">Comptant</option><option value="15 jours">15 jours</option><option value="60 jours">60 jours</option></select></div>
                        <div><label style="display:block; font-size:12px; color:var(--accent-warning); margin-bottom:4px; font-weight:600;">💰 Liste de prix</label><select id="clients-pricelist" style="width:100%; padding:10px; background:var(--bg-primary); border:2px solid var(--accent-warning); border-radius:6px; color:var(--text-primary);"></select></div>
                    </div>
                    <div style="display:flex; gap:12px;">
                        <button class="btn btn-primary" onclick="saveClientForm()">💾 Enregistrer</button>
                        <button class="btn btn-secondary" onclick="hideClientsForm()">Annuler</button>
                    </div>
                </div>

                <!-- Table clients -->
                <div class="card">
                    <div class="table-container" style="max-height:500px; overflow-y:auto;">
                        <table>
                            <thead style="position:sticky; top:0; background:var(--bg-card); z-index:10;">
                                <tr>
                                    <th>N°</th>
                                    <th>Type</th>
                                    <th>Nom / Société</th>
                                    <th>Contact</th>
                                    <th>Ville</th>
                                    <th>Liste prix</th>
                                    <th>Téléphone</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clients-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Articles Page -->
            <div class="module-page" id="page-articles">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span></div>

                <!-- Tabs Navigation -->
                <div style="display:flex; gap:8px; margin-bottom:24px; flex-wrap:wrap; border-bottom:2px solid var(--border-color); padding-bottom:16px;">
                    <button class="art-tab active" onclick="switchArtTab('articles')" style="padding:10px 20px; background:var(--accent-primary); color:#000; border:none; border-radius:8px; font-weight:600; cursor:pointer;">📦 Articles</button>
                    <button class="art-tab" onclick="switchArtTab('categories')" style="padding:10px 20px; background:var(--bg-card); color:var(--text-primary); border:1px solid var(--border-color); border-radius:8px; font-weight:600; cursor:pointer;">🏷️ Catégories</button>
                    <button class="art-tab" onclick="switchArtTab('pricelists')" style="padding:10px 20px; background:var(--bg-card); color:var(--text-primary); border:1px solid var(--border-color); border-radius:8px; font-weight:600; cursor:pointer;">💰 Listes de Prix</button>
                    <button class="art-tab" onclick="switchArtTab('discounts')" style="padding:10px 20px; background:var(--bg-card); color:var(--text-primary); border:1px solid var(--border-color); border-radius:8px; font-weight:600; cursor:pointer;">🏷️ Rabais</button>
                </div>

                <!-- Tab: Articles -->
                <div id="art-tab-articles" class="art-tab-content">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:12px;">
                        <h2 style="font-size:22px; font-weight:700;">📦 Gestion des Articles</h2>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn btn-primary" onclick="showArticleForm()">➕ Nouvel article</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('art-import-file').click()">📥 Importer</button>
                            <button class="btn btn-secondary" onclick="exportArticlesCSV()">📤 Exporter</button>
                            <button class="btn" onclick="saveAllArticlesToDropbox()" style="background:var(--accent-secondary); color:#fff; border:none;">☁️ Dropbox</button>
                            <input type="file" id="art-import-file" accept=".csv" style="display:none;" onchange="importArticlesFile(this)">
                        </div>
                    </div>

                    <!-- Stats Articles -->
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-bottom:20px;">
                        <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; padding:16px; text-align:center;">
                            <div style="font-size:28px; font-weight:700; color:var(--accent-primary);" id="art-total">0</div>
                            <div style="color:var(--text-muted); font-size:12px;">Total articles</div>
                        </div>
                        <div style="background:linear-gradient(135deg, rgba(17,138,178,0.1), rgba(17,138,178,0.05)); border:2px solid var(--accent-secondary); border-radius:10px; padding:16px; text-align:center;">
                            <div style="font-size:28px; font-weight:700; color:var(--accent-secondary);" id="art-categories-count">0</div>
                            <div style="color:var(--text-muted); font-size:12px;">Catégories</div>
                        </div>
                        <div style="background:linear-gradient(135deg, rgba(255,183,77,0.1), rgba(255,183,77,0.05)); border:2px solid var(--accent-warning); border-radius:10px; padding:16px; text-align:center;">
                            <div style="font-size:28px; font-weight:700; color:var(--accent-warning);" id="art-pricelists-count">0</div>
                            <div style="color:var(--text-muted); font-size:12px;">Listes de prix</div>
                        </div>
                        <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; padding:16px; text-align:center;">
                            <div style="font-size:28px; font-weight:700; color:#ff6b6b;" id="art-discounts-count">0</div>
                            <div style="color:var(--text-muted); font-size:12px;">Règles rabais</div>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div style="display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
                        <input type="text" id="art-search" placeholder="🔍 Rechercher N°, désignation, origine..." style="flex:1; min-width:200px; padding:10px 14px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);" oninput="filterArticles()">
                        <select id="art-cat-filter" onchange="filterArticles()" style="padding:10px 14px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            <option value="">Toutes catégories</option>
                        </select>
                    </div>

                    <!-- Formulaire Article -->
                    <div id="art-form" style="display:none; margin-bottom:20px; padding:20px; background:var(--bg-card); border:2px solid #ff6b6b; border-radius:12px;">
                        <h3 style="color:#ff6b6b; margin-bottom:16px;">📝 Fiche Article</h3>
                        <input type="hidden" id="art-edit-id">
                        <div style="display:grid; grid-template-columns:100px 1fr 1fr; gap:12px; margin-bottom:12px;">
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">N° Article *</label><input type="text" id="art-num" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Désignation *</label><input type="text" id="art-name" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Nom latin</label><input type="text" id="art-latin" placeholder="Ex: Salmo trutta" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-style:italic;"></div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 100px 100px; gap:12px; margin-bottom:12px;">
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Catégorie</label><select id="art-category" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></select></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Origine</label><input type="text" id="art-origin" placeholder="FAO27, Suisse..." style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">N° Lot</label><input type="text" id="art-lot" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Nbre pce/colis</label><input type="number" id="art-pcs" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                        </div>
                        <div style="display:grid; grid-template-columns:120px 120px 120px 120px 100px; gap:12px; margin-bottom:12px;">
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Unité</label><select id="art-unit" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"><option value="kg">Kilo (kg)</option><option value="pce">Pièce (pce)</option><option value="l">Litre (l)</option><option value="h">Heure (h)</option><option value="pers">Par pers.</option><option value="lot">Lot</option><option value="dz">Douzaine (dz)</option></select></div>
                            <div><label style="display:block; font-size:11px; color:var(--accent-warning); margin-bottom:4px; font-weight:600;">💰 Prix B2C HT</label><input type="number" step="0.01" id="art-price-b2c" style="width:100%; padding:8px; background:var(--bg-primary); border:2px solid var(--accent-warning); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--accent-secondary); margin-bottom:4px; font-weight:600;">💼 Prix B2B HT</label><input type="number" step="0.01" id="art-price-b2b" style="width:100%; padding:8px; background:var(--bg-primary); border:2px solid var(--accent-secondary); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Prix achat HT</label><input type="number" step="0.01" id="art-cost" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">TVA %</label><input type="number" step="0.1" id="art-tva" value="2.6" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                        </div>
                        <div style="display:grid; grid-template-columns:120px 120px 150px 1fr; gap:12px; margin-bottom:12px;">
                            <div><label style="display:block; font-size:11px; color:var(--accent-primary); margin-bottom:4px; font-weight:600;">📦 Stock actuel</label><input type="number" step="0.01" id="art-stock" style="width:100%; padding:8px; background:var(--bg-primary); border:2px solid var(--accent-primary); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Stock défaut</label><input type="number" step="0.01" id="art-stock-default" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Code TVA</label><input type="text" id="art-tva-code" placeholder="VTE81, TVA77..." style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Code barre (EAN)</label><input type="text" id="art-barcode" placeholder="7640178760004" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-family:monospace;"></div>
                        </div>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <button class="btn btn-primary" onclick="saveArticle()">💾 Enregistrer</button>
                            <button class="btn btn-secondary" onclick="hideArticleForm()">Annuler</button>
                            <label style="display:flex; align-items:center; gap:6px; margin-left:auto; cursor:pointer;"><input type="checkbox" id="art-active" checked> Actif</label>
                        </div>
                    </div>

                    <!-- Table Articles -->
                    <div class="card">
                        <div class="table-container" style="max-height:450px; overflow-y:auto;">
                            <table style="font-size:13px;">
                                <thead style="position:sticky; top:0; background:var(--bg-card); z-index:10;">
                                    <tr>
                                        <th>N°</th>
                                        <th>Désignation</th>
                                        <th>Origine</th>
                                        <th>Unité</th>
                                        <th style="color:var(--accent-warning);">PV HT</th>
                                        <th>PA HT</th>
                                        <th style="color:var(--accent-primary);">Stock</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="art-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab: Catégories -->
                <div id="art-tab-categories" class="art-tab-content" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2 style="font-size:22px; font-weight:700;">🏷️ Catégories d'articles</h2>
                        <button class="btn btn-primary" onclick="showCategoryForm()">➕ Nouvelle catégorie</button>
                    </div>

                    <!-- Formulaire Catégorie -->
                    <div id="cat-form" style="display:none; margin-bottom:20px; padding:20px; background:var(--bg-card); border:2px solid var(--accent-secondary); border-radius:12px;">
                        <h3 style="color:var(--accent-secondary); margin-bottom:16px;">📝 Catégorie</h3>
                        <input type="hidden" id="cat-edit-id">
                        <div style="display:grid; grid-template-columns:100px 1fr 150px; gap:12px; margin-bottom:12px;">
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Code</label><input type="text" id="cat-code" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Nom *</label><input type="text" id="cat-name" placeholder="Ex: Poissons frais, Épicerie..." style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Icône</label><select id="cat-icon" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"><option value="🐟">🐟 Poisson</option><option value="🦐">🦐 Crustacé</option><option value="🦪">🦪 Coquillage</option><option value="🔥">🔥 Fumé</option><option value="🥫">🥫 Conserve</option><option value="🍽️">🍽️ Préparation</option><option value="❄️">❄️ Surgelé</option><option value="🛒">🛒 Épicerie</option><option value="📦">📦 Autre</option></select></div>
                        </div>
                        <div style="display:flex; gap:12px;">
                            <button class="btn btn-primary" onclick="saveCategory()">💾 Enregistrer</button>
                            <button class="btn btn-secondary" onclick="hideCategoryForm()">Annuler</button>
                        </div>
                    </div>

                    <!-- Liste Catégories -->
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:16px;" id="categories-grid"></div>
                </div>

                <!-- Tab: Listes de Prix -->
                <div id="art-tab-pricelists" class="art-tab-content" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <div>
                            <h2 style="font-size:22px; font-weight:700;">💰 Listes de Prix</h2>
                            <p style="color:var(--text-muted); font-size:13px;">Tarifs personnalisés par type de client</p>
                        </div>
                        <button class="btn btn-primary" onclick="showPricelistForm()">➕ Nouvelle liste</button>
                    </div>

                    <!-- Formulaire Liste de prix -->
                    <div id="pricelist-form" style="display:none; margin-bottom:20px; padding:20px; background:var(--bg-card); border:2px solid var(--accent-warning); border-radius:12px;">
                        <h3 style="color:var(--accent-warning); margin-bottom:16px;">📝 Liste de prix</h3>
                        <input type="hidden" id="pl-edit-id">
                        <div style="display:grid; grid-template-columns:100px 1fr 150px; gap:12px; margin-bottom:12px;">
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Code</label><input type="text" id="pl-code" placeholder="GMS, REST..." style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Nom *</label><input type="text" id="pl-name" placeholder="Ex: Restaurateurs, Grande distribution..." style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Remise globale %</label><input type="number" step="0.1" id="pl-discount" value="0" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></div>
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Description / Conditions</label>
                            <textarea id="pl-desc" rows="2" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); resize:vertical;"></textarea>
                        </div>
                        <div style="display:flex; gap:12px;">
                            <button class="btn btn-primary" onclick="savePricelist()">💾 Enregistrer</button>
                            <button class="btn btn-secondary" onclick="hidePricelistForm()">Annuler</button>
                        </div>
                    </div>

                    <!-- Liste des listes de prix -->
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:16px;" id="pricelists-grid"></div>
                </div>

                <!-- Tab: Rabais -->
                <div id="art-tab-discounts" class="art-tab-content" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <div>
                            <h2 style="font-size:22px; font-weight:700;">🏷️ Règles de Rabais</h2>
                            <p style="color:var(--text-muted); font-size:13px;">Remises par quantité et catégorie</p>
                        </div>
                        <button class="btn btn-primary" onclick="showDiscountForm()">➕ Nouvelle règle</button>
                    </div>

                    <!-- Formulaire Rabais -->
                    <div id="discount-form" style="display:none; margin-bottom:20px; padding:20px; background:var(--bg-card); border:2px solid #ff6b6b; border-radius:12px;">
                        <h3 style="color:#ff6b6b; margin-bottom:16px;">📝 Règle de rabais</h3>
                        <input type="hidden" id="disc-edit-id">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Catégorie concernée *</label><select id="disc-category" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></select></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Liste de prix (optionnel)</label><select id="disc-pricelist" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"><option value="">Toutes les listes</option></select></div>
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:8px;">Paliers de quantité</label>
                            <div id="disc-tiers" style="display:flex; flex-direction:column; gap:8px;">
                                <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center;">
                                    <input type="number" placeholder="Dès X pièces" class="disc-qty" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                    <input type="number" step="0.1" placeholder="% rabais" class="disc-pct" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                    <button type="button" onclick="removeDiscountTier(this)" style="padding:8px 12px; background:var(--accent-danger); color:#fff; border:none; border-radius:6px; cursor:pointer;">✕</button>
                                </div>
                            </div>
                            <button type="button" onclick="addDiscountTier()" style="margin-top:8px; padding:6px 12px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; font-size:12px;">➕ Ajouter un palier</button>
                        </div>
                        <div style="display:flex; gap:12px;">
                            <button class="btn btn-primary" onclick="saveDiscount()">💾 Enregistrer</button>
                            <button class="btn btn-secondary" onclick="hideDiscountForm()">Annuler</button>
                        </div>
                    </div>

                    <!-- Exemple -->
                    <div style="background:var(--bg-hover); border-radius:10px; padding:16px; margin-bottom:20px;">
                        <h4 style="color:var(--accent-primary); margin-bottom:8px;">💡 Exemple de configuration</h4>
                        <p style="color:var(--text-muted); font-size:13px;">Catégorie <strong>Épicerie</strong> : Dès 10 pièces → 5% | Dès 20 pièces → 10% | Dès 50 pièces → 15%</p>
                    </div>

                    <!-- Liste des règles -->
                    <div id="discounts-grid"></div>
                </div>
            </div>

            <!-- Modal Détails Articles/Clients -->
            <div id="art-detail-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center; padding:20px;">
                <div style="background:var(--bg-card); border-radius:16px; max-width:800px; width:100%; max-height:85vh; overflow:hidden; display:flex; flex-direction:column;">
                    <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h2 id="art-detail-title" style="font-size:22px; font-weight:700; margin-bottom:4px;"></h2>
                            <p id="art-detail-subtitle" style="color:var(--text-muted); font-size:13px;"></p>
                        </div>
                        <button onclick="closeArtDetailModal()" style="width:40px; height:40px; border-radius:50%; background:var(--bg-hover); border:none; cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center;">✕</button>
                    </div>
                    <div id="art-detail-content" style="padding:20px; overflow-y:auto; flex:1;"></div>
                </div>
            </div>

            <!-- Modal Action Client -->
            <div id="client-action-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center; padding:20px;" onclick="if(event.target === this) closeClientActionModal()">
                <div style="background:var(--bg-card); border-radius:16px; max-width:450px; width:100%; overflow:hidden;">
                    <div style="padding:24px; border-bottom:1px solid var(--border-color); text-align:center;">
                        <div style="font-size:50px; margin-bottom:12px;">👤</div>
                        <h2 id="client-action-name" style="font-size:24px; font-weight:700; margin-bottom:8px;"></h2>
                        <div id="client-action-info" style="margin-bottom:12px;"></div>
                        <div id="client-action-details"></div>
                    </div>
                    <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                        <button onclick="startOrderFromClient(parseInt(document.getElementById('client-action-modal').dataset.clientId))" style="width:100%; padding:16px; background:var(--accent-primary); color:#000; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition:all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform=''">
                            ⚡ Créer une commande
                        </button>
                        <button onclick="editClientFromModal()" style="width:100%; padding:14px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; font-size:14px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
                            ✏️ Modifier la fiche
                        </button>
                        <button onclick="closeClientActionModal()" style="width:100%; padding:12px; background:transparent; color:var(--text-muted); border:none; border-radius:10px; font-size:13px; cursor:pointer;">
                            Annuler
                        </button>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div class="module-page" id="page-reports">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span></div>
                <div class="report-grid">
                    <div class="report-card">
                        <div class="report-icon" style="background: rgba(6, 214, 160, 0.15); color: var(--accent-primary);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"/>
                                <line x1="12" y1="20" x2="12" y2="4"/>
                                <line x1="6" y1="20" x2="6" y2="14"/>
                            </svg>
                        </div>
                        <div class="report-name">Rapport des ventes</div>
                        <div class="report-desc">Analyse des ventes par période, produit et client</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon" style="background: rgba(255, 209, 102, 0.15); color: var(--accent-warning);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                                <path d="M16 3.13a4 4 0 010 7.75"/>
                            </svg>
                        </div>
                        <div class="report-name">Analyse clients</div>
                        <div class="report-desc">Comportement d'achat et segmentation clientèle</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon" style="background: rgba(157, 78, 221, 0.15); color: var(--accent-purple);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="3" width="15" height="13"/>
                                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                                <circle cx="5.5" cy="18.5" r="2.5"/>
                                <circle cx="18.5" cy="18.5" r="2.5"/>
                            </svg>
                        </div>
                        <div class="report-name">Suivi livraisons</div>
                        <div class="report-desc">Performance des livraisons et délais</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon" style="background: rgba(239, 71, 111, 0.15); color: var(--accent-danger);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                        </div>
                        <div class="report-name">Rapport financier</div>
                        <div class="report-desc">Chiffre d'affaires, marges et rentabilité</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon" style="background: rgba(255, 107, 53, 0.15); color: var(--accent-orange);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                <path d="M2 17l10 5 10-5"/>
                                <path d="M2 12l10 5 10-5"/>
                            </svg>
                        </div>
                        <div class="report-name">Nutri-Score</div>
                        <div class="report-desc">Analyse nutritionnelle des produits</div>
                    </div>
                </div>
            </div>

            <!-- ═══════════════════════════════════════════════════════════════════════
                 👥 PAGE RH - GESTION DU PERSONNEL (Admin Only)
                 ═══════════════════════════════════════════════════════════════════════ -->
            <div class="module-page" id="page-rh" data-permission="admin">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span></div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:12px;">
                    <h2 style="font-size:24px; font-weight:700; margin:0;">👥 RH Personnel</h2>
                    <div style="display:flex; gap:10px;">
                        <button onclick="openRHEmployeeModal()" class="btn btn-primary" style="padding:10px 16px;">
                            ➕ Ajouter employé
                        </button>
                        <button onclick="printRHReport()" class="btn btn-secondary" style="padding:10px 16px;">
                            🖨️ Imprimer
                        </button>
                    </div>
                </div>

                <!-- Paramètres RH -->
                <div style="background:linear-gradient(135deg, rgba(155,89,182,0.1), rgba(142,68,173,0.05)); border:1px solid rgba(155,89,182,0.3); border-radius:16px; padding:16px; margin-bottom:20px;">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                        <span style="font-size:20px;">⚙️</span>
                        <span style="font-weight:700; color:#9b59b6;">Configuration horaire</span>
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:16px;">
                        <div style="text-align:center; padding:12px; background:var(--bg-card); border-radius:10px;">
                            <div style="font-size:20px; font-weight:700; color:var(--accent-primary); font-family:'Space Mono',monospace;">8h30</div>
                            <div style="font-size:11px; color:var(--text-muted);">Par jour</div>
                        </div>
                        <div style="text-align:center; padding:12px; background:var(--bg-card); border-radius:10px;">
                            <div style="font-size:20px; font-weight:700; color:var(--accent-secondary); font-family:'Space Mono',monospace;">42.5h</div>
                            <div style="font-size:11px; color:var(--text-muted);">Par semaine</div>
                        </div>
                        <div style="text-align:center; padding:12px; background:var(--bg-card); border-radius:10px;">
                            <div style="font-size:20px; font-weight:700; color:#e74c3c; font-family:'Space Mono',monospace;">20j</div>
                            <div style="font-size:11px; color:var(--text-muted);">Vacances/an</div>
                        </div>
                        <div style="text-align:center; padding:12px; background:var(--bg-card); border-radius:10px;">
                            <div style="font-size:20px; font-weight:700; color:#f39c12; font-family:'Space Mono',monospace;">4 sem</div>
                            <div style="font-size:11px; color:var(--text-muted);">Congés payés</div>
                        </div>
                    </div>
                </div>

                <!-- Sélection mois/année et employé -->
                <div style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
                    <select id="rh-employee-filter" onchange="renderRHCalendar()" style="padding:12px 16px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:10px; color:var(--text-primary); font-size:14px; min-width:200px;">
                        <option value="all">👥 Tous les employés</option>
                    </select>
                    <select id="rh-month-select" onchange="renderRHCalendar()" style="padding:12px 16px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:10px; color:var(--text-primary); font-size:14px;">
                        <option value="0">Janvier</option>
                        <option value="1">Février</option>
                        <option value="2">Mars</option>
                        <option value="3">Avril</option>
                        <option value="4">Mai</option>
                        <option value="5">Juin</option>
                        <option value="6">Juillet</option>
                        <option value="7">Août</option>
                        <option value="8">Septembre</option>
                        <option value="9">Octobre</option>
                        <option value="10">Novembre</option>
                        <option value="11">Décembre</option>
                    </select>
                    <select id="rh-year-select" onchange="renderRHCalendar()" style="padding:12px 16px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:10px; color:var(--text-primary); font-size:14px;">
                    </select>
                    <button onclick="addRHAbsence()" class="btn" style="padding:12px 20px; background:linear-gradient(135deg, #e74c3c, #c0392b); border:none; color:white; border-radius:10px; font-weight:600;">
                        📅 Ajouter absence
                    </button>
                </div>

                <div class="grid-2" style="gap:20px;">
                    <!-- Colonne gauche - Calendrier -->
                    <div>
                        <div class="card">
                            <div class="card-header" style="background:linear-gradient(135deg, #9b59b6, #8e44ad);">
                                <h3 class="card-title" style="color:white;">📅 Calendrier <span id="rh-calendar-title"></span></h3>
                            </div>
                            <div class="card-body" style="padding:12px;">
                                <!-- Légende -->
                                <div style="display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; font-size:11px;">
                                    <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#27ae60; border-radius:3px;"></span> Travail</span>
                                    <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#3498db; border-radius:3px;"></span> Vacances</span>
                                    <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#e74c3c; border-radius:3px;"></span> Maladie</span>
                                    <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#f39c12; border-radius:3px;"></span> Congé</span>
                                    <span style="display:flex; align-items:center; gap:4px;"><span style="width:12px; height:12px; background:#95a5a6; border-radius:3px;"></span> Weekend</span>
                                </div>
                                <!-- Grille calendrier -->
                                <div id="rh-calendar-grid" style="display:grid; grid-template-columns:repeat(7, 1fr); gap:4px;">
                                    <!-- Généré par JS -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Récapitulatif mensuel -->
                        <div class="card" style="margin-top:16px;">
                            <div class="card-header">
                                <h3 class="card-title">📊 Récapitulatif mensuel</h3>
                            </div>
                            <div class="card-body">
                                <div id="rh-monthly-summary" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;">
                                    <!-- Généré par JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Colonne droite - Liste personnel -->
                    <div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">👥 Personnel & Soldes</h3>
                            </div>
                            <div class="card-body" style="padding:0;">
                                <div id="rh-employees-list" style="max-height:500px; overflow-y:auto;">
                                    <!-- Généré par JS -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Absences récentes -->
                        <div class="card" style="margin-top:16px;">
                            <div class="card-header">
                                <h3 class="card-title">📋 Absences récentes</h3>
                            </div>
                            <div class="card-body" style="padding:0;">
                                <div id="rh-absences-list" style="max-height:250px; overflow-y:auto;">
                                    <!-- Généré par JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Décompte annuel -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-header" style="background:linear-gradient(135deg, #2c3e50, #34495e);">
                        <h3 class="card-title" style="color:white;">📈 Décompte annuel <span id="rh-year-title"></span></h3>
                    </div>
                    <div class="card-body">
                        <div id="rh-annual-summary" style="overflow-x:auto;">
                            <!-- Tableau généré par JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Employé RH -->
            <div id="rh-employee-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center; padding:20px;">
                <div style="background:var(--bg-card); border-radius:20px; width:100%; max-width:500px; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
                    <div style="padding:20px; background:linear-gradient(135deg, #9b59b6, #8e44ad); color:white; flex-shrink:0;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 id="rh-employee-modal-title" style="font-weight:700; margin:0;">➕ Nouvel employé</h3>
                            <button onclick="closeRHEmployeeModal()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">×</button>
                        </div>
                    </div>
                    <div style="padding:24px; overflow-y:auto; flex:1;">
                        <input type="hidden" id="rh-emp-edit-id">
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Nom complet *</label>
                            <input type="text" id="rh-emp-name" placeholder="Jean Dupont" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Date d'entrée</label>
                                <input type="date" id="rh-emp-start-date" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </div>
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Taux d'activité %</label>
                                <input type="number" id="rh-emp-rate" value="100" min="10" max="100" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Vacances/an (jours)</label>
                                <input type="number" id="rh-emp-vacation-days" value="20" min="0" max="30" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </div>
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Solde vacances actuel</label>
                                <input type="number" id="rh-emp-vacation-balance" value="20" step="0.5" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </div>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Poste / Fonction</label>
                            <input type="text" id="rh-emp-position" placeholder="Vendeur, Manager..." style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                <input type="checkbox" id="rh-emp-active" checked style="width:20px; height:20px; accent-color:var(--accent-primary);">
                                <span>Employé actif</span>
                            </label>
                        </div>
                        <button onclick="saveRHEmployee()" class="btn btn-primary" style="width:100%; padding:14px; font-weight:700;">
                            💾 Enregistrer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal Absence RH -->
            <div id="rh-absence-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center; padding:20px;">
                <div style="background:var(--bg-card); border-radius:20px; width:100%; max-width:450px; overflow:hidden;">
                    <div style="padding:20px; background:linear-gradient(135deg, #e74c3c, #c0392b); color:white;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="font-weight:700; margin:0;">📅 Ajouter une absence</h3>
                            <button onclick="closeRHAbsenceModal()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">×</button>
                        </div>
                    </div>
                    <div style="padding:24px;">
                        <input type="hidden" id="rh-absence-edit-id">
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Employé *</label>
                            <select id="rh-absence-employee" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </select>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Type d'absence *</label>
                            <select id="rh-absence-type" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                                <option value="vacation">🏖️ Vacances</option>
                                <option value="sick">🤒 Maladie</option>
                                <option value="leave">📋 Congé (autre)</option>
                                <option value="unpaid">💸 Sans solde</option>
                            </select>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Date début *</label>
                                <input type="date" id="rh-absence-start" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </div>
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Date fin *</label>
                                <input type="date" id="rh-absence-end" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                            </div>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Remarque</label>
                            <textarea id="rh-absence-note" rows="2" placeholder="Optionnel..." style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary); resize:none;"></textarea>
                        </div>
                        <button onclick="saveRHAbsence()" class="btn btn-primary" style="width:100%; padding:14px; font-weight:700; background:linear-gradient(135deg, #e74c3c, #c0392b);">
                            💾 Enregistrer l'absence
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="module-page" id="page-settings">
                <div style="margin-bottom:16px;"><span onclick="navigateTo('dashboard')" style="cursor:pointer; color:var(--text-muted); font-size:13px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--accent-primary)'" onmouseout="this.style.background=''; this.style.color='var(--text-muted)'">← Accueil</span></div>

                <h2 style="font-size:24px; font-weight:700; margin-bottom:20px;">⚙️ Paramètres</h2>

                <div class="grid-2">
                    <!-- Colonne gauche -->
                    <div>
                        <!-- Préférences générales -->
                        <div class="card" style="margin-bottom:20px;">
                            <div class="card-header">
                                <h3 class="card-title">🎨 Préférences générales</h3>
                            </div>
                            <div class="card-body">
                                <div class="settings-section">
                                    <div class="setting-row">
                                        <div class="setting-info">
                                            <h4>Mode sombre</h4>
                                            <p>Activer le thème sombre de l'interface</p>
                                        </div>
                                        <div class="toggle active" id="darkModeToggle"></div>
                                    </div>
                                    <div class="setting-row">
                                        <div class="setting-info">
                                            <h4>Notifications</h4>
                                            <p>Recevoir des alertes pour les nouvelles commandes</p>
                                        </div>
                                        <div class="toggle active"></div>
                                    </div>
                                    <div class="setting-row">
                                        <div class="setting-info">
                                            <h4>Sons</h4>
                                            <p>Activer les sons de notification</p>
                                        </div>
                                        <div class="toggle"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Paramètres du compte -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">🏢 Paramètres entreprise</h3>
                            </div>
                            <div class="card-body">
                                <div class="settings-form">
                                    <div class="form-group">
                                        <label>Nom de l'entreprise</label>
                                        <input type="text" id="settings-company" value="La Traversette" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary);">
                                    </div>
                                    <div class="form-group">
                                        <label>Email</label>
                                        <input type="email" id="settings-email" value="contact@traversette.ch" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary);">
                                    </div>
                                    <div class="form-group">
                                        <label>Téléphone</label>
                                        <input type="tel" id="settings-phone" value="+41 21 XXX XX XX" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary);">
                                    </div>
                                    <div class="form-group">
                                        <label>Devise</label>
                                        <select id="settings-currency" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary);">
                                            <option value="CHF" selected>CHF (Fr.)</option>
                                            <option value="EUR">EUR (€)</option>
                                            <option value="USD">USD ($)</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" onclick="saveCompanySettings()" style="width:100%;">💾 Enregistrer</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Colonne droite - Dropbox -->
                    <div>
                        <div class="card" style="border:2px solid var(--accent-secondary);" data-permission="settings:dropbox">
                            <div class="card-header" style="background:var(--accent-secondary)15;">
                                <h3 class="card-title" style="display:flex; align-items:center; gap:10px;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="color:var(--accent-secondary);">
                                        <path d="M12 2L6 6l6 4-6 4 6 4 6-4-6-4 6-4-6-4zm0 8.5L6 14.5l6 4 6-4-6-4z"/>
                                    </svg>
                                    Dropbox - Sauvegarde Cloud
                                </h3>
                            </div>
                            <div class="card-body">
                                <!-- Status connexion -->
                                <div id="dropbox-status" style="padding:12px 16px; border-radius:10px; margin-bottom:16px; display:flex; align-items:center; gap:10px; background:var(--bg-primary);">
                                    <span id="dropbox-status-icon" style="font-size:20px;">⚪</span>
                                    <div>
                                        <div id="dropbox-status-text" style="font-weight:600;">Non configuré</div>
                                        <div id="dropbox-status-detail" style="font-size:12px; color:var(--text-muted);">Entrez votre token d'accès</div>
                                    </div>
                                </div>

                                <!-- Token d'accès -->
                                <div class="form-group" style="margin-bottom:16px;">
                                    <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                        🔑 Token d'accès Dropbox
                                        <a href="https://www.dropbox.com/developers/apps" target="_blank" style="font-size:11px; color:var(--accent-secondary);">(Console Dropbox)</a>
                                    </label>
                                    <input type="password" id="dropbox-token" placeholder="sl.xxxxxxxxxxxxxxx..."
                                        style="width:100%; padding:12px; border-radius:8px; border:2px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary); font-family:monospace;">
                                    <div style="font-size:11px; color:var(--accent-warning); margin-top:8px; padding:8px; background:var(--accent-warning)10; border-radius:6px;">
                                        ⚠️ <strong>Important :</strong> Dans la console Dropbox, mettez "Access token expiration" sur <strong>"No expiration"</strong> avant de générer le token !
                                    </div>
                                </div>

                                <!-- Chemin de base -->
                                <div class="form-group" style="margin-bottom:16px;">
                                    <label style="margin-bottom:8px; display:block;">📁 Chemin de base dans Dropbox</label>
                                    <input type="text" id="dropbox-base-path" value="/TRAKIO" placeholder="/TRAKIO"
                                        style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary);">
                                </div>

                                <!-- Toggle synchronisation -->
                                <div class="setting-row" style="padding:12px 0; border-top:1px solid var(--border-color); border-bottom:1px solid var(--border-color); margin-bottom:16px;">
                                    <div class="setting-info">
                                        <h4>Synchronisation automatique</h4>
                                        <p>Sync toutes les 30 sec. pour travail multi-utilisateurs</p>
                                    </div>
                                    <div class="toggle" id="dropbox-auto-sync"></div>
                                </div>

                                <!-- Info multi-utilisateurs -->
                                <div style="padding:14px; background:linear-gradient(135deg, var(--accent-primary)15, var(--accent-secondary)10); border-radius:10px; margin-bottom:16px; border-left:4px solid var(--accent-primary);">
                                    <div style="font-weight:700; color:var(--accent-primary); margin-bottom:6px;">👥 Mode Multi-Utilisateurs</div>
                                    <div style="font-size:12px; color:var(--text-secondary); line-height:1.6;">
                                        Activez la sync automatique pour permettre à plusieurs personnes de travailler simultanément sur différents appareils.<br>
                                        Les données sont synchronisées toutes les 30 secondes.
                                    </div>
                                </div>

                                <!-- Boutons actions -->
                                <div style="display:flex; flex-direction:column; gap:10px;">
                                    <button onclick="testDropboxConnection()" class="btn btn-secondary" style="width:100%; padding:12px; display:flex; align-items:center; justify-content:center; gap:8px;">
                                        🔗 Tester la connexion
                                    </button>
                                    <button onclick="createDropboxFolders()" class="btn btn-secondary" style="width:100%; padding:12px; display:flex; align-items:center; justify-content:center; gap:8px;">
                                        📂 Créer les dossiers
                                    </button>
                                    <button onclick="saveDropboxSettings()" class="btn btn-primary" style="width:100%; padding:14px; font-weight:700;">
                                        💾 Enregistrer la configuration
                                    </button>
                                    <div style="border-top:1px solid var(--border-color); padding-top:12px; margin-top:6px;">
                                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                            <button onclick="syncFromDropbox(false)" class="btn" style="padding:12px; background:var(--accent-secondary); color:#fff; border:none; font-weight:600; border-radius:10px;">
                                                📥 Récupérer
                                            </button>
                                            <button onclick="syncAllToDropbox()" class="btn" style="padding:12px; background:var(--accent-primary); color:#000; border:none; font-weight:600; border-radius:10px;">
                                                📤 Envoyer
                                            </button>
                                        </div>
                                        <button onclick="forceSyncNow()" class="btn" style="width:100%; padding:14px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color:#000; border:none; font-weight:700; border-radius:10px; margin-top:10px;">
                                            🔄 Synchronisation complète
                                        </button>
                                        <div style="font-size:11px; color:var(--text-muted); text-align:center; margin-top:6px;">
                                            Télécharge puis envoie toutes les données
                                        </div>
                                    </div>
                                </div>

                                <!-- Structure des dossiers -->
                                <div style="margin-top:20px; padding:16px; background:var(--bg-primary); border-radius:10px;">
                                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:10px; text-transform:uppercase;">Structure des dossiers</div>
                                    <div style="font-family:monospace; font-size:13px; line-height:1.8; color:var(--text-secondary);">
                                        <div>📁 <span id="dropbox-path-display">/TRAKIO</span></div>
                                        <div style="padding-left:20px;">├── 📁 Commandes</div>
                                        <div style="padding-left:40px;">└── 📁 <span style="color:var(--text-muted);">YYYY-MM</span></div>
                                        <div style="padding-left:20px;">├── 📁 Clients</div>
                                        <div style="padding-left:20px;">├── 📁 Articles</div>
                                        <div style="padding-left:20px;">├── 📁 Factures</div>
                                        <div style="padding-left:20px;">├── 📁 Rapports</div>
                                        <div style="padding-left:20px;">└── 📁 System <span style="font-size:11px; color:var(--accent-primary);">(sync multi-users)</span></div>
                                        <div style="padding-left:40px;">└── 📁 <span style="color:var(--accent-warning);">Backups</span> <span style="font-size:11px; color:var(--accent-warning);">(sauvegardes complètes)</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gestion des utilisateurs -->
                        <div class="card" style="margin-top:20px;" id="users-management-card">
                            <div class="card-header">
                                <h3 class="card-title">👥 Gestion des Utilisateurs</h3>
                            </div>
                            <div class="card-body">
                                <!-- Bouton Ajouter bien visible -->
                                <button onclick="showAddUserModal()" class="btn btn-primary" style="width:100%; padding:14px; margin-bottom:20px; font-size:15px; font-weight:600;">
                                    ➕ Ajouter un utilisateur
                                </button>

                                <!-- Rôles expliqués -->
                                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:20px;">
                                    <div style="padding:14px; background:var(--accent-danger)10; border:2px solid var(--accent-danger); border-radius:10px; text-align:center;">
                                        <div style="font-size:24px; margin-bottom:6px;">👑</div>
                                        <div style="font-weight:700; color:var(--accent-danger);">Admin</div>
                                        <div style="font-size:11px; color:var(--text-muted); margin-top:4px;">Accès complet à tout</div>
                                    </div>
                                    <div style="padding:14px; background:var(--accent-warning)10; border:2px solid var(--accent-warning); border-radius:10px; text-align:center;">
                                        <div style="font-size:24px; margin-bottom:6px;">⭐</div>
                                        <div style="font-weight:700; color:var(--accent-warning);">Super-User</div>
                                        <div style="font-size:11px; color:var(--text-muted); margin-top:4px;">Modules + certains param.</div>
                                    </div>
                                    <div style="padding:14px; background:var(--accent-primary)10; border:2px solid var(--accent-primary); border-radius:10px; text-align:center;">
                                        <div style="font-size:24px; margin-bottom:6px;">👤</div>
                                        <div style="font-weight:700; color:var(--accent-primary);">User</div>
                                        <div style="font-size:11px; color:var(--text-muted); margin-top:4px;">Modules autorisés uniquement</div>
                                    </div>
                                </div>

                                <!-- Liste des utilisateurs -->
                                <div id="users-list" style="display:flex; flex-direction:column; gap:10px;">
                                    <!-- Généré par JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Numérotation et Préfixes -->
                        <div class="card" style="margin-top:20px; border:2px solid var(--accent-orange);" data-permission="settings:numbering">
                            <div class="card-header">
                                <h3 class="card-title">🔢 Numérotation & Préfixes</h3>
                            </div>
                            <div class="card-body">
                                <p style="color:var(--text-muted); margin-bottom:20px; font-size:13px;">
                                    Configurez les préfixes et tranches de numéros pour chaque type d'élément.
                                </p>

                                <!-- Commandes -->
                                <div style="background:var(--bg-primary); border-radius:10px; padding:16px; margin-bottom:16px; border-left:4px solid var(--accent-primary);">
                                    <div style="font-weight:700; color:var(--accent-primary); margin-bottom:12px;">📋 Commandes</div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Préfixe</label>
                                            <input type="text" id="num-order-prefix" value="CMD" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Début tranche</label>
                                            <input type="number" id="num-order-start" value="1" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Prochain N°</label>
                                            <input type="number" id="num-order-next" value="1" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-weight:700; color:var(--accent-primary);">
                                        </div>
                                    </div>
                                    <div style="margin-top:8px; font-size:11px; color:var(--text-muted);">
                                        Format: <span id="num-order-preview" style="font-family:'Space Mono',monospace; color:var(--accent-primary);">CMD-20241128-001</span>
                                    </div>
                                </div>

                                <!-- Clients -->
                                <div style="background:var(--bg-primary); border-radius:10px; padding:16px; margin-bottom:16px; border-left:4px solid var(--accent-secondary);">
                                    <div style="font-weight:700; color:var(--accent-secondary); margin-bottom:12px;">👥 Clients</div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Préfixe</label>
                                            <input type="text" id="num-client-prefix" value="CLI" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Début tranche</label>
                                            <input type="number" id="num-client-start" value="1000" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Prochain N°</label>
                                            <input type="number" id="num-client-next" value="1000" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-weight:700; color:var(--accent-secondary);">
                                        </div>
                                    </div>
                                    <div style="margin-top:8px; font-size:11px; color:var(--text-muted);">
                                        Format: <span id="num-client-preview" style="font-family:'Space Mono',monospace; color:var(--accent-secondary);">CLI-1000</span>
                                    </div>
                                </div>

                                <!-- Articles -->
                                <div style="background:var(--bg-primary); border-radius:10px; padding:16px; margin-bottom:16px; border-left:4px solid var(--accent-warning);">
                                    <div style="font-weight:700; color:var(--accent-warning); margin-bottom:12px;">📦 Articles</div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Préfixe</label>
                                            <input type="text" id="num-article-prefix" value="ART" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Début tranche</label>
                                            <input type="number" id="num-article-start" value="100" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Prochain N°</label>
                                            <input type="number" id="num-article-next" value="100" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-weight:700; color:var(--accent-warning);">
                                        </div>
                                    </div>
                                    <div style="margin-top:8px; font-size:11px; color:var(--text-muted);">
                                        Format: <span id="num-article-preview" style="font-family:'Space Mono',monospace; color:var(--accent-warning);">ART-100</span>
                                    </div>
                                </div>

                                <!-- Options -->
                                <div style="background:var(--bg-primary); border-radius:10px; padding:16px; margin-bottom:16px;">
                                    <div style="font-weight:700; color:var(--text-primary); margin-bottom:12px;">⚙️ Options</div>
                                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin-bottom:8px;">
                                        <input type="checkbox" id="num-include-date" checked style="width:18px; height:18px; accent-color:var(--accent-primary);">
                                        <span>Inclure la date dans les numéros de commande (YYYYMMDD)</span>
                                    </label>
                                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                        <input type="checkbox" id="num-zero-padding" checked style="width:18px; height:18px; accent-color:var(--accent-primary);">
                                        <span>Ajouter des zéros devant (ex: 001, 002...)</span>
                                    </label>
                                </div>

                                <button onclick="saveNumberingConfig()" class="btn btn-primary" style="width:100%; padding:14px;">
                                    💾 Enregistrer la configuration
                                </button>
                            </div>
                        </div>

                        <!-- Données locales -->
                        <div class="card" style="margin-top:20px;">
                            <div class="card-header">
                                <h3 class="card-title">💾 Données locales</h3>
                            </div>
                            <div class="card-body">
                                <!-- Note importante sur la persistance -->
                                <div style="padding:14px; background:linear-gradient(135deg, var(--accent-primary)15, var(--accent-secondary)10); border-radius:10px; margin-bottom:16px; border-left:4px solid var(--accent-primary);">
                                    <div style="font-weight:700; color:var(--accent-primary); margin-bottom:6px;">📌 Vos données sont sauvegardées automatiquement</div>
                                    <div style="font-size:12px; color:var(--text-secondary); line-height:1.6;">
                                        Les clients, articles et commandes sont stockés dans le navigateur (localStorage).<br>
                                        <strong>Ils ne seront jamais effacés</strong> lors des mises à jour de TRAKIO.<br>
                                        Pour une sauvegarde externe, utilisez Dropbox ou exportez en JSON ci-dessous.
                                    </div>
                                </div>

                                <div style="display:flex; flex-direction:column; gap:10px;">
                                    <button onclick="exportAllData()" class="btn btn-secondary" style="width:100%; padding:12px;" data-permission="settings:export-data">
                                        📤 Exporter toutes les données (JSON)
                                    </button>
                                    <button onclick="document.getElementById('import-data-file').click()" class="btn btn-secondary" style="width:100%; padding:12px;" data-permission="settings:import-data">
                                        📥 Importer des données
                                    </button>
                                    <input type="file" id="import-data-file" accept=".json" onchange="importAllData(this)" style="display:none;">
                                    <button onclick="clearAllData()" class="btn btn-secondary" style="width:100%; padding:12px; color:var(--accent-danger);" data-permission="settings:reset-data">
                                        🗑️ Réinitialiser toutes les données
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- MISE À JOUR TRAKIO - Admin uniquement -->
                        <div class="card" style="margin-top:20px; border:2px solid var(--accent-warning);" data-permission="admin">
                            <div class="card-header" style="background:linear-gradient(135deg, var(--accent-warning), var(--accent-orange));">
                                <h3 class="card-title" style="color:#000;">🔄 Mise à jour TRAKIO</h3>
                            </div>
                            <div class="card-body">
                                <!-- Avertissement -->
                                <div style="padding:14px; background:linear-gradient(135deg, var(--accent-warning)20, var(--accent-orange)10); border-radius:10px; margin-bottom:16px; border-left:4px solid var(--accent-warning);">
                                    <div style="font-weight:700; color:var(--accent-warning); margin-bottom:6px;">⚠️ Procédure de mise à jour</div>
                                    <div style="font-size:12px; color:var(--text-secondary); line-height:1.8;">
                                        <strong>1.</strong> Cliquez sur "Créer une sauvegarde" ci-dessous<br>
                                        <strong>2.</strong> Téléchargez la nouvelle version de TRAKIO<br>
                                        <strong>3.</strong> Remplacez l'ancien fichier par le nouveau<br>
                                        <strong>4.</strong> Rafraîchissez la page - vos données sont conservées !<br>
                                        <strong>5.</strong> Si problème, restaurez depuis la sauvegarde
                                    </div>
                                </div>

                                <!-- Version actuelle -->
                                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:var(--bg-primary); border-radius:10px; margin-bottom:16px;">
                                    <div>
                                        <div style="font-size:12px; color:var(--text-muted);">Version installée</div>
                                        <div style="font-weight:700; font-family:'Space Mono',monospace;" id="trakio-version">2.8.6</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-size:12px; color:var(--text-muted);">Dernière mise à jour</div>
                                        <div style="font-weight:600;" id="trakio-update-date">-</div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div style="display:flex; flex-direction:column; gap:10px;">
                                    <button onclick="createTrakioBackup()" class="btn" style="width:100%; padding:14px; background:var(--accent-primary); color:#000; border:none; font-weight:700; border-radius:10px;">
                                        💾 Créer une sauvegarde complète
                                    </button>
                                    <button onclick="document.getElementById('restore-backup-file').click()" class="btn btn-secondary" style="width:100%; padding:12px;">
                                        📥 Restaurer depuis une sauvegarde
                                    </button>
                                    <input type="file" id="restore-backup-file" accept=".json" onchange="restoreTrakioBackup(this)" style="display:none;">
                                </div>

                                <!-- Historique des sauvegardes -->
                                <div style="margin-top:16px; padding:12px; background:var(--bg-primary); border-radius:10px;">
                                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:8px;">📋 Dernières sauvegardes</div>
                                    <div id="backup-history" style="font-size:12px; color:var(--text-secondary);">
                                        Aucune sauvegarde récente
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- HISTORIQUE DES CONNEXIONS - Admin uniquement -->
                        <div class="card" style="margin-top:20px; border:2px solid #9c88ff;" data-permission="admin">
                            <div class="card-header" style="background:linear-gradient(135deg, #9c88ff, #7158e2);">
                                <h3 class="card-title" style="color:#fff;">🔐 Historique des connexions</h3>
                            </div>
                            <div class="card-body">
                                <!-- Stats rapides -->
                                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-bottom:16px;">
                                    <div style="text-align:center; padding:12px; background:rgba(6,214,160,0.15); border-radius:10px;">
                                        <div id="log-count-login" style="font-size:20px; font-weight:700; color:var(--accent-primary);">0</div>
                                        <div style="font-size:10px; color:var(--text-muted);">Connexions</div>
                                    </div>
                                    <div style="text-align:center; padding:12px; background:rgba(17,138,178,0.15); border-radius:10px;">
                                        <div id="log-count-logout" style="font-size:20px; font-weight:700; color:#118ab2;">0</div>
                                        <div style="font-size:10px; color:var(--text-muted);">Déconnexions</div>
                                    </div>
                                    <div style="text-align:center; padding:12px; background:rgba(255,183,77,0.15); border-radius:10px;">
                                        <div id="log-count-auto" style="font-size:20px; font-weight:700; color:#ffb74d;">0</div>
                                        <div style="font-size:10px; color:var(--text-muted);">Auto (1h)</div>
                                    </div>
                                    <div style="text-align:center; padding:12px; background:rgba(255,107,107,0.15); border-radius:10px;">
                                        <div id="log-count-failed" style="font-size:20px; font-weight:700; color:#ff6b6b;">0</div>
                                        <div style="font-size:10px; color:var(--text-muted);">Échecs</div>
                                    </div>
                                </div>
                                
                                <!-- Liste des connexions -->
                                <div style="max-height:300px; overflow-y:auto; border:1px solid var(--border-color); border-radius:10px;">
                                    <table style="width:100%; border-collapse:collapse; font-size:12px;">
                                        <thead style="background:var(--bg-primary); position:sticky; top:0;">
                                            <tr>
                                                <th style="padding:10px; text-align:left; font-weight:600;">Utilisateur</th>
                                                <th style="padding:10px; text-align:center; font-weight:600;">Action</th>
                                                <th style="padding:10px; text-align:center; font-weight:600;">Date</th>
                                                <th style="padding:10px; text-align:center; font-weight:600;">Heure</th>
                                            </tr>
                                        </thead>
                                        <tbody id="connection-logs-tbody">
                                            <!-- Généré par JS -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Actions -->
                                <div style="margin-top:12px; display:flex; gap:10px;">
                                    <button onclick="refreshConnectionLogs()" class="btn btn-secondary" style="flex:1; padding:10px; font-size:12px;">
                                        🔄 Rafraîchir
                                    </button>
                                    <button onclick="exportConnectionLogs()" class="btn btn-secondary" style="flex:1; padding:10px; font-size:12px;">
                                        📤 Exporter
                                    </button>
                                    <button onclick="clearConnectionLogs()" class="btn btn-secondary" style="flex:1; padding:10px; font-size:12px; color:#ff6b6b;">
                                        🗑️ Vider
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Ajout/Modification Utilisateur -->
    <div id="user-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:2000; display:none; align-items:center; justify-content:center;">
        <div style="background:var(--bg-card); border-radius:20px; width:90%; max-width:500px; max-height:90vh; display:flex; flex-direction:column; overflow:hidden;">
            <!-- Header fixe -->
            <div style="padding:20px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color:#000; flex-shrink:0;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 id="user-modal-title" style="font-weight:700;">➕ Nouvel Utilisateur</h3>
                    <button onclick="closeUserModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">×</button>
                </div>
            </div>

            <!-- Contenu scrollable -->
            <div style="padding:24px; overflow-y:auto; flex:1;">
                <input type="hidden" id="user-edit-id">

                <div style="margin-bottom:16px;">
                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Nom complet *</label>
                    <input type="text" id="user-name" placeholder="Pascal Dupont" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                </div>

                <div style="display:flex; gap:16px; margin-bottom:16px;">
                    <div>
                        <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Initiales</label>
                        <input type="text" id="user-initials" placeholder="PD" maxlength="3" style="width:80px; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary); text-transform:uppercase; text-align:center; font-weight:700;">
                    </div>
                    <div>
                        <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Code PIN *</label>
                        <input type="password" id="user-pin" placeholder="••••" maxlength="4" style="width:100px; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary); text-align:center; font-size:18px; letter-spacing:6px;">
                    </div>
                </div>

                <div style="margin-bottom:16px;">
                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Rôle *</label>
                    <select id="user-role" onchange="updatePermissionsVisibility()" style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                        <option value="user">👤 User - Accès limité</option>
                        <option value="superuser">⭐ Super-User - Accès étendu</option>
                        <option value="admin">👑 Admin - Accès complet</option>
                    </select>
                </div>

                <!-- Permissions dynamiques pour User et Super-User -->
                <div id="user-permissions-section" style="padding:16px; background:var(--bg-primary); border-radius:10px;">
                    <!-- Boutons rapides -->
                    <div style="display:flex; gap:8px; margin-bottom:12px;">
                        <button type="button" onclick="toggleAllPermissions(true)" style="flex:1; padding:8px; background:var(--accent-primary); color:#000; border:none; border-radius:6px; cursor:pointer; font-size:12px;">✅ Tout cocher</button>
                        <button type="button" onclick="toggleAllPermissions(false)" style="flex:1; padding:8px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; font-size:12px;">⬜ Tout décocher</button>
                    </div>

                    <!-- Modules -->
                    <div style="margin-bottom:16px;">
                        <label style="display:block; font-size:13px; font-weight:600; color:var(--accent-primary); margin-bottom:10px;">📱 Modules</label>
                        <div id="permissions-modules" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <!-- Généré dynamiquement -->
                        </div>
                    </div>

                    <!-- Actions/Fonctionnalités -->
                    <div style="margin-bottom:16px; padding-top:16px; border-top:1px solid var(--border-color);">
                        <label style="display:block; font-size:13px; font-weight:600; color:var(--accent-warning); margin-bottom:10px;">⚙️ Actions</label>
                        <div id="permissions-actions" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <!-- Généré dynamiquement -->
                        </div>
                    </div>

                    <!-- Paramètres sensibles (Super-User uniquement) -->
                    <div id="superuser-settings" style="padding-top:16px; border-top:1px solid var(--border-color); display:none;">
                        <label style="display:block; font-size:13px; font-weight:600; color:var(--accent-danger); margin-bottom:10px;">🔒 Paramètres sensibles</label>
                        <div id="permissions-settings" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <!-- Généré dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer fixe avec boutons -->
            <div style="padding:16px 24px; background:var(--bg-card); border-top:1px solid var(--border-color); display:flex; gap:12px; flex-shrink:0;">
                <button onclick="saveUser()" class="btn btn-primary" style="flex:1; padding:14px; font-weight:600;">💾 Enregistrer</button>
                <button onclick="closeUserModal()" class="btn btn-secondary" style="padding:14px;">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal Import Clients - Choix du mode -->
    <div id="import-clients-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:5000; justify-content:center; align-items:center; padding:20px;" onclick="if(event.target === this) closeImportClientsModal()">
        <div style="background:var(--bg-card); border-radius:20px; max-width:450px; width:100%; overflow:hidden;">
            <!-- Header -->
            <div style="padding:24px; background:linear-gradient(135deg, var(--accent-secondary), var(--accent-primary)); text-align:center;">
                <div style="font-size:50px; margin-bottom:10px;">📥</div>
                <h2 style="color:#000; font-weight:700; margin:0;">Import Clients</h2>
                <p style="color:#000; opacity:0.8; margin:8px 0 0;">Choisissez le mode d'import</p>
            </div>
            
            <!-- Options -->
            <div style="padding:24px;">
                <div id="import-mode-replace" onclick="selectImportMode('replace')" style="background:var(--bg-primary); border:2px solid var(--accent-primary); border-radius:12px; padding:20px; margin-bottom:16px; cursor:pointer; transition:all 0.2s;">
                    <div style="display:flex; align-items:center; gap:16px;">
                        <div style="width:50px; height:50px; background:var(--accent-primary); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px;">🔄</div>
                        <div style="flex:1;">
                            <div style="font-weight:700; font-size:16px; color:var(--text-primary);">Remplacer tout</div>
                            <div style="color:var(--text-muted); font-size:13px; margin-top:4px;">Supprime tous les clients existants et importe le fichier</div>
                        </div>
                        <div id="import-check-replace" style="width:24px; height:24px; border-radius:50%; background:var(--accent-primary); display:flex; align-items:center; justify-content:center; color:#000; font-weight:bold;">✓</div>
                    </div>
                </div>
                
                <div id="import-mode-update" onclick="selectImportMode('update')" style="background:var(--bg-primary); border:2px solid var(--border-color); border-radius:12px; padding:20px; cursor:pointer; transition:all 0.2s;">
                    <div style="display:flex; align-items:center; gap:16px;">
                        <div style="width:50px; height:50px; background:var(--bg-hover); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px;">➕</div>
                        <div style="flex:1;">
                            <div style="font-weight:700; font-size:16px; color:var(--text-primary);">Mettre à jour / Ajouter</div>
                            <div style="color:var(--text-muted); font-size:13px; margin-top:4px;">Met à jour les clients existants, ajoute les nouveaux</div>
                        </div>
                        <div id="import-check-update" style="width:24px; height:24px; border-radius:50%; background:var(--bg-hover); display:none; align-items:center; justify-content:center; color:#000; font-weight:bold;">✓</div>
                    </div>
                </div>
                
                <!-- Info clients actuels -->
                <div style="background:var(--bg-primary); border-radius:10px; padding:14px; margin-top:20px; text-align:center;">
                    <span style="color:var(--text-muted); font-size:13px;">Clients actuels : </span>
                    <span id="import-current-count" style="font-weight:700; color:var(--accent-primary); font-family:'Space Mono',monospace;">0</span>
                </div>
            </div>
            
            <!-- Boutons -->
            <div style="padding:16px 24px; border-top:1px solid var(--border-color); display:flex; gap:12px;">
                <button onclick="closeImportClientsModal()" style="flex:1; padding:14px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; font-size:14px; font-weight:600; cursor:pointer;">Annuler</button>
                <button onclick="confirmImportClients()" style="flex:2; padding:14px; background:var(--accent-primary); color:#000; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer;">📂 Choisir fichier</button>
            </div>
        </div>
    </div>

    <!-- Modal Connexion / Changement utilisateur -->
    <div id="login-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:3000; align-items:center; justify-content:center;">
        <div style="background:var(--bg-card); border-radius:24px; width:90%; max-width:400px; overflow:hidden; text-align:center;">
            <div style="padding:30px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));">
                <div style="font-size:50px; margin-bottom:10px;">🐟</div>
                <h2 style="color:#000; font-weight:700;">TRAKIO</h2>
                <p style="color:#000; opacity:0.7; font-size:14px;">Sélectionnez votre profil</p>
            </div>
            <div style="padding:24px;">
                <div id="login-users-list" style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px; max-height:300px; overflow-y:auto;">
                    <!-- Généré par JS -->
                </div>
                <div id="login-pin-section" style="display:none;">
                    <p style="color:var(--text-muted); margin-bottom:12px;">Entrez votre code PIN</p>
                    <input type="password" id="login-pin" maxlength="4" style="width:150px; padding:16px; border:2px solid var(--accent-primary); border-radius:12px; background:var(--bg-primary); color:var(--text-primary); text-align:center; font-size:28px; letter-spacing:12px;" onkeyup="checkLoginPin(event)">
                    <button onclick="cancelLogin()" style="display:block; margin:16px auto 0; background:none; border:none; color:var(--text-muted); cursor:pointer;">← Retour</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Toggle des sections de navigation repliables
        function toggleNavSection(titleElement) {
            const section = titleElement.parentElement;
            const content = section.querySelector('.nav-section-content');

            titleElement.classList.toggle('collapsed');
            content.classList.toggle('collapsed');

            // Sauvegarder l'état dans localStorage
            const sectionId = content.id;
            const isCollapsed = content.classList.contains('collapsed');
            localStorage.setItem('nav_' + sectionId, isCollapsed ? 'collapsed' : 'expanded');
        }

        // Restaurer l'état des sections au chargement
        function restoreNavSections() {
            document.querySelectorAll('.nav-section-content').forEach(content => {
                const savedState = localStorage.getItem('nav_' + content.id);
                // Si explicitement ouvert par l'utilisateur, ouvrir
                if (savedState === 'expanded') {
                    content.classList.remove('collapsed');
                    const title = content.previousElementSibling;
                    if (title) title.classList.remove('collapsed');
                }
                // Sinon, garder l'état par défaut du HTML (fermé)
            });
        }

        // Appeler au chargement
        document.addEventListener('DOMContentLoaded', restoreNavSections);

        // Navigation
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.module-page');
        const pageTitle = document.getElementById('pageTitle');

        const pageTitles = {
            'dashboard': 'Accueil',
            'analyses': '📊 Analyses',
            'orders': 'Commandes',
            'tracking': 'Suivi',
            'nutriscore': 'Nutri-Score Generator',
            'prix-traversette': 'Prix Traversette',
            'prix-fournisseurs': '💰 Prix Fournisseurs',
            'cours-poissons': 'Cours Poissons Frais',
            'myfish': '🐟 MyFish - Commandes',
            'shop': '🛍️ Shop Hub',
            'shopify': '🛍️ Shopify - Synchronisation',
            'quickorder': '⚡ Prise de Commande',
            'clients': '👥 Gestion Clients',
            'articles': '📦 Gestion Articles',
            'reports': 'Rapports',
            'rh': '👥 RH Personnel',
            'settings': 'Paramètres'
        };

        // ========== RECHERCHE GLOBALE ==========
        let globalSearchTimeout = null;

        function globalSearch(query) {
            clearTimeout(globalSearchTimeout);

            if (!query || query.length < 2) {
                document.getElementById('global-search-results').style.display = 'none';
                return;
            }

            globalSearchTimeout = setTimeout(() => {
                performGlobalSearch(query);
            }, 200);
        }

        function performGlobalSearch(query) {
            const q = query.toLowerCase();
            const results = [];

            // Recherche dans les clients
            const clients = QOData?.clients || [];
            const matchedClients = clients.filter(c =>
                (c.name && c.name.toLowerCase().includes(q)) ||
                (c.lastname && c.lastname.toLowerCase().includes(q)) ||
                (c.firstname && c.firstname.toLowerCase().includes(q)) ||
                (c.contact && c.contact.toLowerCase().includes(q)) ||
                (c.city && c.city.toLowerCase().includes(q)) ||
                (c.phone && c.phone.includes(q)) ||
                (c.mobile && c.mobile.includes(q)) ||
                (c.email && c.email.toLowerCase().includes(q))
            ).slice(0, 5);

            matchedClients.forEach(c => {
                const type = (c.clientType || 'b2b').toLowerCase();
                const displayName = c.name || `${c.lastname || ''} ${c.firstname || ''}`.trim();
                results.push({
                    type: 'client',
                    icon: type === 'b2c' ? '🏠' : '🏢',
                    title: displayName,
                    subtitle: `${type.toUpperCase()} • ${c.city || '-'} • ${c.mobile || c.phone || '-'}`,
                    action: () => { navigateTo('clients'); setTimeout(() => { document.getElementById('clients-search').value = displayName; filterClientsPage(displayName); }, 200); }
                });
            });

            // Recherche dans les articles
            const articles = QOData?.articles || [];
            const matchedArticles = articles.filter(a =>
                (a.code && a.code.toLowerCase().includes(q)) ||
                (a.name && a.name.toLowerCase().includes(q)) ||
                (a.category && a.category.toLowerCase().includes(q))
            ).slice(0, 5);

            matchedArticles.forEach(a => {
                results.push({
                    type: 'article',
                    icon: '🏷️',
                    title: a.name || a.code,
                    subtitle: `${a.code || '-'} • ${a.category || '-'} • ${a.priceB2C ? a.priceB2C.toFixed(2) + ' CHF' : '-'}`,
                    action: () => { navigateTo('articles'); setTimeout(() => { document.getElementById('art-search').value = a.name || a.code; filterArticlesTable(); }, 200); }
                });
            });

            // Recherche dans les commandes MyFish
            const mfOrders = JSON.parse(localStorage.getItem('mf_orders') || '[]');
            const matchedOrders = mfOrders.filter(o =>
                (o.orderNumber && o.orderNumber.toLowerCase().includes(q)) ||
                (o.clientName && o.clientName.toLowerCase().includes(q)) ||
                (o.storeName && o.storeName.toLowerCase().includes(q))
            ).slice(0, 5);

            matchedOrders.forEach(o => {
                results.push({
                    type: 'order',
                    icon: '🐟',
                    title: `#${o.orderNumber}`,
                    subtitle: `${o.clientName || '-'} • ${o.storeName || '-'} • ${o.total ? o.total.toFixed(2) + ' CHF' : '-'}`,
                    action: () => { navigateTo('myfish'); }
                });
            });

            // Recherche dans les commandes Shopify
            const shopifyOrders = ShopifyData?.orders || [];
            const matchedShopify = shopifyOrders.filter(o =>
                (o.name && o.name.toLowerCase().includes(q)) ||
                (o.customer && o.customer.toLowerCase().includes(q)) ||
                (o.email && o.email.toLowerCase().includes(q))
            ).slice(0, 5);

            matchedShopify.forEach(o => {
                results.push({
                    type: 'shopify',
                    icon: '🛒',
                    title: o.name || '-',
                    subtitle: `${o.customer || '-'} • ${o.total ? o.total + ' CHF' : '-'}`,
                    action: () => { navigateTo('shopify'); }
                });
            });

            // Recherche dans les modules (navigation)
            const modules = [
                { name: 'Prise de Commande', keywords: 'commande order panier', page: 'quickorder', icon: '🧾' },
                { name: 'Articles', keywords: 'produits tarifs prix', page: 'articles', icon: '📦' },
                { name: 'Clients', keywords: 'client contact b2b b2c', page: 'clients', icon: '👥' },
                { name: 'MyFish', keywords: 'poisson fish commandes', page: 'myfish', icon: '🐟' },
                { name: 'Shop Hub', keywords: 'eshop boutique web shopify nutri fiche produit', page: 'shop', icon: '🛍️' },
                { name: 'Analyses', keywords: 'statistiques rapports chiffres', page: 'analyses', icon: '📊' },
                { name: 'Cours Poissons', keywords: 'prix tarif marge poisson frais', page: 'cours-poissons', icon: '🐟' },
                { name: 'Prix Traversette', keywords: 'fournisseur traversette', page: 'prix-traversette', icon: '🧮' },
                { name: 'Nutri-Score', keywords: 'nutrition label etiquette', page: 'nutriscore', icon: '🥗' },
                { name: 'Paramètres', keywords: 'settings config', page: 'settings', icon: '⚙️' }
            ];

            modules.filter(m =>
                m.name.toLowerCase().includes(q) ||
                m.keywords.toLowerCase().includes(q)
            ).slice(0, 3).forEach(m => {
                results.push({
                    type: 'module',
                    icon: m.icon,
                    title: m.name,
                    subtitle: 'Aller au module',
                    action: () => navigateTo(m.page)
                });
            });

            renderGlobalSearchResults(results, query);
        }

        function renderGlobalSearchResults(results, query) {
            const container = document.getElementById('global-search-content');
            const dropdown = document.getElementById('global-search-results');

            if (results.length === 0) {
                container.innerHTML = `
                    <div style="padding:40px; text-align:center; color:var(--text-muted);">
                        <div style="font-size:40px; margin-bottom:12px;">🔍</div>
                        <div>Aucun résultat pour "<strong>${query}</strong>"</div>
                        <div style="font-size:12px; margin-top:8px;">Essayez avec d'autres mots-clés</div>
                    </div>
                `;
                dropdown.style.display = 'block';
                return;
            }

            // Grouper par type
            const groups = {};
            results.forEach(r => {
                if (!groups[r.type]) groups[r.type] = [];
                groups[r.type].push(r);
            });

            const typeLabels = {
                'client': '👥 Clients',
                'article': '🏷️ Articles',
                'order': '🐟 Commandes MyFish',
                'shopify': '🛒 Commandes Shopify',
                'module': '📍 Navigation'
            };

            let html = '';
            for (const type in groups) {
                html += `<div style="padding:8px 16px; background:var(--bg-primary); font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid var(--border-color);">${typeLabels[type] || type}</div>`;
                groups[type].forEach((r, idx) => {
                    html += `
                        <div onclick="executeGlobalSearchAction(${results.indexOf(r)})" style="padding:12px 16px; cursor:pointer; border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:12px; transition:background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                            <div style="font-size:24px;">${r.icon}</div>
                            <div style="flex:1; min-width:0;">
                                <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${r.title}</div>
                                <div style="font-size:12px; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${r.subtitle}</div>
                            </div>
                            <div style="color:var(--accent-primary);">→</div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
            dropdown.style.display = 'block';

            // Stocker les résultats pour l'action
            window._globalSearchResults = results;
        }

        function executeGlobalSearchAction(index) {
            if (window._globalSearchResults && window._globalSearchResults[index]) {
                const result = window._globalSearchResults[index];
                document.getElementById('global-search-results').style.display = 'none';
                document.getElementById('global-search-input').value = '';
                result.action();
            }
        }

        function showGlobalSearchResults() {
            const input = document.getElementById('global-search-input');
            if (input.value.length >= 2) {
                document.getElementById('global-search-results').style.display = 'block';
            }
        }

        // Fermer les résultats quand on clique ailleurs
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box')) {
                document.getElementById('global-search-results').style.display = 'none';
            }
        });

        // Fonction de navigation globale
        function navigateTo(pageName) {
            // Mettre à jour la nav
            navItems.forEach(i => i.classList.remove('active'));
            const navItem = document.querySelector(`.nav-item[data-page="${pageName}"]`);
            if (navItem) navItem.classList.add('active');

            // Afficher la page
            pages.forEach(p => p.classList.remove('active'));
            const pageEl = document.getElementById(`page-${pageName}`);
            if (pageEl) pageEl.classList.add('active');

            // Titre
            pageTitle.textContent = pageTitles[pageName] || pageName;

            // Fermer menu mobile
            sidebar.classList.remove('mobile-open');
            sidebarOverlay.classList.remove('active');

            // Réappliquer les permissions (important pour la page settings)
            if (typeof applyUserPermissions === 'function') {
                applyUserPermissions();
            }

            // Init spécifiques
            if (pageName === 'quickorder') setTimeout(initQuickOrder, 100);
            if (pageName === 'shopify') setTimeout(initShopifyModule, 100);
            if (pageName === 'myfish') setTimeout(initMyFish, 100);
            if (pageName === 'clients') setTimeout(initClientsModule, 100);
            if (pageName === 'articles') setTimeout(initArticlesModule, 100);
            if (pageName === 'orders') setTimeout(initOrdersModule, 100);
            if (pageName === 'settings') setTimeout(refreshConnectionLogs, 100);
            if (pageName === 'rh') setTimeout(initRHModule, 100);
        }

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navigateTo(item.dataset.page);
            });
        });

        // Sidebar Toggle
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
        });

        // Mobile Menu
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');

        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.add('mobile-open');
            sidebarOverlay.classList.add('active');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('mobile-open');
            sidebarOverlay.classList.remove('active');
        });

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const darkModeToggle = document.getElementById('darkModeToggle');

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') !== 'light';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            darkModeToggle.classList.toggle('active', !isDark);
        }

        themeToggle.addEventListener('click', toggleTheme);
        darkModeToggle.addEventListener('click', toggleTheme);

        // Toggle switches
        document.querySelectorAll('.toggle:not(#darkModeToggle)').forEach(toggle => {
            toggle.addEventListener('click', () => {
                toggle.classList.toggle('active');
                // Mettre à jour DropboxConfig si c'est le toggle Dropbox
                if (toggle.id === 'dropbox-auto-sync') {
                    DropboxConfig.autoSync = toggle.classList.contains('active');
                }
            });
        });

        // Nutri-Score Calculator - Now handled by React component below

        // ==================== PRIX TRAVERSETTE MODULE ====================
        const prixProducts = [
            { num: 1, art: "93063RT", name: "Indispensable Aubergine au piment d'Espele", qty: 12, price: 2.20, degust: false, ean: "3760153930636" },
            { num: 2, art: "93056RT", name: "Indispensable Ail", qty: 12, price: 2.46, degust: false, ean: "3760153930568" },
            { num: 3, art: "93066RT", name: "Indispensable Olive noire", qty: 12, price: 2.03, degust: false, ean: "3760153930667" },
            { num: 4, art: "93101RT", name: "Indispensable Olive verte", qty: 12, price: 2.46, degust: false, ean: "3760153931015" },
            { num: 5, art: "93008RT", name: "Tartine pour Femme", qty: 12, price: 2.54, degust: false, ean: "3760153930087" },
            { num: 6, art: "93007RT", name: "Tartine pour Homme", qty: 12, price: 2.54, degust: false, ean: "3760153930070" },
            { num: 7, art: "93149RT", name: "Tartine Miss Univerte", qty: 12, price: 2.54, degust: false, ean: "3760153931442" },
            { num: 8, art: "93161RT", name: "Tartine le Cadeau", qty: 12, price: 2.54, degust: false, ean: "3760153931770" },
            { num: 9, art: "93163RT", name: "Tartine Jolies Fesses", qty: 12, price: 2.54, degust: false, ean: "3760153932227" },
            { num: 10, art: "93165RT", name: "Tartine Ouvre-Toi", qty: 12, price: 2.54, degust: false, ean: "3760153932234" },
            { num: 11, art: "93164RT", name: "Tartine Le Plaisir", qty: 12, price: 2.54, degust: false, ean: "3760153932258" },
            { num: 12, art: "93166RT", name: "Tartine Nuit étoilée", qty: 12, price: 2.54, degust: false, ean: "3760153932241" },
            { num: 13, art: "93195RT", name: "Tartine Houmousexuel", qty: 12, price: 2.54, degust: false, ean: "3760153932425" },
            { num: 14, art: "93279RT", name: "Pour les copines", qty: 12, price: 2.54, degust: false, ean: "3760153931367" },
            { num: 15, art: "93197RT", name: "Tartine J'ai raté la dinde", qty: 12, price: 2.54, degust: false, ean: "3760153931121" },
            { num: 16, art: "93203RT", name: "Tartine sous mon thym la grenade", qty: 12, price: 2.54, degust: false, ean: "3760153932173" },
            { num: 17, art: "93212RT", name: "Tartine Nue au soleil", qty: 12, price: 2.54, degust: false, ean: "3760153931381" },
            { num: 18, art: "93302RT", name: "Le Bonheur est dans le poireau", qty: 12, price: 2.54, degust: false, ean: "3760153930032" },
            { num: 19, art: "93242RT", name: "Citron grillé", qty: 12, price: 2.54, degust: false, ean: "3760153931510" },
            { num: 20, art: "93243RT", name: "Mon beau sapin", qty: 24, price: 2.54, degust: false, ean: "3760153931718" },
            { num: 21, art: "93260RT", name: "Trou du lucques", qty: 12, price: 2.54, degust: false, ean: "3760153932340" },
            { num: 22, art: "93233RT", name: "Tartine Pulpeuse", qty: 12, price: 2.54, degust: false, ean: "3760153931541" },
            { num: 23, art: "93189RT", name: "Alors on braise ?", qty: 12, price: 2.54, degust: false, ean: "3760153932364" },
            { num: 24, art: "93278RT", name: "L'Artichaude", qty: 12, price: 2.54, degust: false, ean: "3760153931237" },
            { num: 25, art: "93277RT", name: "Born to be olive", qty: 12, price: 2.54, degust: false, ean: "3760153931917" },
            { num: 26, art: "93244RT", name: "Maria barrée", qty: 12, price: 2.54, degust: false, ean: "3760153931503" },
            { num: 27, art: "93088PV", name: "Fais moi sauter la capsule", qty: 24, price: 2.66, degust: false, ean: "3780153930276" },
            { num: 28, art: "93164PV", name: "J'adore tes miches", qty: 24, price: 2.66, degust: false, ean: "3781153930280" },
            { num: 29, art: "93166PV", name: "A plusieurs si tu veux", qty: 24, price: 2.66, degust: false, ean: "3782153930294" },
            { num: 30, art: "93032PV", name: "Goûte-moi l'Oignon", qty: 24, price: 2.66, degust: false, ean: "3783153930307" },
            { num: 31, art: "93100PV", name: "Sors ta belle baguette", qty: 24, price: 2.66, degust: false, ean: "3784153930311" },
            { num: 32, art: "93196PV", name: "Prends moi sur la table", qty: 24, price: 2.66, degust: false, ean: "3785153930325" },
            { num: 33, art: "93008RT", name: "Tartine pour Femme (DEGUST)", qty: 1, price: 0, degust: true, ean: "3760153930087" },
            { num: 34, art: "93007RT", name: "Tartine pour Homme (DEGUST)", qty: 1, price: 0, degust: true, ean: "3760153930070" },
            { num: 35, art: "93149RT", name: "Tartine Miss Univerte (DEGUST)", qty: 1, price: 0, degust: true, ean: "3760153931442" },
            { num: 36, art: "93161RT", name: "Tartine le Cadeau (DEGUST)", qty: 1, price: 0, degust: true, ean: "3760153931770" },
            { num: 37, art: "93163RT", name: "Tartine Jolies Fesses (DEGUST)", qty: 1, price: 0, degust: true, ean: "3760153932227" },
            { num: 38, art: "93164RT", name: "Tartine Le Plaisir (DEGUST)", qty: 1, price: 0, degust: true, ean: "3760153932258" },
            { num: 39, art: "93195RT", name: "Tartine Houmousexuel (DEGUST)", qty: 1, price: 0, degust: true, ean: "3760153932425" },
            { num: 40, art: "93279RT", name: "Pour les copines (DEGUST)", qty: 1, price: 0, degust: true, ean: "3760153931367" },
            { num: 41, art: "93260RT", name: "Trou du lucques (DEGUST)", qty: 1, price: 0, degust: true, ean: "3760153932340" }
        ];

        let prixEanCodes = JSON.parse(localStorage.getItem('trakio_prix_ean_codes') || '{}');

        function getPrixTotalPieces() {
            return prixProducts.filter(p => !p.degust).reduce((sum, p) => sum + p.qty, 0);
        }

        function roundTo5Cents(value) {
            return Math.round(value * 20) / 20;
        }

        function renderPrixTable(filteredProducts = prixProducts) {
            const taux = parseFloat(document.getElementById('tauxChange')?.value) || 0;
            const fraisTotal = parseFloat(document.getElementById('fraisDedouanement')?.value) || 0;
            const pourcentage = parseFloat(document.getElementById('pourcentageMarge')?.value) || 0;
            const tauxTVA = parseFloat(document.getElementById('tauxTVA')?.value) || 0;
            const totalPieces = getPrixTotalPieces();
            const fraisParPiece = totalPieces > 0 ? fraisTotal / totalPieces : 0;

            const totalPiecesEl = document.getElementById('totalPieces');
            const fraisParPieceEl = document.getElementById('fraisParPiece');
            if (totalPiecesEl) totalPiecesEl.textContent = totalPieces;
            if (fraisParPieceEl) fraisParPieceEl.textContent = fraisParPiece.toFixed(4);

            let html = '';
            let sumEur = 0, sumChf = 0, sumQty = 0;

            filteredProducts.forEach((p) => {
                const priceChf = p.price * taux;
                const fraisProduit = p.degust ? 0 : fraisParPiece;
                const prixAvantMarge = priceChf + fraisProduit;
                const montantMarge = p.degust ? 0 : prixAvantMarge * (pourcentage / 100);
                const prixAvantTVA = prixAvantMarge + montantMarge;
                const montantTVA = p.degust ? 0 : prixAvantTVA * (tauxTVA / 100);
                const prixFinalBrut = prixAvantTVA + montantTVA;
                const prixFinal = roundTo5Cents(prixFinalBrut);

                if (!p.degust) {
                    sumEur += p.price * p.qty;
                    sumChf += prixFinal * p.qty;
                }
                sumQty += p.qty;

                const eanValue = prixEanCodes[p.art] || p.ean || '';
                const degustBadge = p.degust ? '<span class="prix-badge-degust">DEGUST</span>' : '';

                html += `
                    <tr data-art="${p.art}" data-name="${p.name.toLowerCase()}" data-ean="${eanValue.toLowerCase()}">
                        <td class="prix-check-col"><input type="checkbox" class="prix-row-check" data-art="${p.art}"></td>
                        <td class="prix-row-num">${p.num}</td>
                        <td class="prix-cell-copy"><span class="prix-art-code">${p.art}</span><button class="prix-btn-copy" onclick="copyPrixText(this, '${p.art}')" title="Copier">📋</button></td>
                        <td class="prix-cell-copy"><span class="prix-product-name">${p.name}</span>${degustBadge}<button class="prix-btn-copy" onclick="copyPrixText(this, '${p.name.replace(/'/g, "\\'")}')" title="Copier">📋</button></td>
                        <td class="prix-qty">${p.qty}</td>
                        <td class="prix-eur">${p.degust ? '-' : '€ ' + p.price.toFixed(2)}</td>
                        <td class="prix-chf">${p.degust ? '-' : priceChf.toFixed(2)}</td>
                        <td class="prix-customs">${p.degust ? '-' : '+' + fraisProduit.toFixed(4)}</td>
                        <td class="prix-marge">${p.degust ? '-' : '+' + montantMarge.toFixed(2)}</td>
                        <td class="prix-tva">${p.degust ? '-' : '+' + montantTVA.toFixed(2)}</td>
                        <td class="prix-cell-copy"><span class="prix-final">${p.degust ? '-' : 'CHF ' + prixFinal.toFixed(2)}</span>${p.degust ? '' : `<button class="prix-btn-copy" onclick="copyPrixText(this, '${prixFinal.toFixed(2)}')" title="Copier">📋</button>`}</td>
                        <td class="prix-cell-copy"><input type="text" class="prix-ean-input" placeholder="Code EAN" value="${eanValue}" data-art="${p.art}" onchange="updatePrixEan(this)"><button class="prix-btn-copy" onclick="copyPrixEan(this)" title="Copier">📋</button></td>
                    </tr>
                `;
            });

            const tableEl = document.getElementById('prixProductTable');
            if (tableEl) tableEl.innerHTML = html;

            // Update summary
            const sumProductsEl = document.getElementById('prixSumProducts');
            const sumQtyEl = document.getElementById('prixSumQty');
            const sumEurEl = document.getElementById('prixSumEur');
            const sumChfEl = document.getElementById('prixSumChf');
            const statsEl = document.getElementById('prixSearchStats');

            if (sumProductsEl) sumProductsEl.textContent = filteredProducts.length;
            if (sumQtyEl) sumQtyEl.textContent = sumQty;
            if (sumEurEl) sumEurEl.textContent = '€ ' + sumEur.toFixed(2);
            if (sumChfEl) sumChfEl.textContent = 'CHF ' + sumChf.toFixed(2);
            if (statsEl) statsEl.textContent = filteredProducts.length + ' produit' + (filteredProducts.length > 1 ? 's' : '');
        }

        function updatePrixEan(input) {
            const art = input.dataset.art;
            const value = input.value.trim();
            if (value) {
                prixEanCodes[art] = value;
            } else {
                delete prixEanCodes[art];
            }
            input.closest('tr').dataset.ean = value.toLowerCase();
        }

        function copyPrixText(btn, text) {
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = '✓';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = '📋';
                    btn.classList.remove('copied');
                }, 1500);
            });
        }

        function copyPrixEan(btn) {
            const input = btn.previousElementSibling;
            const ean = input ? input.value : '';
            if (!ean) {
                alert('Aucun code EAN à copier');
                return;
            }
            navigator.clipboard.writeText(ean).then(() => {
                btn.textContent = '✓';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = '📋';
                    btn.classList.remove('copied');
                }, 1500);
            });
        }

        function savePrixEanCodes() {
            localStorage.setItem('trakio_prix_ean_codes', JSON.stringify(prixEanCodes));
            alert('✅ Codes EAN sauvegardés avec succès !');
        }

        function filterPrixProducts() {
            const searchEl = document.getElementById('prixSearchInput');
            const query = searchEl ? searchEl.value.toLowerCase().trim() : '';
            if (!query) {
                renderPrixTable(prixProducts);
                return;
            }
            const filtered = prixProducts.filter(p => {
                const ean = (prixEanCodes[p.art] || p.ean || '').toLowerCase();
                return p.art.toLowerCase().includes(query) ||
                       p.name.toLowerCase().includes(query) ||
                       ean.includes(query);
            });
            renderPrixTable(filtered);
        }

        function exportPrixData() {
            const taux = parseFloat(document.getElementById('tauxChange')?.value) || 0;
            const fraisTotal = parseFloat(document.getElementById('fraisDedouanement')?.value) || 0;
            const pourcentage = parseFloat(document.getElementById('pourcentageMarge')?.value) || 0;
            const tauxTVA = parseFloat(document.getElementById('tauxTVA')?.value) || 0;
            const totalPieces = getPrixTotalPieces();
            const fraisParPiece = totalPieces > 0 ? fraisTotal / totalPieces : 0;

            let csv = 'N°;Article;Désignation;Quantité;PU EUR;PU CHF;Frais;Marge%;TVA;Prix Final CHF;Code EAN\n';

            prixProducts.forEach(p => {
                const priceChf = p.price * taux;
                const fraisProduit = p.degust ? 0 : fraisParPiece;
                const prixAvantMarge = priceChf + fraisProduit;
                const montantMarge = p.degust ? 0 : prixAvantMarge * (pourcentage / 100);
                const prixAvantTVA = prixAvantMarge + montantMarge;
                const montantTVA = p.degust ? 0 : prixAvantTVA * (tauxTVA / 100);
                const prixFinalBrut = prixAvantTVA + montantTVA;
                const prixFinal = roundTo5Cents(prixFinalBrut);
                const ean = prixEanCodes[p.art] || p.ean || '';

                csv += `${p.num};${p.art};${p.name};${p.qty};${p.degust ? '0' : p.price.toFixed(2)};${p.degust ? '0' : priceChf.toFixed(2)};${fraisProduit.toFixed(4)};${montantMarge.toFixed(2)};${montantTVA.toFixed(2)};${p.degust ? '0' : prixFinal.toFixed(2)};${ean}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'TRAKIO_Prix_Traversette_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
        }

        // Initialize Prix Traversette when page loads
        function initPrixTraversette() {
            const tauxEl = document.getElementById('tauxChange');
            const fraisEl = document.getElementById('fraisDedouanement');
            const margeEl = document.getElementById('pourcentageMarge');
            const tvaEl = document.getElementById('tauxTVA');
            const searchEl = document.getElementById('prixSearchInput');

            if (tauxEl) tauxEl.addEventListener('input', () => renderPrixTable());
            if (fraisEl) fraisEl.addEventListener('input', () => renderPrixTable());
            if (margeEl) margeEl.addEventListener('input', () => renderPrixTable());
            if (tvaEl) tvaEl.addEventListener('input', () => renderPrixTable());
            if (searchEl) searchEl.addEventListener('input', filterPrixProducts);

            renderPrixTable();
        }

        // Call init when DOM is ready
        setTimeout(initPrixTraversette, 200);

    </script>

    <!-- NUTRITION APP (React) -->
    <script type="text/babel">
        const { useState } = React;

        const NutritionApp = () => {
            const [formData, setFormData] = useState({
                portion: '100', kcal: '', energie: '', proteines: '', lipides: '',
                acidesGrasSatures: '', glucides: '', sucres: '', fibres: '', sel: ''
            });
            const [nutriScore, setNutriScore] = useState(null);
            const [showImport, setShowImport] = useState(false);
            const [importCode, setImportCode] = useState('');

            const handleImportCode = () => {
                if (!importCode.trim()) {
                    alert('Veuillez coller un code HTML à importer');
                    return;
                }

                const extractValue = (html, labels) => {
                    const labelList = labels.split('|');
                    for (let label of labelList) {
                        const regex1 = new RegExp(label + '[^<]*</td>\\s*<td[^>]*>\\s*([\\d.,]+)', 'gi');
                        const match1 = regex1.exec(html);
                        if (match1 && match1[1]) return match1[1].replace(',', '.');

                        const regex2 = new RegExp(label + '[^<]*</td>\\s*<td[^>]*>[^\\d]*([\\d.,]+)', 'gi');
                        const match2 = regex2.exec(html);
                        if (match2 && match2[1]) return match2[1].replace(',', '.');

                        const regex3 = new RegExp('>' + label + '[^>]*>([\\d.,]+)', 'gi');
                        const match3 = regex3.exec(html);
                        if (match3 && match3[1]) return match3[1].replace(',', '.');
                    }
                    return '';
                };

                const portionMatch = importCode.match(/Portion[:\s]*(\d+)/i);
                const portion = portionMatch ? portionMatch[1] : '100';

                const newFormData = {
                    portion: portion,
                    kcal: extractValue(importCode, 'kcal'),
                    energie: extractValue(importCode, 'Énergie|Energie|nergie'),
                    proteines: extractValue(importCode, 'Protéines|Proteines|rotéines'),
                    lipides: extractValue(importCode, 'Lipides'),
                    acidesGrasSatures: extractValue(importCode, 'acides gras saturés|gras saturés|saturés'),
                    glucides: extractValue(importCode, 'Glucides'),
                    sucres: extractValue(importCode, 'sucres'),
                    fibres: extractValue(importCode, 'Fibres|fibres alimentaires'),
                    sel: extractValue(importCode, 'Sel')
                };

                setFormData(newFormData);
                setShowImport(false);
                setImportCode('');
                alert('✅ Code importé avec succès ! Vérifiez les valeurs et cliquez sur "Calculer"');
            };

            const calculateNutriScore = (data) => {
                let pointsNegatifs = 0, pointsPositifs = 0;
                const energie = parseFloat(data.energie) || 0;
                if (energie > 3350) pointsNegatifs += 10;
                else if (energie > 2680) pointsNegatifs += 8;
                else if (energie > 2010) pointsNegatifs += 6;
                else if (energie > 1340) pointsNegatifs += 4;
                else if (energie > 670) pointsNegatifs += 2;

                const sucres = parseFloat(data.sucres) || 0;
                if (sucres > 45) pointsNegatifs += 10;
                else if (sucres > 31) pointsNegatifs += 7;
                else if (sucres > 18) pointsNegatifs += 4;
                else if (sucres > 9) pointsNegatifs += 2;

                const ags = parseFloat(data.acidesGrasSatures) || 0;
                if (ags > 10) pointsNegatifs += 10;
                else if (ags > 7) pointsNegatifs += 7;
                else if (ags > 4) pointsNegatifs += 4;
                else if (ags > 2) pointsNegatifs += 2;

                const sel = parseFloat(data.sel) || 0;
                if (sel > 2.25) pointsNegatifs += 10;
                else if (sel > 1.35) pointsNegatifs += 6;
                else if (sel > 0.675) pointsNegatifs += 3;

                const fibres = parseFloat(data.fibres) || 0;
                if (fibres > 4.7) pointsPositifs += 5;
                else if (fibres > 2.8) pointsPositifs += 3;
                else if (fibres > 0.9) pointsPositifs += 1;

                const proteines = parseFloat(data.proteines) || 0;
                if (proteines > 8) pointsPositifs += 5;
                else if (proteines > 4.8) pointsPositifs += 3;
                else if (proteines > 1.6) pointsPositifs += 1;

                const scoreTotal = pointsNegatifs - pointsPositifs;
                let lettre, couleur, couleurTexte;
                if (scoreTotal <= -1) { lettre = 'A'; couleur = '#038141'; couleurTexte = '#fff'; }
                else if (scoreTotal <= 2) { lettre = 'B'; couleur = '#85BB2F'; couleurTexte = '#fff'; }
                else if (scoreTotal <= 10) { lettre = 'C'; couleur = '#FECB02'; couleurTexte = '#000'; }
                else if (scoreTotal <= 18) { lettre = 'D'; couleur = '#EE8100'; couleurTexte = '#fff'; }
                else { lettre = 'E'; couleur = '#E63E11'; couleurTexte = '#fff'; }

                return { lettre, couleur, couleurTexte, scoreTotal };
            };

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

            const handleCalculate = () => setNutriScore(calculateNutriScore(formData));

            const handleReset = () => {
                setFormData({ portion: '100', kcal: '', energie: '', proteines: '', lipides: '', acidesGrasSatures: '', glucides: '', sucres: '', fibres: '', sel: '' });
                setNutriScore(null);
            };

            const hasValue = (val) => val && val !== '';
            const vnr = { energie: 8400, kcal: 2000, lipides: 70, acidesGrasSatures: 20, glucides: 260, sucres: 90, proteines: 50, sel: 6 };
            const calcPct = (val, ref) => {
                if (!hasValue(val) || !ref) return '';
                return `${Math.round((parseFloat(val) / ref) * 100)}%`;
            };

            const generateHTML = () => {
                if (!nutriScore) return '';
                return `<div style="font-family: 'Outfit', sans-serif; max-width: 550px; border: 2px solid #2d3a4f; padding: 20px; background: #1a2234; border-radius: 16px; color: #f8fafc;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3 style="margin: 0; font-size: 18px; color: #06d6a0;">Valeurs nutritionnelles</h3>
    <div style="text-align: center;">
      <div style="width: 50px; height: 50px; border-radius: 50%; background: ${nutriScore.couleur}; display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 28px; font-weight: bold; color: ${nutriScore.couleurTexte};">${nutriScore.lettre}</span>
      </div>
      <p style="margin: 4px 0 0 0; font-size: 8px; font-weight: bold; color: #94a3b8;">NUTRI-SCORE</p>
    </div>
  </div>
  <p style="margin: 0 0 10px 0; font-size: 12px; color: #94a3b8;">Portion: ${formData.portion}g</p>
  <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
    <tr style="border-bottom: 2px solid #2d3a4f;"><th style="text-align: left; padding: 8px 0; color: #94a3b8;"></th><th style="text-align: right; padding: 8px 0; color: #94a3b8;">Par ${formData.portion}g</th><th style="text-align: right; padding: 8px 0; color: #94a3b8;">% AR*</th></tr>
    <tr style="border-bottom: 1px solid #2d3a4f;"><td style="padding: 8px 0;">kcal</td><td style="text-align: right;">${hasValue(formData.kcal) ? formData.kcal : 'NC'}</td><td style="text-align: right; color: #64748b;">${calcPct(formData.kcal, vnr.kcal)}</td></tr>
    <tr style="border-bottom: 1px solid #2d3a4f;"><td style="padding: 8px 0;">Énergie</td><td style="text-align: right;">${hasValue(formData.energie) ? formData.energie + ' kJ' : 'NC'}</td><td style="text-align: right; color: #64748b;">${calcPct(formData.energie, vnr.energie)}</td></tr>
    <tr style="border-bottom: 1px solid #2d3a4f;"><td style="padding: 8px 0;">Protéines</td><td style="text-align: right;">${hasValue(formData.proteines) ? formData.proteines + ' g' : 'NC'}</td><td style="text-align: right; color: #64748b;">${calcPct(formData.proteines, vnr.proteines)}</td></tr>
    <tr style="border-bottom: 1px solid #2d3a4f;"><td style="padding: 8px 0;">Lipides</td><td style="text-align: right;">${hasValue(formData.lipides) ? formData.lipides + ' g' : 'NC'}</td><td style="text-align: right; color: #64748b;">${calcPct(formData.lipides, vnr.lipides)}</td></tr>
    <tr style="border-bottom: 1px solid #2d3a4f;"><td style="padding: 8px 0 8px 15px; font-size: 13px; color: #94a3b8;">dont acides gras saturés</td><td style="text-align: right; font-size: 13px;">${hasValue(formData.acidesGrasSatures) ? formData.acidesGrasSatures + ' g' : 'NC'}</td><td style="text-align: right; font-size: 13px; color: #64748b;">${calcPct(formData.acidesGrasSatures, vnr.acidesGrasSatures)}</td></tr>
    <tr style="border-bottom: 1px solid #2d3a4f;"><td style="padding: 8px 0;">Glucides</td><td style="text-align: right;">${hasValue(formData.glucides) ? formData.glucides + ' g' : 'NC'}</td><td style="text-align: right; color: #64748b;">${calcPct(formData.glucides, vnr.glucides)}</td></tr>
    <tr style="border-bottom: 1px solid #2d3a4f;"><td style="padding: 8px 0 8px 15px; font-size: 13px; color: #94a3b8;">dont sucres</td><td style="text-align: right; font-size: 13px;">${hasValue(formData.sucres) ? formData.sucres + ' g' : 'NC'}</td><td style="text-align: right; font-size: 13px; color: #64748b;">${calcPct(formData.sucres, vnr.sucres)}</td></tr>
    <tr style="border-bottom: 1px solid #2d3a4f;"><td style="padding: 8px 0;">Fibres</td><td style="text-align: right;">${hasValue(formData.fibres) ? formData.fibres + ' g' : 'NC'}</td><td style="text-align: right; color: #64748b;">-</td></tr>
    <tr><td style="padding: 8px 0;">Sel</td><td style="text-align: right;">${hasValue(formData.sel) ? formData.sel + ' g' : 'NC'}</td><td style="text-align: right; color: #64748b;">${calcPct(formData.sel, vnr.sel)}</td></tr>
  </table>
  <p style="margin: 12px 0 0 0; font-size: 11px; color: #64748b; font-style: italic;">*AR = Apports de référence (8400 kJ/2000 kcal)</p>
</div>`;
            };

            const copyHTML = () => {
                navigator.clipboard.writeText(generateHTML()).then(() => {
                    alert('✅ Code HTML copié !');
                });
            };

            // Styles adaptés aux couleurs TRAKIO
            const cardStyle = {
                background: 'var(--bg-card)',
                border: '1px solid var(--border-color)',
                borderRadius: '16px',
                padding: '24px',
            };

            const inputStyle = {
                width: '100%',
                padding: '14px 16px',
                background: 'var(--bg-primary)',
                border: '1px solid var(--border-color)',
                borderRadius: '10px',
                color: 'var(--text-primary)',
                fontSize: '14px',
                fontFamily: 'Outfit, sans-serif',
                transition: 'all 0.3s ease'
            };

            const labelStyle = {
                display: 'block',
                marginBottom: '8px',
                fontWeight: '500',
                fontSize: '14px',
                color: 'var(--text-secondary)'
            };

            const btnPrimaryStyle = {
                flex: 1,
                padding: '14px 20px',
                background: 'linear-gradient(135deg, #06d6a0, #118ab2)',
                color: '#0a0e17',
                border: 'none',
                borderRadius: '10px',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                fontFamily: 'Outfit, sans-serif',
                transition: 'all 0.3s ease'
            };

            const btnSecondaryStyle = {
                flex: 1,
                padding: '14px 20px',
                background: 'var(--bg-hover)',
                color: 'var(--text-primary)',
                border: '1px solid var(--border-color)',
                borderRadius: '10px',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                fontFamily: 'Outfit, sans-serif'
            };

            return (
                <div>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '24px' }}>
                        {/* Formulaire */}
                        <div style={cardStyle}>
                            <h3 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '20px', color: 'var(--text-primary)' }}>
                                📝 Valeurs Nutritionnelles
                            </h3>

                            {/* Bouton Import */}
                            <div style={{ marginBottom: '20px' }}>
                                <button
                                    onClick={() => setShowImport(!showImport)}
                                    style={{
                                        width: '100%',
                                        padding: '14px',
                                        background: showImport ? '#ef476f' : 'linear-gradient(135deg, #9d4edd, #118ab2)',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '10px',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        fontFamily: 'Outfit, sans-serif'
                                    }}
                                >
                                    {showImport ? '❌ Annuler l\'import' : '📥 Importer un code HTML existant'}
                                </button>
                            </div>

                            {/* Zone d'import */}
                            {showImport && (
                                <div style={{
                                    marginBottom: '20px',
                                    padding: '16px',
                                    background: 'var(--bg-primary)',
                                    borderRadius: '12px',
                                    border: '2px dashed #9d4edd'
                                }}>
                                    <p style={{ margin: '0 0 10px 0', fontSize: '14px', color: '#9d4edd', fontWeight: '600' }}>
                                        📋 Collez votre code HTML existant :
                                    </p>
                                    <textarea
                                        value={importCode}
                                        onChange={(e) => setImportCode(e.target.value)}
                                        placeholder="Collez ici le code HTML de votre tableau nutritionnel..."
                                        style={{
                                            width: '100%',
                                            height: '120px',
                                            padding: '12px',
                                            background: 'var(--bg-card)',
                                            border: '1px solid var(--border-color)',
                                            borderRadius: '8px',
                                            fontSize: '12px',
                                            fontFamily: 'Space Mono, monospace',
                                            color: 'var(--text-primary)',
                                            resize: 'vertical'
                                        }}
                                    />
                                    <button
                                        onClick={handleImportCode}
                                        style={{
                                            width: '100%',
                                            marginTop: '10px',
                                            padding: '12px',
                                            background: 'linear-gradient(135deg, #06d6a0, #118ab2)',
                                            color: '#0a0e17',
                                            border: 'none',
                                            borderRadius: '8px',
                                            fontSize: '14px',
                                            fontWeight: '600',
                                            cursor: 'pointer',
                                            fontFamily: 'Outfit, sans-serif'
                                        }}
                                    >
                                        ✨ Extraire les valeurs
                                    </button>
                                </div>
                            )}

                            {/* Champs du formulaire */}
                            <div style={{ display: 'grid', gap: '16px' }}>
                                {[
                                    { name: 'portion', label: '📏 Portion (g)', ph: '100' },
                                    { name: 'kcal', label: '🔥 kcal', ph: '85' },
                                    { name: 'energie', label: '⚡ Énergie (kJ)', ph: '370' },
                                    { name: 'proteines', label: '🥩 Protéines (g)', ph: '20' },
                                    { name: 'lipides', label: '🧈 Lipides (g)', ph: '1' },
                                    { name: 'acidesGrasSatures', label: '   ↳ dont acides gras saturés (g)', ph: '0.2' },
                                    { name: 'glucides', label: '🍞 Glucides (g)', ph: '1' },
                                    { name: 'sucres', label: '   ↳ dont sucres (g)', ph: '0' },
                                    { name: 'fibres', label: '🥬 Fibres (g)', ph: '0' },
                                    { name: 'sel', label: '🧂 Sel (g)', ph: '0.8' }
                                ].map(f => (
                                    <div key={f.name}>
                                        <label style={labelStyle}>{f.label}</label>
                                        <input
                                            type="text"
                                            name={f.name}
                                            value={formData[f.name]}
                                            onChange={handleChange}
                                            placeholder={f.ph}
                                            style={inputStyle}
                                        />
                                    </div>
                                ))}
                            </div>

                            <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                                <button onClick={handleCalculate} style={btnPrimaryStyle}>
                                    ⚡ Calculer le Nutri-Score
                                </button>
                                <button onClick={handleReset} style={btnSecondaryStyle}>
                                    🔄 Reset
                                </button>
                            </div>
                        </div>

                        {/* Résultat */}
                        <div style={cardStyle}>
                            <h3 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '20px', color: 'var(--text-primary)' }}>
                                👁️ Prévisualisation & Code
                            </h3>

                            {!nutriScore ? (
                                <div style={{
                                    textAlign: 'center',
                                    padding: '60px 20px',
                                    color: 'var(--text-muted)'
                                }}>
                                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>🍽️</div>
                                    <p>Remplissez les valeurs nutritionnelles et cliquez sur "Calculer"</p>
                                </div>
                            ) : (
                                <>
                                    {/* Preview */}
                                    <div style={{
                                        background: 'var(--bg-primary)',
                                        borderRadius: '12px',
                                        padding: '20px',
                                        marginBottom: '20px'
                                    }}>
                                        <div dangerouslySetInnerHTML={{ __html: generateHTML() }} />
                                    </div>

                                    {/* Score */}
                                    <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '20px',
                                        padding: '20px',
                                        background: 'var(--bg-primary)',
                                        borderRadius: '12px',
                                        marginBottom: '20px'
                                    }}>
                                        <div style={{
                                            width: '80px',
                                            height: '80px',
                                            borderRadius: '50%',
                                            background: nutriScore.couleur,
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            boxShadow: `0 8px 24px ${nutriScore.couleur}50`
                                        }}>
                                            <span style={{
                                                fontSize: '42px',
                                                fontWeight: '700',
                                                color: nutriScore.couleurTexte
                                            }}>{nutriScore.lettre}</span>
                                        </div>
                                        <div>
                                            <div style={{ fontSize: '14px', color: 'var(--text-muted)' }}>Score calculé</div>
                                            <div style={{ fontSize: '28px', fontWeight: '700', fontFamily: 'Space Mono, monospace' }}>{nutriScore.scoreTotal}</div>
                                            <div style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>Nutri-Score <strong style={{ color: nutriScore.couleur }}>{nutriScore.lettre}</strong></div>
                                        </div>
                                    </div>

                                    {/* Code HTML */}
                                    <div style={{
                                        background: 'var(--bg-primary)',
                                        borderRadius: '12px',
                                        padding: '16px'
                                    }}>
                                        <div style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            marginBottom: '12px'
                                        }}>
                                            <span style={{ fontWeight: '600', fontSize: '14px' }}>📋 Code HTML</span>
                                            <button
                                                onClick={copyHTML}
                                                style={{
                                                    padding: '8px 16px',
                                                    background: 'linear-gradient(135deg, #06d6a0, #118ab2)',
                                                    color: '#0a0e17',
                                                    border: 'none',
                                                    borderRadius: '8px',
                                                    fontSize: '13px',
                                                    fontWeight: '600',
                                                    cursor: 'pointer',
                                                    fontFamily: 'Outfit, sans-serif'
                                                }}
                                            >
                                                📋 Copier le code
                                            </button>
                                        </div>
                                        <textarea
                                            value={generateHTML()}
                                            readOnly
                                            style={{
                                                width: '100%',
                                                height: '150px',
                                                padding: '12px',
                                                fontFamily: 'Space Mono, monospace',
                                                fontSize: '11px',
                                                background: '#1e1e1e',
                                                color: '#d4d4d4',
                                                border: '1px solid var(--border-color)',
                                                borderRadius: '8px',
                                                resize: 'vertical'
                                            }}
                                        />
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Render when page becomes active
        const renderNutritionApp = () => {
            const root = document.getElementById('nutrition-root');
            if (root && !root.hasChildNodes()) {
                ReactDOM.render(<NutritionApp />, root);
            }
        };

        // Initial render
        setTimeout(renderNutritionApp, 100);

        // Re-render when navigating to page
        const originalShowPage = window.showPage || function() {};
        window.nutriPageObserver = new MutationObserver(() => {
            const page = document.getElementById('page-nutriscore');
            if (page && page.classList.contains('active')) {
                renderNutritionApp();
            }
        });
    </script>

    <!-- ========================================
         COURS POISSONS FRAIS MODULE
         Version: 3.0 - Nouveau design TRAKIO
         ======================================== -->
    <script>
        /**
         * CPF - Cours Poissons Frais
         * Module moderne de gestion des tarifs poissons
         */
        const CPF = {
            // Données
            products: JSON.parse(localStorage.getItem('cpf_products') || '[]'),
            favorites: JSON.parse(localStorage.getItem('cpf_favorites') || '[]'),
            history: JSON.parse(localStorage.getItem('cpf_history') || '[]'),
            currentTab: 'catalogue',
            editingId: null,

            // Configuration
            config: {
                vatRate: 2.6,
                defaultLoss: 2,
                margins: [15, 20, 25, 30, 40, 50, 100]
            },

            // Arrondi suisse 5 centimes (1.22 → 1.20, 1.23 → 1.25)
            swiss(value) {
                return (Math.round(value * 20) / 20).toFixed(2);
            },

            // Initialisation
            init() {
                this.updateStats();
                this.renderProducts();
                this.populateOriginFilter();
                console.log('🐟 Cours Poissons Frais initialisé');
            },

            // Sauvegarde
            save() {
                localStorage.setItem('cpf_products', JSON.stringify(this.products));
                localStorage.setItem('cpf_favorites', JSON.stringify(this.favorites));
                localStorage.setItem('cpf_history', JSON.stringify(this.history));
            },

            // Stats
            updateStats() {
                // Nettoyer les favoris orphelins
                const validIds = this.products.map(p => p.id);
                const oldLen = this.favorites.length;
                this.favorites = this.favorites.filter(fid => validIds.includes(fid));
                if (this.favorites.length !== oldLen) {
                    localStorage.setItem('cpf_favorites', JSON.stringify(this.favorites));
                }

                document.getElementById('cpf-stat-total').textContent = this.products.length;
                document.getElementById('cpf-stat-favoris').textContent = this.favorites.length;
                document.getElementById('cpf-fav-count').textContent = this.favorites.length;
                document.getElementById('cpf-stat-fiches').textContent = this.history.length;

                const now = new Date();
                const weekNum = Math.ceil((now - new Date(now.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
                document.getElementById('cpf-stat-semaine').textContent = 'S' + weekNum;
            },

            // Onglets
            switchTab(tab) {
                this.currentTab = tab;
                ['catalogue', 'favoris', 'historique'].forEach(t => {
                    document.getElementById('cpf-content-' + t).style.display = t === tab ? 'block' : 'none';
                    document.getElementById('cpf-tab-' + t).style.background = t === tab ? 'var(--accent-primary)' : 'transparent';
                    document.getElementById('cpf-tab-' + t).style.color = t === tab ? 'white' : 'var(--text-muted)';
                });

                if (tab === 'favoris') this.renderFavorites();
                if (tab === 'historique') this.renderHistory();
            },

            // Remplir filtre origines
            populateOriginFilter() {
                const origins = [...new Set(this.products.map(p => p.origin).filter(Boolean))].sort();
                const select = document.getElementById('cpf-filter-origin');
                select.innerHTML = '<option value="">Toutes origines</option>' +
                    origins.map(o => `<option value="${o}">${o}</option>`).join('');
            },

            // Filtrer et trier
            filterProducts() {
                const search = (document.getElementById('cpf-search')?.value || '').toLowerCase();
                const sort = document.getElementById('cpf-sort')?.value || 'name';
                const originFilter = document.getElementById('cpf-filter-origin')?.value || '';

                let filtered = this.products.filter(p => {
                    const matchSearch = !search ||
                        (p.name || '').toLowerCase().includes(search) ||
                        (p.code || '').toLowerCase().includes(search) ||
                        (p.plu || '').toLowerCase().includes(search) ||
                        (p.origin || '').toLowerCase().includes(search);
                    const matchOrigin = !originFilter || p.origin === originFilter;
                    return matchSearch && matchOrigin;
                });

                // Tri
                filtered.sort((a, b) => {
                    switch(sort) {
                        case 'name': return (a.name || '').localeCompare(b.name || '');
                        case 'name-desc': return (b.name || '').localeCompare(a.name || '');
                        case 'code': return (a.code || '').localeCompare(b.code || '');
                        case 'plu': return (a.plu || '').localeCompare(b.plu || '');
                        case 'price': return (a.price || 0) - (b.price || 0);
                        case 'price-desc': return (b.price || 0) - (a.price || 0);
                        case 'origin': return (a.origin || '').localeCompare(b.origin || '');
                        default: return 0;
                    }
                });

                this.renderProductsList(filtered);
            },

            // Rendu produits
            renderProducts() {
                this.filterProducts();
            },

            renderProductsList(products) {
                const tbody = document.getElementById('cpf-products-tbody');
                const noResults = document.getElementById('cpf-no-results');

                if (products.length === 0) {
                    tbody.innerHTML = '';
                    noResults.style.display = 'block';
                    return;
                }

                noResults.style.display = 'none';

                tbody.innerHTML = products.map(p => {
                    const isFav = this.favorites.includes(p.id);
                    const loss = p.loss || this.config.defaultLoss;
                    const vat = p.vat || this.config.vatRate;
                    const price = p.price || 0;
                    const revient = price / (1 - loss / 100);
                    const m30 = revient / (1 - 30 / 100);
                    const m40 = revient / (1 - 40 / 100);
                    const m100 = revient * 2;
                    const ttc = m100 * (1 + vat / 100);

                    return `
                        <tr style="border-bottom:1px solid var(--border-color); cursor:pointer;" onclick="CPF.editProduct('${p.id}')" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                            <td style="padding:10px 8px; text-align:center;" onclick="event.stopPropagation(); CPF.toggleFavorite('${p.id}')">
                                <span style="font-size:18px; cursor:pointer;">${isFav ? '⭐' : '☆'}</span>
                            </td>
                            <td style="padding:10px 8px; font-family:monospace; color:var(--text-muted);">${p.plu || '-'}</td>
                            <td style="padding:10px 8px;"><code style="background:var(--bg-primary); padding:2px 6px; border-radius:4px;">${p.code || '-'}</code></td>
                            <td style="padding:10px 8px; font-weight:500;">${p.name || '-'}</td>
                            <td style="padding:10px 8px; text-align:center;"><span style="padding:2px 8px; background:var(--bg-hover); border-radius:4px; font-size:11px;">${p.origin || '-'}</span></td>
                            <td style="padding:10px 8px; text-align:right; font-weight:600;">${CPF.swiss(price)}</td>
                            <td style="padding:10px 8px; text-align:center; color:var(--text-muted);">${parseFloat(loss).toFixed(1)}%</td>
                            <td style="padding:10px 8px; text-align:right; color:var(--accent-secondary);">${CPF.swiss(revient)}</td>
                            <td style="padding:10px 8px; text-align:right; color:#fdcb6e;">${CPF.swiss(m30)}</td>
                            <td style="padding:10px 8px; text-align:right; color:#e17055;">${CPF.swiss(m40)}</td>
                            <td style="padding:10px 8px; text-align:right; font-weight:700; color:var(--accent-primary);">${CPF.swiss(ttc)}</td>
                            <td style="padding:10px 8px; text-align:center;" onclick="event.stopPropagation()">
                                <button onclick="CPF.editProduct('${p.id}')" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; color:var(--text-primary);">✏️</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            // Favoris
            toggleFavorite(id) {
                const idx = this.favorites.indexOf(id);
                if (idx > -1) {
                    this.favorites.splice(idx, 1);
                } else {
                    this.favorites.push(id);
                }
                this.save();
                this.updateStats();
                this.renderProducts();
            },

            renderFavorites() {
                const tbody = document.getElementById('cpf-favorites-tbody');
                const noFav = document.getElementById('cpf-no-favorites');
                const searchFav = document.getElementById('cpf-search-fav')?.value?.toLowerCase() || '';

                let favProducts = this.products.filter(p => this.favorites.includes(p.id));

                // Filtrer par recherche
                if (searchFav) {
                    favProducts = favProducts.filter(p =>
                        (p.name || '').toLowerCase().includes(searchFav) ||
                        (p.code || '').toLowerCase().includes(searchFav) ||
                        (p.plu || '').toLowerCase().includes(searchFav)
                    );
                }

                if (favProducts.length === 0) {
                    tbody.innerHTML = '';
                    noFav.style.display = 'block';
                    return;
                }

                noFav.style.display = 'none';

                tbody.innerHTML = favProducts.map(p => {
                    const loss = p.loss || this.config.defaultLoss;
                    const vat = p.vat || this.config.vatRate;
                    const price = p.price || 0;
                    const revient = price / (1 - loss / 100);
                    const m30 = revient / (1 - 30 / 100);
                    const m40 = revient / (1 - 40 / 100);
                    const m100 = revient * 2;
                    const ttc = m100 * (1 + vat / 100);

                    return `
                        <tr style="border-bottom:1px solid var(--border-color); cursor:pointer;" onclick="CPF.editProduct('${p.id}')" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                            <td style="padding:10px 8px; text-align:center;" onclick="event.stopPropagation(); CPF.toggleFavorite('${p.id}')">
                                <span style="font-size:18px; cursor:pointer;">⭐</span>
                            </td>
                            <td style="padding:10px 8px; font-family:monospace; color:var(--text-muted);">${p.plu || '-'}</td>
                            <td style="padding:10px 8px;"><code style="background:var(--bg-primary); padding:2px 6px; border-radius:4px;">${p.code || '-'}</code></td>
                            <td style="padding:10px 8px; font-weight:500;">${p.name || '-'}</td>
                            <td style="padding:10px 8px; text-align:center;"><span style="padding:2px 8px; background:var(--bg-hover); border-radius:4px; font-size:11px;">${p.origin || '-'}</span></td>
                            <td style="padding:10px 8px; text-align:right; font-weight:600;">${CPF.swiss(price)}</td>
                            <td style="padding:10px 8px; text-align:center; color:var(--text-muted);">${parseFloat(loss).toFixed(1)}%</td>
                            <td style="padding:10px 8px; text-align:right; color:var(--accent-secondary);">${CPF.swiss(revient)}</td>
                            <td style="padding:10px 8px; text-align:right; color:#fdcb6e;">${CPF.swiss(m30)}</td>
                            <td style="padding:10px 8px; text-align:right; color:#e17055;">${CPF.swiss(m40)}</td>
                            <td style="padding:10px 8px; text-align:right; font-weight:700; color:var(--accent-primary);">${CPF.swiss(ttc)}</td>
                            <td style="padding:10px 8px; text-align:center;" onclick="event.stopPropagation()">
                                <button onclick="CPF.editProduct('${p.id}')" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; color:var(--text-primary);">✏️</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            // Historique
            saveCurrentWeek() {
                const now = new Date();
                const weekNum = Math.ceil((now - new Date(now.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
                const entry = {
                    id: 'week_' + Date.now(),
                    date: now.toISOString(),
                    week: weekNum,
                    year: now.getFullYear(),
                    month: now.getMonth() + 1,
                    products: JSON.parse(JSON.stringify(this.products)),
                    count: this.products.length
                };
                this.history.unshift(entry);
                this.save();
                this.updateStats();
                this.renderHistory();
                alert('✅ Fiche semaine ' + weekNum + ' sauvegardée !');
            },

            renderHistory() {
                const container = document.getElementById('cpf-history-list');
                const noHistory = document.getElementById('cpf-no-history');
                const filter = document.getElementById('cpf-history-filter')?.value || 'all';

                let filtered = this.history;
                const now = new Date();

                if (filter === 'week') {
                    const weekNum = Math.ceil((now - new Date(now.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
                    filtered = this.history.filter(h => h.week === weekNum && h.year === now.getFullYear());
                } else if (filter === 'month') {
                    filtered = this.history.filter(h => h.month === (now.getMonth() + 1) && h.year === now.getFullYear());
                } else if (filter === 'year') {
                    filtered = this.history.filter(h => h.year === now.getFullYear());
                }

                if (filtered.length === 0) {
                    container.innerHTML = '';
                    noHistory.style.display = 'block';
                    return;
                }

                noHistory.style.display = 'none';

                container.innerHTML = filtered.map(h => {
                    const date = new Date(h.date);
                    return `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:16px; background:var(--bg-primary); border-radius:10px; margin-bottom:10px; border:1px solid var(--border-color);">
                            <div>
                                <div style="font-weight:600;">📅 Semaine ${h.week} - ${h.year}</div>
                                <div style="font-size:12px; color:var(--text-muted);">${date.toLocaleDateString('fr-CH')} • ${h.count} produits</div>
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button onclick="CPF.viewHistory('${h.id}')" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; color:var(--text-primary);">👁️ Voir</button>
                                <button onclick="CPF.restoreHistory('${h.id}')" style="padding:8px 12px; background:var(--accent-primary)20; border:1px solid var(--accent-primary); border-radius:6px; cursor:pointer; color:var(--accent-primary);">♻️ Restaurer</button>
                                <button onclick="CPF.printHistory('${h.id}')" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; color:var(--text-primary);">🖨️</button>
                                <button onclick="CPF.deleteHistory('${h.id}')" style="padding:8px 12px; background:rgba(239,71,111,0.1); border:1px solid var(--accent-danger); border-radius:6px; cursor:pointer; color:var(--accent-danger);">🗑️</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            filterHistory() {
                this.renderHistory();
            },

            restoreHistory(id) {
                const entry = this.history.find(h => h.id === id);
                if (entry && confirm('Restaurer cette fiche ? Les produits actuels seront remplacés.')) {
                    this.products = JSON.parse(JSON.stringify(entry.products));
                    this.save();
                    this.updateStats();
                    this.populateOriginFilter();
                    this.switchTab('catalogue');
                    alert('✅ Fiche restaurée !');
                }
            },

            deleteHistory(id) {
                if (confirm('Supprimer cette fiche de l\'historique ?')) {
                    this.history = this.history.filter(h => h.id !== id);
                    this.save();
                    this.updateStats();
                    this.renderHistory();
                }
            },

            viewHistory(id) {
                const entry = this.history.find(h => h.id === id);
                if (entry) {
                    alert('Semaine ' + entry.week + ' - ' + entry.count + ' produits\n\nUtilisez "Restaurer" pour charger cette fiche.');
                }
            },

            printHistory(id) {
                const entry = this.history.find(h => h.id === id);
                if (entry) {
                    this.printProductList(entry.products, 'Semaine ' + entry.week + ' - ' + entry.year);
                }
            },

            // Modal édition
            showAddModal() {
                this.editingId = null;
                document.getElementById('cpf-modal-title').textContent = '🐟 Nouveau produit';
                document.getElementById('cpf-delete-btn').style.display = 'none';

                // Reset fields
                ['plu', 'code', 'ean', 'name', 'origin', 'cut', 'notes'].forEach(f => {
                    document.getElementById('cpf-edit-' + f).value = '';
                });
                document.getElementById('cpf-edit-category').value = '';
                document.getElementById('cpf-edit-price').value = '';
                document.getElementById('cpf-edit-loss').value = '2.0';
                document.getElementById('cpf-edit-vat').value = '2.6';
                document.getElementById('cpf-edit-photo-preview').innerHTML = '<span style="color:var(--text-muted); font-size:12px;">📷 Ajouter photo</span>';

                this.calculatePrices();
                document.getElementById('cpf-edit-modal').style.display = 'block';
            },

            editProduct(id) {
                const product = this.products.find(p => p.id === id);
                if (!product) return;

                this.editingId = id;
                document.getElementById('cpf-modal-title').textContent = '🐟 Édition: ' + (product.name || 'Produit');
                document.getElementById('cpf-delete-btn').style.display = 'block';

                document.getElementById('cpf-edit-plu').value = product.plu || '';
                document.getElementById('cpf-edit-code').value = product.code || '';
                document.getElementById('cpf-edit-ean').value = product.ean || '';
                document.getElementById('cpf-edit-name').value = product.name || '';
                document.getElementById('cpf-edit-origin').value = product.origin || '';
                document.getElementById('cpf-edit-cut').value = product.cut || '';
                document.getElementById('cpf-edit-category').value = product.category || '';
                document.getElementById('cpf-edit-price').value = product.price || '';
                document.getElementById('cpf-edit-loss').value = parseFloat(product.loss || 2).toFixed(1);
                document.getElementById('cpf-edit-vat').value = product.vat || 2.6;
                document.getElementById('cpf-edit-notes').value = product.notes || '';

                // Photo
                const preview = document.getElementById('cpf-edit-photo-preview');
                if (product.photo) {
                    preview.innerHTML = `<img src="${product.photo}" style="width:100%; height:100%; object-fit:cover;">`;
                } else {
                    preview.innerHTML = '<span style="color:var(--text-muted); font-size:12px;">📷 Ajouter photo</span>';
                }

                this.calculatePrices();
                document.getElementById('cpf-edit-modal').style.display = 'block';
            },

            closeEditModal() {
                document.getElementById('cpf-edit-modal').style.display = 'none';
                this.editingId = null;
            },

            calculatePrices() {
                const price = parseFloat(document.getElementById('cpf-edit-price').value) || 0;
                const loss = parseFloat(document.getElementById('cpf-edit-loss').value) || 2;
                const vat = parseFloat(document.getElementById('cpf-edit-vat').value) || 2.6;

                const revient = price / (1 - loss / 100);

                document.getElementById('cpf-calc-revient').textContent = this.swiss(revient) + ' CHF';

                [15, 20, 25, 30, 40, 50].forEach(m => {
                    const val = revient / (1 - m / 100);
                    document.getElementById('cpf-calc-m' + m).textContent = CPF.swiss(val);
                });

                const m100 = revient * 2;
                const ttc = m100 * (1 + vat / 100);

                document.getElementById('cpf-calc-m100').textContent = this.swiss(m100);
                document.getElementById('cpf-calc-ttc').textContent = this.swiss(ttc);
            },

            handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('cpf-edit-photo-preview').innerHTML =
                        `<img src="${e.target.result}" style="width:100%; height:100%; object-fit:cover;">`;
                };
                reader.readAsDataURL(file);
            },

            removePhoto() {
                document.getElementById('cpf-edit-photo-preview').innerHTML =
                    '<span style="color:var(--text-muted); font-size:12px;">📷 Ajouter photo</span>';
                document.getElementById('cpf-edit-photo-input').value = '';
            },

            saveProduct() {
                const code = document.getElementById('cpf-edit-code').value.trim();
                const name = document.getElementById('cpf-edit-name').value.trim();
                const price = parseFloat(document.getElementById('cpf-edit-price').value);

                if (!code || !name) {
                    alert('⚠️ Code et désignation obligatoires');
                    return;
                }

                const photoPreview = document.getElementById('cpf-edit-photo-preview').querySelector('img');

                const product = {
                    id: this.editingId || 'cpf_' + Date.now(),
                    plu: document.getElementById('cpf-edit-plu').value.trim(),
                    code: code,
                    ean: document.getElementById('cpf-edit-ean').value.trim(),
                    name: name,
                    origin: document.getElementById('cpf-edit-origin').value.trim().toUpperCase(),
                    cut: document.getElementById('cpf-edit-cut').value.trim(),
                    category: document.getElementById('cpf-edit-category').value,
                    price: price || 0,
                    loss: parseFloat(document.getElementById('cpf-edit-loss').value) || 2,
                    vat: parseFloat(document.getElementById('cpf-edit-vat').value) || 2.6,
                    notes: document.getElementById('cpf-edit-notes').value.trim(),
                    photo: photoPreview ? photoPreview.src : null,
                    updatedAt: new Date().toISOString()
                };

                if (this.editingId) {
                    const idx = this.products.findIndex(p => p.id === this.editingId);
                    if (idx > -1) this.products[idx] = product;
                } else {
                    this.products.push(product);
                }

                this.save();
                this.updateStats();
                this.populateOriginFilter();
                this.renderProducts();
                this.closeEditModal();
            },

            deleteProduct() {
                if (!this.editingId) return;
                if (confirm('Supprimer ce produit ?')) {
                    this.products = this.products.filter(p => p.id !== this.editingId);
                    this.favorites = this.favorites.filter(f => f !== this.editingId);
                    this.save();
                    this.updateStats();
                    this.populateOriginFilter();
                    this.renderProducts();
                    this.closeEditModal();
                }
            },

            // Import Excel
            importExcel() {
                document.getElementById('cpf-file-input').click();
            },

            handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                        // Parser les données (à partir de la ligne 5)
                        let imported = 0;
                        for (let i = 4; i < rows.length; i++) {
                            const row = rows[i];
                            if (!row || !row[1]) continue; // Pas de code article

                            const product = {
                                id: 'cpf_' + Date.now() + '_' + i,
                                plu: String(row[0] || '').trim(),
                                code: String(row[1] || '').trim(),
                                name: String(row[2] || '').trim(),
                                cut: String(row[3] || '').trim(),
                                origin: String(row[4] || '').trim().toUpperCase(),
                                vat: parseFloat(row[5]) > 1 ? (1 - parseFloat(row[5])) * 100 : 2.6,
                                loss: parseFloat(row[6]) > 0 ? (1 - parseFloat(row[6])) * 100 : 2,
                                price: parseFloat(row[7]) || 0,
                                updatedAt: new Date().toISOString()
                            };

                            // Vérifier si existe déjà
                            const existing = this.products.findIndex(p => p.code === product.code);
                            if (existing > -1) {
                                this.products[existing] = { ...this.products[existing], ...product };
                            } else {
                                this.products.push(product);
                            }
                            imported++;
                        }

                        this.save();
                        this.updateStats();
                        this.populateOriginFilter();
                        this.renderProducts();
                        alert(`✅ ${imported} produits importés !`);
                    } catch (err) {
                        console.error('Erreur import:', err);
                        alert('❌ Erreur lors de l\'import: ' + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
                event.target.value = '';
            },

            // Export Excel
            exportExcel() {
                if (this.products.length === 0) {
                    alert('Aucun produit à exporter');
                    return;
                }

                const sw = v => Math.round(v * 20) / 20; // Arrondi suisse

                const data = [
                    ['PLU', 'CODE', 'DÉSIGNATION', 'DÉCOUPE', 'ORIGINE', 'TVA%', 'PERTE%', 'P.A. HT', 'REVIENT', '+15%', '+20%', '+25%', '+30%', '+40%', '+50%', '+100%', 'PUBLIC TTC']
                ];

                this.products.forEach(p => {
                    const loss = p.loss || 2;
                    const vat = p.vat || 2.6;
                    const price = p.price || 0;
                    const revient = price / (1 - loss / 100);

                    data.push([
                        p.plu || '',
                        p.code || '',
                        p.name || '',
                        p.cut || '',
                        p.origin || '',
                        vat,
                        loss,
                        sw(price),
                        sw(revient),
                        sw(revient / (1 - 15/100)),
                        sw(revient / (1 - 20/100)),
                        sw(revient / (1 - 25/100)),
                        sw(revient / (1 - 30/100)),
                        sw(revient / (1 - 40/100)),
                        sw(revient / (1 - 50/100)),
                        sw(revient * 2),
                        sw(revient * 2 * (1 + vat/100))
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Cours Poissons');
                XLSX.writeFile(wb, 'cours_poissons_' + new Date().toISOString().split('T')[0] + '.xlsx');
            },

            // Impression
            printList() {
                this.printProductList(this.products, 'Cours Poissons Frais');
            },

            printFavorites() {
                const favProducts = this.products.filter(p => this.favorites.includes(p.id));
                this.printProductList(favProducts, 'Favoris - Cours Poissons');
            },

            printProductList(products, title) {
                const now = new Date();
                const weekNum = Math.ceil((now - new Date(now.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));

                let html = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${title}</title>
                        <style>
                            body { font-family: Arial, sans-serif; font-size: 11px; margin: 10mm; }
                            h1 { font-size: 16px; margin-bottom: 5px; }
                            .info { color: #666; margin-bottom: 10px; font-size: 10px; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: left; }
                            th { background: #f0f0f0; font-weight: bold; }
                            .right { text-align: right; }
                            .center { text-align: center; }
                            .price { font-weight: bold; }
                            @media print { body { margin: 5mm; } }
                        </style>
                    </head>
                    <body>
                        <h1>🐟 ${title}</h1>
                        <div class="info">Semaine ${weekNum} - ${now.toLocaleDateString('fr-CH')} • ${products.length} produits</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Désignation</th>
                                    <th class="center">Origine</th>
                                    <th class="right">P.A.</th>
                                    <th class="right">Revient</th>
                                    <th class="right">+30%</th>
                                    <th class="right">+40%</th>
                                    <th class="right">PUBLIC</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                products.forEach(p => {
                    const loss = p.loss || 2;
                    const vat = p.vat || 2.6;
                    const price = p.price || 0;
                    const revient = price / (1 - loss / 100);
                    const m30 = revient / (1 - 30 / 100);
                    const m40 = revient / (1 - 40 / 100);
                    const ttc = revient * 2 * (1 + vat / 100);

                    html += `
                        <tr>
                            <td>${p.code || '-'}</td>
                            <td>${p.name || '-'}</td>
                            <td class="center">${p.origin || '-'}</td>
                            <td class="right">${CPF.swiss(price)}</td>
                            <td class="right">${CPF.swiss(revient)}</td>
                            <td class="right">${CPF.swiss(m30)}</td>
                            <td class="right">${CPF.swiss(m40)}</td>
                            <td class="right price">${CPF.swiss(ttc)}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </body>
                    </html>
                `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(html);
                printWindow.document.close();
                printWindow.print();
            },

            // ===== IMPORT DEPUIS PRIX FOURNISSEURS =====

            // Modal d'import depuis Prix Fournisseurs
            showImportFromPFModal() {
                // Récupérer les produits de Prix Fournisseurs
                const pfProducts = JSON.parse(localStorage.getItem('pf_products') || '[]');
                const pfSuppliers = JSON.parse(localStorage.getItem('pf_suppliers') || '[]');

                if (pfProducts.length === 0) {
                    alert('⚠️ Aucun produit dans Prix Fournisseurs.\nImportez d\'abord une liste de prix.');
                    return;
                }

                // Compter les nouveaux et mises à jour
                let newCount = 0;
                let updateCount = 0;
                pfProducts.forEach(pf => {
                    const existing = this.products.find(p => p.pfId === pf.id || (p.name || '').toLowerCase() === (pf.name || '').toLowerCase());
                    if (existing) updateCount++;
                    else newCount++;
                });

                const modal = document.createElement('div');
                modal.id = 'cpf-import-pf-modal';
                modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); z-index:10000; display:flex; justify-content:center; align-items:center; padding:20px;';
                modal.innerHTML = `
                    <div style="background:var(--bg-card); border-radius:16px; max-width:500px; width:100%; max-height:90vh; overflow-y:auto;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); background:linear-gradient(135deg, #f39c1220, #e74c3c20);">
                            <h2 style="font-size:18px; font-weight:700; margin:0;">🔄 Synchroniser depuis Prix Fournisseurs</h2>
                            <p style="color:var(--text-muted); font-size:12px; margin-top:4px;">Importer et mettre à jour les prix</p>
                        </div>

                        <div style="padding:20px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                                <div style="background:var(--bg-primary); border-radius:10px; padding:16px; text-align:center;">
                                    <div style="font-size:32px; font-weight:700; color:var(--accent-primary);">${pfProducts.length}</div>
                                    <div style="font-size:12px; color:var(--text-muted);">Produits disponibles</div>
                                </div>
                                <div style="background:var(--bg-primary); border-radius:10px; padding:16px; text-align:center;">
                                    <div style="font-size:32px; font-weight:700; color:var(--accent-secondary);">${pfSuppliers.length}</div>
                                    <div style="font-size:12px; color:var(--text-muted);">Fournisseurs</div>
                                </div>
                            </div>

                            <div style="background:var(--bg-primary); border-radius:10px; padding:16px; margin-bottom:20px;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                    <span style="color:var(--text-muted);">Nouveaux produits:</span>
                                    <span style="font-weight:700; color:#2ecc71;">${newCount}</span>
                                </div>
                                <div style="display:flex; justify-content:space-between;">
                                    <span style="color:var(--text-muted);">Mises à jour prix:</span>
                                    <span style="font-weight:700; color:var(--accent-warning);">${updateCount}</span>
                                </div>
                            </div>

                            <div style="margin-bottom:20px;">
                                <label style="font-size:12px; color:var(--text-muted); display:block; margin-bottom:6px;">Perte par défaut (%)</label>
                                <input type="number" id="cpf-import-loss" value="2" min="0" max="50" step="0.5" style="width:100%; padding:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            </div>

                            <div style="margin-bottom:20px;">
                                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                    <input type="checkbox" id="cpf-import-overwrite" checked style="width:18px; height:18px;">
                                    <span style="font-size:13px;">Mettre à jour les prix existants</span>
                                </label>
                            </div>

                            <div style="margin-bottom:20px;">
                                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                    <input type="checkbox" id="cpf-import-backup" checked style="width:18px; height:18px;">
                                    <span style="font-size:13px;">Sauvegarder dans l'historique</span>
                                </label>
                            </div>

                            <div style="display:flex; gap:10px;">
                                <button onclick="document.getElementById('cpf-import-pf-modal').remove();" style="flex:1; padding:14px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; font-weight:600; cursor:pointer;">Annuler</button>
                                <button onclick="CPF.importFromPF()" style="flex:2; padding:14px; background:linear-gradient(135deg, #f39c12, #e74c3c); color:#fff; border:none; border-radius:10px; font-weight:700; cursor:pointer;">🔄 Synchroniser</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            // Importer depuis Prix Fournisseurs
            importFromPF() {
                const pfProducts = JSON.parse(localStorage.getItem('pf_products') || '[]');
                const defaultLoss = parseFloat(document.getElementById('cpf-import-loss').value) || 2;
                const overwrite = document.getElementById('cpf-import-overwrite').checked;
                const backup = document.getElementById('cpf-import-backup').checked;

                if (pfProducts.length === 0) {
                    alert('Aucun produit à importer');
                    return;
                }

                // Sauvegarde dans l'historique si demandé
                if (backup && this.products.length > 0) {
                    const now = new Date();
                    const weekNum = Math.ceil((now - new Date(now.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
                    this.history.push({
                        id: 'H' + Date.now(),
                        date: now.toISOString(),
                        week: weekNum,
                        year: now.getFullYear(),
                        products: JSON.parse(JSON.stringify(this.products)),
                        count: this.products.length,
                        source: 'Sauvegarde avant sync'
                    });
                }

                let imported = 0;
                let updated = 0;

                pfProducts.forEach(pf => {
                    // Chercher si le produit existe déjà
                    const existingIdx = this.products.findIndex(p =>
                        p.pfId === pf.id ||
                        (p.name || '').toLowerCase() === (pf.name || '').toLowerCase()
                    );

                    const cpfProduct = {
                        id: existingIdx >= 0 ? this.products[existingIdx].id : 'CPF' + Date.now() + Math.random().toString(36).substr(2, 5),
                        pfId: pf.id,
                        name: pf.name || pf.nameShort,
                        nameShort: pf.nameShort,
                        code: pf.code || '',
                        plu: existingIdx >= 0 ? this.products[existingIdx].plu : '',
                        origin: pf.origin || '',
                        price: pf.price || 0,
                        loss: existingIdx >= 0 ? (this.products[existingIdx].loss || defaultLoss) : defaultLoss,
                        vat: existingIdx >= 0 ? (this.products[existingIdx].vat || 2.6) : 2.6,
                        unit: pf.unit || 'kg',
                        supplierId: pf.supplierId,
                        lastSync: new Date().toISOString()
                    };

                    if (existingIdx >= 0) {
                        if (overwrite) {
                            // Conserver PLU, loss, vat de l'ancien
                            cpfProduct.plu = this.products[existingIdx].plu || cpfProduct.plu;
                            cpfProduct.loss = this.products[existingIdx].loss || cpfProduct.loss;
                            cpfProduct.vat = this.products[existingIdx].vat || cpfProduct.vat;
                            this.products[existingIdx] = cpfProduct;
                            updated++;
                        }
                    } else {
                        this.products.push(cpfProduct);
                        imported++;
                    }
                });

                // Trier par nom
                this.products.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'fr'));

                this.save();
                this.updateStats();
                this.renderProducts();
                this.populateOriginFilter();

                // Fermer le modal
                document.getElementById('cpf-import-pf-modal')?.remove();

                showToast(`✅ Sync terminée: ${imported} nouveaux, ${updated} mis à jour`);
            }
        };

        // Init au chargement de la page
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.dataset.page === 'cours-poissons') {
                    setTimeout(() => CPF.init(), 100);
                }
            });
        });

        // Exposer globalement
        window.CPF = CPF;
    </script>

    <!-- ========================================
         MYFISH PRO - Commandes Clients Privés B2C
         ======================================== -->
    <script>
        const MFData = {
            clients: JSON.parse(localStorage.getItem('mf_clients') || '[]'),
            stores: JSON.parse(localStorage.getItem('mf_stores') || '[]'),
            orders: JSON.parse(localStorage.getItem('mf_orders') || '[]'),
            currentOrder: {
                client: null,
                store: null,
                pickupDate: '',
                pickupTime: '',
                cart: [],
                notes: ''
            },
            currentStep: 1,
            clientType: 'B2C' // 'B2C' ou 'B2B'
        };

        // Fonction pour basculer entre B2B et B2C
        function setMFClientType(type) {
            MFData.clientType = type;

            // Mettre à jour l'UI des boutons
            const b2cBtn = document.getElementById('mf-type-b2c');
            const b2bBtn = document.getElementById('mf-type-b2b');

            if (type === 'B2C') {
                b2cBtn.style.border = '3px solid var(--accent-primary)';
                b2cBtn.style.background = 'rgba(6,214,160,0.15)';
                b2bBtn.style.border = '3px solid var(--border-color)';
                b2bBtn.style.background = 'var(--bg-primary)';
            } else {
                b2bBtn.style.border = '3px solid var(--accent-secondary)';
                b2bBtn.style.background = 'rgba(17,138,178,0.15)';
                b2cBtn.style.border = '3px solid var(--border-color)';
                b2cBtn.style.background = 'var(--bg-primary)';
            }

            // Mettre à jour le formulaire
            const b2bFields = document.getElementById('mf-b2b-fields');
            const b2cFields = document.getElementById('mf-b2c-fields');
            const formTitle = document.getElementById('mf-form-title');

            if (type === 'B2B') {
                b2bFields.style.display = 'block';
                b2cFields.style.display = 'none';
                formTitle.innerHTML = '<span>➕</span> Nouveau client professionnel';
            } else {
                b2bFields.style.display = 'none';
                b2cFields.style.display = 'grid';
                formTitle.innerHTML = '<span>➕</span> Nouveau client particulier';
            }

            // Réinitialiser la recherche
            document.getElementById('mf-client-search').value = '';
            document.getElementById('mf-client-results').style.display = 'none';
            clearMFClient();
        }

        // Obtenir tous les clients selon le type sélectionné (base unifiée QOData)
        function getMFClients() {
            const allClients = QOData?.clients || [];

            if (MFData.clientType === 'B2B') {
                // Filtrer les clients B2B
                return allClients.filter(c => (c.clientType || 'b2b').toUpperCase() === 'B2B').map(c => ({
                    ...c,
                    clientType: 'B2B',
                    // Normaliser les champs
                    lastname: c.name || c.lastname || '',
                    firstname: c.contact || c.firstname || '',
                    city: c.city || '',
                    mobile: c.mobile || '',
                    phone: c.phone || '',
                    email: c.email || '',
                    address: c.address || '',
                    zip: c.zip || '',
                    allergies: c.allergies || '',
                    notes: c.notes || '',
                    active: c.active !== false
                }));
            } else {
                // Filtrer les clients B2C
                return allClients.filter(c => (c.clientType || 'b2b').toUpperCase() === 'B2C').map(c => ({
                    ...c,
                    clientType: 'B2C'
                }));
            }
        }

        // Initialisation des données exemples
        function initMFSampleData() {
            // Horaires par défaut
            const defaultHours = {
                mon: { open: true, start: '08:00', end: '18:00' },
                tue: { open: true, start: '08:00', end: '18:00' },
                wed: { open: true, start: '08:00', end: '18:00' },
                thu: { open: true, start: '08:00', end: '18:00' },
                fri: { open: true, start: '08:00', end: '18:00' },
                sat: { open: true, start: '08:00', end: '12:00' },
                sun: { open: false, start: '09:00', end: '12:00' }
            };

            if (MFData.stores.length === 0) {
                MFData.stores = [
                    {
                        id: 1,
                        name: 'Borex Lausanne',
                        address: 'Rue du Lac 15, 1000 Lausanne',
                        email: 'lausanne@borex-poissons.ch',
                        phone: '+41 21 312 45 67',
                        slotDuration: 60,
                        hours: defaultHours,
                        exceptionalDays: [
                            { date: '2024-12-24', label: 'Veille de Noël', closed: false, start: '08:00', end: '14:00' },
                            { date: '2024-12-25', label: 'Noël', closed: true },
                            { date: '2024-12-31', label: 'Saint-Sylvestre', closed: false, start: '08:00', end: '16:00' },
                            { date: '2025-01-01', label: 'Nouvel An', closed: true }
                        ]
                    },
                    {
                        id: 2,
                        name: 'Borex Nyon',
                        address: 'Grand-Rue 22, 1260 Nyon',
                        email: 'nyon@borex-poissons.ch',
                        phone: '+41 22 361 89 00',
                        slotDuration: 60,
                        hours: defaultHours,
                        exceptionalDays: []
                    },
                    {
                        id: 3,
                        name: 'Borex Genève',
                        address: 'Rue du Rhône 8, 1204 Genève',
                        email: 'geneve@borex-poissons.ch',
                        phone: '+41 22 310 12 34',
                        slotDuration: 60,
                        hours: defaultHours,
                        exceptionalDays: []
                    }
                ];
                saveMFData('stores');
            }

            // ========== MIGRATION CLIENTS B2C VERS BASE UNIFIÉE ==========
            // Migrer les anciens clients MFData vers QOData.clients
            if (MFData.clients && MFData.clients.length > 0) {
                console.log('🔄 Migration clients B2C vers base unifiée...');
                let migrated = 0;
                MFData.clients.forEach(mfClient => {
                    // Vérifier si ce client n'existe pas déjà dans QOData
                    const exists = QOData.clients.some(c =>
                        c.id === mfClient.id ||
                        (c.mobile === mfClient.mobile && c.lastname === mfClient.lastname)
                    );
                    if (!exists) {
                        QOData.clients.push({
                            ...mfClient,
                            clientType: 'B2C'
                        });
                        migrated++;
                    }
                });
                if (migrated > 0) {
                    localStorage.setItem('qo_clients', JSON.stringify(QOData.clients));
                    console.log(`✅ ${migrated} clients B2C migrés vers QOData.clients`);
                }
                // Vider l'ancienne base pour éviter les doublons futurs
                MFData.clients = [];
                localStorage.removeItem('mf_clients');
            }

            // Ajouter des clients B2C exemples si aucun n'existe
            const b2cClients = QOData.clients.filter(c => (c.clientType || 'b2b').toUpperCase() === 'B2C');
            if (b2cClients.length === 0) {
                const sampleB2C = [
                    { id: Date.now(), lastname: 'Dupont', firstname: 'Jean', address: 'Rue de la Gare 5', zip: '1000', city: 'Lausanne', mobile: '+41 79 123 45 67', phone: '+41 21 312 00 00', email: 'jean.dupont@email.ch', allergies: '', notes: '', active: true, clientType: 'B2C' },
                    { id: Date.now() + 1, lastname: 'Martin', firstname: 'Sophie', address: 'Avenue du Léman 12', zip: '1260', city: 'Nyon', mobile: '+41 78 987 65 43', phone: '', email: 'sophie.martin@bluewin.ch', allergies: 'Crustacés', notes: 'Cliente fidèle', active: true, clientType: 'B2C' }
                ];
                QOData.clients.push(...sampleB2C);
                localStorage.setItem('qo_clients', JSON.stringify(QOData.clients));
            }
        }

        function saveMFData(type) {
            localStorage.setItem('mf_' + type, JSON.stringify(MFData[type]));
        }

        // ========== DASHBOARD ==========
        function initMFDashboard() {
            initMFSampleData();
            updateMFStats();
            renderMFStoresTiles();
            renderMFOrders();
            populateMFFilters();
        }

        function updateMFStats() {
            const today = new Date().toISOString().split('T')[0];
            const orders = MFData.orders;

            document.getElementById('mf-stat-total').textContent = orders.length;
            document.getElementById('mf-stat-pending').textContent = orders.filter(o => o.status === 'pending').length;
            document.getElementById('mf-stat-confirmed').textContent = orders.filter(o => o.status === 'confirmed').length;
            document.getElementById('mf-stat-ready').textContent = orders.filter(o => o.status === 'ready').length;
        }

        function renderMFStoresTiles() {
            const container = document.getElementById('mf-stores-dashboard');
            if (!container) return;

            // Calculer les stats par magasin
            const storesWithStats = MFData.stores.map(store => {
                const storeOrders = MFData.orders.filter(o => o.storeId === store.id);
                return {
                    ...store,
                    total: storeOrders.length,
                    pending: storeOrders.filter(o => o.status === 'pending').length,
                    confirmed: storeOrders.filter(o => o.status === 'confirmed').length,
                    ready: storeOrders.filter(o => o.status === 'ready').length
                };
            });

            // Trier par nombre de commandes en attente (plus urgentes en premier)
            storesWithStats.sort((a, b) => b.pending - a.pending);

            container.innerHTML = `
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:12px;">
                    ${storesWithStats.map(store => {
                        const hasUrgent = store.pending > 0;
                        const urgentColor = hasUrgent ? '#f4a261' : 'var(--border-color)';

                        return `
                            <div onclick="filterMFOrdersByStore(${store.id})"
                                style="cursor:pointer; background:var(--bg-card); border-radius:16px; overflow:hidden;
                                       border:3px solid ${urgentColor}; transition:all 0.2s;
                                       ${hasUrgent ? 'box-shadow:0 0 20px ' + urgentColor + '40;' : ''}"
                                onmouseover="this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.transform='translateY(0)'">

                                <!-- Header du magasin -->
                                <div style="padding:16px; background:linear-gradient(135deg, var(--bg-primary), var(--bg-card)); border-bottom:1px solid var(--border-color);">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div style="display:flex; align-items:center; gap:12px;">
                                            <div style="width:44px; height:44px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px;">
                                                🏪
                                            </div>
                                            <div>
                                                <div style="font-weight:700; font-size:16px;">${store.name}</div>
                                                <div style="font-size:11px; color:var(--text-muted);">${store.total} commande${store.total > 1 ? 's' : ''}</div>
                                            </div>
                                        </div>
                                        ${hasUrgent ? `
                                            <div style="background:#f4a261; color:#000; padding:6px 12px; border-radius:20px; font-weight:700; font-size:12px; animation:pulse 2s infinite;">
                                                ${store.pending} en attente
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>

                                <!-- Stats du magasin -->
                                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:0;">
                                    <!-- En attente -->
                                    <div style="padding:14px 8px; text-align:center; background:${store.pending > 0 ? '#f4a26115' : 'transparent'}; border-right:1px solid var(--border-color);">
                                        <div style="font-size:28px; font-weight:800; color:${store.pending > 0 ? '#f4a261' : 'var(--text-muted)'};">
                                            ${store.pending}
                                        </div>
                                        <div style="font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Attente</div>
                                    </div>
                                    <!-- Confirmées -->
                                    <div style="padding:14px 8px; text-align:center; background:${store.confirmed > 0 ? '#118ab215' : 'transparent'}; border-right:1px solid var(--border-color);">
                                        <div style="font-size:28px; font-weight:800; color:${store.confirmed > 0 ? '#118ab2' : 'var(--text-muted)'};">
                                            ${store.confirmed}
                                        </div>
                                        <div style="font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Confirm.</div>
                                    </div>
                                    <!-- Prêtes -->
                                    <div style="padding:14px 8px; text-align:center; background:${store.ready > 0 ? '#06d6a015' : 'transparent'};">
                                        <div style="font-size:28px; font-weight:800; color:${store.ready > 0 ? '#06d6a0' : 'var(--text-muted)'};">
                                            ${store.ready}
                                        </div>
                                        <div style="font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Prêtes</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function populateMFFilters() {
            const storeSelect = document.getElementById('mf-filter-store');
            if (storeSelect) {
                storeSelect.innerHTML = '<option value="">Tous les magasins</option>' +
                    MFData.stores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            }
        }

        function renderMFOrders() {
            const tbody = document.getElementById('mf-orders-tbody');
            if (!tbody) return;

            const filterStore = document.getElementById('mf-filter-store')?.value || '';
            const filterStatus = document.getElementById('mf-filter-status')?.value || '';
            const filterDate = document.getElementById('mf-filter-date')?.value || '';

            let orders = [...MFData.orders].reverse();

            if (filterStore) orders = orders.filter(o => o.storeId == filterStore);
            if (filterStatus) orders = orders.filter(o => o.status === filterStatus);
            if (filterDate) orders = orders.filter(o => o.pickupDate === filterDate);

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">Aucune commande</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => {
                // Base unifiée QOData.clients
                let client = (QOData?.clients || []).find(c => c.id === order.clientId);

                const store = MFData.stores.find(s => s.id === order.storeId);
                const statusLabels = {
                    pending: '<span style="padding:4px 10px; background:#ffd16620; color:#ffd166; border-radius:12px; font-size:12px;">⏳ En attente</span>',
                    confirmed: '<span style="padding:4px 10px; background:#06d6a020; color:#06d6a0; border-radius:12px; font-size:12px;">✅ Confirmée</span>',
                    ready: '<span style="padding:4px 10px; background:#118ab220; color:#118ab2; border-radius:12px; font-size:12px;">🎉 Prête</span>',
                    delivered: '<span style="padding:4px 10px; background:#9e9e9e20; color:#9e9e9e; border-radius:12px; font-size:12px;">🤝 Remise</span>'
                };

                // Afficher le nom selon le type
                let clientName = 'Inconnu';
                let typeBadge = '';
                if (client) {
                    if (client.name) {
                        // Client B2B
                        clientName = client.name;
                        typeBadge = '<span style="font-size:10px; background:var(--accent-secondary)20; color:var(--accent-secondary); padding:2px 6px; border-radius:4px; margin-left:6px;">B2B</span>';
                    } else {
                        // Client B2C
                        clientName = client.lastname + ' ' + (client.firstname || '');
                        typeBadge = '<span style="font-size:10px; background:var(--accent-primary)20; color:var(--accent-primary); padding:2px 6px; border-radius:4px; margin-left:6px;">B2C</span>';
                    }
                }

                return `
                    <tr>
                        <td style="font-weight:600;">#${order.id}</td>
                        <td>${clientName}${typeBadge}</td>
                        <td>${store ? store.name : '-'}</td>
                        <td>${formatDate(order.pickupDate)}</td>
                        <td>${order.pickupTime}</td>
                        <td style="font-family:'Space Mono',monospace; font-weight:600;">${order.total.toFixed(2)} CHF</td>
                        <td>${statusLabels[order.status] || order.status}</td>
                        <td>
                            <button onclick="showMFOrderDetail(${order.id})" style="padding:6px 12px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); cursor:pointer; margin-right:4px;">👁️</button>
                            <button onclick="printMFOrderById(${order.id})" style="padding:6px 12px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); cursor:pointer;">🖨️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterMFOrdersByStore(storeId) {
            document.getElementById('mf-filter-store').value = storeId;
            renderMFOrders();
        }

        function filterMFOrdersByStatus(status) {
            document.getElementById('mf-filter-status').value = status;
            renderMFOrders();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-CH');
        }

        // ========== NOUVELLE COMMANDE - WORKFLOW 5 ÉTAPES ==========
        function startMFNewOrder() {
            // Reset current order
            MFData.currentOrder = {
                client: null,
                store: null,
                pickupDate: '',
                pickupTime: '',
                cart: [],
                notes: ''
            };
            MFData.currentStep = 1;
            MFData.clientType = 'B2C'; // Par défaut, client particulier

            // Afficher le modal de sélection rapide
            showMFQuickSelectModal();
        }

        // ========== MODAL SÉLECTION RAPIDE CLIENT ==========
        function showMFQuickSelectModal() {
            // Compter les clients actifs par type
            const allClients = QOData?.clients || [];
            const b2cActive = allClients.filter(c => (c.clientType || 'b2b').toLowerCase() === 'b2c' && c.active !== false).length;
            const b2bActive = allClients.filter(c => (c.clientType || 'b2b').toLowerCase() === 'b2b' && c.active !== false).length;

            document.getElementById('mf-qs-count-b2c').textContent = b2cActive;
            document.getElementById('mf-qs-count-b2b').textContent = b2bActive;

            // Par défaut B2C
            setMFQuickSelectType('b2c');

            document.getElementById('mf-quick-select-modal').style.display = 'flex';
        }

        function closeMFQuickSelectModal() {
            document.getElementById('mf-quick-select-modal').style.display = 'none';
        }

        function setMFQuickSelectType(type) {
            MFData.clientType = type.toUpperCase();

            const b2cBtn = document.getElementById('mf-qs-type-b2c');
            const b2bBtn = document.getElementById('mf-qs-type-b2b');

            if (type === 'b2c') {
                b2cBtn.style.border = '3px solid var(--accent-warning)';
                b2cBtn.style.background = 'rgba(255,183,77,0.15)';
                b2bBtn.style.border = '3px solid var(--border-color)';
                b2bBtn.style.background = 'var(--bg-primary)';
            } else {
                b2bBtn.style.border = '3px solid var(--accent-secondary)';
                b2bBtn.style.background = 'rgba(17,138,178,0.15)';
                b2cBtn.style.border = '3px solid var(--border-color)';
                b2cBtn.style.background = 'var(--bg-primary)';
            }

            // Afficher les top clients du type sélectionné
            renderMFTopClients(type);
        }

        function renderMFTopClients(type) {
            const container = document.getElementById('mf-qs-top-clients');
            const allClients = QOData?.clients || [];

            // Filtrer par type et actifs
            let clients = allClients.filter(c =>
                (c.clientType || 'b2b').toLowerCase() === type &&
                c.active !== false
            );

            // Trier par nombre de commandes (ordersCount) puis par date de création (id plus récent)
            clients.sort((a, b) => {
                const countA = a.ordersCount || 0;
                const countB = b.ordersCount || 0;
                if (countB !== countA) return countB - countA;
                return (b.id || 0) - (a.id || 0);
            });

            // Prendre les 10 premiers
            const topClients = clients.slice(0, 10);

            if (topClients.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:30px; color:var(--text-muted);">
                        <div style="font-size:40px; margin-bottom:10px;">📭</div>
                        <div>Aucun client ${type === 'b2c' ? 'particulier' : 'professionnel'} actif</div>
                        <div style="font-size:12px; margin-top:8px;">Créez un nouveau client pour commencer</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = topClients.map(c => {
                const isB2B = type === 'b2b';
                const displayName = isB2B ? (c.name || c.lastname || '-') : `${c.lastname || ''} ${c.firstname || ''}`.trim();
                const displayCity = c.city || '';
                const ordersCount = c.ordersCount || 0;

                return `
                    <div onclick="mfQuickSelectClient(${c.id})" style="padding:14px 16px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:10px; cursor:pointer; display:flex; align-items:center; gap:12px; transition:all 0.2s;" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                        <div style="width:40px; height:40px; background:${isB2B ? 'rgba(17,138,178,0.2)' : 'rgba(255,183,77,0.2)'}; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px;">
                            ${isB2B ? '🏢' : '👤'}
                        </div>
                        <div style="flex:1; min-width:0;">
                            <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${displayName}</div>
                            <div style="font-size:12px; color:var(--text-muted);">${displayCity}</div>
                        </div>
                        ${ordersCount > 0 ? `<div style="padding:4px 10px; background:var(--bg-hover); border-radius:12px; font-size:11px; color:var(--text-muted);">${ordersCount} cmd</div>` : ''}
                        <div style="color:var(--accent-primary); font-size:18px;">→</div>
                    </div>
                `;
            }).join('');
        }

        function mfQuickSelectClient(clientId) {
            const client = (QOData?.clients || []).find(c => c.id === clientId);
            if (!client) return;

            // Fermer le modal
            closeMFQuickSelectModal();

            // Afficher la vue nouvelle commande directement à l'étape 2 (lieu de retrait)
            document.getElementById('mf-view-dashboard').style.display = 'none';
            document.getElementById('mf-view-neworder').style.display = 'block';

            // Mettre le type du client (AVANT de définir le client car setMFClientType appelle clearMFClient)
            const clientType = (client.clientType || 'b2b').toUpperCase();
            setMFClientType(clientType);

            // IMPORTANT: Configurer la commande avec ce client APRÈS setMFClientType
            MFData.currentOrder.client = client;

            const isB2B = clientType === 'B2B';
            const displayName = isB2B ? (client.name || client.lastname) : `${client.lastname || ''} ${client.firstname || ''}`.trim();

            const selectedDiv = document.getElementById('mf-selected-client');
            selectedDiv.innerHTML = `
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:50px; height:50px; background:${isB2B ? 'rgba(17,138,178,0.2)' : 'rgba(255,183,77,0.2)'}; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;">
                        ${isB2B ? '🏢' : '👤'}
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:700; font-size:16px;">${displayName}</div>
                        <div style="font-size:13px; color:var(--text-muted);">📍 ${client.city || '-'} • 📞 ${client.mobile || client.phone || '-'}</div>
                        ${client.allergies ? `<div style="font-size:12px; color:var(--accent-danger); margin-top:4px;">⚠️ ${client.allergies}</div>` : ''}
                    </div>
                    <button onclick="clearMFClient()" style="padding:8px 12px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:8px; cursor:pointer; color:var(--text-muted);">✕</button>
                </div>
            `;
            selectedDiv.style.display = 'block';
            document.getElementById('mf-step1-next').style.display = 'block';

            // Initialiser date à aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('mf-pickup-date');
            if (dateInput) dateInput.value = today;

            updateMFProgress();
            goToMFStep(1);
        }

        function mfQuickSelectNewClient() {
            closeMFQuickSelectModal();

            // Afficher la vue nouvelle commande
            document.getElementById('mf-view-dashboard').style.display = 'none';
            document.getElementById('mf-view-neworder').style.display = 'block';

            // Reset formulaires
            document.getElementById('mf-client-search').value = '';
            document.getElementById('mf-selected-client').style.display = 'none';
            document.getElementById('mf-step1-next').style.display = 'none';

            // Mettre le type sélectionné
            setMFClientType(MFData.clientType);

            // Ouvrir le formulaire nouveau client
            showMFQuickClientForm();

            // Initialiser date à aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('mf-pickup-date');
            if (dateInput) dateInput.value = today;

            updateMFProgress();
            goToMFStep(1);
        }

        function mfQuickSelectSearchClient() {
            closeMFQuickSelectModal();

            // Afficher la vue nouvelle commande
            document.getElementById('mf-view-dashboard').style.display = 'none';
            document.getElementById('mf-view-neworder').style.display = 'block';

            // Reset formulaires
            document.getElementById('mf-client-search').value = '';
            document.getElementById('mf-selected-client').style.display = 'none';
            document.getElementById('mf-step1-next').style.display = 'none';
            hideMFQuickClientForm();

            // Mettre le type sélectionné
            setMFClientType(MFData.clientType);

            // Focus sur la recherche
            setTimeout(() => {
                document.getElementById('mf-client-search').focus();
            }, 100);

            // Initialiser date à aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('mf-pickup-date');
            if (dateInput) dateInput.value = today;

            updateMFProgress();
            goToMFStep(1);
        }

        function cancelMFOrder() {
            if (MFData.currentOrder.cart.length > 0) {
                if (!confirm('Abandonner cette commande ?')) return;
            }
            document.getElementById('mf-view-neworder').style.display = 'none';
            document.getElementById('mf-view-dashboard').style.display = 'block';
            initMFDashboard();
        }

        function updateMFProgress() {
            const steps = document.querySelectorAll('.mf-step');
            const progressLine = document.getElementById('mf-progress-line');
            const currentStep = MFData.currentStep;

            steps.forEach((step, idx) => {
                const stepNum = idx + 1;
                const circle = step.querySelector('div');
                const label = step.querySelectorAll('div')[1];

                if (stepNum < currentStep) {
                    // Complété
                    circle.style.background = 'var(--accent-primary)';
                    circle.style.color = '#000';
                    circle.style.borderColor = 'var(--accent-primary)';
                    circle.innerHTML = '✓';
                    label.style.color = 'var(--accent-primary)';
                } else if (stepNum === currentStep) {
                    // Actuel
                    circle.style.background = 'var(--accent-primary)';
                    circle.style.color = '#000';
                    circle.style.border = 'none';
                    circle.innerHTML = stepNum;
                    label.style.color = 'var(--accent-primary)';
                } else {
                    // À venir
                    circle.style.background = 'var(--bg-hover)';
                    circle.style.color = 'var(--text-muted)';
                    circle.style.border = '2px solid var(--border-color)';
                    circle.innerHTML = stepNum;
                    label.style.color = 'var(--text-muted)';
                }
            });

            // Ligne de progression
            const progressPercent = ((currentStep - 1) / 4) * 80;
            progressLine.style.width = progressPercent + '%';
        }

        function goToMFStep(step) {
            // Validation avant de changer d'étape
            if (step > 1 && !MFData.currentOrder.client) {
                alert('Veuillez sélectionner un client');
                return;
            }
            if (step > 2 && (!MFData.currentOrder.store || !MFData.currentOrder.pickupDate || !MFData.currentOrder.pickupTime)) {
                alert('Veuillez choisir le lieu et la date de retrait');
                return;
            }
            if (step > 3 && MFData.currentOrder.cart.length === 0) {
                alert('Veuillez ajouter au moins un article');
                return;
            }

            MFData.currentStep = step;
            updateMFProgress();

            // Cacher toutes les étapes
            document.querySelectorAll('.mf-step-content').forEach(el => el.style.display = 'none');
            document.getElementById('mf-step-' + step).style.display = 'block';

            // Actions spécifiques par étape
            if (step === 2) {
                renderMFStoresSelection();
                updateMFStep2Info();
            } else if (step === 3) {
                renderMFArticlesList();
                updateMFCart();
            } else if (step === 4) {
                renderMFRecap();
            } else if (step === 5) {
                renderMFFinal();
            }
        }

        // ========== ÉTAPE 1: CLIENT ==========
        function searchMFClients(query) {
            const resultsDiv = document.getElementById('mf-client-results');
            if (!query || query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            const q = query.toLowerCase();
            const allClients = getMFClients();

            const matches = allClients.filter(c => {
                const searchName = (c.lastname + ' ' + (c.firstname || '')).toLowerCase();
                const searchCompany = (c.name || '').toLowerCase();
                return (
                    searchName.includes(q) ||
                    searchCompany.includes(q) ||
                    (c.mobile && c.mobile.includes(q)) ||
                    (c.phone && c.phone.includes(q)) ||
                    (c.city && c.city.toLowerCase().includes(q))
                );
            }).slice(0, 15);

            if (matches.length === 0) {
                resultsDiv.innerHTML = '<div style="padding:16px; text-align:center; color:var(--text-muted);">Aucun client trouvé</div>';
            } else {
                resultsDiv.innerHTML = matches.map(c => {
                    const displayName = MFData.clientType === 'B2B'
                        ? `<span style="color:var(--accent-secondary);">🏢</span> ${c.name || c.lastname}` + (c.contact || c.firstname ? ` <span style="font-weight:400; color:var(--text-muted);">(${c.contact || c.firstname})</span>` : '')
                        : `<span style="color:var(--accent-primary);">👤</span> ${c.lastname} ${c.firstname || ''}`;

                    return `
                        <div onclick="selectMFClient(${c.id})" style="padding:14px 18px; cursor:pointer; border-bottom:1px solid var(--border-color); transition:background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                            <div style="font-weight:600;">${displayName}</div>
                            <div style="font-size:12px; color:var(--text-muted);">📞 ${c.mobile || c.phone || '-'} • ${c.city || ''}</div>
                            ${c.allergies ? `<div style="font-size:11px; color:var(--accent-danger);">⚠️ ${c.allergies}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }
            resultsDiv.style.display = 'block';
        }

        function selectMFClient(id) {
            const allClients = getMFClients();
            const client = allClients.find(c => c.id === id);
            if (!client) return;

            // Stocker le type de client dans la commande
            client.clientType = MFData.clientType;
            MFData.currentOrder.client = client;

            document.getElementById('mf-client-search').value = '';
            document.getElementById('mf-client-results').style.display = 'none';

            // Affichage selon le type
            const displayName = MFData.clientType === 'B2B'
                ? (client.name || client.lastname) + (client.contact || client.firstname ? ` (${client.contact || client.firstname})` : '')
                : client.lastname + ' ' + (client.firstname || '');

            const typeBadge = MFData.clientType === 'B2B'
                ? '<span style="display:inline-block; padding:2px 8px; background:var(--accent-secondary); color:#fff; border-radius:4px; font-size:10px; margin-left:8px;">B2B</span>'
                : '<span style="display:inline-block; padding:2px 8px; background:var(--accent-primary); color:#000; border-radius:4px; font-size:10px; margin-left:8px;">B2C</span>';

            document.getElementById('mf-client-display-name').innerHTML = displayName + typeBadge;
            document.getElementById('mf-client-display-phone').textContent = client.mobile || client.phone || '-';
            document.getElementById('mf-client-display-email').textContent = client.email || '-';
            document.getElementById('mf-client-display-address').textContent = client.address ? `${client.address}, ${client.zip || ''} ${client.city || ''}` : client.city || '';

            const allergiesEl = document.getElementById('mf-client-display-allergies');
            if (client.allergies) {
                allergiesEl.textContent = '⚠️ Allergies: ' + client.allergies;
                allergiesEl.style.display = 'block';
            } else {
                allergiesEl.style.display = 'none';
            }

            document.getElementById('mf-selected-client').style.display = 'block';
            document.getElementById('mf-step1-next').style.display = 'block';
            hideMFQuickClientForm();
        }

        function clearMFClient() {
            MFData.currentOrder.client = null;
            document.getElementById('mf-selected-client').style.display = 'none';
            document.getElementById('mf-step1-next').style.display = 'none';
            document.getElementById('mf-client-search').focus();
        }

        function showMFQuickClientForm() {
            document.getElementById('mf-quick-client-form').style.display = 'block';
            document.getElementById('mf-new-lastname').focus();
        }

        function hideMFQuickClientForm() {
            document.getElementById('mf-quick-client-form').style.display = 'none';
            // Reset tous les champs (B2B et B2C)
            ['mf-new-lastname', 'mf-new-firstname', 'mf-new-company', 'mf-new-contact', 'mf-new-address', 'mf-new-zip', 'mf-new-city', 'mf-new-mobile', 'mf-new-phone', 'mf-new-email', 'mf-new-allergies', 'mf-new-notes'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        }

        function saveMFQuickClient() {
            let newClient;

            if (MFData.clientType === 'B2B') {
                // Client professionnel
                const company = document.getElementById('mf-new-company').value.trim();
                const mobile = document.getElementById('mf-new-mobile').value.trim();
                const city = document.getElementById('mf-new-city').value.trim();

                if (!company) { alert('Le nom de l\'entreprise est requis'); return; }
                if (!mobile) { alert('Le téléphone est requis'); return; }
                if (!city) { alert('Le lieu est requis'); return; }

                newClient = {
                    id: Date.now(),
                    num: String(Date.now()).slice(-6),
                    name: company,
                    contact: document.getElementById('mf-new-contact').value.trim(),
                    address: document.getElementById('mf-new-address').value.trim(),
                    address2: '',
                    zip: document.getElementById('mf-new-zip').value.trim(),
                    city,
                    phone: document.getElementById('mf-new-phone').value.trim(),
                    mobile,
                    email: document.getElementById('mf-new-email').value.trim(),
                    allergies: document.getElementById('mf-new-allergies').value.trim(),
                    notes: document.getElementById('mf-new-notes').value.trim(),
                    credit: 0,
                    payment: '30 jours fin de mois',
                    ordersCount: 0,
                    history: [],
                    clientType: 'B2B',
                    active: true
                };

                // Sauvegarder dans QOData.clients
                QOData.clients.push(newClient);
                localStorage.setItem('qo_clients', JSON.stringify(QOData.clients));

            } else {
                // Client particulier
                const lastname = document.getElementById('mf-new-lastname').value.trim();
                const firstname = document.getElementById('mf-new-firstname').value.trim();
                const mobile = document.getElementById('mf-new-mobile').value.trim();
                const city = document.getElementById('mf-new-city').value.trim();

                if (!lastname) { alert('Le nom est requis'); return; }
                if (!mobile) { alert('Le téléphone portable est requis'); return; }
                if (!city) { alert('Le lieu est requis'); return; }

                newClient = {
                    id: Date.now(),
                    lastname,
                    firstname,
                    address: document.getElementById('mf-new-address').value.trim(),
                    zip: document.getElementById('mf-new-zip').value.trim(),
                    city,
                    mobile,
                    phone: document.getElementById('mf-new-phone').value.trim(),
                    email: document.getElementById('mf-new-email').value.trim(),
                    allergies: document.getElementById('mf-new-allergies').value.trim(),
                    notes: document.getElementById('mf-new-notes').value.trim(),
                    clientType: 'B2C',
                    active: true
                };

                // Sauvegarder dans QOData.clients (base unifiée)
                QOData.clients.push(newClient);
                localStorage.setItem('qo_clients', JSON.stringify(QOData.clients));
            }

            selectMFClient(newClient.id);
        }

        // ========== ÉTAPE 2: LIEU DE RETRAIT ==========
        function renderMFStoresSelection() {
            const container = document.getElementById('mf-stores-selection');
            if (!container) return;

            container.innerHTML = MFData.stores.map(store => `
                <div class="mf-store-card" onclick="selectMFStore(${store.id})" data-store-id="${store.id}"
                    style="padding:20px; background:var(--bg-primary); border:2px solid ${MFData.currentOrder.store?.id === store.id ? 'var(--accent-primary)' : 'var(--border-color)'}; border-radius:12px; cursor:pointer; transition:all 0.2s;"
                    onmouseover="if(!this.classList.contains('selected'))this.style.borderColor='var(--accent-secondary)'"
                    onmouseout="if(!this.classList.contains('selected'))this.style.borderColor='var(--border-color)'">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="font-size:32px;">🏪</div>
                        <div>
                            <div style="font-weight:700; font-size:16px;">${store.name}</div>
                            <div style="font-size:12px; color:var(--text-muted);">${store.address || ''}</div>
                            <div style="font-size:12px; color:var(--text-muted);">📞 ${store.phone || '-'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectMFStore(id) {
            const store = MFData.stores.find(s => s.id === id);
            if (!store) return;

            MFData.currentOrder.store = store;

            // Update visual
            document.querySelectorAll('.mf-store-card').forEach(card => {
                card.style.borderColor = card.dataset.storeId == id ? 'var(--accent-primary)' : 'var(--border-color)';
            });

            // Show datetime section
            document.getElementById('mf-datetime-section').style.display = 'block';

            // Générer les créneaux si date déjà sélectionnée
            updateMFTimeSlots();
        }

        // Générer les créneaux horaires dynamiquement
        function updateMFTimeSlots() {
            const store = MFData.currentOrder.store;
            const dateStr = document.getElementById('mf-pickup-date').value;
            const slotsContainer = document.getElementById('mf-time-slots');
            const dayInfo = document.getElementById('mf-day-info');
            const timeInput = document.getElementById('mf-pickup-time');

            if (!store || !dateStr) {
                slotsContainer.innerHTML = '<div style="color:var(--text-muted); font-size:12px; padding:12px;">Sélectionnez d\'abord un magasin et une date</div>';
                dayInfo.style.display = 'none';
                return;
            }

            const date = new Date(dateStr);
            const dayOfWeek = date.getDay(); // 0=dimanche, 1=lundi...
            const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const dayKey = dayKeys[dayOfWeek];
            const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];

            // Vérifier jours exceptionnels
            const exceptional = (store.exceptionalDays || []).find(d => d.date === dateStr);

            let dayStart, dayEnd, isClosed = false, infoText = '';

            if (exceptional) {
                // Jour exceptionnel
                if (exceptional.closed) {
                    isClosed = true;
                    infoText = `<span style="color:var(--accent-danger);">⚠️ ${exceptional.label || 'Jour exceptionnel'} - Magasin fermé</span>`;
                } else {
                    dayStart = exceptional.start;
                    dayEnd = exceptional.end;
                    infoText = `<span style="color:var(--accent-orange);">📅 ${exceptional.label || 'Horaires spéciaux'} : ${exceptional.start} - ${exceptional.end}</span>`;
                }
            } else {
                // Jour normal
                const hours = store.hours?.[dayKey];
                if (!hours || !hours.open) {
                    isClosed = true;
                    infoText = `<span style="color:var(--accent-danger);">⚠️ ${dayNames[dayOfWeek]} - Magasin fermé</span>`;
                } else {
                    dayStart = hours.start;
                    dayEnd = hours.end;
                    infoText = `<span style="color:var(--text-muted);">🕐 ${dayNames[dayOfWeek]} : ${hours.start} - ${hours.end}</span>`;
                }
            }

            // Afficher info jour
            dayInfo.style.display = 'block';
            dayInfo.innerHTML = infoText;
            dayInfo.style.background = isClosed ? 'var(--accent-danger)15' : 'var(--accent-primary)15';

            if (isClosed) {
                slotsContainer.innerHTML = '<div style="text-align:center; padding:20px; color:var(--accent-danger);">Choisissez une autre date</div>';
                timeInput.value = '';
                checkMFStep2Complete();
                return;
            }

            // Générer créneaux
            const slotDuration = store.slotDuration || 60; // minutes
            const slots = [];

            const startParts = dayStart.split(':');
            const endParts = dayEnd.split(':');
            let startMinutes = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
            const endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);

            while (startMinutes + slotDuration <= endMinutes) {
                const slotStart = `${String(Math.floor(startMinutes / 60)).padStart(2, '0')}:${String(startMinutes % 60).padStart(2, '0')}`;
                const slotEnd = `${String(Math.floor((startMinutes + slotDuration) / 60)).padStart(2, '0')}:${String((startMinutes + slotDuration) % 60).padStart(2, '0')}`;
                slots.push({ start: slotStart, end: slotEnd, label: `${slotStart}-${slotEnd}` });
                startMinutes += slotDuration;
            }

            if (slots.length === 0) {
                slotsContainer.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">Aucun créneau disponible</div>';
                return;
            }

            // Afficher les créneaux comme boutons
            const currentSelected = timeInput.value;
            slotsContainer.innerHTML = slots.map(slot => `
                <button type="button" onclick="selectMFTimeSlot('${slot.label}')"
                    class="mf-slot-btn ${currentSelected === slot.label ? 'selected' : ''}"
                    style="padding:10px 8px; border-radius:8px; border:2px solid ${currentSelected === slot.label ? 'var(--accent-primary)' : 'var(--border-color)'};
                           background:${currentSelected === slot.label ? 'var(--accent-primary)' : 'var(--bg-card)'};
                           color:${currentSelected === slot.label ? '#000' : 'var(--text-primary)'};
                           font-size:12px; font-weight:600; cursor:pointer; transition:all 0.2s;">
                    ${slot.label}
                </button>
            `).join('');
        }

        function selectMFTimeSlot(slotLabel) {
            document.getElementById('mf-pickup-time').value = slotLabel;

            // Update visual
            document.querySelectorAll('.mf-slot-btn').forEach(btn => {
                const isSelected = btn.textContent.trim() === slotLabel;
                btn.style.borderColor = isSelected ? 'var(--accent-primary)' : 'var(--border-color)';
                btn.style.background = isSelected ? 'var(--accent-primary)' : 'var(--bg-card)';
                btn.style.color = isSelected ? '#000' : 'var(--text-primary)';
                btn.classList.toggle('selected', isSelected);
            });

            checkMFStep2Complete();
        }

        function checkMFStep2Complete() {
            const date = document.getElementById('mf-pickup-date').value;
            const time = document.getElementById('mf-pickup-time').value;

            MFData.currentOrder.pickupDate = date;
            MFData.currentOrder.pickupTime = time;

            const nextBtn = document.getElementById('mf-step2-next');
            if (MFData.currentOrder.store && date && time) {
                nextBtn.style.display = 'inline-flex';
            } else {
                nextBtn.style.display = 'none';
            }
        }

        function updateMFStep2Info() {
            if (MFData.currentOrder.client) {
                const client = MFData.currentOrder.client;
                const displayName = client.name || (client.lastname + ' ' + (client.firstname || ''));
                document.getElementById('mf-step2-client').textContent = displayName;
                document.getElementById('mf-step2-client-phone').textContent = client.mobile || client.phone || '';
            }
        }

        // Event listeners pour date/heure - ne plus écouter time car géré par boutons
        document.addEventListener('DOMContentLoaded', () => {
            const dateEl = document.getElementById('mf-pickup-date');
            if (dateEl) dateEl.addEventListener('change', updateMFTimeSlots);
        });

        // ========== ÉTAPE 3: ARTICLES - NOUVEAU SYSTÈME ==========
        let mfSelectedArticles = []; // Articles sélectionnés dans le modal

        // Labels et emojis pour les catégories
        const mfCatConfig = {
            poisson: { label: 'Poissons', emoji: '🐟', color: '#118ab2' },
            crustace: { label: 'Crustacés', emoji: '🦐', color: '#ef476f' },
            coquillage: { label: 'Coquillages', emoji: '🦪', color: '#8338ec' },
            fume: { label: 'Fumés', emoji: '🔥', color: '#f77f00' },
            conserve: { label: 'Conserves', emoji: '🥫', color: '#d62828' },
            preparation: { label: 'Traiteur', emoji: '🍽️', color: '#06d6a0' },
            surgele: { label: 'Surgelés', emoji: '❄️', color: '#00b4d8' },
            epicerie: { label: 'Épicerie', emoji: '🛒', color: '#fca311' }
        };

        // Ouvrir le modal catalogue
        function openMFArticlesModal() {
            mfSelectedArticles = []; // Reset sélection
            document.getElementById('mf-articles-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';

            // Peupler les catégories
            const articles = ArticlesData?.articles || [];
            const categories = [...new Set(articles.map(a => a.category).filter(c => c))];
            const catSelect = document.getElementById('mf-modal-category');
            catSelect.innerHTML = '<option value="">Toutes catégories</option>' +
                categories.map(cat => {
                    const config = mfCatConfig[cat] || { label: cat };
                    return `<option value="${cat}">${config.emoji || '📦'} ${config.label}</option>`;
                }).join('');

            // Reset recherche
            document.getElementById('mf-modal-search').value = '';

            renderMFModalArticles();
            updateMFSelectionCount();
        }

        function closeMFArticlesModal() {
            document.getElementById('mf-articles-modal').style.display = 'none';
            document.body.style.overflow = '';
        }

        // Filtrer les articles dans le modal
        function filterMFModalArticles() {
            renderMFModalArticles();
        }

        // Afficher les articles dans le modal
        function renderMFModalArticles() {
            const tbody = document.getElementById('mf-articles-tbody');
            const search = document.getElementById('mf-modal-search').value.toLowerCase();
            const category = document.getElementById('mf-modal-category').value;

            let articles = ArticlesData?.articles || [];
            articles = articles.filter(a => a.active !== false);

            if (category) {
                articles = articles.filter(a => a.category === category);
            }

            if (search) {
                articles = articles.filter(a =>
                    a.name.toLowerCase().includes(search) ||
                    (a.code && a.code.toLowerCase().includes(search)) ||
                    (a.category && a.category.toLowerCase().includes(search))
                );
            }

            if (articles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align:center; padding:60px; color:var(--text-muted);">
                            <div style="font-size:48px; margin-bottom:12px;">🔍</div>
                            <div>Aucun article trouvé</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = articles.map(article => {
                const price = article.priceB2C || article.price || 0;
                const isSelected = mfSelectedArticles.some(s => s.id === article.id);
                const catConfig = mfCatConfig[article.category] || { label: article.category, emoji: '📦', color: '#666' };

                return `
                    <tr onclick="toggleMFArticleSelection(${article.id})"
                        style="cursor:pointer; transition:all 0.2s; ${isSelected ? 'background:var(--accent-primary)15;' : ''}"
                        onmouseover="this.style.background='${isSelected ? 'var(--accent-primary)25' : 'var(--bg-hover)'}'"
                        onmouseout="this.style.background='${isSelected ? 'var(--accent-primary)15' : ''}'">
                        <td style="padding:14px 8px; text-align:center;">
                            <div style="width:28px; height:28px; border-radius:6px; border:2px solid ${isSelected ? 'var(--accent-primary)' : 'var(--border-color)'};
                                        background:${isSelected ? 'var(--accent-primary)' : 'transparent'}; display:flex; align-items:center; justify-content:center;">
                                ${isSelected ? '<span style="color:#000; font-weight:700;">✓</span>' : ''}
                            </div>
                        </td>
                        <td style="padding:14px 8px; font-family:'Space Mono',monospace; font-weight:600; color:var(--accent-secondary);">
                            ${article.code || '-'}
                        </td>
                        <td style="padding:14px 8px;">
                            <div style="font-weight:600; font-size:14px;">${article.name}</div>
                        </td>
                        <td style="padding:14px 8px;">
                            <span style="padding:4px 10px; border-radius:12px; font-size:11px; font-weight:600; background:${catConfig.color}20; color:${catConfig.color};">
                                ${catConfig.emoji} ${catConfig.label}
                            </span>
                        </td>
                        <td style="padding:14px 8px; text-align:right; font-family:'Space Mono',monospace; font-weight:700; font-size:15px; color:var(--accent-primary);">
                            ${price.toFixed(2)}
                        </td>
                        <td style="padding:14px 8px; text-align:center; color:var(--text-muted); font-size:13px;">
                            ${article.unit || 'kg'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Toggle sélection d'un article
        function toggleMFArticleSelection(articleId) {
            const articles = ArticlesData?.articles || [];
            const article = articles.find(a => a.id === articleId);
            if (!article) return;

            const existingIdx = mfSelectedArticles.findIndex(s => s.id === articleId);

            if (existingIdx >= 0) {
                // Désélectionner
                mfSelectedArticles.splice(existingIdx, 1);
            } else {
                // Sélectionner avec valeurs par défaut
                mfSelectedArticles.push({
                    id: article.id,
                    code: article.code || '',
                    name: article.name,
                    price: article.priceB2C || article.price || 0,
                    unit: article.unit || 'kg',
                    qty: 1
                });
            }

            renderMFModalArticles();
            updateMFSelectionCount();
        }

        // Mettre à jour le compteur de sélection
        function updateMFSelectionCount() {
            const count = mfSelectedArticles.length;
            document.getElementById('mf-selection-count').textContent = count + ' sélectionné(s)';
            document.getElementById('mf-validate-selection-btn').style.display = count > 0 ? 'block' : 'none';
        }

        // Valider la sélection et ajouter au panier
        function validateMFSelection() {
            if (mfSelectedArticles.length === 0) return;

            // Ajouter au panier
            mfSelectedArticles.forEach(selected => {
                const existing = MFData.currentOrder.cart.find(item => item.articleId === selected.id);
                if (existing) {
                    existing.qty += selected.qty;
                } else {
                    MFData.currentOrder.cart.push({
                        articleId: selected.id,
                        code: selected.code,
                        name: selected.name,
                        price: selected.price,
                        unit: selected.unit,
                        qty: selected.qty
                    });
                }
            });

            closeMFArticlesModal();
            updateMFEditableCart();
            showMFToast(`${mfSelectedArticles.length} article(s) ajouté(s)`);
        }

        // Toast notification
        function showMFToast(message) {
            const existing = document.querySelector('.mf-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'mf-toast';
            toast.style.cssText = `
                position:fixed; bottom:100px; left:50%; transform:translateX(-50%);
                background:var(--accent-primary); color:#000; padding:12px 24px;
                border-radius:25px; font-weight:600; font-size:13px; z-index:9999;
                animation:slideUp 0.3s ease, fadeOut 0.3s ease 1.7s forwards;
                box-shadow:0 4px 20px rgba(6,214,160,0.4);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Mettre à jour le panier éditable
        function updateMFEditableCart() {
            const container = document.getElementById('mf-cart-items-editable');
            const totalsDiv = document.getElementById('mf-cart-totals');
            const cart = MFData.currentOrder.cart;

            if (cart.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:60px 20px; color:var(--text-muted);">
                        <div style="font-size:64px; margin-bottom:16px; opacity:0.3;">📦</div>
                        <div style="font-size:16px; margin-bottom:8px;">Aucun article dans le panier</div>
                        <div style="font-size:13px;">Cliquez sur "Ouvrir catalogue" pour ajouter des produits</div>
                    </div>`;
                totalsDiv.style.display = 'none';
                document.getElementById('mf-step3-next').style.display = 'none';
                return;
            }

            let subtotal = 0;
            container.innerHTML = `
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:2px solid var(--border-color);">
                            <th style="padding:12px 8px; text-align:left; font-size:11px; color:var(--text-muted);">CODE</th>
                            <th style="padding:12px 8px; text-align:left; font-size:11px; color:var(--text-muted);">DÉSIGNATION</th>
                            <th style="padding:12px 8px; text-align:center; font-size:11px; color:var(--text-muted); width:100px;">QTÉ</th>
                            <th style="padding:12px 8px; text-align:center; font-size:11px; color:var(--text-muted); width:80px;">UNITÉ</th>
                            <th style="padding:12px 8px; text-align:right; font-size:11px; color:var(--text-muted); width:100px;">PRIX HT</th>
                            <th style="padding:12px 8px; text-align:right; font-size:11px; color:var(--text-muted); width:100px;">TOTAL</th>
                            <th style="padding:12px 8px; width:40px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cart.map((item, idx) => {
                            const itemTotal = item.price * item.qty;
                            subtotal += itemTotal;
                            return `
                                <tr style="border-bottom:1px solid var(--border-color);">
                                    <td style="padding:12px 8px;">
                                        <input type="text" value="${item.code || ''}"
                                            onchange="updateMFCartField(${idx}, 'code', this.value)"
                                            style="width:80px; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--accent-secondary); font-family:'Space Mono',monospace; font-size:12px;">
                                    </td>
                                    <td style="padding:12px 8px;">
                                        <input type="text" value="${item.name}"
                                            onchange="updateMFCartField(${idx}, 'name', this.value)"
                                            style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:13px;">
                                    </td>
                                    <td style="padding:12px 8px; text-align:center;">
                                        <div style="display:flex; align-items:center; justify-content:center; gap:4px;">
                                            <button onclick="updateMFCartQty(${idx}, -0.5)" style="width:28px; height:28px; border-radius:6px; background:var(--bg-hover); border:1px solid var(--border-color); color:var(--text-primary); cursor:pointer;">−</button>
                                            <input type="number" value="${item.qty}" min="0.1" step="0.1"
                                                onchange="updateMFCartField(${idx}, 'qty', parseFloat(this.value))"
                                                style="width:50px; padding:8px; text-align:center; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-family:'Space Mono',monospace; font-weight:600;">
                                            <button onclick="updateMFCartQty(${idx}, 0.5)" style="width:28px; height:28px; border-radius:6px; background:var(--accent-primary); border:none; color:#000; cursor:pointer;">+</button>
                                        </div>
                                    </td>
                                    <td style="padding:12px 8px; text-align:center;">
                                        <select onchange="updateMFCartField(${idx}, 'unit', this.value)"
                                            style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:12px;">
                                            <option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>kg</option>
                                            <option value="pce" ${item.unit === 'pce' ? 'selected' : ''}>pce</option>
                                            <option value="lot" ${item.unit === 'lot' ? 'selected' : ''}>lot</option>
                                            <option value="g" ${item.unit === 'g' ? 'selected' : ''}>g</option>
                                        </select>
                                    </td>
                                    <td style="padding:12px 8px; text-align:right;">
                                        <input type="number" value="${item.price.toFixed(2)}" min="0" step="0.05"
                                            onchange="updateMFCartField(${idx}, 'price', parseFloat(this.value))"
                                            style="width:80px; padding:8px; text-align:right; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--accent-primary); font-family:'Space Mono',monospace; font-weight:600;">
                                    </td>
                                    <td style="padding:12px 8px; text-align:right; font-family:'Space Mono',monospace; font-weight:700; font-size:14px; color:var(--accent-primary);">
                                        ${itemTotal.toFixed(2)}
                                    </td>
                                    <td style="padding:12px 8px; text-align:center;">
                                        <button onclick="removeMFCartItem(${idx})"
                                            style="padding:6px 10px; background:var(--accent-danger)20; border:1px solid var(--accent-danger); border-radius:6px; color:var(--accent-danger); cursor:pointer; font-size:14px;">
                                            ✕
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            const tva = subtotal * 0.026;
            const total = subtotal + tva;

            document.getElementById('mf-cart-subtotal').textContent = subtotal.toFixed(2) + ' CHF';
            document.getElementById('mf-cart-tva').textContent = tva.toFixed(2) + ' CHF';
            document.getElementById('mf-cart-total').textContent = total.toFixed(2) + ' CHF';
            totalsDiv.style.display = 'block';
            document.getElementById('mf-step3-next').style.display = 'block';
        }

        // Mettre à jour un champ du panier
        function updateMFCartField(idx, field, value) {
            const item = MFData.currentOrder.cart[idx];
            if (!item) return;
            item[field] = value;
            updateMFEditableCart();
        }

        // Modifier quantité
        function updateMFCartQty(idx, delta) {
            const item = MFData.currentOrder.cart[idx];
            if (!item) return;
            item.qty = Math.max(0.1, (item.qty || 1) + delta);
            updateMFEditableCart();
        }

        // Supprimer un article
        function removeMFCartItem(idx) {
            MFData.currentOrder.cart.splice(idx, 1);
            updateMFEditableCart();
        }

        // Ancienne fonction pour compatibilité
        function updateMFCart() {
            updateMFEditableCart();
        }

        // ========== ÉTAPE 4: RÉCAPITULATIF ==========
        function renderMFRecap() {
            const order = MFData.currentOrder;
            const client = order.client;
            const store = order.store;

            // Client info
            document.getElementById('mf-recap-client').innerHTML = `
                <div style="font-weight:600; font-size:16px; margin-bottom:8px;">${client.lastname} ${client.firstname || ''}</div>
                <div style="font-size:13px; color:var(--text-muted);">📞 ${client.mobile || client.phone || '-'}</div>
                <div style="font-size:13px; color:var(--text-muted);">📧 ${client.email || '-'}</div>
                ${client.allergies ? `<div style="font-size:13px; color:var(--accent-danger); margin-top:8px;">⚠️ ${client.allergies}</div>` : ''}
            `;

            // Pickup info
            document.getElementById('mf-recap-pickup').innerHTML = `
                <div style="font-weight:600; font-size:16px; margin-bottom:8px;">${store.name}</div>
                <div style="font-size:13px; color:var(--text-muted);">${store.address || ''}</div>
                <div style="font-size:14px; margin-top:12px; padding:10px; background:var(--bg-card); border-radius:8px;">
                    📅 <strong>${formatDate(order.pickupDate)}</strong> à <strong>${order.pickupTime}</strong>
                </div>
            `;

            // Items
            let subtotal = 0;
            document.getElementById('mf-recap-items').innerHTML = `
                <table style="width:100%;">
                    <thead style="background:var(--bg-hover);">
                        <tr><th style="padding:12px; text-align:left;">Article</th><th style="padding:12px; text-align:center;">Qté</th><th style="padding:12px; text-align:right;">Prix unit.</th><th style="padding:12px; text-align:right;">Total</th></tr>
                    </thead>
                    <tbody>
                        ${order.cart.map(item => {
                            const itemTotal = item.price * item.qty;
                            subtotal += itemTotal;
                            return `
                                <tr style="border-bottom:1px solid var(--border-color);">
                                    <td style="padding:12px;"><strong>${item.name}</strong><br><span style="font-size:11px; color:var(--accent-orange);">${item.code}</span></td>
                                    <td style="padding:12px; text-align:center;">${item.qty} ${item.unit}</td>
                                    <td style="padding:12px; text-align:right; font-family:'Space Mono',monospace;">${item.price.toFixed(2)} CHF</td>
                                    <td style="padding:12px; text-align:right; font-family:'Space Mono',monospace; font-weight:600;">${itemTotal.toFixed(2)} CHF</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            const tva = subtotal * 0.026;
            const total = subtotal + tva;

            document.getElementById('mf-recap-subtotal').textContent = subtotal.toFixed(2) + ' CHF';
            document.getElementById('mf-recap-tva').textContent = tva.toFixed(2) + ' CHF';
            document.getElementById('mf-recap-total').textContent = total.toFixed(2) + ' CHF';
        }

        // ========== ÉTAPE 5: VALIDATION ==========
        function renderMFFinal() {
            const order = MFData.currentOrder;
            const client = order.client;
            const store = order.store;

            let subtotal = order.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const tva = subtotal * 0.026;
            const total = subtotal + tva;

            document.getElementById('mf-final-client').textContent = client.lastname + ' ' + (client.firstname || '');
            document.getElementById('mf-final-total').textContent = total.toFixed(2) + ' CHF';
            document.getElementById('mf-final-pickup').textContent = `📍 ${store.name} • 📅 ${formatDate(order.pickupDate)} à ${order.pickupTime}`;

            document.getElementById('mf-email-to').textContent = client.email || '(pas d\'email)';
            document.getElementById('mf-email-store').textContent = store.email || '(pas d\'email configuré)';
        }

        function validateMFOrder() {
            const order = MFData.currentOrder;

            let subtotal = order.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const tva = subtotal * 0.026;
            const total = subtotal + tva;

            const newOrder = {
                id: (MFData.orders.length > 0 ? Math.max(...MFData.orders.map(o => o.id)) : 0) + 1,
                clientId: order.client.id,
                storeId: order.store.id,
                pickupDate: order.pickupDate,
                pickupTime: order.pickupTime,
                items: [...order.cart],
                subtotal,
                tva,
                total,
                notes: document.getElementById('mf-order-notes')?.value || '',
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            MFData.orders.push(newOrder);
            saveMFData('orders');

            // Email simulation
            const sendEmail = document.getElementById('mf-send-email').checked;
            const sendCopy = document.getElementById('mf-send-copy').checked;

            if (sendEmail && order.client.email) {
                console.log('📧 Email envoyé à:', order.client.email);
            }
            if (sendCopy && order.store.email) {
                console.log('📧 Copie envoyée à:', order.store.email);
            }

            alert(`✅ Commande #${newOrder.id} créée avec succès !`);

            // Retour au dashboard
            document.getElementById('mf-view-neworder').style.display = 'none';
            document.getElementById('mf-view-dashboard').style.display = 'block';
            initMFDashboard();
        }

        function printMFOrder() {
            printMFOrderById(null); // Commande en cours
        }

        function printMFOrderById(orderId) {
            let order, client, store, items, subtotal, tva, total;

            if (orderId) {
                order = MFData.orders.find(o => o.id === orderId);
                if (!order) return;
                client = (QOData?.clients || []).find(c => c.id === order.clientId);
                store = MFData.stores.find(s => s.id === order.storeId);
                items = order.items;
                subtotal = order.subtotal;
                tva = order.tva;
                total = order.total;
            } else {
                order = MFData.currentOrder;
                client = order.client;
                store = order.store;
                items = order.cart;
                subtotal = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                tva = subtotal * 0.026;
                total = subtotal + tva;
            }

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Commande ${orderId ? '#' + orderId : ''}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        h1 { color: #06d6a0; border-bottom: 3px solid #06d6a0; padding-bottom: 10px; }
                        .header { display: flex; justify-content: space-between; margin-bottom: 30px; }
                        .box { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #06d6a0; color: #000; }
                        .total { font-size: 24px; font-weight: bold; text-align: right; color: #06d6a0; }
                        .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <h1>🐟 Borex Poissons - Confirmation de commande</h1>
                    <div class="header">
                        <div class="box" style="flex:1; margin-right:20px;">
                            <h3>👤 Client</h3>
                            <strong>${client?.lastname || ''} ${client?.firstname || ''}</strong><br>
                            ${client?.address || ''}<br>
                            ${client?.zip || ''} ${client?.city || ''}<br>
                            📞 ${client?.mobile || client?.phone || '-'}<br>
                            📧 ${client?.email || '-'}
                            ${client?.allergies ? `<br><span style="color:red;">⚠️ Allergies: ${client.allergies}</span>` : ''}
                        </div>
                        <div class="box" style="flex:1;">
                            <h3>📍 Retrait</h3>
                            <strong>${store?.name || ''}</strong><br>
                            ${store?.address || ''}<br>
                            📞 ${store?.phone || '-'}<br><br>
                            <strong>📅 ${formatDate(order?.pickupDate || order?.pickupDate)} à ${order?.pickupTime}</strong>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr><th>Article</th><th>Qté</th><th>Prix unit.</th><th>Total</th></tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td>${item.name}<br><small style="color:#666;">${item.code}</small></td>
                                    <td>${item.qty} ${item.unit}</td>
                                    <td>${item.price.toFixed(2)} CHF</td>
                                    <td>${(item.price * item.qty).toFixed(2)} CHF</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="text-align:right; margin-top:20px;">
                        <div>Sous-total HT: ${subtotal.toFixed(2)} CHF</div>
                        <div>TVA (2.6%): ${tva.toFixed(2)} CHF</div>
                        <div class="total">TOTAL TTC: ${total.toFixed(2)} CHF</div>
                    </div>
                    ${order?.notes ? `<div class="box" style="margin-top:30px;"><h3>📝 Notes</h3>${order.notes}</div>` : ''}
                    <div class="footer">
                        Borex Poissons - Merci pour votre commande !<br>
                        Document généré le ${new Date().toLocaleString('fr-CH')}
                    </div>
                    <script>window.print();${'<'}/script>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
        }

        // ========== MODALS GESTION ==========
        function showMFClientsModal() {
            renderMFClientsTable();
            document.getElementById('mf-clients-modal').style.display = 'flex';
        }

        function closeMFClientsModal() {
            document.getElementById('mf-clients-modal').style.display = 'none';
        }

        function renderMFClientsTable() {
            const tbody = document.getElementById('mf-clients-tbody');
            const filter = document.getElementById('mf-clients-filter')?.value?.toLowerCase() || '';
            const typeFilter = document.getElementById('mf-clients-type-filter')?.value || '';

            // Tous les clients de la base unifiée
            let allClients = QOData?.clients || [];

            // Mise à jour des stats
            const b2bCount = allClients.filter(c => (c.clientType || 'b2b').toLowerCase() === 'b2b').length;
            const b2cCount = allClients.filter(c => (c.clientType || 'b2b').toLowerCase() === 'b2c').length;
            document.getElementById('mf-clients-total').textContent = allClients.length;
            document.getElementById('mf-clients-b2b').textContent = b2bCount;
            document.getElementById('mf-clients-b2c').textContent = b2cCount;

            // Filtrer par type si sélectionné
            let clients = allClients;
            if (typeFilter) {
                clients = clients.filter(c => (c.clientType || 'b2b').toLowerCase() === typeFilter);
            }

            // Filtrer par recherche texte
            if (filter) {
                clients = clients.filter(c =>
                    (c.name || '').toLowerCase().includes(filter) ||
                    (c.lastname || '').toLowerCase().includes(filter) ||
                    (c.firstname || '').toLowerCase().includes(filter) ||
                    (c.contact || '').toLowerCase().includes(filter) ||
                    (c.mobile || '').includes(filter) ||
                    (c.phone || '').includes(filter) ||
                    (c.city || '').toLowerCase().includes(filter) ||
                    (c.email || '').toLowerCase().includes(filter)
                );
            }

            // Limiter à 100 pour performance
            const displayClients = clients.slice(0, 100);

            tbody.innerHTML = displayClients.map(c => {
                const type = (c.clientType || 'b2b').toUpperCase();
                const isB2B = type === 'B2B';
                const typeBadge = isB2B
                    ? '<span style="padding:3px 8px; background:rgba(17,138,178,0.2); color:var(--accent-secondary); border-radius:4px; font-size:10px; font-weight:600;">B2B</span>'
                    : '<span style="padding:3px 8px; background:rgba(255,183,77,0.2); color:var(--accent-warning); border-radius:4px; font-size:10px; font-weight:600;">B2C</span>';

                // Nom selon le type
                const displayName = isB2B ? (c.name || c.lastname || '-') : (c.lastname || '-');
                const displayContact = isB2B ? (c.contact || c.firstname || '-') : (c.firstname || '-');

                return `
                <tr>
                    <td>${typeBadge}</td>
                    <td><strong>${displayName}</strong></td>
                    <td>${displayContact}</td>
                    <td>${c.mobile || c.phone || '-'}</td>
                    <td style="font-size:12px;">${c.email || '-'}</td>
                    <td>${c.city || '-'}</td>
                    <td>${c.active !== false ? '<span style="color:var(--accent-primary);">✓</span>' : '<span style="color:var(--text-muted);">✕</span>'}</td>
                    <td>
                        <button onclick="editMFClient(${c.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">✏️</button>
                    </td>
                </tr>
            `}).join('');

            if (clients.length > 100) {
                tbody.innerHTML += `<tr><td colspan="8" style="text-align:center; padding:16px; color:var(--text-muted);">... et ${clients.length - 100} autres clients. Affinez votre recherche.</td></tr>`;
            }
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">Aucun client trouvé</td></tr>';
            }
        }

        function filterMFClientsType(type) {
            document.getElementById('mf-clients-type-filter').value = type;

            // Mise à jour visuelle des boutons stats
            const allBtn = document.getElementById('mf-filter-all');
            const b2bBtn = document.getElementById('mf-filter-b2b');
            const b2cBtn = document.getElementById('mf-filter-b2c');

            // Reset toutes les bordures
            if (allBtn) allBtn.style.border = '2px solid transparent';
            if (b2bBtn) b2bBtn.style.border = '2px solid transparent';
            if (b2cBtn) b2cBtn.style.border = '2px solid transparent';

            // Activer le bouton sélectionné
            if (type === 'b2b' && b2bBtn) {
                b2bBtn.style.border = '2px solid var(--accent-secondary)';
            } else if (type === 'b2c' && b2cBtn) {
                b2cBtn.style.border = '2px solid var(--accent-warning)';
            } else if (allBtn) {
                allBtn.style.border = '2px solid var(--accent-primary)';
            }

            renderMFClientsTable();
        }

        function filterMFClientsTable() {
            renderMFClientsTable();
        }

        // ========== MODAL ARTICLES (pour sélection étape 3) ==========
        function showMFArticlesModal() {
            renderMFArticlesTable();
            document.getElementById('mf-articles-modal').style.display = 'flex';
        }

        // ========== MODAL CONSULTATION ARTICLES (depuis dashboard) ==========
        function showMFArticlesViewModal() {
            renderMFViewArticlesTable();
            document.getElementById('mf-articles-view-modal').style.display = 'flex';
        }

        function closeMFArticlesViewModal() {
            document.getElementById('mf-articles-view-modal').style.display = 'none';
        }

        function filterMFViewArticlesTable() {
            renderMFViewArticlesTable();
        }

        function renderMFViewArticlesTable() {
            const tbody = document.getElementById('mf-view-articles-tbody');
            const filter = document.getElementById('mf-view-articles-filter')?.value?.toLowerCase() || '';
            const catFilter = document.getElementById('mf-view-articles-cat-filter')?.value || '';

            // Utiliser les articles du module Outils
            let allArticles = QOData?.articles || [];

            // Stats
            const activeCount = allArticles.filter(a => a.active !== false).length;
            document.getElementById('mf-view-articles-total').textContent = allArticles.length;
            document.getElementById('mf-view-articles-active').textContent = activeCount;

            // Remplir le filtre catégories
            const categories = [...new Set(allArticles.map(a => a.category).filter(Boolean))];
            const catSelect = document.getElementById('mf-view-articles-cat-filter');
            const currentCat = catSelect.value;
            catSelect.innerHTML = '<option value="">Toutes catégories</option>' +
                categories.map(c => `<option value="${c}" ${c === currentCat ? 'selected' : ''}>${c}</option>`).join('');

            // Filtrer par catégorie
            let articles = allArticles;
            if (catFilter) {
                articles = articles.filter(a => a.category === catFilter);
            }

            // Filtrer par recherche
            if (filter) {
                articles = articles.filter(a =>
                    (a.code || '').toLowerCase().includes(filter) ||
                    (a.name || '').toLowerCase().includes(filter) ||
                    (a.category || '').toLowerCase().includes(filter)
                );
            }

            // Limiter à 100
            const displayArticles = articles.slice(0, 100);

            tbody.innerHTML = displayArticles.map(a => `
                <tr style="opacity:${a.active !== false ? '1' : '0.5'}; border-bottom:1px solid var(--border-color);">
                    <td style="padding:10px 8px;"><code style="background:var(--bg-primary); padding:2px 6px; border-radius:4px;">${a.code || '-'}</code></td>
                    <td style="padding:10px 8px;"><strong>${a.name || '-'}</strong></td>
                    <td style="padding:10px 8px;"><span style="padding:2px 8px; background:var(--bg-hover); border-radius:4px; font-size:11px;">${a.category || '-'}</span></td>
                    <td style="padding:10px 8px; color:var(--accent-warning); font-weight:600;">${a.priceB2C ? a.priceB2C.toFixed(2) + ' CHF' : '-'}</td>
                    <td style="padding:10px 8px; color:var(--accent-secondary); font-weight:600;">${a.priceB2B ? a.priceB2B.toFixed(2) + ' CHF' : '-'}</td>
                    <td style="padding:10px 8px;">${a.unit || 'pce'}</td>
                    <td style="padding:10px 8px;">${a.active !== false ? '<span style="color:var(--accent-primary);">✓</span>' : '<span style="color:var(--text-muted);">✕</span>'}</td>
                </tr>
            `).join('');

            if (articles.length > 100) {
                tbody.innerHTML += `<tr><td colspan="7" style="text-align:center; padding:16px; color:var(--text-muted);">... et ${articles.length - 100} autres articles. Affinez votre recherche.</td></tr>`;
            }

            if (displayArticles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--text-muted);">Aucun article trouvé</td></tr>';
            }
        }

        // ========== RENDER ARTICLES TABLE (pour étape 3) ==========
        function renderMFArticlesTable() {
            const tbody = document.getElementById('mf-articles-tbody');
            const filter = document.getElementById('mf-articles-filter')?.value?.toLowerCase() || '';
            const catFilter = document.getElementById('mf-articles-cat-filter')?.value || '';

            // Utiliser les articles du module Outils
            let allArticles = QOData?.articles || [];

            // Stats
            const activeCount = allArticles.filter(a => a.active !== false).length;
            document.getElementById('mf-articles-total').textContent = allArticles.length;
            document.getElementById('mf-articles-active').textContent = activeCount;

            // Remplir le filtre catégories
            const categories = [...new Set(allArticles.map(a => a.category).filter(Boolean))];
            const catSelect = document.getElementById('mf-articles-cat-filter');
            const currentCat = catSelect.value;
            catSelect.innerHTML = '<option value="">Toutes catégories</option>' +
                categories.map(c => `<option value="${c}" ${c === currentCat ? 'selected' : ''}>${c}</option>`).join('');

            // Filtrer par catégorie
            let articles = allArticles;
            if (catFilter) {
                articles = articles.filter(a => a.category === catFilter);
            }

            // Filtrer par recherche
            if (filter) {
                articles = articles.filter(a =>
                    (a.code || '').toLowerCase().includes(filter) ||
                    (a.name || '').toLowerCase().includes(filter) ||
                    (a.category || '').toLowerCase().includes(filter)
                );
            }

            // Limiter à 100
            const displayArticles = articles.slice(0, 100);

            tbody.innerHTML = displayArticles.map(a => `
                <tr style="opacity:${a.active !== false ? '1' : '0.5'};">
                    <td><code style="background:var(--bg-primary); padding:2px 6px; border-radius:4px;">${a.code || '-'}</code></td>
                    <td><strong>${a.name || '-'}</strong></td>
                    <td><span style="padding:2px 8px; background:var(--bg-hover); border-radius:4px; font-size:11px;">${a.category || '-'}</span></td>
                    <td style="color:var(--accent-warning); font-weight:600;">${a.priceB2C ? a.priceB2C.toFixed(2) + ' CHF' : '-'}</td>
                    <td style="color:var(--accent-secondary); font-weight:600;">${a.priceB2B ? a.priceB2B.toFixed(2) + ' CHF' : '-'}</td>
                    <td>${a.unit || 'pce'}</td>
                    <td>${a.active !== false ? '<span style="color:var(--accent-primary);">✓</span>' : '<span style="color:var(--text-muted);">✕</span>'}</td>
                </tr>
            `).join('');

            if (articles.length > 100) {
                tbody.innerHTML += `<tr><td colspan="7" style="text-align:center; padding:16px; color:var(--text-muted);">... et ${articles.length - 100} autres articles. Affinez votre recherche.</td></tr>`;
            }
            if (articles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--text-muted);">Aucun article trouvé</td></tr>';
            }
        }

        function filterMFArticlesTable() {
            renderMFArticlesTable();
        }

        // Fonction pour changer le type de client dans le formulaire
        function setMFEditClientType(type) {
            document.getElementById('mf-edit-client-type').value = type;

            const b2bBtn = document.getElementById('mf-edit-type-b2b');
            const b2cBtn = document.getElementById('mf-edit-type-b2c');
            const companyField = document.getElementById('mf-edit-field-company');
            const lastnameLabel = document.getElementById('mf-edit-label-lastname');
            const firstnameLabel = document.getElementById('mf-edit-label-firstname');

            if (type === 'b2b') {
                // B2B sélectionné
                b2bBtn.style.border = '3px solid var(--accent-secondary)';
                b2bBtn.style.background = 'rgba(17,138,178,0.15)';
                b2cBtn.style.border = '3px solid var(--border-color)';
                b2cBtn.style.background = 'var(--bg-primary)';

                // Afficher champ société
                companyField.style.display = 'block';
                lastnameLabel.textContent = 'Nom du contact';
                firstnameLabel.textContent = 'Prénom du contact';
            } else {
                // B2C sélectionné
                b2cBtn.style.border = '3px solid var(--accent-warning)';
                b2cBtn.style.background = 'rgba(255,183,77,0.15)';
                b2bBtn.style.border = '3px solid var(--border-color)';
                b2bBtn.style.background = 'var(--bg-primary)';

                // Masquer champ société
                companyField.style.display = 'none';
                lastnameLabel.textContent = 'Nom *';
                firstnameLabel.textContent = 'Prénom';
            }
        }

        function showMFClientForm(id = null) {
            const modal = document.getElementById('mf-client-form-modal');
            document.getElementById('mf-client-form-title').textContent = id ? 'Modifier client' : 'Nouveau client';
            document.getElementById('mf-edit-client-id').value = id || '';

            // Reset tous les champs
            ['mf-edit-company', 'mf-edit-lastname', 'mf-edit-firstname', 'mf-edit-address', 'mf-edit-zip', 'mf-edit-city', 'mf-edit-mobile', 'mf-edit-phone', 'mf-edit-email', 'mf-edit-allergies', 'mf-edit-notes'].forEach(fieldId => {
                const el = document.getElementById(fieldId);
                if (el) el.value = '';
            });
            document.getElementById('mf-edit-active').checked = true;

            if (id) {
                const client = (QOData?.clients || []).find(c => c.id === id);
                if (client) {
                    const clientType = (client.clientType || 'b2b').toLowerCase();
                    setMFEditClientType(clientType);

                    // Pour B2B, le nom de société est dans "name"
                    if (clientType === 'b2b') {
                        document.getElementById('mf-edit-company').value = client.name || '';
                        document.getElementById('mf-edit-lastname').value = client.contact || client.lastname || '';
                        document.getElementById('mf-edit-firstname').value = client.firstname || '';
                    } else {
                        document.getElementById('mf-edit-lastname').value = client.lastname || '';
                        document.getElementById('mf-edit-firstname').value = client.firstname || '';
                    }

                    document.getElementById('mf-edit-address').value = client.address || '';
                    document.getElementById('mf-edit-zip').value = client.zip || '';
                    document.getElementById('mf-edit-city').value = client.city || '';
                    document.getElementById('mf-edit-mobile').value = client.mobile || '';
                    document.getElementById('mf-edit-phone').value = client.phone || '';
                    document.getElementById('mf-edit-email').value = client.email || '';
                    document.getElementById('mf-edit-allergies').value = client.allergies || '';
                    document.getElementById('mf-edit-notes').value = client.notes || '';
                    document.getElementById('mf-edit-active').checked = client.active !== false;
                }
            } else {
                // Nouveau client - par défaut B2C
                setMFEditClientType('b2c');
            }

            modal.style.display = 'flex';
        }

        function editMFClient(id) {
            showMFClientForm(id);
        }

        function closeMFClientForm() {
            document.getElementById('mf-client-form-modal').style.display = 'none';
        }

        function saveMFClient() {
            const id = document.getElementById('mf-edit-client-id').value;
            const clientType = document.getElementById('mf-edit-client-type').value.toUpperCase();
            const isB2B = clientType === 'B2B';

            const company = document.getElementById('mf-edit-company').value.trim();
            const lastname = document.getElementById('mf-edit-lastname').value.trim();
            const mobile = document.getElementById('mf-edit-mobile').value.trim();
            const city = document.getElementById('mf-edit-city').value.trim();

            // Validation selon le type
            if (isB2B) {
                if (!company) { alert('Le nom de la société est requis'); return; }
            } else {
                if (!lastname) { alert('Le nom est requis'); return; }
            }
            if (!mobile) { alert('Le téléphone portable est requis'); return; }
            if (!city) { alert('Le lieu est requis'); return; }

            const clientData = {
                clientType: clientType,
                // Pour B2B : name = société, contact = personne
                // Pour B2C : lastname/firstname = personne
                name: isB2B ? company : '',
                contact: isB2B ? lastname : '',
                lastname: isB2B ? '' : lastname,
                firstname: document.getElementById('mf-edit-firstname').value.trim(),
                address: document.getElementById('mf-edit-address').value.trim(),
                zip: document.getElementById('mf-edit-zip').value.trim(),
                city: city,
                mobile: mobile,
                phone: document.getElementById('mf-edit-phone').value.trim(),
                email: document.getElementById('mf-edit-email').value.trim(),
                allergies: document.getElementById('mf-edit-allergies').value.trim(),
                notes: document.getElementById('mf-edit-notes').value.trim(),
                active: document.getElementById('mf-edit-active').checked
            };

            if (id) {
                const idx = QOData.clients.findIndex(c => c.id == id);
                if (idx >= 0) {
                    QOData.clients[idx] = { ...QOData.clients[idx], ...clientData };
                }
            } else {
                clientData.id = Date.now();
                QOData.clients.push(clientData);
            }

            localStorage.setItem('qo_clients', JSON.stringify(QOData.clients));
            closeMFClientForm();
            renderMFClientsTable();
        }

        function showMFStoresModal() {
            renderMFStoresTable();
            document.getElementById('mf-stores-modal').style.display = 'flex';
        }

        function closeMFStoresModal() {
            document.getElementById('mf-stores-modal').style.display = 'none';
        }

        function renderMFStoresTable() {
            const tbody = document.getElementById('mf-stores-tbody');
            tbody.innerHTML = MFData.stores.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.address || '-'}</td>
                    <td>${s.email || '-'}</td>
                    <td>${s.phone || '-'}</td>
                    <td>
                        <button onclick="editMFStore(${s.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">✏️</button>
                    </td>
                </tr>
            `).join('');
        }

        function showMFStoreForm(id = null) {
            document.getElementById('mf-store-form-title').textContent = id ? '🏪 Modifier magasin' : '🏪 Nouveau magasin';
            document.getElementById('mf-edit-store-id').value = id || '';

            // Jours par défaut
            const defaultHours = {
                mon: { open: true, start: '08:00', end: '18:00' },
                tue: { open: true, start: '08:00', end: '18:00' },
                wed: { open: true, start: '08:00', end: '18:00' },
                thu: { open: true, start: '08:00', end: '18:00' },
                fri: { open: true, start: '08:00', end: '18:00' },
                sat: { open: true, start: '08:00', end: '12:00' },
                sun: { open: false, start: '09:00', end: '12:00' }
            };

            if (id) {
                const store = MFData.stores.find(s => s.id === id);
                if (store) {
                    document.getElementById('mf-edit-store-name').value = store.name || '';
                    document.getElementById('mf-edit-store-address').value = store.address || '';
                    document.getElementById('mf-edit-store-email').value = store.email || '';
                    document.getElementById('mf-edit-store-phone').value = store.phone || '';
                    document.getElementById('mf-edit-store-slot').value = store.slotDuration || '60';

                    // Charger les horaires
                    const hours = store.hours || defaultHours;
                    ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].forEach(day => {
                        const dayHours = hours[day] || defaultHours[day];
                        document.getElementById(`mf-hour-${day}-open`).checked = dayHours.open;
                        document.getElementById(`mf-hour-${day}-start`).value = dayHours.start || '08:00';
                        document.getElementById(`mf-hour-${day}-end`).value = dayHours.end || '18:00';
                        toggleMFDayHours(day);
                    });

                    // Charger les jours exceptionnels
                    renderMFExceptionalDays(store.exceptionalDays || []);
                }
            } else {
                // Reset form
                ['mf-edit-store-name', 'mf-edit-store-address', 'mf-edit-store-email', 'mf-edit-store-phone'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                document.getElementById('mf-edit-store-slot').value = '60';

                // Reset horaires par défaut
                ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].forEach(day => {
                    const dayHours = defaultHours[day];
                    document.getElementById(`mf-hour-${day}-open`).checked = dayHours.open;
                    document.getElementById(`mf-hour-${day}-start`).value = dayHours.start;
                    document.getElementById(`mf-hour-${day}-end`).value = dayHours.end;
                    toggleMFDayHours(day);
                });

                // Reset jours exceptionnels
                renderMFExceptionalDays([]);
            }

            document.getElementById('mf-store-form-modal').style.display = 'flex';
        }

        function editMFStore(id) {
            showMFStoreForm(id);
        }

        function closeMFStoreForm() {
            document.getElementById('mf-store-form-modal').style.display = 'none';
        }

        // Toggle affichage horaires jour
        function toggleMFDayHours(day) {
            const isOpen = document.getElementById(`mf-hour-${day}-open`).checked;
            const timesDiv = document.getElementById(`mf-hour-${day}-times`);
            const closedSpan = document.getElementById(`mf-hour-${day}-closed`);

            if (timesDiv) timesDiv.style.display = isOpen ? 'flex' : 'none';
            if (closedSpan) closedSpan.style.display = isOpen ? 'none' : 'inline';
        }

        // Jours exceptionnels
        let mfExceptionalDays = [];

        function renderMFExceptionalDays(days) {
            mfExceptionalDays = days || [];
            const container = document.getElementById('mf-exceptional-days');
            const noExceptional = document.getElementById('mf-no-exceptional');

            if (mfExceptionalDays.length === 0) {
                container.innerHTML = '';
                noExceptional.style.display = 'block';
                return;
            }

            noExceptional.style.display = 'none';
            container.innerHTML = mfExceptionalDays.map((day, idx) => `
                <div style="display:flex; align-items:center; gap:8px; padding:10px; background:var(--bg-card); border-radius:8px; flex-wrap:wrap;">
                    <input type="date" value="${day.date}" onchange="updateMFExceptionalDay(${idx}, 'date', this.value)"
                        style="padding:6px 10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                    <input type="text" value="${day.label || ''}" placeholder="Libellé (ex: Noël)" onchange="updateMFExceptionalDay(${idx}, 'label', this.value)"
                        style="flex:1; min-width:100px; padding:6px 10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                    <label style="display:flex; align-items:center; gap:4px; font-size:11px;">
                        <input type="checkbox" ${day.closed ? 'checked' : ''} onchange="updateMFExceptionalDay(${idx}, 'closed', this.checked)">
                        Fermé
                    </label>
                    <div style="display:${day.closed ? 'none' : 'flex'}; align-items:center; gap:4px;" id="mf-exc-times-${idx}">
                        <input type="time" value="${day.start || '09:00'}" onchange="updateMFExceptionalDay(${idx}, 'start', this.value)"
                            style="padding:4px 6px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:11px;">
                        <span style="font-size:11px;">à</span>
                        <input type="time" value="${day.end || '17:00'}" onchange="updateMFExceptionalDay(${idx}, 'end', this.value)"
                            style="padding:4px 6px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:11px;">
                    </div>
                    <button onclick="removeMFExceptionalDay(${idx})" style="padding:4px 8px; background:var(--accent-danger)20; border:1px solid var(--accent-danger); border-radius:4px; color:var(--accent-danger); cursor:pointer; font-size:12px;">✕</button>
                </div>
            `).join('');
        }

        function addMFExceptionalDay() {
            const today = new Date().toISOString().split('T')[0];
            mfExceptionalDays.push({
                date: today,
                label: '',
                closed: false,
                start: '09:00',
                end: '17:00'
            });
            renderMFExceptionalDays(mfExceptionalDays);
        }

        function updateMFExceptionalDay(idx, field, value) {
            if (mfExceptionalDays[idx]) {
                mfExceptionalDays[idx][field] = value;
                // Si on change closed, re-render pour afficher/masquer les heures
                if (field === 'closed') {
                    renderMFExceptionalDays(mfExceptionalDays);
                }
            }
        }

        function removeMFExceptionalDay(idx) {
            mfExceptionalDays.splice(idx, 1);
            renderMFExceptionalDays(mfExceptionalDays);
        }

        function saveMFStore() {
            const id = document.getElementById('mf-edit-store-id').value;
            const name = document.getElementById('mf-edit-store-name').value.trim();
            const email = document.getElementById('mf-edit-store-email').value.trim();

            if (!name) { alert('Le nom est requis'); return; }
            if (!email) { alert('L\'email est requis pour l\'envoi des confirmations'); return; }

            // Collecter les horaires
            const hours = {};
            ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].forEach(day => {
                hours[day] = {
                    open: document.getElementById(`mf-hour-${day}-open`).checked,
                    start: document.getElementById(`mf-hour-${day}-start`).value,
                    end: document.getElementById(`mf-hour-${day}-end`).value
                };
            });

            const storeData = {
                name,
                address: document.getElementById('mf-edit-store-address').value.trim(),
                email,
                phone: document.getElementById('mf-edit-store-phone').value.trim(),
                slotDuration: parseInt(document.getElementById('mf-edit-store-slot').value) || 60,
                hours,
                exceptionalDays: mfExceptionalDays.filter(d => d.date) // Filtrer les jours vides
            };

            if (id) {
                const idx = MFData.stores.findIndex(s => s.id == id);
                if (idx >= 0) {
                    MFData.stores[idx] = { ...MFData.stores[idx], ...storeData };
                }
            } else {
                storeData.id = Date.now();
                MFData.stores.push(storeData);
            }

            saveMFData('stores');
            closeMFStoreForm();
            renderMFStoresTable();
            renderMFStoresTiles();
        }

        function showMFOrderDetail(orderId) {
            const order = MFData.orders.find(o => o.id === orderId);
            if (!order) return;

            const client = (QOData?.clients || []).find(c => c.id === order.clientId);
            const store = MFData.stores.find(s => s.id === order.storeId);

            document.getElementById('mf-detail-order-id').textContent = '#' + order.id;
            document.getElementById('mf-order-detail-content').innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div style="padding:16px; background:var(--bg-primary); border-radius:10px;">
                        <h4 style="color:var(--accent-primary); margin-bottom:10px;">👤 Client</h4>
                        <div><strong>${client?.lastname || ''} ${client?.firstname || ''}</strong></div>
                        <div style="font-size:13px; color:var(--text-muted);">📞 ${client?.mobile || client?.phone || '-'}</div>
                        <div style="font-size:13px; color:var(--text-muted);">📧 ${client?.email || '-'}</div>
                    </div>
                    <div style="padding:16px; background:var(--bg-primary); border-radius:10px;">
                        <h4 style="color:var(--accent-primary); margin-bottom:10px;">📍 Retrait</h4>
                        <div><strong>${store?.name || ''}</strong></div>
                        <div style="font-size:13px; color:var(--text-muted);">${store?.address || ''}</div>
                        <div style="margin-top:8px; font-weight:600;">📅 ${formatDate(order.pickupDate)} à ${order.pickupTime}</div>
                    </div>
                </div>
                <div style="background:var(--bg-primary); border-radius:10px; overflow:hidden; margin-bottom:20px;">
                    <table style="width:100%;">
                        <thead style="background:var(--bg-hover);"><tr><th style="padding:12px;">Article</th><th style="padding:12px; text-align:center;">Qté</th><th style="padding:12px; text-align:right;">Total</th></tr></thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr><td style="padding:12px;">${item.name}</td><td style="padding:12px; text-align:center;">${item.qty} ${item.unit}</td><td style="padding:12px; text-align:right;">${(item.price * item.qty).toFixed(2)} CHF</td></tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="text-align:right; font-size:13px;">
                    <div>Sous-total: ${order.subtotal.toFixed(2)} CHF</div>
                    <div>TVA (2.6%): ${order.tva.toFixed(2)} CHF</div>
                    <div style="font-size:20px; font-weight:700; color:var(--accent-primary); margin-top:8px;">TOTAL: ${order.total.toFixed(2)} CHF</div>
                </div>
                ${order.notes ? `<div style="margin-top:16px; padding:12px; background:var(--bg-primary); border-radius:8px;"><strong>📝 Notes:</strong> ${order.notes}</div>` : ''}
            `;

            const statusOptions = ['pending', 'confirmed', 'ready', 'delivered'];
            const currentIdx = statusOptions.indexOf(order.status);
            const nextStatus = statusOptions[currentIdx + 1];
            const statusLabels = { pending: 'En attente', confirmed: 'Confirmée', ready: 'Prête', delivered: 'Remise' };

            document.getElementById('mf-order-detail-actions').innerHTML = `
                <button onclick="printMFOrderById(${order.id})" class="btn btn-secondary">🖨️ Imprimer</button>
                ${nextStatus ? `<button onclick="updateMFOrderStatus(${order.id}, '${nextStatus}')" class="btn btn-primary">✅ Marquer comme ${statusLabels[nextStatus]}</button>` : ''}
            `;

            document.getElementById('mf-order-detail-modal').style.display = 'flex';
        }

        function closeMFOrderDetail() {
            document.getElementById('mf-order-detail-modal').style.display = 'none';
        }

        function updateMFOrderStatus(orderId, newStatus) {
            const order = MFData.orders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                saveMFData('orders');
                closeMFOrderDetail();
                initMFDashboard();
            }
        }

        // Init MyFish
        function initMyFish() {
            initMFDashboard();
        }

        // Auto-init when MyFish tab is clicked
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.dataset.page === 'myfish') {
                    setTimeout(initMyFish, 100);
                }
            });
        });

        // ========================================
        // SYSTÈME DE GESTION DES UTILISATEURS
        // ========================================

        // ===== VERSION DE L'APPLICATION =====
        const APP_VERSION = '3.0.3';
        const APP_VERSION_DATE = '2025-12-01';
        
        // ===== UTILISATEURS PAR DÉFAUT =====
        (function initDefaultUsers() {
            let users = JSON.parse(localStorage.getItem('trakio_users') || '[]');
            
            // Vérifier si les IDs sont des strings (ancien format) - migration nécessaire
            const needsMigration = users.length > 0 && typeof users[0].id === 'string';
            
            if (users.length === 0 || needsMigration) {
                const defaultUsers = [
                    {
                        id: 1,
                        name: 'Pascal Admin',
                        pin: '1277',
                        role: 'admin',
                        active: true,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: 'Céline',
                        pin: '1277',
                        role: 'superuser',
                        active: true,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 3,
                        name: 'Hayat',
                        pin: '1260',
                        role: 'user',
                        active: true,
                        createdAt: new Date().toISOString()
                    }
                ];
                localStorage.setItem('trakio_users', JSON.stringify(defaultUsers));
                console.log('✅ Utilisateurs par défaut créés: Pascal Admin (1277), Céline (1277), Hayat (1260)');
            }
        })();

        // Changelog des versions (pour affichage)
        const VERSION_CHANGELOG = {
            '3.0.3': [
                '📥 Modal import clients avec choix du mode',
                '🔄 Option "Remplacer tout" (vide + importe)',
                '➕ Option "Mettre à jour / Ajouter" (conserve existants)',
                '📊 Affichage du nombre de clients actuels'
            ],
            '3.0.2': [
                '🔄 Import clients intelligent (mise à jour au lieu de doublons)',
                '🔍 Détection par numéro client ou nom',
                '📊 Affichage séparé: ajoutés vs mis à jour'
            ],
            '3.0.1': [
                '👤 Utilisateurs par défaut intégrés au code',
                '🔐 Pascal Admin (1277), Céline (1277), Hayat (1260)',
                '🚀 Plus besoin de console pour créer les comptes'
            ],
            '3.0.0': [
                '👥 Module RH Personnel complet (Admin only)',
                '📅 Calendrier mensuel des absences',
                '🏖️ Gestion vacances, congés, maladies',
                '⏰ Config: 8h30/jour, 42.5h/sem, 4 sem vacances',
                '📊 Décompte annuel avec soldes par employé',
                '🖨️ Impression par personnel/mois/année',
                '🗑️ Suppression de TRAKIO Pilot (séparé)'
            ],
            '2.9.9': [
                '🔐 Écran de connexion élégant avec sélection utilisateur',
                '🔒 Authentification par code PIN sécurisé',
                '⏰ Déconnexion automatique après 1h d\'inactivité',
                '📊 Historique des connexions (Admin only)'
            ],
            '2.9.8': [
                '🏠 Dashboard PRO - Nouveau design élégant et organisé',
                '🔴 Zone urgente avec statuts en temps réel',
                '⚡ Accès rapides - 6 tuiles principales avec animations',
                '🛠️ Section Outils rétractable pour modules secondaires'
            ]
        };

        // Vérifier si une mise à jour est nécessaire
        function checkVersionUpdate() {
            const savedVersion = localStorage.getItem('trakio_version');

            if (!savedVersion) {
                // Première installation
                localStorage.setItem('trakio_version', APP_VERSION);
                return;
            }

            if (savedVersion !== APP_VERSION) {
                // Nouvelle version détectée
                showUpdateModal(savedVersion, APP_VERSION);
            }
        }

        // Modal de mise à jour
        function showUpdateModal(oldVersion, newVersion) {
            const changes = VERSION_CHANGELOG[newVersion] || ['Améliorations diverses'];

            const modal = document.createElement('div');
            modal.id = 'update-modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:10000; display:flex; justify-content:center; align-items:center; padding:20px;';
            modal.innerHTML = `
                <div style="background:var(--bg-card); border-radius:20px; max-width:450px; width:100%; overflow:hidden; animation:slideUp 0.3s ease;">
                    <div style="padding:24px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); text-align:center;">
                        <div style="font-size:50px; margin-bottom:10px;">🚀</div>
                        <h2 style="color:#000; font-weight:700; margin:0;">Nouvelle version !</h2>
                        <p style="color:#000; opacity:0.8; margin:8px 0 0;">TRAKIO ${newVersion}</p>
                    </div>

                    <div style="padding:24px;">
                        <p style="color:var(--text-muted); font-size:13px; margin-bottom:16px;">
                            Vous passez de <strong>v${oldVersion}</strong> à <strong>v${newVersion}</strong>
                        </p>

                        <div style="background:var(--bg-primary); border-radius:12px; padding:16px; margin-bottom:20px;">
                            <div style="font-weight:600; margin-bottom:12px; color:var(--accent-primary);">📋 Nouveautés :</div>
                            ${changes.map(c => `<div style="font-size:13px; padding:6px 0; border-bottom:1px solid var(--border-color);">${c}</div>`).join('')}
                        </div>

                        <div style="background:#f39c1220; border:1px solid #f39c12; border-radius:10px; padding:12px; margin-bottom:20px;">
                            <div style="font-size:13px; color:#f39c12;">
                                ⚠️ <strong>Mise à jour recommandée</strong><br>
                                <span style="font-size:12px; opacity:0.9;">Les permissions des utilisateurs Admin seront mises à jour avec les nouveaux modules.</span>
                            </div>
                        </div>

                        <div style="display:flex; gap:12px;">
                            <button onclick="skipUpdate()" style="flex:1; padding:14px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; font-weight:600; cursor:pointer;">
                                Plus tard
                            </button>
                            <button onclick="applyUpdate()" style="flex:2; padding:14px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color:#000; border:none; border-radius:10px; font-weight:700; cursor:pointer;">
                                ✅ Mettre à jour
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Appliquer la mise à jour
        function applyUpdate() {
            // Mettre à jour les permissions des admins
            const allModules = MODULES_CONFIG.modules.map(m => m.id);
            const allActions = MODULES_CONFIG.actions.map(a => a.id);
            const allSettings = MODULES_CONFIG.settings.map(s => s.id);

            let updated = 0;
            UsersData.users.forEach(user => {
                if (user.role === 'admin') {
                    user.permissions = {
                        modules: allModules,
                        actions: allActions,
                        settings: allSettings
                    };
                    updated++;
                }
            });

            // Sauvegarder
            saveUsersData();
            localStorage.setItem('trakio_version', APP_VERSION);

            // Fermer le modal
            document.getElementById('update-modal')?.remove();

            // Notification
            showToast(`✅ Mise à jour v${APP_VERSION} appliquée ! ${updated} admin(s) mis à jour.`);

            // Rafraîchir l'interface
            if (UsersData.currentUser?.role === 'admin') {
                UsersData.currentUser.permissions = { modules: allModules, actions: allActions, settings: allSettings };
                applyUserPermissions();
            }
        }

        // Ignorer la mise à jour (pour cette session)
        function skipUpdate() {
            document.getElementById('update-modal')?.remove();
            // On ne sauvegarde pas la version, le modal réapparaîtra au prochain chargement
        }

        // ===== CONFIGURATION CENTRALISÉE DES MODULES =====
        // Ajouter un nouveau module ici = il apparaît automatiquement dans les permissions
        const MODULES_CONFIG = {
            // Modules principaux (pages/navigation)
            modules: [
                { id: 'dashboard', name: 'Dashboard', icon: '🏠', description: 'Accueil' },
                { id: 'quickorder', name: 'Prise de commande', icon: '⚡', description: 'Créer des commandes' },
                { id: 'orders', name: 'Commandes en cours', icon: '📋', description: 'Gérer les commandes' },
                { id: 'articles', name: 'Articles', icon: '📦', description: 'Gestion des produits' },
                { id: 'clients', name: 'Clients', icon: '👥', description: 'Gestion des clients' },
                { id: 'myfish', name: 'MyFish', icon: '🐟', description: 'Commandes clients privés B2C' },
                { id: 'cours-poissons', name: 'Cours Poissons Frais', icon: '🎣', description: 'Tarifs et marges poissons' },
                { id: 'prix-fournisseurs', name: 'Prix Fournisseurs', icon: '💵', description: 'Comparaison prix fournisseurs' },
                { id: 'analyses', name: 'Analyses', icon: '📊', description: 'Statistiques et analyses' },
                { id: 'shop', name: 'Shop Hub', icon: '🛍️', description: 'Shopify, Nutri-Score, Fiches Produit' },
                { id: 'prix-traversette', name: 'Prix Traversette', icon: '💰', description: 'Calcul prix Traversette' },
                { id: 'tracking', name: 'Suivi', icon: '📍', description: 'Suivi des livraisons' },
                { id: 'reports', name: 'Rapports', icon: '📈', description: 'Statistiques et rapports' },
                { id: 'settings', name: 'Paramètres', icon: '⚙️', description: 'Configuration' }
            ],
            // Actions/Fonctionnalités
            actions: [
                { id: 'articles-add', name: 'Ajouter articles', icon: '➕', description: 'Créer de nouveaux articles' },
                { id: 'articles-edit', name: 'Modifier articles', icon: '✏️', description: 'Modifier les articles existants' },
                { id: 'articles-delete', name: 'Supprimer articles', icon: '🗑️', description: 'Supprimer des articles' },
                { id: 'articles-import', name: 'Import articles', icon: '📥', description: 'Importer des articles CSV/XLS' },
                { id: 'articles-export', name: 'Export articles', icon: '📤', description: 'Exporter les articles' },
                { id: 'clients-add', name: 'Ajouter clients', icon: '➕', description: 'Créer de nouveaux clients' },
                { id: 'clients-edit', name: 'Modifier clients', icon: '✏️', description: 'Modifier les clients existants' },
                { id: 'clients-delete', name: 'Supprimer clients', icon: '🗑️', description: 'Supprimer des clients' },
                { id: 'clients-import', name: 'Import clients', icon: '📥', description: 'Importer des clients CSV/XLS' },
                { id: 'clients-export', name: 'Export clients', icon: '📤', description: 'Exporter les clients' },
                { id: 'orders-create', name: 'Créer commandes', icon: '📝', description: 'Créer de nouvelles commandes' },
                { id: 'orders-edit', name: 'Modifier commandes', icon: '✏️', description: 'Modifier les commandes' },
                { id: 'orders-delete', name: 'Supprimer commandes', icon: '🗑️', description: 'Supprimer des commandes' },
                { id: 'orders-pdf', name: 'Générer PDF', icon: '📄', description: 'Générer des PDF de commande' },
                { id: 'myfish-create', name: 'Créer commande MyFish', icon: '🐟', description: 'Créer commandes clients privés' },
                { id: 'myfish-edit', name: 'Modifier MyFish', icon: '✏️', description: 'Modifier commandes MyFish' },
                { id: 'myfish-delete', name: 'Supprimer MyFish', icon: '🗑️', description: 'Supprimer commandes MyFish' },
                { id: 'cpf-edit', name: 'Modifier Cours Poissons', icon: '🎣', description: 'Modifier les prix poissons' },
                { id: 'cpf-sync', name: 'Sync Prix Fournisseurs', icon: '🔄', description: 'Synchroniser depuis fournisseurs' },
                { id: 'pf-import', name: 'Import Prix Fournisseurs', icon: '📥', description: 'Importer liste de prix' },
                { id: 'pf-order', name: 'Commander Fournisseurs', icon: '🛒', description: 'Passer des commandes fournisseurs' },
                { id: 'shop-nutri', name: 'Nutri-Score', icon: '🏷️', description: 'Générer étiquettes Nutri-Score' },
                { id: 'shop-fiches', name: 'Fiches Produit', icon: '📝', description: 'Créer fiches produit Shopify' },
                { id: 'prix-confidential', name: 'Voir prix confidentiels', icon: '🔒', description: 'Voir les marges et PA' }
            ],
            // Paramètres sensibles (Super-User et Admin)
            settings: [
                { id: 'dropbox', name: 'Dropbox', icon: '☁️', description: 'Configuration Dropbox' },
                { id: 'numbering', name: 'Numérotation', icon: '🔢', description: 'Préfixes et tranches de numéros' },
                { id: 'export-data', name: 'Export données', icon: '📤', description: 'Exporter toutes les données' },
                { id: 'import-data', name: 'Import données', icon: '📥', description: 'Importer des données' },
                { id: 'reset-data', name: 'Réinitialiser', icon: '🗑️', description: 'Réinitialiser les données', danger: true },
                { id: 'users', name: 'Gestion utilisateurs', icon: '👥', description: 'Gérer les utilisateurs', adminOnly: true }
            ]
        };

        // Données des utilisateurs
        let UsersData = {
            users: JSON.parse(localStorage.getItem('trakio_users') || '[]'),
            currentUser: JSON.parse(localStorage.getItem('trakio_current_user') || 'null'),
            connectionLogs: JSON.parse(localStorage.getItem('trakio_connection_logs') || '[]')
        };
        
        // Timer de déconnexion automatique (1h = 3600000ms)
        let autoLogoutTimer = null;
        const AUTO_LOGOUT_DELAY = 60 * 60 * 1000; // 1 heure
        
        // ═══════════════════════════════════════════════════════════════
        // 🔐 SYSTÈME DE LOGIN
        // ═══════════════════════════════════════════════════════════════
        
        function populateLoginUsersList() {
            const select = document.getElementById('login-user-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">Sélectionnez...</option>';
            UsersData.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name + (user.role === 'admin' ? ' 👑' : '');
                select.appendChild(option);
            });
        }
        
        function updateLoginAvatar() {
            const select = document.getElementById('login-user-select');
            const userId = parseInt(select.value);
            // Focus sur le PIN après sélection
            if (userId) {
                document.getElementById('login-pin-input').focus();
            }
        }
        
        function togglePinVisibility() {
            const input = document.getElementById('login-pin-input');
            const icon = document.getElementById('pin-eye-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
            } else {
                input.type = 'password';
                icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
            }
        }
        
        function attemptLogin() {
            const select = document.getElementById('login-user-select');
            const pinInput = document.getElementById('login-pin-input');
            const errorDiv = document.getElementById('login-error');
            
            const userId = parseInt(select.value);
            const pin = pinInput.value;
            
            if (!userId) {
                errorDiv.innerHTML = '<span style="color:#ff6b6b; font-size:13px; font-weight:500;">⚠️ Sélectionnez un utilisateur</span>';
                errorDiv.style.display = 'block';
                return;
            }
            
            const user = UsersData.users.find(u => u.id === userId);
            if (!user) {
                errorDiv.innerHTML = '<span style="color:#ff6b6b; font-size:13px; font-weight:500;">❌ Utilisateur introuvable</span>';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Vérifier le PIN
            if (user.pin !== pin) {
                errorDiv.innerHTML = '<span style="color:#ff6b6b; font-size:13px; font-weight:500;">❌ Code PIN incorrect</span>';
                errorDiv.style.display = 'block';
                pinInput.value = '';
                pinInput.focus();
                
                // Log de tentative échouée
                logConnection(user.name, 'failed');
                return;
            }
            
            // Connexion réussie !
            errorDiv.style.display = 'none';
            UsersData.currentUser = user;
            localStorage.setItem('trakio_current_user', JSON.stringify(user));
            localStorage.setItem('trakio_session_start', Date.now().toString());
            
            // Log de connexion
            logConnection(user.name, 'login');
            
            // Masquer l'écran de login
            document.getElementById('login-screen').style.display = 'none';
            
            // Démarrer le timer de déconnexion auto
            startAutoLogoutTimer();
            
            // Mettre à jour l'interface
            updateUserInterface();
            applyUserPermissions();
            
            // Message de bienvenue
            showToast('👋 Bienvenue ' + user.name + ' !', 'success');
        }
        
        function logConnection(userName, type) {
            const now = new Date();
            const log = {
                user: userName,
                type: type, // 'login', 'logout', 'auto_logout', 'failed'
                date: now.toISOString().split('T')[0],
                time: now.toTimeString().split(' ')[0].substring(0, 5),
                timestamp: now.toISOString()
            };
            
            UsersData.connectionLogs.unshift(log);
            
            // Garder les 500 derniers logs
            if (UsersData.connectionLogs.length > 500) {
                UsersData.connectionLogs = UsersData.connectionLogs.slice(0, 500);
            }
            
            localStorage.setItem('trakio_connection_logs', JSON.stringify(UsersData.connectionLogs));
        }
        
        function startAutoLogoutTimer() {
            // Annuler le timer précédent
            if (autoLogoutTimer) clearTimeout(autoLogoutTimer);
            
            // Nouveau timer
            autoLogoutTimer = setTimeout(() => {
                autoLogout();
            }, AUTO_LOGOUT_DELAY);
            
            // Réinitialiser le timer sur activité
            document.addEventListener('click', resetAutoLogoutTimer);
            document.addEventListener('keypress', resetAutoLogoutTimer);
            document.addEventListener('touchstart', resetAutoLogoutTimer);
        }
        
        function resetAutoLogoutTimer() {
            if (UsersData.currentUser) {
                localStorage.setItem('trakio_session_start', Date.now().toString());
                if (autoLogoutTimer) clearTimeout(autoLogoutTimer);
                autoLogoutTimer = setTimeout(() => {
                    autoLogout();
                }, AUTO_LOGOUT_DELAY);
            }
        }
        
        function autoLogout() {
            if (UsersData.currentUser) {
                logConnection(UsersData.currentUser.name, 'auto_logout');
                performLogout('⏰ Session expirée après 1h d\'inactivité');
            }
        }
        
        function logout() {
            if (UsersData.currentUser) {
                logConnection(UsersData.currentUser.name, 'logout');
                performLogout('👋 Déconnexion réussie');
            }
        }
        
        function performLogout(message) {
            // Nettoyer
            UsersData.currentUser = null;
            localStorage.removeItem('trakio_current_user');
            localStorage.removeItem('trakio_session_start');
            
            if (autoLogoutTimer) clearTimeout(autoLogoutTimer);
            
            // Afficher l'écran de login
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-pin-input').value = '';
            document.getElementById('login-error').style.display = 'none';
            
            if (message) {
                showToast(message, 'info');
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'var(--accent-primary)' : type === 'error' ? '#ff6b6b' : '#118ab2';
            toast.style.cssText = 'position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:' + bgColor + '; color:white; padding:14px 24px; border-radius:12px; font-size:14px; font-weight:600; z-index:999999; box-shadow:0 6px 20px rgba(0,0,0,0.3); animation:slideUp 0.3s ease;';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideDown 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Vérifier la session au chargement
        function checkSession() {
            const sessionStart = localStorage.getItem('trakio_session_start');
            if (sessionStart) {
                const elapsed = Date.now() - parseInt(sessionStart);
                if (elapsed >= AUTO_LOGOUT_DELAY) {
                    // Session expirée
                    if (UsersData.currentUser) {
                        logConnection(UsersData.currentUser.name, 'auto_logout');
                    }
                    UsersData.currentUser = null;
                    localStorage.removeItem('trakio_current_user');
                    localStorage.removeItem('trakio_session_start');
                }
            }
        }

        // Initialiser avec Pascal comme admin si aucun utilisateur
        function initUsersSystem() {
            // Créer les permissions complètes pour admin
            const allModules = MODULES_CONFIG.modules.map(m => m.id);
            const allActions = MODULES_CONFIG.actions.map(a => a.id);
            const allSettings = MODULES_CONFIG.settings.map(s => s.id);

            if (UsersData.users.length === 0) {
                UsersData.users = [
                    {
                        id: 1,
                        name: 'Pascal',
                        initials: 'PA',
                        pin: '1234',
                        role: 'admin',
                        permissions: {
                            modules: allModules,
                            actions: allActions,
                            settings: allSettings
                        },
                        createdAt: new Date().toISOString()
                    }
                ];
                saveUsersData();
            } else {
                // Mettre à jour les admins existants avec les nouvelles permissions
                let updated = false;
                UsersData.users.forEach(user => {
                    if (user.role === 'admin') {
                        // Vérifier si les permissions ont changé
                        if (!user.permissions?.actions || user.permissions.actions.length !== allActions.length) {
                            user.permissions = {
                                modules: allModules,
                                actions: allActions,
                                settings: allSettings
                            };
                            updated = true;
                        }
                    }
                });
                if (updated) saveUsersData();
            }

            // Si pas d'utilisateur connecté ou session expirée, afficher le login
            checkSession();
            
            if (!UsersData.currentUser) {
                // Afficher l'écran de login
                document.getElementById('login-screen').style.display = 'flex';
                populateLoginUsersList();
            } else {
                // Utilisateur déjà connecté - masquer le login
                document.getElementById('login-screen').style.display = 'none';
                
                // Synchroniser l'utilisateur courant avec la liste des utilisateurs
                const currentFromList = UsersData.users.find(u => u.id === UsersData.currentUser.id);
                if (currentFromList) {
                    UsersData.currentUser = currentFromList;
                    saveUsersData();
                }
                
                // Redémarrer le timer de déconnexion
                startAutoLogoutTimer();
            }
            
            // Peupler la liste pour le login (au cas où)
            populateLoginUsersList();

            updateUserInterface();
            renderUsersList();
            applyUserPermissions();
        }

        function saveUsersData() {
            localStorage.setItem('trakio_users', JSON.stringify(UsersData.users));
            localStorage.setItem('trakio_current_user', JSON.stringify(UsersData.currentUser));
            // Sync automatique vers Dropbox si activé
            if (typeof DropboxConfig !== 'undefined' && DropboxConfig.autoSync && DropboxConfig.connected && !DropboxSync?.isSyncing) {
                syncToDropbox('users');
            }
        }
        
        // ═══════════════════════════════════════════════════════════════
        // 📊 GESTION DES LOGS DE CONNEXION
        // ═══════════════════════════════════════════════════════════════
        
        function refreshConnectionLogs() {
            const tbody = document.getElementById('connection-logs-tbody');
            if (!tbody) return;
            
            const logs = UsersData.connectionLogs || [];
            
            // Compter par type
            let countLogin = 0, countLogout = 0, countAuto = 0, countFailed = 0;
            logs.forEach(log => {
                if (log.type === 'login') countLogin++;
                else if (log.type === 'logout') countLogout++;
                else if (log.type === 'auto_logout') countAuto++;
                else if (log.type === 'failed') countFailed++;
            });
            
            // Mettre à jour les stats
            const el1 = document.getElementById('log-count-login');
            const el2 = document.getElementById('log-count-logout');
            const el3 = document.getElementById('log-count-auto');
            const el4 = document.getElementById('log-count-failed');
            if (el1) el1.textContent = countLogin;
            if (el2) el2.textContent = countLogout;
            if (el3) el3.textContent = countAuto;
            if (el4) el4.textContent = countFailed;
            
            // Afficher les 50 derniers logs
            const recentLogs = logs.slice(0, 50);
            
            if (recentLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding:20px; text-align:center; color:var(--text-muted);">Aucune connexion enregistrée</td></tr>';
                return;
            }
            
            tbody.innerHTML = recentLogs.map(log => {
                const typeInfo = {
                    'login': { icon: '✅', label: 'Connexion', color: 'var(--accent-primary)' },
                    'logout': { icon: '🚪', label: 'Déconnexion', color: '#118ab2' },
                    'auto_logout': { icon: '⏰', label: 'Auto (1h)', color: '#ffb74d' },
                    'failed': { icon: '❌', label: 'Échec PIN', color: '#ff6b6b' }
                }[log.type] || { icon: '❓', label: log.type, color: 'var(--text-muted)' };
                
                return `
                    <tr style="border-bottom:1px solid var(--border-color);">
                        <td style="padding:10px; font-weight:500;">${log.user}</td>
                        <td style="padding:10px; text-align:center;">
                            <span style="padding:4px 10px; background:${typeInfo.color}20; color:${typeInfo.color}; border-radius:6px; font-size:11px; font-weight:600;">
                                ${typeInfo.icon} ${typeInfo.label}
                            </span>
                        </td>
                        <td style="padding:10px; text-align:center; font-family:'Space Mono',monospace; font-size:11px;">${log.date}</td>
                        <td style="padding:10px; text-align:center; font-family:'Space Mono',monospace; font-size:11px;">${log.time}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function exportConnectionLogs() {
            const logs = UsersData.connectionLogs || [];
            if (logs.length === 0) {
                alert('Aucun log à exporter');
                return;
            }
            
            const data = JSON.stringify(logs, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'TRAKIO_ConnectionLogs_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('📤 Logs exportés !', 'success');
        }
        
        function clearConnectionLogs() {
            if (!confirm('⚠️ Voulez-vous vraiment supprimer tout l\'historique des connexions ?')) return;
            
            UsersData.connectionLogs = [];
            localStorage.setItem('trakio_connection_logs', '[]');
            refreshConnectionLogs();
            showToast('🗑️ Historique vidé', 'info');
        }

        // Tout cocher / tout décocher
        function toggleAllPermissions(checked) {
            document.querySelectorAll('#user-permissions-section input[type="checkbox"]').forEach(cb => {
                cb.checked = checked;
            });
        }

        // Générer dynamiquement les checkboxes de permissions
        function renderPermissionsCheckboxes(userPermissions = null) {
            const modulesContainer = document.getElementById('permissions-modules');
            const actionsContainer = document.getElementById('permissions-actions');
            const settingsContainer = document.getElementById('permissions-settings');

            if (!modulesContainer) return;

            const perms = userPermissions || { modules: ['quickorder'], actions: ['orders-create', 'orders-pdf'], settings: [] };

            // Modules
            modulesContainer.innerHTML = MODULES_CONFIG.modules.map(m => `
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:6px; background:var(--bg-card);">
                    <input type="checkbox" id="perm-mod-${m.id}" ${perms.modules?.includes(m.id) ? 'checked' : ''}>
                    ${m.icon} ${m.name}
                </label>
            `).join('');

            // Actions
            actionsContainer.innerHTML = MODULES_CONFIG.actions.map(a => `
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:6px; background:var(--bg-card);">
                    <input type="checkbox" id="perm-act-${a.id}" ${perms.actions?.includes(a.id) ? 'checked' : ''}>
                    ${a.icon} ${a.name}
                </label>
            `).join('');

            // Settings
            settingsContainer.innerHTML = MODULES_CONFIG.settings
                .filter(s => !s.adminOnly)
                .map(s => `
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:6px; background:var(--bg-card); ${s.danger ? 'border:1px solid var(--accent-danger);' : ''}">
                    <input type="checkbox" id="perm-set-${s.id}" ${perms.settings?.includes(s.id) ? 'checked' : ''}>
                    ${s.icon} ${s.name}
                </label>
            `).join('');
        }

        // Collecter les permissions depuis les checkboxes
        function collectPermissions() {
            const modules = MODULES_CONFIG.modules
                .filter(m => document.getElementById(`perm-mod-${m.id}`)?.checked)
                .map(m => m.id);

            const actions = MODULES_CONFIG.actions
                .filter(a => document.getElementById(`perm-act-${a.id}`)?.checked)
                .map(a => a.id);

            const settings = MODULES_CONFIG.settings
                .filter(s => document.getElementById(`perm-set-${s.id}`)?.checked)
                .map(s => s.id);

            return { modules, actions, settings };
        }

        // Obtenir toutes les permissions (pour admin)
        function getAllPermissions() {
            return {
                modules: MODULES_CONFIG.modules.map(m => m.id),
                actions: MODULES_CONFIG.actions.map(a => a.id),
                settings: MODULES_CONFIG.settings.map(s => s.id)
            };
        }

        // Vérifier si l'utilisateur a une permission
        function hasPermission(type, id) {
            const user = UsersData.currentUser;
            if (!user) return false;
            if (user.role === 'admin') return true;
            return user.permissions?.[type]?.includes(id) || false;
        }

        // Interface utilisateur
        function updateUserInterface() {
            const user = UsersData.currentUser;
            if (!user) return;

            // Mettre à jour le header
            document.getElementById('header-user-avatar').textContent = user.initials || user.name.substring(0, 2).toUpperCase();
            document.getElementById('header-user-name').textContent = user.name;

            // Mettre à jour le menu
            document.getElementById('menu-user-avatar').textContent = user.initials || user.name.substring(0, 2).toUpperCase();
            document.getElementById('menu-user-name').textContent = user.name;

            const roleEl = document.getElementById('menu-user-role');
            if (user.role === 'admin') {
                roleEl.textContent = '👑 Administrateur';
                roleEl.className = 'user-menu-role role-admin';
            } else if (user.role === 'superuser') {
                roleEl.textContent = '⭐ Super-User';
                roleEl.className = 'user-menu-role role-superuser';
            } else {
                roleEl.textContent = '👤 Utilisateur';
                roleEl.className = 'user-menu-role role-user';
            }

            // Afficher/Masquer le bouton gestion utilisateurs
            const usersBtn = document.getElementById('menu-users-btn');
            if (usersBtn) {
                usersBtn.style.display = user.role === 'admin' ? 'flex' : 'none';
            }
        }

        // Appliquer les permissions
        function applyUserPermissions() {
            const user = UsersData.currentUser;
            if (!user) return;

            // Admin = tout voir
            if (user.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
                document.querySelectorAll('[data-permission]').forEach(el => el.style.display = '');
                document.querySelectorAll('[data-action]').forEach(el => {
                    el.style.display = '';
                    el.disabled = false;
                });
                const usersCard = document.getElementById('users-management-card');
                if (usersCard) usersCard.style.display = '';
                return;
            }

            // Masquer les éléments admin-only
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');

            // Masquer la gestion des utilisateurs pour non-admin
            const usersCard = document.getElementById('users-management-card');
            if (usersCard) usersCard.style.display = 'none';

            // Appliquer les permissions aux modules (navigation)
            MODULES_CONFIG.modules.forEach(module => {
                const navItem = document.querySelector(`[onclick*="'${module.id}'"]`);
                if (navItem) {
                    const allowed = hasPermission('modules', module.id);
                    navItem.style.display = allowed ? '' : 'none';
                }
            });

            // Appliquer les permissions aux éléments avec data-permission
            document.querySelectorAll('[data-permission]').forEach(el => {
                const perm = el.dataset.permission;
                const [type, id] = perm.split(':');
                el.style.display = hasPermission(type, id) ? '' : 'none';
            });

            // Appliquer les permissions aux boutons d'action avec data-action
            document.querySelectorAll('[data-action]').forEach(el => {
                const actionId = el.dataset.action;
                const allowed = hasPermission('actions', actionId);
                if (!allowed) {
                    el.style.display = 'none';
                    el.disabled = true;
                }
            });
        }

        // Toggle menu utilisateur
        function toggleUserMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('active');
        }

        // Fermer le menu si clic ailleurs
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('user-menu');
            const profile = document.querySelector('.user-profile');
            if (menu && profile && !profile.contains(e.target)) {
                menu.classList.remove('active');
            }
        });

        // Afficher le profil utilisateur
        function showUserProfile() {
            const user = UsersData.currentUser;
            const moduleCount = user.permissions?.modules?.length || 0;
            const actionCount = user.permissions?.actions?.length || 0;

            alert(`👤 ${user.name}\n\n` +
                  `Rôle: ${user.role === 'admin' ? '👑 Administrateur' : user.role === 'superuser' ? '⭐ Super-User' : '👤 Utilisateur'}\n` +
                  `Modules: ${user.role === 'admin' ? 'Tous' : moduleCount + '/' + MODULES_CONFIG.modules.length}\n` +
                  `Actions: ${user.role === 'admin' ? 'Toutes' : actionCount + '/' + MODULES_CONFIG.actions.length}\n` +
                  `Code PIN: ••••\n` +
                  `Créé le: ${new Date(user.createdAt).toLocaleDateString('fr-CH')}`);
            document.getElementById('user-menu').classList.remove('active');
        }

        // Gestion utilisateurs (admin seulement)
        function showUserManagement() {
            document.getElementById('user-menu').classList.remove('active');
            navigateTo('settings');
            setTimeout(() => {
                document.getElementById('users-management-card').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // Liste des utilisateurs dans paramètres
        function renderUsersList() {
            const container = document.getElementById('users-list');
            if (!container) return;

            container.innerHTML = UsersData.users.map(user => {
                const roleIcon = user.role === 'admin' ? '👑' : user.role === 'superuser' ? '⭐' : '👤';
                const roleClass = user.role === 'admin' ? 'role-admin' : user.role === 'superuser' ? 'role-superuser' : 'role-user';
                const roleName = user.role === 'admin' ? 'Admin' : user.role === 'superuser' ? 'Super-User' : 'User';
                const isCurrent = UsersData.currentUser?.id === user.id;

                const moduleCount = user.permissions?.modules?.length || 0;
                const actionCount = user.permissions?.actions?.length || 0;

                return `
                <div style="display:flex; align-items:center; gap:12px; padding:14px; background:var(--bg-primary); border-radius:12px; border:2px solid ${isCurrent ? 'var(--accent-primary)' : 'transparent'};">
                    <div style="width:45px; height:45px; border-radius:50%; background:linear-gradient(135deg, var(--accent-purple), var(--accent-orange)); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:16px;">${user.initials || user.name.substring(0, 2).toUpperCase()}</div>
                    <div style="flex:1;">
                        <div style="font-weight:600;">${user.name} ${isCurrent ? '<span style="font-size:11px; color:var(--accent-primary);">(vous)</span>' : ''}</div>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
                            <span class="user-menu-role ${roleClass}" style="font-size:11px;">${roleIcon} ${roleName}</span>
                            ${user.role !== 'admin' ? `<span style="font-size:10px; color:var(--text-muted);">${moduleCount} modules • ${actionCount} actions</span>` : ''}
                        </div>
                    </div>
                    <div style="display:flex; gap:6px;">
                        <button onclick="editUser(${user.id})" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">✏️</button>
                        ${user.role !== 'admin' || UsersData.users.filter(u => u.role === 'admin').length > 1 ?
                            `<button onclick="deleteUser(${user.id})" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; color:var(--accent-danger);">🗑️</button>` : ''}
                    </div>
                </div>
            `}).join('');
        }

        // Modal ajout utilisateur
        function showAddUserModal() {
            document.getElementById('user-modal-title').textContent = '➕ Nouvel Utilisateur';
            document.getElementById('user-edit-id').value = '';
            document.getElementById('user-name').value = '';
            document.getElementById('user-initials').value = '';
            document.getElementById('user-pin').value = '';
            document.getElementById('user-role').value = 'user';

            // Générer les checkboxes de permissions
            renderPermissionsCheckboxes();

            updatePermissionsVisibility();
            document.getElementById('user-modal').style.display = 'flex';
        }

        function editUser(id) {
            const user = UsersData.users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('user-modal-title').textContent = '✏️ Modifier Utilisateur';
            document.getElementById('user-edit-id').value = id;
            document.getElementById('user-name').value = user.name;
            document.getElementById('user-initials').value = user.initials || '';
            document.getElementById('user-pin').value = user.pin;
            document.getElementById('user-role').value = user.role;

            // Générer les checkboxes avec les permissions de l'utilisateur
            renderPermissionsCheckboxes(user.permissions);

            updatePermissionsVisibility();
            document.getElementById('user-modal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('user-modal').style.display = 'none';
        }

        function updatePermissionsVisibility() {
            const role = document.getElementById('user-role').value;
            const permSection = document.getElementById('user-permissions-section');
            const superuserSettings = document.getElementById('superuser-settings');

            if (role === 'admin') {
                permSection.style.display = 'none';
            } else {
                permSection.style.display = 'block';
                superuserSettings.style.display = role === 'superuser' ? 'block' : 'none';
            }
        }

        function saveUser() {
            const id = document.getElementById('user-edit-id').value;
            const name = document.getElementById('user-name').value.trim();
            const initials = document.getElementById('user-initials').value.trim().toUpperCase() || name.substring(0, 2).toUpperCase();
            const pin = document.getElementById('user-pin').value.trim();
            const role = document.getElementById('user-role').value;

            if (!name || !pin || pin.length !== 4) {
                alert('❌ Nom et code PIN (4 chiffres) requis');
                return;
            }

            // Collecter les permissions selon le rôle
            const permissions = role === 'admin'
                ? getAllPermissions()
                : collectPermissions();

            const userData = {
                name,
                initials,
                pin,
                role,
                permissions
            };

            if (id) {
                // Modification
                const idx = UsersData.users.findIndex(u => u.id === parseInt(id));
                if (idx !== -1) {
                    UsersData.users[idx] = { ...UsersData.users[idx], ...userData };
                    // Mettre à jour l'utilisateur courant si c'est lui
                    if (UsersData.currentUser?.id === parseInt(id)) {
                        UsersData.currentUser = UsersData.users[idx];
                        updateUserInterface();
                        applyUserPermissions();
                    }
                }
            } else {
                // Création
                userData.id = Date.now();
                userData.createdAt = new Date().toISOString();
                UsersData.users.push(userData);
            }

            saveUsersData();
            renderUsersList();
            closeUserModal();
            alert('✅ Utilisateur enregistré !');
        }

        function deleteUser(id) {
            const user = UsersData.users.find(u => u.id === id);
            if (!user) return;

            if (UsersData.currentUser?.id === id) {
                alert('❌ Vous ne pouvez pas supprimer votre propre compte');
                return;
            }

            if (!confirm(`Supprimer l'utilisateur "${user.name}" ?`)) return;

            UsersData.users = UsersData.users.filter(u => u.id !== id);
            saveUsersData();
            renderUsersList();
        }

        // Changement d'utilisateur
        function switchUser() {
            document.getElementById('user-menu').classList.remove('active');
            logout(); // Utilise le nouveau système
        }

        function logoutUser() {
            document.getElementById('user-menu').classList.remove('active');
            if (confirm('Voulez-vous vous déconnecter ?')) {
                logout(); // Utilise le nouveau système
            }
        }

        function showLoginModal() {
            // Redirige vers le nouveau système de login
            logout();
        }
        
        // Garder l'ancien code pour compatibilité mais désactivé
        function showLoginModal_OLD() {
            const container = document.getElementById('login-users-list');
            if (!container) return;
            container.innerHTML = UsersData.users.map(user => {
                const roleIcon = user.role === 'admin' ? '👑' : user.role === 'superuser' ? '⭐' : '👤';
                return `
                <div onclick="selectLoginUser(${user.id})" style="display:flex; align-items:center; gap:12px; padding:14px; background:var(--bg-primary); border-radius:12px; cursor:pointer; transition:all 0.2s; border:2px solid transparent;" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='transparent'">
                    <div style="width:45px; height:45px; border-radius:50%; background:linear-gradient(135deg, var(--accent-purple), var(--accent-orange)); display:flex; align-items:center; justify-content:center; font-weight:700;">${user.initials || user.name.substring(0, 2).toUpperCase()}</div>
                    <div style="flex:1;">
                        <div style="font-weight:600;">${user.name}</div>
                        <div style="font-size:12px; color:var(--text-muted);">${roleIcon} ${user.role === 'admin' ? 'Admin' : user.role === 'superuser' ? 'Super-User' : 'User'}</div>
                    </div>
                    <div style="color:var(--text-muted);">→</div>
                </div>
            `}).join('');

            document.getElementById('login-pin-section').style.display = 'none';
            document.getElementById('login-users-list').style.display = 'flex';
            document.getElementById('login-modal').style.display = 'flex';
        }

        let selectedLoginUserId = null;

        function selectLoginUser(id) {
            selectedLoginUserId = id;
            document.getElementById('login-users-list').style.display = 'none';
            document.getElementById('login-pin-section').style.display = 'block';
            document.getElementById('login-pin').value = '';
            document.getElementById('login-pin').focus();
        }

        function checkLoginPin(event) {
            const pin = document.getElementById('login-pin').value;
            if (pin.length === 4) {
                const user = UsersData.users.find(u => u.id === selectedLoginUserId);
                if (user && user.pin === pin) {
                    UsersData.currentUser = user;
                    saveUsersData();
                    document.getElementById('login-modal').style.display = 'none';
                    updateUserInterface();
                    applyUserPermissions();
                    alert(`👋 Bienvenue ${user.name} !`);
                } else {
                    alert('❌ Code PIN incorrect');
                    document.getElementById('login-pin').value = '';
                }
            }
        }

        function cancelLogin() {
            document.getElementById('login-pin-section').style.display = 'none';
            document.getElementById('login-users-list').style.display = 'flex';
            selectedLoginUserId = null;
        }

        // Initialiser le système au chargement
        document.addEventListener('DOMContentLoaded', function() {
            initUsersSystem();
            // Vérifier si une mise à jour est disponible
            setTimeout(() => checkVersionUpdate(), 500);
        });

        // ========================================
        // QUICKORDER MODULE - Prise Commandes Rapide
        // ========================================

        const QOData = {
            clients: JSON.parse(localStorage.getItem('qo_clients') || '[]'),
            products: JSON.parse(localStorage.getItem('qo_products') || '[]'),
            orders: JSON.parse(localStorage.getItem('qo_orders') || '[]'),
            selectedClient: null,
            cart: []
        };

        // ArticlesData déclaré ici pour être disponible partout
        let ArticlesData = {
            articles: [],
            categories: [
                { id: 1, code: 'POISSON', name: 'Poissons frais', icon: '🐟' },
                { id: 2, code: 'CRUSTACE', name: 'Crustacés', icon: '🦐' },
                { id: 3, code: 'COQUILLAGE', name: 'Coquillages', icon: '🦪' },
                { id: 4, code: 'FUME', name: 'Produits fumés', icon: '🔥' },
                { id: 5, code: 'CONSERVE', name: 'Conserves', icon: '🥫' },
                { id: 6, code: 'PREPA', name: 'Préparations', icon: '🍽️' },
                { id: 7, code: 'SURGELE', name: 'Surgelés', icon: '❄️' },
                { id: 8, code: 'EPICERIE', name: 'Épicerie', icon: '🛒' }
            ],
            pricelists: [
                { id: 1, code: 'STD', name: 'Standard B2C', discount: 0, desc: 'Tarif particuliers' },
                { id: 2, code: 'PRO', name: 'Professionnels', discount: 15, desc: 'Restaurants, traiteurs' },
                { id: 3, code: 'GMS', name: 'Grande distribution', discount: 20, desc: 'Supermarchés, hypermarchés' }
            ],
            discounts: [
                { id: 1, categoryId: 8, pricelistId: null, tiers: [{ qty: 10, pct: 5 }, { qty: 20, pct: 10 }, { qty: 50, pct: 15 }] }
            ]
        };

        function initQOSampleData() {
            // IMPORTANT: Ne jamais écraser les données existantes !
            // Charger les produits SEULEMENT si totalement vide
            if (QOData.products.length === 0) {
                loadQODefaultProducts();
            }
            // Charger les clients SEULEMENT si totalement vide
            if (QOData.clients.length === 0) {
                loadQODefaultClients();
            }
        }

        // Charger les produits par défaut (structure B2B/B2C)
        function loadQODefaultProducts() {
            QOData.products = [
                { id: 1, code: '27', name: 'Ailes de raie sans peau FAO27', category: 'poisson', priceB2C: 36.9, priceB2B: 28.50, cost: 13.6, unit: 'kg', lot: '', active: true },
                { id: 2, code: '36', name: 'Bar de ligne entier sauvage', category: 'poisson', priceB2C: 65.0, priceB2B: 52.00, cost: 0, unit: 'kg', lot: '', active: true },
                { id: 3, code: '39', name: 'Bars 400/600 élevage', category: 'poisson', priceB2C: 22.2, priceB2B: 17.80, cost: 0, unit: 'kg', lot: '', active: true },
                { id: 4, code: '60', name: 'Dorade entière royale 200/300', category: 'poisson', priceB2C: 16.3, priceB2B: 13.50, cost: 9.15, unit: 'kg', lot: '', active: true },
                { id: 5, code: '75', name: 'Filet de Fera du lac Léman', category: 'poisson', priceB2C: 64.8, priceB2B: 52.00, cost: 26.0, unit: 'kg', lot: '', active: true },
                { id: 6, code: '90', name: 'Filet de Sébaste', category: 'poisson', priceB2C: 40.5, priceB2B: 32.50, cost: 22.8, unit: 'kg', lot: '', active: true },
                { id: 7, code: '93', name: 'Joues de cabillaud frais', category: 'poisson', priceB2C: 67.0, priceB2B: 54.00, cost: 32.25, unit: 'kg', lot: '', active: true },
                { id: 8, code: '96', name: 'Joues de lotte', category: 'poisson', priceB2C: 32.0, priceB2B: 25.50, cost: 12.0, unit: 'kg', lot: '', active: true },
                { id: 9, code: '99', name: 'Joues de sandre', category: 'poisson', priceB2C: 49.8, priceB2B: 40.00, cost: 20.5, unit: 'kg', lot: '', active: true },
                { id: 10, code: '111', name: 'Filet de maigre avec peau', category: 'poisson', priceB2C: 59.7, priceB2B: 48.00, cost: 19.3, unit: 'kg', lot: '', active: true },
                { id: 11, code: '114', name: 'Maquereaux entier', category: 'poisson', priceB2C: 19.9, priceB2B: 15.90, cost: 9.2, unit: 'kg', lot: '', active: true },
                { id: 12, code: '129', name: 'Filet de Perches du lac Léman', category: 'poisson', priceB2C: 80.0, priceB2B: 65.00, cost: 57.0, unit: 'kg', lot: '', active: true },
                { id: 13, code: '180', name: 'Filet de bar avec peau', category: 'poisson', priceB2C: 53.2, priceB2B: 42.50, cost: 24.15, unit: 'kg', lot: '', active: true },
                { id: 14, code: '183', name: 'Filet de perche Estonie', category: 'poisson', priceB2C: 49.9, priceB2B: 40.00, cost: 20.3, unit: 'kg', lot: '', active: true },
                { id: 15, code: '192', name: 'Filet de baudroie 100/200 GB', category: 'poisson', priceB2C: 97.9, priceB2B: 78.50, cost: 43.95, unit: 'kg', lot: '', active: true },
                { id: 16, code: '195', name: 'Filet de brochet du lac Léman sp/sa', category: 'poisson', priceB2C: 71.0, priceB2B: 57.00, cost: 35.0, unit: 'kg', lot: '', active: true },
                { id: 17, code: '213', name: 'Filet de carrelet Hollande', category: 'poisson', priceB2C: 30.5, priceB2B: 24.50, cost: 16.4, unit: 'kg', lot: '', active: true },
                { id: 18, code: '246', name: 'Filet de flétan sans bord', category: 'poisson', priceB2C: 40.5, priceB2B: 32.50, cost: 21.9, unit: 'kg', lot: '', active: true },
                { id: 19, code: '267', name: 'Dos de julienne', category: 'poisson', priceB2C: 35.3, priceB2B: 28.50, cost: 19.5, unit: 'kg', lot: '', active: true },
                { id: 20, code: '270', name: 'Filet de limande sp/sa', category: 'poisson', priceB2C: 54.7, priceB2B: 44.00, cost: 26.35, unit: 'kg', lot: '', active: true },
                { id: 21, code: '354', name: 'Filet de turbot Danemark', category: 'poisson', priceB2C: 101.0, priceB2B: 81.00, cost: 52.0, unit: 'kg', lot: '', active: true },
                { id: 22, code: '393', name: 'Dos de cabillaud Islande', category: 'poisson', priceB2C: 62.5, priceB2B: 50.00, cost: 29.65, unit: 'kg', lot: '', active: true },
                { id: 23, code: '405', name: 'Dos de lieu noir frais Islande', category: 'poisson', priceB2C: 36.7, priceB2B: 29.50, cost: 16.5, unit: 'kg', lot: '', active: true },
                { id: 24, code: '411', name: "Dos d'églefin royal sans peau", category: 'poisson', priceB2C: 50.7, priceB2B: 40.50, cost: 25.1, unit: 'kg', lot: '', active: true },
                { id: 25, code: '426', name: 'Pavé de thon Maldives/Oman', category: 'poisson', priceB2C: 63.5, priceB2B: 51.00, cost: 32.05, unit: 'kg', lot: '', active: true },
                { id: 26, code: '447', name: 'Filet de saumon Norvège', category: 'poisson', priceB2C: 36.2, priceB2B: 29.00, cost: 18.7, unit: 'kg', lot: '', active: true },
                { id: 27, code: '369', name: 'Filet de truite rose France', category: 'poisson', priceB2C: 45.0, priceB2B: 36.00, cost: 24.25, unit: 'kg', lot: '', active: true },
                { id: 28, code: '381', name: "Filet d'omble Islande", category: 'poisson', priceB2C: 51.5, priceB2B: 41.00, cost: 25.1, unit: 'kg', lot: '', active: true },
                { id: 29, code: '534', name: 'Crevettes roses cuites 60/80', category: 'crustace', priceB2C: 27.6, priceB2B: 22.00, cost: 17.4, unit: 'kg', lot: '', active: true },
                { id: 30, code: '591', name: 'Gambas crues 6/8', category: 'crustace', priceB2C: 41.9, priceB2B: 33.50, cost: 27.3, unit: 'kg', lot: '', active: true },
                { id: 31, code: '681', name: 'Langoustines vivantes', category: 'crustace', priceB2C: 65.0, priceB2B: 52.00, cost: 42.0, unit: 'kg', lot: '', active: true },
                { id: 32, code: '705', name: 'Homard entier cuit', category: 'crustace', priceB2C: 86.6, priceB2B: 69.00, cost: 52.0, unit: 'kg', lot: '', active: true },
                { id: 33, code: '762', name: 'Moules de bouchot', category: 'coquillage', priceB2C: 9.0, priceB2B: 7.20, cost: 4.5, unit: 'kg', lot: '', active: true },
                { id: 34, code: '798', name: 'Huîtres Fines n°3 (douzaine)', category: 'coquillage', priceB2C: 24.0, priceB2B: 19.20, cost: 12.0, unit: 'pce', lot: '', active: true },
                { id: 35, code: '816', name: 'Noix de St-Jacques France', category: 'coquillage', priceB2C: 107.9, priceB2B: 86.00, cost: 65.5, unit: 'kg', lot: '', active: true },
                { id: 36, code: '1128', name: 'Plateau fruits de mer 2 pers.', category: 'preparation', priceB2C: 95.0, priceB2B: 76.00, cost: 55.0, unit: 'pce', lot: '', active: true },
                { id: 37, code: '2310', name: 'Saumon fumé tranché', category: 'fume', priceB2C: 79.0, priceB2B: 63.00, cost: 45.0, unit: 'kg', lot: '', active: true },
                { id: 38, code: '2316', name: 'Truite fumée tranchée', category: 'fume', priceB2C: 65.0, priceB2B: 52.00, cost: 38.0, unit: 'kg', lot: '', active: true }
            ];
            saveQOData('products');
        }

        // Charger les clients par défaut (depuis le CSV importé)
        function loadQODefaultClients() {
QOData.clients = [
    { id: 125814, num: '125814', name: 'Agemo SA', contact: 'Service de distribution', address: 'Route de Carrouge 10', address2: '', zip: '1509', city: 'Vucherens', phone: '', mobile: '', email: '', credit: 2000, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 125813, num: '125813', name: 'Pâtissier Chocolatier Merigonde', contact: 'Carole & Joël Merigonde', address: 'Rue de Vermont 37', address2: '', zip: '1202', city: 'Genève', phone: '022 733 75 62', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 129818, num: '129818', name: 'Ultra Marine Food SA', contact: '', address: 'Rue de Blavignac 10', address2: '', zip: '1227', city: 'Carouge GE', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 129820, num: '129820', name: 'Alimentation Chez Anita', contact: 'Personneni', address: 'Rue de l\'Eglise', address2: '', zip: '1175', city: 'Lavigny', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 129821, num: '129821', name: 'Alimentation Chez Coco', contact: '', address: 'Route de la Poste', address2: '', zip: '1275', city: 'Chéserex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 129822, num: '129822', name: 'Alimentation Def\'', contact: 'Defferard', address: 'Grand-Rue 28', address2: '', zip: '1268', city: 'Begnins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 129823, num: '129823', name: 'Alimentation Pecoud', contact: '', address: 'Grand-Rue', address2: '', zip: '1261', city: 'Le Vaud', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 130104, num: '130104', name: 'Altermath', contact: 'Roland', address: 'Chemin de la Tour 23', address2: '', zip: '2067', city: 'Chaumont', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 130416, num: '130416', name: 'AAA Ambulances Service', contact: '', address: 'Route des Tattes-d\'Oie 93', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 130598, num: '130598', name: 'Amicale des pompiers', contact: '', address: 'p.adr. M. B. Stettler', address2: '', zip: '1277', city: 'Borex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 134628, num: '134628', name: 'José Arnoso', contact: 'Alimentation', address: 'Grand-Rue 59', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 135434, num: '135434', name: 'Kumar Asok', contact: 'ASOK', address: 'Rue de l\'Ancien-Collège 4', address2: '', zip: '1268', city: 'Begnins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136500, num: '136500', name: 'Au Coeur des Saveurs', contact: 'Baumgartner', address: 'Rue de la Paix 1', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136656, num: '136656', name: 'Claude Besnard', contact: 'Auberge de Crassier', address: '', address2: '', zip: '1263', city: 'Crassier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136657, num: '136657', name: 'Alain Pernet', contact: 'Auberge communale', address: '', address2: '', zip: '1274', city: 'Signy', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136658, num: '136658', name: 'Auberge Communale', contact: 'Au Sapin', address: '', address2: '', zip: '1271', city: 'Givrins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136659, num: '136659', name: 'Pierre-Alain Serex', contact: 'Auberge du Château', address: 'Place du Château 8', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136660, num: '136660', name: 'Claude Chambaz', contact: 'Auberge La Croix-Blanche', address: '', address2: '', zip: '1276', city: 'Gingins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136661, num: '136661', name: 'Gérard Landolt', contact: 'Auberge Communale', address: 'Place de la Tour', address2: '', zip: '1270', city: 'Trélex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136662, num: '136662', name: 'Martial et Danielle Huck', contact: 'Auberge Communale', address: 'Route de Bénex 1-3', address2: '', zip: '1197', city: 'Prangins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136663, num: '136663', name: 'Pascal et Danielle Aubert', contact: 'Auberge Communale', address: 'Au Village 7', address2: '', zip: '1277', city: 'Borex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136664, num: '136664', name: 'Auberge Communale Le Lion d\'Or', contact: '', address: '', address2: '', zip: '1261', city: 'Burtigny', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136665, num: '136665', name: 'Roland et Yvan Marguerat', contact: 'Auberge Communale', address: '', address2: '', zip: '1184', city: 'Luins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136666, num: '136666', name: 'Roger Volery', contact: 'Auberge Communale A l\'Etoile', address: '', address2: '', zip: '1278', city: 'La Rippe', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136667, num: '136667', name: 'David Berger', contact: 'Auberge des Trois Tilleuls', address: '', address2: '', zip: '1272', city: 'Genolier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136668, num: '136668', name: 'Olivier A. Martin', contact: 'Auberge Communale', address: 'Chemin de la Pinte 1', address2: '', zip: '1279', city: 'Bogis-Bossey', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 136670, num: '136670', name: 'Aubert', contact: '', address: '', address2: '', zip: '74400', city: 'St-Genis', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 137514, num: '137514', name: 'Philippe et Catherine Lapalud', contact: 'Restaurant L\'Avenir', address: '', address2: '', zip: '1113', city: 'St-Saphorin-Morges', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 144482, num: '144482', name: 'Restaurant', contact: 'Baccarat Léman SA', address: 'Place du Marché 1', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 144768, num: '144768', name: 'Banque Cantonale Vaudoise', contact: '', address: '', address2: '', zip: '1003', city: 'Lausanne', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 144950, num: '144950', name: 'Baumgartner', contact: 'Patrick', address: 'Route de Lausanne 108', address2: '', zip: '1197', city: 'Prangins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 144951, num: '144951', name: 'Bauer', contact: 'Jean-Christophe', address: 'Les Grands-Champs 5', address2: '', zip: '1275', city: 'Chéserex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 147836, num: '147836', name: 'Brahim Yuber', contact: 'Restaurant Bel-Horizon', address: '', address2: '', zip: '1273', city: 'Arzier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 147837, num: '147837', name: 'Belouin', contact: 'Gunilla', address: 'Route de Montelly 39', address2: '', zip: '1166', city: 'Perroy', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 147838, num: '147838', name: 'La Belle Suisse', contact: 'Patrick Monnier', address: 'Place de l\'Horloge', address2: '', zip: '1162', city: 'St-Prex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155558, num: '155558', name: 'Restaurant du Boiron', contact: '', address: '', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155636, num: '155636', name: 'Bolay SA', contact: '', address: 'Chemin des Artisans 6', address2: '', zip: '1263', city: 'Crassier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155688, num: '155688', name: 'Bonfrais Bongel', contact: 'Frigemo SA', address: 'Route de Reculan', address2: '', zip: '1024', city: 'Ecublens VD', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155689, num: '155689', name: 'Thierry Bonnin', contact: 'Boulangerie', address: 'Rue de Rive 31', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155870, num: '155870', name: 'Helder Coelho', contact: 'Boucherie', address: 'Route de St-Cergue 29', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155871, num: '155871', name: 'Christian Fayet', contact: 'Boulangerie', address: 'Rue de la Gare 6', address2: '', zip: '1197', city: 'Prangins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155872, num: '155872', name: 'Marc Cornaz', contact: 'Boucherie', address: 'La Cézille', address2: '', zip: '1268', city: 'Begnins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155873, num: '155873', name: 'Lena JENNY', contact: '\'\'\'La Boutade\'\'\'', address: 'Chemin de Closel A No 1', address2: '', zip: '2035', city: 'Corcelles NE', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155875, num: '155875', name: 'Boucherie de La Rippe', contact: '', address: 'Rue des Quatres-Fontaines', address2: '', zip: '1263', city: 'La Rippe', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155876, num: '155876', name: 'Boucherie Pradervand', contact: 'Gilles Pradervand', address: 'Place St-Martin 9', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155877, num: '155877', name: 'Boulangerie Badel', contact: '', address: 'Rue de l\'Eglise 1', address2: '', zip: '1269', city: 'Bassins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155878, num: '155878', name: 'Boulangerie D. Bossey', contact: '', address: 'Route de Genolier 2', address2: '', zip: '1270', city: 'Trélex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155879, num: '155879', name: 'Boulangerie Jacquat SA', contact: '', address: 'Rue du Château 8', address2: '', zip: '1026', city: 'Echandens', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155880, num: '155880', name: 'Boulangerie La Ruelle', contact: '', address: 'Grand-Rue 57', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155881, num: '155881', name: 'Boulangerie Raphaël', contact: 'Raphaël Schupbach', address: 'Route de nyon 2A', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 155922, num: '155922', name: 'Bowling de Meyrin', contact: '', address: 'Chemin de l\'Etang 67', address2: '', zip: '1219', city: 'Châtelaine', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 157690, num: '157690', name: 'La Brasserie', contact: '', address: 'Signy centre commercial', address2: '', zip: '1274', city: 'Signy', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 157691, num: '157691', name: 'Willy', contact: 'Brasserie de la Gare', address: 'Rue de la Gare 18', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 158054, num: '158054', name: 'Pierre Broggi', contact: 'Alimentation', address: 'Rue Neuve 7', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 167960, num: '167960', name: 'Walter Chételat', contact: 'Restaurant Café des Alpes', address: 'Rue des Alpes 7', address2: '', zip: '1197', city: 'Prangins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 167961, num: '167961', name: 'Jean-Jacques Chaumont', contact: 'Café de La Poste', address: '', address2: '', zip: '1276', city: 'Gingins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 167962, num: '167962', name: 'Elin et Laurent Michaux', contact: 'Café de La Poste', address: 'Route de Nyon', address2: '', zip: '1264', city: 'St-Cergue', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 167963, num: '167963', name: 'Salvatore Marchese', contact: 'Café Restaurant de la Gare', address: '', address2: '', zip: '1166', city: 'Perroy', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 167964, num: '167964', name: 'Rivenside Restaurants Sàrl', contact: 'Café de la Banque', address: 'Place du Marché', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 168168, num: '168168', name: 'Schmutz', contact: 'Restaurant Le Canard Bleu', address: 'Tennisvic SA', address2: '', zip: '1267', city: 'Vich', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 171288, num: '171288', name: 'Century 21 Food SA', contact: '', address: 'Rue Robert de Traz 7', address2: '', zip: '1206', city: 'Genève', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 171289, num: '171289', name: 'Restaurant du Centre Sportif', contact: 'Tennis Club', address: 'Route de Châtaigneriaz', address2: '', zip: '1297', city: 'Founex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 171392, num: '171392', name: 'Roland Petit', contact: 'Restaurant Le Cerf', address: 'Rue Antoine-Saladin 2', address2: '', zip: '1299', city: 'Crans-près-Céligny', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 173160, num: '173160', name: 'Laurence Mennet', contact: 'Restaurant Château Martheray', address: 'Rue de l\'Eglise 2', address2: '', zip: '1268', city: 'Begnins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 173161, num: '173161', name: 'Michel et Viviane Rapp', contact: 'Restaurant Château de Prangins', address: '', address2: '', zip: '1197', city: 'Prangins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 173394, num: '173394', name: 'Chez Fred', contact: 'M. Triani', address: 'Rue de St-Jean 30', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 176514, num: '176514', name: 'André Clerc SA', contact: '', address: 'Avenue Cardinal-Journet 13', address2: '', zip: '1217', city: 'Meyrin', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 178828, num: '178828', name: 'CODEBEL SA', contact: 'Joseph Debelder', address: 'Place Bel-Air 8', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 178854, num: '178854', name: 'Brigitte et Philippe Wyssen', contact: 'Auberge Au Coeur de la Côte', address: '', address2: '', zip: '1185', city: 'Mont-sur-Rolle', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 179036, num: '179036', name: 'Colonie St-Gervais', contact: '', address: 'Au Bucley', address2: '', zip: '1278', city: 'La Rippe', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 179062, num: '179062', name: 'Commune de Crassier', contact: '', address: 'Rue de la Tour 3', address2: '', zip: '1263', city: 'Crassier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 179088, num: '179088', name: 'Confiserie Anne & David', contact: '', address: 'Rue du Pont-Levis 20', address2: '', zip: '1162', city: 'St-Prex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 179089, num: '179089', name: 'Confiserie Buet', contact: '', address: 'Grand st-jean 6', address2: '', zip: '1003', city: 'Lausanne', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 179090, num: '179090', name: 'Confiserie Rougemont', contact: '', address: 'Rue St-Jean 24', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 179192, num: '179192', name: 'Corema Frozen Sea Foods SA', contact: '', address: '5 Chemin des Chalets', address2: '', zip: '1279', city: 'Chavannes-de-Bogis', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 181454, num: '181454', name: 'Bagnoud', contact: 'Pizzeria La Croix-Verte', address: 'Rue Perdtemps 7', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 181455, num: '181455', name: 'Christine et Claude Matthey', contact: 'Restaurant La Ferme', address: 'Rue des Coteaux 29', address2: '', zip: '2016', city: 'Cortaillod', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 181456, num: '181456', name: 'Crottet', contact: 'Gaëlle', address: 'Avenue Ruchonnet 20', address2: '', zip: '1003', city: 'Lausanne', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 181457, num: '181457', name: 'Sophie Conan', contact: 'Restaurant La Croix-Verte', address: '', address2: '', zip: '1267', city: 'Vich', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 183534, num: '183534', name: 'Jean-Louis Cuendet', contact: '', address: 'Rue St-Jean 30', address2: '', zip: '1260', city: 'Nyon 1', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 183535, num: '183535', name: 'Boulangerie Le Mylord', contact: '', address: 'Rue de la Gare 39', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 183536, num: '183536', name: 'Boulangerie Clémenty', contact: '', address: 'Route de Clémenty 62', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 183537, num: '183537', name: 'Boulangerie Les Brioches', contact: '', address: 'Centre commercial La Combe', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 183538, num: '183538', name: 'Boulangerie de St-Jean', contact: 'M. Jean-Louis Cuendet', address: 'Rue de St-Jean 30', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 187356, num: '187356', name: 'Rivenside Restaurants Sàrl', contact: 'Le Débarcadère', address: 'Rue de Rive 34', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 191568, num: '191568', name: 'Dana Club S.A.', contact: 'M. Frédéric', address: 'Rue de la Paix 1', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 194376, num: '194376', name: 'Marc Deblue', contact: 'Boucherie', address: 'Rue de la Gare 22', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 194636, num: '194636', name: 'Serge Lecomte', contact: 'Delta Viande', address: 'La Bichette', address2: '', zip: '1267', city: 'Vich', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 194637, num: '194637', name: 'Delmeer Sisseln', contact: '', address: 'Rütistrasse 26', address2: '', zip: '4334', city: 'Sisseln AG', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 194792, num: '194792', name: 'Deriaz S.A.', contact: 'Fabrice Deriaz', address: 'Route d\'Yverdon 19', address2: '', zip: '1028', city: 'Préverenges', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 202176, num: '202176', name: 'Dobrski', contact: 'Astrid', address: 'Rue de Condemines 13', address2: '', zip: '1951', city: 'Sion', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 206882, num: '206882', name: 'Duc Transport', contact: '', address: '', address2: '', zip: '1680', city: 'Romont FR', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 216710, num: '216710', name: 'Elisabeth Luder', contact: 'Restaurant L\'Ecusson Vaudois', address: '', address2: '', zip: '1262', city: 'Eysins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 219466, num: '219466', name: 'Eggli', contact: 'Christophe et Francis', address: 'Chemin de la Chapelle', address2: '', zip: '1264', city: 'St-Cergue', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 224458, num: '224458', name: 'Bernard Suttra', contact: 'E.M.S Bellevue', address: 'Route de Burtigny 11', address2: '', zip: '1268', city: 'Begnins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 226538, num: '226538', name: 'Epicerie campagnarde', contact: 'Junod', address: 'Vieux Village 6', address2: '', zip: '1266', city: 'Duillier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 226540, num: '226540', name: 'Epicerie chez Dom\'', contact: 'Vert', address: 'Rue du Village 32', address2: '', zip: '1295', city: 'Mies', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 226541, num: '226541', name: 'Epicerie de Chavannes', contact: '', address: 'Route de Bogis-Bossey 18', address2: '', zip: '1279', city: 'Chavannes-de-Bogis', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 226542, num: '226542', name: 'Epicerie de Genolier', contact: 'M. Gerber', address: 'Route de la Cézille 2', address2: '', zip: '1272', city: 'Genolier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 226543, num: '226543', name: 'Epicerie de la Fontaine', contact: 'M. Da Silva', address: 'Chemin du Carroz 11', address2: '', zip: '1169', city: 'Yens', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 226544, num: '226544', name: 'Epicerie de Le Muids', contact: 'Mme Ruffet', address: 'Ch. de la Petoliière', address2: '', zip: '1273', city: 'Le Muids', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 226545, num: '226545', name: 'Epicerie de Marchissy', contact: 'Mme Ilic', address: 'Pré-Baron', address2: '', zip: '1261', city: 'Marchissy', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 226546, num: '226546', name: 'Epicerie de Prangins', contact: 'M. Clivaz', address: 'La Place 2', address2: '', zip: '1197', city: 'Prangins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 226547, num: '226547', name: 'Epicerie du Marché', contact: '', address: 'Grand-Rue 59', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 226548, num: '226548', name: 'Epicerie Tea-Room', contact: 'M. Illic', address: 'Route de l\'Etraz', address2: '', zip: '1184', city: 'Luins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 226549, num: '226549', name: 'La Sauge', contact: 'M. Blanc', address: 'Place de la St-Jaques 3', address2: '', zip: '1163', city: 'Etoy', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 226550, num: '226550', name: 'Le Marché des Corbeaux', contact: '', address: 'Rue du Grand-Pré 23', address2: '', zip: '1299', city: 'Crans-près-Céligny', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 238550, num: '238550', name: 'Faupel SA', contact: '', address: 'Centre commercial', address2: '', zip: '1163', city: 'Etoy', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 239486, num: '239486', name: 'FC G.Begnins', contact: 'Loto', address: 'Case postale 126', address2: '', zip: '1278', city: 'La Rippe', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 244348, num: '244348', name: 'Lehnher SA', contact: '', address: 'Chapon des Prés 18', address2: '', zip: '2022', city: 'Bevaix', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 244738, num: '244738', name: 'Fishermen\'s Pub', contact: '', address: 'Rue de Rive 37', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 246636, num: '246636', name: 'Binggeli Frères SA', contact: 'François et Laurent Binggeli', address: 'En Budron A1', address2: '', zip: '1052', city: 'Mont-sur-Lausanne', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 261872, num: '261872', name: 'Garage de l\'Autoroute', contact: 'Bottone Ch.', address: 'Rue des Fléchères', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 261898, num: '261898', name: 'Covedis SA', contact: '', address: 'Rue des Ronquoz 39', address2: '', zip: '1950', city: 'Sion', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 261950, num: '261950', name: 'Gilbert Gauthier', contact: 'Import. spécialité alimentaire', address: 'Rue du Pavement 13', address2: '', zip: '1530', city: 'Payerne', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 267956, num: '267956', name: 'Au Poissonnier', contact: 'Ch. Gilliéron', address: 'Route de Fey 2', address2: '', zip: '1418', city: 'Vuarrens', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 272688, num: '272688', name: 'Olivier Goncerut', contact: 'Boucherie', address: 'Place St-Martin 9', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 274690, num: '274690', name: 'Graziano', contact: 'Epicerie-Laiterie', address: 'Route de Genève 10', address2: '', zip: '1263', city: 'Crassier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 274692, num: '274692', name: 'Boucherie Chez Philou', contact: 'Philippe Grange', address: 'Grand-Rue', address2: '', zip: '1268', city: 'Begnins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 274898, num: '274898', name: 'GRIMM, Centre Opel', contact: '', address: 'Avenue des Morgines 26', address2: '', zip: '1213', city: 'Petit-Lancy', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 277238, num: '277238', name: 'Aurore et Serge Nuara', contact: 'Hostellerie Le Guillaume-Tell', address: 'Route de Divonne 10', address2: '', zip: '1291', city: 'Commugny', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 281424, num: '281424', name: 'Hôtel de Ville et du Rivage', contact: '', address: 'Rue du Rivage', address2: '', zip: '1095', city: 'Lutry', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 291226, num: '291226', name: 'Higueras', contact: 'Photo Signy', address: 'Centre commercial', address2: '', zip: '1274', city: 'Signy', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 296140, num: '296140', name: 'Hôpital psychiatrique', contact: '', address: '', address2: '', zip: '1197', city: 'Prangins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 296141, num: '296141', name: 'GHOL/ Hôpital de Nyon', contact: 'Cuisine M.Hybois', address: 'Chemin Monastier 10', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 296142, num: '296142', name: 'Hôpital de Rolle', contact: '', address: '26, route de l\'Hôpital', address2: '', zip: '1180', city: 'Rolle', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 296218, num: '296218', name: 'Macrysta SA', contact: 'Hostellerie Le XVIème Siècle', address: '', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 303576, num: '303576', name: 'Régis Hybois', contact: '', address: 'Route des Amoureux 3b', address2: '', zip: '1341', city: 'L\' Orient', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 318838, num: '318838', name: 'Institut Oecuménique', contact: 'Département Hôtellerie', address: 'Château Bossey', address2: '', zip: '1298', city: 'Céligny', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 332046, num: '332046', name: 'Eric Jaques', contact: 'Bijouterie', address: 'Rue St-Jean 34', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 335062, num: '335062', name: 'Gilbert Jemmely et fils', contact: 'Boucherie', address: 'Rue du Collège 11', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 335088, num: '335088', name: 'Michel Jenny', contact: 'NZZ Suisse Romande', address: 'Chemin de Closel 1A', address2: '', zip: '2035', city: 'Corcelles NE', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 366132, num: '366132', name: 'Kohler', contact: 'Catherine', address: 'Rue Pierre-Péquignat 5', address2: '', zip: '2950', city: 'Courgenay', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 374426, num: '374426', name: 'Rivenside Restaurants Sàrl', contact: 'Le Léman', address: 'Rue de Rive 28', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 376974, num: '376974', name: 'Pierre-André et Ninik Michoud', contact: 'Restaurant L\'Ecusson Vaudois', address: 'Rue de la Plaine 29', address2: '', zip: '1400', city: 'Yverdon-les-Bains', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 377390, num: '377390', name: 'Auberge des Santolines', contact: 'Famille Isler-Naudy', address: 'Rue des Artisans 20', address2: '', zip: '1299', city: 'Crans-près-Céligny', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 378326, num: '378326', name: 'Alain Broggi', contact: 'Restaurant La Couronne', address: '', address2: '', zip: '1269', city: 'Bassins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 378327, num: '378327', name: 'Monique Wicht', contact: 'Restaurant La Cayenne', address: 'Chemin du Ruttet 5', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 378328, num: '378328', name: 'Pascal Penel', contact: 'Auberge Communale La Couronne', address: 'Route de Crassier', address2: '', zip: '1275', city: 'Chéserex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 378329, num: '378329', name: 'Michèle et Alain Maitrias', contact: 'La Bonbonnière', address: 'Place de la Gare 5', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 378330, num: '378330', name: 'Office Pénitencière', contact: 'La Clairière', address: 'Route de Satigny 27', address2: '', zip: '1214', city: 'Vernier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 378332, num: '378332', name: 'La P\'tite Fringale', contact: 'M. Brulhart', address: 'Route de Genève 101', address2: '', zip: '1026', city: 'Denges', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 378482, num: '378482', name: 'Lacpro Sàrl', contact: '', address: 'Grand-Rue 31', address2: '', zip: '1462', city: 'Yvonand', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 378950, num: '378950', name: 'Laurencet', contact: 'France', address: 'Avenue Cardinal-Mermillod 36', address2: '', zip: '1227', city: 'Carouge GE', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381446, num: '381446', name: 'Jacques Gay', contact: 'Restaurant Le Point du Jour', address: 'Route de Nyon', address2: '', zip: '1264', city: 'St-Cergue', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381447, num: '381447', name: 'Antonio Di Palma', contact: 'Restaurant Le Parc', address: 'Grand-Rue 12', address2: '', zip: '1180', city: 'Rolle', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381448, num: '381448', name: 'Robert Davet', contact: 'Restaurant Le Jura', address: '', address2: '', zip: '1264', city: 'St-Cergue', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381449, num: '381449', name: 'Verena Imfeld', contact: 'Restaurant Le Relais Fleuri', address: 'Grand\'Rue', address2: '', zip: '1262', city: 'Eysins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381450, num: '381450', name: 'Giovanni et Annelyse Perito', contact: 'Restaurant Le Relais', address: 'Route de Bogis-Bossey 35', address2: '', zip: '1279', city: 'Chavannes-de-Bogis', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381451, num: '381451', name: 'D. Pene et V. Nyffeler', contact: 'Restaurant Le Grenier', address: 'Route de Divonne 4', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381452, num: '381452', name: 'René Sinner et fils', contact: 'Restaurant Le Parc', address: 'Route de l\'Etraz 52', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381453, num: '381453', name: 'Restaurant Le Boeuf Rouge', contact: 'Dara Sàrl', address: '', address2: '', zip: '1263', city: 'Crassier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381454, num: '381454', name: 'Gary Kuster', contact: 'Restaurant Le Relais du Vin', address: 'G.L.R.V Sàrl', address2: '', zip: '1268', city: 'Begnins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381455, num: '381455', name: 'André Boiret', contact: 'Restaurant Le Jeanne D\'Arc', address: 'Crans Montana', address2: '', zip: '3962', city: 'Montana-Vermala', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381456, num: '381456', name: 'R.M.Dos Santos Carvalho', contact: 'Restaurant Le Débarcardère', address: 'Rue de Rive 34', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381457, num: '381457', name: 'Terez Nemeth', contact: 'Restaurant Le Paprika', address: 'Chemin du Ruttet 5', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381458, num: '381458', name: 'Le Neptune', contact: '', address: 'Rue de Rive 22', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381940, num: '381940', name: 'Le P\'tit Magasin', contact: '', address: 'Grand-Rue', address2: '', zip: '1188', city: 'Gimel', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 381992, num: '381992', name: 'Lerch', contact: 'Willy', address: 'Rue du Bugnon 4', address2: '', zip: '1299', city: 'Crans-près-Céligny', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 382018, num: '382018', name: 'Philippe Lapalud', contact: 'Restaurant Les Glycines', address: 'Chemin des Plantaz 56', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 382019, num: '382019', name: 'Attilio Abbati', contact: 'Pizzeria Les Fontaines', address: 'Chemin d\'Eysins 45 A', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 382020, num: '382020', name: 'Restaurant Les Abériaux', contact: 'Pareja Sàrl', address: 'Route de Lausanne', address2: '', zip: '1197', city: 'Prangins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 382021, num: '382021', name: 'Marcel Neuffer', contact: 'Restaurant Les Trois Suisses', address: 'Route de Coinsins', address2: '', zip: '1272', city: 'Genolier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 382022, num: '382022', name: 'José et Ivana Rodrigues', contact: 'Restaurant Les Platanes', address: '', address2: '', zip: '1275', city: 'Chéserex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 382023, num: '382023', name: 'Brahim Yuber', contact: 'Restaurant Le Mirabeau', address: 'Route d\'Arzier', address2: '', zip: '1264', city: 'St-Cergue', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 382024, num: '382024', name: 'Restaurant Les Cytises', contact: '', address: 'Rue de la Gare 70', address2: '', zip: '1264', city: 'St-Cergue', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 382025, num: '382025', name: 'Restaurant Les Gravines', contact: '', address: 'Route de l\'Etraz 144', address2: '', zip: '1290', city: 'Richelien', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 389844, num: '389844', name: 'Loto Salle Communale Crans', contact: 'p.adr. M. Guex Bernard', address: '', address2: '', zip: '1262', city: 'Eysins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 389846, num: '389846', name: 'Loto', contact: '', address: '', address2: '', zip: '1276', city: 'Gingins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 391846, num: '391846', name: 'LRG LOGISTICS SA', contact: '', address: '6, chemin des Aulx', address2: '', zip: '1228', city: 'Plan-les-Ouates', phone: '', mobile: '', email: '', credit: 6000, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 401986, num: '401986', name: 'Marie-Thérèse Magnin', contact: 'Boulangerie Epicerie', address: '', address2: '', zip: '1271', city: 'Givrins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 402272, num: '402272', name: 'Arnold Marti', contact: 'Boulangerie', address: 'Place du Marché 8', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 402273, num: '402273', name: 'Marmier', contact: 'Muriel', address: 'Avenue de la Dent-d\'Oche 2', address2: '', zip: '1007', city: 'Lausanne', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 402274, num: '402274', name: 'Marguerite Ramel', contact: 'Epicerie', address: '', address2: '', zip: '1261', city: 'Le Muids', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 402276, num: '402276', name: 'Marché Flag Aubonne Sàrl', contact: 'Ramel-Saudan', address: 'Rue des Fosses Dessous 21', address2: '', zip: '1170', city: 'Aubonne', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 402277, num: '402277', name: 'Marmorat', contact: 'Yves', address: 'Chemin du Nipy', address2: '', zip: '1262', city: 'Eysins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 405340, num: '405340', name: 'Mep SA', contact: '', address: 'Case postale 87', address2: '', zip: '1279', city: 'Chavannes-de-Bogis', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 408122, num: '408122', name: 'Boulangerie Rapp', contact: 'Tea-Room', address: 'Avenue du Mont-Blanc 10', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 413088, num: '413088', name: 'Patric Monney', contact: 'Boucherie', address: 'Au Village 5', address2: '', zip: '1277', city: 'Borex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 413270, num: '413270', name: 'Marc Cornaz', contact: 'Restaurant Le Moulin', address: 'La Cézille', address2: '', zip: '1268', city: 'Begnins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 425724, num: '425724', name: 'Natalini SA', contact: '', address: 'Route de Nyon', address2: '', zip: '1264', city: 'St-Cergue', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 460824, num: '460824', name: 'Optic 2000', contact: 'Jérôme Martin', address: '', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 461890, num: '461890', name: 'Restaurant', contact: 'L\'Orange Mécanique', address: 'Famille Artero', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 461968, num: '461968', name: 'Pierre Leuba', contact: 'Maison Ordis', address: 'Chemin des Mûriers 7', address2: '', zip: '1350', city: 'Orbe', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 465374, num: '465374', name: 'Ovostar', contact: '', address: 'En Budron B10', address2: '', zip: '1052', city: 'Mont-sur-Lausanne', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 472212, num: '472212', name: 'Patrick Pahud', contact: 'Netcorner', address: 'Chemin de la Tuilière 14', address2: '', zip: '1197', city: 'Prangins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 472316, num: '472316', name: 'Paléo Arts & Spectacles', contact: '\'\'\'La Touche\'\' Coordination N&B\'', address: 'Route de Saint-Cergue 312', address2: '', zip: '1260', city: 'Nyon 1', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 472317, num: '472317', name: 'Paléo Festival', contact: 'Le Fin Bec', address: '', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 472318, num: '472318', name: 'Paléo Arts & Spectacles', contact: '\'Les Artistes\'\' Coordination N&B\'', address: 'Route de Saint-Cergue 312', address2: '', zip: '1260', city: 'Nyon 1', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 472319, num: '472319', name: 'Paléo Arts & Spectacles', contact: '\'\'\'La Ferme\'\' Coordination N&B\'', address: 'Route de Saint-Cergue 312', address2: '', zip: '1260', city: 'Nyon 1', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 472321, num: '472321', name: 'Paléo Festival Nyon', contact: 'Magasin des Restaurants', address: 'M. Lhopiteau Hervé', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 472446, num: '472446', name: 'Paquier Frères', contact: '', address: 'Chemin des Vignes 8', address2: '', zip: '1165', city: 'Allaman', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 472524, num: '472524', name: 'Pâtissier-Chocolatier', contact: 'Moret', address: 'Rue du Temple 5', address2: '', zip: '1180', city: 'Rolle', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 475592, num: '475592', name: 'Pernet Comestible SA', contact: '', address: 'Chemin de la Navigation 4', address2: '', zip: '1180', city: 'Rolle', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 475594, num: '475594', name: 'Perches Import S.A.', contact: '', address: 'Chemin du Lavasson 12B', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 475644, num: '475644', name: 'Roland Rosé', contact: 'Les Petits Pêcheurs', address: '', address2: '', zip: '1180', city: 'Rolle', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 475645, num: '475645', name: 'Restaurant Pizzeria', contact: 'Le Petit Moulin', address: '', address2: '', zip: '1274', city: 'Grens', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 476138, num: '476138', name: 'Pfizer AG', contact: 'Mme Antonella Emmenegger', address: 'Schärenmoosstrasse 99', address2: '', zip: '8052', city: 'Zürich', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 477490, num: '477490', name: 'Pharmacia', contact: 'Pharmacia et Upjohn AG', address: 'Lagerstrasse 14', address2: '', zip: '8600', city: 'Dübendorf', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 478920, num: '478920', name: 'Jean-Philippe et Alain Genoud', contact: 'Pizzeria Romana', address: 'Place de la Gare 7', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 478921, num: '478921', name: 'Pizzeria du Bowling', contact: 'ER-Rais Javad Hassan', address: 'Avenue du Mont-Blanc 38', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 483158, num: '483158', name: 'Poisson Claude', contact: '', address: 'Rue Cordey 30', address2: '', zip: '1400', city: 'Yverdon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 483470, num: '483470', name: 'Pouly Tradition SA', contact: '', address: 'Rue Pré-Bouvier 31', address2: '', zip: '1242', city: 'Satigny', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 485654, num: '485654', name: 'Provic SA', contact: '', address: 'Route de Nyon 2 A', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 485655, num: '485655', name: 'Produlac SA', contact: '', address: '', address2: '', zip: '1429', city: 'Giez', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 485656, num: '485656', name: 'Promenthoux Plage', contact: 'Restaurant', address: '', address2: '', zip: '1197', city: 'Prangins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 522418, num: '522418', name: 'André Trunz', contact: 'Restaurant Tea-Room Prédérès', address: 'Le Martinet K', address2: '', zip: '1276', city: 'Gingins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 522419, num: '522419', name: 'Santiago Wegmann', contact: 'Restaurant Le Latino', address: 'Rue de Rive 13', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 522420, num: '522420', name: 'Le Perdtemps SA', contact: 'Hôtel-Restaurant', address: 'Avenue Viollier 1', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 522421, num: '522421', name: 'Restaurant de Colovray', contact: '', address: 'Route de Genève 37', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 522422, num: '522422', name: 'Restaurant L\'Aérodrome', contact: 'GALP Sàrl', address: '', address2: '', zip: '1197', city: 'Prangins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 525122, num: '525122', name: 'Richard', contact: 'Claude', address: '', address2: '', zip: '1267', city: 'Vich', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 525538, num: '525538', name: 'Gérard Risse', contact: 'Boucherie', address: 'Avenue du Mont-Blanc 8', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 530062, num: '530062', name: 'Maison Romero', contact: '', address: '', address2: '', zip: '1462', city: 'Yvonand', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 542724, num: '542724', name: 'Satisfaction SA', contact: '', address: 'Chemin de la Fontaine', address2: '', zip: '1260', city: 'Nyon 1', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 542776, num: '542776', name: 'Manuel Ernst', contact: 'Saveurs et Couleurs', address: '', address2: '', zip: '1000', city: 'Lausanne 20', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 542777, num: '542777', name: 'Saveur 2000 Sàrl', contact: '', address: 'Route de Vernier 94', address2: '', zip: '1219', city: 'Châtelaine', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 543972, num: '543972', name: 'Scheibler AG', contact: '', address: 'Ribigasse 1', address2: '', zip: '4434', city: 'Hölstein', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 545792, num: '545792', name: 'Antonio Serra', contact: '', address: 'Rue du Port 40', address2: '', zip: '1815', city: 'Clarens', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 553202, num: '553202', name: 'Société de Développement', contact: 'Claude SCHWARZENTRUB', address: 'Route de Tranchepied 21', address2: '', zip: '1277', city: 'Borex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 553203, num: '553203', name: '\'Sociétés locales \'\'Loto\'\'\'', contact: 'Philippe Boulenaz', address: '', address2: '', zip: '1263', city: 'Crassier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 553205, num: '553205', name: 'Société d\'animation de Luins', contact: 'M. Bachofen', address: '', address2: '', zip: '1184', city: 'Luins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 553436, num: '553436', name: 'Jean-Michel Colin', contact: 'Restaurant Le Soleil', address: '', address2: '', zip: '1183', city: 'Bursins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 557050, num: '557050', name: 'Staménovic', contact: '', address: 'Avenue Dumas 22', address2: '', zip: '1206', city: 'Genève', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 557052, num: '557052', name: 'Station Migrol', contact: 'M. Affolter', address: 'Route Suisse', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 559052, num: '559052', name: 'SVR Food SA', contact: '', address: 'Chemin de l\'Esparcette 5', address2: '', zip: '1023', city: 'Crissier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 568802, num: '568802', name: 'Techfroid SA', contact: '', address: 'Les Landes 44 B', address2: '', zip: '1299', city: 'Crans-près-Céligny', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 569088, num: '569088', name: 'Restaurant Tennis Club', contact: '', address: 'Avenue de Bois-Bougy', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 569218, num: '569218', name: 'Client test', contact: '', address: 'Rue de la Poste 55', address2: '', zip: '1242', city: 'Satigny', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 570960, num: '570960', name: 'Tea-Room La Théière', contact: '', address: 'Rue de Malagny 14-16', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 571194, num: '571194', name: 'Thely', contact: 'Elisabeth', address: 'Chemin du Mont-Blanc 26', address2: '', zip: '1170', city: 'Aubonne', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 572338, num: '572338', name: 'André Tissot', contact: 'Boucherie', address: 'Rue de la Gare 16', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 572416, num: '572416', name: 'Charles-Emile Ramel', contact: 'Restaurant Le Tivoli', address: '', address2: '', zip: '1261', city: 'Le Muids', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 578890, num: '578890', name: 'Traiteur', contact: 'Paul Mayr', address: 'Chemin Monastier 15', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 603356, num: '603356', name: 'USLG', contact: 'M. Bachofen', address: '', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 612716, num: '612716', name: 'Valette', contact: '', address: '', address2: '', zip: '1296', city: 'Coppet', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641914, num: '641914', name: 'Whyte', contact: 'Alisdair', address: 'Chalet Temara', address2: '', zip: '1884', city: 'Villars-sur-Ollon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641915, num: '641915', name: 'TM2', contact: 'Margaux', address: '', address2: '', zip: '1268', city: 'Begnins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641917, num: '641917', name: 'Restaurant Quai 23', contact: 'Mme Padovano Nicole', address: 'Rue de Rive 23', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641918, num: '641918', name: 'Société de Tir', contact: '', address: 'Case postale 106', address2: '', zip: '1290', city: 'Versoix', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641919, num: '641919', name: 'DOLD AG', contact: '', address: 'Hertistrasse 4', address2: '', zip: '8304', city: 'Wallisellen', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641920, num: '641920', name: 'CAVE SA', contact: '', address: 'Rue de Malagny 28', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641921, num: '641921', name: 'Restaurant du Lac', contact: 'Michaux SARL', address: 'Quai de Versoix 1', address2: '', zip: '1290', city: 'Versoix', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641922, num: '641922', name: 'Le Rosey SA/Section filles', contact: 'Pensionnat privé', address: 'Château du Rosey', address2: '', zip: '1180', city: 'Rolle', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641923, num: '641923', name: 'Le Rosey SA/Section garçons', contact: 'Pensionnat privé', address: 'Château du Rosey', address2: '', zip: '1180', city: 'Rolle', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641924, num: '641924', name: 'Le Rosey SA', contact: 'Pensionnat privé', address: 'Département comptabilité', address2: '', zip: '1180', city: 'Rolle', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641925, num: '641925', name: 'Coigny', contact: '', address: '', address2: '', zip: '1273', city: 'Le Muids', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641926, num: '641926', name: 'Nordtin', contact: 'Marguerite', address: '', address2: '', zip: '3963', city: 'Crans-Montana', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641927, num: '641927', name: 'Petits Pêcheurs', contact: 'M. Olivier Guignet', address: 'Route de l\'Etraz', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641928, num: '641928', name: 'Stünkel Immobilier', contact: '', address: 'Route de Nyon', address2: '', zip: '1264', city: 'St-Cergue', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641929, num: '641929', name: 'Rossborough', contact: 'Odette', address: '', address2: '', zip: '1201', city: 'Genève', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641930, num: '641930', name: 'Boutique  Dali-baba', contact: 'Laboratoire, service traiteur', address: 'Rue des Alpes 6', address2: '', zip: '1197', city: 'Prangins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641931, num: '641931', name: 'Boulangerie Joly', contact: '', address: 'Chemin du Lavasson 37-39', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641932, num: '641932', name: 'Magasin Mille et une fleurs', contact: '', address: '', address2: '', zip: '1263', city: 'Crassier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641933, num: '641933', name: 'Chocolaterie Pâtisserie', contact: 'M. Alexandre Urfer', address: 'Rue du Pont-Levis 20', address2: '', zip: '1162', city: 'St-Prex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641934, num: '641934', name: 'Clos des Sapins', contact: 'M.Strobino', address: 'Chemin du Clos des Sapins 2-4', address2: '', zip: '1264', city: 'St-Cergue', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641935, num: '641935', name: 'Station Avia', contact: 'Fléchère Services Sàrl', address: 'D.Nickl et F.Dessaux', address2: '', zip: '1274', city: 'Signy', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641936, num: '641936', name: 'Boulangerie Rapp', contact: 'Festival Caribana', address: 'Avenue du Mont-Blanc 10', address2: '', zip: '1196', city: 'Gland', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641937, num: '641937', name: 'Artemis Café', contact: 'Officium SA', address: 'Rue de la Gare 4', address2: '', zip: '2034', city: 'Peseux', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641938, num: '641938', name: 'L\'After', contact: 'Le relais du vin', address: 'Rue de Rive 22', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641940, num: '641940', name: 'Boulangerie Ruckstuhl', contact: '', address: 'Cité Vieusseux 9', address2: '', zip: '1203', city: 'Genève', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641941, num: '641941', name: 'RMC', contact: 'Moulin à Vin', address: 'Ruelle des Moulins 1', address2: '', zip: '1260', city: 'Nyon', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641942, num: '641942', name: 'Serra Poissons Frais', contact: '', address: 'Rue du Port 40', address2: '', zip: '1815', city: 'Clarens', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641943, num: '641943', name: 'Pêcherie d\'Estavayer', contact: 'Schmid SA', address: 'Champ de la Vigne 7', address2: '', zip: '1470', city: 'Estavayer-le-Lac', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641944, num: '641944', name: 'Vivadis', contact: '', address: 'Chemin des Aulx 6', address2: '', zip: '1228', city: 'Plan-les-Ouates', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641945, num: '641945', name: 'Vivadis SA', contact: '', address: 'Case postale 1055', address2: '', zip: '1211', city: 'Genève 26', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641946, num: '641946', name: 'DIANE Comestible', contact: 'Mme Andrey', address: 'Rue du Jura 20', address2: '', zip: '1373', city: 'Chavornay', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641947, num: '641947', name: 'MA CARTIER SA', contact: '', address: 'Route de l\'Etraz 126', address2: '', zip: '1290', city: 'Versoix', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641948, num: '641948', name: 'Confiserie Tea-Room', contact: 'Christian Boillat Sàrl', address: 'Rue de la Gare 1', address2: '', zip: '1162', city: 'St-Prex', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641949, num: '641949', name: 'EMS Les Franchises', contact: '', address: 'Cité-Vieusseux 10', address2: '', zip: '1203', city: 'Genève', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641950, num: '641950', name: 'Hybois', contact: 'Régis', address: 'Chemin des Amoureux 3 B', address2: '', zip: '1341', city: 'Orient', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641951, num: '641951', name: 'Boucherie Droux & Fils', contact: '', address: 'Grand-Rue 13', address2: '', zip: '1470', city: 'Estavayer-le-Lac', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641952, num: '641952', name: 'Gleisberg', contact: 'Gerd', address: 'Chemin du Suchet 2B', address2: '', zip: '1350', city: 'Orbe', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 641953, num: '641953', name: 'Eric Charrière SA', contact: '', address: 'Route de La Rippe 23', address2: '', zip: '1263', city: 'Crassier', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 999501, num: '999501', name: 'Auberge de la Poste', contact: '', address: 'Route de Chéserex 10', address2: '', zip: '1276', city: 'Gingins', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 999502, num: '999502', name: 'Confiserie Fornerod', contact: '', address: 'Grand-Rue 58', address2: '', zip: '1110', city: 'Morges', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] },
    { id: 999503, num: '999503', name: 'DPPS', contact: 'Centre Subsistance CIA', address: 'Caserne 1940-50', address2: '', zip: '1145', city: 'Bière Caserne', phone: '', mobile: '', email: '', credit: 0, payment: '30 jours fin de mois', ordersCount: 0, history: [] }
];
            // Ajouter clientType b2b (professionnel) par défaut à tous les clients
            QOData.clients.forEach(c => { if (!c.clientType) c.clientType = 'b2b'; });
            saveQOData('clients');

        }

        // Obtenir le prix selon le type de client
        function getQOProductPrice(product, clientType) {
            if (clientType === 'b2c') {
                return product.priceB2C || product.price || 0;
            } else {
                // B2B - si pas de prix B2B, utiliser B2C avec remise 20%
                return product.priceB2B || (product.priceB2C ? product.priceB2C * 0.8 : product.price || 0);
            }
        }

        function saveQOData(type) {
            localStorage.setItem('qo_' + type, JSON.stringify(QOData[type]));
            // Sync automatique vers Dropbox si activé
            if (DropboxConfig.autoSync && DropboxConfig.connected && !DropboxSync.isSyncing) {
                syncToDropbox(type);
            }
        }

        // Client Search - mise à jour pour nouvelle structure
        function searchQOClients(query) {
            const resultsDiv = document.getElementById('qo-client-results');
            if (query.length < 2) { resultsDiv.style.display = 'none'; return; }

            const q = query.toLowerCase();
            // Filtrer uniquement les clients B2B pour la prise de commande
            const matches = QOData.clients.filter(c =>
                (c.clientType === 'b2b' || !c.clientType) && // B2B uniquement (ou anciens clients sans type)
                (c.name.toLowerCase().includes(q) ||
                (c.contact && c.contact.toLowerCase().includes(q)) ||
                (c.phone && c.phone.includes(q)) ||
                (c.mobile && c.mobile.includes(q)) ||
                (c.city && c.city.toLowerCase().includes(q)) ||
                (c.num && c.num.includes(q)))
            ).slice(0, 15);

            if (matches.length === 0) {
                resultsDiv.innerHTML = '<div style="padding:16px; color:var(--text-muted); text-align:center;">Aucun client B2B trouvé</div>';
            } else {
                resultsDiv.innerHTML = matches.map(c => {
                    // Afficher la liste de prix si définie
                    const priceList = c.pricelistId ? ArticlesData.priceLists?.find(p => p.id === c.pricelistId) : null;
                    const priceListLabel = priceList ? `<span style="color:var(--accent-warning); font-size:11px;">💰 ${priceList.name}</span>` : '';

                    return `
                    <div onclick="selectQOClient(${c.id})" style="padding:16px; border-bottom:1px solid var(--border-color); cursor:pointer; transition:background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <strong style="font-size:16px;">${c.name}</strong>
                                ${c.contact ? `<span style="color:var(--accent-secondary); margin-left:8px; font-size:13px;">${c.contact}</span>` : ''}
                                <span style="margin-left:8px; padding:2px 6px; background:var(--accent-secondary)20; color:var(--accent-secondary); border-radius:4px; font-size:10px;">B2B</span>
                                <div style="font-size:13px; color:var(--text-muted); margin-top:4px;">${c.city || ''} ${c.phone || c.mobile ? '• ' + (c.phone || c.mobile) : ''}</div>
                                ${priceListLabel}
                            </div>
                            <div style="text-align:right;">
                                <span style="font-size:11px; color:var(--accent-orange);">#${c.num || c.id}</span>
                                <div style="font-size:11px; color:var(--text-muted);">${c.ordersCount || 0} cmd</div>
                            </div>
                        </div>
                    </div>
                `}).join('');
            }
            resultsDiv.style.display = 'block';
        }

        function selectQOClient(id) {
            const client = QOData.clients.find(c => c.id === id);
            if (!client) return;

            // Assurer que clientType existe
            if (!client.clientType) client.clientType = 'b2b';

            QOData.selectedClient = client;
            document.getElementById('qo-client-search').value = '';
            document.getElementById('qo-client-results').style.display = 'none';

            const clientType = client.clientType || 'b2b';
            const typeLabel = clientType === 'b2c' ? '🏠 Particulier' : '🏢 Professionnel';
            const typeColor = clientType === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)';

            // Afficher liste de prix si applicable
            const pricelist = client.pricelistId ? ArticlesData.pricelists?.find(p => p.id === client.pricelistId) : null;
            const pricelistBadge = pricelist ? `<span style="margin-left:6px;padding:3px 8px;border-radius:12px;font-size:11px;background:#ffd16620;color:#ffd166;">📋 ${pricelist.name}</span>` : '';

            document.getElementById('qo-client-name').innerHTML = `${client.name}${client.contact ? ` - ${client.contact}` : ''} <span onclick="toggleQOClientType()" style="cursor:pointer;margin-left:8px;padding:3px 8px;border-radius:12px;font-size:11px;background:${typeColor};color:#fff;" title="Cliquez pour changer">${typeLabel}</span>${pricelistBadge}`;
            document.getElementById('qo-client-phone').textContent = client.phone || client.mobile || '-';
            document.getElementById('qo-client-email').textContent = client.email || '-';
            document.getElementById('qo-client-orders-count').textContent = client.ordersCount || 0;

            document.getElementById('qo-selected-client').style.display = 'block';
            document.getElementById('qo-btn-next-step').style.display = 'inline-flex';
            document.getElementById('qo-new-client-form').style.display = 'none';

            // Mettre à jour l'affichage des paliers de rabais
            updateDiscountTiersDisplay();
        }

        function toggleQOClientType() {
            if (!QOData.selectedClient) return;
            QOData.selectedClient.clientType = QOData.selectedClient.clientType === 'b2c' ? 'b2b' : 'b2c';
            // Mettre à jour dans la liste des clients
            const idx = QOData.clients.findIndex(c => c.id === QOData.selectedClient.id);
            if (idx >= 0) {
                QOData.clients[idx].clientType = QOData.selectedClient.clientType;
                saveQOData('clients');
            }
            // Rafraîchir l'affichage
            selectQOClient(QOData.selectedClient.id);
            // Recalculer le panier avec les nouveaux prix
            recalculateQOCartPrices();
            // Mettre à jour l'affichage des rabais
            updateDiscountTiersDisplay();
        }

        function recalculateQOCartPrices() {
            const clientType = QOData.selectedClient?.clientType || 'b2b';
            QOData.cart.forEach(item => {
                const product = QOData.products.find(p => p.id === item.productId);
                if (product) {
                    item.price = getQOProductPrice(product, clientType);
                    item.total = item.qty * item.price;
                }
            });
            updateQOCart();
        }

        function clearQOClient() {
            QOData.selectedClient = null;
            document.getElementById('qo-selected-client').style.display = 'none';
            document.getElementById('qo-btn-next-step').style.display = 'none';
            document.getElementById('qo-client-search').focus();
            // Cacher les paliers de rabais
            updateDiscountTiersDisplay();
        }

        function showQONewClientForm() {
            document.getElementById('qo-new-client-form').style.display = 'block';
            // Reset form
            selectQOClientType('b2b');
            document.getElementById('qo-new-name').value = '';
            document.getElementById('qo-new-firstname').value = '';
            document.getElementById('qo-new-phone').value = '';
            document.getElementById('qo-new-mobile').value = '';
            document.getElementById('qo-new-email').value = '';
            document.getElementById('qo-new-company').value = '';
            document.getElementById('qo-new-address').value = '';
            document.getElementById('qo-new-zip').value = '';
            document.getElementById('qo-new-city').value = '';
            document.getElementById('qo-new-canton').value = 'VD';
            document.getElementById('qo-new-country').value = 'Suisse';
            // Populate pricelist dropdown
            const plSelect = document.getElementById('qo-new-pricelist');
            if (plSelect && typeof ArticlesData !== 'undefined') {
                plSelect.innerHTML = '<option value="">-- Standard --</option>' +
                    (ArticlesData.pricelists || []).map(p =>
                        `<option value="${p.id}">${p.name} (-${p.discount}%)</option>`
                    ).join('');
            }
        }
        function hideQONewClientForm() { document.getElementById('qo-new-client-form').style.display = 'none'; }

        function selectQOClientType(type) {
            const b2bDiv = document.getElementById('qo-type-b2b');
            const b2cDiv = document.getElementById('qo-type-b2c');

            if (type === 'b2b') {
                b2bDiv.style.background = 'var(--accent-secondary)';
                b2bDiv.style.color = '#fff';
                b2bDiv.style.border = 'none';
                b2cDiv.style.background = 'var(--bg-card)';
                b2cDiv.style.color = 'var(--text-muted)';
                b2cDiv.style.border = '2px solid var(--border-color)';
                document.querySelector('input[name="qo-new-type"][value="b2b"]').checked = true;
            } else {
                b2cDiv.style.background = 'var(--accent-warning)';
                b2cDiv.style.color = '#000';
                b2cDiv.style.border = 'none';
                b2bDiv.style.background = 'var(--bg-card)';
                b2bDiv.style.color = 'var(--text-muted)';
                b2bDiv.style.border = '2px solid var(--border-color)';
                document.querySelector('input[name="qo-new-type"][value="b2c"]').checked = true;
            }
        }

        function saveQONewClient() {
            const name = document.getElementById('qo-new-name').value.trim();
            const firstname = document.getElementById('qo-new-firstname').value.trim();
            const phone = document.getElementById('qo-new-phone').value.trim();
            const mobile = document.getElementById('qo-new-mobile').value.trim();
            const email = document.getElementById('qo-new-email').value.trim();
            const company = document.getElementById('qo-new-company').value.trim();
            const address = document.getElementById('qo-new-address').value.trim();
            const zip = document.getElementById('qo-new-zip').value.trim();
            const city = document.getElementById('qo-new-city').value.trim();
            const canton = document.getElementById('qo-new-canton').value;
            const country = document.getElementById('qo-new-country').value;
            const clientType = document.querySelector('input[name="qo-new-type"]:checked').value;
            const pricelistId = parseInt(document.getElementById('qo-new-pricelist').value) || null;

            // Validation
            if (!name) { alert('Le nom est requis'); return; }
            if (!phone) { alert('Le téléphone fixe est requis'); return; }
            if (!email) { alert('L\'email est requis'); return; }
            if (!address) { alert('L\'adresse est requise'); return; }
            if (!zip) { alert('Le NPA est requis'); return; }
            if (!city) { alert('La ville est requise'); return; }

            // Construire le nom complet
            const fullName = company || (firstname ? `${name} ${firstname}` : name);

            const newClient = {
                id: Date.now(),
                num: generateClientNumber(),
                name: fullName,
                contact: firstname ? `${firstname} ${name}` : '',
                clientType: clientType,
                address: address,
                address2: '',
                zip: zip,
                city: city,
                canton: canton,
                country: country,
                phone: phone,
                mobile: mobile,
                email: email,
                credit: 0,
                payment: '30 jours fin de mois',
                pricelistId: pricelistId,
                ordersCount: 0,
                history: []
            };
            QOData.clients.push(newClient);
            saveQOData('clients');

            // Upload sur Dropbox si configuré
            if (DropboxConfig.autoSync && DropboxConfig.token) {
                saveClientToDropbox(newClient);
            }

            hideQONewClientForm();
            selectQOClient(newClient.id);
        }

        // Step Navigation
        function goToQOStep2() {
            if (!QOData.selectedClient) { alert('Sélectionnez un client'); return; }

            document.getElementById('qo-step-client').style.display = 'none';
            document.getElementById('qo-step-order').style.display = 'block';
            document.getElementById('qo-header-client').textContent = QOData.selectedClient.name;

            loadQOClientHistory();
            refreshQOSuggestions();
            // Mettre à jour l'affichage des paliers de rabais
            updateDiscountTiersDisplay();
        }

        function goBackToQOStep1() {
            document.getElementById('qo-step-order').style.display = 'none';
            document.getElementById('qo-step-client').style.display = 'block';
        }

        // Client History
        function loadQOClientHistory() {
            const historyDiv = document.getElementById('qo-client-history');
            const client = QOData.selectedClient;
            const clientType = client?.clientType || 'b2b';

            if (!client || !client.history || client.history.length === 0) {
                historyDiv.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">Aucun historique</div>';
                return;
            }

            const historyProducts = client.history.map(pid => QOData.products.find(p => p.id === pid)).filter(p => p && p.active);
            historyDiv.innerHTML = historyProducts.map(p => {
                const price = getQOProductPrice(p, clientType);
                return `
                <div onclick="addQOToCart(${p.id})" style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:var(--bg-primary); border-radius:8px; margin-bottom:8px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)';this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.background='var(--bg-primary)'">
                    <div>
                        <strong style="color:var(--accent-orange); font-size:12px;">${p.code}</strong>
                        <div style="font-size:14px;">${p.name}</div>
                        <div style="font-size:11px; color:var(--text-muted);">${getCategoryIcon(p.category)} ${p.category || ''}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-family:'Space Mono',monospace; font-weight:600; color:var(--accent-primary);">${price.toFixed(2)}</div>
                        <div style="font-size:11px; color:var(--text-muted);">/${p.unit}</div>
                    </div>
                </div>
            `}).join('');
        }

        // Suggestions (jamais commandé)
        function refreshQOSuggestions() {
            const suggestionsDiv = document.getElementById('qo-suggestions');
            const client = QOData.selectedClient;
            const clientType = client?.clientType || 'b2b';
            const clientHistory = client?.history || [];

            // Produits jamais commandés
            let neverOrdered = QOData.products.filter(p => p.active && !clientHistory.includes(p.id));

            // Mélanger aléatoirement
            neverOrdered = neverOrdered.sort(() => Math.random() - 0.5).slice(0, 5);

            if (neverOrdered.length === 0) {
                suggestionsDiv.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">Tous les produits ont déjà été commandés !</div>';
                return;
            }

            suggestionsDiv.innerHTML = neverOrdered.map(p => {
                const price = getQOProductPrice(p, clientType);
                return `
                <div onclick="addQOToCart(${p.id})" style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:rgba(6,214,160,0.1); border:1px solid rgba(6,214,160,0.3); border-radius:8px; margin-bottom:8px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='rgba(6,214,160,0.2)'" onmouseout="this.style.background='rgba(6,214,160,0.1)'">
                    <div>
                        <strong style="color:var(--accent-orange); font-size:12px;">${p.code}</strong>
                        <div style="font-size:14px;">${p.name}</div>
                        <div style="font-size:11px; color:var(--text-muted);">${getCategoryIcon(p.category)} ${p.category || ''}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-family:'Space Mono',monospace; font-weight:600; color:var(--accent-primary);">${price.toFixed(2)}</div>
                        <div style="font-size:11px; color:var(--text-muted);">/${p.unit}</div>
                    </div>
                </div>
            `}).join('');
        }

        // Product Search
        // Variable pour suivre la catégorie filtrée
        let qoSelectedCategory = null;

        function showQOProductsByCategory() {
            if (!ArticlesData || !ArticlesData.articles) {
                loadArticlesData();
            }

            // Afficher les boutons de catégorie
            const filterDiv = document.getElementById('qo-category-filter');
            filterDiv.innerHTML = `
                <button onclick="filterQOByCategory(null)" class="qo-cat-btn ${!qoSelectedCategory ? 'active' : ''}" style="padding:6px 12px; border-radius:20px; font-size:12px; cursor:pointer; border:1px solid var(--border-color); background:${!qoSelectedCategory ? 'var(--accent-primary)' : 'var(--bg-card)'}; color:${!qoSelectedCategory ? '#000' : 'var(--text-primary)'};">Tous</button>
                ${ArticlesData.categories.map(cat => `
                    <button onclick="filterQOByCategory(${cat.id})" class="qo-cat-btn ${qoSelectedCategory === cat.id ? 'active' : ''}" style="padding:6px 12px; border-radius:20px; font-size:12px; cursor:pointer; border:1px solid var(--border-color); background:${qoSelectedCategory === cat.id ? 'var(--accent-primary)' : 'var(--bg-card)'}; color:${qoSelectedCategory === cat.id ? '#000' : 'var(--text-primary)'};">${cat.icon} ${cat.name}</button>
                `).join('')}
            `;

            // Afficher les produits
            renderQOProducts();
        }

        function filterQOByCategory(categoryId) {
            qoSelectedCategory = categoryId;
            showQOProductsByCategory();
        }

        function searchQOProducts(query) {
            const resultsDiv = document.getElementById('qo-product-results');

            if (!ArticlesData || !ArticlesData.articles) {
                loadArticlesData();
            }

            if (query.length === 0) {
                showQOProductsByCategory();
                return;
            }

            const q = query.toLowerCase();
            const matches = ArticlesData.articles.filter(a => a.active !== false && (
                a.num.toLowerCase().includes(q) ||
                a.name.toLowerCase().includes(q) ||
                (a.latin && a.latin.toLowerCase().includes(q)) ||
                (a.origin && a.origin.toLowerCase().includes(q))
            ));

            renderQOProductList(matches);
        }

        function renderQOProducts() {
            let articles = ArticlesData.articles.filter(a => a.active !== false);

            if (qoSelectedCategory) {
                articles = articles.filter(a => a.categoryId === qoSelectedCategory);
            }

            renderQOProductList(articles);
        }

        function renderQOProductList(articles) {
            const resultsDiv = document.getElementById('qo-product-results');
            const client = QOData.selectedClient;
            const clientType = client?.clientType || 'b2b';
            const pricelistId = client?.pricelistId || null;
            const pricelist = pricelistId ? ArticlesData.pricelists?.find(p => p.id === pricelistId) : null;

            if (articles.length === 0) {
                resultsDiv.innerHTML = '<div style="padding:20px; color:var(--text-muted); text-align:center;">Aucun produit trouvé</div>';
                return;
            }

            // Afficher info liste de prix si applicable
            let pricelistInfo = '';
            if (pricelist) {
                pricelistInfo = `<div style="padding:10px 14px; background:var(--accent-warning)15; border:1px solid var(--accent-warning); border-radius:8px; margin-bottom:12px; font-size:13px;">
                    💰 Liste de prix: <strong>${pricelist.name}</strong> (-${pricelist.discount}%)
                </div>`;
            }

            resultsDiv.innerHTML = pricelistInfo + articles.slice(0, 50).map(a => {
                const cat = ArticlesData.categories.find(c => c.id === a.categoryId);
                const basePrice = clientType === 'b2c' ? a.priceB2C : a.priceB2B;
                const finalPrice = calculatePriceWithDiscount(a, 1, clientType, pricelistId);
                const hasDiscount = finalPrice < basePrice;
                const priceLabel = clientType === 'b2c' ? 'B2C' : 'PRO';

                return `
                <div onclick="addQOToCart(${a.id})" style="display:flex; justify-content:space-between; align-items:center; padding:12px 14px; background:var(--bg-primary); border-radius:10px; margin-bottom:8px; cursor:pointer; transition:all 0.2s; border:1px solid transparent;" onmouseover="this.style.background='var(--bg-hover)'; this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.background='var(--bg-primary)'; this.style.borderColor='transparent'">
                    <div style="flex:1;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                            <strong style="color:var(--accent-orange); font-size:12px;">${a.num}</strong>
                            ${cat ? `<span style="font-size:14px;">${cat.icon}</span>` : ''}
                        </div>
                        <div style="font-size:15px; font-weight:600;">${a.name}</div>
                        ${a.latin ? `<div style="font-size:11px; font-style:italic; color:var(--text-muted);">${a.latin}</div>` : ''}
                        <div style="font-size:12px; color:var(--text-muted);">${a.origin || ''} ${a.pcs > 1 ? '• ' + a.pcs + ' pcs' : ''}</div>
                    </div>
                    <div style="text-align:right; min-width:100px;">
                        ${hasDiscount ? `<div style="font-size:11px; color:var(--text-muted); text-decoration:line-through;">${basePrice.toFixed(2)}</div>` : ''}
                        <div style="font-family:'Space Mono',monospace; font-weight:700; font-size:17px; color:var(--accent-primary);">${finalPrice.toFixed(2)}</div>
                        <div style="font-size:11px; color:var(--text-muted);">CHF/${a.unit} <span style="color:${clientType === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)'}">${priceLabel}</span></div>
                    </div>
                </div>
            `}).join('');

            if (articles.length > 50) {
                resultsDiv.innerHTML += `<div style="padding:12px; text-align:center; color:var(--text-muted); font-size:13px;">+ ${articles.length - 50} autres produits. Affinez votre recherche.</div>`;
            }
        }

        function getCategoryIcon(categoryId) {
            if (!ArticlesData || !ArticlesData.categories) return '📦';
            const cat = ArticlesData.categories.find(c => c.id === categoryId);
            return cat ? cat.icon : '📦';
        }

        // Cart Management
        function addQOToCart(articleId) {
            const article = ArticlesData.articles.find(a => a.id === articleId);
            if (!article) return;

            const client = QOData.selectedClient;
            const clientType = client?.clientType || 'b2b';
            const pricelistId = client?.pricelistId || null;
            const price = calculatePriceWithDiscount(article, 1, clientType, pricelistId);
            const cat = ArticlesData.categories.find(c => c.id === article.categoryId);

            const existing = QOData.cart.find(item => item.productId === articleId);
            if (existing) {
                existing.qty += 1;
                // Recalculer le prix avec les rabais quantité
                existing.price = calculatePriceWithDiscount(article, existing.qty, clientType, pricelistId);
                existing.total = existing.qty * existing.price;
            } else {
                QOData.cart.push({
                    productId: article.id,
                    code: article.num,
                    name: article.name,
                    latin: article.latin || '',
                    category: cat?.name || '',
                    categoryId: article.categoryId,
                    lot: article.lot || '',
                    origin: article.origin || '',
                    price: price,
                    priceB2B: article.priceB2B || 0,
                    priceB2C: article.priceB2C || 0,
                    tva: article.tva || 2.6,
                    unit: article.unit,
                    qty: 1,
                    total: price
                });
            }

            updateQOCart();

            // Effacer recherche
            document.getElementById('qo-product-search').value = '';
            showQOProductsByCategory();
        }

        function updateQOCart() {
            const cartDiv = document.getElementById('qo-cart-items');

            if (QOData.cart.length === 0) {
                cartDiv.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:40px;">Ajoutez des produits</div>';
                document.getElementById('qo-cart-count').textContent = '0 article(s)';
                document.getElementById('qo-total-items').textContent = '0';
                document.getElementById('qo-total-weight').textContent = '0.00 kg';
                document.getElementById('qo-total-price').textContent = '0.00 CHF';
                document.getElementById('qo-total-tva').textContent = '0.00 CHF';
                document.getElementById('qo-total-ttc').textContent = '0.00 CHF';
                document.getElementById('qo-total-ttc-compact').textContent = '0.00 CHF';
                return;
            }

            let totalItems = 0, totalWeight = 0, totalPrice = 0;

            cartDiv.innerHTML = QOData.cart.map((item, index) => {
                totalItems += item.qty;
                if (item.unit === 'kg') totalWeight += item.qty;
                totalPrice += item.total;

                // Vérifier si un rabais quantité est appliqué
                const article = ArticlesData?.articles?.find(a => a.id === item.productId);
                const client = QOData.selectedClient;
                const clientType = client?.clientType || 'b2b';
                const basePrice = clientType === 'b2c' ? (item.priceB2C || item.price) : (item.priceB2B || item.price);
                const hasQuantityDiscount = item.price < basePrice;

                // Calculer le pourcentage de rabais et l'économie
                let discountPct = 0;
                let savings = 0;
                if (hasQuantityDiscount && basePrice > 0) {
                    discountPct = ((basePrice - item.price) / basePrice * 100).toFixed(0);
                    savings = (basePrice - item.price) * item.qty;
                }

                return `
                    <div style="background:var(--bg-primary); border-radius:10px; padding:12px; margin-bottom:10px; border:1px solid ${hasQuantityDiscount ? 'var(--accent-warning)' : 'var(--border-color)'};">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                            <div style="flex:1;">
                                <div style="font-weight:600; font-size:14px;">${item.name}</div>
                                <div style="font-size:11px; color:var(--accent-orange);">${item.code}</div>
                                <div style="font-size:11px; color:var(--text-muted); margin-top:2px;">${item.origin || ''} ${item.latin ? '• ' + item.latin : ''}</div>
                                ${item.lot ? `<div style="font-size:11px; color:var(--text-muted);">Lot: ${item.lot}</div>` : ''}
                                ${hasQuantityDiscount ? `<div style="font-size:11px; margin-top:4px; padding:3px 10px; background:var(--accent-warning)20; color:var(--accent-warning); border-radius:10px; display:inline-flex; align-items:center; gap:8px;">
                                    <span>🏷️ Rabais quantité (-${discountPct}%)</span>
                                    <span style="padding:2px 6px; background:var(--accent-primary); color:#000; border-radius:6px; font-weight:700;">économie ${savings.toFixed(2)} CHF</span>
                                </div>` : ''}
                            </div>
                            <button onclick="openQOEditModal(${index})" style="background:none; border:none; color:var(--accent-secondary); cursor:pointer; font-size:16px; padding:4px;">✏️</button>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; padding-top:8px; border-top:1px dashed var(--border-color);">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <button onclick="changeQOQty(${index}, -1)" style="width:28px; height:28px; border-radius:6px; border:1px solid var(--border-color); background:var(--bg-hover); color:var(--text-primary); cursor:pointer; font-size:16px;">−</button>
                                <input type="number" value="${item.qty}" min="0.1" step="${item.unit === 'kg' ? '0.1' : '1'}"
                                    style="width:60px; text-align:center; padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-weight:600;"
                                    onchange="setQOQty(${index}, this.value)">
                                <button onclick="changeQOQty(${index}, 1)" style="width:28px; height:28px; border-radius:6px; border:1px solid var(--border-color); background:var(--bg-hover); color:var(--text-primary); cursor:pointer; font-size:16px;">+</button>
                                <span style="font-size:12px; color:var(--text-muted);">/${item.unit}</span>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:12px; color:var(--text-muted);">${item.price.toFixed(2)} × ${item.qty}</div>
                                <div style="font-family:'Space Mono',monospace; font-weight:700; font-size:16px; color:var(--accent-primary);">${item.total.toFixed(2)} CHF</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('qo-cart-count').textContent = QOData.cart.length + ' article(s)';
            document.getElementById('qo-total-items').textContent = totalItems;
            document.getElementById('qo-total-weight').textContent = totalWeight.toFixed(2) + ' kg';
            document.getElementById('qo-total-price').textContent = totalPrice.toFixed(2) + ' CHF';

            // Calculer TVA et TTC (TVA 2.6% par défaut)
            const tvaRate = 2.6;
            const totalTva = totalPrice * (tvaRate / 100);
            const totalTtc = totalPrice + totalTva;
            document.getElementById('qo-total-tva').textContent = totalTva.toFixed(2) + ' CHF';
            document.getElementById('qo-total-ttc').textContent = totalTtc.toFixed(2) + ' CHF';

            // Mettre à jour le total compact dans la barre caisse
            document.getElementById('qo-total-ttc-compact').textContent = totalTtc.toFixed(2) + ' CHF';

            // Mettre à jour l'affichage des paliers de rabais
            updateDiscountTiersDisplay();
        }

        // Toggle caisse (ouvrir/fermer les détails)
        function toggleQOCaisse() {
            const details = document.getElementById('qo-caisse-details');
            const arrow = document.getElementById('qo-caisse-arrow');
            if (details.style.display === 'none') {
                details.style.display = 'block';
                arrow.textContent = '▼';
            } else {
                details.style.display = 'none';
                arrow.textContent = '▲';
            }
        }

        // Toggle menu flottant
        let qoFloatMenuOpen = false;
        function toggleQOFloatMenu() {
            const expanded = document.getElementById('qo-float-expanded');
            const toggle = document.getElementById('qo-float-toggle');
            qoFloatMenuOpen = !qoFloatMenuOpen;

            if (qoFloatMenuOpen) {
                expanded.style.opacity = '1';
                expanded.style.transform = 'translateY(0)';
                expanded.style.pointerEvents = 'auto';
                toggle.textContent = '✕';
                toggle.style.background = 'var(--accent-primary)';
                toggle.style.color = '#000';
                toggle.style.borderColor = 'var(--accent-primary)';
            } else {
                expanded.style.opacity = '0';
                expanded.style.transform = 'translateY(10px)';
                expanded.style.pointerEvents = 'none';
                toggle.textContent = '⚙️';
                toggle.style.background = 'var(--bg-card)';
                toggle.style.color = 'var(--text-muted)';
                toggle.style.borderColor = 'var(--border-color)';
            }
        }

        // Afficher les paliers de rabais pour le client sélectionné
        function updateDiscountTiersDisplay() {
            const infoDiv = document.getElementById('qo-discount-info');
            const simDiv = document.getElementById('qo-discount-simulation');
            const plBadge = document.getElementById('qo-pricelist-badge');

            if (!infoDiv || !simDiv) return;

            const client = QOData.selectedClient;
            if (!client) {
                infoDiv.style.display = 'none';
                return;
            }

            // Récupérer les infos de la liste de prix du client
            const pricelistId = client.pricelistId;
            const pricelist = pricelistId ? ArticlesData.pricelists?.find(p => p.id === pricelistId) : null;

            // Afficher le badge liste de prix
            if (plBadge) {
                if (pricelist && pricelist.discount > 0) {
                    plBadge.textContent = `📋 ${pricelist.name}: -${pricelist.discount}%`;
                    plBadge.style.display = 'inline-block';
                } else {
                    plBadge.style.display = 'none';
                }
            }

            // Collecter les rabais quantité applicables
            const applicableDiscounts = ArticlesData.discounts?.filter(d =>
                !d.pricelistId || d.pricelistId === pricelistId
            ) || [];

            // Calculer le total actuel du panier pour la simulation
            const cartTotal = QOData.cart.reduce((sum, item) => sum + item.total, 0);
            const cartQty = QOData.cart.reduce((sum, item) => sum + item.qty, 0);

            // Générer les simulations par palier
            let simulations = [];

            // Ligne 1: Prix avec liste de prix uniquement (sans rabais quantité)
            if (pricelist && pricelist.discount > 0) {
                simulations.push({
                    type: 'pricelist',
                    label: `Prix liste "${pricelist.name}"`,
                    discount: `-${pricelist.discount}%`,
                    applied: true,
                    color: '#06d6a0'
                });
            } else {
                simulations.push({
                    type: 'base',
                    label: client.clientType === 'b2b' ? 'Tarif Pro B2B' : 'Tarif Standard',
                    discount: '✓',
                    applied: true,
                    color: '#06d6a0'
                });
            }

            // Lignes pour les paliers de rabais quantité
            applicableDiscounts.forEach(d => {
                if (d.tiers && d.tiers.length > 0) {
                    const category = ArticlesData.categories?.find(c => c.id === d.categoryId);
                    const catName = category?.name || 'Produits';

                    // Trier les paliers par quantité
                    const sortedTiers = [...d.tiers].sort((a, b) => a.qty - b.qty);

                    sortedTiers.forEach((tier, idx) => {
                        // Vérifier si ce palier est atteint dans le panier actuel
                        const categoryItems = QOData.cart.filter(item => {
                            const article = ArticlesData.articles?.find(a => a.id === item.productId);
                            return article && article.categoryId === d.categoryId;
                        });
                        const categoryQty = categoryItems.reduce((sum, item) => sum + item.qty, 0);
                        const isApplied = categoryQty >= tier.qty;

                        // Trouver le prochain palier
                        const nextTier = sortedTiers[idx + 1];
                        const qtyNeeded = isApplied ? (nextTier ? nextTier.qty - categoryQty : 0) : tier.qty - categoryQty;

                        simulations.push({
                            type: 'quantity',
                            label: `Dès ${tier.qty} ${catName}`,
                            discount: `-${tier.pct}%`,
                            applied: isApplied,
                            qtyNeeded: Math.ceil(qtyNeeded),
                            currentQty: categoryQty,
                            color: isApplied ? '#06d6a0' : '#ffd166'
                        });
                    });
                }
            });

            // Générer l'affichage
            if (simulations.length === 0) {
                infoDiv.style.display = 'none';
                return;
            }

            infoDiv.style.display = 'block';

            // Séparer les rabais appliqués des rabais disponibles
            const applied = simulations.filter(s => s.applied);
            const available = simulations.filter(s => !s.applied);

            let html = '';

            // Rabais appliqués
            if (applied.length > 0) {
                html += `<div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:${available.length > 0 ? '8px' : '0'};">`;
                applied.forEach(s => {
                    html += `<span style="padding:4px 10px; background:${s.color}20; color:${s.color}; border-radius:12px; font-weight:600; font-size:11px;">
                        ✓ ${s.label}: <strong>${s.discount}</strong>
                    </span>`;
                });
                html += '</div>';
            }

            // Séparateur et rabais disponibles
            if (available.length > 0) {
                html += `<div style="border-top:1px dashed var(--border-color); padding-top:8px; margin-top:4px;">
                    <div style="font-size:10px; color:var(--text-muted); margin-bottom:6px;">📈 Prochain palier :</div>
                    <div style="display:flex; flex-wrap:wrap; gap:6px;">`;
                available.forEach(s => {
                    html += `<span style="padding:4px 10px; background:${s.color}15; color:${s.color}; border-radius:12px; font-size:11px; border:1px dashed ${s.color}50;">
                        ${s.label}: <strong>${s.discount}</strong>
                        ${s.qtyNeeded > 0 ? `<span style="margin-left:4px; opacity:0.7;">(+${s.qtyNeeded})</span>` : ''}
                    </span>`;
                });
                html += '</div></div>';
            }

            simDiv.innerHTML = html;
        }

        function changeQOQty(index, delta) {
            const item = QOData.cart[index];
            if (!item) return;

            const step = item.unit === 'kg' ? 0.5 : 1;
            item.qty = Math.max(step, item.qty + (delta * step));

            // Recalculer le prix avec les rabais quantité
            const article = ArticlesData.articles.find(a => a.id === item.productId);
            if (article) {
                const client = QOData.selectedClient;
                const clientType = client?.clientType || 'b2b';
                const pricelistId = client?.pricelistId || null;
                item.price = calculatePriceWithDiscount(article, item.qty, clientType, pricelistId);
            }

            item.total = item.qty * item.price;
            updateQOCart();
        }

        function setQOQty(index, value) {
            const item = QOData.cart[index];
            if (!item) return;

            item.qty = Math.max(0.1, parseFloat(value) || 0);

            // Recalculer le prix avec les rabais quantité
            const article = ArticlesData.articles.find(a => a.id === item.productId);
            if (article) {
                const client = QOData.selectedClient;
                const clientType = client?.clientType || 'b2b';
                const pricelistId = client?.pricelistId || null;
                item.price = calculatePriceWithDiscount(article, item.qty, clientType, pricelistId);
            }

            item.total = item.qty * item.price;
            updateQOCart();
        }

        // Edit Line Modal
        function openQOEditModal(index) {
            const item = QOData.cart[index];
            if (!item) return;

            document.getElementById('qo-edit-index').value = index;
            document.getElementById('qo-edit-product-name').textContent = item.name;
            document.getElementById('qo-edit-product-code').textContent = item.code;
            document.getElementById('qo-edit-origin').value = item.origin;
            document.getElementById('qo-edit-latin').value = item.latin;
            document.getElementById('qo-edit-lot').value = item.lot;
            document.getElementById('qo-edit-price').value = item.price;
            document.getElementById('qo-edit-qty').value = item.qty;

            document.getElementById('qo-edit-line-modal').style.display = 'flex';
        }

        function closeQOEditModal() { document.getElementById('qo-edit-line-modal').style.display = 'none'; }

        function saveQOEditLine() {
            const index = parseInt(document.getElementById('qo-edit-index').value);
            const item = QOData.cart[index];
            if (!item) return;

            item.origin = document.getElementById('qo-edit-origin').value;
            item.latin = document.getElementById('qo-edit-latin').value;
            item.lot = document.getElementById('qo-edit-lot').value;
            item.price = parseFloat(document.getElementById('qo-edit-price').value) || 0;
            item.qty = parseFloat(document.getElementById('qo-edit-qty').value) || 1;
            item.total = item.qty * item.price;

            closeQOEditModal();
            updateQOCart();
        }

        function removeQOCartItem() {
            const index = parseInt(document.getElementById('qo-edit-index').value);
            QOData.cart.splice(index, 1);
            closeQOEditModal();
            updateQOCart();
        }

        // Validate Order
        function validateQOOrder() {
            if (!QOData.selectedClient) { alert('Aucun client sélectionné'); return; }
            if (QOData.cart.length === 0) { alert('Le panier est vide'); return; }

            let totalHT = 0;
            QOData.cart.forEach(item => totalHT += item.total);
            const tva = totalHT * 0.026;
            const totalTTC = totalHT + tva;

            // Générer un numéro de commande
            const now = new Date();
            const orderNum = generateOrderNumber();

            // Utilisateur courant
            const currentUser = UsersData.currentUser?.name || 'Inconnu';

            const order = {
                id: orderNum,
                clientId: QOData.selectedClient.id,
                clientName: QOData.selectedClient.name,
                clientType: QOData.selectedClient.clientType || 'b2b',
                clientAddress: QOData.selectedClient.address || '',
                clientCity: QOData.selectedClient.city || '',
                clientPhone: QOData.selectedClient.phone || '',
                pricelistId: QOData.selectedClient.pricelistId || null,
                items: [...QOData.cart],
                totalHT: totalHT,
                tva: tva,
                totalTTC: totalTTC,
                date: now.toISOString(),
                createdAt: now.toISOString(),
                createdBy: currentUser,
                updatedAt: null,
                updatedBy: null,
                status: 'pending',
                statusLabel: 'En attente'
            };

            // Update client history
            const client = QOData.clients.find(c => c.id === QOData.selectedClient.id);
            if (client) {
                client.ordersCount = (client.ordersCount || 0) + 1;
                client.lastOrderDate = now.toISOString();
                client.lastOrderId = order.id;
                QOData.cart.forEach(item => {
                    if (!client.history) client.history = [];
                    if (!client.history.includes(item.productId)) {
                        client.history.push(item.productId);
                    }
                });
                saveQOData('clients');
            }

            QOData.orders.push(order);
            saveQOData('orders');

            // Mettre à jour le badge des commandes
            updateOrdersBadge();

            // Generate PDF et sauvegarder sur Dropbox (sans ouvrir)
            generateQOPDF(order, false);

            // Reset
            QOData.cart = [];
            QOData.selectedClient = null;
            updateQOCart();

            alert('✅ Commande ' + order.id + ' enregistrée !\n\n📤 PDF sauvegardé sur Dropbox\nCréée par: ' + currentUser);

            // Reset to step 1
            document.getElementById('qo-step-order').style.display = 'none';
            document.getElementById('qo-step-client').style.display = 'block';
            document.getElementById('qo-selected-client').style.display = 'none';
            document.getElementById('qo-btn-next-step').style.display = 'none';

            // Mettre à jour la barre flottante
            updateOrderFloatingBar();
        }

        function updateOrdersBadge() {
            const pendingOrders = QOData.orders.filter(o => o.status === 'pending' || o.status === 'preparing').length;
            const badge = document.getElementById('orders-badge');
            if (badge) {
                badge.textContent = pendingOrders;
                badge.style.display = pendingOrders > 0 ? 'flex' : 'none';
            }
        }

        // =====================================================
        // GESTION DES COMMANDES EN COURS
        // =====================================================

        function initOrdersModule() {
            renderOrdersTable();
            updateOrdersStats();
        }

        function updateOrdersStats() {
            const orders = QOData.orders || [];
            const now = new Date();
            const thisMonth = orders.filter(o => {
                const d = new Date(o.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });

            document.getElementById('orders-stat-pending').textContent = orders.filter(o => o.status === 'pending').length;
            document.getElementById('orders-stat-preparing').textContent = orders.filter(o => o.status === 'preparing').length;
            document.getElementById('orders-stat-ready').textContent = orders.filter(o => o.status === 'ready').length;
            document.getElementById('orders-stat-total').textContent = thisMonth.length;
        }

        function renderOrdersTable() {
            const filter = document.getElementById('orders-filter-status')?.value || '';
            let orders = [...(QOData.orders || [])].reverse(); // Plus récentes en premier

            if (filter) {
                orders = orders.filter(o => o.status === filter);
            }

            const tbody = document.getElementById('orders-tbody');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">Aucune commande</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(o => {
                const statusColors = {
                    pending: { bg: 'var(--accent-secondary)', label: '⏳ En attente' },
                    preparing: { bg: 'var(--accent-warning)', label: '🔄 Préparation' },
                    ready: { bg: 'var(--accent-primary)', label: '✅ Prête' },
                    delivered: { bg: '#666', label: '📦 Livrée' }
                };
                const status = statusColors[o.status] || statusColors.pending;
                const date = new Date(o.date).toLocaleString('fr-CH', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                const total = o.totalTTC ? o.totalTTC.toFixed(2) : (o.total ? o.total.toFixed(2) : '0.00');

                // Métadonnées créé/modifié
                const createdInfo = o.createdBy ? `Créée par ${o.createdBy}` : '';
                const updatedInfo = o.updatedAt ? `<br><span style="color:var(--accent-warning);">✏️ Modifiée par ${o.updatedBy || '-'}</span>` : '';

                return `
                <tr style="cursor:pointer;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                    <td onclick="showOrderDetail('${o.id}')"><strong style="color:var(--accent-primary);">${o.id}</strong></td>
                    <td onclick="showOrderDetail('${o.id}')">
                        <div style="font-weight:600;">${o.clientName}</div>
                        <div style="font-size:11px; color:var(--text-muted);">${o.clientCity || ''}</div>
                    </td>
                    <td onclick="showOrderDetail('${o.id}')" style="font-size:12px;">
                        <div>${date}</div>
                        <div style="font-size:10px; color:var(--text-muted); margin-top:2px;">${createdInfo}${updatedInfo}</div>
                    </td>
                    <td onclick="showOrderDetail('${o.id}')">${o.items?.length || 0} article(s)</td>
                    <td onclick="showOrderDetail('${o.id}')" style="font-family:'Space Mono',monospace; font-weight:600;">${total} CHF</td>
                    <td><span style="padding:4px 10px; background:${status.bg}20; color:${status.bg}; border-radius:20px; font-size:11px; white-space:nowrap;">${status.label}</span></td>
                    <td onclick="event.stopPropagation()">
                        <select onchange="changeOrderStatus('${o.id}', this.value)" style="padding:6px 10px; border-radius:6px; border:1px solid var(--border-color); background:var(--bg-card); color:var(--text-primary); font-size:12px;">
                            <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>⏳ En attente</option>
                            <option value="preparing" ${o.status === 'preparing' ? 'selected' : ''}>🔄 Préparation</option>
                            <option value="ready" ${o.status === 'ready' ? 'selected' : ''}>✅ Prête</option>
                            <option value="delivered" ${o.status === 'delivered' ? 'selected' : ''}>📦 Livrée</option>
                        </select>
                    </td>
                    <td onclick="event.stopPropagation()" style="white-space:nowrap;">
                        <button onclick="editOrder('${o.id}')" style="padding:6px 10px; background:var(--accent-warning); color:#000; border:none; border-radius:6px; cursor:pointer; margin-right:4px;" title="Modifier">✏️</button>
                        <button onclick="printOrder('${o.id}')" style="padding:6px 10px; background:var(--accent-primary); color:#000; border:none; border-radius:6px; cursor:pointer;" title="Imprimer A4">🖨️</button>
                    </td>
                </tr>
            `}).join('');
        }

        function changeOrderStatus(orderId, newStatus) {
            const order = QOData.orders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                order.statusLabel = {
                    pending: 'En attente',
                    preparing: 'En préparation',
                    ready: 'Prête',
                    delivered: 'Livrée'
                }[newStatus];
                saveQOData('orders');
                updateOrdersStats();
                updateOrdersBadge();
            }
        }

        function showOrderDetail(orderId) {
            const order = QOData.orders.find(o => o.id === orderId);
            if (!order) return;

            const date = new Date(order.date).toLocaleString('fr-CH');
            const items = order.items.map(i => `• ${i.name} x${i.qty} = ${i.total.toFixed(2)} CHF`).join('\n');

            let metaInfo = '';
            if (order.createdBy) {
                metaInfo += `\n\n📝 Créée par: ${order.createdBy}`;
                if (order.createdAt) metaInfo += ` le ${new Date(order.createdAt).toLocaleString('fr-CH')}`;
            }
            if (order.updatedBy) {
                metaInfo += `\n✏️ Modifiée par: ${order.updatedBy}`;
                if (order.updatedAt) metaInfo += ` le ${new Date(order.updatedAt).toLocaleString('fr-CH')}`;
            }

            alert(`📋 Commande ${order.id}\n\n👤 Client: ${order.clientName}\n📅 Date: ${date}\n\n📦 Articles:\n${items}\n\n💰 Total TTC: ${(order.totalTTC || order.total || 0).toFixed(2)} CHF${metaInfo}`);
        }

        // Afficher les commandes d'un client
        function showClientOrders() {
            if (!QOData.selectedClient) return;

            const clientId = QOData.selectedClient.id;
            const clientName = QOData.selectedClient.name;
            const clientOrders = QOData.orders.filter(o => o.clientId === clientId).sort((a, b) => new Date(b.date) - new Date(a.date));

            document.getElementById('client-orders-title').textContent = `Commandes - ${clientName}`;

            const listDiv = document.getElementById('client-orders-list');

            if (clientOrders.length === 0) {
                listDiv.innerHTML = `
                    <div style="text-align:center; padding:40px; color:var(--text-muted);">
                        <div style="font-size:48px; margin-bottom:16px;">📋</div>
                        <p>Aucune commande pour ce client</p>
                    </div>
                `;
            } else {
                listDiv.innerHTML = clientOrders.map(order => {
                    const date = new Date(order.date).toLocaleString('fr-CH', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                    const total = (order.totalTTC || order.total || 0).toFixed(2);
                    const statusColors = {
                        pending: { bg: 'var(--accent-secondary)', label: '⏳ En attente' },
                        preparing: { bg: 'var(--accent-warning)', label: '🔄 Préparation' },
                        ready: { bg: 'var(--accent-primary)', label: '✅ Prête' },
                        delivered: { bg: '#666', label: '📦 Livrée' }
                    };
                    const status = statusColors[order.status] || statusColors.pending;

                    // Liste des articles
                    const itemsList = order.items.map(i => `
                        <div style="display:flex; justify-content:space-between; padding:4px 0; font-size:12px; border-bottom:1px dashed var(--border-color);">
                            <span>${i.name} <span style="color:var(--text-muted);">x${i.qty}</span></span>
                            <span style="font-family:'Space Mono',monospace;">${i.total.toFixed(2)} CHF</span>
                        </div>
                    `).join('');

                    // Métadonnées
                    let metaHtml = '';
                    if (order.createdBy) {
                        metaHtml += `<span style="font-size:10px; color:var(--text-muted);">Créée par ${order.createdBy}</span>`;
                    }
                    if (order.updatedBy) {
                        metaHtml += `<span style="font-size:10px; color:var(--accent-warning); margin-left:8px;">✏️ Modifiée par ${order.updatedBy}</span>`;
                    }

                    return `
                        <div style="background:var(--bg-primary); border-radius:12px; padding:16px; margin-bottom:12px; border:1px solid var(--border-color);">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                                <div>
                                    <div style="font-weight:700; font-size:16px; color:var(--accent-primary);">${order.id}</div>
                                    <div style="font-size:12px; color:var(--text-muted);">${date}</div>
                                    ${metaHtml ? `<div style="margin-top:4px;">${metaHtml}</div>` : ''}
                                </div>
                                <div style="text-align:right;">
                                    <span style="padding:4px 10px; background:${status.bg}20; color:${status.bg}; border-radius:20px; font-size:11px;">${status.label}</span>
                                    <div style="font-family:'Space Mono',monospace; font-weight:700; font-size:18px; margin-top:8px;">${total} CHF</div>
                                </div>
                            </div>
                            <div style="background:var(--bg-card); border-radius:8px; padding:10px; margin-bottom:12px;">
                                ${itemsList}
                            </div>
                            <div style="display:flex; gap:8px; justify-content:flex-end;">
                                <button onclick="closeClientOrdersModal(); printOrder('${order.id}')" style="padding:8px 16px; background:var(--accent-primary); color:#000; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;">🖨️ Imprimer</button>
                                <button onclick="closeClientOrdersModal(); editOrder('${order.id}')" style="padding:8px 16px; background:var(--accent-warning); color:#000; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;">✏️ Modifier</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            document.getElementById('client-orders-modal').style.display = 'flex';
        }

        function closeClientOrdersModal() {
            document.getElementById('client-orders-modal').style.display = 'none';
        }

        // Imprimer une commande en A4
        function printOrder(orderId) {
            const order = QOData.orders.find(o => o.id === orderId);
            if (!order) return;

            generateQOPDF(order, true); // true = ouvrir pour impression
        }

        // Éditer une commande existante
        function editOrder(orderId) {
            const order = QOData.orders.find(o => o.id === orderId);
            if (!order) return;

            // Stocker l'ID de la commande en cours d'édition
            QOData.editingOrderId = orderId;

            // Charger le client
            const client = QOData.clients.find(c => c.id === order.clientId);
            if (client) {
                QOData.selectedClient = client;
            } else {
                // Client non trouvé, créer un client temporaire depuis les données de la commande
                QOData.selectedClient = {
                    id: order.clientId,
                    name: order.clientName,
                    clientType: order.clientType || 'b2b',
                    address: order.clientAddress || '',
                    city: order.clientCity || '',
                    phone: order.clientPhone || '',
                    email: order.clientEmail || ''
                };
            }

            // Charger les articles dans le panier (copie profonde)
            QOData.cart = order.items.map(item => ({
                productId: item.productId,
                code: item.code,
                name: item.name,
                origin: item.origin || '',
                latin: item.latin || '',
                lot: item.lot || '',
                unit: item.unit || 'kg',
                price: item.price,
                priceB2B: item.priceB2B || item.price,
                priceB2C: item.priceB2C || item.price,
                qty: item.qty,
                total: item.total
            }));

            console.log('📝 Édition commande:', orderId, 'Articles:', QOData.cart.length);

            // Aller à l'étape commande
            navigateTo('quickorder');

            // Attendre que la page soit chargée puis afficher les données
            setTimeout(() => {
                // Afficher le client sélectionné
                const selectedClient = QOData.selectedClient;
                const clientType = selectedClient.clientType || 'b2b';
                const typeLabel = clientType === 'b2c' ? '🏠 Particulier' : '🏢 Professionnel';
                const typeColor = clientType === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)';

                document.getElementById('qo-client-name').innerHTML = `${selectedClient.name}${selectedClient.contact ? ` - ${selectedClient.contact}` : ''} <span style="margin-left:8px;padding:3px 8px;border-radius:12px;font-size:11px;background:${typeColor};color:#fff;">${typeLabel}</span>`;
                document.getElementById('qo-client-phone').textContent = selectedClient.phone || selectedClient.mobile || '-';
                document.getElementById('qo-client-email').textContent = selectedClient.email || '-';
                document.getElementById('qo-client-orders-count').textContent = selectedClient.ordersCount || 0;
                document.getElementById('qo-selected-client').style.display = 'block';

                // Mettre à jour le header client
                document.getElementById('qo-header-client').textContent = selectedClient.name;

                // Passer à l'étape 2 (commande)
                document.getElementById('qo-step-client').style.display = 'none';
                document.getElementById('qo-step-order').style.display = 'block';

                // Mettre à jour l'affichage du panier
                updateQOCart();

                // Afficher un indicateur d'édition
                const existingBanner = document.getElementById('edit-order-banner');
                if (existingBanner) existingBanner.remove();

                const editBanner = document.createElement('div');
                editBanner.id = 'edit-order-banner';
                editBanner.style.cssText = 'background:linear-gradient(135deg, var(--accent-warning), var(--accent-orange)); color:#000; padding:12px 20px; border-radius:10px; margin-bottom:16px; display:flex; justify-content:space-between; align-items:center;';
                editBanner.innerHTML = `
                    <div>
                        <strong>✏️ Mode Édition</strong> - Commande ${order.id}
                        <div style="font-size:12px; opacity:0.8;">Modifiez les articles puis cliquez sur "Mettre à jour"</div>
                    </div>
                    <button onclick="cancelEditOrder()" style="padding:8px 16px; background:#fff; color:#000; border:none; border-radius:6px; cursor:pointer; font-weight:600;">✖ Annuler</button>
                `;

                // Insérer le banner au début de qo-step-order
                const stepOrder = document.getElementById('qo-step-order');
                stepOrder.insertBefore(editBanner, stepOrder.firstChild);

                // Modifier le bouton de validation
                const validateBtn = document.getElementById('qo-btn-validate');
                if (validateBtn) {
                    validateBtn.innerHTML = '💾 Mettre à jour la commande';
                    validateBtn.onclick = function() { updateExistingOrder(order.id); };
                }

                console.log('✅ Mode édition activé, panier:', QOData.cart);
            }, 200);
        }

        // Annuler l'édition
        function cancelEditOrder() {
            QOData.editingOrderId = null;
            QOData.cart = [];
            QOData.selectedClient = null;

            const banner = document.getElementById('edit-order-banner');
            if (banner) banner.remove();

            // Restaurer le bouton de validation
            const validateBtn = document.getElementById('qo-btn-validate');
            if (validateBtn) {
                validateBtn.innerHTML = '✅ Valider la commande';
                validateBtn.onclick = showFinalizeModal;
            }

            // Retour à l'étape client
            document.getElementById('qo-step-order').style.display = 'none';
            document.getElementById('qo-step-client').style.display = 'block';
            document.getElementById('qo-selected-client').style.display = 'none';
            updateQOCart();
        }

        // Mettre à jour une commande existante
        function updateExistingOrder(orderId) {
            const order = QOData.orders.find(o => o.id === orderId);
            if (!order) return;

            if (QOData.cart.length === 0) {
                alert('Le panier est vide');
                return;
            }

            // Recalculer les totaux
            let totalHT = 0;
            QOData.cart.forEach(item => totalHT += item.total);
            const tva = totalHT * 0.026;
            const totalTTC = totalHT + tva;

            // Utilisateur courant
            const currentUser = UsersData.currentUser?.name || 'Inconnu';
            const now = new Date();

            // Mettre à jour la commande
            order.items = [...QOData.cart];
            order.totalHT = totalHT;
            order.tva = tva;
            order.totalTTC = totalTTC;
            order.updatedAt = now.toISOString();
            order.updatedBy = currentUser;

            saveQOData('orders');

            // Régénérer le PDF sur Dropbox
            generateQOPDF(order, false);

            // Reset
            QOData.editingOrderId = null;
            QOData.cart = [];
            QOData.selectedClient = null;

            const banner = document.getElementById('edit-order-banner');
            if (banner) banner.remove();

            // Restaurer le bouton de validation
            const validateBtn = document.getElementById('qo-btn-validate');
            if (validateBtn) {
                validateBtn.innerHTML = '✅ Valider la commande';
                validateBtn.onclick = showFinalizeModal;
            }

            alert(`✅ Commande ${orderId} mise à jour !\n\n✏️ Modifiée par: ${currentUser}\n📤 PDF mis à jour sur Dropbox`);

            // Retour à l'étape client
            document.getElementById('qo-step-order').style.display = 'none';
            document.getElementById('qo-step-client').style.display = 'block';
            document.getElementById('qo-selected-client').style.display = 'none';
            updateQOCart();

            // Rafraîchir la liste des commandes si on y retourne
            if (typeof renderOrdersTable === 'function') {
                renderOrdersTable();
            }
        }

        // PDF Generation
        function generateQOPDF(order, openForPrint = false) {
            if (typeof window.jspdf === 'undefined') { console.log('jsPDF non chargé'); return; }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFillColor(10, 14, 23);
            doc.rect(0, 0, 210, 45, 'F');

            doc.setTextColor(6, 214, 160);
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text('COMMANDE', 20, 25);

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.text(order.id, 20, 35);

            doc.setFontSize(11);
            doc.text(new Date(order.date).toLocaleDateString('fr-CH') + ' ' + new Date(order.date).toLocaleTimeString('fr-CH', {hour:'2-digit', minute:'2-digit'}), 150, 25);

            // Client info
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('CLIENT', 20, 60);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(14);
            doc.text(order.clientName, 20, 68);

            const client = QOData.clients.find(c => c.id === order.clientId);
            if (client) {
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(client.phone + (client.email ? ' • ' + client.email : ''), 20, 75);
            }

            // Table
            const tableData = order.items.map(item => [
                item.code,
                item.name + '\n' + item.origin + (item.latin ? '\n' + item.latin : '') + '\nLot: ' + (item.lot || '-'),
                item.price.toFixed(2) + ' CHF/' + item.unit,
                item.qty.toString(),
                item.total.toFixed(2) + ' CHF'
            ]);

            const total = order.totalTTC || order.total || 0;

            doc.autoTable({
                startY: 85,
                head: [['Code', 'Désignation', 'Prix unit.', 'Qté', 'Total']],
                body: tableData,
                foot: [['', '', '', 'TOTAL TTC', total.toFixed(2) + ' CHF']],
                theme: 'grid',
                headStyles: { fillColor: [6, 214, 160], textColor: [10, 14, 23], fontStyle: 'bold' },
                footStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold' },
                styles: { fontSize: 9, cellPadding: 5 },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 75 },
                    2: { cellWidth: 30, halign: 'right' },
                    3: { cellWidth: 20, halign: 'center' },
                    4: { cellWidth: 30, halign: 'right' }
                }
            });

            // Métadonnées créé/modifié
            const finalY = doc.lastAutoTable.finalY + 15;
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);

            const createdDate = order.createdAt ? new Date(order.createdAt).toLocaleString('fr-CH') : '-';
            doc.text(`Créée le: ${createdDate} par ${order.createdBy || '-'}`, 20, finalY);

            if (order.updatedAt) {
                const updatedDate = new Date(order.updatedAt).toLocaleString('fr-CH');
                doc.text(`Modifiée le: ${updatedDate} par ${order.updatedBy || '-'}`, 20, finalY + 5);
            }

            // Footer
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(9);
            doc.setTextColor(150, 150, 150);
            doc.text('Document généré automatiquement par TRAKIO', 105, pageHeight - 15, { align: 'center' });

            // Sauvegarder sur Dropbox si configuré
            if (DropboxConfig.connected && DropboxConfig.token) {
                const pdfBase64 = doc.output('datauristring').split(',')[1];
                const monthYear = new Date(order.date).toISOString().slice(0, 7); // YYYY-MM
                const pdfPath = `${DropboxConfig.basePath}/Commandes/${monthYear}/${order.id}.pdf`;

                // Upload async
                uploadPDFToDropbox(pdfPath, pdfBase64);
            }

            // Ouvrir pour impression si demandé
            if (openForPrint) {
                doc.autoPrint();
                window.open(doc.output('bloburl'), '_blank');
            }
        }

        // Upload PDF Base64 vers Dropbox
        async function uploadPDFToDropbox(path, base64Content) {
            try {
                // Convertir base64 en blob
                const byteCharacters = atob(base64Content);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });

                const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + DropboxConfig.token,
                        'Dropbox-API-Arg': JSON.stringify({
                            path: path,
                            mode: 'overwrite',
                            autorename: false,
                            mute: true
                        }),
                        'Content-Type': 'application/octet-stream'
                    },
                    body: blob
                });

                if (response.ok) {
                    console.log('✅ PDF sauvegardé sur Dropbox:', path);
                } else {
                    console.error('❌ Erreur upload PDF Dropbox:', await response.text());
                }
            } catch (error) {
                console.error('Erreur upload PDF:', error);
            }
        }

        // Products Management
        function openQOProductsModal() {
            renderQOProductsTable();
            document.getElementById('qo-products-modal').style.display = 'flex';
        }

        function closeQOProductsModal() { document.getElementById('qo-products-modal').style.display = 'none'; }

        function renderQOProductsTable(filter = '', catFilter = '') {
            const tbody = document.getElementById('qo-products-tbody');
            let products = QOData.products;

            // Filtrer par recherche
            if (filter) {
                const q = filter.toLowerCase();
                products = products.filter(p =>
                    p.code.toLowerCase().includes(q) ||
                    p.name.toLowerCase().includes(q)
                );
            }

            // Filtrer par catégorie
            if (catFilter) {
                products = products.filter(p => p.category === catFilter);
            }

            document.getElementById('qo-products-count').textContent = `(${products.length}/${QOData.products.length} produits)`;

            tbody.innerHTML = products.map(p => `
                <tr style="${!p.active ? 'opacity:0.5;' : ''}">
                    <td><strong style="color:var(--accent-orange);">${p.code}</strong></td>
                    <td>${p.name}</td>
                    <td>${getCategoryIcon(p.category)} ${p.category || '-'}</td>
                    <td style="font-family:'Space Mono',monospace; color:var(--accent-warning);">${(p.priceB2C || 0).toFixed(2)}</td>
                    <td style="font-family:'Space Mono',monospace; color:var(--accent-secondary);">${(p.priceB2B || 0).toFixed(2)}</td>
                    <td>${p.unit}</td>
                    <td>${p.active ? '✅' : '❌'}</td>
                    <td>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="editQOProduct(${p.id})">✏️</button>
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px; color:var(--accent-danger);" onclick="deleteQOProduct(${p.id})">🗑️</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterQOProductsTable(query) {
            const catFilter = document.getElementById('qo-prod-cat-filter').value;
            renderQOProductsTable(query, catFilter);
        }

        function showQOProductForm() {
            document.getElementById('qo-product-form').style.display = 'block';
            document.getElementById('qo-prod-edit-id').value = '';
            document.getElementById('qo-prod-code').value = '';
            document.getElementById('qo-prod-name').value = '';
            document.getElementById('qo-prod-price-b2c').value = '';
            document.getElementById('qo-prod-price-b2b').value = '';
            document.getElementById('qo-prod-cost').value = '';
            document.getElementById('qo-prod-unit').value = 'kg';
            document.getElementById('qo-prod-cat').value = 'poisson';
            document.getElementById('qo-prod-active').checked = true;
        }

        function hideQOProductForm() { document.getElementById('qo-product-form').style.display = 'none'; }

        function editQOProduct(id) {
            const p = QOData.products.find(x => x.id === id);
            if (!p) return;

            document.getElementById('qo-product-form').style.display = 'block';
            document.getElementById('qo-prod-edit-id').value = id;
            document.getElementById('qo-prod-code').value = p.code;
            document.getElementById('qo-prod-name').value = p.name;
            document.getElementById('qo-prod-price-b2c').value = p.priceB2C || '';
            document.getElementById('qo-prod-price-b2b').value = p.priceB2B || '';
            document.getElementById('qo-prod-cost').value = p.cost || '';
            document.getElementById('qo-prod-unit').value = p.unit;
            document.getElementById('qo-prod-cat').value = p.category || 'poisson';
            document.getElementById('qo-prod-active').checked = p.active;
        }

        function saveQOProduct() {
            const id = document.getElementById('qo-prod-edit-id').value;
            const priceB2C = parseFloat(document.getElementById('qo-prod-price-b2c').value) || 0;
            const priceB2B = parseFloat(document.getElementById('qo-prod-price-b2b').value) || 0;

            const product = {
                id: id ? parseInt(id) : Date.now(),
                code: document.getElementById('qo-prod-code').value.trim(),
                name: document.getElementById('qo-prod-name').value.trim(),
                category: document.getElementById('qo-prod-cat').value,
                priceB2C: priceB2C,
                priceB2B: priceB2B || priceB2C * 0.8, // Par défaut -20% si pas de B2B
                cost: parseFloat(document.getElementById('qo-prod-cost').value) || 0,
                unit: document.getElementById('qo-prod-unit').value,
                lot: '',
                active: document.getElementById('qo-prod-active').checked
            };

            if (!product.code || !product.name) {
                alert('Code et désignation requis');
                return;
            }

            if (id) {
                const index = QOData.products.findIndex(p => p.id === parseInt(id));
                if (index !== -1) QOData.products[index] = product;
            } else {
                QOData.products.push(product);
            }

            saveQOData('products');
            hideQOProductForm();
            renderQOProductsTable();
        }

        function deleteQOProduct(id) {
            if (!confirm('Supprimer ce produit ?')) return;
            QOData.products = QOData.products.filter(p => p.id !== id);
            saveQOData('products');
            renderQOProductsTable();
        }

        // Import Lightspeed (B2C)
        function importQOLightspeed(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n').filter(l => l.trim());
                const header = lines[0].split(';');

                // Trouver les index des colonnes
                const colSKU = header.findIndex(h => h.toLowerCase().includes('sku') && !h.toLowerCase().includes('parent'));
                const colNom = header.findIndex(h => h.toLowerCase().includes('nom') && !h.toLowerCase().includes('bouton'));
                const colType = header.findIndex(h => h.toLowerCase().includes('type'));
                const colPrix = header.findIndex(h => h.toLowerCase().includes('prix par défaut') || h.toLowerCase().includes('prix'));
                const colDept = header.findIndex(h => h.toLowerCase().includes('département'));
                const colCost = header.findIndex(h => h.toLowerCase().includes('prix de revient') || h.toLowerCase().includes('cost'));

                let added = 0, updated = 0;

                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(';');
                    const sku = cols[colSKU]?.trim();
                    const nom = cols[colNom]?.trim();
                    const type = cols[colType]?.trim().toLowerCase();
                    const prix = parseFloat(cols[colPrix]) || 0;
                    const dept = cols[colDept]?.trim().toUpperCase() || '';
                    const cost = parseFloat(cols[colCost]) || 0;

                    // Seulement les articles avec nom
                    if (type !== 'article' || !nom || !sku) continue;

                    // Déterminer catégorie
                    let cat = 'autre';
                    if (dept.includes('CRUSTACE')) cat = 'crustace';
                    else if (dept.includes('COQUILLAGE')) cat = 'coquillage';
                    else if (dept.includes('POISSONS FRAIS')) cat = 'poisson';
                    else if (dept.includes('FUME')) cat = 'fume';
                    else if (dept.includes('CONSERVE')) cat = 'conserve';
                    else if (dept.includes('PREPARATION') || dept.includes('EPICERIE')) cat = 'preparation';
                    else if (dept.includes('SURGELE')) cat = 'surgele';

                    // Chercher si existe déjà
                    const existing = QOData.products.find(p => p.code === sku);
                    if (existing) {
                        existing.name = nom;
                        existing.priceB2C = prix;
                        existing.cost = cost || existing.cost;
                        existing.category = cat;
                        existing.active = prix > 0;
                        updated++;
                    } else {
                        QOData.products.push({
                            id: Date.now() + i,
                            code: sku,
                            name: nom,
                            category: cat,
                            priceB2C: prix,
                            priceB2B: 0,
                            cost: cost,
                            unit: 'kg',
                            lot: '',
                            active: prix > 0
                        });
                        added++;
                    }
                }

                saveQOData('products');
                renderQOProductsTable();
                alert(`Import Lightspeed B2C terminé !\n\n✅ ${added} produits ajoutés\n🔄 ${updated} produits mis à jour`);
            };
            reader.readAsText(file);
            input.value = '';
        }

        // Import Infoniqa/Sage (B2B)
        function importQOInfoniqa(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                // Détecter le séparateur
                const sep = content.includes(';') ? ';' : ',';
                const lines = content.split('\n').filter(l => l.trim());
                const header = lines[0].split(sep).map(h => h.toLowerCase().trim());

                // Trouver les index des colonnes (adapter selon format Infoniqa)
                const colCode = header.findIndex(h => h.includes('code') || h.includes('article') || h.includes('sku') || h.includes('numéro'));
                const colNom = header.findIndex(h => h.includes('désignation') || h.includes('nom') || h.includes('libellé'));
                const colPrix = header.findIndex(h => h.includes('prix') || h.includes('tarif'));

                if (colCode < 0 || colPrix < 0) {
                    alert('Format non reconnu. Colonnes requises: Code/Article et Prix');
                    return;
                }

                let updated = 0, notFound = 0;

                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(sep);
                    const code = cols[colCode]?.trim();
                    const prix = parseFloat(cols[colPrix]?.replace(',', '.')) || 0;

                    if (!code || prix <= 0) continue;

                    // Chercher le produit existant par code
                    const existing = QOData.products.find(p => p.code === code);
                    if (existing) {
                        existing.priceB2B = prix;
                        updated++;
                    } else {
                        notFound++;
                    }
                }

                saveQOData('products');
                renderQOProductsTable();
                alert(`Import Infoniqa B2B terminé !\n\n🔄 ${updated} prix B2B mis à jour\n⚠️ ${notFound} codes non trouvés`);
            };
            reader.readAsText(file);
            input.value = '';
        }

        // Export produits CSV
        function exportQOProductsCSV() {
            const headers = ['Code', 'Désignation', 'Catégorie', 'Prix B2C', 'Prix B2B', 'Coût', 'Unité', 'Actif'];
            const rows = QOData.products.map(p => [
                p.code, p.name, p.category, p.priceB2C, p.priceB2B, p.cost || 0, p.unit, p.active ? 'Oui' : 'Non'
            ].map(v => `"${v}"`).join(';'));

            const csv = [headers.join(';'), ...rows].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'produits_export_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
        }

        // Réinitialiser produits
        function resetQOProductsToDefault() {
            if (!confirm('⚠️ Réinitialiser la base produits ?\n\nCette action remplacera tous les produits actuels.')) return;
            loadQODefaultProducts();
            renderQOProductsTable();
            alert('✅ Base produits réinitialisée !');
        }

        // =====================================================
        // MODULE CLIENTS (page dédiée)
        // =====================================================
        function initClientsModule() {
            // S'assurer que les données clients sont chargées
            if (!QOData.clients || QOData.clients.length === 0) {
                const saved = localStorage.getItem('qo_clients');
                if (saved) {
                    QOData.clients = JSON.parse(saved);
                }
                // Si toujours vide, charger les clients par défaut
                if (!QOData.clients || QOData.clients.length < 50) {
                    loadQODefaultClients();
                }
            }
            // Charger ArticlesData si pas encore fait
            if (!ArticlesData || !ArticlesData.pricelists) {
                loadArticlesData();
            }
            updateClientPricelistSelect();
            renderClientsTable();
        }

        function updateClientPricelistSelect() {
            const sel = document.getElementById('clients-pricelist');
            if (sel && typeof ArticlesData !== 'undefined') {
                sel.innerHTML = '<option value="">-- Standard --</option>' +
                    (ArticlesData.pricelists || []).map(p =>
                        `<option value="${p.id}">${p.name} (-${p.discount}%)</option>`
                    ).join('');
            }
        }

        function renderClientsTable(filter = '', typeFilter = '') {
            let clients = QOData.clients || [];

            // Filtrer par recherche
            if (filter) {
                const q = filter.toLowerCase();
                clients = clients.filter(c =>
                    (c.name && c.name.toLowerCase().includes(q)) ||
                    (c.lastname && c.lastname.toLowerCase().includes(q)) ||
                    (c.firstname && c.firstname.toLowerCase().includes(q)) ||
                    (c.contact && c.contact.toLowerCase().includes(q)) ||
                    (c.city && c.city.toLowerCase().includes(q)) ||
                    (c.phone && c.phone.includes(q)) ||
                    (c.mobile && c.mobile.includes(q)) ||
                    (c.email && c.email.toLowerCase().includes(q)) ||
                    (c.num && c.num.includes(q))
                );
            }

            // Filtrer par type
            if (typeFilter) {
                clients = clients.filter(c => (c.clientType || 'b2b').toLowerCase() === typeFilter.toLowerCase());
            }

            // Stats
            const allClients = QOData.clients || [];
            const b2bCount = allClients.filter(c => (c.clientType || 'b2b').toLowerCase() === 'b2b').length;
            const b2cCount = allClients.filter(c => (c.clientType || '').toLowerCase() === 'b2c').length;
            const activeCount = allClients.filter(c => c.ordersCount > 0).length;

            document.getElementById('clients-total').textContent = allClients.length;
            document.getElementById('clients-b2b-count').textContent = b2bCount;
            document.getElementById('clients-b2c-count').textContent = b2cCount;
            document.getElementById('clients-active').textContent = activeCount;

            const tbody = document.getElementById('clients-tbody');
            tbody.innerHTML = clients.slice(0, 200).map(c => {
                const type = (c.clientType || 'b2b').toLowerCase();
                const typeIcon = type === 'b2c' ? '🏠' : '🏢';
                const typeColor = type === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)';
                const typeLabel = type === 'b2c' ? 'Part.' : 'Pro';
                // Nom : pour B2B c'est name, pour B2C c'est lastname + firstname
                const displayName = c.name || `${c.lastname || ''} ${c.firstname || ''}`.trim() || '-';
                const displayContact = c.contact || (c.name ? `${c.lastname || ''} ${c.firstname || ''}`.trim() : '') || '-';
                const pricelist = c.pricelistId && typeof ArticlesData !== 'undefined' ?
                    ArticlesData.pricelists?.find(p => p.id === c.pricelistId) : null;
                return `
                <tr style="cursor:pointer;" onclick="showClientActionModal(${c.id})" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                    <td><strong style="color:var(--accent-orange);">${c.num || c.id}</strong></td>
                    <td><span style="padding:4px 10px; background:${typeColor}20; color:${typeColor}; border-radius:20px; font-size:11px; white-space:nowrap;">${typeIcon} ${typeLabel}</span></td>
                    <td><strong style="color:var(--accent-primary);">${displayName}</strong></td>
                    <td>${displayContact}</td>
                    <td>${c.city || '-'}</td>
                    <td onclick="event.stopPropagation()">${pricelist ? `<span onclick="goToPricelistFromClient(${pricelist.id})" style="padding:4px 8px; background:var(--accent-warning)20; color:var(--accent-warning); border-radius:12px; font-size:11px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='var(--accent-warning)'; this.style.color='#000'" onmouseout="this.style.background='var(--accent-warning)20'; this.style.color='var(--accent-warning)'">${pricelist.name} (-${pricelist.discount}%)</span>` : '<span style="color:var(--text-muted);">Standard</span>'}</td>
                    <td>${c.phone || c.mobile || '-'}</td>
                    <td onclick="event.stopPropagation()">
                        <div style="display:flex; gap:6px;">
                            <button class="btn btn-primary" style="padding:6px 10px; font-size:12px;" onclick="startOrderFromClient(${c.id})" title="Nouvelle commande">⚡</button>
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="editClientPage(${c.id})" title="Modifier">✏️</button>
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="toggleClientType(${c.id})">${type === 'b2c' ? '🏢' : '🏠'}</button>
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px; color:var(--accent-danger);" onclick="deleteClientPage(${c.id})">🗑️</button>
                        </div>
                    </td>
                </tr>
            `}).join('') || '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">Aucun client trouvé</td></tr>';
        }

        // Modal action client
        function showClientActionModal(clientId) {
            const client = QOData.clients.find(c => c.id === clientId);
            if (!client) return;

            const type = client.clientType || 'b2b';
            const typeIcon = type === 'b2c' ? '🏠' : '🏢';
            const typeLabel = type === 'b2c' ? 'Particulier' : 'Professionnel';
            const pricelist = client.pricelistId && typeof ArticlesData !== 'undefined' ?
                ArticlesData.pricelists?.find(p => p.id === client.pricelistId) : null;

            const modal = document.getElementById('client-action-modal');
            document.getElementById('client-action-name').textContent = client.name;
            document.getElementById('client-action-info').innerHTML = `
                <span style="padding:4px 10px; background:${type === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)'}20; color:${type === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)'}; border-radius:20px; font-size:12px;">${typeIcon} ${typeLabel}</span>
                ${pricelist ? `<span style="padding:4px 10px; background:var(--accent-warning)20; color:var(--accent-warning); border-radius:20px; font-size:12px; margin-left:8px;">💰 ${pricelist.name}</span>` : ''}
            `;
            document.getElementById('client-action-details').innerHTML = `
                <div style="font-size:13px; color:var(--text-muted);">
                    ${client.address ? `📍 ${client.address}, ${client.zip} ${client.city}` : ''}
                    ${client.phone ? `<br>📞 ${client.phone}` : ''}
                    ${client.email ? `<br>✉️ ${client.email}` : ''}
                </div>
            `;
            modal.dataset.clientId = clientId;
            modal.style.display = 'flex';
        }

        function closeClientActionModal() {
            document.getElementById('client-action-modal').style.display = 'none';
        }

        function startOrderFromClient(clientId) {
            closeClientActionModal();
            navigateTo('quickorder');
            setTimeout(() => {
                selectQOClient(clientId);
            }, 200);
        }

        function editClientFromModal() {
            const clientId = parseInt(document.getElementById('client-action-modal').dataset.clientId);
            closeClientActionModal();
            editClientPage(clientId);
        }

        // Naviguer vers la liste de prix depuis Clients
        function goToPricelistFromClient(pricelistId) {
            navigateTo('articles');
            setTimeout(() => {
                switchArtTab('pricelists');
                setTimeout(() => showPricelistClients(pricelistId), 200);
            }, 100);
        }

        function filterClientsPage(query) {
            const typeFilter = document.getElementById('clients-type-filter').value;
            renderClientsTable(query, typeFilter);
        }

        function showClientsForm() {
            document.getElementById('clients-form').style.display = 'block';
            document.getElementById('clients-edit-id').value = '';
            document.getElementById('clients-num').value = '';
            document.getElementById('clients-name').value = '';
            document.getElementById('clients-contact').value = '';
            document.getElementById('clients-type').value = 'b2b';
            document.getElementById('clients-address').value = '';
            document.getElementById('clients-address2').value = '';
            document.getElementById('clients-zip').value = '';
            document.getElementById('clients-city').value = '';
            document.getElementById('clients-phone').value = '';
            document.getElementById('clients-mobile').value = '';
            document.getElementById('clients-email').value = '';
            document.getElementById('clients-credit').value = '';
            document.getElementById('clients-payment').value = '30 jours fin de mois';
            document.getElementById('clients-pricelist').value = '';
            document.getElementById('clients-form').scrollIntoView({ behavior: 'smooth' });
        }

        function hideClientsForm() {
            document.getElementById('clients-form').style.display = 'none';
        }

        function editClientPage(id) {
            const c = QOData.clients.find(x => x.id === id);
            if (!c) return;

            document.getElementById('clients-form').style.display = 'block';
            document.getElementById('clients-edit-id').value = id;
            document.getElementById('clients-num').value = c.num || '';
            document.getElementById('clients-name').value = c.name || '';
            document.getElementById('clients-contact').value = c.contact || '';
            document.getElementById('clients-type').value = c.clientType || 'b2b';
            document.getElementById('clients-address').value = c.address || '';
            document.getElementById('clients-address2').value = c.address2 || '';
            document.getElementById('clients-zip').value = c.zip || '';
            document.getElementById('clients-city').value = c.city || '';
            document.getElementById('clients-phone').value = c.phone || '';
            document.getElementById('clients-mobile').value = c.mobile || '';
            document.getElementById('clients-email').value = c.email || '';
            document.getElementById('clients-credit').value = c.credit || '';
            document.getElementById('clients-payment').value = c.payment || '30 jours fin de mois';
            document.getElementById('clients-pricelist').value = c.pricelistId || '';
            document.getElementById('clients-form').scrollIntoView({ behavior: 'smooth' });
        }

        function saveClientForm() {
            const id = document.getElementById('clients-edit-id').value;
            const client = {
                id: id ? parseInt(id) : Date.now(),
                num: document.getElementById('clients-num').value.trim() || String(Date.now()).slice(-6),
                name: document.getElementById('clients-name').value.trim(),
                contact: document.getElementById('clients-contact').value.trim(),
                clientType: document.getElementById('clients-type').value,
                address: document.getElementById('clients-address').value.trim(),
                address2: document.getElementById('clients-address2').value.trim(),
                zip: document.getElementById('clients-zip').value.trim(),
                city: document.getElementById('clients-city').value.trim(),
                phone: document.getElementById('clients-phone').value.trim(),
                mobile: document.getElementById('clients-mobile').value.trim(),
                email: document.getElementById('clients-email').value.trim(),
                credit: parseFloat(document.getElementById('clients-credit').value) || 0,
                payment: document.getElementById('clients-payment').value,
                pricelistId: parseInt(document.getElementById('clients-pricelist').value) || null,
                ordersCount: 0,
                history: []
            };

            if (!client.name) {
                alert('Le nom/société est requis');
                return;
            }

            if (id) {
                const index = QOData.clients.findIndex(c => c.id === parseInt(id));
                if (index !== -1) {
                    client.ordersCount = QOData.clients[index].ordersCount || 0;
                    client.history = QOData.clients[index].history || [];
                    QOData.clients[index] = client;
                }
            } else {
                QOData.clients.push(client);
            }

            saveQOData('clients');

            // Upload sur Dropbox si configuré
            if (DropboxConfig.autoSync && DropboxConfig.token) {
                saveClientToDropbox(client);
            }

            hideClientsForm();
            renderClientsTable();
        }

        function deleteClientPage(id) {
            if (!confirm('Supprimer ce client ?')) return;
            QOData.clients = QOData.clients.filter(c => c.id !== id);
            saveQOData('clients');
            renderClientsTable();
        }

        function toggleClientType(id) {
            const client = QOData.clients.find(c => c.id === id);
            if (!client) return;
            client.clientType = (client.clientType || 'b2b') === 'b2c' ? 'b2b' : 'b2c';
            saveQOData('clients');
            renderClientsTable(document.getElementById('clients-search').value, document.getElementById('clients-type-filter').value);
        }

        function exportAllClientsCSV() {
            const headers = ['Numéro', 'Type', 'Nom', 'Contact', 'Adresse', 'Code postal', 'Ville', 'Téléphone', 'Mobile', 'Email', 'Crédit', 'Échéance', 'Commandes'];
            const rows = QOData.clients.map(c => [
                c.num, c.clientType || 'b2b', c.name, c.contact || '', c.address || '', c.zip || '', c.city || '', c.phone || '', c.mobile || '', c.email || '', c.credit || 0, c.payment || '', c.ordersCount || 0
            ].map(v => `"${v}"`).join(';'));

            const csv = [headers.join(';'), ...rows].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'clients_export_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
        }

        // Variable pour stocker le mode d'import sélectionné
        let clientsImportMode = 'replace';
        
        function showImportClientsModal() {
            document.getElementById('import-current-count').textContent = QOData.clients.length;
            selectImportMode('replace'); // Mode par défaut
            document.getElementById('import-clients-modal').style.display = 'flex';
        }
        
        function closeImportClientsModal() {
            document.getElementById('import-clients-modal').style.display = 'none';
        }
        
        function selectImportMode(mode) {
            clientsImportMode = mode;
            
            const replaceDiv = document.getElementById('import-mode-replace');
            const updateDiv = document.getElementById('import-mode-update');
            const checkReplace = document.getElementById('import-check-replace');
            const checkUpdate = document.getElementById('import-check-update');
            
            if (mode === 'replace') {
                replaceDiv.style.border = '2px solid var(--accent-primary)';
                replaceDiv.querySelector('div > div').style.background = 'var(--accent-primary)';
                checkReplace.style.display = 'flex';
                
                updateDiv.style.border = '2px solid var(--border-color)';
                updateDiv.querySelector('div > div').style.background = 'var(--bg-hover)';
                checkUpdate.style.display = 'none';
            } else {
                updateDiv.style.border = '2px solid var(--accent-primary)';
                updateDiv.querySelector('div > div').style.background = 'var(--accent-primary)';
                checkUpdate.style.display = 'flex';
                
                replaceDiv.style.border = '2px solid var(--border-color)';
                replaceDiv.querySelector('div > div').style.background = 'var(--bg-hover)';
                checkReplace.style.display = 'none';
            }
        }
        
        function confirmImportClients() {
            closeImportClientsModal();
            document.getElementById('clients-import-file').click();
        }

        function importClientsFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                let content = fixEncoding(e.target.result);
                const sep = content.includes(';') ? ';' : ',';
                const lines = content.split('\n').filter(l => l.trim());

                let added = 0;
                let updated = 0;
                let deleted = 0;
                
                // Mode "Remplacer tout" : vider les clients existants
                if (clientsImportMode === 'replace') {
                    deleted = QOData.clients.length;
                    QOData.clients = [];
                }
                
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(sep).map(c => c.replace(/"/g, '').trim());
                    if (cols.length >= 2 && cols[1]) {
                        const clientNum = cols[0] || '';
                        const clientName = cols[1] || cols[2] || 'Client importé';
                        
                        // Chercher si le client existe déjà (par numéro ou par nom)
                        let existingIndex = -1;
                        if (clientsImportMode === 'update') {
                            if (clientNum) {
                                existingIndex = QOData.clients.findIndex(c => c.num === clientNum);
                            }
                            if (existingIndex === -1) {
                                existingIndex = QOData.clients.findIndex(c => 
                                    c.name.toLowerCase().trim() === clientName.toLowerCase().trim()
                                );
                            }
                        }
                        
                        const clientData = {
                            num: clientNum || String(Date.now() + i).slice(-6),
                            name: clientName,
                            contact: cols[3] || '',
                            clientType: (cols[1] || '').toLowerCase().includes('b2c') ? 'b2c' : 'b2b',
                            address: cols[4] || '',
                            address2: cols[5] || '',
                            zip: cols[6] || '',
                            city: cols[7] || '',
                            phone: cols[8] || '',
                            mobile: cols[9] || '',
                            email: cols[10] || '',
                            credit: parseFloat(cols[11]) || 0,
                            payment: cols[12] || '30 jours fin de mois'
                        };
                        
                        if (existingIndex !== -1) {
                            // Mettre à jour le client existant (garder id, ordersCount, history)
                            QOData.clients[existingIndex] = {
                                ...QOData.clients[existingIndex],
                                ...clientData
                            };
                            updated++;
                        } else {
                            // Ajouter nouveau client
                            QOData.clients.push({
                                id: Date.now() + i,
                                ...clientData,
                                ordersCount: 0,
                                history: []
                            });
                            added++;
                        }
                    }
                }

                saveQOData('clients');
                renderClientsTable();
                
                // Message selon le mode
                let message = '✅ Import terminé !\n\n';
                if (clientsImportMode === 'replace') {
                    message += `🗑️ ${deleted} anciens clients supprimés\n`;
                    message += `📥 ${added} clients importés`;
                } else {
                    message += `📥 ${added} clients ajoutés\n`;
                    message += `🔄 ${updated} clients mis à jour`;
                }
                alert(message);
            };
            reader.readAsText(file, 'ISO-8859-1');
            input.value = '';
        }

        // =====================================================
        // MODULE ARTICLES
        // =====================================================

        function loadArticlesData() {
            const saved = localStorage.getItem('trakio_articles');
            if (saved) {
                const parsed = JSON.parse(saved);
                ArticlesData = { ...ArticlesData, ...parsed };
            }
            if (!ArticlesData.articles || ArticlesData.articles.length === 0) {
                loadDefaultArticles();
            }
        }

        function saveArticlesData(key) {
            localStorage.setItem('trakio_articles', JSON.stringify(ArticlesData));
            // Sync automatique vers Dropbox si activé
            if (DropboxConfig.autoSync && DropboxConfig.connected && !DropboxSync.isSyncing) {
                syncToDropbox('articles');
            }
        }

        function loadDefaultArticles() {
            ArticlesData.articles = [
                { id: 1, num: '001', name: 'Filet de perches du Léman', latin: 'Perca fluviatilis', categoryId: 1, origin: 'Suisse', lot: '', pcs: 1, unit: 'kg', priceB2C: 80.00, priceB2B: 65.00, cost: 45.00, tva: 2.6, active: true },
                { id: 2, num: '002', name: 'Filet de féra', latin: 'Coregonus fera', categoryId: 1, origin: 'Lac Léman', lot: '', pcs: 1, unit: 'kg', priceB2C: 55.00, priceB2B: 45.00, cost: 32.00, tva: 2.6, active: true },
                { id: 3, num: '003', name: 'Omble chevalier entier', latin: 'Salvelinus alpinus', categoryId: 1, origin: 'Suisse', lot: '', pcs: 1, unit: 'kg', priceB2C: 48.00, priceB2B: 38.00, cost: 28.00, tva: 2.6, active: true },
                { id: 4, num: '004', name: 'Truite arc-en-ciel', latin: 'Oncorhynchus mykiss', categoryId: 1, origin: 'Suisse', lot: '', pcs: 1, unit: 'kg', priceB2C: 22.00, priceB2B: 18.00, cost: 12.00, tva: 2.6, active: true },
                { id: 5, num: '005', name: 'Bar de ligne', latin: 'Dicentrarchus labrax', categoryId: 1, origin: 'FAO27', lot: '', pcs: 1, unit: 'kg', priceB2C: 65.00, priceB2B: 52.00, cost: 38.00, tva: 2.6, active: true },
                { id: 6, num: '006', name: 'Dorade royale', latin: 'Sparus aurata', categoryId: 1, origin: 'Méditerranée', lot: '', pcs: 1, unit: 'kg', priceB2C: 32.00, priceB2B: 26.00, cost: 18.00, tva: 2.6, active: true },
                { id: 7, num: '010', name: 'Crevettes roses cuites', latin: 'Penaeus vannamei', categoryId: 2, origin: 'Équateur', lot: '', pcs: 1, unit: 'kg', priceB2C: 28.00, priceB2B: 22.00, cost: 15.00, tva: 2.6, active: true },
                { id: 8, num: '011', name: 'Gambas crues 16/20', latin: 'Penaeus monodon', categoryId: 2, origin: 'Madagascar', lot: '', pcs: 16, unit: 'kg', priceB2C: 38.00, priceB2B: 30.00, cost: 22.00, tva: 2.6, active: true },
                { id: 9, num: '012', name: 'Homard bleu vivant', latin: 'Homarus gammarus', categoryId: 2, origin: 'Bretagne', lot: '', pcs: 1, unit: 'pce', priceB2C: 75.00, priceB2B: 60.00, cost: 42.00, tva: 2.6, active: true },
                { id: 10, num: '020', name: 'Huîtres Gillardeau n°3', latin: 'Crassostrea gigas', categoryId: 3, origin: 'France', lot: '', pcs: 12, unit: 'dz', priceB2C: 36.00, priceB2B: 28.00, cost: 18.00, tva: 2.6, active: true },
                { id: 11, num: '021', name: 'Moules de bouchot', latin: 'Mytilus edulis', categoryId: 3, origin: 'Mont St-Michel', lot: '', pcs: 1, unit: 'kg', priceB2C: 8.50, priceB2B: 6.80, cost: 4.50, tva: 2.6, active: true },
                { id: 12, num: '022', name: 'Saint-Jacques avec corail', latin: 'Pecten maximus', categoryId: 3, origin: 'Normandie', lot: '', pcs: 1, unit: 'pce', priceB2C: 6.50, priceB2B: 5.20, cost: 3.50, tva: 2.6, active: true },
                { id: 13, num: '030', name: 'Saumon fumé tranché', latin: 'Salmo salar', categoryId: 4, origin: 'Écosse', lot: '', pcs: 1, unit: 'kg', priceB2C: 58.00, priceB2B: 46.00, cost: 32.00, tva: 2.6, active: true },
                { id: 14, num: '031', name: 'Truite fumée filet', latin: 'Oncorhynchus mykiss', categoryId: 4, origin: 'Suisse', lot: '', pcs: 1, unit: 'kg', priceB2C: 48.00, priceB2B: 38.00, cost: 26.00, tva: 2.6, active: true },
                { id: 15, num: '050', name: 'Huile olive vierge extra', latin: '', categoryId: 8, origin: 'Espagne', lot: '', pcs: 1, unit: 'pce', priceB2C: 18.00, priceB2B: 14.00, cost: 9.00, tva: 2.6, active: true },
                { id: 16, num: '051', name: 'Citrons bio (filet 500g)', latin: '', categoryId: 8, origin: 'Sicile', lot: '', pcs: 1, unit: 'pce', priceB2C: 4.50, priceB2B: 3.50, cost: 2.00, tva: 2.6, active: true }
            ];
            saveArticlesData();
        }

        function initArticlesModule() {
            loadArticlesData();
            updateCategorySelects();
            updatePricelistSelects();
            renderArticlesTable();
            renderCategoriesGrid();
            renderPricelistsGrid();
            renderDiscountsGrid();
            updateArticleStats();
        }

        function switchArtTab(tabName) {
            document.querySelectorAll('.art-tab').forEach(t => {
                t.style.background = 'var(--bg-card)';
                t.style.color = 'var(--text-primary)';
                t.style.border = '1px solid var(--border-color)';
                t.classList.remove('active');
            });
            document.querySelectorAll('.art-tab-content').forEach(c => c.style.display = 'none');

            const activeTab = document.querySelector(`.art-tab[onclick*="${tabName}"]`);
            if (activeTab) {
                activeTab.style.background = 'var(--accent-primary)';
                activeTab.style.color = '#000';
                activeTab.style.border = 'none';
                activeTab.classList.add('active');
            }
            document.getElementById(`art-tab-${tabName}`).style.display = 'block';
        }

        function updateArticleStats() {
            document.getElementById('art-total').textContent = ArticlesData.articles.length;
            document.getElementById('art-categories-count').textContent = ArticlesData.categories.length;
            document.getElementById('art-pricelists-count').textContent = ArticlesData.pricelists.length;
            document.getElementById('art-discounts-count').textContent = ArticlesData.discounts.length;
        }

        function updateCategorySelects() {
            const options = '<option value="">-- Choisir --</option>' + ArticlesData.categories.map(c =>
                `<option value="${c.id}">${c.icon} ${c.name}</option>`
            ).join('');

            const artCat = document.getElementById('art-category');
            const discCat = document.getElementById('disc-category');
            const filterCat = document.getElementById('art-cat-filter');

            if (artCat) artCat.innerHTML = options;
            if (discCat) discCat.innerHTML = options;
            if (filterCat) filterCat.innerHTML = '<option value="">Toutes catégories</option>' + ArticlesData.categories.map(c =>
                `<option value="${c.id}">${c.icon} ${c.name}</option>`
            ).join('');
        }

        function updatePricelistSelects() {
            const discPl = document.getElementById('disc-pricelist');
            if (discPl) {
                discPl.innerHTML = '<option value="">Toutes les listes</option>' + ArticlesData.pricelists.map(p =>
                    `<option value="${p.id}">${p.name} (${p.discount}%)</option>`
                ).join('');
            }
        }

        // === ARTICLES ===
        function renderArticlesTable() {
            let articles = ArticlesData.articles;
            const search = document.getElementById('art-search')?.value.toLowerCase() || '';
            const catFilter = document.getElementById('art-cat-filter')?.value || '';

            if (search) {
                articles = articles.filter(a =>
                    a.num.toLowerCase().includes(search) ||
                    a.name.toLowerCase().includes(search) ||
                    (a.latin && a.latin.toLowerCase().includes(search)) ||
                    (a.origin && a.origin.toLowerCase().includes(search)) ||
                    (a.barcode && a.barcode.toLowerCase().includes(search))
                );
            }
            if (catFilter) {
                articles = articles.filter(a => a.categoryId == catFilter);
            }

            const tbody = document.getElementById('art-tbody');
            tbody.innerHTML = articles.map(a => {
                const stock = a.stock || 0;
                const stockColor = stock <= 0 ? 'var(--accent-danger)' : stock < 10 ? 'var(--accent-warning)' : 'var(--accent-primary)';
                const unit = a.unit === 'kg' ? 'kg' : a.unit === 'pce' ? 'pce' : a.unit;
                return `
                <tr style="opacity:${a.active !== false ? 1 : 0.5}">
                    <td><strong style="color:var(--accent-orange); font-family:monospace;">${a.num}</strong></td>
                    <td>
                        <div><strong>${a.name}</strong></div>
                        ${a.latin ? `<div style="font-size:11px; font-style:italic; color:var(--text-muted);">${a.latin}</div>` : ''}
                        ${a.barcode ? `<div style="font-size:10px; color:var(--text-muted); font-family:monospace;">🔖 ${a.barcode}</div>` : ''}
                    </td>
                    <td style="font-size:12px;">${a.origin || '-'}</td>
                    <td>${unit}</td>
                    <td style="font-weight:600; color:var(--accent-warning);">${(a.priceB2C || 0).toFixed(2)}</td>
                    <td style="color:var(--text-muted);">${(a.cost || 0).toFixed(2)}</td>
                    <td style="font-weight:600; color:${stockColor};">${stock.toFixed(1)}</td>
                    <td>
                        <div style="display:flex; gap:4px;">
                            <button onclick="editArticle(${a.id})" style="padding:4px 8px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:4px; cursor:pointer;">✏️</button>
                            <button onclick="deleteArticle(${a.id})" style="padding:4px 8px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:4px; cursor:pointer; color:var(--accent-danger);">🗑️</button>
                        </div>
                    </td>
                </tr>
            `}).join('') || '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">Aucun article</td></tr>';

            updateArticleStats();
        }

        function filterArticles() {
            renderArticlesTable();
        }

        function showArticleForm() {
            document.getElementById('art-form').style.display = 'block';
            document.getElementById('art-edit-id').value = '';
            // Pré-remplir avec le prochain numéro d'article
            const nextNum = `${NumberingConfig.article.prefix}-${NumberingConfig.article.next}`;
            document.getElementById('art-num').value = nextNum;
            document.getElementById('art-name').value = '';
            document.getElementById('art-latin').value = '';
            document.getElementById('art-category').value = '';
            document.getElementById('art-origin').value = '';
            document.getElementById('art-lot').value = '';
            document.getElementById('art-pcs').value = '';
            document.getElementById('art-unit').value = 'kg';
            document.getElementById('art-price-b2c').value = '';
            document.getElementById('art-price-b2b').value = '';
            document.getElementById('art-cost').value = '';
            document.getElementById('art-tva').value = '2.6';
            document.getElementById('art-stock').value = '';
            document.getElementById('art-stock-default').value = '';
            document.getElementById('art-tva-code').value = '';
            document.getElementById('art-barcode').value = '';
            document.getElementById('art-active').checked = true;
            document.getElementById('art-form').scrollIntoView({ behavior: 'smooth' });
        }

        function hideArticleForm() {
            document.getElementById('art-form').style.display = 'none';
        }

        function editArticle(id) {
            const a = ArticlesData.articles.find(x => x.id === id);
            if (!a) return;

            document.getElementById('art-form').style.display = 'block';
            document.getElementById('art-edit-id').value = id;
            document.getElementById('art-num').value = a.num || '';
            document.getElementById('art-name').value = a.name || '';
            document.getElementById('art-latin').value = a.latin || '';
            document.getElementById('art-category').value = a.categoryId || '';
            document.getElementById('art-origin').value = a.origin || '';
            document.getElementById('art-lot').value = a.lot || '';
            document.getElementById('art-pcs').value = a.pcs || '';
            document.getElementById('art-unit').value = a.unit || 'kg';
            document.getElementById('art-price-b2c').value = a.priceB2C || '';
            document.getElementById('art-price-b2b').value = a.priceB2B || '';
            document.getElementById('art-cost').value = a.cost || '';
            document.getElementById('art-tva').value = a.tva || 2.6;
            document.getElementById('art-stock').value = a.stock || '';
            document.getElementById('art-stock-default').value = a.stockDefault || '';
            document.getElementById('art-tva-code').value = a.tvaCode || '';
            document.getElementById('art-barcode').value = a.barcode || '';
            document.getElementById('art-active').checked = a.active !== false;
            document.getElementById('art-form').scrollIntoView({ behavior: 'smooth' });
        }

        function saveArticle() {
            const id = document.getElementById('art-edit-id').value;
            const article = {
                id: id ? parseInt(id) : Date.now(),
                num: document.getElementById('art-num').value.trim(),
                name: document.getElementById('art-name').value.trim(),
                latin: document.getElementById('art-latin').value.trim(),
                categoryId: parseInt(document.getElementById('art-category').value) || null,
                origin: document.getElementById('art-origin').value.trim(),
                lot: document.getElementById('art-lot').value.trim(),
                pcs: parseInt(document.getElementById('art-pcs').value) || 1,
                unit: document.getElementById('art-unit').value,
                priceB2C: parseFloat(document.getElementById('art-price-b2c').value) || 0,
                priceB2B: parseFloat(document.getElementById('art-price-b2b').value) || 0,
                cost: parseFloat(document.getElementById('art-cost').value) || 0,
                tva: parseFloat(document.getElementById('art-tva').value) || 2.6,
                stock: parseFloat(document.getElementById('art-stock').value) || 0,
                stockDefault: parseFloat(document.getElementById('art-stock-default').value) || 0,
                tvaCode: document.getElementById('art-tva-code').value.trim(),
                barcode: document.getElementById('art-barcode').value.trim(),
                active: document.getElementById('art-active').checked
            };

            if (!article.num || !article.name) {
                alert('N° article et désignation requis');
                return;
            }

            if (id) {
                const idx = ArticlesData.articles.findIndex(a => a.id === parseInt(id));
                if (idx !== -1) ArticlesData.articles[idx] = article;
            } else {
                ArticlesData.articles.push(article);
                // Incrémenter le compteur d'article si le numéro correspond au format auto
                if (article.num.startsWith(NumberingConfig.article.prefix + '-')) {
                    NumberingConfig.article.next++;
                    localStorage.setItem('num_article_next', NumberingConfig.article.next);
                }
            }

            saveArticlesData();

            // Upload sur Dropbox si configuré
            if (DropboxConfig.autoSync && DropboxConfig.token) {
                saveArticleToDropbox(article);
            }

            hideArticleForm();
            renderArticlesTable();
        }

        function deleteArticle(id) {
            if (!confirm('Supprimer cet article ?')) return;
            ArticlesData.articles = ArticlesData.articles.filter(a => a.id !== id);
            saveArticlesData();
            renderArticlesTable();
        }

        function exportArticlesCSV() {
            // Format compatible avec le fichier de gestion existant
            const headers = ['Numéro article', 'Description', 'Nom 2 français', 'Unité de la quantité', 'PV hors TVA', 'PV inclus TVA', 'Stock actuel', 'PA hors TVA', 'PA inclus TVA', 'Quantité achetée', 'Stock par défaut', 'Code TVA - Recettes', 'Code barre'];

            const rows = ArticlesData.articles.map(a => {
                const tvaRate = (a.tva || 2.6) / 100;
                const pvTTC = a.priceB2C ? (a.priceB2C * (1 + tvaRate)).toFixed(2) + '  CHF' : '';
                const pvHT = a.priceB2C ? a.priceB2C.toFixed(2) + '  CHF' : '';
                const paTTC = a.cost ? (a.cost * (1 + tvaRate)).toFixed(2) + '  CHF' : '';
                const paHT = a.cost ? a.cost.toFixed(2) + '  CHF' : '';

                // Mapper l'unité
                let unite = a.unit || 'Pièce';
                if (unite === 'kg') unite = 'Kilo';
                if (unite === 'pce') unite = 'Pièce';
                if (unite === 'l') unite = 'Litre';

                return [
                    a.num || '',                          // Numéro article
                    a.name || '',                         // Description
                    a.origin || a.latin || '',            // Nom 2 français (origine/info complémentaire)
                    unite,                                // Unité
                    pvHT,                                 // PV hors TVA
                    pvTTC,                                // PV inclus TVA
                    a.stock !== undefined ? a.stock : '', // Stock actuel
                    paHT,                                 // PA hors TVA
                    paTTC,                                // PA inclus TVA
                    a.qtyPurchased || '',                 // Quantité achetée
                    a.stockDefault || '',                 // Stock par défaut
                    a.tvaCode || '',                      // Code TVA
                    a.barcode || ''                       // Code barre
                ].map(v => `${v}`).join(';');
            });

            const csv = [headers.join(';'), ...rows].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Articles_export_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
        }

        function importArticlesFile(input) {
            const file = input.files[0];
            if (!file) return;

            // Essayer d'abord en ISO-8859-1 (Latin1) car la plupart des fichiers Excel/anciens sont dans ce format
            const reader = new FileReader();
            reader.onload = function(e) {
                let content = e.target.result;

                // Nettoyer les caractères spéciaux mal encodés
                content = fixEncoding(content);

                const lines = content.split('\n').filter(l => l.trim());
                let added = 0, updated = 0;

                // Détecter le format (mon format ou format externe)
                const header = lines[0].toLowerCase();
                const isExternalFormat = header.includes('pv hors tva') || header.includes('num') || header.includes('article');

                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(';').map(c => c.replace(/"/g, '').trim());
                    if (cols.length < 2 || !cols[1]) continue;

                    // Parser les prix (enlever "CHF" et espaces)
                    const parsePrice = (str) => {
                        if (!str) return 0;
                        return parseFloat(str.replace(/CHF/gi, '').replace(/\s/g, '').replace(',', '.')) || 0;
                    };

                    // Mapper l'unité
                    let unit = (cols[3] || 'pce').toLowerCase();
                    if (unit.includes('kilo') || unit === 'kg') unit = 'kg';
                    else if (unit.includes('pièce') || unit.includes('piece') || unit.includes('piè') || unit === 'pi') unit = 'pce';
                    else if (unit.includes('litre')) unit = 'l';
                    else if (unit.includes('heure')) unit = 'h';
                    else if (unit.includes('p.pers') || unit.includes('pers')) unit = 'pers';
                    else if (unit.includes('unit')) unit = 'pce';
                    else unit = 'pce';

                    const articleData = {
                        num: cols[0] || String(Date.now() + i).slice(-6),
                        name: cols[1],
                        origin: cols[2] || '',                    // Nom 2 français = origine/complément
                        latin: '',
                        categoryId: null,
                        lot: '',
                        pcs: 1,
                        unit: unit,
                        priceB2C: parsePrice(cols[4]),            // PV hors TVA
                        priceB2B: parsePrice(cols[4]) * 0.85,     // Prix B2B = -15% par défaut
                        cost: parsePrice(cols[7]),                // PA hors TVA
                        stock: parseFloat(cols[6]) || 0,          // Stock actuel
                        stockDefault: parseFloat(cols[10]) || 0,  // Stock par défaut
                        tvaCode: cols[11] || '',                  // Code TVA
                        barcode: cols[12] || '',                  // Code barre
                        tva: 2.6,
                        active: true
                    };

                    // Vérifier si l'article existe déjà (par numéro)
                    const existingIdx = ArticlesData.articles.findIndex(a => a.num === articleData.num);
                    if (existingIdx !== -1) {
                        // Mettre à jour l'article existant (conserver l'ID)
                        articleData.id = ArticlesData.articles[existingIdx].id;
                        ArticlesData.articles[existingIdx] = articleData;
                        updated++;
                    } else {
                        // Ajouter un nouvel article
                        articleData.id = Date.now() + i;
                        ArticlesData.articles.push(articleData);
                        added++;
                    }
                }

                saveArticlesData();
                renderArticlesTable();
                updateArticleStats();

                let msg = `✅ Import terminé !\n\n`;
                if (added > 0) msg += `📦 ${added} nouveaux articles ajoutés\n`;
                if (updated > 0) msg += `🔄 ${updated} articles mis à jour`;
                alert(msg);
            };
            // Lire en ISO-8859-1 (Latin1) pour bien gérer les accents français
            reader.readAsText(file, 'ISO-8859-1');
            input.value = '';
        }

        // Fonction pour corriger les problèmes d'encodage
        function fixEncoding(str) {
            // Remplacements pour les caractères mal encodés
            const replacements = {
                // Caractères courants mal encodés
                'Ã©': 'é', 'Ã¨': 'è', 'Ãª': 'ê', 'Ã«': 'ë',
                'Ã ': 'à', 'Ã¢': 'â', 'Ã¤': 'ä',
                'Ã¹': 'ù', 'Ã»': 'û', 'Ã¼': 'ü',
                'Ã®': 'î', 'Ã¯': 'ï', 'Ã´': 'ô',
                'Ã§': 'ç', 'Å"': 'œ', 'Ã': 'à',
                'â€™': "'", 'â€"': '-', 'â€œ': '"', 'â€': '"',
                '\\x84': '"', '\\x93': '"', '\\x94': '"',
                '\\x91': "'", '\\x92': "'",
                '\\xe9': 'é', '\\xe8': 'è', '\\xea': 'ê', '\\xeb': 'ë',
                '\\xe0': 'à', '\\xe2': 'â', '\\xe4': 'ä',
                '\\xf9': 'ù', '\\xfb': 'û', '\\xfc': 'ü',
                '\\xee': 'î', '\\xef': 'ï', '\\xf4': 'ô',
                '\\xe7': 'ç', '\\xf1': 'ñ'
            };

            for (const [bad, good] of Object.entries(replacements)) {
                str = str.split(bad).join(good);
            }

            return str;
        }

        // =====================================================
        // SAUVEGARDE MANUELLE DROPBOX
        // =====================================================

        async function saveAllArticlesToDropbox() {
            if (!DropboxConfig.token) {
                alert('❌ Dropbox non configuré.\n\nAllez dans Paramètres > Dropbox pour configurer votre token.');
                return;
            }

            // Tester la connexion d'abord
            const testOk = await testDropboxConnection(true);
            if (!testOk) {
                alert('❌ Token Dropbox invalide ou expiré.\n\nGénérez un nouveau token dans la console Dropbox.');
                return;
            }

            const basePath = DropboxConfig.basePath;
            let success = 0, errors = 0;

            // Afficher progression
            const total = ArticlesData.articles.length + 1;

            // Sauvegarder le fichier complet
            const allArticlesJson = JSON.stringify(ArticlesData, null, 2);
            const allResult = await uploadToDropboxDirect(basePath + '/Articles/_all_articles.json', allArticlesJson);
            if (allResult) success++;
            else errors++;

            // Sauvegarder chaque article individuellement
            for (const article of ArticlesData.articles) {
                const fileName = article.num + '_' + article.name.replace(/[^a-zA-Z0-9àâäéèêëïîôùûüç]/gi, '_').substring(0, 30) + '.json';
                const result = await uploadToDropboxDirect(basePath + '/Articles/' + fileName, JSON.stringify(article, null, 2));
                if (result) success++;
                else errors++;
            }

            if (errors === 0) {
                alert(`✅ Articles sauvegardés sur Dropbox !\n\n📦 ${ArticlesData.articles.length} articles\n📁 ${basePath}/Articles/`);
            } else {
                alert(`⚠️ Sauvegarde partielle\n\n✅ ${success} fichiers OK\n❌ ${errors} erreurs`);
            }
        }

        async function saveAllClientsToDropbox() {
            if (!DropboxConfig.token) {
                alert('❌ Dropbox non configuré.\n\nAllez dans Paramètres > Dropbox pour configurer votre token.');
                return;
            }

            // Tester la connexion d'abord
            const testOk = await testDropboxConnection(true);
            if (!testOk) {
                alert('❌ Token Dropbox invalide ou expiré.\n\nGénérez un nouveau token dans la console Dropbox.');
                return;
            }

            const basePath = DropboxConfig.basePath;
            let success = 0, errors = 0;

            // Sauvegarder le fichier complet
            const allClientsJson = JSON.stringify(QOData.clients, null, 2);
            const allResult = await uploadToDropboxDirect(basePath + '/Clients/_all_clients.json', allClientsJson);
            if (allResult) success++;
            else errors++;

            // Sauvegarder chaque client individuellement
            for (const client of QOData.clients) {
                const fileName = client.num + '_' + client.name.replace(/[^a-zA-Z0-9àâäéèêëïîôùûüç]/gi, '_').substring(0, 30) + '.json';
                const result = await uploadToDropboxDirect(basePath + '/Clients/' + fileName, JSON.stringify(client, null, 2));
                if (result) success++;
                else errors++;
            }

            if (errors === 0) {
                alert(`✅ Clients sauvegardés sur Dropbox !\n\n👥 ${QOData.clients.length} clients\n📁 ${basePath}/Clients/`);
            } else {
                alert(`⚠️ Sauvegarde partielle\n\n✅ ${success} fichiers OK\n❌ ${errors} erreurs`);
            }
        }

        // === CATÉGORIES ===
        function renderCategoriesGrid() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = ArticlesData.categories.map(c => {
                const count = ArticlesData.articles.filter(a => a.categoryId === c.id).length;
                return `
                <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; padding:20px; display:flex; align-items:center; gap:16px; cursor:pointer; transition:all 0.2s;" onclick="showCategoryArticles(${c.id})" onmouseover="this.style.borderColor='var(--accent-primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform=''">
                    <div style="font-size:40px;">${c.icon}</div>
                    <div style="flex:1;">
                        <div style="font-weight:700;">${c.name}</div>
                        <div style="font-size:12px; color:var(--text-muted);">Code: ${c.code}</div>
                        <span style="display:inline-block; margin-top:6px; font-size:11px; padding:4px 10px; background:var(--accent-primary)20; color:var(--accent-primary); border-radius:12px;">📦 ${count} article${count > 1 ? 's' : ''}</span>
                    </div>
                    <div style="display:flex; gap:6px;">
                        <button onclick="event.stopPropagation(); editCategory(${c.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">✏️</button>
                        <button onclick="event.stopPropagation(); deleteCategory(${c.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; color:var(--accent-danger);">🗑️</button>
                    </div>
                </div>
            `}).join('');
        }

        // Afficher les articles d'une catégorie
        function showCategoryArticles(categoryId) {
            const cat = ArticlesData.categories.find(c => c.id === categoryId);
            if (!cat) return;

            const articles = ArticlesData.articles.filter(a => a.categoryId === categoryId);

            const modal = document.getElementById('art-detail-modal');
            document.getElementById('art-detail-title').innerHTML = `${cat.icon} ${cat.name}`;
            document.getElementById('art-detail-subtitle').textContent = `${articles.length} article${articles.length > 1 ? 's' : ''} dans cette catégorie`;

            const content = document.getElementById('art-detail-content');
            if (articles.length === 0) {
                content.innerHTML = '<p style="text-align:center; color:var(--text-muted); padding:40px;">Aucun article dans cette catégorie</p>';
            } else {
                content.innerHTML = `
                    <table style="width:100%; font-size:13px;">
                        <thead>
                            <tr>
                                <th>N°</th>
                                <th>Désignation</th>
                                <th>Origine</th>
                                <th style="color:var(--accent-warning);">B2C</th>
                                <th style="color:var(--accent-secondary);">B2B</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${articles.map(a => `
                                <tr style="opacity:${a.active ? 1 : 0.5}">
                                    <td><strong style="color:var(--accent-orange);">${a.num}</strong></td>
                                    <td>
                                        <div><strong>${a.name}</strong></div>
                                        ${a.latin ? `<div style="font-size:11px; font-style:italic; color:var(--text-muted);">${a.latin}</div>` : ''}
                                    </td>
                                    <td>${a.origin || '-'}</td>
                                    <td style="font-weight:600; color:var(--accent-warning);">${a.priceB2C.toFixed(2)}</td>
                                    <td style="font-weight:600; color:var(--accent-secondary);">${a.priceB2B.toFixed(2)}</td>
                                    <td>
                                        <button onclick="closeArtDetailModal(); switchArtTab('articles'); setTimeout(() => editArticle(${a.id}), 200)" style="padding:4px 8px; background:var(--accent-primary); color:#000; border:none; border-radius:4px; cursor:pointer; font-size:11px;">Éditer →</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            modal.style.display = 'flex';
        }

        // Fermer le modal de détails
        function closeArtDetailModal() {
            document.getElementById('art-detail-modal').style.display = 'none';
        }

        function showCategoryForm() {
            document.getElementById('cat-form').style.display = 'block';
            document.getElementById('cat-edit-id').value = '';
            document.getElementById('cat-code').value = '';
            document.getElementById('cat-name').value = '';
            document.getElementById('cat-icon').value = '📦';
        }

        function hideCategoryForm() {
            document.getElementById('cat-form').style.display = 'none';
        }

        function editCategory(id) {
            const c = ArticlesData.categories.find(x => x.id === id);
            if (!c) return;
            document.getElementById('cat-form').style.display = 'block';
            document.getElementById('cat-edit-id').value = id;
            document.getElementById('cat-code').value = c.code || '';
            document.getElementById('cat-name').value = c.name || '';
            document.getElementById('cat-icon').value = c.icon || '📦';
        }

        function saveCategory() {
            const id = document.getElementById('cat-edit-id').value;
            const cat = {
                id: id ? parseInt(id) : Date.now(),
                code: document.getElementById('cat-code').value.trim().toUpperCase() || 'CAT' + Date.now(),
                name: document.getElementById('cat-name').value.trim(),
                icon: document.getElementById('cat-icon').value
            };
            if (!cat.name) { alert('Nom requis'); return; }

            if (id) {
                const idx = ArticlesData.categories.findIndex(c => c.id === parseInt(id));
                if (idx !== -1) ArticlesData.categories[idx] = cat;
            } else {
                ArticlesData.categories.push(cat);
            }
            saveArticlesData();
            hideCategoryForm();
            updateCategorySelects();
            renderCategoriesGrid();
            updateArticleStats();
        }

        function deleteCategory(id) {
            if (!confirm('Supprimer cette catégorie ?')) return;
            ArticlesData.categories = ArticlesData.categories.filter(c => c.id !== id);
            saveArticlesData();
            updateCategorySelects();
            renderCategoriesGrid();
            updateArticleStats();
        }

        // === LISTES DE PRIX ===
        function renderPricelistsGrid() {
            const grid = document.getElementById('pricelists-grid');
            grid.innerHTML = ArticlesData.pricelists.map(p => {
                const clientCount = (QOData.clients || []).filter(c => c.pricelistId === p.id).length;
                return `
                <div style="background:var(--bg-card); border:2px solid ${p.discount > 0 ? 'var(--accent-warning)' : 'var(--border-color)'}; border-radius:12px; padding:20px; cursor:pointer; transition:all 0.2s;" onclick="showPricelistClients(${p.id})" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                        <div>
                            <div style="font-weight:700; font-size:18px;">${p.name}</div>
                            <div style="font-size:12px; color:var(--text-muted);">Code: ${p.code}</div>
                        </div>
                        <div style="background:${p.discount > 0 ? 'var(--accent-warning)' : 'var(--bg-hover)'}; color:${p.discount > 0 ? '#000' : 'var(--text-primary)'}; padding:6px 12px; border-radius:20px; font-weight:700;">
                            -${p.discount}%
                        </div>
                    </div>
                    <p style="color:var(--text-muted); font-size:13px; margin-bottom:12px;">${p.desc || 'Aucune description'}</p>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:12px; padding:6px 12px; background:var(--accent-secondary)20; color:var(--accent-secondary); border-radius:20px; cursor:pointer;" onclick="event.stopPropagation(); showPricelistClients(${p.id})">👥 ${clientCount} client${clientCount > 1 ? 's' : ''}</span>
                        <div style="display:flex; gap:6px;">
                            <button onclick="event.stopPropagation(); editPricelist(${p.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">✏️</button>
                            <button onclick="event.stopPropagation(); deletePricelist(${p.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; color:var(--accent-danger);">🗑️</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Afficher les clients d'une liste de prix
        function showPricelistClients(pricelistId) {
            const pl = ArticlesData.pricelists.find(p => p.id === pricelistId);
            if (!pl) return;

            const clients = (QOData.clients || []).filter(c => c.pricelistId === pricelistId);

            const modal = document.getElementById('art-detail-modal');
            document.getElementById('art-detail-title').innerHTML = `💰 ${pl.name} <span style="font-size:14px; color:var(--text-muted);">(-${pl.discount}%)</span>`;
            document.getElementById('art-detail-subtitle').textContent = `${clients.length} client${clients.length > 1 ? 's' : ''} avec cette liste de prix`;

            const content = document.getElementById('art-detail-content');
            if (clients.length === 0) {
                content.innerHTML = '<p style="text-align:center; color:var(--text-muted); padding:40px;">Aucun client assigné à cette liste de prix</p>';
            } else {
                content.innerHTML = `
                    <table style="width:100%; font-size:13px;">
                        <thead>
                            <tr>
                                <th>N°</th>
                                <th>Type</th>
                                <th>Nom / Société</th>
                                <th>Ville</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clients.map(c => {
                                const type = c.clientType || 'b2b';
                                const typeIcon = type === 'b2c' ? '🏠' : '🏢';
                                const typeColor = type === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)';
                                return `
                                <tr>
                                    <td><strong style="color:var(--accent-orange);">${c.num || c.id}</strong></td>
                                    <td><span style="padding:3px 8px; background:${typeColor}20; color:${typeColor}; border-radius:12px; font-size:11px;">${typeIcon}</span></td>
                                    <td><strong>${c.name}</strong></td>
                                    <td>${c.city || '-'}</td>
                                    <td>
                                        <button onclick="closeArtDetailModal(); navigateTo('clients'); setTimeout(() => editClientPage(${c.id}), 200)" style="padding:4px 8px; background:var(--accent-primary); color:#000; border:none; border-radius:4px; cursor:pointer; font-size:11px;">Voir →</button>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                `;
            }

            modal.style.display = 'flex';
        }

        function showPricelistForm() {
            document.getElementById('pricelist-form').style.display = 'block';
            document.getElementById('pl-edit-id').value = '';
            document.getElementById('pl-code').value = '';
            document.getElementById('pl-name').value = '';
            document.getElementById('pl-discount').value = '0';
            document.getElementById('pl-desc').value = '';
        }

        function hidePricelistForm() {
            document.getElementById('pricelist-form').style.display = 'none';
        }

        function editPricelist(id) {
            const p = ArticlesData.pricelists.find(x => x.id === id);
            if (!p) return;
            document.getElementById('pricelist-form').style.display = 'block';
            document.getElementById('pl-edit-id').value = id;
            document.getElementById('pl-code').value = p.code || '';
            document.getElementById('pl-name').value = p.name || '';
            document.getElementById('pl-discount').value = p.discount || 0;
            document.getElementById('pl-desc').value = p.desc || '';
        }

        function savePricelist() {
            const id = document.getElementById('pl-edit-id').value;
            const pl = {
                id: id ? parseInt(id) : Date.now(),
                code: document.getElementById('pl-code').value.trim().toUpperCase() || 'PL' + Date.now(),
                name: document.getElementById('pl-name').value.trim(),
                discount: parseFloat(document.getElementById('pl-discount').value) || 0,
                desc: document.getElementById('pl-desc').value.trim()
            };
            if (!pl.name) { alert('Nom requis'); return; }

            if (id) {
                const idx = ArticlesData.pricelists.findIndex(p => p.id === parseInt(id));
                if (idx !== -1) ArticlesData.pricelists[idx] = pl;
            } else {
                ArticlesData.pricelists.push(pl);
            }
            saveArticlesData();
            hidePricelistForm();
            updatePricelistSelects();
            renderPricelistsGrid();
            updateArticleStats();
        }

        function deletePricelist(id) {
            if (!confirm('Supprimer cette liste de prix ?')) return;
            ArticlesData.pricelists = ArticlesData.pricelists.filter(p => p.id !== id);
            saveArticlesData();
            updatePricelistSelects();
            renderPricelistsGrid();
            updateArticleStats();
        }

        // === RABAIS ===
        function renderDiscountsGrid() {
            const grid = document.getElementById('discounts-grid');
            grid.innerHTML = ArticlesData.discounts.map(d => {
                const cat = ArticlesData.categories.find(c => c.id === d.categoryId);
                const pl = d.pricelistId ? ArticlesData.pricelists.find(p => p.id === d.pricelistId) : null;
                const tiersHtml = (d.tiers || []).map(t =>
                    `<span style="display:inline-block; padding:4px 10px; background:var(--bg-hover); border-radius:20px; font-size:12px; margin:2px;">Dès ${t.qty} pce → <strong>-${t.pct}%</strong></span>`
                ).join(' ');

                return `
                <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; padding:16px; margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <span style="font-size:24px;">${cat?.icon || '📦'}</span>
                            <div>
                                <div style="font-weight:700;">${cat?.name || 'Catégorie inconnue'}</div>
                                <div style="font-size:12px; color:var(--text-muted);">${pl ? `Liste: ${pl.name}` : 'Toutes les listes'}</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:6px;">
                            <button onclick="editDiscount(${d.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">✏️</button>
                            <button onclick="deleteDiscount(${d.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; color:var(--accent-danger);">🗑️</button>
                        </div>
                    </div>
                    <div>${tiersHtml || '<span style="color:var(--text-muted);">Aucun palier défini</span>'}</div>
                </div>
            `}).join('') || '<p style="color:var(--text-muted); text-align:center; padding:40px;">Aucune règle de rabais configurée</p>';
        }

        function showDiscountForm() {
            document.getElementById('discount-form').style.display = 'block';
            document.getElementById('disc-edit-id').value = '';
            document.getElementById('disc-category').value = '';
            document.getElementById('disc-pricelist').value = '';
            document.getElementById('disc-tiers').innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center;">
                    <input type="number" placeholder="Dès X pièces" class="disc-qty" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                    <input type="number" step="0.1" placeholder="% rabais" class="disc-pct" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                    <button type="button" onclick="removeDiscountTier(this)" style="padding:8px 12px; background:var(--accent-danger); color:#fff; border:none; border-radius:6px; cursor:pointer;">✕</button>
                </div>
            `;
        }

        function hideDiscountForm() {
            document.getElementById('discount-form').style.display = 'none';
        }

        function addDiscountTier() {
            const container = document.getElementById('disc-tiers');
            const div = document.createElement('div');
            div.style.cssText = 'display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center;';
            div.innerHTML = `
                <input type="number" placeholder="Dès X pièces" class="disc-qty" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                <input type="number" step="0.1" placeholder="% rabais" class="disc-pct" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                <button type="button" onclick="removeDiscountTier(this)" style="padding:8px 12px; background:var(--accent-danger); color:#fff; border:none; border-radius:6px; cursor:pointer;">✕</button>
            `;
            container.appendChild(div);
        }

        function removeDiscountTier(btn) {
            const rows = document.querySelectorAll('#disc-tiers > div');
            if (rows.length > 1) btn.parentElement.remove();
        }

        function editDiscount(id) {
            const d = ArticlesData.discounts.find(x => x.id === id);
            if (!d) return;

            document.getElementById('discount-form').style.display = 'block';
            document.getElementById('disc-edit-id').value = id;
            document.getElementById('disc-category').value = d.categoryId || '';
            document.getElementById('disc-pricelist').value = d.pricelistId || '';

            const container = document.getElementById('disc-tiers');
            container.innerHTML = (d.tiers || []).map(t => `
                <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center;">
                    <input type="number" placeholder="Dès X pièces" class="disc-qty" value="${t.qty}" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                    <input type="number" step="0.1" placeholder="% rabais" class="disc-pct" value="${t.pct}" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                    <button type="button" onclick="removeDiscountTier(this)" style="padding:8px 12px; background:var(--accent-danger); color:#fff; border:none; border-radius:6px; cursor:pointer;">✕</button>
                </div>
            `).join('') || `
                <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center;">
                    <input type="number" placeholder="Dès X pièces" class="disc-qty" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                    <input type="number" step="0.1" placeholder="% rabais" class="disc-pct" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                    <button type="button" onclick="removeDiscountTier(this)" style="padding:8px 12px; background:var(--accent-danger); color:#fff; border:none; border-radius:6px; cursor:pointer;">✕</button>
                </div>
            `;
        }

        function saveDiscount() {
            const id = document.getElementById('disc-edit-id').value;
            const categoryId = parseInt(document.getElementById('disc-category').value);
            if (!categoryId) { alert('Catégorie requise'); return; }

            const tiers = [];
            document.querySelectorAll('#disc-tiers > div').forEach(row => {
                const qty = parseInt(row.querySelector('.disc-qty').value);
                const pct = parseFloat(row.querySelector('.disc-pct').value);
                if (qty > 0 && pct > 0) tiers.push({ qty, pct });
            });
            tiers.sort((a, b) => a.qty - b.qty);

            const disc = {
                id: id ? parseInt(id) : Date.now(),
                categoryId: categoryId,
                pricelistId: parseInt(document.getElementById('disc-pricelist').value) || null,
                tiers: tiers
            };

            if (id) {
                const idx = ArticlesData.discounts.findIndex(d => d.id === parseInt(id));
                if (idx !== -1) ArticlesData.discounts[idx] = disc;
            } else {
                ArticlesData.discounts.push(disc);
            }
            saveArticlesData();
            hideDiscountForm();
            renderDiscountsGrid();
            updateArticleStats();
        }

        function deleteDiscount(id) {
            if (!confirm('Supprimer cette règle ?')) return;
            ArticlesData.discounts = ArticlesData.discounts.filter(d => d.id !== id);
            saveArticlesData();
            renderDiscountsGrid();
            updateArticleStats();
        }

        // Calcul du prix avec rabais
        function calculatePriceWithDiscount(article, qty, clientType, pricelistId) {
            let basePrice = clientType === 'b2c' ? article.priceB2C : article.priceB2B;

            // Appliquer remise liste de prix
            if (pricelistId) {
                const pl = ArticlesData.pricelists.find(p => p.id === pricelistId);
                if (pl && pl.discount > 0) {
                    basePrice = basePrice * (1 - pl.discount / 100);
                }
            }

            // Appliquer rabais quantité par catégorie
            const discount = ArticlesData.discounts.find(d =>
                d.categoryId === article.categoryId &&
                (!d.pricelistId || d.pricelistId === pricelistId)
            );

            if (discount && discount.tiers) {
                const applicableTier = discount.tiers
                    .filter(t => qty >= t.qty)
                    .sort((a, b) => b.qty - a.qty)[0];

                if (applicableTier) {
                    basePrice = basePrice * (1 - applicableTier.pct / 100);
                }
            }

            return basePrice;
        }

        // Init QuickOrder
        function initQuickOrder() {
            // Ne pas réinitialiser si on est en mode édition
            if (QOData.editingOrderId) {
                console.log('⏭️ Skip initQuickOrder - mode édition actif');
                return;
            }

            initQOSampleData();
            document.getElementById('qo-step-client').style.display = 'block';
            document.getElementById('qo-step-order').style.display = 'none';
            document.getElementById('qo-selected-client').style.display = 'none';
            document.getElementById('qo-btn-next-step').style.display = 'none';
            QOData.cart = [];
            QOData.selectedClient = null;
        }

        // ========================================
        // GESTION CLIENTS - Modal & CRUD
        // ========================================

        function openQOClientsModal() {
            renderQOClientsTable();
            document.getElementById('qo-clients-modal').style.display = 'flex';
        }

        function closeQOClientsModal() {
            document.getElementById('qo-clients-modal').style.display = 'none';
        }

        function renderQOClientsTable(filter = '') {
            const tbody = document.getElementById('qo-clients-tbody');
            let clients = QOData.clients;

            if (filter) {
                const q = filter.toLowerCase();
                clients = clients.filter(c =>
                    c.name.toLowerCase().includes(q) ||
                    (c.contact && c.contact.toLowerCase().includes(q)) ||
                    (c.city && c.city.toLowerCase().includes(q)) ||
                    (c.phone && c.phone.includes(q)) ||
                    (c.num && c.num.includes(q))
                );
            }

            const b2bCount = clients.filter(c => (c.clientType || 'b2b') === 'b2b').length;
            const b2cCount = clients.filter(c => c.clientType === 'b2c').length;

            document.getElementById('qo-clients-count').textContent = clients.length;
            document.getElementById('qo-clients-b2b').textContent = b2bCount;
            document.getElementById('qo-clients-b2c').textContent = b2cCount;

            tbody.innerHTML = clients.slice(0, 100).map(c => {
                const type = c.clientType || 'b2b';
                const typeIcon = type === 'b2c' ? '🏠' : '🏢';
                const typeColor = type === 'b2c' ? 'var(--accent-warning)' : 'var(--accent-secondary)';
                return `
                <tr>
                    <td><strong style="color:var(--accent-orange);">${c.num || c.id}</strong></td>
                    <td><span style="color:${typeColor};" title="${type === 'b2c' ? 'Particulier' : 'Professionnel'}">${typeIcon}</span></td>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.contact || '-'}</td>
                    <td>${c.city || '-'}</td>
                    <td>${c.phone || c.mobile || '-'}</td>
                    <td>${c.ordersCount || 0}</td>
                    <td>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="editQOClient(${c.id})">✏️</button>
                            <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px; color:var(--accent-danger);" onclick="deleteQOClient(${c.id})">🗑️</button>
                        </div>
                    </td>
                </tr>
            `}).join('') || '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">Aucun client</td></tr>';
        }

        function filterQOClientsTable(query) {
            renderQOClientsTable(query);
        }

        function showQOClientForm() {
            document.getElementById('qo-client-form').style.display = 'block';
            document.getElementById('qo-client-edit-id').value = '';
            document.getElementById('qo-client-num').value = '';
            document.getElementById('qo-client-company').value = '';
            document.getElementById('qo-client-contact').value = '';
            document.getElementById('qo-client-type').value = 'b2b';
            document.getElementById('qo-client-address').value = '';
            document.getElementById('qo-client-address2').value = '';
            document.getElementById('qo-client-zip').value = '';
            document.getElementById('qo-client-city').value = '';
            document.getElementById('qo-client-tel').value = '';
            document.getElementById('qo-client-mobile').value = '';
            document.getElementById('qo-client-email2').value = '';
            document.getElementById('qo-client-credit').value = '';
            document.getElementById('qo-client-payment').value = '30 jours fin de mois';
        }

        function hideQOClientForm() {
            document.getElementById('qo-client-form').style.display = 'none';
        }

        function editQOClient(id) {
            const c = QOData.clients.find(x => x.id === id);
            if (!c) return;

            document.getElementById('qo-client-form').style.display = 'block';
            document.getElementById('qo-client-edit-id').value = id;
            document.getElementById('qo-client-num').value = c.num || '';
            document.getElementById('qo-client-company').value = c.name || '';
            document.getElementById('qo-client-contact').value = c.contact || '';
            document.getElementById('qo-client-type').value = c.clientType || 'b2b';
            document.getElementById('qo-client-address').value = c.address || '';
            document.getElementById('qo-client-address2').value = c.address2 || '';
            document.getElementById('qo-client-zip').value = c.zip || '';
            document.getElementById('qo-client-city').value = c.city || '';
            document.getElementById('qo-client-tel').value = c.phone || '';
            document.getElementById('qo-client-mobile').value = c.mobile || '';
            document.getElementById('qo-client-email2').value = c.email || '';
            document.getElementById('qo-client-credit').value = c.credit || '';
            document.getElementById('qo-client-payment').value = c.payment || '30 jours fin de mois';
        }

        function saveQOClient() {
            const id = document.getElementById('qo-client-edit-id').value;
            const client = {
                id: id ? parseInt(id) : Date.now(),
                num: document.getElementById('qo-client-num').value.trim() || String(Date.now()).slice(-6),
                name: document.getElementById('qo-client-company').value.trim(),
                contact: document.getElementById('qo-client-contact').value.trim(),
                clientType: document.getElementById('qo-client-type').value,
                address: document.getElementById('qo-client-address').value.trim(),
                address2: document.getElementById('qo-client-address2').value.trim(),
                zip: document.getElementById('qo-client-zip').value.trim(),
                city: document.getElementById('qo-client-city').value.trim(),
                phone: document.getElementById('qo-client-tel').value.trim(),
                mobile: document.getElementById('qo-client-mobile').value.trim(),
                email: document.getElementById('qo-client-email2').value.trim(),
                credit: parseFloat(document.getElementById('qo-client-credit').value) || 0,
                payment: document.getElementById('qo-client-payment').value,
                ordersCount: 0,
                history: []
            };

            if (!client.name) {
                alert('Le nom/société est requis');
                return;
            }

            if (id) {
                const index = QOData.clients.findIndex(c => c.id === parseInt(id));
                if (index !== -1) {
                    client.ordersCount = QOData.clients[index].ordersCount || 0;
                    client.history = QOData.clients[index].history || [];
                    QOData.clients[index] = client;
                }
            } else {
                QOData.clients.push(client);
            }

            saveQOData('clients');
            hideQOClientForm();
            renderQOClientsTable();
        }

        function deleteQOClient(id) {
            if (!confirm('Supprimer ce client ?')) return;
            QOData.clients = QOData.clients.filter(c => c.id !== id);
            saveQOData('clients');
            renderQOClientsTable();
        }

        // ========================================
        // IMPORT / EXPORT CSV
        // ========================================

        function importQOClientsFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                let content = e.target.result;

                // Appliquer la correction d'encodage pour les fichiers CSV
                if (file.name.endsWith('.csv')) {
                    content = fixEncoding(content);
                    parseQOClientsCSV(content);
                } else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                    parseQOClientsXLS(e.target.result);
                }
            };

            if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                reader.readAsArrayBuffer(file);
            } else {
                // Lire en ISO-8859-1 (Latin1) pour les fichiers CSV avec accents
                reader.readAsText(file, 'ISO-8859-1');
            }

            input.value = ''; // Reset input
        }

        function parseQOClientsCSV(content) {
            const lines = content.split('\n');
            if (lines.length < 2) {
                alert('Fichier CSV vide ou invalide');
                return;
            }

            // Détecter le séparateur (virgule ou point-virgule)
            const separator = lines[0].includes(';') ? ';' : ',';

            // Parser le header pour trouver les colonnes
            const header = lines[0].split(separator).map(h => h.trim().toLowerCase().replace(/"/g, ''));

            // Mapping des colonnes possibles
            const colMap = {
                num: header.findIndex(h => h.includes('num') || h.includes('client') || h.includes('code')),
                name: header.findIndex(h => h.includes('nom') || h.includes('soci') || h.includes('name') || h.includes('company')),
                contact: header.findIndex(h => h.includes('pr') || h.includes('contact') || h.includes('firstname')),
                address: header.findIndex(h => h.includes('adresse 1') || h.includes('address') || h.includes('rue')),
                address2: header.findIndex(h => h.includes('adresse 2')),
                zip: header.findIndex(h => h.includes('postal') || h.includes('zip') || h.includes('cp')),
                city: header.findIndex(h => h.includes('ville') || h.includes('city') || h.includes('localit')),
                phone: header.findIndex(h => h.includes('phone 1') || h.includes('phone') || h.includes('tel') && !h.includes('portable')),
                mobile: header.findIndex(h => h.includes('portable') || h.includes('mobile') || h.includes('cell')),
                email: header.findIndex(h => h.includes('email') || h.includes('mail')),
                credit: header.findIndex(h => h.includes('cr') && h.includes('dit') || h.includes('limit')),
                payment: header.findIndex(h => h.includes('ch') && h.includes('ance') || h.includes('payment'))
            };

            let imported = 0;
            let updated = 0;

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const cols = line.split(separator).map(c => c.trim().replace(/^"|"$/g, ''));

                const clientNum = colMap.num >= 0 ? cols[colMap.num] : '';
                const clientName = colMap.name >= 0 ? cols[colMap.name] : '';

                if (!clientName) continue;

                const newClient = {
                    id: clientNum ? parseInt(clientNum) || Date.now() + i : Date.now() + i,
                    num: clientNum || String(Date.now() + i).slice(-6),
                    name: clientName,
                    contact: colMap.contact >= 0 ? cols[colMap.contact] || '' : '',
                    address: colMap.address >= 0 ? cols[colMap.address] || '' : '',
                    address2: colMap.address2 >= 0 ? cols[colMap.address2] || '' : '',
                    zip: colMap.zip >= 0 ? cols[colMap.zip] || '' : '',
                    city: colMap.city >= 0 ? cols[colMap.city] || '' : '',
                    phone: colMap.phone >= 0 ? cols[colMap.phone] || '' : '',
                    mobile: colMap.mobile >= 0 ? cols[colMap.mobile] || '' : '',
                    email: colMap.email >= 0 ? cols[colMap.email] || '' : '',
                    credit: colMap.credit >= 0 ? parseFloat(cols[colMap.credit]) || 0 : 0,
                    payment: colMap.payment >= 0 ? cols[colMap.payment] || '30 jours fin de mois' : '30 jours fin de mois',
                    ordersCount: 0,
                    history: []
                };

                // Vérifier si le client existe déjà (par numéro ou nom)
                const existingIndex = QOData.clients.findIndex(c =>
                    (c.num && c.num === newClient.num) ||
                    c.name.toLowerCase() === newClient.name.toLowerCase()
                );

                if (existingIndex >= 0) {
                    // Mettre à jour en préservant ordersCount et history
                    newClient.ordersCount = QOData.clients[existingIndex].ordersCount || 0;
                    newClient.history = QOData.clients[existingIndex].history || [];
                    newClient.id = QOData.clients[existingIndex].id;
                    QOData.clients[existingIndex] = newClient;
                    updated++;
                } else {
                    QOData.clients.push(newClient);
                    imported++;
                }
            }

            saveQOData('clients');
            renderQOClientsTable();
            alert(`Import terminé !\n${imported} clients ajoutés\n${updated} clients mis à jour`);
        }

        function parseQOClientsXLS(data) {
            if (typeof XLSX === 'undefined') {
                alert('Bibliothèque Excel non chargée. Utilisez un fichier CSV.');
                return;
            }

            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const csvContent = XLSX.utils.sheet_to_csv(firstSheet, { FS: ';' });
            parseQOClientsCSV(csvContent);
        }

        function exportQOClientsCSV() {
            const headers = ['Numéro de client', 'Nom/société', 'Prénom', 'Adresse 1', 'Adresse 2', 'Code postal', 'Ville', 'Téléphone 1', 'Portable', 'Email', 'Limite de crédit', 'Échéance', 'Nb commandes'];

            const rows = QOData.clients.map(c => [
                c.num || c.id,
                c.name || '',
                c.contact || '',
                c.address || '',
                c.address2 || '',
                c.zip || '',
                c.city || '',
                c.phone || '',
                c.mobile || '',
                c.email || '',
                c.credit || 0,
                c.payment || '30 jours fin de mois',
                c.ordersCount || 0
            ]);

            const csvContent = [headers.join(';'), ...rows.map(r => r.map(v => `"${v}"`).join(';'))].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'clients_export_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function downloadQOImportTemplate() {
            const headers = ['Numéro de client', 'Nom/société', 'Prénom', 'Adresse 1', 'Adresse 2', 'Code postal', 'Ville', 'Téléphone 1', 'Portable', 'Email', 'Limite de crédit', 'Échéance'];
            const example = ['123456', 'Restaurant Example', 'Jean Dupont', 'Rue de la Gare 15', '', '1260', 'Nyon', '022 123 45 67', '079 123 45 67', 'contact@example.ch', '2000', '30 jours fin de mois'];

            const csvContent = [headers.join(';'), example.map(v => `"${v}"`).join(';')].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'modele_import_clients.csv';
            link.click();
        }

        function resetQOClientsToDefault() {
            if (!confirm('⚠️ Réinitialiser la base clients avec les 277 clients par défaut ?\n\nCette action remplacera tous les clients actuels.')) return;
            loadQODefaultClients();
            renderQOClientsTable();
            alert('✅ Base clients réinitialisée avec 277 clients !');
        }

        // Auto-init when QuickOrder tab is clicked
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.dataset.page === 'quickorder') {
                    setTimeout(initQuickOrder, 100);
                }
            });
        });

        // Init ArticlesData and QOData on page load
        loadArticlesData();

        // Charger les clients au démarrage si pas dans localStorage
        if (!QOData.clients || QOData.clients.length < 50) {
            loadQODefaultClients();
        }

        // Close modals on click outside
        document.addEventListener('click', function(e) {
            if (e.target.id === 'qo-client-results') return;
            if (!e.target.closest('#qo-client-search') && !e.target.closest('#qo-client-results')) {
                document.getElementById('qo-client-results').style.display = 'none';
            }
        });

        // =====================================================
        // BARRE FLOTTANTE COMMANDE EN COURS
        // =====================================================

        function updateOrderFloatingBar() {
            const bar = document.getElementById('floating-order-bar');
            const currentPage = document.querySelector('.module-page[style*="display: block"]')?.id?.replace('page-', '') || 'dashboard';

            // Cacher si on est sur QuickOrder ou si pas de commande en cours
            if (currentPage === 'quickorder' || (!QOData.selectedClient && QOData.cart.length === 0)) {
                bar.style.display = 'none';
                return;
            }

            // Calculer le total
            let total = 0;
            QOData.cart.forEach(item => total += item.total);
            const tva = total * 0.026;
            const ttc = total + tva;

            // Mettre à jour le contenu
            const clientName = QOData.selectedClient ? QOData.selectedClient.name : 'Client non sélectionné';

            document.getElementById('floating-order-client').textContent = clientName;
            document.getElementById('floating-order-total').textContent = ttc.toFixed(2);

            bar.style.display = 'block';
        }

        function goToCurrentOrder() {
            closeFinalizeModal();
            navigateTo('quickorder');
        }

        function hideFloatingOrderBar() {
            const bar = document.getElementById('floating-order-bar');
            bar.style.display = 'none';
            // Mémoriser que l'utilisateur a fermé la barre
            sessionStorage.setItem('floatingBarHidden', 'true');
        }

        function showFloatingOrderBarIfNeeded() {
            // Si l'utilisateur a fermé manuellement, ne pas réafficher
            if (sessionStorage.getItem('floatingBarHidden') === 'true') return;
            updateOrderFloatingBar();
        }

        // =====================================================
        // MODAL FINALISATION
        // =====================================================

        function showFinalizeModal() {
            if (!QOData.selectedClient || QOData.cart.length === 0) {
                alert('Aucune commande en cours');
                return;
            }

            const client = QOData.selectedClient;
            const type = client.clientType || 'b2b';

            // Client info
            document.getElementById('finalize-client-icon').textContent = type === 'b2c' ? '🏠' : '🏢';
            document.getElementById('finalize-client-name').textContent = client.name;
            document.getElementById('finalize-client-info').innerHTML = `
                ${client.address ? client.address + ', ' : ''}${client.zip || ''} ${client.city || ''}
                ${client.phone ? '<br>📞 ' + client.phone : ''}
            `;

            // Articles list
            const itemsList = document.getElementById('finalize-items-list');
            itemsList.innerHTML = QOData.cart.map(item => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--border-color);">
                    <div style="flex:1;">
                        <div style="font-weight:600; font-size:14px;">${item.name}</div>
                        <div style="font-size:12px; color:var(--text-muted);">${item.code} • ${item.origin || ''}</div>
                    </div>
                    <div style="text-align:center; padding:0 16px;">
                        <div style="font-size:14px; font-weight:600;">${item.qty}</div>
                        <div style="font-size:11px; color:var(--text-muted);">${item.unit}</div>
                    </div>
                    <div style="text-align:right; min-width:80px;">
                        <div style="font-family:'Space Mono',monospace; font-weight:600;">${item.total.toFixed(2)}</div>
                        <div style="font-size:11px; color:var(--text-muted);">CHF</div>
                    </div>
                </div>
            `).join('');

            // Totaux
            let totalHT = 0;
            QOData.cart.forEach(item => totalHT += item.total);
            const tva = totalHT * 0.026;
            const ttc = totalHT + tva;

            document.getElementById('finalize-total-ht').textContent = totalHT.toFixed(2) + ' CHF';
            document.getElementById('finalize-total-tva').textContent = tva.toFixed(2) + ' CHF';
            document.getElementById('finalize-total-ttc').textContent = ttc.toFixed(2) + ' CHF';

            document.getElementById('finalize-modal').style.display = 'flex';
        }

        function closeFinalizeModal() {
            document.getElementById('finalize-modal').style.display = 'none';
        }

        function confirmAndFinalizeOrder() {
            if (!QOData.selectedClient || QOData.cart.length === 0) return;

            // Calculer les totaux
            let totalHT = 0;
            QOData.cart.forEach(item => totalHT += item.total);
            const tva = totalHT * 0.026;
            const totalTTC = totalHT + tva;

            const now = new Date();
            const currentUser = UsersData.currentUser?.name || 'Inconnu';

            // Mode édition ?
            if (QOData.editingOrderId) {
                // Mise à jour d'une commande existante
                const order = QOData.orders.find(o => o.id === QOData.editingOrderId);
                if (order) {
                    order.items = [...QOData.cart];
                    order.totalHT = totalHT;
                    order.tva = tva;
                    order.totalTTC = totalTTC;
                    order.updatedAt = now.toISOString();
                    order.updatedBy = currentUser;

                    saveQOData('orders');
                    closeFinalizeModal();

                    // Régénérer le PDF
                    generateProPDF(order, false);

                    // Reset
                    const orderId = QOData.editingOrderId;
                    QOData.editingOrderId = null;
                    QOData.cart = [];
                    QOData.selectedClient = null;
                    updateQOCart();
                    updateOrderFloatingBar();

                    // Supprimer le banner d'édition
                    const banner = document.getElementById('edit-order-banner');
                    if (banner) banner.remove();

                    const dropboxMsg = DropboxConfig.autoSync ? '\n📤 PDF mis à jour sur Dropbox' : '';
                    alert('✅ Commande ' + orderId + ' mise à jour !\n\n✏️ Modifiée par: ' + currentUser + dropboxMsg);

                    // Retour à l'étape client
                    document.getElementById('qo-step-order').style.display = 'none';
                    document.getElementById('qo-step-client').style.display = 'block';
                    document.getElementById('qo-selected-client').style.display = 'none';
                }
                return;
            }

            // Nouvelle commande
            const orderNum = generateOrderNumber();

            const order = {
                id: orderNum,
                clientId: QOData.selectedClient.id,
                clientName: QOData.selectedClient.name,
                clientType: QOData.selectedClient.clientType || 'b2b',
                clientAddress: QOData.selectedClient.address || '',
                clientZip: QOData.selectedClient.zip || '',
                clientCity: QOData.selectedClient.city || '',
                clientPhone: QOData.selectedClient.phone || '',
                clientEmail: QOData.selectedClient.email || '',
                pricelistId: QOData.selectedClient.pricelistId || null,
                items: [...QOData.cart],
                totalHT: totalHT,
                tva: tva,
                totalTTC: totalTTC,
                date: now.toISOString(),
                createdAt: now.toISOString(),
                createdBy: currentUser,
                updatedAt: null,
                updatedBy: null,
                status: 'pending',
                statusLabel: 'En attente'
            };

            // Update client
            const client = QOData.clients.find(c => c.id === QOData.selectedClient.id);
            if (client) {
                client.ordersCount = (client.ordersCount || 0) + 1;
                client.lastOrderDate = now.toISOString();
                client.lastOrderId = order.id;
                if (!client.history) client.history = [];
                QOData.cart.forEach(item => {
                    if (!client.history.includes(item.productId)) {
                        client.history.push(item.productId);
                    }
                });
                saveQOData('clients');
            }

            // Save order
            QOData.orders.push(order);
            saveQOData('orders');

            // Update badges
            updateOrdersBadge();

            // Fermer le modal
            closeFinalizeModal();

            // Générer le PDF (sans ouvrir, sauvegarde Dropbox auto)
            generateProPDF(order, false);

            // Reset panier
            QOData.cart = [];
            QOData.selectedClient = null;
            updateQOCart();
            updateOrderFloatingBar();

            // Message de confirmation
            const dropboxMsg = DropboxConfig.autoSync ? '\n📤 PDF sauvegardé sur Dropbox' : '';
            alert('✅ Commande ' + order.id + ' enregistrée !\n\n📝 Créée par: ' + currentUser + dropboxMsg);
        }

        // =====================================================
        // PDF PROFESSIONNEL A4
        // =====================================================

        function generateProPDF(order, openForPrint = false) {
            if (typeof window.jspdf === 'undefined') {
                console.log('jsPDF non chargé');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const margin = 15;

            // === HEADER ===
            doc.setFillColor(10, 14, 23);
            doc.rect(0, 0, pageWidth, 50, 'F');

            // Logo / Nom entreprise
            doc.setTextColor(6, 214, 160);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('TRAKIO', margin, 22);

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Gestion des commandes', margin, 30);

            // Numéro de commande
            doc.setTextColor(6, 214, 160);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(order.id, pageWidth - margin, 22, { align: 'right' });

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const dateFormatted = new Date(order.date).toLocaleDateString('fr-CH', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            doc.text(dateFormatted, pageWidth - margin, 30, { align: 'right' });
            doc.text(new Date(order.date).toLocaleTimeString('fr-CH', { hour: '2-digit', minute: '2-digit' }), pageWidth - margin, 36, { align: 'right' });

            // === CLIENT INFO ===
            let y = 60;

            doc.setTextColor(100, 100, 100);
            doc.setFontSize(9);
            doc.text('FACTURER À', margin, y);

            doc.setTextColor(30, 30, 30);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(order.clientName, margin, y + 8);

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            if (order.clientAddress) {
                doc.text(order.clientAddress, margin, y + 15);
            }
            if (order.clientZip || order.clientCity) {
                doc.text((order.clientZip || '') + ' ' + (order.clientCity || ''), margin, y + 21);
            }
            if (order.clientPhone) {
                doc.text('Tél: ' + order.clientPhone, margin, y + 27);
            }

            // Type client badge
            const typeLabel = order.clientType === 'b2c' ? 'Particulier' : 'Professionnel';
            doc.setFillColor(order.clientType === 'b2c' ? 255 : 59, order.clientType === 'b2c' ? 170 : 130, order.clientType === 'b2c' ? 0 : 246);
            doc.roundedRect(pageWidth - margin - 30, y, 30, 7, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text(typeLabel, pageWidth - margin - 15, y + 5, { align: 'center' });

            // === TABLE DES ARTICLES ===
            y = 95;

            // Header de table
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, y, pageWidth - 2*margin, 10, 'F');

            doc.setTextColor(80, 80, 80);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('Article', margin + 3, y + 7);
            doc.text('Qté', 130, y + 7);
            doc.text('P.U.', 150, y + 7);
            doc.text('Total', pageWidth - margin - 3, y + 7, { align: 'right' });

            y += 14;
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(30, 30, 30);

            // Articles
            order.items.forEach((item, index) => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }

                // Ligne alternée
                if (index % 2 === 1) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(margin, y - 4, pageWidth - 2*margin, 12, 'F');
                }

                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(30, 30, 30);
                doc.text(item.name.substring(0, 45), margin + 3, y + 2);

                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(120, 120, 120);
                let subtext = item.code;
                if (item.origin) subtext += ' • ' + item.origin;
                if (item.lot) subtext += ' • Lot: ' + item.lot;
                doc.text(subtext.substring(0, 60), margin + 3, y + 7);

                doc.setTextColor(30, 30, 30);
                doc.setFontSize(10);
                doc.text(item.qty.toString() + ' ' + item.unit, 130, y + 4);
                doc.text(item.price.toFixed(2), 150, y + 4);
                doc.setFont('helvetica', 'bold');
                doc.text(item.total.toFixed(2) + ' CHF', pageWidth - margin - 3, y + 4, { align: 'right' });

                y += 14;
            });

            // === TOTAUX ===
            y += 5;
            doc.setDrawColor(200, 200, 200);
            doc.line(120, y, pageWidth - margin, y);
            y += 8;

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(80, 80, 80);
            doc.text('Total HT', 130, y);
            doc.setTextColor(30, 30, 30);
            doc.text(order.totalHT.toFixed(2) + ' CHF', pageWidth - margin - 3, y, { align: 'right' });

            y += 7;
            doc.setTextColor(80, 80, 80);
            doc.text('TVA (2.6%)', 130, y);
            doc.setTextColor(30, 30, 30);
            doc.text(order.tva.toFixed(2) + ' CHF', pageWidth - margin - 3, y, { align: 'right' });

            y += 3;
            doc.setDrawColor(6, 214, 160);
            doc.setLineWidth(0.5);
            doc.line(120, y, pageWidth - margin, y);
            y += 8;

            doc.setFillColor(6, 214, 160);
            doc.roundedRect(120, y - 5, pageWidth - margin - 120, 12, 2, 2, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('TOTAL TTC', 125, y + 3);
            doc.text(order.totalTTC.toFixed(2) + ' CHF', pageWidth - margin - 5, y + 3, { align: 'right' });

            // === FOOTER ===
            const footerY = 275;

            // Métadonnées créé/modifié
            doc.setTextColor(150, 150, 150);
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');

            if (order.createdBy) {
                const createdDate = order.createdAt ? new Date(order.createdAt).toLocaleString('fr-CH') : '';
                doc.text(`Créée par: ${order.createdBy} le ${createdDate}`, margin, footerY);
            }
            if (order.updatedBy) {
                const updatedDate = order.updatedAt ? new Date(order.updatedAt).toLocaleString('fr-CH') : '';
                doc.text(`Modifiée par: ${order.updatedBy} le ${updatedDate}`, margin, footerY + 4);
            }

            doc.setFontSize(8);
            doc.text('Document généré automatiquement par TRAKIO', pageWidth / 2, footerY + 10, { align: 'center' });
            doc.text('Page 1/1', pageWidth - margin, footerY + 10, { align: 'right' });

            // Upload sur Dropbox si configuré (toujours)
            if (DropboxConfig.token) {
                const pdfBlob = doc.output('blob');
                uploadOrderPDFToDropbox(order, pdfBlob);
            }

            // Ouvrir pour impression si demandé
            if (openForPrint) {
                doc.autoPrint();
                window.open(doc.output('bloburl'), '_blank');
            }
        }

        // Upload PDF commande vers Dropbox
        async function uploadOrderPDFToDropbox(order, pdfBlob) {
            if (!DropboxConfig.token) return;

            try {
                const monthYear = new Date(order.date).toISOString().slice(0, 7); // YYYY-MM
                const pdfPath = `${DropboxConfig.basePath}/Commandes/${monthYear}/${order.id}.pdf`;

                const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + DropboxConfig.token,
                        'Dropbox-API-Arg': JSON.stringify({
                            path: pdfPath,
                            mode: 'overwrite',
                            autorename: false,
                            mute: true
                        }),
                        'Content-Type': 'application/octet-stream'
                    },
                    body: pdfBlob
                });

                if (response.ok) {
                    console.log('✅ PDF commande sauvegardé sur Dropbox:', pdfPath);
                } else {
                    console.error('❌ Erreur upload PDF Dropbox:', await response.text());
                }
            } catch (error) {
                console.error('Erreur upload PDF:', error);
            }
        }

        // Mettre à jour la barre quand on change de page
        const originalNavigateTo = navigateTo;
        navigateTo = function(pageName) {
            originalNavigateTo(pageName);
            setTimeout(updateOrderFloatingBar, 150);
        };

        // Mettre à jour après chaque modification du panier
        const originalUpdateQOCart = updateQOCart;
        updateQOCart = function() {
            originalUpdateQOCart();
            updateOrderFloatingBar();
        };

        // =====================================================
        // SHOPIFY INTEGRATION - Import CSV
        // =====================================================

        let ShopifyData = {
            orders: [],
            filteredOrders: [],
            currentOrder: null,
            processedOrders: JSON.parse(localStorage.getItem('shopify_processed') || '[]')
        };

        function initShopifyModule() {
            // Charger les données précédemment importées
            const savedOrders = localStorage.getItem('shopify_orders');
            if (savedOrders) {
                try {
                    ShopifyData.orders = JSON.parse(savedOrders);
                    ShopifyData.filteredOrders = [...ShopifyData.orders];
                    if (ShopifyData.orders.length > 0) {
                        showShopifyData();
                        updateShopifyStats();
                        renderShopifyOrders();
                    }
                } catch(e) { console.error('Erreur chargement Shopify:', e); }
            }
        }

        // Parser un CSV
        function parseCSV(text) {
            const lines = [];
            let currentLine = [];
            let currentField = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        currentField += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        currentLine.push(currentField);
                        currentField = '';
                    } else if (char === '\n' || (char === '\r' && nextChar === '\n')) {
                        currentLine.push(currentField);
                        if (currentLine.length > 1) lines.push(currentLine);
                        currentLine = [];
                        currentField = '';
                        if (char === '\r') i++;
                    } else if (char !== '\r') {
                        currentField += char;
                    }
                }
            }
            if (currentField || currentLine.length > 0) {
                currentLine.push(currentField);
                if (currentLine.length > 1) lines.push(currentLine);
            }
            return lines;
        }

        // =============================================
        // SHOP HUB - Fonctions
        // =============================================
        
        let generatedFicheHTML = '';
        
        // Conservation texts
        const ficheConservationTexts = {
            congele: { temp: "-18°C", detail: "Conserver au congélateur à -18°C. Ne jamais recongeler." },
            frais: { temp: "0°C à +4°C", detail: "Conserver au réfrigérateur. Consommer sous 2-3 jours." },
            both: { temp: "-18°C / 0°C à +4°C", detail: "Congélateur -18°C. Après décongélation: frigo 0-4°C, consommer sous 48h." }
        };
        
        // Switch tabs in Shop Hub
        function switchShopTab(tab) {
            // Update buttons
            ['sync', 'nutri', 'fiches'].forEach(t => {
                const btn = document.getElementById('shop-tab-' + t);
                const content = document.getElementById('shop-content-' + t);
                if (btn && content) {
                    if (t === tab) {
                        btn.style.background = 'var(--accent-primary)';
                        btn.style.color = 'white';
                        content.style.display = 'block';
                    } else {
                        btn.style.background = 'transparent';
                        btn.style.color = 'var(--text-muted)';
                        content.style.display = 'none';
                    }
                }
            });
        }
        
        // Parse import text for Fiche
        function parseFicheImport() {
            const text = document.getElementById('fiche-import-text')?.value?.trim();
            if (!text) { showToast('Collez un texte d\'abord', 'warning'); return; }
            
            const found = [];
            
            // Description
            const descMatch = text.match(/Description du Produit\s*:?\s*\n?([\s\S]*?)(?=CONSEILS|Conseils|$)/i);
            if (descMatch) { 
                document.getElementById('fiche-description').value = descMatch[1].trim(); 
                found.push('Description'); 
            }
            
            // Conseils
            const conseilsMatch = text.match(/CONSEILS?\s*(?:DE\s*)?PR[EÉ]PARATION[^:]*:?\s*\n?([\s\S]*?)(?=Servez|Choisissez|$)/i);
            if (conseilsMatch) { 
                document.getElementById('fiche-conseils').value = conseilsMatch[1].trim(); 
                found.push('Conseils'); 
            }
            
            // Certification
            if (text.match(/\bMSC\b/i)) { 
                document.getElementById('fiche-certification').value = 'msc'; 
                found.push('MSC'); 
            } else if (text.match(/\bBIO\b/i)) { 
                document.getElementById('fiche-certification').value = 'bio'; 
                found.push('BIO'); 
            } else if (text.match(/\bASC\b/i)) { 
                document.getElementById('fiche-certification').value = 'asc'; 
                found.push('ASC'); 
            }
            
            // Type
            if (text.match(/sauvage/i)) { 
                document.getElementById('fiche-type').value = 'sauvage'; 
                found.push('Sauvage'); 
            }
            
            if (found.length > 0) {
                showToast('Import réussi: ' + found.join(', '), 'success');
            } else {
                document.getElementById('fiche-description').value = text;
                showToast('Texte copié en description', 'info');
            }
        }
        
        // Get badge HTML
        function getFicheCertBadge(cert) {
            const badges = {
                'bio': '<span class="badge badge-bio">BIO</span>',
                'msc': '<span class="badge badge-msc">MSC</span>',
                'asc': '<span class="badge badge-asc">ASC</span>',
                'label-rouge': '<span class="badge badge-label-rouge">Label Rouge</span>',
                'premium': '<span class="badge badge-premium">Premium</span>',
                'aucune': '<span class="badge badge-aucune">Aucune</span>'
            };
            return badges[cert] || badges['aucune'];
        }
        
        function getFicheTypeBadge(type) {
            return type === 'sauvage' 
                ? '<span class="badge badge-sauvage">Sauvage</span>' 
                : '<span class="badge badge-elevage">Élevage</span>';
        }
        
        // Generate Fiche HTML
        function generateFicheHTML() {
            const getValue = (id) => document.getElementById(id)?.value?.trim() || '';
            
            const conservation = getValue('fiche-conservation');
            const conservData = ficheConservationTexts[conservation] || { temp: '', detail: '' };
            
            const data = {
                description: getValue('fiche-description'),
                presentation: getValue('fiche-presentation'),
                poids: getValue('fiche-poids'),
                type: getValue('fiche-type'),
                certification: getValue('fiche-certification'),
                origine: getValue('fiche-origine'),
                zoneFao: getValue('fiche-zone-fao'),
                methodePeche: getValue('fiche-methode-peche'),
                texteVendeur: getValue('fiche-vendeur'),
                conseils: getValue('fiche-conseils'),
                accords: getValue('fiche-accords'),
                dlc: getValue('fiche-dlc'),
                lien: getValue('fiche-lien'),
                conservationTemp: conservData.temp,
                conservationDetail: conservData.detail
            };
            
            generatedFicheHTML = `<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
<style>
.trakio-fiche-produit { font-family: 'Amiri', serif; max-width: 800px; margin: 0 auto; color: #333; line-height: 1.7; }
.trakio-fiche-produit h2 { color: #1a5f7a; border-bottom: 3px solid #1a5f7a; padding-bottom: 10px; margin-top: 25px; font-size: 1.4em; }
.trakio-fiche-produit .presentation { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #1a5f7a; }
.trakio-fiche-produit table { width: 100%; border-collapse: collapse; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
.trakio-fiche-produit table tr:nth-child(even) { background-color: #f8f9fa; }
.trakio-fiche-produit table td { padding: 12px 15px; border-bottom: 1px solid #dee2e6; }
.trakio-fiche-produit table td:first-child { font-weight: 600; color: #1a5f7a; width: 35%; background-color: rgba(26, 95, 122, 0.05); }
.trakio-fiche-produit .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; color: white; }
.trakio-fiche-produit .badge-bio { background: #4caf50; }
.trakio-fiche-produit .badge-msc { background: #2196f3; }
.trakio-fiche-produit .badge-asc { background: #00bcd4; }
.trakio-fiche-produit .badge-label-rouge { background: #f44336; }
.trakio-fiche-produit .badge-premium { background: linear-gradient(135deg, #d4af37, #f4e5a1); color: #000; }
.trakio-fiche-produit .badge-aucune { background: #9e9e9e; }
.trakio-fiche-produit .badge-sauvage { background: #2196f3; }
.trakio-fiche-produit .badge-elevage { background: #ff9800; }
.trakio-fiche-produit .conseils-box { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin: 15px 0; }
.trakio-fiche-produit .conseils-box h3 { color: #856404; margin-top: 0; font-size: 1.1em; }
.trakio-fiche-produit .accords-vins { background: #f8f0fc; border: 1px solid #9c27b0; border-radius: 8px; padding: 15px; margin: 15px 0; display: flex; align-items: center; gap: 15px; }
.trakio-fiche-produit .vin-icon { font-size: 2.5em; }
.trakio-fiche-produit .conservation-box { background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin: 15px 0; }
.trakio-fiche-produit .conservation-box h3 { color: #1565c0; margin-top: 0; font-size: 1.1em; }
</style>

<div class="trakio-fiche-produit">

${data.description ? `<h2>Description du Produit</h2>
<div class="presentation"><p>${data.description}</p></div>` : ''}

${data.presentation ? `<p>${data.presentation}</p>` : ''}

<h2>📋 Caractéristiques</h2>
<table>
${data.poids ? `<tr><td>⚖️ Unité / Poids</td><td><strong>${data.poids}</strong></td></tr>` : ''}
<tr><td>🐟 Type</td><td>${getFicheTypeBadge(data.type)}</td></tr>
<tr><td>✅ Certification</td><td>${getFicheCertBadge(data.certification)}</td></tr>
${data.methodePeche ? `<tr><td>🎣 Méthode de Pêche</td><td>${data.methodePeche}</td></tr>` : ''}
${data.origine ? `<tr><td>🌍 Origine</td><td><strong>${data.origine}</strong></td></tr>` : ''}
${data.zoneFao ? `<tr><td>🗺️ Zone FAO</td><td>${data.zoneFao}</td></tr>` : ''}
${data.lien ? `<tr><td>🔗 Plus d'infos</td><td><a href="${data.lien}" target="_blank" style="color: #1a5f7a;">En savoir plus ↗</a></td></tr>` : ''}
</table>

${data.texteVendeur ? `<h2>💬 Notre Engagement</h2>
<div class="presentation"><p>${data.texteVendeur}</p></div>` : ''}

${data.conseils ? `<div class="conseils-box"><h3>👨‍🍳 Conseils de Préparation</h3><p>${data.conseils}</p></div>` : ''}

${data.accords ? `<div class="accords-vins"><div class="vin-icon">🍷</div><div><strong>Accords Mets & Vins</strong><br>${data.accords}</div></div>` : ''}

<div class="conservation-box">
<h3>❄️ Conservation</h3>
<table style="box-shadow: none; margin: 10px 0;">
${data.dlc ? `<tr><td style="background: transparent;">📅 DLC</td><td>${data.dlc}</td></tr>` : ''}
${data.conservationTemp || data.conservationDetail ? `<tr><td style="background: transparent;">🧊 Conservation</td><td>${data.conservationTemp ? '<strong>' + data.conservationTemp + '</strong>' : ''}${data.conservationDetail ? '<br>' + data.conservationDetail : ''}</td></tr>` : ''}
</table>
</div>

</div>`;

            // Show preview
            document.getElementById('fiche-preview-section').style.display = 'block';
            document.getElementById('fiche-preview-content').innerHTML = generatedFicheHTML;
            document.getElementById('fiche-code-content').textContent = generatedFicheHTML;
            showFicheTab('preview');
            
            showToast('Fiche générée !', 'success');
        }
        
        // Show preview or code tab
        function showFicheTab(tab) {
            const previewContent = document.getElementById('fiche-preview-content');
            const codeContent = document.getElementById('fiche-code-content');
            const btnPreview = document.getElementById('fiche-btn-preview');
            const btnCode = document.getElementById('fiche-btn-code');
            
            if (tab === 'preview') {
                previewContent.style.display = 'block';
                codeContent.style.display = 'none';
                btnPreview.style.background = 'var(--accent-primary)';
                btnPreview.style.color = '#000';
                btnCode.style.background = 'var(--bg-hover)';
                btnCode.style.color = 'var(--text-primary)';
            } else {
                previewContent.style.display = 'none';
                codeContent.style.display = 'block';
                btnCode.style.background = 'var(--accent-primary)';
                btnCode.style.color = '#000';
                btnPreview.style.background = 'var(--bg-hover)';
                btnPreview.style.color = 'var(--text-primary)';
            }
        }
        
        // Copy Fiche HTML
        function copyFicheHTML() {
            if (!generatedFicheHTML) {
                showToast('Générez d\'abord une fiche !', 'warning');
                return;
            }
            navigator.clipboard.writeText(generatedFicheHTML).then(() => {
                showToast('Code HTML copié !', 'success');
            });
        }
        
        // Reset Fiche form
        function resetFicheForm() {
            const fields = ['fiche-description', 'fiche-presentation', 'fiche-poids', 'fiche-origine', 
                           'fiche-vendeur', 'fiche-conseils', 'fiche-accords', 'fiche-lien', 'fiche-import-text'];
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            // Reset selects
            ['fiche-type', 'fiche-certification', 'fiche-zone-fao', 'fiche-methode-peche', 'fiche-conservation', 'fiche-dlc'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.selectedIndex = 0;
            });
            
            // Hide preview
            document.getElementById('fiche-preview-section').style.display = 'none';
            generatedFicheHTML = '';
            
            showToast('Formulaire réinitialisé', 'info');
        }

        // Importer le CSV Shopify
        function importShopifyCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const statusEl = document.getElementById('shopify-import-status');
            statusEl.innerHTML = '<span style="color:var(--accent-warning);">⏳ Importation en cours...</span>';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = parseCSV(text);

                    if (lines.length < 2) {
                        statusEl.innerHTML = '<span style="color:var(--accent-danger);">❌ Fichier vide ou invalide</span>';
                        return;
                    }

                    const headers = lines[0];
                    const orders = {};

                    // Index des colonnes
                    const idx = {
                        name: headers.indexOf('Name'),
                        email: headers.indexOf('Email'),
                        financialStatus: headers.indexOf('Financial Status'),
                        fulfillmentStatus: headers.indexOf('Fulfillment Status'),
                        currency: headers.indexOf('Currency'),
                        total: headers.indexOf('Total'),
                        shippingMethod: headers.indexOf('Shipping Method'),
                        createdAt: headers.indexOf('Created at'),
                        lineitemQty: headers.indexOf('Lineitem quantity'),
                        lineitemName: headers.indexOf('Lineitem name'),
                        lineitemPrice: headers.indexOf('Lineitem price'),
                        lineitemSku: headers.indexOf('Lineitem sku'),
                        billingName: headers.indexOf('Billing Name'),
                        billingPhone: headers.indexOf('Billing Phone'),
                        billingAddress: headers.indexOf('Billing Address1'),
                        billingCity: headers.indexOf('Billing City'),
                        billingZip: headers.indexOf('Billing Zip'),
                        shippingName: headers.indexOf('Shipping Name'),
                        shippingPhone: headers.indexOf('Shipping Phone'),
                        shippingAddress: headers.indexOf('Shipping Address1'),
                        shippingCity: headers.indexOf('Shipping City'),
                        shippingZip: headers.indexOf('Shipping Zip'),
                        notes: headers.indexOf('Notes'),
                        tags: headers.indexOf('Tags'),
                        id: headers.indexOf('Id')
                    };

                    // Parser les lignes
                    for (let i = 1; i < lines.length; i++) {
                        const row = lines[i];
                        const orderName = row[idx.name];

                        if (!orderName) continue;

                        if (!orders[orderName]) {
                            const tags = row[idx.tags] || '';
                            const pickupInfo = parsePickupInfo(tags);

                            orders[orderName] = {
                                id: row[idx.id] || orderName,
                                name: orderName,
                                email: row[idx.email] || '',
                                financialStatus: row[idx.financialStatus] || '',
                                fulfillmentStatus: row[idx.fulfillmentStatus] || '',
                                currency: row[idx.currency] || 'CHF',
                                total: parseFloat(row[idx.total]) || 0,
                                shippingMethod: row[idx.shippingMethod] || '',
                                createdAt: row[idx.createdAt] || '',
                                billingName: row[idx.billingName] || '',
                                billingPhone: row[idx.billingPhone] || '',
                                billingAddress: row[idx.billingAddress] || '',
                                billingCity: row[idx.billingCity] || '',
                                billingZip: row[idx.billingZip] || '',
                                shippingName: row[idx.shippingName] || '',
                                shippingPhone: row[idx.shippingPhone] || '',
                                shippingAddress: row[idx.shippingAddress] || '',
                                shippingCity: row[idx.shippingCity] || '',
                                shippingZip: row[idx.shippingZip] || '',
                                notes: row[idx.notes] || '',
                                tags: tags,
                                pickupDate: pickupInfo.date,
                                pickupTime: pickupInfo.time,
                                pickupLocation: pickupInfo.location,
                                isPickup: pickupInfo.isPickup,
                                items: [],
                                processed: ShopifyData.processedOrders.includes(orderName)
                            };
                        }

                        // Ajouter l'article
                        const itemName = row[idx.lineitemName];
                        if (itemName) {
                            orders[orderName].items.push({
                                name: itemName,
                                quantity: parseInt(row[idx.lineitemQty]) || 1,
                                price: parseFloat(row[idx.lineitemPrice]) || 0,
                                sku: row[idx.lineitemSku] || ''
                            });
                        }
                    }

                    // Convertir en tableau et trier par date
                    ShopifyData.orders = Object.values(orders).sort((a, b) => {
                        const dateA = new Date(a.createdAt);
                        const dateB = new Date(b.createdAt);
                        return dateB - dateA;
                    });

                    ShopifyData.filteredOrders = [...ShopifyData.orders];

                    // Sauvegarder
                    localStorage.setItem('shopify_orders', JSON.stringify(ShopifyData.orders));

                    // Afficher
                    showShopifyData();
                    updateShopifyStats();
                    populatePickupDateFilter();
                    renderShopifyOrders();

                    statusEl.innerHTML = `<span style="color:var(--accent-primary);">✅ ${ShopifyData.orders.length} commandes importées</span>`;

                } catch(err) {
                    console.error('Erreur import CSV:', err);
                    statusEl.innerHTML = `<span style="color:var(--accent-danger);">❌ Erreur: ${err.message}</span>`;
                }
            };
            reader.readAsText(file, 'UTF-8');
            input.value = '';
        }

        // Parser les infos de retrait depuis les tags
        function parsePickupInfo(tags) {
            const result = {
                date: '',
                time: '',
                location: '',
                isPickup: false
            };

            if (!tags) return result;

            const tagList = tags.split(',').map(t => t.trim());

            // Détecter le type
            if (tags.includes('Store Pickup')) {
                result.isPickup = true;
            }

            // Extraire le lieu
            if (tags.includes('Laboratoire')) {
                result.location = 'Laboratoire de Coinsins';
            } else if (tags.includes('Magasin de Nyon')) {
                result.location = 'Magasin de Nyon';
            } else if (tags.includes('Standard Shipping')) {
                result.location = 'Livraison';
            }

            // Extraire la date (format: "19 Dec 2025")
            const dateMatch = tags.match(/(\d{1,2}\s+(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4})/i);
            if (dateMatch) {
                result.date = dateMatch[1];
            }

            // Extraire l'heure (format: "9:00 AM - 10:00 AM")
            const timeMatch = tags.match(/(\d{1,2}:\d{2}\s*(?:AM|PM)\s*-\s*\d{1,2}:\d{2}\s*(?:AM|PM))/i);
            if (timeMatch) {
                result.time = timeMatch[1];
            }

            return result;
        }

        function showShopifyData() {
            document.getElementById('shopify-empty').style.display = 'none';
            document.getElementById('shopify-stats').style.display = 'grid';
            document.getElementById('shopify-filters').style.display = 'flex';
            document.getElementById('shopify-table-container').style.display = 'block';
            document.getElementById('shopify-alerts').style.display = 'block';
        }

        function updateShopifyStats() {
            const orders = ShopifyData.orders;

            const total = orders.length;
            const urgent = orders.filter(o => o.financialStatus === 'paid' && o.fulfillmentStatus === 'unfulfilled' && !o.processed).length;
            const pending = orders.filter(o => o.financialStatus === 'pending').length;
            const fulfilled = orders.filter(o => o.fulfillmentStatus === 'fulfilled' || o.processed).length;
            const pickup = orders.filter(o => o.isPickup).length;
            const revenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);

            document.getElementById('shopify-stat-total').textContent = total;
            document.getElementById('shopify-stat-urgent').textContent = urgent;
            document.getElementById('shopify-stat-pending').textContent = pending;
            document.getElementById('shopify-stat-fulfilled').textContent = fulfilled;
            document.getElementById('shopify-stat-pickup').textContent = pickup;
            document.getElementById('shopify-stat-revenue').textContent = revenue.toFixed(0);

            // Alertes
            const alertUrgent = document.getElementById('shopify-alert-urgent');
            const alertToday = document.getElementById('shopify-alert-today');

            if (urgent > 0) {
                alertUrgent.style.display = 'block';
                document.getElementById('shopify-urgent-count').textContent = urgent;
            } else {
                alertUrgent.style.display = 'none';
            }

            // Commandes aujourd'hui
            const today = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            const todayOrders = orders.filter(o => o.pickupDate && o.pickupDate.includes(today.split(' ')[0]) && !o.processed);
            if (todayOrders.length > 0) {
                alertToday.style.display = 'block';
                document.getElementById('shopify-today-count').textContent = todayOrders.length;
            } else {
                alertToday.style.display = 'none';
            }

            // Mettre à jour le badge sur le Dashboard
            updateShopifyDashboardBadge();
            updateDayAlerts();
        }

        function populatePickupDateFilter() {
            const dates = new Set();
            ShopifyData.orders.forEach(o => {
                if (o.pickupDate) dates.add(o.pickupDate);
            });

            const select = document.getElementById('shopify-filter-pickup-date');
            select.innerHTML = '<option value="">Toutes les dates</option>';

            // Trier les dates
            const sortedDates = Array.from(dates).sort((a, b) => {
                const dateA = new Date(a);
                const dateB = new Date(b);
                return dateA - dateB;
            });

            sortedDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = '📅 ' + date;
                select.appendChild(option);
            });
        }

        function applyShopifyFilters() {
            const statusFilter = document.getElementById('shopify-filter-status').value;
            const locationFilter = document.getElementById('shopify-filter-location').value;
            const dateFilter = document.getElementById('shopify-filter-pickup-date').value;
            const searchFilter = document.getElementById('shopify-search').value.toLowerCase();

            ShopifyData.filteredOrders = ShopifyData.orders.filter(order => {
                // Filtre statut
                if (statusFilter === 'urgent') {
                    if (!(order.financialStatus === 'paid' && order.fulfillmentStatus === 'unfulfilled' && !order.processed)) return false;
                } else if (statusFilter === 'pending') {
                    if (order.financialStatus !== 'pending') return false;
                } else if (statusFilter === 'fulfilled') {
                    if (order.fulfillmentStatus !== 'fulfilled' && !order.processed) return false;
                } else if (statusFilter === 'refunded') {
                    if (order.financialStatus !== 'refunded') return false;
                }

                // Filtre lieu
                if (locationFilter) {
                    if (locationFilter === 'Shipping') {
                        if (order.isPickup) return false;
                    } else if (!order.pickupLocation?.includes(locationFilter)) {
                        return false;
                    }
                }

                // Filtre date
                if (dateFilter && order.pickupDate !== dateFilter) return false;

                // Filtre recherche
                if (searchFilter) {
                    const searchIn = `${order.name} ${order.billingName} ${order.shippingName} ${order.email}`.toLowerCase();
                    if (!searchIn.includes(searchFilter)) return false;
                }

                return true;
            });

            renderShopifyOrders();
        }

        function filterShopifyOrders(type) {
            document.getElementById('shopify-filter-status').value = type === 'all' ? '' : type;
            applyShopifyFilters();
        }

        function filterShopifyByUrgent() {
            document.getElementById('shopify-filter-status').value = 'urgent';
            document.getElementById('shopify-filter-location').value = '';
            document.getElementById('shopify-filter-pickup-date').value = '';
            document.getElementById('shopify-search').value = '';
            applyShopifyFilters();
        }

        function filterShopifyByToday() {
            const today = new Date();
            const options = document.getElementById('shopify-filter-pickup-date').options;
            for (let i = 0; i < options.length; i++) {
                const optDate = options[i].value;
                if (optDate && optDate.includes(today.getDate().toString())) {
                    document.getElementById('shopify-filter-pickup-date').value = optDate;
                    break;
                }
            }
            applyShopifyFilters();
        }

        function resetShopifyFilters() {
            document.getElementById('shopify-filter-status').value = '';
            document.getElementById('shopify-filter-location').value = '';
            document.getElementById('shopify-filter-pickup-date').value = '';
            document.getElementById('shopify-search').value = '';
            ShopifyData.filteredOrders = [...ShopifyData.orders];
            renderShopifyOrders();
        }

        function renderShopifyOrders() {
            const tbody = document.getElementById('shopify-orders-tbody');
            let orders = [...ShopifyData.filteredOrders];

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px; color:var(--text-muted);">Aucune commande trouvée</td></tr>';
                return;
            }

            // Trier par date de retrait (plus proche d'abord)
            orders.sort((a, b) => {
                const dateA = parsePickupDateForSort(a.pickupDate);
                const dateB = parsePickupDateForSort(b.pickupDate);
                if (!dateA && !dateB) return 0;
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            });

            tbody.innerHTML = orders.map(order => {
                const isUrgent = order.financialStatus === 'paid' && order.fulfillmentStatus === 'unfulfilled' && !order.processed;
                const isPending = order.financialStatus === 'pending';
                const isProcessed = order.processed || order.fulfillmentStatus === 'fulfilled';
                const isRefunded = order.financialStatus === 'refunded';

                // Couleur de la ligne
                let rowStyle = '';
                if (isUrgent) rowStyle = 'background:rgba(231,76,60,0.1); border-left:4px solid var(--accent-danger);';
                else if (isPending) rowStyle = 'background:rgba(241,196,15,0.1);';
                else if (isProcessed) rowStyle = 'opacity:0.6;';

                // Badge statut
                let statusBadge = '';
                if (isRefunded) {
                    statusBadge = '<span style="padding:4px 8px; background:var(--accent-danger); color:#fff; border-radius:4px; font-size:10px;">↩️ Remboursée</span>';
                } else if (isProcessed) {
                    statusBadge = '<span style="padding:4px 8px; background:var(--accent-secondary); color:#fff; border-radius:4px; font-size:10px;">✅ Traitée</span>';
                } else if (isUrgent) {
                    statusBadge = '<span style="padding:4px 8px; background:var(--accent-danger); color:#fff; border-radius:4px; font-size:10px;">🚨 À traiter</span>';
                } else if (isPending) {
                    statusBadge = '<span style="padding:4px 8px; background:var(--accent-warning); color:#000; border-radius:4px; font-size:10px;">⏳ Paiement</span>';
                } else {
                    statusBadge = '<span style="padding:4px 8px; background:var(--text-muted); color:#fff; border-radius:4px; font-size:10px;">' + order.financialStatus + '</span>';
                }

                // Lieu avec icône
                let locationBadge = '';
                if (order.pickupLocation === 'Laboratoire de Coinsins') {
                    locationBadge = '<span style="color:var(--accent-primary);">🔬 Labo</span>';
                } else if (order.pickupLocation === 'Magasin de Nyon') {
                    locationBadge = '<span style="color:var(--accent-secondary);">🏪 Nyon</span>';
                } else if (order.isPickup) {
                    locationBadge = '<span style="color:var(--text-muted);">📍 Retrait</span>';
                } else {
                    locationBadge = '<span style="color:var(--accent-warning);">📦 Livraison</span>';
                }

                // Articles résumé
                const itemsCount = order.items.length;

                // Date de commande formatée
                const orderDate = order.createdAt ? formatOrderDate(order.createdAt) : '-';

                return `
                    <tr style="${rowStyle}" onclick="showShopifyOrderDetail('${order.name}')" class="clickable-row">
                        <td onclick="event.stopPropagation()"><input type="checkbox" class="shopify-order-check" data-order="${order.name}"></td>
                        <td><strong style="color:#96bf48;">${order.name}</strong></td>
                        <td style="font-size:12px; color:var(--text-muted);">${orderDate}</td>
                        <td>
                            <div style="font-weight:600;">${order.billingName || order.shippingName || 'N/A'}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${order.billingCity || order.shippingCity || ''}</div>
                        </td>
                        <td>
                            <div style="font-weight:600; color:${isUrgent ? 'var(--accent-danger)' : 'var(--text-primary)'};">${order.pickupDate || '-'}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${order.pickupTime || ''}</div>
                        </td>
                        <td>${locationBadge}</td>
                        <td>
                            <div style="font-size:12px;">${itemsCount} article(s)</div>
                        </td>
                        <td style="font-family:'Space Mono',monospace; font-weight:600;">${order.total.toFixed(2)} ${order.currency}</td>
                        <td>${statusBadge}</td>
                        <td onclick="event.stopPropagation()">
                            <button onclick="showShopifyOrderDetail('${order.name}')" style="padding:6px 10px; background:var(--accent-secondary); color:#fff; border:none; border-radius:4px; cursor:pointer; margin-right:4px;">👁️</button>
                            ${!isProcessed && !isRefunded ? `<button onclick="markOrderProcessed('${order.name}')" style="padding:6px 10px; background:var(--accent-primary); color:#000; border:none; border-radius:4px; cursor:pointer;">✓</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Parser la date de retrait pour le tri
        function parsePickupDateForSort(dateStr) {
            if (!dateStr) return null;
            // Format: "19 Dec 2025"
            const months = { 'Jan':0, 'Feb':1, 'Mar':2, 'Apr':3, 'May':4, 'Jun':5, 'Jul':6, 'Aug':7, 'Sep':8, 'Oct':9, 'Nov':10, 'Dec':11 };
            const match = dateStr.match(/(\d{1,2})\s+(\w{3})\s+(\d{4})/);
            if (match) {
                const day = parseInt(match[1]);
                const month = months[match[2]];
                const year = parseInt(match[3]);
                if (month !== undefined) {
                    return new Date(year, month, day);
                }
            }
            return null;
        }

        // Formater la date de commande
        function formatOrderDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fr-CH', { day: '2-digit', month: '2-digit', year: '2-digit' });
            } catch(e) {
                return dateStr.substring(0, 10);
            }
        }


        function showShopifyOrderDetail(orderName) {
            const order = ShopifyData.orders.find(o => o.name === orderName);
            if (!order) return;

            ShopifyData.currentOrder = order;

            const isUrgent = order.financialStatus === 'paid' && order.fulfillmentStatus === 'unfulfilled' && !order.processed;

            document.getElementById('shopify-modal-order-id').textContent = order.name;

            // Changer la couleur du header si urgent
            const header = document.getElementById('shopify-modal-header');
            if (isUrgent) {
                header.style.background = 'linear-gradient(135deg, var(--accent-danger), #c0392b)';
            } else {
                header.style.background = 'linear-gradient(135deg, #96bf48, #5c8e24)';
            }

            // Contenu
            const itemsHtml = order.items.map(item => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--bg-primary); border-radius:8px; margin-bottom:8px;">
                    <div style="flex:1;">
                        <div style="font-weight:600;">${item.name}</div>
                        <div style="font-size:11px; color:var(--text-muted);">SKU: ${item.sku || '-'}</div>
                    </div>
                    <div style="text-align:center; padding:0 16px;">
                        <div style="font-weight:700; font-size:18px;">×${item.quantity}</div>
                    </div>
                    <div style="text-align:right; min-width:100px;">
                        <div style="font-family:'Space Mono',monospace; font-weight:600;">${item.price.toFixed(2)} CHF</div>
                        <div style="font-size:11px; color:var(--text-muted);">= ${(item.quantity * item.price).toFixed(2)} CHF</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('shopify-modal-content').innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <!-- Retrait -->
                    <div style="background:${isUrgent ? 'rgba(231,76,60,0.1)' : 'var(--bg-primary)'}; padding:16px; border-radius:12px; ${isUrgent ? 'border:2px solid var(--accent-danger);' : ''}">
                        <div style="font-weight:600; color:${isUrgent ? 'var(--accent-danger)' : 'var(--accent-primary)'}; margin-bottom:12px;">📅 Retrait / Livraison</div>
                        <div style="font-size:18px; font-weight:700; margin-bottom:4px;">${order.pickupDate || 'Non spécifié'}</div>
                        <div style="color:var(--text-muted);">${order.pickupTime || ''}</div>
                        <div style="margin-top:8px; padding:8px; background:var(--bg-card); border-radius:6px;">
                            <strong>${order.pickupLocation || order.shippingMethod || 'N/A'}</strong>
                        </div>
                    </div>
                    <!-- Client -->
                    <div style="background:var(--bg-primary); padding:16px; border-radius:12px;">
                        <div style="font-weight:600; color:var(--accent-secondary); margin-bottom:12px;">👤 Client</div>
                        <div style="font-size:16px; font-weight:600;">${order.billingName || order.shippingName}</div>
                        <div style="color:var(--text-muted); margin-top:4px;">${order.email}</div>
                        <div style="color:var(--text-muted);">${order.billingPhone || order.shippingPhone || ''}</div>
                        <div style="margin-top:8px; font-size:13px;">
                            ${order.shippingAddress || order.billingAddress}<br>
                            ${order.shippingZip || order.billingZip} ${order.shippingCity || order.billingCity}
                        </div>
                    </div>
                </div>

                ${order.notes ? `
                <div style="background:var(--accent-warning)15; padding:16px; border-radius:12px; margin-bottom:20px; border-left:4px solid var(--accent-warning);">
                    <div style="font-weight:600; color:var(--accent-warning); margin-bottom:8px;">📝 Note du client</div>
                    <div>${order.notes}</div>
                </div>
                ` : ''}

                <!-- Articles -->
                <div style="margin-bottom:20px;">
                    <div style="font-weight:600; margin-bottom:12px;">📦 Articles (${order.items.length})</div>
                    ${itemsHtml}
                </div>

                <!-- Total -->
                <div style="background:var(--bg-primary); padding:16px; border-radius:12px;">
                    <div style="display:flex; justify-content:space-between; font-weight:700; font-size:20px;">
                        <span>Total</span>
                        <span style="font-family:'Space Mono',monospace; color:#96bf48;">${order.total.toFixed(2)} ${order.currency}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:8px; color:var(--text-muted); font-size:13px;">
                        <span>Statut paiement</span>
                        <span>${order.financialStatus === 'paid' ? '✅ Payée' : order.financialStatus}</span>
                    </div>
                </div>
            `;

            document.getElementById('shopify-order-modal').style.display = 'flex';
        }

        function closeShopifyOrderModal() {
            document.getElementById('shopify-order-modal').style.display = 'none';
        }

        function markOrderProcessed(orderName) {
            const order = ShopifyData.orders.find(o => o.name === orderName);
            if (!order) return;

            order.processed = true;

            // Sauvegarder dans la liste des commandes traitées
            if (!ShopifyData.processedOrders.includes(orderName)) {
                ShopifyData.processedOrders.push(orderName);
                localStorage.setItem('shopify_processed', JSON.stringify(ShopifyData.processedOrders));
            }

            localStorage.setItem('shopify_orders', JSON.stringify(ShopifyData.orders));

            updateShopifyStats();
            renderShopifyOrders();
        }

        function markAsProcessed() {
            if (!ShopifyData.currentOrder) return;
            markOrderProcessed(ShopifyData.currentOrder.name);
            closeShopifyOrderModal();
        }

        function toggleSelectAllShopify() {
            const selectAll = document.getElementById('shopify-select-all').checked;
            document.querySelectorAll('.shopify-order-check').forEach(cb => cb.checked = selectAll);
        }

        function printShopifyOrder() {
            if (!ShopifyData.currentOrder) return;
            const order = ShopifyData.currentOrder;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Commande ${order.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #96bf48; }
                        .info { margin: 10px 0; }
                        .items { margin: 20px 0; }
                        .item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
                        .total { font-size: 20px; font-weight: bold; margin-top: 20px; text-align: right; }
                        .urgent { color: #e74c3c; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>🛍️ Commande ${order.name}</h1>
                    <div class="info"><strong>Client:</strong> ${order.billingName || order.shippingName}</div>
                    <div class="info"><strong>Email:</strong> ${order.email}</div>
                    <div class="info"><strong>Téléphone:</strong> ${order.billingPhone || order.shippingPhone || '-'}</div>
                    <div class="info"><strong>Adresse:</strong> ${order.shippingAddress || order.billingAddress}, ${order.shippingZip || order.billingZip} ${order.shippingCity || order.billingCity}</div>
                    <hr>
                    <div class="info ${order.financialStatus === 'paid' && order.fulfillmentStatus === 'unfulfilled' ? 'urgent' : ''}">
                        <strong>📅 Date de retrait:</strong> ${order.pickupDate || 'Non spécifié'} ${order.pickupTime || ''}
                    </div>
                    <div class="info"><strong>📍 Lieu:</strong> ${order.pickupLocation || order.shippingMethod}</div>
                    ${order.notes ? `<div class="info"><strong>📝 Note:</strong> ${order.notes}</div>` : ''}
                    <hr>
                    <div class="items">
                        <h3>Articles</h3>
                        ${order.items.map(item => `
                            <div class="item">
                                <span>${item.quantity}x ${item.name}</span>
                                <span>${(item.quantity * item.price).toFixed(2)} CHF</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="total">Total: ${order.total.toFixed(2)} ${order.currency}</div>
                    <script>window.print();${'<'}/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function exportShopifyFiltered() {
            const orders = ShopifyData.filteredOrders;
            if (orders.length === 0) {
                alert('Aucune commande à exporter');
                return;
            }

            // Créer CSV
            const headers = ['N° Commande', 'Client', 'Email', 'Téléphone', 'Date Retrait', 'Heure', 'Lieu', 'Articles', 'Total', 'Statut Paiement', 'Statut Traitement'];
            const rows = orders.map(o => [
                o.name,
                o.billingName || o.shippingName,
                o.email,
                o.billingPhone || o.shippingPhone,
                o.pickupDate,
                o.pickupTime,
                o.pickupLocation || o.shippingMethod,
                o.items.map(i => `${i.quantity}x ${i.name}`).join(' | '),
                o.total.toFixed(2),
                o.financialStatus,
                o.processed ? 'Traitée' : 'Non traitée'
            ]);

            const csv = [headers, ...rows].map(r => r.map(c => `"${(c || '').replace(/"/g, '""')}"`).join(',')).join('\n');

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shopify-commandes-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // =====================================================
        // NUMÉROTATION & PRÉFIXES
        // =====================================================

        const NumberingConfig = {
            order: {
                prefix: localStorage.getItem('num_order_prefix') || 'CMD',
                start: parseInt(localStorage.getItem('num_order_start')) || 1,
                next: parseInt(localStorage.getItem('num_order_next')) || 1
            },
            client: {
                prefix: localStorage.getItem('num_client_prefix') || 'CLI',
                start: parseInt(localStorage.getItem('num_client_start')) || 1000,
                next: parseInt(localStorage.getItem('num_client_next')) || 1000
            },
            article: {
                prefix: localStorage.getItem('num_article_prefix') || 'ART',
                start: parseInt(localStorage.getItem('num_article_start')) || 100,
                next: parseInt(localStorage.getItem('num_article_next')) || 100
            },
            includeDate: localStorage.getItem('num_include_date') !== 'false',
            zeroPadding: localStorage.getItem('num_zero_padding') !== 'false'
        };

        function initNumberingSettings() {
            // Charger les valeurs dans les champs
            document.getElementById('num-order-prefix').value = NumberingConfig.order.prefix;
            document.getElementById('num-order-start').value = NumberingConfig.order.start;
            document.getElementById('num-order-next').value = NumberingConfig.order.next;

            document.getElementById('num-client-prefix').value = NumberingConfig.client.prefix;
            document.getElementById('num-client-start').value = NumberingConfig.client.start;
            document.getElementById('num-client-next').value = NumberingConfig.client.next;

            document.getElementById('num-article-prefix').value = NumberingConfig.article.prefix;
            document.getElementById('num-article-start').value = NumberingConfig.article.start;
            document.getElementById('num-article-next').value = NumberingConfig.article.next;

            document.getElementById('num-include-date').checked = NumberingConfig.includeDate;
            document.getElementById('num-zero-padding').checked = NumberingConfig.zeroPadding;

            // Mettre à jour les aperçus
            updateNumberingPreviews();

            // Ajouter les événements pour mise à jour en temps réel
            ['num-order-prefix', 'num-order-next', 'num-client-prefix', 'num-client-next', 'num-article-prefix', 'num-article-next', 'num-include-date', 'num-zero-padding'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateNumberingPreviews);
                if (el) el.addEventListener('change', updateNumberingPreviews);
            });
        }

        function updateNumberingPreviews() {
            const includeDate = document.getElementById('num-include-date')?.checked;
            const zeroPadding = document.getElementById('num-zero-padding')?.checked;
            const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');

            // Commandes
            const orderPrefix = document.getElementById('num-order-prefix')?.value || 'CMD';
            const orderNext = parseInt(document.getElementById('num-order-next')?.value) || 1;
            const orderNum = zeroPadding ? String(orderNext).padStart(3, '0') : orderNext;
            const orderPreview = includeDate ? `${orderPrefix}-${dateStr}-${orderNum}` : `${orderPrefix}-${orderNum}`;
            const orderEl = document.getElementById('num-order-preview');
            if (orderEl) orderEl.textContent = orderPreview;

            // Clients
            const clientPrefix = document.getElementById('num-client-prefix')?.value || 'CLI';
            const clientNext = parseInt(document.getElementById('num-client-next')?.value) || 1000;
            const clientPreview = `${clientPrefix}-${clientNext}`;
            const clientEl = document.getElementById('num-client-preview');
            if (clientEl) clientEl.textContent = clientPreview;

            // Articles
            const articlePrefix = document.getElementById('num-article-prefix')?.value || 'ART';
            const articleNext = parseInt(document.getElementById('num-article-next')?.value) || 100;
            const articlePreview = `${articlePrefix}-${articleNext}`;
            const articleEl = document.getElementById('num-article-preview');
            if (articleEl) articleEl.textContent = articlePreview;
        }

        function saveNumberingConfig() {
            // Récupérer les valeurs
            NumberingConfig.order.prefix = document.getElementById('num-order-prefix').value.trim() || 'CMD';
            NumberingConfig.order.start = parseInt(document.getElementById('num-order-start').value) || 1;
            NumberingConfig.order.next = parseInt(document.getElementById('num-order-next').value) || 1;

            NumberingConfig.client.prefix = document.getElementById('num-client-prefix').value.trim() || 'CLI';
            NumberingConfig.client.start = parseInt(document.getElementById('num-client-start').value) || 1000;
            NumberingConfig.client.next = parseInt(document.getElementById('num-client-next').value) || 1000;

            NumberingConfig.article.prefix = document.getElementById('num-article-prefix').value.trim() || 'ART';
            NumberingConfig.article.start = parseInt(document.getElementById('num-article-start').value) || 100;
            NumberingConfig.article.next = parseInt(document.getElementById('num-article-next').value) || 100;

            NumberingConfig.includeDate = document.getElementById('num-include-date').checked;
            NumberingConfig.zeroPadding = document.getElementById('num-zero-padding').checked;

            // Sauvegarder dans localStorage
            localStorage.setItem('num_order_prefix', NumberingConfig.order.prefix);
            localStorage.setItem('num_order_start', NumberingConfig.order.start);
            localStorage.setItem('num_order_next', NumberingConfig.order.next);

            localStorage.setItem('num_client_prefix', NumberingConfig.client.prefix);
            localStorage.setItem('num_client_start', NumberingConfig.client.start);
            localStorage.setItem('num_client_next', NumberingConfig.client.next);

            localStorage.setItem('num_article_prefix', NumberingConfig.article.prefix);
            localStorage.setItem('num_article_start', NumberingConfig.article.start);
            localStorage.setItem('num_article_next', NumberingConfig.article.next);

            localStorage.setItem('num_include_date', NumberingConfig.includeDate);
            localStorage.setItem('num_zero_padding', NumberingConfig.zeroPadding);

            alert('✅ Configuration de numérotation enregistrée !');
        }

        // Générer un numéro de commande
        function generateOrderNumber() {
            const prefix = NumberingConfig.order.prefix;
            const num = NumberingConfig.order.next;
            const padded = NumberingConfig.zeroPadding ? String(num).padStart(3, '0') : num;

            let orderNum;
            if (NumberingConfig.includeDate) {
                const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                orderNum = `${prefix}-${dateStr}-${padded}`;
            } else {
                orderNum = `${prefix}-${padded}`;
            }

            // Incrémenter le prochain numéro
            NumberingConfig.order.next++;
            localStorage.setItem('num_order_next', NumberingConfig.order.next);

            return orderNum;
        }

        // Générer un numéro de client
        function generateClientNumber() {
            const prefix = NumberingConfig.client.prefix;
            const num = NumberingConfig.client.next;
            const clientNum = `${prefix}-${num}`;

            // Incrémenter le prochain numéro
            NumberingConfig.client.next++;
            localStorage.setItem('num_client_next', NumberingConfig.client.next);

            return clientNum;
        }

        // Générer un numéro d'article
        function generateArticleNumber() {
            const prefix = NumberingConfig.article.prefix;
            const num = NumberingConfig.article.next;
            const articleNum = `${prefix}-${num}`;

            // Incrémenter le prochain numéro
            NumberingConfig.article.next++;
            localStorage.setItem('num_article_next', NumberingConfig.article.next);

            return articleNum;
        }

        // =====================================================
        // DROPBOX INTEGRATION
        // =====================================================

        const DropboxConfig = {
            token: localStorage.getItem('dropbox_token') || '',
            basePath: localStorage.getItem('dropbox_base_path') || '/TRAKIO',
            autoSync: localStorage.getItem('dropbox_auto_sync') === 'true',
            connected: false
        };

        function initDropboxSettings() {
            // Charger les paramètres
            document.getElementById('dropbox-token').value = DropboxConfig.token;
            document.getElementById('dropbox-base-path').value = DropboxConfig.basePath;
            document.getElementById('dropbox-path-display').textContent = DropboxConfig.basePath;

            if (DropboxConfig.autoSync) {
                document.getElementById('dropbox-auto-sync').classList.add('active');
            }

            // Mettre à jour le chemin affiché en temps réel
            document.getElementById('dropbox-base-path').addEventListener('input', function() {
                document.getElementById('dropbox-path-display').textContent = this.value || '/TRAKIO';
            });

            // Vérifier la connexion si token existe
            if (DropboxConfig.token) {
                testDropboxConnection(true);
            }
        }

        function toggleDropboxSync() {
            // Fonction appelée si nécessaire - le toggle est géré automatiquement
            DropboxConfig.autoSync = document.getElementById('dropbox-auto-sync').classList.contains('active');
        }

        function saveDropboxSettings() {
            DropboxConfig.token = document.getElementById('dropbox-token').value.trim();
            DropboxConfig.basePath = document.getElementById('dropbox-base-path').value.trim() || '/TRAKIO';
            DropboxConfig.autoSync = document.getElementById('dropbox-auto-sync').classList.contains('active');

            localStorage.setItem('dropbox_token', DropboxConfig.token);
            localStorage.setItem('dropbox_base_path', DropboxConfig.basePath);
            localStorage.setItem('dropbox_auto_sync', DropboxConfig.autoSync);

            // Gérer la sync automatique
            if (DropboxConfig.autoSync && DropboxConfig.connected) {
                startDropboxSync();
                alert('✅ Configuration enregistrée !\n\n🔄 Synchronisation automatique activée.\nLes données seront synchronisées toutes les 30 secondes.');
            } else if (!DropboxConfig.autoSync) {
                stopDropboxSync();
                alert('✅ Configuration Dropbox enregistrée !\n\n⏹️ Synchronisation automatique désactivée.');
            } else {
                alert('✅ Configuration Dropbox enregistrée !');
            }

            if (DropboxConfig.token) {
                testDropboxConnection(true).then(connected => {
                    if (connected && DropboxConfig.autoSync) {
                        startDropboxSync();
                    }
                });
            }
        }

        async function testDropboxConnection(silent = false) {
            const token = document.getElementById('dropbox-token').value.trim() || DropboxConfig.token;

            if (!token) {
                updateDropboxStatus('error', 'Token manquant', 'Veuillez entrer un token d\'accès');
                if (!silent) alert('❌ Veuillez entrer un token d\'accès Dropbox');
                return false;
            }

            // Vérifier format du token
            if (!token.startsWith('sl.')) {
                updateDropboxStatus('error', 'Token invalide', 'Le token doit commencer par "sl."');
                if (!silent) alert('❌ Format de token invalide.\n\nLe token Dropbox doit commencer par "sl."');
                return false;
            }

            updateDropboxStatus('loading', 'Test en cours...', 'Connexion à Dropbox...');

            try {
                const response = await fetch('https://api.dropboxapi.com/2/users/get_current_account', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    body: null
                });

                if (response.ok) {
                    const data = await response.json();
                    DropboxConfig.connected = true;
                    DropboxConfig.token = token; // Sauvegarder le token valide
                    updateDropboxStatus('success', 'Connecté', 'Compte: ' + data.email);
                    if (!silent) alert('✅ Connexion réussie !\n\nCompte: ' + data.name.display_name + '\nEmail: ' + data.email);
                    return true;
                } else {
                    // Récupérer le message d'erreur détaillé
                    let errorMsg = 'Token invalide ou expiré';
                    try {
                        const errorData = await response.json();
                        if (errorData.error_summary) {
                            errorMsg = errorData.error_summary;
                        }
                        if (errorData.error && errorData.error['.tag']) {
                            errorMsg = errorData.error['.tag'];
                        }
                    } catch(e) {}

                    DropboxConfig.connected = false;
                    updateDropboxStatus('error', 'Erreur ' + response.status, errorMsg);

                    if (!silent) {
                        if (response.status === 401) {
                            alert('❌ Token invalide ou expiré.\n\n1. Retournez sur la console Dropbox\n2. Cliquez "Generate" pour un nouveau token\n3. Copiez-le et réessayez immédiatement');
                        } else {
                            alert('❌ Erreur Dropbox: ' + errorMsg + '\n\nCode: ' + response.status);
                        }
                    }
                    return false;
                }
            } catch (error) {
                DropboxConfig.connected = false;
                updateDropboxStatus('error', 'Erreur réseau', error.message);
                if (!silent) alert('❌ Erreur de connexion réseau:\n\n' + error.message + '\n\nVérifiez votre connexion internet.');
                return false;
            }
        }

        function updateDropboxStatus(status, text, detail) {
            const icons = { success: '🟢', error: '🔴', loading: '🟡', default: '⚪' };
            document.getElementById('dropbox-status-icon').textContent = icons[status] || icons.default;
            document.getElementById('dropbox-status-text').textContent = text;
            document.getElementById('dropbox-status-detail').textContent = detail;

            const statusDiv = document.getElementById('dropbox-status');
            statusDiv.style.background = status === 'success' ? 'var(--accent-primary)15' :
                                         status === 'error' ? 'var(--accent-danger)15' : 'var(--bg-primary)';
        }

        async function createDropboxFolders() {
            const token = document.getElementById('dropbox-token').value.trim() || DropboxConfig.token;
            const basePath = document.getElementById('dropbox-base-path').value.trim() || DropboxConfig.basePath;

            if (!token) {
                alert('❌ Veuillez d\'abord configurer le token Dropbox');
                return;
            }

            const folders = ['Commandes', 'Clients', 'Articles', 'Factures', 'Rapports', 'System', 'System/Backups'];
            let created = 0;
            let errors = [];

            for (const folder of folders) {
                const path = basePath + '/' + folder;
                try {
                    const response = await fetch('https://api.dropboxapi.com/2/files/create_folder_v2', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ path: path, autorename: false })
                    });

                    if (response.ok || response.status === 409) { // 409 = dossier existe déjà
                        created++;
                    } else {
                        errors.push(folder);
                    }
                } catch (e) {
                    errors.push(folder);
                }
            }

            if (errors.length === 0) {
                alert('✅ Structure créée avec succès !\n\n' + basePath + '\n├── Commandes\n├── Clients\n├── Articles\n├── Factures\n├── Rapports\n└── System\n    └── Backups (sauvegardes complètes)');
            } else {
                alert('⚠️ Dossiers créés: ' + created + '/' + folders.length + '\nErreurs: ' + errors.join(', '));
            }
        }

        async function uploadToDropbox(filePath, content, contentType = 'application/json') {
            if (!DropboxConfig.token) return false;
            // Pour les uploads automatiques, vérifier autoSync
            // Les uploads manuels passent forceUpload=true
            if (!DropboxConfig.autoSync && !DropboxConfig._forceUpload) return false;

            try {
                const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + DropboxConfig.token,
                        'Content-Type': 'application/octet-stream',
                        'Dropbox-API-Arg': JSON.stringify({
                            path: filePath,
                            mode: 'overwrite',
                            autorename: false,
                            mute: true
                        })
                    },
                    body: content
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Dropbox error:', response.status, errorData);
                }

                return response.ok;
            } catch (error) {
                console.error('Dropbox upload error:', error);
                return false;
            }
        }

        // Upload direct (pour boutons manuels - ignore autoSync)
        async function uploadToDropboxDirect(filePath, content) {
            if (!DropboxConfig.token) return false;

            try {
                const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + DropboxConfig.token,
                        'Content-Type': 'application/octet-stream',
                        'Dropbox-API-Arg': JSON.stringify({
                            path: filePath,
                            mode: 'overwrite',
                            autorename: false,
                            mute: true
                        })
                    },
                    body: content
                });

                return response.ok;
            } catch (error) {
                console.error('Dropbox upload error:', error);
                return false;
            }
        }

        async function saveOrderToDropbox(order) {
            if (!DropboxConfig.autoSync || !DropboxConfig.token) return;

            const basePath = DropboxConfig.basePath;
            const date = new Date(order.date);
            const yearMonth = date.toISOString().slice(0, 7); // YYYY-MM

            // Sauvegarder le JSON de la commande
            const jsonPath = basePath + '/Commandes/' + yearMonth + '/' + order.id + '.json';
            await uploadToDropbox(jsonPath, JSON.stringify(order, null, 2));

            console.log('📤 Commande sauvegardée sur Dropbox:', order.id);
        }

        async function saveClientToDropbox(client) {
            if (!DropboxConfig.autoSync || !DropboxConfig.token) return;

            const basePath = DropboxConfig.basePath;
            const jsonPath = basePath + '/Clients/' + client.num + '_' + client.name.replace(/[^a-zA-Z0-9]/g, '_') + '.json';
            await uploadToDropbox(jsonPath, JSON.stringify(client, null, 2));

            console.log('📤 Client sauvegardé sur Dropbox:', client.name);
        }

        async function saveArticleToDropbox(article) {
            if (!DropboxConfig.autoSync || !DropboxConfig.token) return;

            const basePath = DropboxConfig.basePath;
            const jsonPath = basePath + '/Articles/' + article.num + '_' + article.name.replace(/[^a-zA-Z0-9]/g, '_') + '.json';
            await uploadToDropbox(jsonPath, JSON.stringify(article, null, 2));

            console.log('📤 Article sauvegardé sur Dropbox:', article.name);
        }

        // Sauvegarder toutes les données
        async function syncAllToDropbox() {
            if (!DropboxConfig.token) {
                alert('❌ Dropbox non configuré');
                return;
            }

            const basePath = DropboxConfig.basePath;

            // Clients
            const clientsJson = JSON.stringify(QOData.clients, null, 2);
            await uploadToDropbox(basePath + '/Clients/_all_clients.json', clientsJson);

            // Articles
            const articlesJson = JSON.stringify(ArticlesData, null, 2);
            await uploadToDropbox(basePath + '/Articles/_all_articles.json', articlesJson);

            // Commandes
            const ordersJson = JSON.stringify(QOData.orders, null, 2);
            await uploadToDropbox(basePath + '/Commandes/_all_orders.json', ordersJson);

            // Utilisateurs (pour multi-appareils)
            const usersJson = JSON.stringify(UsersData.users, null, 2);
            await uploadToDropbox(basePath + '/System/_users.json', usersJson);

            // Timestamp de dernière sync
            const syncMeta = { lastSync: new Date().toISOString(), device: navigator.userAgent.substring(0, 50) };
            await uploadToDropbox(basePath + '/System/_sync_meta.json', JSON.stringify(syncMeta, null, 2));

            DropboxSync.lastSync = new Date();
            updateSyncIndicator('success');
            alert('✅ Toutes les données synchronisées sur Dropbox !');
        }

        // =====================================================
        // SYNCHRONISATION DROPBOX MULTI-UTILISATEURS
        // =====================================================

        const DropboxSync = {
            enabled: false,
            interval: null,
            syncFrequency: 30000, // 30 secondes
            lastSync: null,
            isSyncing: false
        };

        // Télécharger un fichier depuis Dropbox
        async function downloadFromDropbox(path) {
            if (!DropboxConfig.token) return null;

            try {
                const response = await fetch('https://content.dropboxapi.com/2/files/download', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + DropboxConfig.token,
                        'Dropbox-API-Arg': JSON.stringify({ path: path })
                    }
                });

                if (response.ok) {
                    const text = await response.text();
                    return JSON.parse(text);
                } else if (response.status === 409) {
                    // Fichier n'existe pas
                    return null;
                }
                return null;
            } catch (error) {
                console.log('Dropbox download error:', error);
                return null;
            }
        }

        // Synchroniser depuis Dropbox (télécharger les données)
        async function syncFromDropbox(silent = true) {
            if (!DropboxConfig.token || !DropboxConfig.connected) {
                if (!silent) alert('❌ Dropbox non connecté');
                return false;
            }

            if (DropboxSync.isSyncing) return false;
            DropboxSync.isSyncing = true;
            updateSyncIndicator('syncing');

            const basePath = DropboxConfig.basePath;
            let updated = false;

            try {
                // Télécharger les clients
                const remoteClients = await downloadFromDropbox(basePath + '/Clients/_all_clients.json');
                if (remoteClients && Array.isArray(remoteClients) && remoteClients.length > 0) {
                    // Fusionner les données (garder les plus récentes)
                    const mergedClients = mergeData(QOData.clients, remoteClients, 'id');
                    if (JSON.stringify(mergedClients) !== JSON.stringify(QOData.clients)) {
                        QOData.clients = mergedClients;
                        saveQOData('clients');
                        updated = true;
                    }
                }

                // Télécharger les articles
                const remoteArticles = await downloadFromDropbox(basePath + '/Articles/_all_articles.json');
                if (remoteArticles && remoteArticles.articles) {
                    const mergedArticles = mergeData(ArticlesData.articles, remoteArticles.articles, 'id');
                    if (JSON.stringify(mergedArticles) !== JSON.stringify(ArticlesData.articles)) {
                        ArticlesData.articles = mergedArticles;
                        ArticlesData.categories = remoteArticles.categories || ArticlesData.categories;
                        ArticlesData.priceLists = remoteArticles.priceLists || ArticlesData.priceLists;
                        saveArticlesData();
                        updated = true;
                    }
                }

                // Télécharger les commandes
                const remoteOrders = await downloadFromDropbox(basePath + '/Commandes/_all_orders.json');
                if (remoteOrders && Array.isArray(remoteOrders)) {
                    const mergedOrders = mergeData(QOData.orders, remoteOrders, 'id');
                    if (JSON.stringify(mergedOrders) !== JSON.stringify(QOData.orders)) {
                        QOData.orders = mergedOrders;
                        saveQOData('orders');
                        updated = true;
                    }
                }

                // Télécharger les utilisateurs
                const remoteUsers = await downloadFromDropbox(basePath + '/System/_users.json');
                if (remoteUsers && Array.isArray(remoteUsers) && remoteUsers.length > 0) {
                    const mergedUsers = mergeData(UsersData.users, remoteUsers, 'id');
                    if (JSON.stringify(mergedUsers) !== JSON.stringify(UsersData.users)) {
                        UsersData.users = mergedUsers;
                        // Mettre à jour l'utilisateur courant si modifié
                        const currentFromList = UsersData.users.find(u => u.id === UsersData.currentUser?.id);
                        if (currentFromList) {
                            UsersData.currentUser = currentFromList;
                        }
                        saveUsersData();
                        updated = true;
                    }
                }

                DropboxSync.lastSync = new Date();
                updateSyncIndicator('success');

                if (updated && !silent) {
                    showSyncNotification('📥 Données synchronisées depuis Dropbox');
                }

                return true;
            } catch (error) {
                console.error('Sync from Dropbox error:', error);
                updateSyncIndicator('error');
                return false;
            } finally {
                DropboxSync.isSyncing = false;
            }
        }

        // Fusionner les données locales et distantes
        function mergeData(localData, remoteData, idField = 'id') {
            if (!localData || !Array.isArray(localData)) localData = [];
            if (!remoteData || !Array.isArray(remoteData)) return localData;

            const merged = new Map();

            // Ajouter les données locales
            localData.forEach(item => {
                if (item && item[idField]) {
                    merged.set(item[idField], item);
                }
            });

            // Fusionner avec les données distantes (distant gagne si plus récent ou si local n'existe pas)
            remoteData.forEach(item => {
                if (item && item[idField]) {
                    const existing = merged.get(item[idField]);
                    if (!existing) {
                        // Nouvel élément depuis le distant
                        merged.set(item[idField], item);
                    } else {
                        // Comparer les dates de modification si disponibles
                        const localDate = existing.updatedAt || existing.createdAt || 0;
                        const remoteDate = item.updatedAt || item.createdAt || 0;
                        if (new Date(remoteDate) > new Date(localDate)) {
                            merged.set(item[idField], item);
                        }
                    }
                }
            });

            return Array.from(merged.values());
        }

        // Envoyer les données vers Dropbox (upload)
        async function syncToDropbox(dataType = 'all') {
            if (!DropboxConfig.token || !DropboxConfig.connected) return false;
            if (DropboxSync.isSyncing) return false;

            DropboxSync.isSyncing = true;
            updateSyncIndicator('syncing');

            const basePath = DropboxConfig.basePath;

            try {
                if (dataType === 'all' || dataType === 'clients') {
                    const clientsJson = JSON.stringify(QOData.clients, null, 2);
                    await uploadToDropboxDirect(basePath + '/Clients/_all_clients.json', clientsJson);
                }

                if (dataType === 'all' || dataType === 'articles') {
                    const articlesJson = JSON.stringify(ArticlesData, null, 2);
                    await uploadToDropboxDirect(basePath + '/Articles/_all_articles.json', articlesJson);
                }

                if (dataType === 'all' || dataType === 'orders') {
                    const ordersJson = JSON.stringify(QOData.orders, null, 2);
                    await uploadToDropboxDirect(basePath + '/Commandes/_all_orders.json', ordersJson);
                }

                if (dataType === 'all' || dataType === 'users') {
                    const usersJson = JSON.stringify(UsersData.users, null, 2);
                    await uploadToDropboxDirect(basePath + '/System/_users.json', usersJson);
                }

                DropboxSync.lastSync = new Date();
                updateSyncIndicator('success');
                return true;
            } catch (error) {
                console.error('Sync to Dropbox error:', error);
                updateSyncIndicator('error');
                return false;
            } finally {
                DropboxSync.isSyncing = false;
            }
        }

        // Démarrer la synchronisation automatique
        function startDropboxSync() {
            if (DropboxSync.interval) {
                clearInterval(DropboxSync.interval);
            }

            DropboxSync.enabled = true;
            DropboxSync.interval = setInterval(async () => {
                if (DropboxConfig.connected && DropboxConfig.autoSync) {
                    await syncFromDropbox(true);
                }
            }, DropboxSync.syncFrequency);

            // Sync immédiate au démarrage
            if (DropboxConfig.connected) {
                syncFromDropbox(true);
            }

            console.log('🔄 Dropbox sync started (every ' + (DropboxSync.syncFrequency / 1000) + 's)');
        }

        // Arrêter la synchronisation automatique
        function stopDropboxSync() {
            if (DropboxSync.interval) {
                clearInterval(DropboxSync.interval);
                DropboxSync.interval = null;
            }
            DropboxSync.enabled = false;
            console.log('⏹️ Dropbox sync stopped');
        }

        // Mettre à jour l'indicateur de sync dans le header
        function updateSyncIndicator(status) {
            const indicator = document.getElementById('sync-indicator');
            if (!indicator) return;

            const icons = {
                'success': '🟢',
                'syncing': '🔄',
                'error': '🔴',
                'offline': '⚪'
            };

            indicator.textContent = icons[status] || '⚪';
            indicator.title = status === 'success' ? 'Synchronisé' :
                             status === 'syncing' ? 'Synchronisation...' :
                             status === 'error' ? 'Erreur de sync' : 'Non connecté';

            // Animation pour syncing
            if (status === 'syncing') {
                indicator.style.animation = 'spin 1s linear infinite';
            } else {
                indicator.style.animation = 'none';
            }
        }

        // Notification de sync
        function showSyncNotification(message) {
            const notif = document.createElement('div');
            notif.style.cssText = 'position:fixed; bottom:20px; right:20px; padding:12px 20px; background:var(--accent-primary); color:#000; border-radius:10px; font-weight:600; z-index:9999; animation:slideIn 0.3s ease;';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        // Forcer une synchronisation manuelle
        async function forceSyncNow() {
            if (!DropboxConfig.connected) {
                alert('❌ Dropbox non connecté');
                return;
            }

            showSyncNotification('🔄 Synchronisation complète en cours...');

            try {
                // 1. D'abord télécharger depuis Dropbox
                await syncFromDropbox(true);

                // 2. Puis envoyer les modifications locales
                await syncToDropbox('all');

                // 3. Créer et envoyer une sauvegarde complète (en mode silencieux)
                await createTrakioBackup(true);

                showSyncNotification('✅ Sync complète + Backup Dropbox !');
            } catch (error) {
                console.error('Erreur sync:', error);
                showSyncNotification('⚠️ Sync partielle - voir console');
            }
        }

        // Initialiser la sync au chargement si Dropbox est configuré
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (DropboxConfig.token && DropboxConfig.autoSync) {
                    testDropboxConnection(true).then(connected => {
                        if (connected) {
                            startDropboxSync();
                        }
                    });
                }
            }, 2000); // Attendre 2s après le chargement
        });

        // =====================================================
        // SETTINGS - Company & Data Management
        // =====================================================

        function saveCompanySettings() {
            const settings = {
                company: document.getElementById('settings-company').value,
                email: document.getElementById('settings-email').value,
                phone: document.getElementById('settings-phone').value,
                currency: document.getElementById('settings-currency').value
            };
            localStorage.setItem('trakio_company_settings', JSON.stringify(settings));
            alert('✅ Paramètres entreprise enregistrés !');
        }

        function loadCompanySettings() {
            const saved = localStorage.getItem('trakio_company_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                if (document.getElementById('settings-company')) {
                    document.getElementById('settings-company').value = settings.company || 'La Traversette';
                    document.getElementById('settings-email').value = settings.email || '';
                    document.getElementById('settings-phone').value = settings.phone || '';
                    document.getElementById('settings-currency').value = settings.currency || 'CHF';
                }
            }
        }

        function exportAllData() {
            const data = {
                clients: QOData.clients,
                orders: QOData.orders,
                products: QOData.products,
                articles: ArticlesData,
                settings: JSON.parse(localStorage.getItem('trakio_company_settings') || '{}'),
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'trakio_backup_' + new Date().toISOString().slice(0, 10) + '.json';
            link.click();
        }

        function importAllData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (data.clients) {
                        QOData.clients = data.clients;
                        saveQOData('clients');
                    }
                    if (data.orders) {
                        QOData.orders = data.orders;
                        saveQOData('orders');
                    }
                    if (data.articles) {
                        ArticlesData = { ...ArticlesData, ...data.articles };
                        saveArticlesData();
                    }
                    if (data.settings) {
                        localStorage.setItem('trakio_company_settings', JSON.stringify(data.settings));
                    }

                    alert('✅ Données importées avec succès !\n\nClients: ' + (data.clients?.length || 0) + '\nCommandes: ' + (data.orders?.length || 0));
                    location.reload();
                } catch (error) {
                    alert('❌ Erreur lors de l\'import: ' + error.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function clearAllData() {
            if (!confirm('⚠️ ATTENTION !\n\nCette action va supprimer TOUTES les données:\n- Clients\n- Commandes\n- Articles\n- Paramètres\n\nÊtes-vous sûr ?')) return;
            if (!confirm('🔴 DERNIÈRE CONFIRMATION\n\nToutes les données seront perdues définitivement.\n\nConfirmer la suppression ?')) return;

            localStorage.clear();
            alert('✅ Toutes les données ont été supprimées.\n\nLa page va se recharger.');
            location.reload();
        }

        // =====================================================
        // SYSTÈME DE MISE À JOUR TRAKIO - Sauvegarde complète
        // =====================================================

        const TRAKIO_VERSION = '2.9.3';
        const TRAKIO_BUILD_DATE = '2025-11-29';

        function initTrakioVersionInfo() {
            const versionEl = document.getElementById('trakio-version');
            const dateEl = document.getElementById('trakio-update-date');
            const navVersionEl = document.getElementById('nav-version');

            if (versionEl) versionEl.textContent = TRAKIO_VERSION;
            if (dateEl) dateEl.textContent = TRAKIO_BUILD_DATE;
            if (navVersionEl) navVersionEl.textContent = 'v' + TRAKIO_VERSION;

            // Charger l'historique des sauvegardes
            loadBackupHistory();
        }

        async function createTrakioBackup(silent = false) {
            // Collecter TOUTES les données du localStorage
            const backup = {
                _meta: {
                    type: 'TRAKIO_FULL_BACKUP',
                    version: TRAKIO_VERSION,
                    createdAt: new Date().toISOString(),
                    device: navigator.userAgent.substring(0, 50)
                },
                localStorage: {}
            };

            // Sauvegarder toutes les clés du localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                try {
                    backup.localStorage[key] = localStorage.getItem(key);
                } catch (e) {
                    console.warn('Impossible de sauvegarder:', key);
                }
            }

            // Créer le fichier
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `TRAKIO_BACKUP_${timestamp}.json`;

            // Télécharger localement si pas en mode silencieux
            if (!silent) {
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
            }

            // Envoyer sur Dropbox
            const dropboxSuccess = await uploadBackupToDropbox(backup, filename);

            // Enregistrer dans l'historique
            saveBackupToHistory(filename, dropboxSuccess);

            // Notification
            if (!silent) {
                if (dropboxSuccess) {
                    showToast('✅ Sauvegarde créée et envoyée sur Dropbox', 'success');
                } else {
                    showToast('✅ Sauvegarde locale créée (Dropbox non connecté)', 'success');
                }
            }

            return dropboxSuccess;
        }

        async function uploadBackupToDropbox(backup, filename) {
            if (!DropboxConfig.accessToken) {
                console.log('Dropbox non configuré, sauvegarde locale uniquement');
                return false;
            }

            try {
                const path = `${DropboxConfig.basePath}/System/Backups/${filename}`;

                const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${DropboxConfig.accessToken}`,
                        'Content-Type': 'application/octet-stream',
                        'Dropbox-API-Arg': JSON.stringify({
                            path: path,
                            mode: 'overwrite',
                            autorename: false
                        })
                    },
                    body: JSON.stringify(backup, null, 2)
                });

                if (response.ok) {
                    console.log('✅ Backup envoyé sur Dropbox:', path);
                    return true;
                } else {
                    console.error('❌ Erreur upload backup Dropbox:', await response.text());
                    return false;
                }
            } catch (error) {
                console.error('Erreur upload backup:', error);
                return false;
            }
        }

        function restoreTrakioBackup(input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm('⚠️ RESTAURATION\n\nCette action va remplacer toutes vos données actuelles par celles de la sauvegarde.\n\nVoulez-vous continuer ?')) {
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);

                    // Vérifier que c'est une sauvegarde TRAKIO valide
                    if (!backup._meta || backup._meta.type !== 'TRAKIO_FULL_BACKUP') {
                        // Essayer l'ancien format
                        if (backup.clients || backup.orders || backup.articles) {
                            importAllData({ files: [file] });
                            return;
                        }
                        throw new Error('Ce fichier n\'est pas une sauvegarde TRAKIO valide');
                    }

                    // Restaurer toutes les données du localStorage
                    let restoredCount = 0;
                    for (const [key, value] of Object.entries(backup.localStorage)) {
                        try {
                            localStorage.setItem(key, value);
                            restoredCount++;
                        } catch (e) {
                            console.warn('Impossible de restaurer:', key);
                        }
                    }

                    alert(`✅ Restauration terminée !\n\n` +
                          `Version sauvegarde: ${backup._meta.version}\n` +
                          `Date sauvegarde: ${new Date(backup._meta.createdAt).toLocaleString('fr-CH')}\n` +
                          `Données restaurées: ${restoredCount} éléments\n\n` +
                          `La page va se recharger.`);

                    location.reload();

                } catch (error) {
                    alert('❌ Erreur lors de la restauration:\n' + error.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function saveBackupToHistory(filename, dropboxSynced = false) {
            const history = JSON.parse(localStorage.getItem('trakio_backup_history') || '[]');
            history.unshift({
                filename: filename,
                date: new Date().toISOString(),
                version: TRAKIO_VERSION,
                dropbox: dropboxSynced
            });
            // Garder seulement les 5 dernières
            localStorage.setItem('trakio_backup_history', JSON.stringify(history.slice(0, 5)));
            loadBackupHistory();
        }

        function loadBackupHistory() {
            const historyEl = document.getElementById('backup-history');
            if (!historyEl) return;

            const history = JSON.parse(localStorage.getItem('trakio_backup_history') || '[]');

            if (history.length === 0) {
                historyEl.innerHTML = '<div style="color:var(--text-muted);">Aucune sauvegarde récente</div>';
                return;
            }

            historyEl.innerHTML = history.map(h => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid var(--border-color);">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <span style="font-size:14px;">${h.dropbox ? '☁️' : '💾'}</span>
                        <span style="font-family:'Space Mono',monospace; font-size:11px;">${h.filename.substring(0, 25)}...</span>
                    </div>
                    <span style="color:var(--text-muted); font-size:11px;">${new Date(h.date).toLocaleDateString('fr-CH')}</span>
                </div>
            `).join('');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position:fixed; bottom:100px; left:50%; transform:translateX(-50%);
                padding:16px 24px; border-radius:12px; z-index:99999;
                font-weight:600; box-shadow:0 8px 32px rgba(0,0,0,0.3);
                animation: slideUp 0.3s ease;
                ${type === 'success' ? 'background:var(--accent-primary); color:#000;' :
                  type === 'error' ? 'background:var(--accent-danger); color:#fff;' :
                  'background:var(--bg-card); color:var(--text-primary); border:1px solid var(--border-color);'}
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // =====================================================
        // ANALYTICS - Graphiques et Statistiques
        // =====================================================

        let analyticsCharts = {};

        function initAnalytics() {
            // Détruire les anciens charts s'ils existent
            Object.values(analyticsCharts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            analyticsCharts = {};

            updateAnalytics();
        }

        function updateAnalytics() {
            const period = parseInt(document.getElementById('analysis-period')?.value || 30);

            // Collecter les données
            const data = collectAnalyticsData(period);

            // Mettre à jour les KPIs
            updateKPIs(data);

            // Créer les graphiques
            createRevenueChart(data);
            createSourcesChart(data);
            createOrdersDayChart(data);
            createTopClientsChart(data);

            // Mettre à jour les tableaux
            updateRecentOrdersTable(data);
            updateStatsDetails(data);
        }

        function collectAnalyticsData(days) {
            const now = new Date();
            const startDate = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));

            // Commandes QuickOrder
            const qoOrders = (typeof QOData !== 'undefined' && QOData.orders) ? QOData.orders : [];
            const qoClients = (typeof QOData !== 'undefined' && QOData.clients) ? QOData.clients : [];

            // Commandes Shopify
            const shopifyOrders = JSON.parse(localStorage.getItem('shopify_orders') || '[]');
            const shopifyProcessed = JSON.parse(localStorage.getItem('shopify_processed') || '[]');

            // Articles
            const articles = (typeof ArticlesData !== 'undefined' && ArticlesData.items) ? ArticlesData.items : [];

            // Filtrer par période
            const filteredQO = qoOrders.filter(o => {
                if (!o.createdAt) return false;
                return new Date(o.createdAt) >= startDate;
            });

            const filteredShopify = shopifyOrders.filter(o => {
                if (!o.createdAt) return true; // Garder si pas de date
                return new Date(o.createdAt) >= startDate;
            });

            // Calculer les revenus
            const qoRevenue = filteredQO.reduce((sum, o) => sum + (parseFloat(o.totalTTC) || 0), 0);
            const shopifyRevenue = filteredShopify.reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);

            // Grouper par jour pour les graphiques
            const revenueByDay = {};
            const ordersByDay = {};

            for (let i = 0; i < days; i++) {
                const date = new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));
                const dateStr = date.toISOString().slice(0, 10);
                revenueByDay[dateStr] = 0;
                ordersByDay[dateStr] = 0;
            }

            filteredQO.forEach(o => {
                if (o.createdAt) {
                    const dateStr = new Date(o.createdAt).toISOString().slice(0, 10);
                    if (revenueByDay[dateStr] !== undefined) {
                        revenueByDay[dateStr] += parseFloat(o.totalTTC) || 0;
                        ordersByDay[dateStr]++;
                    }
                }
            });

            filteredShopify.forEach(o => {
                if (o.createdAt) {
                    const dateStr = new Date(o.createdAt).toISOString().slice(0, 10);
                    if (revenueByDay[dateStr] !== undefined) {
                        revenueByDay[dateStr] += parseFloat(o.total) || 0;
                        ordersByDay[dateStr]++;
                    }
                }
            });

            // Top clients
            const clientRevenue = {};
            filteredQO.forEach(o => {
                const name = o.clientName || 'Inconnu';
                clientRevenue[name] = (clientRevenue[name] || 0) + (parseFloat(o.totalTTC) || 0);
            });

            const topClients = Object.entries(clientRevenue)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // Shopify stats
            const shopifyUrgent = filteredShopify.filter(o =>
                o.financialStatus === 'paid' &&
                o.fulfillmentStatus === 'unfulfilled' &&
                !o.processed &&
                !shopifyProcessed.includes(o.name)
            ).length;

            const shopifyPending = filteredShopify.filter(o => o.financialStatus === 'pending').length;
            const shopifyDone = filteredShopify.filter(o => o.processed || o.fulfillmentStatus === 'fulfilled').length;

            // B2B vs B2C
            const b2b = qoClients.filter(c => c.type === 'B2B').length;
            const b2c = qoClients.filter(c => c.type === 'B2C').length;

            return {
                period: days,
                totalRevenue: qoRevenue + shopifyRevenue,
                qoRevenue,
                shopifyRevenue,
                totalOrders: filteredQO.length + filteredShopify.length,
                qoOrders: filteredQO.length,
                shopifyOrders: filteredShopify.length,
                totalClients: qoClients.length,
                totalArticles: articles.length,
                revenueByDay,
                ordersByDay,
                topClients,
                b2b,
                b2c,
                shopifyUrgent,
                shopifyPending,
                shopifyDone,
                avgBasket: (filteredQO.length + filteredShopify.length) > 0
                    ? (qoRevenue + shopifyRevenue) / (filteredQO.length + filteredShopify.length)
                    : 0,
                ordersPerDay: (filteredQO.length + filteredShopify.length) / days,
                recentOrders: [...filteredQO.map(o => ({...o, source: 'QuickOrder'})),
                               ...filteredShopify.map(o => ({...o, source: 'Shopify'}))]
                    .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))
                    .slice(0, 10)
            };
        }

        function updateKPIs(data) {
            document.getElementById('kpi-revenue').textContent = formatNumber(data.totalRevenue);
            document.getElementById('kpi-orders').textContent = data.totalOrders;
            document.getElementById('kpi-clients').textContent = data.totalClients;
            document.getElementById('kpi-shopify').textContent = data.shopifyOrders;
            document.getElementById('kpi-articles').textContent = data.totalArticles;
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.round(num).toLocaleString('fr-CH');
        }

        function createRevenueChart(data) {
            const ctx = document.getElementById('chart-revenue');
            if (!ctx) return;

            if (analyticsCharts.revenue) analyticsCharts.revenue.destroy();

            const labels = Object.keys(data.revenueByDay).sort();
            const values = labels.map(d => data.revenueByDay[d]);

            analyticsCharts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(d => {
                        const date = new Date(d);
                        return date.toLocaleDateString('fr-CH', { day: '2-digit', month: 'short' });
                    }),
                    datasets: [{
                        label: 'CA (CHF)',
                        data: values,
                        borderColor: '#06d6a0',
                        backgroundColor: 'rgba(6, 214, 160, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888', maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function createSourcesChart(data) {
            const ctx = document.getElementById('chart-sources');
            if (!ctx) return;

            if (analyticsCharts.sources) analyticsCharts.sources.destroy();

            analyticsCharts.sources = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['QuickOrder', 'Shopify'],
                    datasets: [{
                        data: [data.qoRevenue, data.shopifyRevenue],
                        backgroundColor: ['#06d6a0', '#96bf48'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#888', padding: 20 }
                        }
                    }
                }
            });
        }

        function createOrdersDayChart(data) {
            const ctx = document.getElementById('chart-orders-day');
            if (!ctx) return;

            if (analyticsCharts.ordersDay) analyticsCharts.ordersDay.destroy();

            const labels = Object.keys(data.ordersByDay).sort().slice(-14); // 2 dernières semaines
            const values = labels.map(d => data.ordersByDay[d]);

            analyticsCharts.ordersDay = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(d => {
                        const date = new Date(d);
                        return date.toLocaleDateString('fr-CH', { day: '2-digit', month: 'short' });
                    }),
                    datasets: [{
                        label: 'Commandes',
                        data: values,
                        backgroundColor: '#118ab2',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888', stepSize: 1 }
                        }
                    }
                }
            });
        }

        function createTopClientsChart(data) {
            const ctx = document.getElementById('chart-top-clients');
            if (!ctx) return;

            if (analyticsCharts.topClients) analyticsCharts.topClients.destroy();

            const labels = data.topClients.map(c => c[0].substring(0, 20));
            const values = data.topClients.map(c => c[1]);

            if (labels.length === 0) {
                labels.push('Aucune donnée');
                values.push(0);
            }

            analyticsCharts.topClients = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'CA (CHF)',
                        data: values,
                        backgroundColor: ['#06d6a0', '#118ab2', '#ffd166', '#9c88ff', '#ff6b6b'],
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function updateRecentOrdersTable(data) {
            const tbody = document.getElementById('table-recent-orders');
            if (!tbody) return;

            if (data.recentOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--text-muted); padding:20px;">Aucune commande</td></tr>';
                return;
            }

            tbody.innerHTML = data.recentOrders.map(o => {
                const date = o.createdAt ? new Date(o.createdAt).toLocaleDateString('fr-CH') : '-';
                const amount = o.source === 'Shopify' ? (o.total || 0).toFixed(2) : (o.totalTTC || 0).toFixed(2);
                const orderNum = o.source === 'Shopify' ? o.name : (o.id || '-');
                const client = o.source === 'Shopify' ? (o.billingName || o.shippingName || '-') : (o.clientName || '-');
                const sourceColor = o.source === 'Shopify' ? '#96bf48' : 'var(--accent-primary)';
                const sourceIcon = o.source === 'Shopify' ? '🛍️' : '⚡';

                return `
                    <tr>
                        <td style="font-weight:600;">${orderNum}</td>
                        <td>${client}</td>
                        <td style="color:var(--text-muted);">${date}</td>
                        <td style="font-family:'Space Mono',monospace; font-weight:600;">${amount} CHF</td>
                        <td><span style="padding:3px 8px; background:${sourceColor}20; color:${sourceColor}; border-radius:4px; font-size:11px;">${sourceIcon} ${o.source}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function updateStatsDetails(data) {
            document.getElementById('stat-avg-basket').textContent = data.avgBasket.toFixed(2) + ' CHF';
            document.getElementById('stat-b2b').textContent = data.b2b;
            document.getElementById('stat-b2c').textContent = data.b2c;
            document.getElementById('stat-orders-day').textContent = data.ordersPerDay.toFixed(1);

            document.getElementById('stat-shopify-urgent').textContent = data.shopifyUrgent;
            document.getElementById('stat-shopify-pending').textContent = data.shopifyPending;
            document.getElementById('stat-shopify-done').textContent = data.shopifyDone;
            document.getElementById('stat-shopify-revenue').textContent = data.shopifyRevenue.toFixed(0) + ' CHF';

            // Tendance
            const trend = document.getElementById('stat-trend');
            if (data.totalOrders > 0) {
                const shopifyPct = ((data.shopifyOrders / data.totalOrders) * 100).toFixed(0);
                const qoPct = ((data.qoOrders / data.totalOrders) * 100).toFixed(0);
                trend.innerHTML = `
                    Sur les ${data.period} derniers jours:<br>
                    • <strong>${data.totalOrders}</strong> commandes pour <strong>${data.totalRevenue.toFixed(0)} CHF</strong><br>
                    • Shopify: ${shopifyPct}% des commandes<br>
                    • QuickOrder: ${qoPct}% des commandes<br>
                    • Panier moyen: <strong>${data.avgBasket.toFixed(2)} CHF</strong>
                `;
            } else {
                trend.innerHTML = 'Aucune donnée disponible pour cette période.';
            }
        }

        // =====================================================
        // TRACKING - Suivi des commandes
        // =====================================================

        let trackingWeekOffset = 0;
        let allTrackingOrders = [];

        function initTracking() {
            trackingWeekOffset = 0;
            updateTrackingView();
        }

        function updateTrackingView() {
            const sourceFilter = document.getElementById('tracking-source-filter')?.value || 'all';

            // Collecter toutes les commandes
            allTrackingOrders = collectAllOrders(sourceFilter);

            // Mettre à jour les KPIs
            updateTrackingKPIs(allTrackingOrders);

            // Mettre à jour le pipeline
            updateTrackingPipeline(allTrackingOrders);

            // Mettre à jour le calendrier
            updateTrackingCalendar(allTrackingOrders);

            // Mettre à jour la timeline
            updateTrackingTimeline(allTrackingOrders);

            // Mettre à jour le tableau
            updateTrackingTable(allTrackingOrders);
        }

        function collectAllOrders(sourceFilter) {
            let orders = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // QuickOrder
            if (sourceFilter === 'all' || sourceFilter === 'quickorder') {
                const qoOrders = (typeof QOData !== 'undefined' && QOData.orders) ? QOData.orders : [];
                qoOrders.forEach(o => {
                    orders.push({
                        id: o.id || 'QO-' + Math.random().toString(36).substr(2, 6),
                        source: 'quickorder',
                        sourceIcon: '⚡',
                        sourceColor: '#06d6a0',
                        orderNumber: o.id || '-',
                        client: o.clientName || 'Client inconnu',
                        clientPhone: o.clientPhone || '',
                        deliveryDate: o.deliveryDate ? new Date(o.deliveryDate) : null,
                        deliveryDateStr: o.deliveryDate || '',
                        location: o.deliveryAddress || 'À définir',
                        amount: parseFloat(o.totalTTC) || 0,
                        status: mapQOStatus(o.status),
                        rawStatus: o.status,
                        createdAt: o.createdAt ? new Date(o.createdAt) : new Date(),
                        items: o.items || [],
                        notes: o.notes || ''
                    });
                });
            }

            // Shopify
            if (sourceFilter === 'all' || sourceFilter === 'shopify') {
                const shopifyOrders = JSON.parse(localStorage.getItem('shopify_orders') || '[]');
                const shopifyProcessed = JSON.parse(localStorage.getItem('shopify_processed') || '[]');

                shopifyOrders.forEach(o => {
                    const pickupDate = parseShopifyPickupDate(o.pickupDate);
                    const isProcessed = o.processed || shopifyProcessed.includes(o.name);

                    orders.push({
                        id: o.name || 'SH-' + Math.random().toString(36).substr(2, 6),
                        source: 'shopify',
                        sourceIcon: '🛍️',
                        sourceColor: '#96bf48',
                        orderNumber: o.name || '-',
                        client: o.billingName || o.shippingName || 'Client Shopify',
                        clientPhone: o.phone || '',
                        deliveryDate: pickupDate,
                        deliveryDateStr: o.pickupDate || '',
                        location: o.pickupLocation || 'Retrait magasin',
                        amount: parseFloat(o.total) || 0,
                        status: mapShopifyStatus(o, isProcessed),
                        rawStatus: o.fulfillmentStatus,
                        createdAt: o.createdAt ? new Date(o.createdAt) : new Date(),
                        items: o.lineItems || [],
                        notes: o.notes || '',
                        pickupTime: o.pickupTime || ''
                    });
                });
            }

            // MyFish
            if (sourceFilter === 'all' || sourceFilter === 'myfish') {
                const myfishOrders = JSON.parse(localStorage.getItem('myfish_orders') || '[]');
                myfishOrders.forEach(o => {
                    orders.push({
                        id: o.id || 'MF-' + Math.random().toString(36).substr(2, 6),
                        source: 'myfish',
                        sourceIcon: '🐟',
                        sourceColor: '#118ab2',
                        orderNumber: o.orderNumber || o.id || '-',
                        client: o.clientName || 'Client MyFish',
                        clientPhone: o.clientPhone || '',
                        deliveryDate: o.deliveryDate ? new Date(o.deliveryDate) : null,
                        deliveryDateStr: o.deliveryDate || '',
                        location: o.store || o.deliveryAddress || 'À définir',
                        amount: parseFloat(o.total) || 0,
                        status: mapMyFishStatus(o.status),
                        rawStatus: o.status,
                        createdAt: o.createdAt ? new Date(o.createdAt) : new Date(),
                        items: o.items || [],
                        notes: o.notes || ''
                    });
                });
            }

            // Trier par date de livraison
            orders.sort((a, b) => {
                if (!a.deliveryDate && !b.deliveryDate) return 0;
                if (!a.deliveryDate) return 1;
                if (!b.deliveryDate) return -1;
                return a.deliveryDate - b.deliveryDate;
            });

            return orders;
        }

        function parseShopifyPickupDate(dateStr) {
            if (!dateStr) return null;
            const months = { 'Jan':0, 'Feb':1, 'Mar':2, 'Apr':3, 'May':4, 'Jun':5, 'Jul':6, 'Aug':7, 'Sep':8, 'Oct':9, 'Nov':10, 'Dec':11 };
            const match = dateStr.match(/(\d{1,2})\s+(\w{3})\s+(\d{4})/);
            if (match) {
                const day = parseInt(match[1]);
                const month = months[match[2]];
                const year = parseInt(match[3]);
                if (month !== undefined) return new Date(year, month, day);
            }
            return null;
        }

        function mapQOStatus(status) {
            const map = {
                'pending': 'pending',
                'confirmed': 'preparing',
                'preparing': 'preparing',
                'ready': 'ready',
                'shipped': 'ready',
                'delivered': 'delivered',
                'cancelled': 'cancelled'
            };
            return map[status] || 'pending';
        }

        function mapShopifyStatus(order, isProcessed) {
            if (order.fulfillmentStatus === 'fulfilled' || isProcessed) return 'delivered';
            if (order.financialStatus === 'paid') return 'preparing';
            return 'pending';
        }

        function mapMyFishStatus(status) {
            const map = {
                'new': 'pending',
                'confirmed': 'preparing',
                'production': 'preparing',
                'ready': 'ready',
                'delivered': 'delivered',
                'cancelled': 'cancelled'
            };
            return map[status] || 'pending';
        }

        function updateTrackingKPIs(orders) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const pending = orders.filter(o => o.status === 'pending').length;
            const preparing = orders.filter(o => o.status === 'preparing').length;
            const ready = orders.filter(o => o.status === 'ready').length;
            const delivered = orders.filter(o => o.status === 'delivered').length;
            const todayOrders = orders.filter(o => {
                if (!o.deliveryDate) return false;
                return o.deliveryDate >= today && o.deliveryDate < tomorrow;
            }).length;

            document.getElementById('tracking-pending').textContent = pending;
            document.getElementById('tracking-preparing').textContent = preparing;
            document.getElementById('tracking-ready').textContent = ready;
            document.getElementById('tracking-delivered').textContent = delivered;
            document.getElementById('tracking-today').textContent = todayOrders;
        }

        function updateTrackingPipeline(orders) {
            const columns = {
                pending: document.getElementById('pipeline-pending'),
                preparing: document.getElementById('pipeline-preparing'),
                ready: document.getElementById('pipeline-ready'),
                delivered: document.getElementById('pipeline-delivered')
            };

            const counts = {
                pending: 0,
                preparing: 0,
                ready: 0,
                delivered: 0
            };

            // Vider les colonnes
            Object.values(columns).forEach(col => { if (col) col.innerHTML = ''; });

            // Limiter aux 30 derniers jours pour la vue pipeline
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            orders.filter(o => o.status !== 'cancelled').forEach(order => {
                const col = columns[order.status];
                if (!col) return;

                counts[order.status]++;

                // Limiter le nombre affiché par colonne
                if (counts[order.status] > 10 && order.status === 'delivered') return;

                const dateStr = order.deliveryDate
                    ? order.deliveryDate.toLocaleDateString('fr-CH', { day: '2-digit', month: 'short' })
                    : '-';

                const isToday = order.deliveryDate && isDateToday(order.deliveryDate);
                const isLate = order.deliveryDate && order.deliveryDate < new Date() && order.status !== 'delivered';

                col.innerHTML += `
                    <div class="tracking-card" style="background:var(--bg-card); border-radius:8px; padding:10px; border-left:3px solid ${order.sourceColor}; ${isLate ? 'border:1px solid #ff6b6b;' : ''}" onclick="showTrackingOrderDetail('${order.id}', '${order.source}')">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <span style="font-size:11px; background:${order.sourceColor}20; color:${order.sourceColor}; padding:2px 6px; border-radius:4px;">${order.sourceIcon} ${order.orderNumber}</span>
                            ${isToday ? '<span style="font-size:10px; background:#ff6b6b; color:#fff; padding:2px 6px; border-radius:4px;">AUJOURD\'HUI</span>' : ''}
                            ${isLate ? '<span style="font-size:10px; background:#ff6b6b; color:#fff; padding:2px 6px; border-radius:4px;">⚠️ RETARD</span>' : ''}
                        </div>
                        <div style="font-weight:600; font-size:13px; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${order.client}</div>
                        <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--text-muted);">
                            <span>📅 ${dateStr}</span>
                            <span style="font-weight:600; color:var(--accent-primary);">${order.amount.toFixed(0)} CHF</span>
                        </div>
                        ${order.location ? `<div style="font-size:10px; color:var(--text-muted); margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">📍 ${order.location}</div>` : ''}
                    </div>
                `;
            });

            // Mettre à jour les compteurs
            document.getElementById('pipeline-pending-count').textContent = counts.pending;
            document.getElementById('pipeline-preparing-count').textContent = counts.preparing;
            document.getElementById('pipeline-ready-count').textContent = counts.ready;
            document.getElementById('pipeline-delivered-count').textContent = counts.delivered;
        }

        function isDateToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        function updateTrackingCalendar(orders) {
            const calendar = document.getElementById('tracking-calendar');
            const label = document.getElementById('tracking-week-label');
            if (!calendar) return;

            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (trackingWeekOffset * 7)); // Lundi

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            if (label) {
                const startStr = startOfWeek.toLocaleDateString('fr-CH', { day: '2-digit', month: 'short' });
                const endStr = endOfWeek.toLocaleDateString('fr-CH', { day: '2-digit', month: 'short' });
                label.textContent = `${startStr} - ${endStr}`;
            }

            const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            let html = '';

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);

                const dayOrders = orders.filter(o => {
                    if (!o.deliveryDate || o.status === 'delivered' || o.status === 'cancelled') return false;
                    return o.deliveryDate.toDateString() === date.toDateString();
                });

                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today && !isToday;

                html += `
                    <div style="background:${isToday ? 'linear-gradient(135deg, var(--accent-primary)20, var(--accent-secondary)20)' : 'var(--bg-primary)'}; border-radius:10px; padding:10px; ${isToday ? 'border:2px solid var(--accent-primary);' : ''} ${isPast ? 'opacity:0.5;' : ''}">
                        <div style="text-align:center; margin-bottom:8px;">
                            <div style="font-size:11px; color:var(--text-muted);">${days[i]}</div>
                            <div style="font-size:18px; font-weight:700; ${isToday ? 'color:var(--accent-primary);' : ''}">${date.getDate()}</div>
                        </div>
                        <div style="min-height:60px;">
                            ${dayOrders.slice(0, 3).map(o => `
                                <div style="font-size:10px; background:${o.sourceColor}20; color:${o.sourceColor}; padding:3px 6px; border-radius:4px; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${o.client}">
                                    ${o.sourceIcon} ${o.client.substring(0, 12)}...
                                </div>
                            `).join('')}
                            ${dayOrders.length > 3 ? `<div style="font-size:10px; color:var(--text-muted); text-align:center;">+${dayOrders.length - 3} autres</div>` : ''}
                            ${dayOrders.length === 0 ? `<div style="font-size:10px; color:var(--text-muted); text-align:center;">-</div>` : ''}
                        </div>
                    </div>
                `;
            }

            calendar.innerHTML = html;
        }

        function changeTrackingWeek(delta) {
            trackingWeekOffset += delta;
            updateTrackingCalendar(allTrackingOrders);
        }

        function updateTrackingTimeline(orders) {
            const timeline = document.getElementById('tracking-timeline');
            if (!timeline) return;

            // Générer des événements basés sur les commandes
            const events = [];
            const now = new Date();

            orders.forEach(o => {
                // Événement de création
                if (o.createdAt) {
                    events.push({
                        date: o.createdAt,
                        type: 'created',
                        icon: '📥',
                        text: `Nouvelle commande ${o.orderNumber} (${o.client})`,
                        source: o.source,
                        color: o.sourceColor
                    });
                }

                // Événement de livraison prévue aujourd'hui
                if (o.deliveryDate && isDateToday(o.deliveryDate) && o.status !== 'delivered') {
                    events.push({
                        date: o.deliveryDate,
                        type: 'delivery_today',
                        icon: '📦',
                        text: `Livraison prévue: ${o.orderNumber} (${o.client})`,
                        source: o.source,
                        color: '#ff6b6b',
                        highlight: true
                    });
                }

                // Événement livré
                if (o.status === 'delivered' && o.deliveryDate) {
                    events.push({
                        date: o.deliveryDate,
                        type: 'delivered',
                        icon: '✅',
                        text: `Livré: ${o.orderNumber} (${o.client})`,
                        source: o.source,
                        color: '#06d6a0'
                    });
                }
            });

            // Trier par date décroissante et limiter
            events.sort((a, b) => b.date - a.date);
            const recentEvents = events.slice(0, 15);

            if (recentEvents.length === 0) {
                timeline.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">Aucun événement récent</div>';
                return;
            }

            timeline.innerHTML = recentEvents.map(e => {
                const timeAgo = getTimeAgo(e.date);
                return `
                    <div class="timeline-item ${e.highlight ? 'warning' : ''}">
                        <div class="timeline-time">${timeAgo}</div>
                        <div class="timeline-content">
                            <span style="margin-right:6px;">${e.icon}</span>
                            ${e.text}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'À l\'instant';
            if (minutes < 60) return `Il y a ${minutes} min`;
            if (hours < 24) return `Il y a ${hours}h`;
            if (days < 7) return `Il y a ${days} jour${days > 1 ? 's' : ''}`;
            return date.toLocaleDateString('fr-CH');
        }

        function updateTrackingTable(orders) {
            const tbody = document.getElementById('tracking-table-body');
            if (!tbody) return;

            const activeOrders = orders.filter(o => o.status !== 'cancelled');

            if (activeOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:var(--text-muted); padding:30px;">Aucune commande en cours</td></tr>';
                return;
            }

            tbody.innerHTML = activeOrders.map(o => {
                const dateStr = o.deliveryDate
                    ? o.deliveryDate.toLocaleDateString('fr-CH')
                    : '-';

                const statusColors = {
                    pending: { bg: '#ffd16620', color: '#ffd166', text: 'En attente' },
                    preparing: { bg: '#118ab220', color: '#118ab2', text: 'En préparation' },
                    ready: { bg: '#9c88ff20', color: '#9c88ff', text: 'Prêt' },
                    delivered: { bg: '#06d6a020', color: '#06d6a0', text: 'Livré' }
                };
                const st = statusColors[o.status] || statusColors.pending;

                return `
                    <tr>
                        <td><span style="padding:3px 8px; background:${o.sourceColor}20; color:${o.sourceColor}; border-radius:4px; font-size:11px;">${o.sourceIcon}</span></td>
                        <td style="font-weight:600;">${o.orderNumber}</td>
                        <td>${o.client}</td>
                        <td>${dateStr}</td>
                        <td style="font-size:12px; color:var(--text-muted);">${(o.location || '-').substring(0, 25)}</td>
                        <td style="font-family:'Space Mono',monospace; font-weight:600;">${o.amount.toFixed(2)} CHF</td>
                        <td><span style="padding:4px 10px; background:${st.bg}; color:${st.color}; border-radius:6px; font-size:11px; font-weight:600;">${st.text}</span></td>
                        <td>
                            <div style="display:flex; gap:4px;">
                                ${o.status !== 'delivered' ? `
                                    <button onclick="updateOrderStatus('${o.id}', '${o.source}', 'next')" style="padding:4px 8px; background:var(--accent-primary); color:#000; border:none; border-radius:4px; cursor:pointer; font-size:11px;" title="Étape suivante">▶</button>
                                    <button onclick="updateOrderStatus('${o.id}', '${o.source}', 'delivered')" style="padding:4px 8px; background:var(--accent-secondary); color:#000; border:none; border-radius:4px; cursor:pointer; font-size:11px;" title="Marquer livré">✓</button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterTrackingTable() {
            const search = document.getElementById('tracking-search')?.value.toLowerCase() || '';
            const filtered = allTrackingOrders.filter(o =>
                o.orderNumber.toLowerCase().includes(search) ||
                o.client.toLowerCase().includes(search) ||
                o.location.toLowerCase().includes(search)
            );
            updateTrackingTable(filtered);
        }

        function updateOrderStatus(orderId, source, action) {
            const statusFlow = ['pending', 'preparing', 'ready', 'delivered'];

            if (source === 'quickorder') {
                const order = QOData.orders.find(o => o.id === orderId);
                if (order) {
                    if (action === 'delivered') {
                        order.status = 'delivered';
                    } else if (action === 'next') {
                        const currentIdx = statusFlow.indexOf(mapQOStatus(order.status));
                        if (currentIdx < statusFlow.length - 1) {
                            const qoStatusMap = { pending: 'pending', preparing: 'preparing', ready: 'ready', delivered: 'delivered' };
                            order.status = Object.keys(qoStatusMap).find(k => qoStatusMap[k] === statusFlow[currentIdx + 1]) || 'delivered';
                        }
                    }
                    saveQOData('orders');
                }
            } else if (source === 'shopify') {
                const shopifyOrders = JSON.parse(localStorage.getItem('shopify_orders') || '[]');
                const order = shopifyOrders.find(o => o.name === orderId);
                if (order) {
                    if (action === 'delivered' || action === 'next') {
                        order.processed = true;
                        order.fulfillmentStatus = 'fulfilled';
                        localStorage.setItem('shopify_orders', JSON.stringify(shopifyOrders));

                        // Ajouter à la liste des traités
                        const processed = JSON.parse(localStorage.getItem('shopify_processed') || '[]');
                        if (!processed.includes(orderId)) {
                            processed.push(orderId);
                            localStorage.setItem('shopify_processed', JSON.stringify(processed));
                        }
                    }
                }
            } else if (source === 'myfish') {
                const myfishOrders = JSON.parse(localStorage.getItem('myfish_orders') || '[]');
                const order = myfishOrders.find(o => o.id === orderId);
                if (order) {
                    if (action === 'delivered') {
                        order.status = 'delivered';
                    } else if (action === 'next') {
                        const mfStatusMap = { new: 'confirmed', confirmed: 'production', production: 'ready', ready: 'delivered' };
                        order.status = mfStatusMap[order.status] || 'delivered';
                    }
                    localStorage.setItem('myfish_orders', JSON.stringify(myfishOrders));
                }
            }

            showToast('✅ Statut mis à jour', 'success');
            updateTrackingView();
        }

        function showTrackingOrderDetail(orderId, source) {
            // Rediriger vers le module approprié
            if (source === 'quickorder') {
                navigateTo('orders');
            } else if (source === 'shopify') {
                navigateTo('shopify');
                setTimeout(() => showShopifyOrderDetail(orderId), 200);
            } else if (source === 'myfish') {
                navigateTo('myfish');
            }
        }

        // Initialiser le tracking quand on va sur la page
        const originalNavigateToTracking = navigateTo;
        navigateTo = function(pageName) {
            originalNavigateToTracking(pageName);
            if (pageName === 'tracking') {
                setTimeout(initTracking, 100);
            }
        };

        // =====================================================

        // Initialiser les analytics quand on va sur la page
        const originalNavigateToAnalytics = navigateTo;
        navigateTo = function(pageName) {
            originalNavigateToAnalytics(pageName);
            if (pageName === 'analyses') {
                setTimeout(initAnalytics, 100);
            }
        };

        // Init version info au chargement
        document.addEventListener('DOMContentLoaded', initTrakioVersionInfo);
        setTimeout(initTrakioVersionInfo, 1000);

        // =====================================================

        // Init settings quand on va sur la page
        const originalNavigateToSettings = navigateTo;
        navigateTo = function(pageName) {
            originalNavigateToSettings(pageName);
            if (pageName === 'settings') {
                setTimeout(() => {
                    initDropboxSettings();
                    initNumberingSettings();
                    loadCompanySettings();
                }, 100);
            }
        };

        // =====================================================
        // NOTIFICATIONS JOUR J & BADGES DASHBOARD
        // =====================================================

        function toggleNotifications(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('notifications-dropdown');
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                updateDayAlerts();
            }
        }

        // Fermer les notifications en cliquant ailleurs
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('notifications-dropdown');
            const btn = document.getElementById('notificationBtn');
            if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        function updateDayAlerts() {
            const today = new Date();
            const todayStr = today.toLocaleDateString('fr-CH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('notif-date').textContent = todayStr;

            const alerts = [];

            // 1. Commandes Shopify du jour
            const shopifyOrders = JSON.parse(localStorage.getItem('shopify_orders') || '[]');
            const shopifyProcessed = JSON.parse(localStorage.getItem('shopify_processed') || '[]');
            const todayShopify = shopifyOrders.filter(o => {
                if (o.processed || shopifyProcessed.includes(o.name)) return false;
                if (!o.pickupDate) return false;
                const pickupDate = parsePickupDateForSort(o.pickupDate);
                if (!pickupDate) return false;
                return pickupDate.toDateString() === today.toDateString();
            });

            todayShopify.forEach(order => {
                alerts.push({
                    type: 'shopify',
                    icon: '🛍️',
                    color: '#96bf48',
                    title: `Shopify ${order.name}`,
                    subtitle: order.billingName || order.shippingName,
                    time: order.pickupTime || '',
                    location: order.pickupLocation || 'Livraison',
                    action: () => { navigateTo('shopify'); setTimeout(() => showShopifyOrderDetail(order.name), 200); }
                });
            });

            // 2. Commandes QuickOrder du jour (commandes B2B/B2C)
            if (typeof QOData !== 'undefined' && QOData.orders) {
                const todayQO = QOData.orders.filter(o => {
                    if (o.status === 'delivered' || o.status === 'cancelled') return false;
                    if (!o.deliveryDate) return false;
                    const deliveryDate = new Date(o.deliveryDate);
                    return deliveryDate.toDateString() === today.toDateString();
                });

                todayQO.forEach(order => {
                    alerts.push({
                        type: 'quickorder',
                        icon: '⚡',
                        color: 'var(--accent-primary)',
                        title: `Cmd ${order.id}`,
                        subtitle: order.clientName,
                        time: order.deliveryTime || '',
                        location: order.deliveryAddress || '',
                        action: () => { navigateTo('orders'); }
                    });
                });
            }

            // 3. Commandes MyFish du jour
            const myfishOrders = JSON.parse(localStorage.getItem('myfish_orders') || '[]');
            const todayMyfish = myfishOrders.filter(o => {
                if (o.status === 'delivered' || o.status === 'cancelled') return false;
                if (!o.deliveryDate) return false;
                const deliveryDate = new Date(o.deliveryDate);
                return deliveryDate.toDateString() === today.toDateString();
            });

            todayMyfish.forEach(order => {
                alerts.push({
                    type: 'myfish',
                    icon: '🐟',
                    color: 'var(--accent-secondary)',
                    title: `MyFish ${order.id || order.orderNum}`,
                    subtitle: order.clientName,
                    time: '',
                    location: order.store || '',
                    action: () => { navigateTo('myfish'); }
                });
            });

            // Mettre à jour le badge
            const badge = document.getElementById('notif-badge');
            if (alerts.length > 0) {
                badge.style.display = 'flex';
                badge.textContent = alerts.length;
            } else {
                badge.style.display = 'none';
            }

            // Afficher la liste
            const list = document.getElementById('notifications-list');
            if (alerts.length === 0) {
                list.innerHTML = '<div style="padding:30px; text-align:center; color:var(--text-muted);"><div style="font-size:36px; margin-bottom:10px;">✅</div>Aucune livraison/retrait prévu aujourd\'hui</div>';
            } else {
                list.innerHTML = alerts.map((alert, idx) => `
                    <div onclick="notificationAlerts[${idx}].action()" style="display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid var(--border-color); cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                        <div style="width:40px; height:40px; background:${alert.color}20; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px;">
                            ${alert.icon}
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:600; color:var(--text-primary);">${alert.title}</div>
                            <div style="font-size:12px; color:var(--text-muted);">${alert.subtitle}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:12px; font-weight:600; color:${alert.color};">${alert.time}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${alert.location}</div>
                        </div>
                    </div>
                `).join('');
            }

            // Stocker les actions pour les appeler au clic
            window.notificationAlerts = alerts;
        }

        // Mettre à jour le badge Shopify sur le Dashboard
        function updateShopifyDashboardBadge() {
            const orders = JSON.parse(localStorage.getItem('shopify_orders') || '[]');
            const processed = JSON.parse(localStorage.getItem('shopify_processed') || '[]');

            const urgentCount = orders.filter(o =>
                o.financialStatus === 'paid' &&
                o.fulfillmentStatus === 'unfulfilled' &&
                !o.processed &&
                !processed.includes(o.name)
            ).length;

            const badge = document.getElementById('dashboard-shopify-badge');
            const count = document.getElementById('dashboard-shopify-count');

            if (badge && count) {
                if (urgentCount > 0) {
                    badge.style.display = 'block';
                    count.textContent = urgentCount + ' à traiter';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Init au chargement
        setTimeout(() => {
            updateOrderFloatingBar();
            updateOrdersBadge();
            updateShopifyDashboardBadge();
            updateDayAlerts();
            updateDashboardSummary();
        }, 500);

        // =============================================
        // PRIX FOURNISSEURS - Module de gestion
        // =============================================

        const PFData = {
            suppliers: JSON.parse(localStorage.getItem('pf_suppliers') || '[]'),
            products: JSON.parse(localStorage.getItem('pf_products') || '[]'),
            priceHistory: JSON.parse(localStorage.getItem('pf_price_history') || '[]'),
            orders: JSON.parse(localStorage.getItem('pf_orders') || '[]'),
            currentOrder: { supplier: null, items: [], notes: '', deliveryDate: '' }
        };

        // Initialiser avec données Delmeer par défaut
        function initPFData() {
            if (PFData.suppliers.length === 0) {
                PFData.suppliers = [{
                    id: 'delmeer',
                    name: 'DELMEER SISSELN',
                    phone: '062 873 27 27',
                    fax: '062 873 27 29',
                    email: 'delmeer@delmeer.ch',
                    minOrder: 0,
                    deliveryDays: ['mardi', 'jeudi'],
                    active: true
                }];
                savePFData();
            }
            // Initialiser le panier si pas fait
            if (!PFData.currentOrder || !PFData.currentOrder.items) {
                PFData.currentOrder = { supplierId: null, items: [], notes: '', deliveryDate: '' };
            }
            renderPFCatalogue();
            renderPFSuppliers();
            updatePFStats();
            populatePFSupplierSelects();
            updatePFCartBadge();
        }

        function savePFData() {
            localStorage.setItem('pf_suppliers', JSON.stringify(PFData.suppliers));
            localStorage.setItem('pf_products', JSON.stringify(PFData.products));
            localStorage.setItem('pf_price_history', JSON.stringify(PFData.priceHistory));
            localStorage.setItem('pf_orders', JSON.stringify(PFData.orders));
        }

        // Onglets
        function switchPFTab(tab) {
            document.querySelectorAll('.pf-tab').forEach(t => {
                t.style.background = 'var(--bg-card)';
                t.style.color = 'var(--text-primary)';
                t.style.border = '1px solid var(--border-color)';
            });
            document.querySelectorAll('.pf-content').forEach(c => c.style.display = 'none');

            const activeTab = document.getElementById('pf-tab-' + tab);
            if (activeTab) {
                activeTab.style.background = 'var(--accent-primary)';
                activeTab.style.color = '#000';
                activeTab.style.border = 'none';
            }

            const content = document.getElementById('pf-content-' + tab);
            if (content) content.style.display = 'block';

            if (tab === 'fournisseurs') renderPFSuppliers();
            if (tab === 'commandes') renderPFOrders();
            if (tab === 'historique') renderPFHistory();
        }

        // Render catalogue
        function renderPFCatalogue() {
            const tbody = document.getElementById('pf-catalogue-tbody');
            if (!tbody) return;

            let products = [...PFData.products];
            const search = (document.getElementById('pf-search')?.value || '').toLowerCase();
            const supplierFilter = document.getElementById('pf-filter-supplier')?.value || '';

            if (search) {
                products = products.filter(p =>
                    (p.name || '').toLowerCase().includes(search) ||
                    (p.nameShort || '').toLowerCase().includes(search) ||
                    (p.code || '').toLowerCase().includes(search)
                );
            }

            if (supplierFilter) {
                products = products.filter(p => p.supplierId === supplierFilter);
            }

            // Tri alphabétique par nom
            products.sort((a, b) => (a.name || a.nameShort || '').localeCompare(b.name || b.nameShort || '', 'fr'));

            // Grouper par nom pour comparaison multi-fournisseurs
            const grouped = {};
            products.forEach(p => {
                const key = (p.name || p.nameShort || '').toLowerCase().replace(/[^a-z]/g, '');
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(p);
            });

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding:40px; text-align:center; color:var(--text-muted);">Aucun produit. Importez une liste de prix.</td></tr>';
                return;
            }

            tbody.innerHTML = products.slice(0, 100).map(p => {
                const supplier = PFData.suppliers.find(s => s.id === p.supplierId);
                const evolution = getPFPriceEvolution(p.id);
                const evolutionHtml = evolution === 0 ? '<span style="color:var(--text-muted);">—</span>' :
                    evolution > 0 ? `<span style="color:#e74c3c;">↑ +${evolution.toFixed(1)}%</span>` :
                    `<span style="color:#2ecc71;">↓ ${evolution.toFixed(1)}%</span>`;

                return `
                    <tr style="border-bottom:1px solid var(--border-color); cursor:pointer;" onclick="showPFProductDetail('${p.id}')" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                        <td style="padding:12px 10px;">
                            <div style="font-weight:600;">${p.name || p.nameShort}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${p.nameShort || ''}</div>
                        </td>
                        <td style="padding:12px 10px;"><span style="font-size:12px; background:var(--bg-hover); padding:2px 8px; border-radius:4px;">${p.origin || '—'}</span></td>
                        <td style="padding:12px 10px; text-align:right; font-family:'Space Mono',monospace; font-weight:600; color:var(--accent-primary);">${p.price > 0 ? p.price.toFixed(2) : '—'} <span style="font-size:10px; color:var(--text-muted);">/${p.unit || 'kg'}</span></td>
                        <td style="padding:12px 10px; text-align:center;"><span style="font-size:11px; background:var(--accent-secondary)20; color:var(--accent-secondary); padding:3px 8px; border-radius:6px;">${supplier?.name || '—'}</span></td>
                        <td style="padding:12px 10px; text-align:center; font-size:12px;">${evolutionHtml}</td>
                        <td style="padding:12px 10px; text-align:center;">
                            <button onclick="event.stopPropagation(); addToPFOrder('${p.id}')" style="padding:6px 10px; background:var(--accent-primary); color:#000; border:none; border-radius:6px; cursor:pointer; font-size:11px;">+ Cmd</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterPFCatalogue() {
            renderPFCatalogue();
        }

        // Evolution des prix
        function getPFPriceEvolution(productId) {
            const history = PFData.priceHistory.filter(h => h.productId === productId).sort((a, b) => new Date(b.date) - new Date(a.date));
            if (history.length < 2) return 0;
            const current = history[0].price;
            const previous = history[1].price;
            if (previous === 0) return 0;
            return ((current - previous) / previous) * 100;
        }

        // Render fournisseurs
        function renderPFSuppliers() {
            const grid = document.getElementById('pf-suppliers-grid');
            if (!grid) return;

            if (PFData.suppliers.length === 0) {
                grid.innerHTML = '<p style="color:var(--text-muted); text-align:center; padding:40px;">Aucun fournisseur configuré.</p>';
                return;
            }

            grid.innerHTML = PFData.suppliers.map(s => {
                const productCount = PFData.products.filter(p => p.supplierId === s.id).length;
                return `
                    <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; padding:16px; position:relative;">
                        <div style="position:absolute; top:12px; right:12px;">
                            <span style="width:10px; height:10px; background:${s.active ? 'var(--accent-primary)' : 'var(--text-muted)'}; border-radius:50%; display:inline-block;"></span>
                        </div>
                        <div style="font-size:16px; font-weight:700; margin-bottom:4px;">${s.name}</div>
                        <div style="font-size:12px; color:var(--text-muted); margin-bottom:12px;">${s.email || ''}</div>
                        <div style="display:flex; gap:16px; font-size:12px; margin-bottom:12px;">
                            <div><span style="color:var(--text-muted);">📦</span> ${productCount} produits</div>
                            <div><span style="color:var(--text-muted);">📞</span> ${s.phone || '—'}</div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button onclick="editPFSupplier('${s.id}')" style="flex:1; padding:8px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); cursor:pointer; font-size:12px;">✏️ Modifier</button>
                            <button onclick="showPFOrderModal('${s.id}')" style="flex:1; padding:8px; background:var(--accent-secondary); border:none; border-radius:6px; color:#fff; cursor:pointer; font-size:12px;">🛒 Commander</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render commandes
        function renderPFOrders() {
            const container = document.getElementById('pf-orders-list');
            if (!container) return;

            const orders = PFData.orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (orders.length === 0) {
                container.innerHTML = '<p style="color:var(--text-muted); text-align:center; padding:40px;">Aucune commande fournisseur.</p>';
                return;
            }

            const statusColors = { draft: '#95a5a6', sent: '#f39c12', confirmed: '#3498db', received: '#2ecc71' };
            const statusLabels = { draft: 'Brouillon', sent: 'Envoyée', confirmed: 'Confirmée', received: 'Reçue' };

            container.innerHTML = orders.map(o => {
                const supplier = PFData.suppliers.find(s => s.id === o.supplierId);
                return `
                    <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:12px; padding:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                            <div>
                                <div style="font-size:16px; font-weight:700;">Commande #${o.id}</div>
                                <div style="font-size:12px; color:var(--text-muted);">${supplier?.name || 'Fournisseur'} • ${new Date(o.createdAt).toLocaleDateString('fr-CH')}</div>
                            </div>
                            <span style="padding:4px 10px; background:${statusColors[o.status]}20; color:${statusColors[o.status]}; border-radius:6px; font-size:11px; font-weight:600;">${statusLabels[o.status] || o.status}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="font-size:13px; color:var(--text-muted);">${o.items?.length || 0} articles</div>
                            <div style="font-size:18px; font-weight:700; color:var(--accent-primary); font-family:'Space Mono',monospace;">${(o.total || 0).toFixed(2)} CHF</div>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:12px;">
                            <button onclick="printPFOrder('${o.id}')" style="flex:1; padding:8px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); cursor:pointer; font-size:12px;">🖨️ Imprimer</button>
                            <button onclick="updatePFOrderStatus('${o.id}')" style="flex:1; padding:8px; background:var(--accent-secondary); border:none; border-radius:6px; color:#fff; cursor:pointer; font-size:12px;">📋 Statut</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Stats
        function updatePFStats() {
            const el1 = document.getElementById('pf-stat-products');
            const el2 = document.getElementById('pf-stat-suppliers');
            const el3 = document.getElementById('pf-stat-updates');
            const el4 = document.getElementById('pf-stat-pending');

            if (el1) el1.textContent = PFData.products.length;
            if (el2) el2.textContent = PFData.suppliers.length;

            // Updates cette semaine
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const updates = PFData.priceHistory.filter(h => new Date(h.date) > weekAgo).length;
            if (el3) el3.textContent = updates;

            // Commandes en cours
            const pending = PFData.orders.filter(o => o.status === 'draft' || o.status === 'sent').length;
            if (el4) el4.textContent = pending;
        }

        // Populate selects
        function populatePFSupplierSelects() {
            const selects = ['pf-filter-supplier', 'pf-import-supplier', 'pf-order-supplier', 'pf-orders-filter-supplier'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption);
                    PFData.suppliers.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name;
                        select.appendChild(opt);
                    });
                }
            });
        }

        // Modals
        function showPFImportModal() { document.getElementById('pf-import-modal').style.display = 'flex'; }
        function closePFImportModal() { document.getElementById('pf-import-modal').style.display = 'none'; }
        function showPFOrderModal(supplierId) {
            document.getElementById('pf-order-modal').style.display = 'flex';

            // Utiliser le fournisseur du panier existant ou celui passé en paramètre
            const currentSupplierId = PFData.currentOrder.supplierId || supplierId;
            if (currentSupplierId) {
                document.getElementById('pf-order-supplier').value = currentSupplierId;
            }

            // Ne PAS vider le panier s'il y a des articles
            if (PFData.currentOrder.items.length === 0 && supplierId) {
                PFData.currentOrder.supplierId = supplierId;
            }

            renderPFOrderCart();
            updatePFCartBadge();
        }
        function closePFOrderModal() { document.getElementById('pf-order-modal').style.display = 'none'; }
        function closePFProductModal() { document.getElementById('pf-product-modal').style.display = 'none'; }

        // Import process
        function processPFImport() {
            const supplierId = document.getElementById('pf-import-supplier').value;
            const date = document.getElementById('pf-import-date').value;

            if (!supplierId) { alert('Sélectionnez un fournisseur'); return; }
            if (!date) { alert('Sélectionnez une date'); return; }

            // Pour l'instant, on utilise les données Delmeer pré-chargées
            // En production, on parserait le fichier uploadé

            alert('✅ Import simulé avec succès!\n\nEn production, le fichier serait parsé automatiquement.');
            closePFImportModal();

            // Charger les données Delmeer de démo
            loadDelmeerData();
        }

        // Charger données Delmeer
        function loadDelmeerData() {
            const delmeerProducts = [
                // POISSONS FRAIS - Filets et dos
                {id: 'DM001', name: 'Filet de Black Cod IQF MSC', nameShort: 'Black Cod IQF MSC', price: 31.80, unit: 'kg', origin: 'MSC', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM002', name: 'Dos de loup du nord', nameShort: 'Loup du nord dos', price: 27.20, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM003', name: 'Dorade Royale élevage 4/600 GR', nameShort: 'Dorade Royale 4/600', price: 10.20, unit: 'kg', origin: 'GR', supplierId: 'delmeer', boxSize: 10},
                {id: 'DM004', name: 'Filet de dorades Royales a/p s/ar', nameShort: 'Dorades Royales fil', price: 23.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM005', name: 'Dos de cabillaud a/p 4/600', nameShort: 'Cabillaud dos a/p', price: 27.70, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM006', name: 'Dos de cabillaud s/p 2/400 IS', nameShort: 'Cabillaud dos s/p IS', price: 26.00, unit: 'kg', origin: 'IS', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM007', name: 'Filet de cabillaud Tails s/p', nameShort: 'Cabillaud Tails', price: 19.30, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM008', name: 'Filet de flétan frais FR', nameShort: 'Flétan frais FR', price: 25.90, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM009', name: 'Joues de cabillaud Isl.', nameShort: 'Joues cabillaud IS', price: 25.70, unit: 'kg', origin: 'IS', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM010', name: 'Dos de julienne s/p', nameShort: 'Julienne dos', price: 18.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM011', name: 'Filet de merlans a/p FR', nameShort: 'Merlans fil FR', price: 16.90, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM012', name: 'Filet de pangasius 1/400 ASC', nameShort: 'Pangasius ASC', price: 9.90, unit: 'kg', origin: 'ASC', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM013', name: 'Filet de lieu jaune', nameShort: 'Lieu jaune fil', price: 24.80, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM014', name: 'Filet de sébastes ISL s/p', nameShort: 'Sébastes IS', price: 14.90, unit: 'kg', origin: 'IS', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM015', name: 'Filet de limande-sole 40/60 DK', nameShort: 'Limande-sole DK', price: 25.60, unit: 'kg', origin: 'DK', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM016', name: 'Dos d\'eglefin', nameShort: 'Eglefin dos', price: 22.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM017', name: 'Filet de carrelets gris 12/16 NL', nameShort: 'Carrelets NL', price: 18.40, unit: 'kg', origin: 'NL', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM018', name: 'Filet d\'espadon Sashimi SL', nameShort: 'Espadon Sashimi', price: 24.90, unit: 'kg', origin: 'SL', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM019', name: 'Dos de lieu noir 150+', nameShort: 'Lieu noir dos', price: 16.60, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM020', name: 'Filet de baudroie 0,8-1,2', nameShort: 'Baudroie 0,8-1,2', price: 42.00, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM021', name: 'Filet de baudroie 3/500 GB', nameShort: 'Baudroie GB', price: 40.60, unit: 'kg', origin: 'GB', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM022', name: 'Filet de St. Pierre a/p', nameShort: 'St. Pierre fil', price: 41.00, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM023', name: 'Filet de turbots', nameShort: 'Turbots fil', price: 52.90, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM024', name: 'Filet de thon Sashimi', nameShort: 'Thon Sashimi', price: 27.80, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM025', name: 'Filet de bars a/p s/ar. 100/140', nameShort: 'Bars 100/140', price: 24.60, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM026', name: 'Filet de bars a/p s/ar. 140/180', nameShort: 'Bars 140/180', price: 25.60, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM027', name: 'Filet de perches a/p 10/20 ES', nameShort: 'Perches ES', price: 26.00, unit: 'kg', origin: 'ES', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM028', name: 'Filet de perches p-à-bière IQF', nameShort: 'Perches p-à-bière', price: 23.60, unit: 'kg', origin: 'IQF', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM029', name: 'Filet de féras petits CH', nameShort: 'Féras CH', price: 24.00, unit: 'kg', origin: 'CH', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM030', name: 'Filet de sandres a/p 1/300 Est', nameShort: 'Sandres 1/300', price: 18.90, unit: 'kg', origin: 'Est', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM031', name: 'Filet de sandres s/p 3/500', nameShort: 'Sandres 3/500', price: 22.90, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM032', name: 'Joues de sandre', nameShort: 'Sandre joues', price: 22.00, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM033', name: 'Bar élevage 4/600 GR', nameShort: 'Bar 4/600 GR', price: 11.70, unit: 'kg', origin: 'GR', supplierId: 'delmeer', boxSize: 10},
                {id: 'DM034', name: 'Bar élevage 6/800 GR', nameShort: 'Bar 6/800 GR', price: 12.70, unit: 'kg', origin: 'GR', supplierId: 'delmeer', boxSize: 10},
                {id: 'DM035', name: 'Soles 4/500 NL', nameShort: 'Soles 4/500', price: 32.20, unit: 'kg', origin: 'NL', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM036', name: 'Soles 5/600 NL', nameShort: 'Soles 5/600', price: 33.80, unit: 'kg', origin: 'NL', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM037', name: 'Filet de soles s/fr. 80/120 NL', nameShort: 'Soles fil 80/120', price: 65.20, unit: 'kg', origin: 'NL', supplierId: 'delmeer', boxSize: 3},
                {id: 'DM038', name: 'Turbots 1-1,5 NL', nameShort: 'Turbots entiers', price: 29.60, unit: 'kg', origin: 'NL', supplierId: 'delmeer', boxSize: 10},
                {id: 'DM039', name: 'Filet de saumon a/p Premium 1,5-2', nameShort: 'Saumon Premium', price: 17.10, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM040', name: 'Filet de saumon Scot. a/p s/ar', nameShort: 'Saumon Ecosse', price: 20.20, unit: 'kg', origin: 'Scot', supplierId: 'delmeer', boxSize: 5},
                // FRUITS DE MER
                {id: 'DM041', name: 'Noix de St. Jacques GB Dry', nameShort: 'St. Jacques GB', price: 35.20, unit: 'kg', origin: 'GB', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM042', name: 'Noix de St. Jacques avec corail', nameShort: 'St. Jacques corail', price: 42.00, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM043', name: 'Moules IT', nameShort: 'Moules Italie', price: 5.20, unit: 'kg', origin: 'IT', supplierId: 'delmeer', boxSize: 10},
                {id: 'DM044', name: 'Crevettes Chile 150', nameShort: 'Crevettes 150', price: 27.90, unit: 'kg', origin: 'Chile', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM045', name: 'Crevettes Chile 900', nameShort: 'Crevettes 900', price: 24.90, unit: 'kg', origin: 'Chile', supplierId: 'delmeer', boxSize: 5},
                // FUMES
                {id: 'DM046', name: 'Filet de haddock fumé', nameShort: 'Haddock fumé', price: 24.80, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM047', name: 'Saumon fumé prétr. 500g Sup', nameShort: 'Saumon fumé 500g', price: 22.00, unit: 'pce', origin: '', supplierId: 'delmeer', boxSize: 1},
                {id: 'DM048', name: 'Joues de lotte GB', nameShort: 'Lotte joues GB', price: 25.20, unit: 'kg', origin: 'GB', supplierId: 'delmeer', boxSize: 5},
                // PRODUITS ADDITIONNELS DU PDF
                {id: 'DM049', name: 'Filet de cabillaud a/p 1,2+', nameShort: 'Cabillaud fil 1,2+', price: 22.80, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM050', name: 'Filet de cabillaud s/p 1,2+ IS', nameShort: 'Cabillaud s/p IS', price: 24.20, unit: 'kg', origin: 'IS', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM051', name: 'Queue de lotte 0,5-1 GB', nameShort: 'Lotte queue GB', price: 26.80, unit: 'kg', origin: 'GB', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM052', name: 'Queue de lotte 1-2 GB', nameShort: 'Lotte queue 1-2', price: 27.90, unit: 'kg', origin: 'GB', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM053', name: 'Queue de lotte 2+ GB', nameShort: 'Lotte queue 2+', price: 29.50, unit: 'kg', origin: 'GB', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM054', name: 'Filet de truite saumonée CH', nameShort: 'Truite saumonée CH', price: 18.90, unit: 'kg', origin: 'CH', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM055', name: 'Filet de truite saumonée FR', nameShort: 'Truite saumonée FR', price: 16.50, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM056', name: 'Omble chevalier CH', nameShort: 'Omble CH', price: 32.00, unit: 'kg', origin: 'CH', supplierId: 'delmeer', boxSize: 3},
                {id: 'DM057', name: 'Filet d\'omble chevalier CH', nameShort: 'Omble fil CH', price: 42.50, unit: 'kg', origin: 'CH', supplierId: 'delmeer', boxSize: 3},
                {id: 'DM058', name: 'Filet de rouget barbet', nameShort: 'Rouget barbet', price: 28.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 3},
                {id: 'DM059', name: 'Sardines fraîches PT', nameShort: 'Sardines PT', price: 8.90, unit: 'kg', origin: 'PT', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM060', name: 'Anchois frais ES', nameShort: 'Anchois ES', price: 12.50, unit: 'kg', origin: 'ES', supplierId: 'delmeer', boxSize: 3},
                {id: 'DM061', name: 'Maquereau FR', nameShort: 'Maquereau FR', price: 7.80, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM062', name: 'Filet de maquereau FR', nameShort: 'Maquereau fil', price: 14.20, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM063', name: 'Hareng frais NL', nameShort: 'Hareng NL', price: 6.50, unit: 'kg', origin: 'NL', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM064', name: 'Filet de hareng fumé', nameShort: 'Hareng fumé', price: 12.80, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM065', name: 'Anguille fumée', nameShort: 'Anguille fumée', price: 38.00, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 2},
                {id: 'DM066', name: 'Truite fumée entière', nameShort: 'Truite fumée', price: 24.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 3},
                {id: 'DM067', name: 'Filet de truite fumée', nameShort: 'Truite fumée fil', price: 32.00, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 3},
                {id: 'DM068', name: 'Saumon fumé côté 1,2+ NO', nameShort: 'Saumon fumé côté', price: 28.50, unit: 'kg', origin: 'NO', supplierId: 'delmeer', boxSize: 3},
                {id: 'DM069', name: 'Saumon fumé sauvage Alaska', nameShort: 'Saumon fumé Alaska', price: 45.00, unit: 'kg', origin: 'Alaska', supplierId: 'delmeer', boxSize: 2},
                {id: 'DM070', name: 'Esturgeon fumé', nameShort: 'Esturgeon fumé', price: 65.00, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 1},
                {id: 'DM071', name: 'Flétan fumé', nameShort: 'Flétan fumé', price: 42.00, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 2},
                // CRUSTACES
                {id: 'DM072', name: 'Homard canadien 400/500', nameShort: 'Homard 400/500', price: 32.00, unit: 'kg', origin: 'CA', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM073', name: 'Homard canadien 500/600', nameShort: 'Homard 500/600', price: 34.50, unit: 'kg', origin: 'CA', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM074', name: 'Homard breton 500/600', nameShort: 'Homard breton', price: 52.00, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 3},
                {id: 'DM075', name: 'Langoustines 10/15 GB', nameShort: 'Langoustines 10/15', price: 28.00, unit: 'kg', origin: 'GB', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM076', name: 'Langoustines 16/20 GB', nameShort: 'Langoustines 16/20', price: 24.50, unit: 'kg', origin: 'GB', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM077', name: 'Queues de langoustines', nameShort: 'Langoustines queues', price: 48.00, unit: 'kg', origin: 'GB', supplierId: 'delmeer', boxSize: 3},
                {id: 'DM078', name: 'Crevettes roses cuites 40/60', nameShort: 'Crevettes cuites 40/60', price: 18.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM079', name: 'Crevettes roses cuites 60/80', nameShort: 'Crevettes cuites 60/80', price: 15.90, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM080', name: 'Crevettes tigrées 16/20', nameShort: 'Tigrées 16/20', price: 22.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM081', name: 'Crevettes tigrées 21/25', nameShort: 'Tigrées 21/25', price: 19.80, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM082', name: 'Gambas 6/8', nameShort: 'Gambas 6/8', price: 28.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM083', name: 'Gambas 8/12', nameShort: 'Gambas 8/12', price: 24.00, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM084', name: 'Ecrevisses cuites', nameShort: 'Ecrevisses', price: 16.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM085', name: 'Crabe tourteau cuit', nameShort: 'Tourteau cuit', price: 14.80, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM086', name: 'Chair de crabe', nameShort: 'Crabe chair', price: 42.00, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 2},
                {id: 'DM087', name: 'Araignée de mer', nameShort: 'Araignée', price: 12.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                // COQUILLAGES
                {id: 'DM088', name: 'Huîtres fines de claire n°3', nameShort: 'Huîtres n°3', price: 1.20, unit: 'pce', origin: 'FR', supplierId: 'delmeer', boxSize: 1},
                {id: 'DM089', name: 'Huîtres fines de claire n°2', nameShort: 'Huîtres n°2', price: 1.50, unit: 'pce', origin: 'FR', supplierId: 'delmeer', boxSize: 1},
                {id: 'DM090', name: 'Huîtres spéciales n°3', nameShort: 'Huîtres spé n°3', price: 1.80, unit: 'pce', origin: 'FR', supplierId: 'delmeer', boxSize: 1},
                {id: 'DM091', name: 'Palourdes IT', nameShort: 'Palourdes IT', price: 14.50, unit: 'kg', origin: 'IT', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM092', name: 'Coques FR', nameShort: 'Coques FR', price: 9.80, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM093', name: 'Praires FR', nameShort: 'Praires FR', price: 12.50, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM094', name: 'Couteaux ES', nameShort: 'Couteaux ES', price: 15.80, unit: 'kg', origin: 'ES', supplierId: 'delmeer', boxSize: 3},
                {id: 'DM095', name: 'Bulots cuits', nameShort: 'Bulots cuits', price: 11.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM096', name: 'Bigorneaux cuits', nameShort: 'Bigorneaux', price: 9.80, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM097', name: 'Moules de bouchot FR', nameShort: 'Moules bouchot', price: 6.80, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 10},
                {id: 'DM098', name: 'Encornets entiers', nameShort: 'Encornets', price: 11.20, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM099', name: 'Encornets tubes', nameShort: 'Encornets tubes', price: 14.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM100', name: 'Poulpe cuit', nameShort: 'Poulpe cuit', price: 18.50, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM101', name: 'Seiche nettoyée', nameShort: 'Seiche', price: 16.80, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                // POISSONS ENTIERS
                {id: 'DM102', name: 'St. Pierre entier 1-2', nameShort: 'St. Pierre 1-2', price: 26.00, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM103', name: 'Rascasse FR', nameShort: 'Rascasse FR', price: 18.50, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM104', name: 'Grondin FR', nameShort: 'Grondin FR', price: 12.80, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM105', name: 'Merlan entier FR', nameShort: 'Merlan entier', price: 9.50, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM106', name: 'Raie FR', nameShort: 'Raie FR', price: 14.50, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM107', name: 'Congre FR', nameShort: 'Congre FR', price: 11.20, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM108', name: 'Lotte entière 1-2', nameShort: 'Lotte entière', price: 22.00, unit: 'kg', origin: '', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM109', name: 'Petit navire FR', nameShort: 'Petit navire', price: 16.80, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                {id: 'DM110', name: 'Lieu jaune entier FR', nameShort: 'Lieu jaune entier', price: 14.50, unit: 'kg', origin: 'FR', supplierId: 'delmeer', boxSize: 5},
                // AUTRES
                {id: 'DM111', name: 'Caviar Baeri 30g', nameShort: 'Caviar 30g', price: 65.00, unit: 'pce', origin: '', supplierId: 'delmeer', boxSize: 1},
                {id: 'DM112', name: 'Caviar Baeri 50g', nameShort: 'Caviar 50g', price: 95.00, unit: 'pce', origin: '', supplierId: 'delmeer', boxSize: 1},
                {id: 'DM113', name: 'Oeufs de saumon 500g', nameShort: 'Oeufs saumon', price: 45.00, unit: 'pce', origin: '', supplierId: 'delmeer', boxSize: 1},
                {id: 'DM114', name: 'Oeufs de truite 500g', nameShort: 'Oeufs truite', price: 38.00, unit: 'pce', origin: '', supplierId: 'delmeer', boxSize: 1},
                {id: 'DM115', name: 'Tartare de saumon 150g', nameShort: 'Tartare saumon', price: 8.50, unit: 'pce', origin: '', supplierId: 'delmeer', boxSize: 1},
                {id: 'DM116', name: 'Tartare de thon 150g', nameShort: 'Tartare thon', price: 12.00, unit: 'pce', origin: '', supplierId: 'delmeer', boxSize: 1},
                {id: 'DM117', name: 'Rillettes de saumon 150g', nameShort: 'Rillettes saumon', price: 6.80, unit: 'pce', origin: '', supplierId: 'delmeer', boxSize: 1}
            ];

            // Ajouter les produits
            let added = 0;
            delmeerProducts.forEach(p => {
                const existing = PFData.products.find(ep => ep.id === p.id);
                if (!existing) {
                    PFData.products.push(p);
                    // Ajouter à l'historique
                    PFData.priceHistory.push({
                        productId: p.id,
                        price: p.price,
                        date: new Date().toISOString().split('T')[0],
                        supplierId: p.supplierId
                    });
                    added++;
                }
            });

            savePFData();
            renderPFCatalogue();
            updatePFStats();

            showToast('✅ ' + added + ' nouveaux produits Delmeer ajoutés! (Total: ' + PFData.products.length + ')');
        }

        // Ajouter au panier commande
        function addToPFOrder(productId) {
            const product = PFData.products.find(p => p.id === productId);
            if (!product) return;

            // Récupérer la dernière commande pour pré-remplir
            const lastOrder = getProductOrderHistory(productId)[0];
            const defaultBoxes = lastOrder?.boxes || 1;
            const defaultBoxSize = product.boxSize || lastOrder?.boxSize || 5;

            // Ajouter au panier sans ouvrir le modal
            addToPFCartDirect(productId, defaultBoxes, defaultBoxSize);

            // Toast + badge
            showToast(`✅ ${product.name} ajouté au panier`);
            updatePFCartBadge();
        }

        function addToPFOrderWithBoxes(productId, boxes, boxSize) {
            const product = PFData.products.find(p => p.id === productId);
            if (!product) return;

            // Ajouter au panier directement
            addToPFCartDirect(productId, boxes, boxSize);
            updatePFCartBadge();
        }

        function renderPFOrderCart() {
            const container = document.getElementById('pf-order-cart');
            const totalEl = document.getElementById('pf-order-total');
            if (!container) return;

            if (PFData.currentOrder.items.length === 0) {
                container.innerHTML = '<p style="color:var(--text-muted); font-size:13px; text-align:center; padding:20px;">Aucun article ajouté</p>';
                if (totalEl) totalEl.textContent = '0.00 CHF';
                return;
            }

            // Options pour caisses de X kg
            const boxSizeOptionsHtml = (selectedSize) => {
                let html = '';
                for (let i = 1; i <= 20; i++) {
                    html += `<option value="${i}" ${selectedSize === i ? 'selected' : ''}>${i} kg</option>`;
                }
                return html;
            };

            // Options pour nombre de caisses
            const boxCountOptionsHtml = (selectedCount) => {
                let html = '';
                for (let i = 1; i <= 50; i++) {
                    html += `<option value="${i}" ${selectedCount === i ? 'selected' : ''}>${i}</option>`;
                }
                return html;
            };

            let total = 0;
            container.innerHTML = PFData.currentOrder.items.map((item, idx) => {
                const totalQty = item.boxes * item.boxSize;
                const subtotal = item.price * totalQty;
                total += subtotal;

                return `
                    <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; padding:12px; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                            <div>
                                <div style="font-weight:600; font-size:14px;">${item.name}</div>
                                <div style="font-size:12px; color:var(--text-muted);">${item.price.toFixed(2)} CHF/${item.unit}</div>
                            </div>
                            <button onclick="removePFCartItem(${idx})" style="background:none; border:none; color:#e74c3c; cursor:pointer; font-size:18px; padding:0;">×</button>
                        </div>

                        <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:center;">
                            <!-- Nombre de caisses -->
                            <div>
                                <label style="font-size:10px; color:var(--text-muted); display:block; margin-bottom:2px;">Nb caisses</label>
                                <select onchange="updatePFCartBoxes(${idx}, this.value)" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:14px; font-weight:600;">
                                    ${boxCountOptionsHtml(item.boxes)}
                                </select>
                            </div>

                            <!-- Poids par caisse -->
                            <div>
                                <label style="font-size:10px; color:var(--text-muted); display:block; margin-bottom:2px;">Caisse de</label>
                                <select onchange="updatePFCartBoxSize(${idx}, this.value)" style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:14px;">
                                    ${boxSizeOptionsHtml(item.boxSize)}
                                </select>
                            </div>

                            <!-- Total -->
                            <div style="text-align:right; min-width:90px;">
                                <div style="font-size:10px; color:var(--text-muted);">${totalQty} kg</div>
                                <div style="font-size:16px; font-weight:700; color:var(--accent-primary); font-family:'Space Mono',monospace;">${subtotal.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (totalEl) totalEl.textContent = total.toFixed(2) + ' CHF';
        }

        function updatePFCartBoxes(idx, val) {
            PFData.currentOrder.items[idx].boxes = parseInt(val) || 1;
            PFData.currentOrder.items[idx].totalQty = PFData.currentOrder.items[idx].boxes * PFData.currentOrder.items[idx].boxSize;
            renderPFOrderCart();
        }

        function updatePFCartBoxSize(idx, val) {
            PFData.currentOrder.items[idx].boxSize = parseInt(val) || 5;
            PFData.currentOrder.items[idx].totalQty = PFData.currentOrder.items[idx].boxes * PFData.currentOrder.items[idx].boxSize;
            renderPFOrderCart();
        }

        function updatePFCartQty(idx, delta) {
            PFData.currentOrder.items[idx].boxes = Math.max(1, (PFData.currentOrder.items[idx].boxes || 1) + delta);
            PFData.currentOrder.items[idx].totalQty = PFData.currentOrder.items[idx].boxes * PFData.currentOrder.items[idx].boxSize;
            renderPFOrderCart();
        }

        function setPFCartQty(idx, val) {
            PFData.currentOrder.items[idx].boxes = Math.max(1, parseInt(val) || 1);
            PFData.currentOrder.items[idx].totalQty = PFData.currentOrder.items[idx].boxes * PFData.currentOrder.items[idx].boxSize;
            renderPFOrderCart();
        }

        function removePFCartItem(idx) {
            PFData.currentOrder.items.splice(idx, 1);
            renderPFOrderCart();
        }

        // Sauvegarder brouillon
        function savePFOrderDraft() {
            if (PFData.currentOrder.items.length === 0) { alert('Ajoutez des articles'); return; }

            const supplierId = document.getElementById('pf-order-supplier').value;
            const deliveryDate = document.getElementById('pf-order-delivery-date').value;
            const notes = document.getElementById('pf-order-notes').value;

            const order = {
                id: 'PF' + Date.now(),
                supplierId: supplierId,
                items: [...PFData.currentOrder.items],
                deliveryDate: deliveryDate,
                notes: notes,
                total: PFData.currentOrder.items.reduce((sum, i) => sum + i.price * (i.boxes * i.boxSize), 0),
                status: 'draft',
                createdAt: new Date().toISOString()
            };

            PFData.orders.push(order);
            savePFData();
            closePFOrderModal();
            updatePFStats();
            showToast('✅ Brouillon sauvegardé!');
        }

        // Confirmer commande (sans impression automatique)
        function confirmPFOrder() {
            if (PFData.currentOrder.items.length === 0) { alert('Ajoutez des articles'); return; }

            const supplierId = document.getElementById('pf-order-supplier').value || PFData.currentOrder.supplierId;
            if (!supplierId) { alert('Sélectionnez un fournisseur'); return; }

            const deliveryDate = document.getElementById('pf-order-delivery-date').value;
            const notes = document.getElementById('pf-order-notes').value;

            const order = {
                id: 'PF' + Date.now(),
                supplierId: supplierId,
                items: [...PFData.currentOrder.items],
                deliveryDate: deliveryDate,
                notes: notes,
                total: PFData.currentOrder.items.reduce((sum, i) => sum + i.price * (i.boxes * i.boxSize), 0),
                status: 'confirmed',
                createdAt: new Date().toISOString()
            };

            PFData.orders.push(order);

            // Vider le panier
            PFData.currentOrder = { supplierId: null, items: [], notes: '', deliveryDate: '' };

            savePFData();
            closePFOrderModal();
            updatePFStats();
            updatePFCartBadge();

            // Proposer d'imprimer
            showPFOrderConfirmation(order.id);
        }

        // Modal de confirmation après commande
        function showPFOrderConfirmation(orderId) {
            const order = PFData.orders.find(o => o.id === orderId);
            if (!order) return;

            const supplier = PFData.suppliers.find(s => s.id === order.supplierId);

            const modal = document.createElement('div');
            modal.id = 'pf-confirm-modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:10000; display:flex; justify-content:center; align-items:center; padding:20px;';
            modal.innerHTML = `
                <div style="background:var(--bg-card); border-radius:16px; max-width:400px; width:100%; padding:24px; text-align:center;">
                    <div style="width:64px; height:64px; background:linear-gradient(135deg, #2ecc71, #27ae60); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px;">
                        <span style="font-size:32px;">✅</span>
                    </div>
                    <h2 style="font-size:20px; font-weight:700; margin-bottom:8px;">Commande enregistrée !</h2>
                    <p style="color:var(--text-muted); font-size:14px; margin-bottom:8px;">N° ${order.id}</p>
                    <p style="color:var(--text-muted); font-size:13px; margin-bottom:20px;">${supplier?.name || 'Fournisseur'} • ${order.items.length} article(s)</p>
                    <div style="font-size:24px; font-weight:700; color:var(--accent-primary); margin-bottom:20px; font-family:'Space Mono',monospace;">${order.total.toFixed(2)} CHF</div>
                    <div style="display:flex; gap:10px;">
                        <button onclick="document.getElementById('pf-confirm-modal').remove(); switchPFTab('commandes');" style="flex:1; padding:14px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; font-weight:600; cursor:pointer;">📋 Voir commandes</button>
                        <button onclick="printPFOrder('${order.id}'); document.getElementById('pf-confirm-modal').remove();" style="flex:1; padding:14px; background:var(--accent-primary); color:#000; border:none; border-radius:10px; font-weight:700; cursor:pointer;">🖨️ Imprimer</button>
                    </div>
                    <button onclick="document.getElementById('pf-confirm-modal').remove();" style="margin-top:12px; background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:13px;">Fermer</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Vider le panier
        function clearPFCart() {
            if (PFData.currentOrder.items.length === 0) return;
            if (confirm('Vider le panier ?')) {
                PFData.currentOrder = { supplierId: null, items: [], notes: '', deliveryDate: '' };
                renderPFOrderCart();
                updatePFCartBadge();
            }
        }

        // Imprimer commande
        function printPFOrder(orderId) {
            const order = PFData.orders.find(o => o.id === orderId);
            if (!order) return;

            const supplier = PFData.suppliers.find(s => s.id === order.supplierId);

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Commande ${order.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                        h1 { font-size: 24px; margin-bottom: 5px; }
                        .header { border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px; }
                        .info { display: flex; justify-content: space-between; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #f5f5f5; font-weight: bold; }
                        .total { text-align: right; font-size: 20px; font-weight: bold; }
                        .footer { margin-top: 30px; font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>COMMANDE FOURNISSEUR</h1>
                        <p><strong>N° ${order.id}</strong> | ${new Date(order.createdAt).toLocaleDateString('fr-CH')}</p>
                    </div>
                    <div class="info">
                        <div>
                            <strong>BOREX Poissons</strong><br>
                            Votre adresse ici
                        </div>
                        <div style="text-align:right;">
                            <strong>${supplier?.name || 'Fournisseur'}</strong><br>
                            ${supplier?.email || ''}<br>
                            ${supplier?.phone || ''}
                        </div>
                    </div>
                    ${order.deliveryDate ? `<p><strong>Livraison souhaitée:</strong> ${new Date(order.deliveryDate).toLocaleDateString('fr-CH')}</p>` : ''}
                    <table>
                        <thead>
                            <tr>
                                <th>Article</th>
                                <th style="text-align:center;">Caisses</th>
                                <th style="text-align:center;">Poids/caisse</th>
                                <th style="text-align:center;">Total kg</th>
                                <th style="text-align:right;">Prix/kg</th>
                                <th style="text-align:right;">Total CHF</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(i => {
                                const totalKg = (i.boxes || 1) * (i.boxSize || 5);
                                const totalPrice = i.price * totalKg;
                                return `
                                <tr>
                                    <td>${i.name}</td>
                                    <td style="text-align:center;">${i.boxes || 1}</td>
                                    <td style="text-align:center;">${i.boxSize || 5} kg</td>
                                    <td style="text-align:center; font-weight:bold;">${totalKg} kg</td>
                                    <td style="text-align:right;">${i.price.toFixed(2)}</td>
                                    <td style="text-align:right; font-weight:bold;">${totalPrice.toFixed(2)}</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                    <div class="total">TOTAL HT: ${order.total.toFixed(2)} CHF</div>
                    ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                    <div class="footer">
                        <p>Commande générée par TRAKIO - ${new Date().toLocaleString('fr-CH')}</p>
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Détail produit
        function showPFProductDetail(productId) {
            const product = PFData.products.find(p => p.id === productId);
            if (!product) return;

            const supplier = PFData.suppliers.find(s => s.id === product.supplierId);
            const history = PFData.priceHistory.filter(h => h.productId === productId).sort((a, b) => new Date(b.date) - new Date(a.date));

            // Historique des commandes pour ce produit
            const orderHistory = getProductOrderHistory(productId);

            // Options pour caisses de X kg
            let boxSizeOptions = '';
            for (let i = 1; i <= 20; i++) {
                const selected = (product.boxSize || 5) === i ? 'selected' : '';
                boxSizeOptions += `<option value="${i}" ${selected}>${i} kg</option>`;
            }

            const modal = document.getElementById('pf-product-modal');
            const content = document.getElementById('pf-product-modal-content');

            content.innerHTML = `
                <div style="padding:20px; border-bottom:1px solid var(--border-color); background:linear-gradient(135deg, var(--accent-primary)20, var(--accent-secondary)20);">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div style="flex:1;">
                            <input type="text" id="pf-edit-name" value="${product.name || ''}" placeholder="Nom du produit" style="width:100%; font-size:18px; font-weight:700; background:transparent; border:none; border-bottom:2px solid transparent; color:var(--text-primary); padding:4px 0; margin-bottom:4px;" onfocus="this.style.borderBottomColor='var(--accent-primary)'" onblur="this.style.borderBottomColor='transparent'">
                            <input type="text" id="pf-edit-nameShort" value="${product.nameShort || ''}" placeholder="Description courte" style="width:100%; font-size:13px; background:transparent; border:none; border-bottom:1px solid transparent; color:var(--text-muted); padding:2px 0;" onfocus="this.style.borderBottomColor='var(--accent-primary)'" onblur="this.style.borderBottomColor='transparent'">
                        </div>
                        <button onclick="closePFProductModal()" style="background:none; border:none; color:var(--text-muted); font-size:24px; cursor:pointer; margin-left:10px;">×</button>
                    </div>
                </div>
                <div style="padding:20px;">
                    <!-- Prix et infos de base -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                        <div style="background:var(--bg-primary); border-radius:10px; padding:14px;">
                            <label style="font-size:11px; color:var(--text-muted); display:block; margin-bottom:4px;">Prix HT</label>
                            <div style="display:flex; align-items:center; gap:6px;">
                                <input type="number" step="0.01" id="pf-edit-price" value="${product.price || 0}" style="flex:1; font-size:24px; font-weight:700; color:var(--accent-primary); background:transparent; border:none; border-bottom:2px solid var(--border-color); font-family:'Space Mono',monospace; padding:4px 0;" onfocus="this.style.borderBottomColor='var(--accent-primary)'">
                                <span style="color:var(--text-muted);">CHF</span>
                            </div>
                        </div>
                        <div style="background:var(--bg-primary); border-radius:10px; padding:14px;">
                            <label style="font-size:11px; color:var(--text-muted); display:block; margin-bottom:4px;">Unité</label>
                            <select id="pf-edit-unit" style="width:100%; padding:8px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:14px;">
                                <option value="kg" ${product.unit === 'kg' ? 'selected' : ''}>kg</option>
                                <option value="pce" ${product.unit === 'pce' ? 'selected' : ''}>pièce</option>
                                <option value="L" ${product.unit === 'L' ? 'selected' : ''}>litre</option>
                                <option value="bte" ${product.unit === 'bte' ? 'selected' : ''}>boîte</option>
                            </select>
                        </div>
                    </div>

                    <!-- Origine et Fournisseur -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                        <div>
                            <label style="font-size:11px; color:var(--text-muted); display:block; margin-bottom:4px;">Origine</label>
                            <input type="text" id="pf-edit-origin" value="${product.origin || ''}" placeholder="Ex: FR, NL, CH..." style="width:100%; padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                        </div>
                        <div>
                            <label style="font-size:11px; color:var(--text-muted); display:block; margin-bottom:4px;">Fournisseur</label>
                            <div style="padding:10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-muted);">${supplier?.name || '—'}</div>
                        </div>
                    </div>

                    <!-- Configuration Caisses -->
                    <div style="background:linear-gradient(135deg, var(--accent-warning)10, var(--accent-warning)05); border:1px solid var(--accent-warning)40; border-radius:12px; padding:16px; margin-bottom:16px;">
                        <h4 style="font-size:13px; margin-bottom:12px; color:var(--accent-warning);">📦 Configuration des caisses</h4>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            <div>
                                <label style="font-size:11px; color:var(--text-muted); display:block; margin-bottom:4px;">Poids par caisse</label>
                                <select id="pf-edit-boxSize" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                    ${boxSizeOptions}
                                </select>
                            </div>
                            <div>
                                <label style="font-size:11px; color:var(--text-muted); display:block; margin-bottom:4px;">Qté min. commande</label>
                                <input type="number" id="pf-edit-minQty" value="${product.minQty || 1}" min="1" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            </div>
                        </div>
                    </div>

                    <!-- Historique des commandes -->
                    ${orderHistory.length > 0 ? `
                    <div style="background:var(--bg-primary); border-radius:10px; padding:14px; margin-bottom:16px;">
                        <h4 style="font-size:13px; margin-bottom:10px;">📋 Mes dernières commandes</h4>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            ${orderHistory.slice(0, 6).map(oh => `
                                <div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; padding:8px 12px; text-align:center;">
                                    <div style="font-size:11px; color:var(--text-muted);">${new Date(oh.date).toLocaleDateString('fr-CH', {day:'2-digit', month:'short'})}</div>
                                    <div style="font-weight:700; color:var(--accent-primary);">${oh.quantity} ${oh.unit || 'kg'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Historique des prix -->
                    <details style="margin-bottom:16px;">
                        <summary style="cursor:pointer; font-size:13px; font-weight:600; padding:10px; background:var(--bg-primary); border-radius:8px;">📈 Historique des prix (${history.length})</summary>
                        <div style="background:var(--bg-primary); border-radius:0 0 10px 10px; max-height:150px; overflow-y:auto;">
                            ${history.length > 0 ? history.slice(0, 10).map(h => `
                                <div style="display:flex; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border-color);">
                                    <span style="color:var(--text-muted); font-size:12px;">${new Date(h.date).toLocaleDateString('fr-CH')}</span>
                                    <span style="font-family:'Space Mono',monospace; font-weight:600;">${h.price.toFixed(2)} CHF</span>
                                </div>
                            `).join('') : '<p style="padding:15px; text-align:center; color:var(--text-muted);">Pas d\'historique</p>'}
                        </div>
                    </details>

                    <!-- Actions -->
                    <div style="display:flex; gap:10px;">
                        <button onclick="savePFProductEdit('${product.id}')" style="flex:1; padding:12px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; font-weight:600; cursor:pointer;">💾 Sauvegarder</button>
                        <button onclick="openPFQuickOrder('${product.id}')" style="flex:2; padding:12px; background:var(--accent-primary); color:#000; border:none; border-radius:10px; font-weight:700; cursor:pointer;">🛒 Commander</button>
                    </div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        // Sauvegarder les modifications du produit
        function savePFProductEdit(productId) {
            const product = PFData.products.find(p => p.id === productId);
            if (!product) return;

            const oldPrice = product.price;

            product.name = document.getElementById('pf-edit-name').value;
            product.nameShort = document.getElementById('pf-edit-nameShort').value;
            product.price = parseFloat(document.getElementById('pf-edit-price').value) || 0;
            product.unit = document.getElementById('pf-edit-unit').value;
            product.origin = document.getElementById('pf-edit-origin').value;
            product.boxSize = parseInt(document.getElementById('pf-edit-boxSize').value) || 5;
            product.minQty = parseInt(document.getElementById('pf-edit-minQty').value) || 1;

            // Ajouter à l'historique si le prix a changé
            if (oldPrice !== product.price) {
                PFData.priceHistory.push({
                    productId: product.id,
                    price: product.price,
                    date: new Date().toISOString().split('T')[0],
                    supplierId: product.supplierId
                });
            }

            savePFData();
            renderPFCatalogue();
            closePFProductModal();
            showToast('✅ Produit mis à jour !');
        }

        // Historique des commandes pour un produit
        function getProductOrderHistory(productId) {
            const history = [];
            PFData.orders.forEach(order => {
                order.items?.forEach(item => {
                    if (item.productId === productId) {
                        history.push({
                            date: order.createdAt,
                            quantity: item.totalQty || (item.boxes * item.boxSize) || item.quantity,
                            unit: item.unit || 'kg',
                            boxes: item.boxes,
                            boxSize: item.boxSize
                        });
                    }
                });
            });
            return history.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Ajouter au panier depuis modal produit (sans ouvrir modal commande)
        function openPFQuickOrder(productId) {
            const product = PFData.products.find(p => p.id === productId);
            if (!product) return;

            // Pré-remplir avec les dernières valeurs commandées
            const lastOrder = getProductOrderHistory(productId)[0];
            const defaultBoxes = lastOrder?.boxes || 1;
            const defaultBoxSize = product.boxSize || lastOrder?.boxSize || 5;

            // Ajouter au panier sans ouvrir le modal
            addToPFCartDirect(productId, defaultBoxes, defaultBoxSize);

            // Toast de confirmation
            showToast(`✅ ${product.name} ajouté au panier`);

            // Mettre à jour le badge panier
            updatePFCartBadge();

            // Fermer le modal produit
            closePFProductModal();
        }

        // Ajouter directement au panier courant sans ouvrir modal
        function addToPFCartDirect(productId, boxes, boxSize) {
            const product = PFData.products.find(p => p.id === productId);
            if (!product) return;

            // S'assurer que le fournisseur est défini
            if (!PFData.currentOrder.supplierId) {
                PFData.currentOrder.supplierId = product.supplierId;
            }

            // Vérifier si même fournisseur
            if (PFData.currentOrder.supplierId !== product.supplierId && PFData.currentOrder.items.length > 0) {
                if (!confirm('⚠️ Vous avez déjà des articles d\'un autre fournisseur.\nVider le panier et commencer avec ' + (PFData.suppliers.find(s => s.id === product.supplierId)?.name || 'ce fournisseur') + ' ?')) {
                    return;
                }
                PFData.currentOrder.items = [];
                PFData.currentOrder.supplierId = product.supplierId;
            }

            const existing = PFData.currentOrder.items.find(i => i.productId === productId);
            if (existing) {
                existing.boxes = (existing.boxes || 1) + 1;
                existing.totalQty = existing.boxes * existing.boxSize;
            } else {
                PFData.currentOrder.items.push({
                    productId: productId,
                    name: product.name,
                    price: product.price,
                    unit: product.unit || 'kg',
                    boxes: boxes || 1,
                    boxSize: boxSize || product.boxSize || 5,
                    totalQty: (boxes || 1) * (boxSize || product.boxSize || 5)
                });
            }
        }

        // Badge panier
        function updatePFCartBadge() {
            const badge = document.getElementById('pf-cart-badge');
            const count = PFData.currentOrder.items.length;
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'flex' : 'none';
            }
        }

        // Historique
        function renderPFHistory() {
            // À implémenter avec Chart.js
        }

        // Ajouter fournisseur
        function showPFAddSupplierModal() {
            const name = prompt('Nom du fournisseur:');
            if (!name) return;

            const email = prompt('Email:') || '';
            const phone = prompt('Téléphone:') || '';

            PFData.suppliers.push({
                id: 'SUP' + Date.now(),
                name: name,
                email: email,
                phone: phone,
                active: true
            });

            savePFData();
            renderPFSuppliers();
            populatePFSupplierSelects();
            updatePFStats();
        }

        function editPFSupplier(id) {
            const supplier = PFData.suppliers.find(s => s.id === id);
            if (!supplier) return;

            const name = prompt('Nom:', supplier.name);
            if (name) supplier.name = name;

            const email = prompt('Email:', supplier.email);
            if (email !== null) supplier.email = email;

            const phone = prompt('Téléphone:', supplier.phone);
            if (phone !== null) supplier.phone = phone;

            savePFData();
            renderPFSuppliers();
            populatePFSupplierSelects();
        }

        function updatePFOrderStatus(orderId) {
            const order = PFData.orders.find(o => o.id === orderId);
            if (!order) return;

            const statuses = ['draft', 'sent', 'confirmed', 'received'];
            const labels = ['Brouillon', 'Envoyée', 'Confirmée', 'Reçue'];
            const currentIdx = statuses.indexOf(order.status);

            const choice = prompt('Nouveau statut:\n1. Brouillon\n2. Envoyée\n3. Confirmée\n4. Reçue\n\nEntrez 1-4:', currentIdx + 1);
            if (!choice) return;

            const idx = parseInt(choice) - 1;
            if (idx >= 0 && idx < statuses.length) {
                order.status = statuses[idx];
                savePFData();
                renderPFOrders();
                updatePFStats();
            }
        }

        function filterPFOrders() {
            renderPFOrders();
        }

        function searchPFOrderProduct() {
            const search = document.getElementById('pf-order-search').value.toLowerCase();
            const resultsDiv = document.getElementById('pf-order-search-results');
            const supplierId = document.getElementById('pf-order-supplier').value || PFData.currentOrder.supplierId;

            if (search.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            let products = PFData.products.filter(p =>
                ((p.name || '').toLowerCase().includes(search) || (p.nameShort || '').toLowerCase().includes(search))
            );

            if (supplierId) {
                products = products.filter(p => p.supplierId === supplierId);
            }

            if (products.length === 0) {
                resultsDiv.style.display = 'none';
                return;
            }

            resultsDiv.innerHTML = products.slice(0, 10).map(p => `
                <div onclick="addToPFCartFromModal('${p.id}'); document.getElementById('pf-order-search').value=''; document.getElementById('pf-order-search-results').style.display='none';"
                     style="padding:10px 14px; cursor:pointer; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;"
                     onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                    <span>${p.name}</span>
                    <span style="font-family:'Space Mono',monospace; color:var(--accent-primary);">${p.price.toFixed(2)}</span>
                </div>
            `).join('');

            resultsDiv.style.display = 'block';
        }

        // Ajouter au panier depuis la recherche dans le modal (garde le modal ouvert)
        function addToPFCartFromModal(productId) {
            const product = PFData.products.find(p => p.id === productId);
            if (!product) return;

            const lastOrder = getProductOrderHistory(productId)[0];
            const defaultBoxes = lastOrder?.boxes || 1;
            const defaultBoxSize = product.boxSize || lastOrder?.boxSize || 5;

            addToPFCartDirect(productId, defaultBoxes, defaultBoxSize);
            renderPFOrderCart();
            updatePFCartBadge();
        }

        function loadPFSupplierProducts() {
            // Placeholder pour charger les produits d'un fournisseur
        }

        // Init au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initPFData, 600);
        });

        // 📊 Fonction de mise à jour du résumé Dashboard
        function updateDashboardSummary() {
            // 1. Commandes en cours (QuickOrder) avec détail par statut
            const qoOrders = JSON.parse(localStorage.getItem('qo_orders') || '[]');
            
            // Compter par statut
            let countNew = 0;
            let countPreparing = 0;
            let countReady = 0;
            let countTotal = 0;
            
            qoOrders.forEach(o => {
                const status = (o.status || 'new').toLowerCase();
                if (status === 'new' || status === 'nouvelle' || status === 'pending' || !o.status) {
                    countNew++;
                    countTotal++;
                } else if (status === 'preparing' || status === 'en_cours' || status === 'preparation') {
                    countPreparing++;
                    countTotal++;
                } else if (status === 'ready' || status === 'pret' || status === 'prête') {
                    countReady++;
                    countTotal++;
                }
                // Les commandes "completed" ou "done" ne sont pas comptées
            });
            
            // Mettre à jour les compteurs de statuts
            const newEl = document.getElementById('status-new-count');
            if (newEl) newEl.textContent = countNew;
            
            const prepEl = document.getElementById('status-preparing-count');
            if (prepEl) prepEl.textContent = countPreparing;
            
            const readyEl = document.getElementById('status-ready-count');
            if (readyEl) readyEl.textContent = countReady;
            
            // Badge total urgent
            const urgentEl = document.getElementById('urgent-total-badge');
            if (urgentEl) {
                urgentEl.textContent = countTotal;
                // Changer couleur selon urgence
                if (countNew > 0) {
                    urgentEl.style.background = '#ff6b6b';
                } else if (countPreparing > 0) {
                    urgentEl.style.background = '#118ab2';
                } else if (countReady > 0) {
                    urgentEl.style.background = '#06d6a0';
                } else {
                    urgentEl.style.background = '#636e72';
                }
            }

            // 2. MyFish en attente
            const mfOrders = JSON.parse(localStorage.getItem('mf_orders') || '[]');
            const pendingMyfish = mfOrders.filter(o => {
                const s = (o.status || '').toLowerCase();
                return s === 'pending' || s === 'en_attente' || s === 'nouvelle' || s === 'new' || !o.status;
            }).length;
            
            const myfishEl = document.getElementById('status-myfish-count');
            if (myfishEl) myfishEl.textContent = pendingMyfish;

            // 3. CA du jour
            const today = new Date().toISOString().split('T')[0];
            let caToday = 0;

            // Additionner les commandes QuickOrder du jour
            qoOrders.forEach(o => {
                if (o.date && o.date.startsWith(today) && o.total) {
                    caToday += parseFloat(o.total) || 0;
                }
            });

            // Additionner les commandes MyFish du jour
            mfOrders.forEach(o => {
                if (o.createdAt && o.createdAt.startsWith(today) && o.total) {
                    caToday += parseFloat(o.total) || 0;
                }
            });

            const caEl = document.getElementById('summary-ca-today');
            if (caEl) {
                caEl.textContent = caToday.toFixed(0) + ' CHF';
            }
        }
        
        // Toggle pour la section Outils
        function toggleToolsSection() {
            const section = document.getElementById('tools-section');
            const chevron = document.getElementById('tools-chevron');
            if (section && chevron) {
                if (section.style.display === 'none') {
                    section.style.display = 'grid';
                    chevron.style.transform = 'rotate(0deg)';
                } else {
                    section.style.display = 'none';
                    chevron.style.transform = 'rotate(-90deg)';
                }
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════
        // 👥 MODULE RH - GESTION DU PERSONNEL
        // ═══════════════════════════════════════════════════════════════════════
        
        // Configuration RH
        const RH_CONFIG = {
            hoursPerDay: 8.5,       // 8h30
            hoursPerWeek: 42.5,
            vacationDaysPerYear: 20, // 4 semaines
            weekendDays: [0, 6]     // Dimanche, Samedi
        };
        
        // Données RH
        let RHData = {
            employees: JSON.parse(localStorage.getItem('trakio_rh_employees') || '[]'),
            absences: JSON.parse(localStorage.getItem('trakio_rh_absences') || '[]')
        };
        
        function saveRHData() {
            localStorage.setItem('trakio_rh_employees', JSON.stringify(RHData.employees));
            localStorage.setItem('trakio_rh_absences', JSON.stringify(RHData.absences));
        }
        
        function initRHModule() {
            // Initialiser les sélecteurs de date
            const monthSelect = document.getElementById('rh-month-select');
            const yearSelect = document.getElementById('rh-year-select');
            
            if (monthSelect && yearSelect) {
                const now = new Date();
                monthSelect.value = now.getMonth();
                
                // Années: année courante -2 à +1
                yearSelect.innerHTML = '';
                for (let y = now.getFullYear() - 2; y <= now.getFullYear() + 1; y++) {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = y;
                    if (y === now.getFullYear()) opt.selected = true;
                    yearSelect.appendChild(opt);
                }
            }
            
            // Peupler le filtre employés
            updateRHEmployeeFilter();
            
            // Rendre le calendrier
            renderRHCalendar();
            renderRHEmployeesList();
            renderRHAbsencesList();
            renderRHAnnualSummary();
        }
        
        function updateRHEmployeeFilter() {
            const filter = document.getElementById('rh-employee-filter');
            const absenceSelect = document.getElementById('rh-absence-employee');
            if (!filter) return;
            
            filter.innerHTML = '<option value="all">👥 Tous les employés</option>';
            RHData.employees.filter(e => e.active !== false).forEach(emp => {
                const opt = document.createElement('option');
                opt.value = emp.id;
                opt.textContent = emp.name;
                filter.appendChild(opt);
            });
            
            // Aussi pour le modal d'absence
            if (absenceSelect) {
                absenceSelect.innerHTML = '';
                RHData.employees.filter(e => e.active !== false).forEach(emp => {
                    const opt = document.createElement('option');
                    opt.value = emp.id;
                    opt.textContent = emp.name;
                    absenceSelect.appendChild(opt);
                });
            }
        }
        
        function renderRHCalendar() {
            const grid = document.getElementById('rh-calendar-grid');
            const titleEl = document.getElementById('rh-calendar-title');
            if (!grid) return;
            
            const month = parseInt(document.getElementById('rh-month-select')?.value || new Date().getMonth());
            const year = parseInt(document.getElementById('rh-year-select')?.value || new Date().getFullYear());
            const employeeFilter = document.getElementById('rh-employee-filter')?.value || 'all';
            
            const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
            if (titleEl) titleEl.textContent = monthNames[month] + ' ' + year;
            
            // Jours de la semaine
            const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            grid.innerHTML = dayNames.map(d => `<div style="text-align:center; font-size:10px; font-weight:600; color:var(--text-muted); padding:6px;">${d}</div>`).join('');
            
            // Premier jour du mois
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();
            
            // Cases vides avant le 1er
            for (let i = 0; i < startPadding; i++) {
                grid.innerHTML += '<div></div>';
            }
            
            // Jours du mois
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const isWeekend = RH_CONFIG.weekendDays.includes(date.getDay());
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                
                // Chercher les absences pour ce jour
                let absenceType = null;
                let absenceEmployees = [];
                
                RHData.absences.forEach(abs => {
                    if (employeeFilter !== 'all' && abs.employeeId !== parseInt(employeeFilter)) return;
                    if (dateStr >= abs.startDate && dateStr <= abs.endDate) {
                        absenceType = abs.type;
                        const emp = RHData.employees.find(e => e.id === abs.employeeId);
                        if (emp) absenceEmployees.push(emp.name.split(' ')[0]);
                    }
                });
                
                let bgColor = isWeekend ? '#95a5a6' : '#27ae60';
                if (absenceType === 'vacation') bgColor = '#3498db';
                else if (absenceType === 'sick') bgColor = '#e74c3c';
                else if (absenceType === 'leave' || absenceType === 'unpaid') bgColor = '#f39c12';
                
                const borderStyle = isToday ? 'border:2px solid white;' : '';
                const tooltip = absenceEmployees.length > 0 ? absenceEmployees.join(', ') : '';
                
                grid.innerHTML += `
                    <div onclick="showDayDetail('${dateStr}')" title="${tooltip}" style="cursor:pointer; text-align:center; padding:8px 4px; background:${bgColor}30; border-radius:6px; font-size:12px; font-weight:500; ${borderStyle} transition:all 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                        <div style="color:${bgColor}; font-weight:700;">${day}</div>
                        ${absenceEmployees.length > 0 ? `<div style="font-size:8px; color:var(--text-muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${absenceEmployees.length > 1 ? absenceEmployees.length + ' abs' : absenceEmployees[0]}</div>` : ''}
                    </div>
                `;
            }
            
            // Mettre à jour le récap mensuel
            renderRHMonthlySummary(month, year, employeeFilter);
        }
        
        function renderRHMonthlySummary(month, year, employeeFilter) {
            const container = document.getElementById('rh-monthly-summary');
            if (!container) return;
            
            // Calculer les stats du mois
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            let workDays = 0;
            let vacationDays = 0;
            let sickDays = 0;
            let otherDays = 0;
            
            for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                if (!RH_CONFIG.weekendDays.includes(d.getDay())) {
                    const dateStr = d.toISOString().split('T')[0];
                    let hasAbsence = false;
                    
                    RHData.absences.forEach(abs => {
                        if (employeeFilter !== 'all' && abs.employeeId !== parseInt(employeeFilter)) return;
                        if (dateStr >= abs.startDate && dateStr <= abs.endDate) {
                            hasAbsence = true;
                            if (abs.type === 'vacation') vacationDays++;
                            else if (abs.type === 'sick') sickDays++;
                            else otherDays++;
                        }
                    });
                    
                    if (!hasAbsence) workDays++;
                }
            }
            
            const totalHours = workDays * RH_CONFIG.hoursPerDay;
            
            container.innerHTML = `
                <div style="text-align:center; padding:12px; background:rgba(39,174,96,0.15); border-radius:10px;">
                    <div style="font-size:22px; font-weight:700; color:#27ae60;">${workDays}</div>
                    <div style="font-size:10px; color:var(--text-muted);">Jours travaillés</div>
                </div>
                <div style="text-align:center; padding:12px; background:rgba(52,152,219,0.15); border-radius:10px;">
                    <div style="font-size:22px; font-weight:700; color:#3498db;">${vacationDays}</div>
                    <div style="font-size:10px; color:var(--text-muted);">Jours vacances</div>
                </div>
                <div style="text-align:center; padding:12px; background:rgba(231,76,60,0.15); border-radius:10px;">
                    <div style="font-size:22px; font-weight:700; color:#e74c3c;">${sickDays}</div>
                    <div style="font-size:10px; color:var(--text-muted);">Jours maladie</div>
                </div>
                <div style="text-align:center; padding:12px; background:rgba(155,89,182,0.15); border-radius:10px;">
                    <div style="font-size:22px; font-weight:700; color:#9b59b6;">${totalHours.toFixed(1)}h</div>
                    <div style="font-size:10px; color:var(--text-muted);">Heures totales</div>
                </div>
            `;
        }
        
        function renderRHEmployeesList() {
            const container = document.getElementById('rh-employees-list');
            if (!container) return;
            
            if (RHData.employees.length === 0) {
                container.innerHTML = '<div style="padding:30px; text-align:center; color:var(--text-muted);">Aucun employé<br><small>Cliquez sur "Ajouter employé"</small></div>';
                return;
            }
            
            const year = parseInt(document.getElementById('rh-year-select')?.value || new Date().getFullYear());
            
            container.innerHTML = RHData.employees.map(emp => {
                // Calculer les vacances prises cette année
                const vacationTaken = calculateVacationTaken(emp.id, year);
                const vacationBalance = (emp.vacationBalance || RH_CONFIG.vacationDaysPerYear) - vacationTaken;
                const balanceColor = vacationBalance < 0 ? '#e74c3c' : vacationBalance < 5 ? '#f39c12' : '#27ae60';
                
                return `
                    <div style="padding:14px 16px; border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:12px; ${emp.active === false ? 'opacity:0.5;' : ''}">
                        <div style="width:42px; height:42px; border-radius:50%; background:linear-gradient(135deg, #9b59b6, #8e44ad); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:14px;">
                            ${emp.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()}
                        </div>
                        <div style="flex:1; min-width:0;">
                            <div style="font-weight:600; display:flex; align-items:center; gap:6px;">
                                ${emp.name}
                                ${emp.active === false ? '<span style="font-size:10px; background:#e74c3c; color:white; padding:2px 6px; border-radius:4px;">Inactif</span>' : ''}
                            </div>
                            <div style="font-size:11px; color:var(--text-muted);">${emp.position || 'Non défini'} • ${emp.rate || 100}%</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:16px; font-weight:700; color:${balanceColor}; font-family:'Space Mono',monospace;">${vacationBalance.toFixed(1)}j</div>
                            <div style="font-size:10px; color:var(--text-muted);">Solde vacances</div>
                        </div>
                        <div style="display:flex; gap:6px;">
                            <button onclick="editRHEmployee(${emp.id})" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;" title="Modifier">✏️</button>
                            <button onclick="deleteRHEmployee(${emp.id})" style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;" title="Supprimer">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function calculateVacationTaken(employeeId, year) {
            let days = 0;
            RHData.absences.filter(a => a.employeeId === employeeId && a.type === 'vacation').forEach(abs => {
                const start = new Date(abs.startDate);
                const end = new Date(abs.endDate);
                if (start.getFullYear() === year || end.getFullYear() === year) {
                    // Compter les jours ouvrés
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        if (d.getFullYear() === year && !RH_CONFIG.weekendDays.includes(d.getDay())) {
                            days++;
                        }
                    }
                }
            });
            return days;
        }
        
        function renderRHAbsencesList() {
            const container = document.getElementById('rh-absences-list');
            if (!container) return;
            
            const recentAbsences = RHData.absences.sort((a, b) => new Date(b.startDate) - new Date(a.startDate)).slice(0, 20);
            
            if (recentAbsences.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted);">Aucune absence enregistrée</div>';
                return;
            }
            
            const typeLabels = {
                vacation: { icon: '🏖️', label: 'Vacances', color: '#3498db' },
                sick: { icon: '🤒', label: 'Maladie', color: '#e74c3c' },
                leave: { icon: '📋', label: 'Congé', color: '#f39c12' },
                unpaid: { icon: '💸', label: 'Sans solde', color: '#95a5a6' }
            };
            
            container.innerHTML = recentAbsences.map(abs => {
                const emp = RHData.employees.find(e => e.id === abs.employeeId);
                const type = typeLabels[abs.type] || typeLabels.leave;
                const days = countWorkDays(abs.startDate, abs.endDate);
                
                return `
                    <div style="padding:12px 16px; border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:10px;">
                        <span style="font-size:18px;">${type.icon}</span>
                        <div style="flex:1;">
                            <div style="font-weight:600; font-size:13px;">${emp?.name || 'Inconnu'}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${formatDateFR(abs.startDate)} → ${formatDateFR(abs.endDate)}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:14px; font-weight:600; color:${type.color};">${days}j</div>
                        </div>
                        <button onclick="deleteRHAbsence(${abs.id})" style="padding:6px; background:none; border:none; cursor:pointer; opacity:0.5;" title="Supprimer">🗑️</button>
                    </div>
                `;
            }).join('');
        }
        
        function countWorkDays(startDate, endDate) {
            let count = 0;
            const start = new Date(startDate);
            const end = new Date(endDate);
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                if (!RH_CONFIG.weekendDays.includes(d.getDay())) count++;
            }
            return count;
        }
        
        function formatDateFR(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-CH', { day: '2-digit', month: '2-digit' });
        }
        
        function renderRHAnnualSummary() {
            const container = document.getElementById('rh-annual-summary');
            const titleEl = document.getElementById('rh-year-title');
            if (!container) return;
            
            const year = parseInt(document.getElementById('rh-year-select')?.value || new Date().getFullYear());
            if (titleEl) titleEl.textContent = year;
            
            if (RHData.employees.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted);">Ajoutez des employés pour voir le décompte annuel</div>';
                return;
            }
            
            const months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
            
            let tableHTML = `
                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                    <thead>
                        <tr style="background:var(--bg-primary);">
                            <th style="padding:10px; text-align:left; font-weight:600; border-bottom:2px solid var(--border-color);">Employé</th>
                            ${months.map(m => `<th style="padding:8px 4px; text-align:center; font-weight:600; border-bottom:2px solid var(--border-color);">${m}</th>`).join('')}
                            <th style="padding:10px; text-align:center; font-weight:700; border-bottom:2px solid var(--border-color); background:rgba(155,89,182,0.1);">Total</th>
                            <th style="padding:10px; text-align:center; font-weight:700; border-bottom:2px solid var(--border-color); background:rgba(39,174,96,0.1);">Solde</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            RHData.employees.filter(e => e.active !== false).forEach(emp => {
                let totalVacation = 0;
                let monthlyData = [];
                
                for (let m = 0; m < 12; m++) {
                    const vacDays = calculateMonthlyVacation(emp.id, year, m);
                    totalVacation += vacDays;
                    monthlyData.push(vacDays);
                }
                
                const balance = (emp.vacationBalance || RH_CONFIG.vacationDaysPerYear) - totalVacation;
                const balanceColor = balance < 0 ? '#e74c3c' : balance < 5 ? '#f39c12' : '#27ae60';
                
                tableHTML += `
                    <tr style="border-bottom:1px solid var(--border-color);">
                        <td style="padding:10px; font-weight:500;">${emp.name}</td>
                        ${monthlyData.map(d => `<td style="padding:8px 4px; text-align:center; ${d > 0 ? 'color:#3498db; font-weight:600;' : 'color:var(--text-muted);'}">${d > 0 ? d : '-'}</td>`).join('')}
                        <td style="padding:10px; text-align:center; font-weight:700; background:rgba(155,89,182,0.1);">${totalVacation}j</td>
                        <td style="padding:10px; text-align:center; font-weight:700; color:${balanceColor}; background:rgba(39,174,96,0.1);">${balance.toFixed(1)}j</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }
        
        function calculateMonthlyVacation(employeeId, year, month) {
            let days = 0;
            RHData.absences.filter(a => a.employeeId === employeeId && a.type === 'vacation').forEach(abs => {
                const start = new Date(abs.startDate);
                const end = new Date(abs.endDate);
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    if (d.getFullYear() === year && d.getMonth() === month && !RH_CONFIG.weekendDays.includes(d.getDay())) {
                        days++;
                    }
                }
            });
            return days;
        }
        
        // Modals
        function openRHEmployeeModal(id = null) {
            document.getElementById('rh-employee-modal').style.display = 'flex';
            document.getElementById('rh-employee-modal-title').textContent = id ? '✏️ Modifier employé' : '➕ Nouvel employé';
            document.getElementById('rh-emp-edit-id').value = id || '';
            
            if (id) {
                const emp = RHData.employees.find(e => e.id === id);
                if (emp) {
                    document.getElementById('rh-emp-name').value = emp.name;
                    document.getElementById('rh-emp-start-date').value = emp.startDate || '';
                    document.getElementById('rh-emp-rate').value = emp.rate || 100;
                    document.getElementById('rh-emp-vacation-days').value = emp.vacationDays || 20;
                    document.getElementById('rh-emp-vacation-balance').value = emp.vacationBalance || 20;
                    document.getElementById('rh-emp-position').value = emp.position || '';
                    document.getElementById('rh-emp-active').checked = emp.active !== false;
                }
            } else {
                document.getElementById('rh-emp-name').value = '';
                document.getElementById('rh-emp-start-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('rh-emp-rate').value = 100;
                document.getElementById('rh-emp-vacation-days').value = 20;
                document.getElementById('rh-emp-vacation-balance').value = 20;
                document.getElementById('rh-emp-position').value = '';
                document.getElementById('rh-emp-active').checked = true;
            }
        }
        
        function closeRHEmployeeModal() {
            document.getElementById('rh-employee-modal').style.display = 'none';
        }
        
        function saveRHEmployee() {
            const id = document.getElementById('rh-emp-edit-id').value;
            const name = document.getElementById('rh-emp-name').value.trim();
            
            if (!name) {
                alert('Veuillez entrer un nom');
                return;
            }
            
            const empData = {
                name: name,
                startDate: document.getElementById('rh-emp-start-date').value,
                rate: parseInt(document.getElementById('rh-emp-rate').value) || 100,
                vacationDays: parseInt(document.getElementById('rh-emp-vacation-days').value) || 20,
                vacationBalance: parseFloat(document.getElementById('rh-emp-vacation-balance').value) || 20,
                position: document.getElementById('rh-emp-position').value.trim(),
                active: document.getElementById('rh-emp-active').checked
            };
            
            if (id) {
                const idx = RHData.employees.findIndex(e => e.id === parseInt(id));
                if (idx !== -1) {
                    RHData.employees[idx] = { ...RHData.employees[idx], ...empData };
                }
            } else {
                empData.id = Date.now();
                empData.createdAt = new Date().toISOString();
                RHData.employees.push(empData);
            }
            
            saveRHData();
            closeRHEmployeeModal();
            updateRHEmployeeFilter();
            renderRHEmployeesList();
            renderRHAnnualSummary();
            showToast('✅ Employé enregistré !', 'success');
        }
        
        function editRHEmployee(id) {
            openRHEmployeeModal(id);
        }
        
        function deleteRHEmployee(id) {
            if (!confirm('Supprimer cet employé ?')) return;
            RHData.employees = RHData.employees.filter(e => e.id !== id);
            RHData.absences = RHData.absences.filter(a => a.employeeId !== id);
            saveRHData();
            updateRHEmployeeFilter();
            renderRHEmployeesList();
            renderRHCalendar();
            renderRHAbsencesList();
            renderRHAnnualSummary();
            showToast('🗑️ Employé supprimé', 'info');
        }
        
        function addRHAbsence() {
            if (RHData.employees.length === 0) {
                alert('Ajoutez d\'abord des employés');
                return;
            }
            document.getElementById('rh-absence-modal').style.display = 'flex';
            document.getElementById('rh-absence-edit-id').value = '';
            document.getElementById('rh-absence-start').value = '';
            document.getElementById('rh-absence-end').value = '';
            document.getElementById('rh-absence-note').value = '';
            document.getElementById('rh-absence-type').value = 'vacation';
        }
        
        function closeRHAbsenceModal() {
            document.getElementById('rh-absence-modal').style.display = 'none';
        }
        
        function saveRHAbsence() {
            const employeeId = parseInt(document.getElementById('rh-absence-employee').value);
            const startDate = document.getElementById('rh-absence-start').value;
            const endDate = document.getElementById('rh-absence-end').value;
            const type = document.getElementById('rh-absence-type').value;
            const note = document.getElementById('rh-absence-note').value.trim();
            
            if (!employeeId || !startDate || !endDate) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('La date de fin doit être après la date de début');
                return;
            }
            
            const absence = {
                id: Date.now(),
                employeeId: employeeId,
                type: type,
                startDate: startDate,
                endDate: endDate,
                note: note,
                createdAt: new Date().toISOString()
            };
            
            RHData.absences.push(absence);
            saveRHData();
            closeRHAbsenceModal();
            renderRHCalendar();
            renderRHAbsencesList();
            renderRHEmployeesList();
            renderRHAnnualSummary();
            showToast('✅ Absence enregistrée !', 'success');
        }
        
        function deleteRHAbsence(id) {
            if (!confirm('Supprimer cette absence ?')) return;
            RHData.absences = RHData.absences.filter(a => a.id !== id);
            saveRHData();
            renderRHCalendar();
            renderRHAbsencesList();
            renderRHEmployeesList();
            renderRHAnnualSummary();
            showToast('🗑️ Absence supprimée', 'info');
        }
        
        function showDayDetail(dateStr) {
            const absencesForDay = RHData.absences.filter(a => dateStr >= a.startDate && dateStr <= a.endDate);
            if (absencesForDay.length === 0) {
                alert('Aucune absence ce jour');
                return;
            }
            
            let msg = `📅 ${formatDateFR(dateStr)}\n\n`;
            absencesForDay.forEach(abs => {
                const emp = RHData.employees.find(e => e.id === abs.employeeId);
                const typeLabels = { vacation: 'Vacances', sick: 'Maladie', leave: 'Congé', unpaid: 'Sans solde' };
                msg += `• ${emp?.name || 'Inconnu'}: ${typeLabels[abs.type] || abs.type}\n`;
            });
            alert(msg);
        }
        
        function printRHReport() {
            const employeeFilter = document.getElementById('rh-employee-filter')?.value || 'all';
            const month = parseInt(document.getElementById('rh-month-select')?.value || new Date().getMonth());
            const year = parseInt(document.getElementById('rh-year-select')?.value || new Date().getFullYear());
            const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
            
            let printContent = `
                <html>
                <head>
                    <title>Rapport RH - ${monthNames[month]} ${year}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #9b59b6; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
                        th { background: #9b59b6; color: white; }
                        .vacation { background: #3498db20; }
                        .sick { background: #e74c3c20; }
                    </style>
                </head>
                <body>
                    <h1>👥 Rapport RH - ${monthNames[month]} ${year}</h1>
                    <p>Généré le ${new Date().toLocaleDateString('fr-CH')}</p>
            `;
            
            // Ajouter le contenu selon le filtre
            if (employeeFilter === 'all') {
                printContent += '<h2>Tous les employés</h2>';
                RHData.employees.filter(e => e.active !== false).forEach(emp => {
                    const vacTaken = calculateVacationTaken(emp.id, year);
                    const balance = (emp.vacationBalance || 20) - vacTaken;
                    printContent += `<p><strong>${emp.name}</strong> - Vacances prises: ${vacTaken}j - Solde: ${balance.toFixed(1)}j</p>`;
                });
            } else {
                const emp = RHData.employees.find(e => e.id === parseInt(employeeFilter));
                if (emp) {
                    printContent += `<h2>${emp.name}</h2>`;
                    const vacTaken = calculateVacationTaken(emp.id, year);
                    const balance = (emp.vacationBalance || 20) - vacTaken;
                    printContent += `<p>Taux: ${emp.rate || 100}% - Vacances prises: ${vacTaken}j - Solde: ${balance.toFixed(1)}j</p>`;
                }
            }
            
            printContent += `
                    <h3>Absences du mois</h3>
                    <table>
                        <tr><th>Employé</th><th>Type</th><th>Du</th><th>Au</th><th>Jours</th></tr>
            `;
            
            RHData.absences.filter(abs => {
                if (employeeFilter !== 'all' && abs.employeeId !== parseInt(employeeFilter)) return false;
                const start = new Date(abs.startDate);
                const end = new Date(abs.endDate);
                return (start.getMonth() === month && start.getFullYear() === year) || 
                       (end.getMonth() === month && end.getFullYear() === year);
            }).forEach(abs => {
                const emp = RHData.employees.find(e => e.id === abs.employeeId);
                const typeLabels = { vacation: 'Vacances', sick: 'Maladie', leave: 'Congé', unpaid: 'Sans solde' };
                const days = countWorkDays(abs.startDate, abs.endDate);
                printContent += `<tr class="${abs.type}"><td>${emp?.name || '-'}</td><td>${typeLabels[abs.type]}</td><td>${formatDateFR(abs.startDate)}</td><td>${formatDateFR(abs.endDate)}</td><td>${days}</td></tr>`;
            });
            
            printContent += '</table></body></html>';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Filtre par statut dans les commandes
        function filterOrdersByStatus(status) {
            // Cette fonction sera appelée après navigation vers orders
            // On stocke le filtre désiré
            sessionStorage.setItem('filterOrderStatus', status);
        }
    </script>

    <!-- Barre flottante commande en cours - Compacte Mobile -->
    <div id="floating-order-bar" style="display:none; position:fixed; bottom:12px; left:12px; right:12px; background:var(--bg-card); border:2px solid var(--accent-primary); border-radius:14px; padding:10px 14px; z-index:9998; box-shadow:0 4px 20px rgba(0,0,0,0.4);">
        <!-- Bouton fermer -->
        <button onclick="hideFloatingOrderBar()" style="position:absolute; top:-8px; right:-8px; width:24px; height:24px; border-radius:50%; background:var(--bg-card); border:1px solid var(--border-color); color:var(--text-muted); font-size:12px; cursor:pointer; display:flex; align-items:center; justify-content:center;">✕</button>
        <div style="display:flex; align-items:center; gap:10px;">
            <div style="width:36px; height:36px; background:var(--accent-primary); border-radius:8px; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                <span style="font-size:16px;">🛒</span>
            </div>
            <div style="flex:1; min-width:0;">
                <div id="floating-order-client" style="font-size:13px; font-weight:600; color:var(--text-primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Client</div>
            </div>
            <div style="text-align:right; padding:4px 10px; background:var(--bg-primary); border-radius:6px;">
                <div id="floating-order-total" style="font-size:15px; font-weight:700; color:var(--accent-primary); font-family:'Space Mono',monospace;">0.00</div>
            </div>
            <button onclick="goToCurrentOrder()" style="padding:8px 12px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; white-space:nowrap;">
                ✏️
            </button>
            <button onclick="showFinalizeModal()" style="padding:8px 12px; background:var(--accent-primary); color:#000; border:none; border-radius:6px; font-size:11px; font-weight:700; cursor:pointer; white-space:nowrap;">
                ✅
            </button>
        </div>
    </div>

    <!-- Modal Commandes du Client -->
    <div id="client-orders-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center; padding:20px;" onclick="if(event.target === this) closeClientOrdersModal()">
        <div style="background:var(--bg-card); border-radius:20px; max-width:800px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
            <!-- Header -->
            <div style="padding:20px 24px; background:linear-gradient(135deg, var(--accent-secondary), var(--accent-primary)); color:#fff;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-size:12px; opacity:0.8;">HISTORIQUE</div>
                        <h2 id="client-orders-title" style="font-size:22px; font-weight:700; margin:0;">Commandes du client</h2>
                    </div>
                    <button onclick="closeClientOrdersModal()" style="background:rgba(255,255,255,0.2); border:none; color:#fff; width:36px; height:36px; border-radius:50%; font-size:20px; cursor:pointer;">×</button>
                </div>
            </div>
            <!-- Liste des commandes -->
            <div id="client-orders-list" style="flex:1; overflow-y:auto; padding:20px;">
                <!-- Rempli dynamiquement -->
            </div>
        </div>
    </div>

    <!-- Modal Récapitulatif / Finalisation -->
    <div id="finalize-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center; padding:20px;" onclick="if(event.target === this) closeFinalizeModal()">
        <div style="background:var(--bg-card); border-radius:20px; max-width:600px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
            <!-- Header -->
            <div style="padding:20px 24px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color:#000;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-size:12px; opacity:0.8;">RÉCAPITULATIF</div>
                        <h2 style="font-size:22px; font-weight:700; margin:0;">Commande</h2>
                    </div>
                    <button onclick="closeFinalizeModal()" style="background:rgba(0,0,0,0.2); border:none; color:#000; width:36px; height:36px; border-radius:50%; font-size:20px; cursor:pointer;">×</button>
                </div>
            </div>

            <!-- Client Info -->
            <div style="padding:16px 24px; background:var(--bg-primary); border-bottom:1px solid var(--border-color);">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div id="finalize-client-icon" style="width:45px; height:45px; background:var(--accent-secondary)20; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px;">🏢</div>
                    <div>
                        <div id="finalize-client-name" style="font-size:18px; font-weight:700;"></div>
                        <div id="finalize-client-info" style="font-size:13px; color:var(--text-muted);"></div>
                    </div>
                </div>
            </div>

            <!-- Articles List -->
            <div style="flex:1; overflow-y:auto; padding:16px 24px;">
                <div style="font-size:12px; color:var(--text-muted); margin-bottom:12px; text-transform:uppercase;">Articles commandés</div>
                <div id="finalize-items-list"></div>
            </div>

            <!-- Totaux -->
            <div style="padding:16px 24px; background:var(--bg-primary); border-top:1px solid var(--border-color);">
                <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-size:14px;">
                    <span>Total HT</span>
                    <span id="finalize-total-ht" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:13px; color:var(--text-muted);">
                    <span>TVA (2.6%)</span>
                    <span id="finalize-total-tva" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                </div>
                <div style="display:flex; justify-content:space-between; padding-top:10px; border-top:2px solid var(--accent-primary);">
                    <span style="font-size:18px; font-weight:700;">TOTAL TTC</span>
                    <span id="finalize-total-ttc" style="font-size:24px; font-weight:700; color:var(--accent-primary); font-family:'Space Mono',monospace;">0.00 CHF</span>
                </div>
            </div>

            <!-- Actions -->
            <div style="padding:16px 24px; display:flex; gap:12px; border-top:1px solid var(--border-color);">
                <button onclick="closeFinalizeModal(); goToCurrentOrder();" style="flex:1; padding:14px; background:var(--bg-hover); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; font-size:14px; font-weight:600; cursor:pointer;">
                    ✏️ Modifier
                </button>
                <button onclick="confirmAndFinalizeOrder()" style="flex:2; padding:14px; background:var(--accent-primary); color:#000; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    ✅ Valider & Imprimer
                </button>
            </div>
        </div>
    </div>
</body>
</html>

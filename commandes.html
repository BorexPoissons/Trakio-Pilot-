<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO v4.5.0 - Commandes</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="trakio-config.js?v=4.5.0"></script>
    <script src="trakio-sync.js?v=4.5.0"></script>
    <script src="trakio-ui.js?v=4.5.0"></script>
    <style>
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 15px; }
        .page-title { font-size: 26px; font-weight: 700; }
        .btn { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--trakio-primary); color: white; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-secondary { background: var(--trakio-bg-input); color: var(--trakio-text); border: 1px solid var(--trakio-border); }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; background: var(--trakio-bg-card); padding: 5px; border-radius: 12px; border: 1px solid var(--trakio-border); flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: transparent; border: none; border-radius: 8px; color: var(--trakio-text-muted); font-weight: 500; cursor: pointer; }
        .tab.active { background: var(--trakio-primary); color: white; }
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px; }
        .order-card { background: var(--trakio-bg-card); border: 1px solid var(--trakio-border); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.2s; }
        .order-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); border-color: var(--trakio-primary); }
        .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .order-client { font-size: 16px; font-weight: 600; }
        .order-date { font-size: 12px; color: var(--trakio-text-muted); }
        .order-status { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .order-status.pending { background: rgba(245, 158, 11, 0.2); color: var(--trakio-warning); }
        .order-status.confirmed { background: rgba(14, 165, 233, 0.2); color: var(--trakio-primary); }
        .order-status.ready { background: rgba(16, 185, 129, 0.2); color: var(--trakio-success); }
        .order-status.delivered { background: rgba(107, 114, 128, 0.2); color: var(--trakio-text-muted); }
        .order-items { font-size: 13px; color: var(--trakio-text-muted); margin-bottom: 15px; padding: 10px; background: var(--trakio-bg-input); border-radius: 8px; }
        .order-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid var(--trakio-border); }
        .order-total { font-size: 20px; font-weight: 700; color: var(--trakio-success); }
        .order-actions { display: flex; gap: 8px; }
        .order-action { padding: 8px 14px; background: var(--trakio-bg-input); border: none; border-radius: 8px; cursor: pointer; font-size: 12px; color: var(--trakio-text); }
        .order-action:hover { background: var(--trakio-primary); }
        .empty { text-align: center; padding: 60px; color: var(--trakio-text-muted); grid-column: 1 / -1; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 10000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--trakio-bg-card); border-radius: 20px; width: 100%; max-width: 700px; max-height: 90vh; overflow: hidden; border: 1px solid var(--trakio-border); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--trakio-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; background: var(--trakio-bg-input); border: none; color: var(--trakio-text); cursor: pointer; font-size: 20px; }
        .modal-body { padding: 20px; overflow-y: auto; max-height: calc(90vh - 140px); }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; color: var(--trakio-text-muted); margin-bottom: 6px; }
        .form-group input, .form-group select { width: 100%; padding: 10px 14px; background: var(--trakio-bg-input); border: 1px solid var(--trakio-border); border-radius: 8px; color: var(--trakio-text); font-size: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .items-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--trakio-border); }
        .item-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .item-row input, .item-row select { flex: 1; }
        .item-remove { width: 36px; height: 36px; background: var(--trakio-error); border: none; border-radius: 8px; color: white; cursor: pointer; }
        .add-item-btn { width: 100%; padding: 12px; background: var(--trakio-bg-input); border: 2px dashed var(--trakio-border); border-radius: 8px; cursor: pointer; color: var(--trakio-text-muted); }
        .total-section { margin-top: 20px; padding: 15px; background: var(--trakio-bg-input); border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
        .total-label { color: var(--trakio-text-muted); }
        .total-value { font-size: 24px; font-weight: 700; color: var(--trakio-success); }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--trakio-border); display: flex; justify-content: space-between; gap: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">üìã Commandes</h1>
            <button class="btn btn-primary" onclick="openModal()">‚ûï Nouvelle commande</button>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="setTab('all')" data-tab="all">Toutes</button>
            <button class="tab" onclick="setTab('pending')" data-tab="pending">‚è≥ En attente</button>
            <button class="tab" onclick="setTab('confirmed')" data-tab="confirmed">‚úÖ Confirm√©es</button>
            <button class="tab" onclick="setTab('ready')" data-tab="ready">üì¶ Pr√™tes</button>
            <button class="tab" onclick="setTab('delivered')" data-tab="delivered">üöö Livr√©es</button>
        </div>
        <div class="orders-grid" id="orders-grid"><div class="empty">Chargement...</div></div>
    </div>
    <div class="modal-overlay" id="order-modal">
        <div class="modal">
            <div class="modal-header"><h3 id="modal-title">‚ûï Nouvelle commande</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label>Client *</label><select id="order-client"><option value="">-- S√©lectionner --</option></select></div>
                    <div class="form-group"><label>Statut</label><select id="order-status"><option value="pending">En attente</option><option value="confirmed">Confirm√©e</option><option value="ready">Pr√™te</option><option value="delivered">Livr√©e</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Date livraison</label><input type="date" id="order-date"></div>
                    <div class="form-group"><label>Heure</label><input type="time" id="order-time" value="10:00"></div>
                </div>
                <div class="items-section">
                    <label>Articles</label>
                    <div id="items-container"></div>
                    <button class="add-item-btn" onclick="addItem()">‚ûï Ajouter un article</button>
                </div>
                <div class="total-section"><span class="total-label">Total</span><span class="total-value" id="order-total">CHF 0.00</span></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annuler</button><button class="btn btn-primary" onclick="saveOrder()">üíæ Enregistrer</button></div>
        </div>
    </div>
    <script>
        let ordersData = [], clientsData = [], articlesData = [], currentTab = 'all', editingId = null, itemCounter = 0;
        document.addEventListener('DOMContentLoaded', () => setTimeout(loadData, 300));
        async function loadData() {
            try {
                [ordersData, clientsData, articlesData] = await Promise.all([DataStore.commandes.getAll(), DataStore.clients.getAll(), DataStore.articles.getAll()]);
                renderOrders(); populateClientSelect();
            } catch (e) { console.error(e); }
        }
        function populateClientSelect() {
            const sel = document.getElementById('order-client');
            sel.innerHTML = '<option value="">-- S√©lectionner --</option>' + clientsData.map(c => '<option value="'+c.id+'">'+c.firstName+' '+c.lastName+(c.company?' ('+c.company+')':'')+'</option>').join('');
        }
        function setTab(tab) { currentTab = tab; document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab)); renderOrders(); }
        function renderOrders() {
            let filtered = currentTab === 'all' ? ordersData : ordersData.filter(o => o.status === currentTab);
            filtered = filtered.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            const grid = document.getElementById('orders-grid');
            if (filtered.length === 0) { grid.innerHTML = '<div class="empty">Aucune commande</div>'; return; }
            const statusLabels = { pending: 'En attente', confirmed: 'Confirm√©e', ready: 'Pr√™te', delivered: 'Livr√©e' };
            grid.innerHTML = filtered.map(o => {
                const status = o.status || 'pending';
                return '<div class="order-card" onclick="openModal(\''+o.id+'\')"><div class="order-header"><div><div class="order-client">'+(o.clientName||'Client')+'</div><div class="order-date">'+formatDateTime(o.createdAt)+'</div></div><span class="order-status '+status+'">'+statusLabels[status]+'</span></div><div class="order-items">'+(o.items?.length||0)+' article(s)'+(o.deliveryDate?' ‚Ä¢ Livraison: '+formatDate(o.deliveryDate):'')+'</div><div class="order-footer"><span class="order-total">'+formatCHF(o.total)+'</span><div class="order-actions"><button class="order-action" onclick="event.stopPropagation(); printOrder(\''+o.id+'\')">üñ®Ô∏è</button></div></div></div>';
            }).join('');
        }
        function openModal(id = null) {
            editingId = id; itemCounter = 0;
            document.getElementById('order-client').value = '';
            document.getElementById('order-status').value = 'pending';
            document.getElementById('order-date').value = new Date().toISOString().slice(0, 10);
            document.getElementById('order-time').value = '10:00';
            document.getElementById('items-container').innerHTML = '';
            if (id) {
                const o = ordersData.find(x => x.id === id);
                if (o) {
                    document.getElementById('modal-title').textContent = '‚úèÔ∏è Modifier commande';
                    document.getElementById('order-client').value = o.clientId || '';
                    document.getElementById('order-status').value = o.status || 'pending';
                    if (o.deliveryDate) document.getElementById('order-date').value = o.deliveryDate.slice(0, 10);
                    if (o.deliveryTime) document.getElementById('order-time').value = o.deliveryTime;
                    (o.items || []).forEach(item => addItem(item));
                }
            } else { document.getElementById('modal-title').textContent = '‚ûï Nouvelle commande'; addItem(); }
            updateTotal();
            document.getElementById('order-modal').classList.add('active');
        }
        function closeModal() { document.getElementById('order-modal').classList.remove('active'); editingId = null; }
        function addItem(item = null) {
            const container = document.getElementById('items-container');
            const idx = itemCounter++;
            const div = document.createElement('div');
            div.className = 'item-row';
            div.id = 'item-' + idx;
            div.innerHTML = '<select onchange="updateTotal()"><option value="">Article...</option>'+articlesData.map(a=>'<option value="'+a.id+'" data-price="'+(a.price||0)+'"'+(item?.articleId===a.id?' selected':'')+'>'+a.name+' ('+formatCHF(a.price)+')</option>').join('')+'</select><input type="number" placeholder="Qt√©" min="0.1" step="0.1" value="'+(item?.quantity||1)+'" onchange="updateTotal()"><input type="number" placeholder="Prix" step="0.05" value="'+(item?.price||'')+'" onchange="updateTotal()"><button class="item-remove" onclick="removeItem('+idx+')">√ó</button>';
            container.appendChild(div);
        }
        function removeItem(idx) { document.getElementById('item-' + idx)?.remove(); updateTotal(); }
        function updateTotal() {
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const sel = row.querySelector('select');
                const qtyInput = row.querySelectorAll('input')[0];
                const priceInput = row.querySelectorAll('input')[1];
                const qty = parseFloat(qtyInput.value) || 0;
                let price = parseFloat(priceInput.value);
                if (isNaN(price) && sel.selectedOptions[0]?.dataset.price) price = parseFloat(sel.selectedOptions[0].dataset.price);
                if (!isNaN(price)) total += qty * price;
            });
            document.getElementById('order-total').textContent = formatCHF(total);
        }
        async function saveOrder() {
            const clientId = document.getElementById('order-client').value;
            const client = clientsData.find(c => c.id === clientId);
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const sel = row.querySelector('select');
                const qty = parseFloat(row.querySelectorAll('input')[0].value) || 0;
                const price = parseFloat(row.querySelectorAll('input')[1].value) || parseFloat(sel.selectedOptions[0]?.dataset.price) || 0;
                if (sel.value && qty > 0) items.push({ articleId: sel.value, articleName: sel.selectedOptions[0].text, quantity: qty, price });
            });
            const total = items.reduce((s, i) => s + (i.quantity * i.price), 0);
            const data = { clientId, clientName: client ? client.firstName + ' ' + client.lastName : 'Client', status: document.getElementById('order-status').value, deliveryDate: document.getElementById('order-date').value, deliveryTime: document.getElementById('order-time').value, items, total };
            await DataStore.commandes.save(editingId, data);
            TrakioUI.showToast('‚úÖ Commande enregistr√©e', 'success');
            closeModal(); loadData();
        }
        function printOrder(id) { TrakioUI.showToast('üñ®Ô∏è Impression...', 'info'); }
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO - MyFish PRO v1.0.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-card: #12121a;
            --bg-hover: #1a1a25;
            --border-color: #2a2a3a;
            --text-primary: #ffffff;
            --text-secondary: #ccccdd;
            --text-muted: #8888aa;
            --accent-primary: #06d6a0;
            --accent-secondary: #118ab2;
            --accent-warning: #ffd166;
            --accent-danger: #ef476f;
            --accent-orange: #ff9f43;
            --radius: 12px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px 20px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .back-btn {
            padding: 10px 16px;
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .back-btn:hover {
            background: var(--accent-primary);
            color: #000;
            border-color: var(--accent-primary);
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .version-badge {
            font-size: 11px;
            padding: 4px 10px;
            background: var(--accent-primary);
            color: #000;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: #000;
        }
        
        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            overflow: hidden;
        }
        
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 700;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .table-container { overflow-x: auto; }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 2px solid var(--border-color);
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }
        
        tr:hover { background: var(--bg-hover); }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.visible { display: flex; }
        
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            padding: 14px 20px;
            background: var(--bg-card);
            border: 1px solid var(--accent-primary);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .hide-mobile { display: none; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <a href="index.html" class="back-btn">‚Üê Retour TRAKIO</a>
            <h1>üêü MyFish PRO <span class="version-badge">v1.0.0</span></h1>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-secondary" onclick="showMFClientsModal()" title="Clients">üë•</button>
            <button class="btn btn-secondary" onclick="showMFArticlesViewModal()" title="Articles">üì¶</button>
            <button class="btn btn-secondary" onclick="showMFStoresModal()" title="Magasins">üè™</button>
            <button class="btn btn-primary" onclick="startMFNewOrder()">‚ûï Nouvelle</button>
        </div>
    </div>
    
    <!-- Module page content wrapper -->
    <div id="page-myfish">
                <!-- Header MyFish PRO compact -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:12px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:28px;">üêü</span>
                        <div>
                            <h2 style="font-size:20px; font-weight:700;">MyFish PRO</h2>
                            <p style="color:var(--text-muted); font-size:11px;">Commandes clients</p>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-secondary" onclick="showMFClientsModal()" style="padding:8px 12px; font-size:12px;" title="Clients">üë•</button>
                        <button class="btn btn-secondary" onclick="showMFArticlesViewModal()" style="padding:8px 12px; font-size:12px;" title="Articles">üì¶</button>
                        <button class="btn btn-secondary" onclick="showMFStoresModal()" style="padding:8px 12px; font-size:12px;" title="Magasins">üè™</button>
                        <button class="btn btn-primary" onclick="startMFNewOrder()" style="padding:10px 16px; font-size:14px;">
                            ‚ûï Nouvelle
                        </button>
                    </div>
                </div>

                <!-- Vue Dashboard (par d√©faut) -->
                <div id="mf-view-dashboard">
                    <!-- Points de retrait en premier - GRANDE VISIBILIT√â -->
                    <div id="mf-stores-dashboard" style="margin-bottom:20px;">
                        <!-- G√©n√©r√© dynamiquement -->
                    </div>

                    <!-- Stats globales en ligne compacte -->
                    <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;">
                        <div onclick="filterMFOrdersByStatus('')" style="flex:1; min-width:70px; cursor:pointer; background:var(--bg-card); border-radius:10px; padding:10px; text-align:center; border:1px solid var(--border-color);">
                            <div style="font-size:22px; font-weight:700; color:var(--text-primary);" id="mf-stat-total">0</div>
                            <div style="font-size:9px; color:var(--text-muted);">TOTAL</div>
                        </div>
                        <div onclick="filterMFOrdersByStatus('pending')" style="flex:1; min-width:70px; cursor:pointer; background:var(--bg-card); border-radius:10px; padding:10px; text-align:center; border:2px solid #f4a261;">
                            <div style="font-size:22px; font-weight:700; color:#f4a261;" id="mf-stat-pending">0</div>
                            <div style="font-size:9px; color:var(--text-muted);">ATTENTE</div>
                        </div>
                        <div onclick="filterMFOrdersByStatus('confirmed')" style="flex:1; min-width:70px; cursor:pointer; background:var(--bg-card); border-radius:10px; padding:10px; text-align:center; border:2px solid #118ab2;">
                            <div style="font-size:22px; font-weight:700; color:#118ab2;" id="mf-stat-confirmed">0</div>
                            <div style="font-size:9px; color:var(--text-muted);">CONFIRM√âES</div>
                        </div>
                        <div onclick="filterMFOrdersByStatus('ready')" style="flex:1; min-width:70px; cursor:pointer; background:var(--bg-card); border-radius:10px; padding:10px; text-align:center; border:2px solid #06d6a0;">
                            <div style="font-size:22px; font-weight:700; color:#06d6a0;" id="mf-stat-ready">0</div>
                            <div style="font-size:9px; color:var(--text-muted);">PR√äTES</div>
                        </div>
                    </div>

                    <!-- Liste des commandes -->
                    <div class="card">
                        <div class="card-header" style="padding:12px 16px; flex-wrap:wrap; gap:8px;">
                            <h3 class="card-title" style="font-size:14px;">üìã Commandes</h3>
                            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                                <select id="mf-filter-store" onchange="renderMFOrders()" style="padding:6px 10px; font-size:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                    <option value="">Tous magasins</option>
                                </select>
                                <select id="mf-filter-status" onchange="renderMFOrders()" style="padding:6px 10px; font-size:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                                    <option value="">Tous statuts</option>
                                    <option value="pending">‚è≥ En attente</option>
                                    <option value="confirmed">‚úÖ Confirm√©e</option>
                                    <option value="ready">üéâ Pr√™te</option>
                                    <option value="delivered">ü§ù Remise</option>
                                </select>
                                <input type="date" id="mf-filter-date" onchange="renderMFOrders()" style="padding:6px 10px; font-size:12px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                            </div>
                        </div>
                        <div class="table-container" style="font-size:13px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="padding:8px 6px;">N¬∞</th>
                                        <th style="padding:8px 6px;">Client</th>
                                        <th style="padding:8px 6px;">Lieu</th>
                                        <th style="padding:8px 6px;">Date</th>
                                        <th style="padding:8px 6px;" class="hide-mobile">Heure</th>
                                        <th style="padding:8px 6px;">Total</th>
                                        <th style="padding:8px 6px;">Statut</th>
                                        <th style="padding:8px 6px;">Act.</th>
                                    </tr>
                                </thead>
                                <tbody id="mf-orders-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Vue Nouvelle Commande (5 √©tapes) -->
                <div id="mf-view-neworder" style="display:none;">
                    <!-- Barre de progression compacte -->
                    <div style="background:var(--bg-card); border-radius:12px; padding:12px 16px; margin-bottom:16px; border:1px solid var(--border-color);">
                        <div style="display:flex; justify-content:space-between; align-items:center; position:relative;">
                            <!-- Ligne de connexion -->
                            <div style="position:absolute; top:50%; left:8%; right:8%; height:2px; background:var(--border-color); z-index:0;"></div>
                            <div id="mf-progress-line" style="position:absolute; top:50%; left:8%; height:2px; background:var(--accent-primary); z-index:1; width:0%; transition:width 0.3s;"></div>

                            <!-- √âtapes compactes -->
                            <div class="mf-step active" data-step="1" onclick="goToMFStep(1)" style="z-index:2; text-align:center; cursor:pointer;">
                                <div style="width:36px; height:36px; border-radius:50%; background:var(--accent-primary); color:#000; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; margin:0 auto 4px; transition:all 0.3s;">1</div>
                                <div style="font-size:10px; font-weight:600; color:var(--accent-primary);">Client</div>
                            </div>
                            <div class="mf-step" data-step="2" onclick="goToMFStep(2)" style="z-index:2; text-align:center; cursor:pointer;">
                                <div style="width:36px; height:36px; border-radius:50%; background:var(--bg-hover); color:var(--text-muted); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; margin:0 auto 4px; border:2px solid var(--border-color); transition:all 0.3s;">2</div>
                                <div style="font-size:10px; color:var(--text-muted);">Lieu</div>
                            </div>
                            <div class="mf-step" data-step="3" onclick="goToMFStep(3)" style="z-index:2; text-align:center; cursor:pointer;">
                                <div style="width:36px; height:36px; border-radius:50%; background:var(--bg-hover); color:var(--text-muted); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; margin:0 auto 4px; border:2px solid var(--border-color); transition:all 0.3s;">3</div>
                                <div style="font-size:10px; color:var(--text-muted);">Articles</div>
                            </div>
                            <div class="mf-step" data-step="4" onclick="goToMFStep(4)" style="z-index:2; text-align:center; cursor:pointer;">
                                <div style="width:36px; height:36px; border-radius:50%; background:var(--bg-hover); color:var(--text-muted); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; margin:0 auto 4px; border:2px solid var(--border-color); transition:all 0.3s;">4</div>
                                <div style="font-size:10px; color:var(--text-muted);">R√©cap</div>
                            </div>
                            <div class="mf-step" data-step="5" onclick="goToMFStep(5)" style="z-index:2; text-align:center; cursor:pointer;">
                                <div style="width:36px; height:36px; border-radius:50%; background:var(--bg-hover); color:var(--text-muted); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; margin:0 auto 4px; border:2px solid var(--border-color); transition:all 0.3s;">5</div>
                                <div style="font-size:10px; color:var(--text-muted);">OK</div>
                            </div>
                        </div>
                    </div>

                    <!-- √âTAPE 1: Client -->
                    <div id="mf-step-1" class="mf-step-content">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üë§ Client</h3>
                                <button class="btn btn-secondary" onclick="cancelMFOrder()" style="padding:8px 14px;">‚úï</button>
                            </div>
                            <div class="card-body">
                                <!-- S√©lecteur B2B / B2C compact -->
                                <div style="display:flex; gap:8px; margin-bottom:16px;">
                                    <button id="mf-type-b2c" onclick="setMFClientType('B2C')" class="mf-type-btn" style="flex:1; padding:14px 12px; border-radius:12px; border:2px solid var(--accent-primary); background:rgba(6,214,160,0.15); cursor:pointer; transition:all 0.2s;">
                                        <div style="font-size:24px; margin-bottom:4px;">üë§</div>
                                        <div style="font-size:14px; font-weight:700; color:var(--accent-primary);">Particulier</div>
                                        <div style="font-size:11px; color:var(--text-muted);">B2C</div>
                                    </button>
                                    <button id="mf-type-b2b" onclick="setMFClientType('B2B')" class="mf-type-btn" style="flex:1; padding:14px 12px; border-radius:12px; border:2px solid var(--border-color); background:var(--bg-primary); cursor:pointer; transition:all 0.2s;">
                                        <div style="font-size:24px; margin-bottom:4px;">üè¢</div>
                                        <div style="font-size:14px; font-weight:700; color:var(--text-primary);">Professionnel</div>
                                        <div style="font-size:11px; color:var(--text-muted);">B2B</div>
                                    </button>
                                </div>

                                <!-- Recherche client compact -->
                                <div style="position:relative; margin-bottom:16px;">
                                    <input type="text" id="mf-client-search" placeholder="üîç Rechercher nom, entreprise, t√©l..."
                                        style="width:100%; padding:14px 16px; font-size:16px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:10px; color:var(--text-primary);"
                                        oninput="searchMFClients(this.value)" autocomplete="off">
                                    <div id="mf-client-results" style="display:none; position:absolute; top:100%; left:0; right:0; background:var(--bg-card); border:2px solid var(--border-color); border-radius:10px; max-height:250px; overflow-y:auto; z-index:100; margin-top:4px; box-shadow:0 8px 24px rgba(0,0,0,0.3);"></div>
                                </div>

                                <!-- Client s√©lectionn√© compact -->
                                <div id="mf-selected-client" style="display:none; padding:14px; background:linear-gradient(135deg, rgba(6,214,160,0.1), rgba(17,138,178,0.1)); border:2px solid var(--accent-primary); border-radius:10px; margin-bottom:16px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                                        <div style="flex:1; min-width:0;">
                                            <h3 id="mf-client-display-name" style="font-size:16px; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></h3>
                                            <p style="color:var(--text-muted); font-size:12px;">
                                                üìû <span id="mf-client-display-phone"></span> ‚Ä¢
                                                üìß <span id="mf-client-display-email"></span>
                                            </p>
                                            <p id="mf-client-display-address" style="color:var(--text-muted); font-size:11px; margin-top:2px;"></p>
                                            <p id="mf-client-display-allergies" style="color:var(--accent-danger); font-size:11px; margin-top:2px; display:none;"></p>
                                        </div>
                                        <button class="btn btn-secondary" onclick="clearMFClient()" style="padding:6px 12px; font-size:12px;">‚úï</button>
                                    </div>
                                </div>

                                <!-- Bouton cr√©ation rapide -->
                                <div style="text-align:center; margin-bottom:16px;">
                                    <button class="btn btn-secondary" onclick="showMFQuickClientForm()" style="padding:10px 20px; font-size:13px;">
                                        ‚ûï Nouveau client
                                    </button>
                                </div>

                                <!-- Formulaire cr√©ation rapide -->
                                <div id="mf-quick-client-form" style="display:none; padding:24px; background:var(--bg-primary); border-radius:16px; border:2px dashed var(--accent-primary);">
                                    <h4 id="mf-form-title" style="color:var(--accent-primary); margin-bottom:20px; display:flex; align-items:center; gap:8px;">
                                        <span>‚ûï</span> Nouveau client particulier
                                    </h4>

                                    <!-- Champs B2B uniquement -->
                                    <div id="mf-b2b-fields" style="display:none; margin-bottom:16px;">
                                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                                            <div style="grid-column:1/-1;">
                                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">üè¢ Nom entreprise *</label>
                                                <input type="text" id="mf-new-company" placeholder="Restaurant Le L√©man, Boulangerie M√ºller..." style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--accent-secondary); border-radius:8px; color:var(--text-primary); font-weight:600;">
                                            </div>
                                            <div style="grid-column:1/-1;">
                                                <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Contact / Responsable</label>
                                                <input type="text" id="mf-new-contact" placeholder="M. Dupont, Mme Martin..." style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Champs B2C (Nom/Pr√©nom) -->
                                    <div id="mf-b2c-fields" style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Nom *</label>
                                            <input type="text" id="mf-new-lastname" placeholder="Dupont" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Pr√©nom *</label>
                                            <input type="text" id="mf-new-firstname" placeholder="Jean" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                    </div>

                                    <!-- Champs communs -->
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                                        <div style="grid-column:1/-1;">
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Adresse</label>
                                            <input type="text" id="mf-new-address" placeholder="Rue de la Gare 12" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">NPA</label>
                                            <input type="text" id="mf-new-zip" placeholder="1000" maxlength="6" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Lieu *</label>
                                            <input type="text" id="mf-new-city" placeholder="Lausanne" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">T√©l. portable *</label>
                                            <input type="tel" id="mf-new-mobile" placeholder="+41 79 xxx xx xx" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">T√©l. fixe</label>
                                            <input type="tel" id="mf-new-phone" placeholder="+41 21 xxx xx xx" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div style="grid-column:1/-1;">
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Email</label>
                                            <input type="email" id="mf-new-email" placeholder="jean.dupont@email.ch" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div style="grid-column:1/-1;">
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">‚ö†Ô∏è Allergies</label>
                                            <input type="text" id="mf-new-allergies" placeholder="Crustac√©s, sulfites..." style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--accent-danger)40; border-radius:8px; color:var(--text-primary);">
                                        </div>
                                        <div style="grid-column:1/-1;">
                                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Notes</label>
                                            <textarea id="mf-new-notes" rows="2" placeholder="Notes internes..." style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary); resize:vertical;"></textarea>
                                        </div>
                                    </div>
                                    <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:20px;">
                                        <button class="btn btn-secondary" onclick="hideMFQuickClientForm()">Annuler</button>
                                        <button class="btn btn-primary" onclick="saveMFQuickClient()">üíæ Cr√©er et s√©lectionner</button>
                                    </div>
                                </div>

                                <!-- Bouton suivant -->
                                <div id="mf-step1-next" style="display:none; margin-top:24px; text-align:right;">
                                    <button class="btn btn-primary" onclick="goToMFStep(2)" style="padding:16px 32px; font-size:16px;">
                                        Continuer ‚Üí Lieu de retrait
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- √âTAPE 2: Lieu de retrait -->
                    <div id="mf-step-2" class="mf-step-content" style="display:none;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üìç Lieu de retrait</h3>
                                <button class="btn btn-secondary" onclick="goToMFStep(1)">‚Üê Retour client</button>
                            </div>
                            <div class="card-body">
                                <!-- R√©cap client -->
                                <div style="padding:12px 16px; background:var(--bg-primary); border-radius:10px; margin-bottom:24px; display:flex; align-items:center; gap:12px;">
                                    <span style="font-size:24px;">üë§</span>
                                    <div>
                                        <div id="mf-step2-client" style="font-weight:600;"></div>
                                        <div id="mf-step2-client-phone" style="font-size:12px; color:var(--text-muted);"></div>
                                    </div>
                                </div>

                                <!-- S√©lection magasin -->
                                <h4 style="margin-bottom:16px;">S√©lectionnez le point de retrait :</h4>
                                <div id="mf-stores-selection" class="grid-2" style="margin-bottom:24px;">
                                    <!-- G√©n√©r√© dynamiquement -->
                                </div>

                                <!-- Date et heure -->
                                <div id="mf-datetime-section" style="display:none; padding:16px; background:var(--bg-primary); border-radius:10px; margin-bottom:20px;">
                                    <h4 style="margin-bottom:12px; color:var(--accent-primary); font-size:14px;">üìÖ Date et cr√©neau de retrait</h4>

                                    <!-- Date -->
                                    <div style="margin-bottom:16px;">
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Date *</label>
                                        <input type="date" id="mf-pickup-date" onchange="updateMFTimeSlots()" style="width:100%; padding:12px; background:var(--bg-card); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary); font-size:14px;">
                                    </div>

                                    <!-- Info jour (normal/exceptionnel/ferm√©) -->
                                    <div id="mf-day-info" style="display:none; padding:10px; border-radius:8px; margin-bottom:12px; font-size:12px;"></div>

                                    <!-- Cr√©neaux horaires -->
                                    <div>
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:8px;">Cr√©neau horaire *</label>
                                        <div id="mf-time-slots" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:8px;">
                                            <!-- Cr√©neaux g√©n√©r√©s dynamiquement -->
                                        </div>
                                        <input type="hidden" id="mf-pickup-time" value="">
                                    </div>
                                </div>

                                <!-- Boutons navigation -->
                                <div style="display:flex; justify-content:space-between; margin-top:20px;">
                                    <button class="btn btn-secondary" onclick="goToMFStep(1)" style="padding:10px 16px; font-size:13px;">‚Üê Client</button>
                                    <button id="mf-step2-next" class="btn btn-primary" onclick="goToMFStep(3)" style="padding:12px 24px; font-size:14px; display:none;">
                                        Articles ‚Üí
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- √âTAPE 3: Articles - Nouveau Design -->
                    <div id="mf-step-3" class="mf-step-content" style="display:none;">
                        <div class="card">
                            <div class="card-header" style="padding:16px;">
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <button class="btn btn-secondary" onclick="goToMFStep(2)" style="padding:8px 14px;">‚Üê Lieu</button>
                                    <h3 class="card-title" style="margin:0;">üõí Commande</h3>
                                </div>
                                <button onclick="openMFArticlesModal()" class="btn btn-primary" style="padding:12px 24px; font-size:15px; display:flex; align-items:center; gap:8px;">
                                    <span style="font-size:20px;">üì¶</span> Ouvrir catalogue
                                </button>
                            </div>

                            <div class="card-body" style="padding:16px;">
                                <!-- Panier √©ditable -->
                                <div id="mf-cart-container">
                                    <div id="mf-cart-items-editable">
                                        <div style="text-align:center; padding:60px 20px; color:var(--text-muted);">
                                            <div style="font-size:64px; margin-bottom:16px; opacity:0.3;">üì¶</div>
                                            <div style="font-size:16px; margin-bottom:8px;">Aucun article dans le panier</div>
                                            <div style="font-size:13px;">Cliquez sur "Ouvrir catalogue" pour ajouter des produits</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Totaux avec TVA -->
                                <div id="mf-cart-totals" style="display:none; margin-top:20px; padding:16px; background:linear-gradient(135deg, var(--accent-primary)10, var(--accent-secondary)10); border-radius:12px; border:2px solid var(--accent-primary);">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px;">
                                        <span>Sous-total HT</span>
                                        <span id="mf-cart-subtotal" style="font-family:'Space Mono',monospace; font-weight:600;">0.00 CHF</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px; color:var(--text-muted);">
                                        <span>TVA (2.6%)</span>
                                        <span id="mf-cart-tva" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; font-size:22px; font-weight:700; color:var(--accent-primary); padding-top:12px; border-top:2px solid var(--accent-primary);">
                                        <span>TOTAL TTC</span>
                                        <span id="mf-cart-total" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                                    </div>
                                </div>

                                <!-- Navigation -->
                                <div style="display:flex; justify-content:space-between; margin-top:20px;">
                                    <button class="btn btn-secondary" onclick="goToMFStep(2)">‚Üê Lieu</button>
                                    <button id="mf-step3-next" class="btn btn-primary" onclick="goToMFStep(4)" style="padding:14px 28px; font-size:15px; display:none;">
                                        R√©capitulatif ‚Üí
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MODAL CATALOGUE ARTICLES PLEIN √âCRAN -->
                    <div id="mf-articles-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg-primary); z-index:3000; overflow:hidden;">
                        <div style="height:100%; display:flex; flex-direction:column;">
                            <!-- Header modal -->
                            <div style="padding:16px; background:var(--bg-card); border-bottom:2px solid var(--accent-primary); display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
                                <div style="display:flex; align-items:center; gap:16px;">
                                    <button onclick="closeMFArticlesModal()" style="padding:10px 16px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); font-size:14px; cursor:pointer;">
                                        ‚úï Fermer
                                    </button>
                                    <h2 style="margin:0; font-size:18px;">üì¶ Catalogue articles</h2>
                                </div>
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <span id="mf-selection-count" style="padding:8px 16px; background:var(--accent-primary)20; border:2px solid var(--accent-primary); border-radius:20px; font-weight:700; color:var(--accent-primary);">
                                        0 s√©lectionn√©(s)
                                    </span>
                                    <button onclick="validateMFSelection()" id="mf-validate-selection-btn" class="btn btn-primary" style="padding:12px 24px; font-size:15px; display:none;">
                                        ‚úì Valider la s√©lection
                                    </button>
                                </div>
                            </div>

                            <!-- Barre de recherche -->
                            <div style="padding:16px; background:var(--bg-card); border-bottom:1px solid var(--border-color); flex-shrink:0;">
                                <div style="display:flex; gap:12px; align-items:center; max-width:800px; margin:0 auto;">
                                    <div style="flex:1; position:relative;">
                                        <span style="position:absolute; left:16px; top:50%; transform:translateY(-50%); font-size:20px;">üîç</span>
                                        <input type="text" id="mf-modal-search" placeholder="Rechercher par code, nom, cat√©gorie..."
                                            style="width:100%; padding:14px 14px 14px 50px; font-size:16px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:12px; color:var(--text-primary);"
                                            oninput="filterMFModalArticles()">
                                    </div>
                                    <select id="mf-modal-category" onchange="filterMFModalArticles()" style="padding:14px 20px; font-size:14px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:12px; color:var(--text-primary);">
                                        <option value="">Toutes cat√©gories</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Liste articles tableau -->
                            <div style="flex:1; overflow-y:auto; padding:16px;">
                                <table style="width:100%; border-collapse:collapse;" id="mf-articles-table">
                                    <thead style="position:sticky; top:0; background:var(--bg-card); z-index:10;">
                                        <tr style="border-bottom:2px solid var(--accent-primary);">
                                            <th style="padding:12px 8px; text-align:left; font-size:12px; color:var(--text-muted); width:50px;">SEL</th>
                                            <th style="padding:12px 8px; text-align:left; font-size:12px; color:var(--text-muted); width:100px;">N¬∞ ARTICLE</th>
                                            <th style="padding:12px 8px; text-align:left; font-size:12px; color:var(--text-muted);">D√âSIGNATION</th>
                                            <th style="padding:12px 8px; text-align:left; font-size:12px; color:var(--text-muted); width:100px;">CAT√âGORIE</th>
                                            <th style="padding:12px 8px; text-align:right; font-size:12px; color:var(--text-muted); width:100px;">PRIX HT</th>
                                            <th style="padding:12px 8px; text-align:center; font-size:12px; color:var(--text-muted); width:80px;">UNIT√â</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mf-articles-tbody">
                                        <!-- G√©n√©r√© dynamiquement -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- √âTAPE 4: R√©capitulatif -->
                    <div id="mf-step-4" class="mf-step-content" style="display:none;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üìã R√©capitulatif de la commande</h3>
                                <button class="btn btn-secondary" onclick="goToMFStep(3)">‚Üê Retour articles</button>
                            </div>
                            <div class="card-body">
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:24px;">
                                    <!-- Infos client -->
                                    <div style="padding:20px; background:var(--bg-primary); border-radius:12px;">
                                        <h4 style="color:var(--accent-primary); margin-bottom:12px;">üë§ Client</h4>
                                        <div id="mf-recap-client"></div>
                                    </div>
                                    <!-- Infos retrait -->
                                    <div style="padding:20px; background:var(--bg-primary); border-radius:12px;">
                                        <h4 style="color:var(--accent-primary); margin-bottom:12px;">üìç Retrait</h4>
                                        <div id="mf-recap-pickup"></div>
                                    </div>
                                </div>

                                <!-- D√©tail articles -->
                                <div style="margin-bottom:24px;">
                                    <h4 style="margin-bottom:12px;">üõí Articles command√©s</h4>
                                    <div id="mf-recap-items" style="background:var(--bg-primary); border-radius:12px; overflow:hidden;"></div>
                                </div>

                                <!-- Totaux avec TVA -->
                                <div style="padding:20px; background:linear-gradient(135deg, rgba(6,214,160,0.1), rgba(17,138,178,0.1)); border-radius:12px; border:2px solid var(--accent-primary);">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                        <span>Sous-total HT</span>
                                        <span id="mf-recap-subtotal" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:var(--text-muted);">
                                        <span>TVA (2.6%)</span>
                                        <span id="mf-recap-tva" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; font-size:24px; font-weight:700; color:var(--accent-primary); padding-top:12px; border-top:2px solid var(--accent-primary);">
                                        <span>TOTAL TTC</span>
                                        <span id="mf-recap-total" style="font-family:'Space Mono',monospace;">0.00 CHF</span>
                                    </div>
                                </div>

                                <!-- Notes commande -->
                                <div style="margin-top:24px;">
                                    <label style="display:block; font-size:13px; color:var(--text-muted); margin-bottom:8px;">üìù Notes pour cette commande</label>
                                    <textarea id="mf-order-notes" rows="3" placeholder="Instructions sp√©ciales, remarques..." style="width:100%; padding:14px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:12px; color:var(--text-primary); resize:vertical;"></textarea>
                                </div>

                                <!-- Boutons navigation -->
                                <div style="display:flex; justify-content:space-between; margin-top:24px;">
                                    <button class="btn btn-secondary" onclick="goToMFStep(3)">‚Üê Articles</button>
                                    <button class="btn btn-primary" onclick="goToMFStep(5)" style="padding:16px 32px; font-size:16px;">
                                        Continuer ‚Üí Validation
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- √âTAPE 5: Validation -->
                    <div id="mf-step-5" class="mf-step-content" style="display:none;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‚úÖ Validation et envoi</h3>
                                <button class="btn btn-secondary" onclick="goToMFStep(4)">‚Üê Retour r√©cap</button>
                            </div>
                            <div class="card-body">
                                <!-- R√©sum√© final -->
                                <div style="padding:24px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius:16px; color:#000; margin-bottom:24px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
                                        <div>
                                            <div style="font-size:14px; opacity:0.8;">Commande pour</div>
                                            <div id="mf-final-client" style="font-size:24px; font-weight:700;"></div>
                                        </div>
                                        <div style="text-align:right;">
                                            <div style="font-size:14px; opacity:0.8;">Total TTC</div>
                                            <div id="mf-final-total" style="font-size:32px; font-weight:700; font-family:'Space Mono',monospace;"></div>
                                        </div>
                                    </div>
                                    <div style="margin-top:16px; padding-top:16px; border-top:2px solid rgba(0,0,0,0.2);">
                                        <span id="mf-final-pickup" style="font-size:14px;"></span>
                                    </div>
                                </div>

                                <!-- Options d'envoi -->
                                <div style="margin-bottom:24px;">
                                    <h4 style="margin-bottom:16px;">üìß Envoi de confirmation</h4>
                                    <div style="display:flex; flex-direction:column; gap:12px;">
                                        <label style="display:flex; align-items:center; gap:12px; padding:16px; background:var(--bg-primary); border-radius:12px; cursor:pointer; border:2px solid var(--border-color);">
                                            <input type="checkbox" id="mf-send-email" checked style="width:20px; height:20px;">
                                            <div>
                                                <div style="font-weight:600;">Envoyer par email au client</div>
                                                <div id="mf-email-to" style="font-size:13px; color:var(--text-muted);"></div>
                                            </div>
                                        </label>
                                        <label style="display:flex; align-items:center; gap:12px; padding:16px; background:var(--bg-primary); border-radius:12px; cursor:pointer; border:2px solid var(--border-color);">
                                            <input type="checkbox" id="mf-send-copy" checked style="width:20px; height:20px;">
                                            <div>
                                                <div style="font-weight:600;">Copie au magasin</div>
                                                <div id="mf-email-store" style="font-size:13px; color:var(--text-muted);"></div>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <!-- Boutons actions -->
                                <div style="display:flex; gap:16px; flex-wrap:wrap;">
                                    <button class="btn btn-secondary" onclick="goToMFStep(4)" style="flex:1; padding:16px;">
                                        ‚Üê Modifier
                                    </button>
                                    <button class="btn btn-secondary" onclick="printMFOrder()" style="flex:1; padding:16px;">
                                        üñ®Ô∏è Imprimer
                                    </button>
                                    <button class="btn btn-primary" onclick="validateMFOrder()" style="flex:2; padding:16px; font-size:18px;">
                                        ‚úÖ Valider la commande
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Gestion Clients -->
                <div id="mf-clients-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:16px; max-width:1200px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                            <h3>üë• Gestion des clients</h3>
                            <button onclick="closeMFClientsModal()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">&times;</button>
                        </div>
                        <!-- Stats clients -->
                        <div style="padding:16px; display:flex; gap:12px; flex-wrap:wrap; border-bottom:1px solid var(--border-color);">
                            <div id="mf-filter-all" style="flex:1; min-width:120px; padding:12px; background:var(--bg-primary); border-radius:10px; text-align:center; cursor:pointer; border:2px solid var(--accent-primary);" onclick="filterMFClientsType('')">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-primary);" id="mf-clients-total">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">TOUS</div>
                            </div>
                            <div id="mf-filter-b2b" style="flex:1; min-width:120px; padding:12px; background:rgba(17,138,178,0.15); border-radius:10px; text-align:center; cursor:pointer; border:2px solid transparent;" onclick="filterMFClientsType('b2b')">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-secondary);" id="mf-clients-b2b">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">B2B</div>
                            </div>
                            <div id="mf-filter-b2c" style="flex:1; min-width:120px; padding:12px; background:rgba(255,183,77,0.15); border-radius:10px; text-align:center; cursor:pointer; border:2px solid transparent;" onclick="filterMFClientsType('b2c')">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-warning);" id="mf-clients-b2c">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">B2C</div>
                            </div>
                        </div>
                        <div style="padding:16px; border-bottom:1px solid var(--border-color); display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                            <input type="text" id="mf-clients-filter" placeholder="üîç Rechercher nom, t√©l√©phone, ville..." oninput="filterMFClientsTable()" style="flex:1; min-width:200px; padding:10px 16px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            <select id="mf-clients-type-filter" onchange="filterMFClientsTable()" style="padding:10px 16px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                <option value="">Tous les types</option>
                                <option value="b2b">üè¢ B2B</option>
                                <option value="b2c">üè† B2C</option>
                            </select>
                            <button class="btn btn-primary" onclick="showMFClientForm()">‚ûï Nouveau client</button>
                        </div>
                        <div style="flex:1; overflow-y:auto; padding:16px;">
                            <table style="width:100%;">
                                <thead><tr><th>Type</th><th>Nom / Soci√©t√©</th><th>Contact</th><th>T√©l√©phone</th><th>Email</th><th>Ville</th><th>Actif</th><th>Actions</th></tr></thead>
                                <tbody id="mf-clients-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Modal Formulaire Client -->
                <div id="mf-client-form-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2100; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:16px; max-width:650px; width:100%; max-height:90vh; overflow-y:auto;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;">
                            <h3 id="mf-client-form-title">Client</h3>
                            <button onclick="closeMFClientForm()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">&times;</button>
                        </div>
                        <div style="padding:20px;">
                            <input type="hidden" id="mf-edit-client-id">

                            <!-- S√©lecteur Type B2B / B2C -->
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                                <div id="mf-edit-type-b2b" onclick="setMFEditClientType('b2b')" style="padding:16px; background:var(--bg-primary); border:3px solid var(--border-color); border-radius:12px; text-align:center; cursor:pointer; transition:all 0.2s;">
                                    <div style="font-size:28px; margin-bottom:4px;">üè¢</div>
                                    <div style="font-weight:700; color:var(--accent-secondary);">Professionnel</div>
                                    <div style="font-size:11px; color:var(--text-muted);">B2B</div>
                                </div>
                                <div id="mf-edit-type-b2c" onclick="setMFEditClientType('b2c')" style="padding:16px; background:rgba(255,183,77,0.15); border:3px solid var(--accent-warning); border-radius:12px; text-align:center; cursor:pointer; transition:all 0.2s;">
                                    <div style="font-size:28px; margin-bottom:4px;">üè†</div>
                                    <div style="font-weight:700; color:var(--accent-warning);">Particulier</div>
                                    <div style="font-size:11px; color:var(--text-muted);">B2C</div>
                                </div>
                            </div>
                            <input type="hidden" id="mf-edit-client-type" value="b2c">

                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                                <!-- Champs B2B (soci√©t√©) -->
                                <div id="mf-edit-field-company" style="display:none; grid-column:1/-1;">
                                    <label style="display:block; font-size:12px; color:var(--accent-secondary); margin-bottom:6px; font-weight:600;">üè¢ Nom de la soci√©t√© *</label>
                                    <input type="text" id="mf-edit-company" placeholder="Ex: Restaurant du Lac SA" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--accent-secondary); border-radius:8px; color:var(--text-primary);">
                                </div>

                                <!-- Champs B2C (nom/pr√©nom) ou Contact B2B -->
                                <div id="mf-edit-field-lastname">
                                    <label id="mf-edit-label-lastname" style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Nom *</label>
                                    <input type="text" id="mf-edit-lastname" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div id="mf-edit-field-firstname">
                                    <label id="mf-edit-label-firstname" style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Pr√©nom</label>
                                    <input type="text" id="mf-edit-firstname" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>

                                <div style="grid-column:1/-1;">
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Adresse</label>
                                    <input type="text" id="mf-edit-address" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">NPA</label>
                                    <input type="text" id="mf-edit-zip" maxlength="6" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Lieu *</label>
                                    <input type="text" id="mf-edit-city" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">T√©l. portable *</label>
                                    <input type="tel" id="mf-edit-mobile" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">T√©l. fixe</label>
                                    <input type="tel" id="mf-edit-phone" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div style="grid-column:1/-1;">
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Email</label>
                                    <input type="email" id="mf-edit-email" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div style="grid-column:1/-1;">
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">‚ö†Ô∏è Allergies</label>
                                    <input type="text" id="mf-edit-allergies" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--accent-danger)40; border-radius:8px; color:var(--text-primary);">
                                </div>
                                <div style="grid-column:1/-1;">
                                    <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px;">Notes</label>
                                    <textarea id="mf-edit-notes" rows="2" style="width:100%; padding:12px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:8px; color:var(--text-primary); resize:vertical;"></textarea>
                                </div>
                                <div style="grid-column:1/-1;">
                                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                        <input type="checkbox" id="mf-edit-active" checked style="width:20px; height:20px;">
                                        <span>Client actif</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div style="padding:16px 20px; border-top:1px solid var(--border-color); display:flex; justify-content:flex-end; gap:12px;">
                            <button class="btn btn-secondary" onclick="closeMFClientForm()">Annuler</button>
                            <button class="btn btn-primary" onclick="saveMFClient()">üíæ Enregistrer</button>
                        </div>
                    </div>
                </div>

                <!-- Modal Consultation Articles (depuis dashboard) -->
                <div id="mf-articles-view-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:16px; max-width:1200px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                            <h3>üì¶ Articles disponibles</h3>
                            <button onclick="closeMFArticlesViewModal()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">&times;</button>
                        </div>
                        <!-- Stats articles -->
                        <div style="padding:16px; display:flex; gap:12px; flex-wrap:wrap; border-bottom:1px solid var(--border-color);">
                            <div style="flex:1; min-width:120px; padding:12px; background:var(--bg-primary); border-radius:10px; text-align:center;">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-primary);" id="mf-view-articles-total">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">TOTAL</div>
                            </div>
                            <div style="flex:1; min-width:120px; padding:12px; background:rgba(6,214,160,0.15); border-radius:10px; text-align:center;">
                                <div style="font-size:24px; font-weight:700; color:var(--accent-primary);" id="mf-view-articles-active">0</div>
                                <div style="font-size:11px; color:var(--text-muted);">ACTIFS</div>
                            </div>
                        </div>
                        <div style="padding:16px; border-bottom:1px solid var(--border-color); display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                            <input type="text" id="mf-view-articles-filter" placeholder="üîç Rechercher code, nom, cat√©gorie..." oninput="filterMFViewArticlesTable()" style="flex:1; min-width:200px; padding:10px 16px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                            <select id="mf-view-articles-cat-filter" onchange="filterMFViewArticlesTable()" style="padding:10px 16px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary);">
                                <option value="">Toutes cat√©gories</option>
                            </select>
                            <a href="articles.html" class="btn btn-secondary" style="text-decoration:none;">‚öôÔ∏è G√©rer dans Outils</a>
                        </div>
                        <div style="flex:1; overflow-y:auto; padding:16px;">
                            <table style="width:100%;">
                                <thead><tr><th>Code</th><th>D√©signation</th><th>Cat√©gorie</th><th style="color:var(--accent-warning);">Prix B2C</th><th style="color:var(--accent-secondary);">Prix B2B</th><th>Unit√©</th><th>Actif</th></tr></thead>
                                <tbody id="mf-view-articles-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Modal S√©lection Rapide Client (Nouvelle Commande) -->
                <div id="mf-quick-select-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:16px; max-width:600px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                            <h3>‚ûï Nouvelle commande</h3>
                            <button onclick="closeMFQuickSelectModal()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">&times;</button>
                        </div>

                        <!-- S√©lecteur Type Client avec compteurs -->
                        <div style="padding:16px; border-bottom:1px solid var(--border-color);">
                            <div style="font-size:12px; color:var(--text-muted); margin-bottom:10px; text-transform:uppercase;">Type de client</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                <div id="mf-qs-type-b2c" onclick="setMFQuickSelectType('b2c')" style="padding:16px; background:rgba(255,183,77,0.15); border:3px solid var(--accent-warning); border-radius:12px; text-align:center; cursor:pointer; transition:all 0.2s;">
                                    <div style="font-size:28px; margin-bottom:4px;">üè†</div>
                                    <div style="font-weight:700; color:var(--accent-warning);">Particulier</div>
                                    <div style="font-size:20px; font-weight:700; color:var(--accent-warning); margin-top:4px;" id="mf-qs-count-b2c">0</div>
                                    <div style="font-size:10px; color:var(--text-muted);">clients actifs</div>
                                </div>
                                <div id="mf-qs-type-b2b" onclick="setMFQuickSelectType('b2b')" style="padding:16px; background:var(--bg-primary); border:3px solid var(--border-color); border-radius:12px; text-align:center; cursor:pointer; transition:all 0.2s;">
                                    <div style="font-size:28px; margin-bottom:4px;">üè¢</div>
                                    <div style="font-weight:700; color:var(--accent-secondary);">Professionnel</div>
                                    <div style="font-size:20px; font-weight:700; color:var(--accent-secondary); margin-top:4px;" id="mf-qs-count-b2b">0</div>
                                    <div style="font-size:10px; color:var(--text-muted);">clients actifs</div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Clients -->
                        <div style="padding:16px; flex:1; overflow-y:auto;">
                            <div style="font-size:12px; color:var(--text-muted); margin-bottom:10px; text-transform:uppercase;">‚≠ê Clients fr√©quents</div>
                            <div id="mf-qs-top-clients" style="display:flex; flex-direction:column; gap:8px;">
                                <!-- G√©n√©r√© dynamiquement -->
                            </div>
                        </div>

                        <!-- Actions -->
                        <div style="padding:16px; border-top:1px solid var(--border-color); display:flex; gap:12px;">
                            <button onclick="mfQuickSelectNewClient()" class="btn btn-secondary" style="flex:1;">
                                ‚ûï Nouveau client
                            </button>
                            <button onclick="mfQuickSelectSearchClient()" class="btn btn-primary" style="flex:1;">
                                üîç Rechercher
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal Gestion Magasins -->
                <div id="mf-stores-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:16px; max-width:800px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                            <h3>üè™ Gestion des magasins</h3>
                            <button onclick="closeMFStoresModal()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">&times;</button>
                        </div>
                        <div style="padding:16px; border-bottom:1px solid var(--border-color);">
                            <button class="btn btn-primary" onclick="showMFStoreForm()">‚ûï Nouveau magasin</button>
                        </div>
                        <div style="flex:1; overflow-y:auto; padding:16px;">
                            <table style="width:100%;">
                                <thead><tr><th>Nom</th><th>Adresse</th><th>Email</th><th>T√©l√©phone</th><th>Actions</th></tr></thead>
                                <tbody id="mf-stores-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Modal Formulaire Magasin COMPLET avec horaires -->
                <div id="mf-store-form-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2100; align-items:center; justify-content:center; padding:12px; overflow-y:auto;">
                    <div style="background:var(--bg-card); border-radius:12px; max-width:700px; width:100%; max-height:95vh; overflow-y:auto; margin:auto;">
                        <div style="padding:16px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; position:sticky; top:0; background:var(--bg-card); z-index:10;">
                            <h3 id="mf-store-form-title" style="font-size:16px;">üè™ Magasin</h3>
                            <button onclick="closeMFStoreForm()" style="background:none; border:none; color:var(--text-muted); font-size:24px; cursor:pointer;">&times;</button>
                        </div>
                        <div style="padding:16px;">
                            <input type="hidden" id="mf-edit-store-id">

                            <!-- Infos g√©n√©rales -->
                            <div style="background:var(--bg-primary); border-radius:10px; padding:14px; margin-bottom:16px;">
                                <h4 style="font-size:13px; color:var(--accent-primary); margin-bottom:12px;">üìã Informations g√©n√©rales</h4>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                    <div style="grid-column:1/-1;">
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Nom du magasin *</label>
                                        <input type="text" id="mf-edit-store-name" placeholder="Borex Lausanne" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:14px;">
                                    </div>
                                    <div style="grid-column:1/-1;">
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Adresse</label>
                                        <input type="text" id="mf-edit-store-address" placeholder="Rue du Lac 15, 1000 Lausanne" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:14px;">
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">Email entreprise *</label>
                                        <input type="email" id="mf-edit-store-email" placeholder="lausanne@borex-poissons.ch" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:14px;">
                                    </div>
                                    <div>
                                        <label style="display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px;">T√©l√©phone</label>
                                        <input type="tel" id="mf-edit-store-phone" placeholder="+41 21 xxx xx xx" style="width:100%; padding:10px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:14px;">
                                    </div>
                                </div>
                            </div>

                            <!-- Horaires d'ouverture -->
                            <div style="background:var(--bg-primary); border-radius:10px; padding:14px; margin-bottom:16px;">
                                <h4 style="font-size:13px; color:var(--accent-secondary); margin-bottom:12px;">üïê Horaires d'ouverture</h4>
                                <div id="mf-store-hours" style="display:grid; gap:8px;">
                                    <!-- Lundi -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Lundi</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-mon-open" checked onchange="toggleMFDayHours('mon')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-mon-times" style="display:flex; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-mon-start" value="08:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">√†</span>
                                            <input type="time" id="mf-hour-mon-end" value="18:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                    </div>
                                    <!-- Mardi -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Mardi</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-tue-open" checked onchange="toggleMFDayHours('tue')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-tue-times" style="display:flex; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-tue-start" value="08:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">√†</span>
                                            <input type="time" id="mf-hour-tue-end" value="18:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                    </div>
                                    <!-- Mercredi -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Mercredi</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-wed-open" checked onchange="toggleMFDayHours('wed')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-wed-times" style="display:flex; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-wed-start" value="08:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">√†</span>
                                            <input type="time" id="mf-hour-wed-end" value="18:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                    </div>
                                    <!-- Jeudi -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Jeudi</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-thu-open" checked onchange="toggleMFDayHours('thu')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-thu-times" style="display:flex; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-thu-start" value="08:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">√†</span>
                                            <input type="time" id="mf-hour-thu-end" value="18:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                    </div>
                                    <!-- Vendredi -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Vendredi</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-fri-open" checked onchange="toggleMFDayHours('fri')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-fri-times" style="display:flex; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-fri-start" value="08:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">√†</span>
                                            <input type="time" id="mf-hour-fri-end" value="18:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                    </div>
                                    <!-- Samedi -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Samedi</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-sat-open" checked onchange="toggleMFDayHours('sat')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-sat-times" style="display:flex; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-sat-start" value="08:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">√†</span>
                                            <input type="time" id="mf-hour-sat-end" value="12:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                    </div>
                                    <!-- Dimanche -->
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <label style="width:70px; font-size:12px; font-weight:600;">Dimanche</label>
                                        <label style="display:flex; align-items:center; gap:4px; font-size:12px;">
                                            <input type="checkbox" id="mf-hour-sun-open" onchange="toggleMFDayHours('sun')">
                                            <span>Ouvert</span>
                                        </label>
                                        <div id="mf-hour-sun-times" style="display:none; align-items:center; gap:4px;">
                                            <input type="time" id="mf-hour-sun-start" value="09:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                            <span style="color:var(--text-muted);">√†</span>
                                            <input type="time" id="mf-hour-sun-end" value="12:00" style="padding:6px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                                        </div>
                                        <span id="mf-hour-sun-closed" style="color:var(--accent-danger); font-size:11px;">Ferm√©</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Cr√©neaux de retrait -->
                            <div style="background:var(--bg-primary); border-radius:10px; padding:14px; margin-bottom:16px;">
                                <h4 style="font-size:13px; color:var(--accent-primary); margin-bottom:12px;">‚è∞ Cr√©neaux de retrait commandes</h4>
                                <p style="font-size:11px; color:var(--text-muted); margin-bottom:12px;">D√©finir la dur√©e des cr√©neaux horaires propos√©s aux clients</p>
                                <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                                    <label style="font-size:12px;">Dur√©e d'un cr√©neau :</label>
                                    <select id="mf-edit-store-slot" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:13px;">
                                        <option value="30">30 minutes</option>
                                        <option value="60" selected>1 heure</option>
                                        <option value="120">2 heures</option>
                                    </select>
                                    <span style="font-size:11px; color:var(--text-muted);">Ex: 9h-10h, 10h-11h...</span>
                                </div>
                            </div>

                            <!-- Jours exceptionnels -->
                            <div style="background:var(--bg-primary); border-radius:10px; padding:14px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                    <h4 style="font-size:13px; color:var(--accent-danger);">üéÑ Jours exceptionnels</h4>
                                    <button type="button" onclick="addMFExceptionalDay()" class="btn btn-secondary" style="padding:6px 12px; font-size:11px;">‚ûï Ajouter</button>
                                </div>
                                <p style="font-size:11px; color:var(--text-muted); margin-bottom:12px;">Fermetures ou horaires sp√©ciaux (No√´l, vacances, jours f√©ri√©s...)</p>
                                <div id="mf-exceptional-days" style="display:grid; gap:8px;">
                                    <!-- Jours exceptionnels g√©n√©r√©s dynamiquement -->
                                </div>
                                <div id="mf-no-exceptional" style="text-align:center; padding:12px; color:var(--text-muted); font-size:12px;">
                                    Aucun jour exceptionnel d√©fini
                                </div>
                            </div>
                        </div>
                        <div style="padding:12px 16px; border-top:1px solid var(--border-color); display:flex; justify-content:flex-end; gap:10px; position:sticky; bottom:0; background:var(--bg-card);">
                            <button class="btn btn-secondary" onclick="closeMFStoreForm()" style="padding:10px 16px; font-size:13px;">Annuler</button>
                            <button class="btn btn-primary" onclick="saveMFStore()" style="padding:10px 16px; font-size:13px;">üíæ Enregistrer</button>
                        </div>
                    </div>
                </div>

                <!-- Modal D√©tail Commande -->
                <div id="mf-order-detail-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:var(--bg-card); border-radius:16px; max-width:800px; width:100%; max-height:90vh; overflow-y:auto;">
                        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;">
                            <h3>Commande <span id="mf-detail-order-id"></span></h3>
                            <button onclick="closeMFOrderDetail()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">&times;</button>
                        </div>
                        <div id="mf-order-detail-content" style="padding:20px;"></div>
                        <div id="mf-order-detail-actions" style="padding:16px 20px; border-top:1px solid var(--border-color); display:flex; justify-content:flex-end; gap:12px;"></div>
                    </div>
                </div>
</div>

    <!-- Toast container -->
    <div class="toast-container" id="toast-container"></div>
    
    <script>
        // ===== DONN√âES PARTAG√âES =====
        // Charger les donn√©es depuis localStorage partag√©
        let QOData = {
            clients: [],
            products: [],
            orders: []
        };
        
        let ArticlesData = {
            articles: [],
            categories: [
                { id: 1, code: 'POISSON', name: 'Poissons frais', icon: 'üêü' },
                { id: 2, code: 'CRUSTACE', name: 'Crustac√©s', icon: 'ü¶ê' },
                { id: 3, code: 'COQUILLAGE', name: 'Coquillages', icon: 'ü¶™' },
                { id: 4, code: 'FUME', name: 'Produits fum√©s', icon: 'üî•' },
                { id: 5, code: 'CONSERVE', name: 'Conserves', icon: 'ü•´' },
                { id: 6, code: 'PREPA', name: 'Pr√©parations', icon: 'üçΩÔ∏è' },
                { id: 7, code: 'SURGELE', name: 'Surgel√©s', icon: '‚ùÑÔ∏è' },
                { id: 8, code: 'EPICERIE', name: '√âpicerie', icon: 'üõí' }
            ],
            pricelists: []
        };
        
        // Fonction navigateTo pour compatibilit√©
        function navigateTo(page) {
            if (page === 'dashboard') {
                window.location.href = 'index.html';
            }
        }
        
        // Charger les donn√©es au d√©marrage
        function loadSharedData() {
            // QOData (clients, products, orders)
            const qoData = localStorage.getItem('trakio_quickorder');
            if (qoData) {
                const parsed = JSON.parse(qoData);
                QOData.clients = parsed.clients || [];
                QOData.products = parsed.products || [];
                QOData.orders = parsed.orders || [];
            }
            
            // ArticlesData
            const artData = localStorage.getItem('trakio_articles');
            if (artData) {
                const parsed = JSON.parse(artData);
                ArticlesData = { ...ArticlesData, ...parsed };
            }
        }
        
        // Sauvegarder les clients dans QOData
        function saveQOData(type) {
            const data = {
                clients: QOData.clients,
                products: QOData.products,
                orders: QOData.orders
            };
            localStorage.setItem('trakio_quickorder', JSON.stringify(data));
        }

        const MFData = {
            clients: JSON.parse(localStorage.getItem('mf_clients') || '[]'),
            stores: JSON.parse(localStorage.getItem('mf_stores') || '[]'),
            orders: JSON.parse(localStorage.getItem('mf_orders') || '[]'),
            currentOrder: {
                client: null,
                store: null,
                pickupDate: '',
                pickupTime: '',
                cart: [],
                notes: ''
            },
            currentStep: 1,
            clientType: 'B2C' // 'B2C' ou 'B2B'
        };

        // Fonction pour basculer entre B2B et B2C
        function setMFClientType(type) {
            MFData.clientType = type;

            // Mettre √† jour l'UI des boutons
            const b2cBtn = document.getElementById('mf-type-b2c');
            const b2bBtn = document.getElementById('mf-type-b2b');

            if (type === 'B2C') {
                b2cBtn.style.border = '3px solid var(--accent-primary)';
                b2cBtn.style.background = 'rgba(6,214,160,0.15)';
                b2bBtn.style.border = '3px solid var(--border-color)';
                b2bBtn.style.background = 'var(--bg-primary)';
            } else {
                b2bBtn.style.border = '3px solid var(--accent-secondary)';
                b2bBtn.style.background = 'rgba(17,138,178,0.15)';
                b2cBtn.style.border = '3px solid var(--border-color)';
                b2cBtn.style.background = 'var(--bg-primary)';
            }

            // Mettre √† jour le formulaire
            const b2bFields = document.getElementById('mf-b2b-fields');
            const b2cFields = document.getElementById('mf-b2c-fields');
            const formTitle = document.getElementById('mf-form-title');

            if (type === 'B2B') {
                b2bFields.style.display = 'block';
                b2cFields.style.display = 'none';
                formTitle.innerHTML = '<span>‚ûï</span> Nouveau client professionnel';
            } else {
                b2bFields.style.display = 'none';
                b2cFields.style.display = 'grid';
                formTitle.innerHTML = '<span>‚ûï</span> Nouveau client particulier';
            }

            // R√©initialiser la recherche
            document.getElementById('mf-client-search').value = '';
            document.getElementById('mf-client-results').style.display = 'none';
            clearMFClient();
        }

        // Obtenir tous les clients selon le type s√©lectionn√© (base unifi√©e QOData)
        function getMFClients() {
            const allClients = QOData?.clients || [];

            if (MFData.clientType === 'B2B') {
                // Filtrer les clients B2B
                return allClients.filter(c => (c.clientType || 'b2b').toUpperCase() === 'B2B').map(c => ({
                    ...c,
                    clientType: 'B2B',
                    // Normaliser les champs
                    lastname: c.name || c.lastname || '',
                    firstname: c.contact || c.firstname || '',
                    city: c.city || '',
                    mobile: c.mobile || '',
                    phone: c.phone || '',
                    email: c.email || '',
                    address: c.address || '',
                    zip: c.zip || '',
                    allergies: c.allergies || '',
                    notes: c.notes || '',
                    active: c.active !== false
                }));
            } else {
                // Filtrer les clients B2C
                return allClients.filter(c => (c.clientType || 'b2b').toUpperCase() === 'B2C').map(c => ({
                    ...c,
                    clientType: 'B2C'
                }));
            }
        }

        // Initialisation des donn√©es exemples
        function initMFSampleData() {
            // Horaires par d√©faut
            const defaultHours = {
                mon: { open: true, start: '08:00', end: '18:00' },
                tue: { open: true, start: '08:00', end: '18:00' },
                wed: { open: true, start: '08:00', end: '18:00' },
                thu: { open: true, start: '08:00', end: '18:00' },
                fri: { open: true, start: '08:00', end: '18:00' },
                sat: { open: true, start: '08:00', end: '12:00' },
                sun: { open: false, start: '09:00', end: '12:00' }
            };

            if (MFData.stores.length === 0) {
                MFData.stores = [
                    {
                        id: 1,
                        name: 'Borex Lausanne',
                        address: 'Rue du Lac 15, 1000 Lausanne',
                        email: 'lausanne@borex-poissons.ch',
                        phone: '+41 21 312 45 67',
                        slotDuration: 60,
                        hours: defaultHours,
                        exceptionalDays: [
                            { date: '2024-12-24', label: 'Veille de No√´l', closed: false, start: '08:00', end: '14:00' },
                            { date: '2024-12-25', label: 'No√´l', closed: true },
                            { date: '2024-12-31', label: 'Saint-Sylvestre', closed: false, start: '08:00', end: '16:00' },
                            { date: '2025-01-01', label: 'Nouvel An', closed: true }
                        ]
                    },
                    {
                        id: 2,
                        name: 'Borex Nyon',
                        address: 'Grand-Rue 22, 1260 Nyon',
                        email: 'nyon@borex-poissons.ch',
                        phone: '+41 22 361 89 00',
                        slotDuration: 60,
                        hours: defaultHours,
                        exceptionalDays: []
                    },
                    {
                        id: 3,
                        name: 'Borex Gen√®ve',
                        address: 'Rue du Rh√¥ne 8, 1204 Gen√®ve',
                        email: 'geneve@borex-poissons.ch',
                        phone: '+41 22 310 12 34',
                        slotDuration: 60,
                        hours: defaultHours,
                        exceptionalDays: []
                    }
                ];
                saveMFData('stores');
            }

            // ========== MIGRATION CLIENTS B2C VERS BASE UNIFI√âE ==========
            // Migrer les anciens clients MFData vers QOData.clients
            if (MFData.clients && MFData.clients.length > 0) {
                console.log('üîÑ Migration clients B2C vers base unifi√©e...');
                let migrated = 0;
                MFData.clients.forEach(mfClient => {
                    // V√©rifier si ce client n'existe pas d√©j√† dans QOData
                    const exists = QOData.clients.some(c =>
                        c.id === mfClient.id ||
                        (c.mobile === mfClient.mobile && c.lastname === mfClient.lastname)
                    );
                    if (!exists) {
                        QOData.clients.push({
                            ...mfClient,
                            clientType: 'B2C'
                        });
                        migrated++;
                    }
                });
                if (migrated > 0) {
                    localStorage.setItem('qo_clients', JSON.stringify(QOData.clients));
                    console.log(`‚úÖ ${migrated} clients B2C migr√©s vers QOData.clients`);
                }
                // Vider l'ancienne base pour √©viter les doublons futurs
                MFData.clients = [];
                localStorage.removeItem('mf_clients');
            }

            // Ajouter des clients B2C exemples si aucun n'existe
            const b2cClients = QOData.clients.filter(c => (c.clientType || 'b2b').toUpperCase() === 'B2C');
            if (b2cClients.length === 0) {
                const sampleB2C = [
                    { id: Date.now(), lastname: 'Dupont', firstname: 'Jean', address: 'Rue de la Gare 5', zip: '1000', city: 'Lausanne', mobile: '+41 79 123 45 67', phone: '+41 21 312 00 00', email: 'jean.dupont@email.ch', allergies: '', notes: '', active: true, clientType: 'B2C' },
                    { id: Date.now() + 1, lastname: 'Martin', firstname: 'Sophie', address: 'Avenue du L√©man 12', zip: '1260', city: 'Nyon', mobile: '+41 78 987 65 43', phone: '', email: 'sophie.martin@bluewin.ch', allergies: 'Crustac√©s', notes: 'Cliente fid√®le', active: true, clientType: 'B2C' }
                ];
                QOData.clients.push(...sampleB2C);
                localStorage.setItem('qo_clients', JSON.stringify(QOData.clients));
            }
        }

        function saveMFData(type) {
            localStorage.setItem('mf_' + type, JSON.stringify(MFData[type]));
        }

        // ========== DASHBOARD ==========
        function initMFDashboard() {
            initMFSampleData();
            updateMFStats();
            renderMFStoresTiles();
            renderMFOrders();
            populateMFFilters();
        }

        function updateMFStats() {
            const today = new Date().toISOString().split('T')[0];
            const orders = MFData.orders;

            document.getElementById('mf-stat-total').textContent = orders.length;
            document.getElementById('mf-stat-pending').textContent = orders.filter(o => o.status === 'pending').length;
            document.getElementById('mf-stat-confirmed').textContent = orders.filter(o => o.status === 'confirmed').length;
            document.getElementById('mf-stat-ready').textContent = orders.filter(o => o.status === 'ready').length;
        }

        function renderMFStoresTiles() {
            const container = document.getElementById('mf-stores-dashboard');
            if (!container) return;

            // Calculer les stats par magasin
            const storesWithStats = MFData.stores.map(store => {
                const storeOrders = MFData.orders.filter(o => o.storeId === store.id);
                return {
                    ...store,
                    total: storeOrders.length,
                    pending: storeOrders.filter(o => o.status === 'pending').length,
                    confirmed: storeOrders.filter(o => o.status === 'confirmed').length,
                    ready: storeOrders.filter(o => o.status === 'ready').length
                };
            });

            // Trier par nombre de commandes en attente (plus urgentes en premier)
            storesWithStats.sort((a, b) => b.pending - a.pending);

            container.innerHTML = `
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:12px;">
                    ${storesWithStats.map(store => {
                        const hasUrgent = store.pending > 0;
                        const urgentColor = hasUrgent ? '#f4a261' : 'var(--border-color)';

                        return `
                            <div onclick="filterMFOrdersByStore(${store.id})"
                                style="cursor:pointer; background:var(--bg-card); border-radius:16px; overflow:hidden;
                                       border:3px solid ${urgentColor}; transition:all 0.2s;
                                       ${hasUrgent ? 'box-shadow:0 0 20px ' + urgentColor + '40;' : ''}"
                                onmouseover="this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.transform='translateY(0)'">

                                <!-- Header du magasin -->
                                <div style="padding:16px; background:linear-gradient(135deg, var(--bg-primary), var(--bg-card)); border-bottom:1px solid var(--border-color);">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div style="display:flex; align-items:center; gap:12px;">
                                            <div style="width:44px; height:44px; background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px;">
                                                üè™
                                            </div>
                                            <div>
                                                <div style="font-weight:700; font-size:16px;">${store.name}</div>
                                                <div style="font-size:11px; color:var(--text-muted);">${store.total} commande${store.total > 1 ? 's' : ''}</div>
                                            </div>
                                        </div>
                                        ${hasUrgent ? `
                                            <div style="background:#f4a261; color:#000; padding:6px 12px; border-radius:20px; font-weight:700; font-size:12px; animation:pulse 2s infinite;">
                                                ${store.pending} en attente
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>

                                <!-- Stats du magasin -->
                                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:0;">
                                    <!-- En attente -->
                                    <div style="padding:14px 8px; text-align:center; background:${store.pending > 0 ? '#f4a26115' : 'transparent'}; border-right:1px solid var(--border-color);">
                                        <div style="font-size:28px; font-weight:800; color:${store.pending > 0 ? '#f4a261' : 'var(--text-muted)'};">
                                            ${store.pending}
                                        </div>
                                        <div style="font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Attente</div>
                                    </div>
                                    <!-- Confirm√©es -->
                                    <div style="padding:14px 8px; text-align:center; background:${store.confirmed > 0 ? '#118ab215' : 'transparent'}; border-right:1px solid var(--border-color);">
                                        <div style="font-size:28px; font-weight:800; color:${store.confirmed > 0 ? '#118ab2' : 'var(--text-muted)'};">
                                            ${store.confirmed}
                                        </div>
                                        <div style="font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Confirm.</div>
                                    </div>
                                    <!-- Pr√™tes -->
                                    <div style="padding:14px 8px; text-align:center; background:${store.ready > 0 ? '#06d6a015' : 'transparent'};">
                                        <div style="font-size:28px; font-weight:800; color:${store.ready > 0 ? '#06d6a0' : 'var(--text-muted)'};">
                                            ${store.ready}
                                        </div>
                                        <div style="font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Pr√™tes</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function populateMFFilters() {
            const storeSelect = document.getElementById('mf-filter-store');
            if (storeSelect) {
                storeSelect.innerHTML = '<option value="">Tous les magasins</option>' +
                    MFData.stores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            }
        }

        function renderMFOrders() {
            const tbody = document.getElementById('mf-orders-tbody');
            if (!tbody) return;

            const filterStore = document.getElementById('mf-filter-store')?.value || '';
            const filterStatus = document.getElementById('mf-filter-status')?.value || '';
            const filterDate = document.getElementById('mf-filter-date')?.value || '';

            let orders = [...MFData.orders].reverse();

            if (filterStore) orders = orders.filter(o => o.storeId == filterStore);
            if (filterStatus) orders = orders.filter(o => o.status === filterStatus);
            if (filterDate) orders = orders.filter(o => o.pickupDate === filterDate);

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">Aucune commande</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => {
                // Base unifi√©e QOData.clients
                let client = (QOData?.clients || []).find(c => c.id === order.clientId);

                const store = MFData.stores.find(s => s.id === order.storeId);
                const statusLabels = {
                    pending: '<span style="padding:4px 10px; background:#ffd16620; color:#ffd166; border-radius:12px; font-size:12px;">‚è≥ En attente</span>',
                    confirmed: '<span style="padding:4px 10px; background:#06d6a020; color:#06d6a0; border-radius:12px; font-size:12px;">‚úÖ Confirm√©e</span>',
                    ready: '<span style="padding:4px 10px; background:#118ab220; color:#118ab2; border-radius:12px; font-size:12px;">üéâ Pr√™te</span>',
                    delivered: '<span style="padding:4px 10px; background:#9e9e9e20; color:#9e9e9e; border-radius:12px; font-size:12px;">ü§ù Remise</span>'
                };

                // Afficher le nom selon le type
                let clientName = 'Inconnu';
                let typeBadge = '';
                if (client) {
                    if (client.name) {
                        // Client B2B
                        clientName = client.name;
                        typeBadge = '<span style="font-size:10px; background:var(--accent-secondary)20; color:var(--accent-secondary); padding:2px 6px; border-radius:4px; margin-left:6px;">B2B</span>';
                    } else {
                        // Client B2C
                        clientName = client.lastname + ' ' + (client.firstname || '');
                        typeBadge = '<span style="font-size:10px; background:var(--accent-primary)20; color:var(--accent-primary); padding:2px 6px; border-radius:4px; margin-left:6px;">B2C</span>';
                    }
                }

                return `
                    <tr>
                        <td style="font-weight:600;">#${order.id}</td>
                        <td>${clientName}${typeBadge}</td>
                        <td>${store ? store.name : '-'}</td>
                        <td>${formatDate(order.pickupDate)}</td>
                        <td>${order.pickupTime}</td>
                        <td style="font-family:'Space Mono',monospace; font-weight:600;">${order.total.toFixed(2)} CHF</td>
                        <td>${statusLabels[order.status] || order.status}</td>
                        <td>
                            <button onclick="showMFOrderDetail(${order.id})" style="padding:6px 12px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); cursor:pointer; margin-right:4px;">üëÅÔ∏è</button>
                            <button onclick="printMFOrderById(${order.id})" style="padding:6px 12px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); cursor:pointer;">üñ®Ô∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterMFOrdersByStore(storeId) {
            document.getElementById('mf-filter-store').value = storeId;
            renderMFOrders();
        }

        function filterMFOrdersByStatus(status) {
            document.getElementById('mf-filter-status').value = status;
            renderMFOrders();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-CH');
        }

        // ========== NOUVELLE COMMANDE - WORKFLOW 5 √âTAPES ==========
        function startMFNewOrder() {
            // Reset current order
            MFData.currentOrder = {
                client: null,
                store: null,
                pickupDate: '',
                pickupTime: '',
                cart: [],
                notes: ''
            };
            MFData.currentStep = 1;
            MFData.clientType = 'B2C'; // Par d√©faut, client particulier

            // Afficher le modal de s√©lection rapide
            showMFQuickSelectModal();
        }

        // ========== MODAL S√âLECTION RAPIDE CLIENT ==========
        function showMFQuickSelectModal() {
            // Compter les clients actifs par type
            const allClients = QOData?.clients || [];
            const b2cActive = allClients.filter(c => (c.clientType || 'b2b').toLowerCase() === 'b2c' && c.active !== false).length;
            const b2bActive = allClients.filter(c => (c.clientType || 'b2b').toLowerCase() === 'b2b' && c.active !== false).length;

            document.getElementById('mf-qs-count-b2c').textContent = b2cActive;
            document.getElementById('mf-qs-count-b2b').textContent = b2bActive;

            // Par d√©faut B2C
            setMFQuickSelectType('b2c');

            document.getElementById('mf-quick-select-modal').style.display = 'flex';
        }

        function closeMFQuickSelectModal() {
            document.getElementById('mf-quick-select-modal').style.display = 'none';
        }

        function setMFQuickSelectType(type) {
            MFData.clientType = type.toUpperCase();

            const b2cBtn = document.getElementById('mf-qs-type-b2c');
            const b2bBtn = document.getElementById('mf-qs-type-b2b');

            if (type === 'b2c') {
                b2cBtn.style.border = '3px solid var(--accent-warning)';
                b2cBtn.style.background = 'rgba(255,183,77,0.15)';
                b2bBtn.style.border = '3px solid var(--border-color)';
                b2bBtn.style.background = 'var(--bg-primary)';
            } else {
                b2bBtn.style.border = '3px solid var(--accent-secondary)';
                b2bBtn.style.background = 'rgba(17,138,178,0.15)';
                b2cBtn.style.border = '3px solid var(--border-color)';
                b2cBtn.style.background = 'var(--bg-primary)';
            }

            // Afficher les top clients du type s√©lectionn√©
            renderMFTopClients(type);
        }

        function renderMFTopClients(type) {
            const container = document.getElementById('mf-qs-top-clients');
            const allClients = QOData?.clients || [];

            // Filtrer par type et actifs
            let clients = allClients.filter(c =>
                (c.clientType || 'b2b').toLowerCase() === type &&
                c.active !== false
            );

            // Trier par nombre de commandes (ordersCount) puis par date de cr√©ation (id plus r√©cent)
            clients.sort((a, b) => {
                const countA = a.ordersCount || 0;
                const countB = b.ordersCount || 0;
                if (countB !== countA) return countB - countA;
                return (b.id || 0) - (a.id || 0);
            });

            // Prendre les 10 premiers
            const topClients = clients.slice(0, 10);

            if (topClients.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:30px; color:var(--text-muted);">
                        <div style="font-size:40px; margin-bottom:10px;">üì≠</div>
                        <div>Aucun client ${type === 'b2c' ? 'particulier' : 'professionnel'} actif</div>
                        <div style="font-size:12px; margin-top:8px;">Cr√©ez un nouveau client pour commencer</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = topClients.map(c => {
                const isB2B = type === 'b2b';
                const displayName = isB2B ? (c.name || c.lastname || '-') : `${c.lastname || ''} ${c.firstname || ''}`.trim();
                const displayCity = c.city || '';
                const ordersCount = c.ordersCount || 0;

                return `
                    <div onclick="mfQuickSelectClient(${c.id})" style="padding:14px 16px; background:var(--bg-primary); border:2px solid var(--border-color); border-radius:10px; cursor:pointer; display:flex; align-items:center; gap:12px; transition:all 0.2s;" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                        <div style="width:40px; height:40px; background:${isB2B ? 'rgba(17,138,178,0.2)' : 'rgba(255,183,77,0.2)'}; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px;">
                            ${isB2B ? 'üè¢' : 'üë§'}
                        </div>
                        <div style="flex:1; min-width:0;">
                            <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${displayName}</div>
                            <div style="font-size:12px; color:var(--text-muted);">${displayCity}</div>
                        </div>
                        ${ordersCount > 0 ? `<div style="padding:4px 10px; background:var(--bg-hover); border-radius:12px; font-size:11px; color:var(--text-muted);">${ordersCount} cmd</div>` : ''}
                        <div style="color:var(--accent-primary); font-size:18px;">‚Üí</div>
                    </div>
                `;
            }).join('');
        }

        function mfQuickSelectClient(clientId) {
            const client = (QOData?.clients || []).find(c => c.id === clientId);
            if (!client) return;

            // Fermer le modal
            closeMFQuickSelectModal();

            // Afficher la vue nouvelle commande directement √† l'√©tape 2 (lieu de retrait)
            document.getElementById('mf-view-dashboard').style.display = 'none';
            document.getElementById('mf-view-neworder').style.display = 'block';

            // Mettre le type du client (AVANT de d√©finir le client car setMFClientType appelle clearMFClient)
            const clientType = (client.clientType || 'b2b').toUpperCase();
            setMFClientType(clientType);

            // IMPORTANT: Configurer la commande avec ce client APR√àS setMFClientType
            MFData.currentOrder.client = client;

            const isB2B = clientType === 'B2B';
            const displayName = isB2B ? (client.name || client.lastname) : `${client.lastname || ''} ${client.firstname || ''}`.trim();

            const selectedDiv = document.getElementById('mf-selected-client');
            selectedDiv.innerHTML = `
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:50px; height:50px; background:${isB2B ? 'rgba(17,138,178,0.2)' : 'rgba(255,183,77,0.2)'}; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;">
                        ${isB2B ? 'üè¢' : 'üë§'}
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:700; font-size:16px;">${displayName}</div>
                        <div style="font-size:13px; color:var(--text-muted);">üìç ${client.city || '-'} ‚Ä¢ üìû ${client.mobile || client.phone || '-'}</div>
                        ${client.allergies ? `<div style="font-size:12px; color:var(--accent-danger); margin-top:4px;">‚ö†Ô∏è ${client.allergies}</div>` : ''}
                    </div>
                    <button onclick="clearMFClient()" style="padding:8px 12px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:8px; cursor:pointer; color:var(--text-muted);">‚úï</button>
                </div>
            `;
            selectedDiv.style.display = 'block';
            document.getElementById('mf-step1-next').style.display = 'block';

            // Initialiser date √† aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('mf-pickup-date');
            if (dateInput) dateInput.value = today;

            updateMFProgress();
            goToMFStep(1);
        }

        function mfQuickSelectNewClient() {
            closeMFQuickSelectModal();

            // Afficher la vue nouvelle commande
            document.getElementById('mf-view-dashboard').style.display = 'none';
            document.getElementById('mf-view-neworder').style.display = 'block';

            // Reset formulaires
            document.getElementById('mf-client-search').value = '';
            document.getElementById('mf-selected-client').style.display = 'none';
            document.getElementById('mf-step1-next').style.display = 'none';

            // Mettre le type s√©lectionn√©
            setMFClientType(MFData.clientType);

            // Ouvrir le formulaire nouveau client
            showMFQuickClientForm();

            // Initialiser date √† aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('mf-pickup-date');
            if (dateInput) dateInput.value = today;

            updateMFProgress();
            goToMFStep(1);
        }

        function mfQuickSelectSearchClient() {
            closeMFQuickSelectModal();

            // Afficher la vue nouvelle commande
            document.getElementById('mf-view-dashboard').style.display = 'none';
            document.getElementById('mf-view-neworder').style.display = 'block';

            // Reset formulaires
            document.getElementById('mf-client-search').value = '';
            document.getElementById('mf-selected-client').style.display = 'none';
            document.getElementById('mf-step1-next').style.display = 'none';
            hideMFQuickClientForm();

            // Mettre le type s√©lectionn√©
            setMFClientType(MFData.clientType);

            // Focus sur la recherche
            setTimeout(() => {
                document.getElementById('mf-client-search').focus();
            }, 100);

            // Initialiser date √† aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('mf-pickup-date');
            if (dateInput) dateInput.value = today;

            updateMFProgress();
            goToMFStep(1);
        }

        function cancelMFOrder() {
            if (MFData.currentOrder.cart.length > 0) {
                if (!confirm('Abandonner cette commande ?')) return;
            }
            document.getElementById('mf-view-neworder').style.display = 'none';
            document.getElementById('mf-view-dashboard').style.display = 'block';
            initMFDashboard();
        }

        function updateMFProgress() {
            const steps = document.querySelectorAll('.mf-step');
            const progressLine = document.getElementById('mf-progress-line');
            const currentStep = MFData.currentStep;

            steps.forEach((step, idx) => {
                const stepNum = idx + 1;
                const circle = step.querySelector('div');
                const label = step.querySelectorAll('div')[1];

                if (stepNum < currentStep) {
                    // Compl√©t√©
                    circle.style.background = 'var(--accent-primary)';
                    circle.style.color = '#000';
                    circle.style.borderColor = 'var(--accent-primary)';
                    circle.innerHTML = '‚úì';
                    label.style.color = 'var(--accent-primary)';
                } else if (stepNum === currentStep) {
                    // Actuel
                    circle.style.background = 'var(--accent-primary)';
                    circle.style.color = '#000';
                    circle.style.border = 'none';
                    circle.innerHTML = stepNum;
                    label.style.color = 'var(--accent-primary)';
                } else {
                    // √Ä venir
                    circle.style.background = 'var(--bg-hover)';
                    circle.style.color = 'var(--text-muted)';
                    circle.style.border = '2px solid var(--border-color)';
                    circle.innerHTML = stepNum;
                    label.style.color = 'var(--text-muted)';
                }
            });

            // Ligne de progression
            const progressPercent = ((currentStep - 1) / 4) * 80;
            progressLine.style.width = progressPercent + '%';
        }

        function goToMFStep(step) {
            // Validation avant de changer d'√©tape
            if (step > 1 && !MFData.currentOrder.client) {
                alert('Veuillez s√©lectionner un client');
                return;
            }
            if (step > 2 && (!MFData.currentOrder.store || !MFData.currentOrder.pickupDate || !MFData.currentOrder.pickupTime)) {
                alert('Veuillez choisir le lieu et la date de retrait');
                return;
            }
            if (step > 3 && MFData.currentOrder.cart.length === 0) {
                alert('Veuillez ajouter au moins un article');
                return;
            }

            MFData.currentStep = step;
            updateMFProgress();

            // Cacher toutes les √©tapes
            document.querySelectorAll('.mf-step-content').forEach(el => el.style.display = 'none');
            document.getElementById('mf-step-' + step).style.display = 'block';

            // Actions sp√©cifiques par √©tape
            if (step === 2) {
                renderMFStoresSelection();
                updateMFStep2Info();
            } else if (step === 3) {
                renderMFArticlesList();
                updateMFCart();
            } else if (step === 4) {
                renderMFRecap();
            } else if (step === 5) {
                renderMFFinal();
            }
        }

        // ========== √âTAPE 1: CLIENT ==========
        function searchMFClients(query) {
            const resultsDiv = document.getElementById('mf-client-results');
            if (!query || query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            const q = query.toLowerCase();
            const allClients = getMFClients();

            const matches = allClients.filter(c => {
                const searchName = (c.lastname + ' ' + (c.firstname || '')).toLowerCase();
                const searchCompany = (c.name || '').toLowerCase();
                return (
                    searchName.includes(q) ||
                    searchCompany.includes(q) ||
                    (c.mobile && c.mobile.includes(q)) ||
                    (c.phone && c.phone.includes(q)) ||
                    (c.city && c.city.toLowerCase().includes(q))
                );
            }).slice(0, 15);

            if (matches.length === 0) {
                resultsDiv.innerHTML = '<div style="padding:16px; text-align:center; color:var(--text-muted);">Aucun client trouv√©</div>';
            } else {
                resultsDiv.innerHTML = matches.map(c => {
                    const displayName = MFData.clientType === 'B2B'
                        ? `<span style="color:var(--accent-secondary);">üè¢</span> ${c.name || c.lastname}` + (c.contact || c.firstname ? ` <span style="font-weight:400; color:var(--text-muted);">(${c.contact || c.firstname})</span>` : '')
                        : `<span style="color:var(--accent-primary);">üë§</span> ${c.lastname} ${c.firstname || ''}`;

                    return `
                        <div onclick="selectMFClient(${c.id})" style="padding:14px 18px; cursor:pointer; border-bottom:1px solid var(--border-color); transition:background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                            <div style="font-weight:600;">${displayName}</div>
                            <div style="font-size:12px; color:var(--text-muted);">üìû ${c.mobile || c.phone || '-'} ‚Ä¢ ${c.city || ''}</div>
                            ${c.allergies ? `<div style="font-size:11px; color:var(--accent-danger);">‚ö†Ô∏è ${c.allergies}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }
            resultsDiv.style.display = 'block';
        }

        function selectMFClient(id) {
            const allClients = getMFClients();
            const client = allClients.find(c => c.id === id);
            if (!client) return;

            // Stocker le type de client dans la commande
            client.clientType = MFData.clientType;
            MFData.currentOrder.client = client;

            document.getElementById('mf-client-search').value = '';
            document.getElementById('mf-client-results').style.display = 'none';

            // Affichage selon le type
            const displayName = MFData.clientType === 'B2B'
                ? (client.name || client.lastname) + (client.contact || client.firstname ? ` (${client.contact || client.firstname})` : '')
                : client.lastname + ' ' + (client.firstname || '');

            const typeBadge = MFData.clientType === 'B2B'
                ? '<span style="display:inline-block; padding:2px 8px; background:var(--accent-secondary); color:#fff; border-radius:4px; font-size:10px; margin-left:8px;">B2B</span>'
                : '<span style="display:inline-block; padding:2px 8px; background:var(--accent-primary); color:#000; border-radius:4px; font-size:10px; margin-left:8px;">B2C</span>';

            document.getElementById('mf-client-display-name').innerHTML = displayName + typeBadge;
            document.getElementById('mf-client-display-phone').textContent = client.mobile || client.phone || '-';
            document.getElementById('mf-client-display-email').textContent = client.email || '-';
            document.getElementById('mf-client-display-address').textContent = client.address ? `${client.address}, ${client.zip || ''} ${client.city || ''}` : client.city || '';

            const allergiesEl = document.getElementById('mf-client-display-allergies');
            if (client.allergies) {
                allergiesEl.textContent = '‚ö†Ô∏è Allergies: ' + client.allergies;
                allergiesEl.style.display = 'block';
            } else {
                allergiesEl.style.display = 'none';
            }

            document.getElementById('mf-selected-client').style.display = 'block';
            document.getElementById('mf-step1-next').style.display = 'block';
            hideMFQuickClientForm();
        }

        function clearMFClient() {
            MFData.currentOrder.client = null;
            document.getElementById('mf-selected-client').style.display = 'none';
            document.getElementById('mf-step1-next').style.display = 'none';
            document.getElementById('mf-client-search').focus();
        }

        function showMFQuickClientForm() {
            document.getElementById('mf-quick-client-form').style.display = 'block';
            document.getElementById('mf-new-lastname').focus();
        }

        function hideMFQuickClientForm() {
            document.getElementById('mf-quick-client-form').style.display = 'none';
            // Reset tous les champs (B2B et B2C)
            ['mf-new-lastname', 'mf-new-firstname', 'mf-new-company', 'mf-new-contact', 'mf-new-address', 'mf-new-zip', 'mf-new-city', 'mf-new-mobile', 'mf-new-phone', 'mf-new-email', 'mf-new-allergies', 'mf-new-notes'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        }

        function saveMFQuickClient() {
            let newClient;

            if (MFData.clientType === 'B2B') {
                // Client professionnel
                const company = document.getElementById('mf-new-company').value.trim();
                const mobile = document.getElementById('mf-new-mobile').value.trim();
                const city = document.getElementById('mf-new-city').value.trim();

                if (!company) { alert('Le nom de l\'entreprise est requis'); return; }
                if (!mobile) { alert('Le t√©l√©phone est requis'); return; }
                if (!city) { alert('Le lieu est requis'); return; }

                newClient = {
                    id: Date.now(),
                    num: String(Date.now()).slice(-6),
                    name: company,
                    contact: document.getElementById('mf-new-contact').value.trim(),
                    address: document.getElementById('mf-new-address').value.trim(),
                    address2: '',
                    zip: document.getElementById('mf-new-zip').value.trim(),
                    city,
                    phone: document.getElementById('mf-new-phone').value.trim(),
                    mobile,
                    email: document.getElementById('mf-new-email').value.trim(),
                    allergies: document.getElementById('mf-new-allergies').value.trim(),
                    notes: document.getElementById('mf-new-notes').value.trim(),
                    credit: 0,
                    payment: '30 jours fin de mois',
                    ordersCount: 0,
                    history: [],
                    clientType: 'B2B',
                    active: true
                };

                // Sauvegarder dans QOData.clients
                QOData.clients.push(newClient);
                localStorage.setItem('qo_clients', JSON.stringify(QOData.clients));

            } else {
                // Client particulier
                const lastname = document.getElementById('mf-new-lastname').value.trim();
                const firstname = document.getElementById('mf-new-firstname').value.trim();
                const mobile = document.getElementById('mf-new-mobile').value.trim();
                const city = document.getElementById('mf-new-city').value.trim();

                if (!lastname) { alert('Le nom est requis'); return; }
                if (!mobile) { alert('Le t√©l√©phone portable est requis'); return; }
                if (!city) { alert('Le lieu est requis'); return; }

                newClient = {
                    id: Date.now(),
                    lastname,
                    firstname,
                    address: document.getElementById('mf-new-address').value.trim(),
                    zip: document.getElementById('mf-new-zip').value.trim(),
                    city,
                    mobile,
                    phone: document.getElementById('mf-new-phone').value.trim(),
                    email: document.getElementById('mf-new-email').value.trim(),
                    allergies: document.getElementById('mf-new-allergies').value.trim(),
                    notes: document.getElementById('mf-new-notes').value.trim(),
                    clientType: 'B2C',
                    active: true
                };

                // Sauvegarder dans QOData.clients (base unifi√©e)
                QOData.clients.push(newClient);
                localStorage.setItem('qo_clients', JSON.stringify(QOData.clients));
            }

            selectMFClient(newClient.id);
        }

        // ========== √âTAPE 2: LIEU DE RETRAIT ==========
        function renderMFStoresSelection() {
            const container = document.getElementById('mf-stores-selection');
            if (!container) return;

            container.innerHTML = MFData.stores.map(store => `
                <div class="mf-store-card" onclick="selectMFStore(${store.id})" data-store-id="${store.id}"
                    style="padding:20px; background:var(--bg-primary); border:2px solid ${MFData.currentOrder.store?.id === store.id ? 'var(--accent-primary)' : 'var(--border-color)'}; border-radius:12px; cursor:pointer; transition:all 0.2s;"
                    onmouseover="if(!this.classList.contains('selected'))this.style.borderColor='var(--accent-secondary)'"
                    onmouseout="if(!this.classList.contains('selected'))this.style.borderColor='var(--border-color)'">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="font-size:32px;">üè™</div>
                        <div>
                            <div style="font-weight:700; font-size:16px;">${store.name}</div>
                            <div style="font-size:12px; color:var(--text-muted);">${store.address || ''}</div>
                            <div style="font-size:12px; color:var(--text-muted);">üìû ${store.phone || '-'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectMFStore(id) {
            const store = MFData.stores.find(s => s.id === id);
            if (!store) return;

            MFData.currentOrder.store = store;

            // Update visual
            document.querySelectorAll('.mf-store-card').forEach(card => {
                card.style.borderColor = card.dataset.storeId == id ? 'var(--accent-primary)' : 'var(--border-color)';
            });

            // Show datetime section
            document.getElementById('mf-datetime-section').style.display = 'block';

            // G√©n√©rer les cr√©neaux si date d√©j√† s√©lectionn√©e
            updateMFTimeSlots();
        }

        // G√©n√©rer les cr√©neaux horaires dynamiquement
        function updateMFTimeSlots() {
            const store = MFData.currentOrder.store;
            const dateStr = document.getElementById('mf-pickup-date').value;
            const slotsContainer = document.getElementById('mf-time-slots');
            const dayInfo = document.getElementById('mf-day-info');
            const timeInput = document.getElementById('mf-pickup-time');

            if (!store || !dateStr) {
                slotsContainer.innerHTML = '<div style="color:var(--text-muted); font-size:12px; padding:12px;">S√©lectionnez d\'abord un magasin et une date</div>';
                dayInfo.style.display = 'none';
                return;
            }

            const date = new Date(dateStr);
            const dayOfWeek = date.getDay(); // 0=dimanche, 1=lundi...
            const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const dayKey = dayKeys[dayOfWeek];
            const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];

            // V√©rifier jours exceptionnels
            const exceptional = (store.exceptionalDays || []).find(d => d.date === dateStr);

            let dayStart, dayEnd, isClosed = false, infoText = '';

            if (exceptional) {
                // Jour exceptionnel
                if (exceptional.closed) {
                    isClosed = true;
                    infoText = `<span style="color:var(--accent-danger);">‚ö†Ô∏è ${exceptional.label || 'Jour exceptionnel'} - Magasin ferm√©</span>`;
                } else {
                    dayStart = exceptional.start;
                    dayEnd = exceptional.end;
                    infoText = `<span style="color:var(--accent-orange);">üìÖ ${exceptional.label || 'Horaires sp√©ciaux'} : ${exceptional.start} - ${exceptional.end}</span>`;
                }
            } else {
                // Jour normal
                const hours = store.hours?.[dayKey];
                if (!hours || !hours.open) {
                    isClosed = true;
                    infoText = `<span style="color:var(--accent-danger);">‚ö†Ô∏è ${dayNames[dayOfWeek]} - Magasin ferm√©</span>`;
                } else {
                    dayStart = hours.start;
                    dayEnd = hours.end;
                    infoText = `<span style="color:var(--text-muted);">üïê ${dayNames[dayOfWeek]} : ${hours.start} - ${hours.end}</span>`;
                }
            }

            // Afficher info jour
            dayInfo.style.display = 'block';
            dayInfo.innerHTML = infoText;
            dayInfo.style.background = isClosed ? 'var(--accent-danger)15' : 'var(--accent-primary)15';

            if (isClosed) {
                slotsContainer.innerHTML = '<div style="text-align:center; padding:20px; color:var(--accent-danger);">Choisissez une autre date</div>';
                timeInput.value = '';
                checkMFStep2Complete();
                return;
            }

            // G√©n√©rer cr√©neaux
            const slotDuration = store.slotDuration || 60; // minutes
            const slots = [];

            const startParts = dayStart.split(':');
            const endParts = dayEnd.split(':');
            let startMinutes = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
            const endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);

            while (startMinutes + slotDuration <= endMinutes) {
                const slotStart = `${String(Math.floor(startMinutes / 60)).padStart(2, '0')}:${String(startMinutes % 60).padStart(2, '0')}`;
                const slotEnd = `${String(Math.floor((startMinutes + slotDuration) / 60)).padStart(2, '0')}:${String((startMinutes + slotDuration) % 60).padStart(2, '0')}`;
                slots.push({ start: slotStart, end: slotEnd, label: `${slotStart}-${slotEnd}` });
                startMinutes += slotDuration;
            }

            if (slots.length === 0) {
                slotsContainer.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">Aucun cr√©neau disponible</div>';
                return;
            }

            // Afficher les cr√©neaux comme boutons
            const currentSelected = timeInput.value;
            slotsContainer.innerHTML = slots.map(slot => `
                <button type="button" onclick="selectMFTimeSlot('${slot.label}')"
                    class="mf-slot-btn ${currentSelected === slot.label ? 'selected' : ''}"
                    style="padding:10px 8px; border-radius:8px; border:2px solid ${currentSelected === slot.label ? 'var(--accent-primary)' : 'var(--border-color)'};
                           background:${currentSelected === slot.label ? 'var(--accent-primary)' : 'var(--bg-card)'};
                           color:${currentSelected === slot.label ? '#000' : 'var(--text-primary)'};
                           font-size:12px; font-weight:600; cursor:pointer; transition:all 0.2s;">
                    ${slot.label}
                </button>
            `).join('');
        }

        function selectMFTimeSlot(slotLabel) {
            document.getElementById('mf-pickup-time').value = slotLabel;

            // Update visual
            document.querySelectorAll('.mf-slot-btn').forEach(btn => {
                const isSelected = btn.textContent.trim() === slotLabel;
                btn.style.borderColor = isSelected ? 'var(--accent-primary)' : 'var(--border-color)';
                btn.style.background = isSelected ? 'var(--accent-primary)' : 'var(--bg-card)';
                btn.style.color = isSelected ? '#000' : 'var(--text-primary)';
                btn.classList.toggle('selected', isSelected);
            });

            checkMFStep2Complete();
        }

        function checkMFStep2Complete() {
            const date = document.getElementById('mf-pickup-date').value;
            const time = document.getElementById('mf-pickup-time').value;

            MFData.currentOrder.pickupDate = date;
            MFData.currentOrder.pickupTime = time;

            const nextBtn = document.getElementById('mf-step2-next');
            if (MFData.currentOrder.store && date && time) {
                nextBtn.style.display = 'inline-flex';
            } else {
                nextBtn.style.display = 'none';
            }
        }

        function updateMFStep2Info() {
            if (MFData.currentOrder.client) {
                const client = MFData.currentOrder.client;
                const displayName = client.name || (client.lastname + ' ' + (client.firstname || ''));
                document.getElementById('mf-step2-client').textContent = displayName;
                document.getElementById('mf-step2-client-phone').textContent = client.mobile || client.phone || '';
            }
        }

        // Event listeners pour date/heure - ne plus √©couter time car g√©r√© par boutons
        document.addEventListener('DOMContentLoaded', () => {
            const dateEl = document.getElementById('mf-pickup-date');
            if (dateEl) dateEl.addEventListener('change', updateMFTimeSlots);
        });

        // ========== √âTAPE 3: ARTICLES - NOUVEAU SYST√àME ==========
        let mfSelectedArticles = []; // Articles s√©lectionn√©s dans le modal

        // Labels et emojis pour les cat√©gories
        const mfCatConfig = {
            poisson: { label: 'Poissons', emoji: 'üêü', color: '#118ab2' },
            crustace: { label: 'Crustac√©s', emoji: 'ü¶ê', color: '#ef476f' },
            coquillage: { label: 'Coquillages', emoji: 'ü¶™', color: '#8338ec' },
            fume: { label: 'Fum√©s', emoji: 'üî•', color: '#f77f00' },
            conserve: { label: 'Conserves', emoji: 'ü•´', color: '#d62828' },
            preparation: { label: 'Traiteur', emoji: 'üçΩÔ∏è', color: '#06d6a0' },
            surgele: { label: 'Surgel√©s', emoji: '‚ùÑÔ∏è', color: '#00b4d8' },
            epicerie: { label: '√âpicerie', emoji: 'üõí', color: '#fca311' }
        };

        // Ouvrir le modal catalogue
        function openMFArticlesModal() {
            mfSelectedArticles = []; // Reset s√©lection
            document.getElementById('mf-articles-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';

            // Peupler les cat√©gories
            const articles = ArticlesData?.articles || [];
            const categories = [...new Set(articles.map(a => a.category).filter(c => c))];
            const catSelect = document.getElementById('mf-modal-category');
            catSelect.innerHTML = '<option value="">Toutes cat√©gories</option>' +
                categories.map(cat => {
                    const config = mfCatConfig[cat] || { label: cat };
                    return `<option value="${cat}">${config.emoji || 'üì¶'} ${config.label}</option>`;
                }).join('');

            // Reset recherche
            document.getElementById('mf-modal-search').value = '';

            renderMFModalArticles();
            updateMFSelectionCount();
        }

        function closeMFArticlesModal() {
            document.getElementById('mf-articles-modal').style.display = 'none';
            document.body.style.overflow = '';
        }

        // Filtrer les articles dans le modal
        function filterMFModalArticles() {
            renderMFModalArticles();
        }

        // Afficher les articles dans le modal
        function renderMFModalArticles() {
            const tbody = document.getElementById('mf-articles-tbody');
            const search = document.getElementById('mf-modal-search').value.toLowerCase();
            const category = document.getElementById('mf-modal-category').value;

            let articles = ArticlesData?.articles || [];
            articles = articles.filter(a => a.active !== false);

            if (category) {
                articles = articles.filter(a => a.category === category);
            }

            if (search) {
                articles = articles.filter(a =>
                    a.name.toLowerCase().includes(search) ||
                    (a.code && a.code.toLowerCase().includes(search)) ||
                    (a.category && a.category.toLowerCase().includes(search))
                );
            }

            if (articles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align:center; padding:60px; color:var(--text-muted);">
                            <div style="font-size:48px; margin-bottom:12px;">üîç</div>
                            <div>Aucun article trouv√©</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = articles.map(article => {
                const price = article.priceB2C || article.price || 0;
                const isSelected = mfSelectedArticles.some(s => s.id === article.id);
                const catConfig = mfCatConfig[article.category] || { label: article.category, emoji: 'üì¶', color: '#666' };

                return `
                    <tr onclick="toggleMFArticleSelection(${article.id})"
                        style="cursor:pointer; transition:all 0.2s; ${isSelected ? 'background:var(--accent-primary)15;' : ''}"
                        onmouseover="this.style.background='${isSelected ? 'var(--accent-primary)25' : 'var(--bg-hover)'}'"
                        onmouseout="this.style.background='${isSelected ? 'var(--accent-primary)15' : ''}'">
                        <td style="padding:14px 8px; text-align:center;">
                            <div style="width:28px; height:28px; border-radius:6px; border:2px solid ${isSelected ? 'var(--accent-primary)' : 'var(--border-color)'};
                                        background:${isSelected ? 'var(--accent-primary)' : 'transparent'}; display:flex; align-items:center; justify-content:center;">
                                ${isSelected ? '<span style="color:#000; font-weight:700;">‚úì</span>' : ''}
                            </div>
                        </td>
                        <td style="padding:14px 8px; font-family:'Space Mono',monospace; font-weight:600; color:var(--accent-secondary);">
                            ${article.code || '-'}
                        </td>
                        <td style="padding:14px 8px;">
                            <div style="font-weight:600; font-size:14px;">${article.name}</div>
                        </td>
                        <td style="padding:14px 8px;">
                            <span style="padding:4px 10px; border-radius:12px; font-size:11px; font-weight:600; background:${catConfig.color}20; color:${catConfig.color};">
                                ${catConfig.emoji} ${catConfig.label}
                            </span>
                        </td>
                        <td style="padding:14px 8px; text-align:right; font-family:'Space Mono',monospace; font-weight:700; font-size:15px; color:var(--accent-primary);">
                            ${price.toFixed(2)}
                        </td>
                        <td style="padding:14px 8px; text-align:center; color:var(--text-muted); font-size:13px;">
                            ${article.unit || 'kg'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Toggle s√©lection d'un article
        function toggleMFArticleSelection(articleId) {
            const articles = ArticlesData?.articles || [];
            const article = articles.find(a => a.id === articleId);
            if (!article) return;

            const existingIdx = mfSelectedArticles.findIndex(s => s.id === articleId);

            if (existingIdx >= 0) {
                // D√©s√©lectionner
                mfSelectedArticles.splice(existingIdx, 1);
            } else {
                // S√©lectionner avec valeurs par d√©faut
                mfSelectedArticles.push({
                    id: article.id,
                    code: article.code || '',
                    name: article.name,
                    price: article.priceB2C || article.price || 0,
                    unit: article.unit || 'kg',
                    qty: 1
                });
            }

            renderMFModalArticles();
            updateMFSelectionCount();
        }

        // Mettre √† jour le compteur de s√©lection
        function updateMFSelectionCount() {
            const count = mfSelectedArticles.length;
            document.getElementById('mf-selection-count').textContent = count + ' s√©lectionn√©(s)';
            document.getElementById('mf-validate-selection-btn').style.display = count > 0 ? 'block' : 'none';
        }

        // Valider la s√©lection et ajouter au panier
        function validateMFSelection() {
            if (mfSelectedArticles.length === 0) return;

            // Ajouter au panier
            mfSelectedArticles.forEach(selected => {
                const existing = MFData.currentOrder.cart.find(item => item.articleId === selected.id);
                if (existing) {
                    existing.qty += selected.qty;
                } else {
                    MFData.currentOrder.cart.push({
                        articleId: selected.id,
                        code: selected.code,
                        name: selected.name,
                        price: selected.price,
                        unit: selected.unit,
                        qty: selected.qty
                    });
                }
            });

            closeMFArticlesModal();
            updateMFEditableCart();
            showMFToast(`${mfSelectedArticles.length} article(s) ajout√©(s)`);
        }

        // Toast notification
        function showMFToast(message) {
            const existing = document.querySelector('.mf-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'mf-toast';
            toast.style.cssText = `
                position:fixed; bottom:100px; left:50%; transform:translateX(-50%);
                background:var(--accent-primary); color:#000; padding:12px 24px;
                border-radius:25px; font-weight:600; font-size:13px; z-index:9999;
                animation:slideUp 0.3s ease, fadeOut 0.3s ease 1.7s forwards;
                box-shadow:0 4px 20px rgba(6,214,160,0.4);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Mettre √† jour le panier √©ditable
        function updateMFEditableCart() {
            const container = document.getElementById('mf-cart-items-editable');
            const totalsDiv = document.getElementById('mf-cart-totals');
            const cart = MFData.currentOrder.cart;

            if (cart.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:60px 20px; color:var(--text-muted);">
                        <div style="font-size:64px; margin-bottom:16px; opacity:0.3;">üì¶</div>
                        <div style="font-size:16px; margin-bottom:8px;">Aucun article dans le panier</div>
                        <div style="font-size:13px;">Cliquez sur "Ouvrir catalogue" pour ajouter des produits</div>
                    </div>`;
                totalsDiv.style.display = 'none';
                document.getElementById('mf-step3-next').style.display = 'none';
                return;
            }

            let subtotal = 0;
            container.innerHTML = `
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:2px solid var(--border-color);">
                            <th style="padding:12px 8px; text-align:left; font-size:11px; color:var(--text-muted);">CODE</th>
                            <th style="padding:12px 8px; text-align:left; font-size:11px; color:var(--text-muted);">D√âSIGNATION</th>
                            <th style="padding:12px 8px; text-align:center; font-size:11px; color:var(--text-muted); width:100px;">QT√â</th>
                            <th style="padding:12px 8px; text-align:center; font-size:11px; color:var(--text-muted); width:80px;">UNIT√â</th>
                            <th style="padding:12px 8px; text-align:right; font-size:11px; color:var(--text-muted); width:100px;">PRIX HT</th>
                            <th style="padding:12px 8px; text-align:right; font-size:11px; color:var(--text-muted); width:100px;">TOTAL</th>
                            <th style="padding:12px 8px; width:40px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cart.map((item, idx) => {
                            const itemTotal = item.price * item.qty;
                            subtotal += itemTotal;
                            return `
                                <tr style="border-bottom:1px solid var(--border-color);">
                                    <td style="padding:12px 8px;">
                                        <input type="text" value="${item.code || ''}"
                                            onchange="updateMFCartField(${idx}, 'code', this.value)"
                                            style="width:80px; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--accent-secondary); font-family:'Space Mono',monospace; font-size:12px;">
                                    </td>
                                    <td style="padding:12px 8px;">
                                        <input type="text" value="${item.name}"
                                            onchange="updateMFCartField(${idx}, 'name', this.value)"
                                            style="width:100%; padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:13px;">
                                    </td>
                                    <td style="padding:12px 8px; text-align:center;">
                                        <div style="display:flex; align-items:center; justify-content:center; gap:4px;">
                                            <button onclick="updateMFCartQty(${idx}, -0.5)" style="width:28px; height:28px; border-radius:6px; background:var(--bg-hover); border:1px solid var(--border-color); color:var(--text-primary); cursor:pointer;">‚àí</button>
                                            <input type="number" value="${item.qty}" min="0.1" step="0.1"
                                                onchange="updateMFCartField(${idx}, 'qty', parseFloat(this.value))"
                                                style="width:50px; padding:8px; text-align:center; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-family:'Space Mono',monospace; font-weight:600;">
                                            <button onclick="updateMFCartQty(${idx}, 0.5)" style="width:28px; height:28px; border-radius:6px; background:var(--accent-primary); border:none; color:#000; cursor:pointer;">+</button>
                                        </div>
                                    </td>
                                    <td style="padding:12px 8px; text-align:center;">
                                        <select onchange="updateMFCartField(${idx}, 'unit', this.value)"
                                            style="padding:8px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:12px;">
                                            <option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>kg</option>
                                            <option value="pce" ${item.unit === 'pce' ? 'selected' : ''}>pce</option>
                                            <option value="lot" ${item.unit === 'lot' ? 'selected' : ''}>lot</option>
                                            <option value="g" ${item.unit === 'g' ? 'selected' : ''}>g</option>
                                        </select>
                                    </td>
                                    <td style="padding:12px 8px; text-align:right;">
                                        <input type="number" value="${item.price.toFixed(2)}" min="0" step="0.05"
                                            onchange="updateMFCartField(${idx}, 'price', parseFloat(this.value))"
                                            style="width:80px; padding:8px; text-align:right; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:6px; color:var(--accent-primary); font-family:'Space Mono',monospace; font-weight:600;">
                                    </td>
                                    <td style="padding:12px 8px; text-align:right; font-family:'Space Mono',monospace; font-weight:700; font-size:14px; color:var(--accent-primary);">
                                        ${itemTotal.toFixed(2)}
                                    </td>
                                    <td style="padding:12px 8px; text-align:center;">
                                        <button onclick="removeMFCartItem(${idx})"
                                            style="padding:6px 10px; background:var(--accent-danger)20; border:1px solid var(--accent-danger); border-radius:6px; color:var(--accent-danger); cursor:pointer; font-size:14px;">
                                            ‚úï
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            const tva = subtotal * 0.026;
            const total = subtotal + tva;

            document.getElementById('mf-cart-subtotal').textContent = subtotal.toFixed(2) + ' CHF';
            document.getElementById('mf-cart-tva').textContent = tva.toFixed(2) + ' CHF';
            document.getElementById('mf-cart-total').textContent = total.toFixed(2) + ' CHF';
            totalsDiv.style.display = 'block';
            document.getElementById('mf-step3-next').style.display = 'block';
        }

        // Mettre √† jour un champ du panier
        function updateMFCartField(idx, field, value) {
            const item = MFData.currentOrder.cart[idx];
            if (!item) return;
            item[field] = value;
            updateMFEditableCart();
        }

        // Modifier quantit√©
        function updateMFCartQty(idx, delta) {
            const item = MFData.currentOrder.cart[idx];
            if (!item) return;
            item.qty = Math.max(0.1, (item.qty || 1) + delta);
            updateMFEditableCart();
        }

        // Supprimer un article
        function removeMFCartItem(idx) {
            MFData.currentOrder.cart.splice(idx, 1);
            updateMFEditableCart();
        }

        // Ancienne fonction pour compatibilit√©
        function updateMFCart() {
            updateMFEditableCart();
        }

        // ========== √âTAPE 4: R√âCAPITULATIF ==========
        function renderMFRecap() {
            const order = MFData.currentOrder;
            const client = order.client;
            const store = order.store;

            // Client info
            document.getElementById('mf-recap-client').innerHTML = `
                <div style="font-weight:600; font-size:16px; margin-bottom:8px;">${client.lastname} ${client.firstname || ''}</div>
                <div style="font-size:13px; color:var(--text-muted);">üìû ${client.mobile || client.phone || '-'}</div>
                <div style="font-size:13px; color:var(--text-muted);">üìß ${client.email || '-'}</div>
                ${client.allergies ? `<div style="font-size:13px; color:var(--accent-danger); margin-top:8px;">‚ö†Ô∏è ${client.allergies}</div>` : ''}
            `;

            // Pickup info
            document.getElementById('mf-recap-pickup').innerHTML = `
                <div style="font-weight:600; font-size:16px; margin-bottom:8px;">${store.name}</div>
                <div style="font-size:13px; color:var(--text-muted);">${store.address || ''}</div>
                <div style="font-size:14px; margin-top:12px; padding:10px; background:var(--bg-card); border-radius:8px;">
                    üìÖ <strong>${formatDate(order.pickupDate)}</strong> √† <strong>${order.pickupTime}</strong>
                </div>
            `;

            // Items
            let subtotal = 0;
            document.getElementById('mf-recap-items').innerHTML = `
                <table style="width:100%;">
                    <thead style="background:var(--bg-hover);">
                        <tr><th style="padding:12px; text-align:left;">Article</th><th style="padding:12px; text-align:center;">Qt√©</th><th style="padding:12px; text-align:right;">Prix unit.</th><th style="padding:12px; text-align:right;">Total</th></tr>
                    </thead>
                    <tbody>
                        ${order.cart.map(item => {
                            const itemTotal = item.price * item.qty;
                            subtotal += itemTotal;
                            return `
                                <tr style="border-bottom:1px solid var(--border-color);">
                                    <td style="padding:12px;"><strong>${item.name}</strong><br><span style="font-size:11px; color:var(--accent-orange);">${item.code}</span></td>
                                    <td style="padding:12px; text-align:center;">${item.qty} ${item.unit}</td>
                                    <td style="padding:12px; text-align:right; font-family:'Space Mono',monospace;">${item.price.toFixed(2)} CHF</td>
                                    <td style="padding:12px; text-align:right; font-family:'Space Mono',monospace; font-weight:600;">${itemTotal.toFixed(2)} CHF</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            const tva = subtotal * 0.026;
            const total = subtotal + tva;

            document.getElementById('mf-recap-subtotal').textContent = subtotal.toFixed(2) + ' CHF';
            document.getElementById('mf-recap-tva').textContent = tva.toFixed(2) + ' CHF';
            document.getElementById('mf-recap-total').textContent = total.toFixed(2) + ' CHF';
        }

        // ========== √âTAPE 5: VALIDATION ==========
        function renderMFFinal() {
            const order = MFData.currentOrder;
            const client = order.client;
            const store = order.store;

            let subtotal = order.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const tva = subtotal * 0.026;
            const total = subtotal + tva;

            document.getElementById('mf-final-client').textContent = client.lastname + ' ' + (client.firstname || '');
            document.getElementById('mf-final-total').textContent = total.toFixed(2) + ' CHF';
            document.getElementById('mf-final-pickup').textContent = `üìç ${store.name} ‚Ä¢ üìÖ ${formatDate(order.pickupDate)} √† ${order.pickupTime}`;

            document.getElementById('mf-email-to').textContent = client.email || '(pas d\'email)';
            document.getElementById('mf-email-store').textContent = store.email || '(pas d\'email configur√©)';
        }

        function validateMFOrder() {
            const order = MFData.currentOrder;

            let subtotal = order.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const tva = subtotal * 0.026;
            const total = subtotal + tva;

            const newOrder = {
                id: (MFData.orders.length > 0 ? Math.max(...MFData.orders.map(o => o.id)) : 0) + 1,
                clientId: order.client.id,
                storeId: order.store.id,
                pickupDate: order.pickupDate,
                pickupTime: order.pickupTime,
                items: [...order.cart],
                subtotal,
                tva,
                total,
                notes: document.getElementById('mf-order-notes')?.value || '',
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            MFData.orders.push(newOrder);
            saveMFData('orders');

            // Email simulation
            const sendEmail = document.getElementById('mf-send-email').checked;
            const sendCopy = document.getElementById('mf-send-copy').checked;

            if (sendEmail && order.client.email) {
                console.log('üìß Email envoy√© √†:', order.client.email);
            }
            if (sendCopy && order.store.email) {
                console.log('üìß Copie envoy√©e √†:', order.store.email);
            }

            alert(`‚úÖ Commande #${newOrder.id} cr√©√©e avec succ√®s !`);

            // Retour au dashboard
            document.getElementById('mf-view-neworder').style.display = 'none';
            document.getElementById('mf-view-dashboard').style.display = 'block';
            initMFDashboard();
        }

        function printMFOrder() {
            printMFOrderById(null); // Commande en cours
        }

        function printMFOrderById(orderId) {
            let order, client, store, items, subtotal, tva, total;

            if (orderId) {
                order = MFData.orders.find(o => o.id === orderId);
                if (!order) return;
                client = (QOData?.clients || []).find(c => c.id === order.clientId);
                store = MFData.stores.find(s => s.id === order.storeId);
                items = order.items;
                subtotal = order.subtotal;
                tva = order.tva;
                total = order.total;
            } else {
                order = MFData.currentOrder;
                client = order.client;
                store = order.store;
                items = order.cart;
                subtotal = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                tva = subtotal * 0.026;
                total = subtotal + tva;
            }

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Commande ${orderId ? '#' + orderId : ''}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        h1 { color: #06d6a0; border-bottom: 3px solid #06d6a0; padding-bottom: 10px; }
                        .header { display: flex; justify-content: space-between; margin-bottom: 30px; }
                        .box { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #06d6a0; color: #000; }
                        .total { font-size: 24px; font-weight: bold; text-align: right; color: #06d6a0; }
                        .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <h1>üêü Borex Poissons - Confirmation de commande</h1>
                    <div class="header">
                        <div class="box" style="flex:1; margin-right:20px;">
                            <h3>üë§ Client</h3>
                            <strong>${client?.lastname || ''} ${client?.firstname || ''}</strong><br>
                            ${client?.address || ''}<br>
                            ${client?.zip || ''} ${client?.city || ''}<br>
                            üìû ${client?.mobile || client?.phone || '-'}<br>
                            üìß ${client?.email || '-'}
                            ${client?.allergies ? `<br><span style="color:red;">‚ö†Ô∏è Allergies: ${client.allergies}</span>` : ''}
                        </div>
                        <div class="box" style="flex:1;">
                            <h3>üìç Retrait</h3>
                            <strong>${store?.name || ''}</strong><br>
                            ${store?.address || ''}<br>
                            üìû ${store?.phone || '-'}<br><br>
                            <strong>üìÖ ${formatDate(order?.pickupDate || order?.pickupDate)} √† ${order?.pickupTime}</strong>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr><th>Article</th><th>Qt√©</th><th>Prix unit.</th><th>Total</th></tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td>${item.name}<br><small style="color:#666;">${item.code}</small></td>
                                    <td>${item.qty} ${item.unit}</td>
                                    <td>${item.price.toFixed(2)} CHF</td>
                                    <td>${(item.price * item.qty).toFixed(2)} CHF</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="text-align:right; margin-top:20px;">
                        <div>Sous-total HT: ${subtotal.toFixed(2)} CHF</div>
                        <div>TVA (2.6%): ${tva.toFixed(2)} CHF</div>
                        <div class="total">TOTAL TTC: ${total.toFixed(2)} CHF</div>
                    </div>
                    ${order?.notes ? `<div class="box" style="margin-top:30px;"><h3>üìù Notes</h3>${order.notes}</div>` : ''}
                    <div class="footer">
                        Borex Poissons - Merci pour votre commande !<br>
                        Document g√©n√©r√© le ${new Date().toLocaleString('fr-CH')}
                    </div>
                    <script>window.print();${'<'}/script>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
        }

        // ========== MODALS GESTION ==========
        function showMFClientsModal() {
            renderMFClientsTable();
            document.getElementById('mf-clients-modal').style.display = 'flex';
        }

        function closeMFClientsModal() {
            document.getElementById('mf-clients-modal').style.display = 'none';
        }

        function renderMFClientsTable() {
            const tbody = document.getElementById('mf-clients-tbody');
            const filter = document.getElementById('mf-clients-filter')?.value?.toLowerCase() || '';
            const typeFilter = document.getElementById('mf-clients-type-filter')?.value || '';

            // Tous les clients de la base unifi√©e
            let allClients = QOData?.clients || [];

            // Mise √† jour des stats
            const b2bCount = allClients.filter(c => (c.clientType || 'b2b').toLowerCase() === 'b2b').length;
            const b2cCount = allClients.filter(c => (c.clientType || 'b2b').toLowerCase() === 'b2c').length;
            document.getElementById('mf-clients-total').textContent = allClients.length;
            document.getElementById('mf-clients-b2b').textContent = b2bCount;
            document.getElementById('mf-clients-b2c').textContent = b2cCount;

            // Filtrer par type si s√©lectionn√©
            let clients = allClients;
            if (typeFilter) {
                clients = clients.filter(c => (c.clientType || 'b2b').toLowerCase() === typeFilter);
            }

            // Filtrer par recherche texte
            if (filter) {
                clients = clients.filter(c =>
                    (c.name || '').toLowerCase().includes(filter) ||
                    (c.lastname || '').toLowerCase().includes(filter) ||
                    (c.firstname || '').toLowerCase().includes(filter) ||
                    (c.contact || '').toLowerCase().includes(filter) ||
                    (c.mobile || '').includes(filter) ||
                    (c.phone || '').includes(filter) ||
                    (c.city || '').toLowerCase().includes(filter) ||
                    (c.email || '').toLowerCase().includes(filter)
                );
            }

            // Limiter √† 100 pour performance
            const displayClients = clients.slice(0, 100);

            tbody.innerHTML = displayClients.map(c => {
                const type = (c.clientType || 'b2b').toUpperCase();
                const isB2B = type === 'B2B';
                const typeBadge = isB2B
                    ? '<span style="padding:3px 8px; background:rgba(17,138,178,0.2); color:var(--accent-secondary); border-radius:4px; font-size:10px; font-weight:600;">B2B</span>'
                    : '<span style="padding:3px 8px; background:rgba(255,183,77,0.2); color:var(--accent-warning); border-radius:4px; font-size:10px; font-weight:600;">B2C</span>';

                // Nom selon le type
                const displayName = isB2B ? (c.name || c.lastname || '-') : (c.lastname || '-');
                const displayContact = isB2B ? (c.contact || c.firstname || '-') : (c.firstname || '-');

                return `
                <tr>
                    <td>${typeBadge}</td>
                    <td><strong>${displayName}</strong></td>
                    <td>${displayContact}</td>
                    <td>${c.mobile || c.phone || '-'}</td>
                    <td style="font-size:12px;">${c.email || '-'}</td>
                    <td>${c.city || '-'}</td>
                    <td>${c.active !== false ? '<span style="color:var(--accent-primary);">‚úì</span>' : '<span style="color:var(--text-muted);">‚úï</span>'}</td>
                    <td>
                        <button onclick="editMFClient(${c.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">‚úèÔ∏è</button>
                    </td>
                </tr>
            `}).join('');

            if (clients.length > 100) {
                tbody.innerHTML += `<tr><td colspan="8" style="text-align:center; padding:16px; color:var(--text-muted);">... et ${clients.length - 100} autres clients. Affinez votre recherche.</td></tr>`;
            }
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--text-muted);">Aucun client trouv√©</td></tr>';
            }
        }

        function filterMFClientsType(type) {
            document.getElementById('mf-clients-type-filter').value = type;

            // Mise √† jour visuelle des boutons stats
            const allBtn = document.getElementById('mf-filter-all');
            const b2bBtn = document.getElementById('mf-filter-b2b');
            const b2cBtn = document.getElementById('mf-filter-b2c');

            // Reset toutes les bordures
            if (allBtn) allBtn.style.border = '2px solid transparent';
            if (b2bBtn) b2bBtn.style.border = '2px solid transparent';
            if (b2cBtn) b2cBtn.style.border = '2px solid transparent';

            // Activer le bouton s√©lectionn√©
            if (type === 'b2b' && b2bBtn) {
                b2bBtn.style.border = '2px solid var(--accent-secondary)';
            } else if (type === 'b2c' && b2cBtn) {
                b2cBtn.style.border = '2px solid var(--accent-warning)';
            } else if (allBtn) {
                allBtn.style.border = '2px solid var(--accent-primary)';
            }

            renderMFClientsTable();
        }

        function filterMFClientsTable() {
            renderMFClientsTable();
        }

        // ========== MODAL ARTICLES (pour s√©lection √©tape 3) ==========
        function showMFArticlesModal() {
            renderMFArticlesTable();
            document.getElementById('mf-articles-modal').style.display = 'flex';
        }

        // ========== MODAL CONSULTATION ARTICLES (depuis dashboard) ==========
        function showMFArticlesViewModal() {
            renderMFViewArticlesTable();
            document.getElementById('mf-articles-view-modal').style.display = 'flex';
        }

        function closeMFArticlesViewModal() {
            document.getElementById('mf-articles-view-modal').style.display = 'none';
        }

        function filterMFViewArticlesTable() {
            renderMFViewArticlesTable();
        }

        function renderMFViewArticlesTable() {
            const tbody = document.getElementById('mf-view-articles-tbody');
            const filter = document.getElementById('mf-view-articles-filter')?.value?.toLowerCase() || '';
            const catFilter = document.getElementById('mf-view-articles-cat-filter')?.value || '';

            // Utiliser les articles du module Outils
            let allArticles = QOData?.articles || [];

            // Stats
            const activeCount = allArticles.filter(a => a.active !== false).length;
            document.getElementById('mf-view-articles-total').textContent = allArticles.length;
            document.getElementById('mf-view-articles-active').textContent = activeCount;

            // Remplir le filtre cat√©gories
            const categories = [...new Set(allArticles.map(a => a.category).filter(Boolean))];
            const catSelect = document.getElementById('mf-view-articles-cat-filter');
            const currentCat = catSelect.value;
            catSelect.innerHTML = '<option value="">Toutes cat√©gories</option>' +
                categories.map(c => `<option value="${c}" ${c === currentCat ? 'selected' : ''}>${c}</option>`).join('');

            // Filtrer par cat√©gorie
            let articles = allArticles;
            if (catFilter) {
                articles = articles.filter(a => a.category === catFilter);
            }

            // Filtrer par recherche
            if (filter) {
                articles = articles.filter(a =>
                    (a.code || '').toLowerCase().includes(filter) ||
                    (a.name || '').toLowerCase().includes(filter) ||
                    (a.category || '').toLowerCase().includes(filter)
                );
            }

            // Limiter √† 100
            const displayArticles = articles.slice(0, 100);

            tbody.innerHTML = displayArticles.map(a => `
                <tr style="opacity:${a.active !== false ? '1' : '0.5'}; border-bottom:1px solid var(--border-color);">
                    <td style="padding:10px 8px;"><code style="background:var(--bg-primary); padding:2px 6px; border-radius:4px;">${a.code || '-'}</code></td>
                    <td style="padding:10px 8px;"><strong>${a.name || '-'}</strong></td>
                    <td style="padding:10px 8px;"><span style="padding:2px 8px; background:var(--bg-hover); border-radius:4px; font-size:11px;">${a.category || '-'}</span></td>
                    <td style="padding:10px 8px; color:var(--accent-warning); font-weight:600;">${a.priceB2C ? a.priceB2C.toFixed(2) + ' CHF' : '-'}</td>
                    <td style="padding:10px 8px; color:var(--accent-secondary); font-weight:600;">${a.priceB2B ? a.priceB2B.toFixed(2) + ' CHF' : '-'}</td>
                    <td style="padding:10px 8px;">${a.unit || 'pce'}</td>
                    <td style="padding:10px 8px;">${a.active !== false ? '<span style="color:var(--accent-primary);">‚úì</span>' : '<span style="color:var(--text-muted);">‚úï</span>'}</td>
                </tr>
            `).join('');

            if (articles.length > 100) {
                tbody.innerHTML += `<tr><td colspan="7" style="text-align:center; padding:16px; color:var(--text-muted);">... et ${articles.length - 100} autres articles. Affinez votre recherche.</td></tr>`;
            }

            if (displayArticles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--text-muted);">Aucun article trouv√©</td></tr>';
            }
        }

        // ========== RENDER ARTICLES TABLE (pour √©tape 3) ==========
        function renderMFArticlesTable() {
            const tbody = document.getElementById('mf-articles-tbody');
            const filter = document.getElementById('mf-articles-filter')?.value?.toLowerCase() || '';
            const catFilter = document.getElementById('mf-articles-cat-filter')?.value || '';

            // Utiliser les articles du module Outils
            let allArticles = QOData?.articles || [];

            // Stats
            const activeCount = allArticles.filter(a => a.active !== false).length;
            document.getElementById('mf-articles-total').textContent = allArticles.length;
            document.getElementById('mf-articles-active').textContent = activeCount;

            // Remplir le filtre cat√©gories
            const categories = [...new Set(allArticles.map(a => a.category).filter(Boolean))];
            const catSelect = document.getElementById('mf-articles-cat-filter');
            const currentCat = catSelect.value;
            catSelect.innerHTML = '<option value="">Toutes cat√©gories</option>' +
                categories.map(c => `<option value="${c}" ${c === currentCat ? 'selected' : ''}>${c}</option>`).join('');

            // Filtrer par cat√©gorie
            let articles = allArticles;
            if (catFilter) {
                articles = articles.filter(a => a.category === catFilter);
            }

            // Filtrer par recherche
            if (filter) {
                articles = articles.filter(a =>
                    (a.code || '').toLowerCase().includes(filter) ||
                    (a.name || '').toLowerCase().includes(filter) ||
                    (a.category || '').toLowerCase().includes(filter)
                );
            }

            // Limiter √† 100
            const displayArticles = articles.slice(0, 100);

            tbody.innerHTML = displayArticles.map(a => `
                <tr style="opacity:${a.active !== false ? '1' : '0.5'};">
                    <td><code style="background:var(--bg-primary); padding:2px 6px; border-radius:4px;">${a.code || '-'}</code></td>
                    <td><strong>${a.name || '-'}</strong></td>
                    <td><span style="padding:2px 8px; background:var(--bg-hover); border-radius:4px; font-size:11px;">${a.category || '-'}</span></td>
                    <td style="color:var(--accent-warning); font-weight:600;">${a.priceB2C ? a.priceB2C.toFixed(2) + ' CHF' : '-'}</td>
                    <td style="color:var(--accent-secondary); font-weight:600;">${a.priceB2B ? a.priceB2B.toFixed(2) + ' CHF' : '-'}</td>
                    <td>${a.unit || 'pce'}</td>
                    <td>${a.active !== false ? '<span style="color:var(--accent-primary);">‚úì</span>' : '<span style="color:var(--text-muted);">‚úï</span>'}</td>
                </tr>
            `).join('');

            if (articles.length > 100) {
                tbody.innerHTML += `<tr><td colspan="7" style="text-align:center; padding:16px; color:var(--text-muted);">... et ${articles.length - 100} autres articles. Affinez votre recherche.</td></tr>`;
            }
            if (articles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--text-muted);">Aucun article trouv√©</td></tr>';
            }
        }

        function filterMFArticlesTable() {
            renderMFArticlesTable();
        }

        // Fonction pour changer le type de client dans le formulaire
        function setMFEditClientType(type) {
            document.getElementById('mf-edit-client-type').value = type;

            const b2bBtn = document.getElementById('mf-edit-type-b2b');
            const b2cBtn = document.getElementById('mf-edit-type-b2c');
            const companyField = document.getElementById('mf-edit-field-company');
            const lastnameLabel = document.getElementById('mf-edit-label-lastname');
            const firstnameLabel = document.getElementById('mf-edit-label-firstname');

            if (type === 'b2b') {
                // B2B s√©lectionn√©
                b2bBtn.style.border = '3px solid var(--accent-secondary)';
                b2bBtn.style.background = 'rgba(17,138,178,0.15)';
                b2cBtn.style.border = '3px solid var(--border-color)';
                b2cBtn.style.background = 'var(--bg-primary)';

                // Afficher champ soci√©t√©
                companyField.style.display = 'block';
                lastnameLabel.textContent = 'Nom du contact';
                firstnameLabel.textContent = 'Pr√©nom du contact';
            } else {
                // B2C s√©lectionn√©
                b2cBtn.style.border = '3px solid var(--accent-warning)';
                b2cBtn.style.background = 'rgba(255,183,77,0.15)';
                b2bBtn.style.border = '3px solid var(--border-color)';
                b2bBtn.style.background = 'var(--bg-primary)';

                // Masquer champ soci√©t√©
                companyField.style.display = 'none';
                lastnameLabel.textContent = 'Nom *';
                firstnameLabel.textContent = 'Pr√©nom';
            }
        }

        function showMFClientForm(id = null) {
            const modal = document.getElementById('mf-client-form-modal');
            document.getElementById('mf-client-form-title').textContent = id ? 'Modifier client' : 'Nouveau client';
            document.getElementById('mf-edit-client-id').value = id || '';

            // Reset tous les champs
            ['mf-edit-company', 'mf-edit-lastname', 'mf-edit-firstname', 'mf-edit-address', 'mf-edit-zip', 'mf-edit-city', 'mf-edit-mobile', 'mf-edit-phone', 'mf-edit-email', 'mf-edit-allergies', 'mf-edit-notes'].forEach(fieldId => {
                const el = document.getElementById(fieldId);
                if (el) el.value = '';
            });
            document.getElementById('mf-edit-active').checked = true;

            if (id) {
                const client = (QOData?.clients || []).find(c => c.id === id);
                if (client) {
                    const clientType = (client.clientType || 'b2b').toLowerCase();
                    setMFEditClientType(clientType);

                    // Pour B2B, le nom de soci√©t√© est dans "name"
                    if (clientType === 'b2b') {
                        document.getElementById('mf-edit-company').value = client.name || '';
                        document.getElementById('mf-edit-lastname').value = client.contact || client.lastname || '';
                        document.getElementById('mf-edit-firstname').value = client.firstname || '';
                    } else {
                        document.getElementById('mf-edit-lastname').value = client.lastname || '';
                        document.getElementById('mf-edit-firstname').value = client.firstname || '';
                    }

                    document.getElementById('mf-edit-address').value = client.address || '';
                    document.getElementById('mf-edit-zip').value = client.zip || '';
                    document.getElementById('mf-edit-city').value = client.city || '';
                    document.getElementById('mf-edit-mobile').value = client.mobile || '';
                    document.getElementById('mf-edit-phone').value = client.phone || '';
                    document.getElementById('mf-edit-email').value = client.email || '';
                    document.getElementById('mf-edit-allergies').value = client.allergies || '';
                    document.getElementById('mf-edit-notes').value = client.notes || '';
                    document.getElementById('mf-edit-active').checked = client.active !== false;
                }
            } else {
                // Nouveau client - par d√©faut B2C
                setMFEditClientType('b2c');
            }

            modal.style.display = 'flex';
        }

        function editMFClient(id) {
            showMFClientForm(id);
        }

        function closeMFClientForm() {
            document.getElementById('mf-client-form-modal').style.display = 'none';
        }

        function saveMFClient() {
            const id = document.getElementById('mf-edit-client-id').value;
            const clientType = document.getElementById('mf-edit-client-type').value.toUpperCase();
            const isB2B = clientType === 'B2B';

            const company = document.getElementById('mf-edit-company').value.trim();
            const lastname = document.getElementById('mf-edit-lastname').value.trim();
            const mobile = document.getElementById('mf-edit-mobile').value.trim();
            const city = document.getElementById('mf-edit-city').value.trim();

            // Validation selon le type
            if (isB2B) {
                if (!company) { alert('Le nom de la soci√©t√© est requis'); return; }
            } else {
                if (!lastname) { alert('Le nom est requis'); return; }
            }
            if (!mobile) { alert('Le t√©l√©phone portable est requis'); return; }
            if (!city) { alert('Le lieu est requis'); return; }

            const clientData = {
                clientType: clientType,
                // Pour B2B : name = soci√©t√©, contact = personne
                // Pour B2C : lastname/firstname = personne
                name: isB2B ? company : '',
                contact: isB2B ? lastname : '',
                lastname: isB2B ? '' : lastname,
                firstname: document.getElementById('mf-edit-firstname').value.trim(),
                address: document.getElementById('mf-edit-address').value.trim(),
                zip: document.getElementById('mf-edit-zip').value.trim(),
                city: city,
                mobile: mobile,
                phone: document.getElementById('mf-edit-phone').value.trim(),
                email: document.getElementById('mf-edit-email').value.trim(),
                allergies: document.getElementById('mf-edit-allergies').value.trim(),
                notes: document.getElementById('mf-edit-notes').value.trim(),
                active: document.getElementById('mf-edit-active').checked
            };

            if (id) {
                const idx = QOData.clients.findIndex(c => c.id == id);
                if (idx >= 0) {
                    QOData.clients[idx] = { ...QOData.clients[idx], ...clientData };
                }
            } else {
                clientData.id = Date.now();
                QOData.clients.push(clientData);
            }

            localStorage.setItem('qo_clients', JSON.stringify(QOData.clients));
            closeMFClientForm();
            renderMFClientsTable();
        }

        function showMFStoresModal() {
            renderMFStoresTable();
            document.getElementById('mf-stores-modal').style.display = 'flex';
        }

        function closeMFStoresModal() {
            document.getElementById('mf-stores-modal').style.display = 'none';
        }

        function renderMFStoresTable() {
            const tbody = document.getElementById('mf-stores-tbody');
            tbody.innerHTML = MFData.stores.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.address || '-'}</td>
                    <td>${s.email || '-'}</td>
                    <td>${s.phone || '-'}</td>
                    <td>
                        <button onclick="editMFStore(${s.id})" style="padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">‚úèÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function showMFStoreForm(id = null) {
            document.getElementById('mf-store-form-title').textContent = id ? 'üè™ Modifier magasin' : 'üè™ Nouveau magasin';
            document.getElementById('mf-edit-store-id').value = id || '';

            // Jours par d√©faut
            const defaultHours = {
                mon: { open: true, start: '08:00', end: '18:00' },
                tue: { open: true, start: '08:00', end: '18:00' },
                wed: { open: true, start: '08:00', end: '18:00' },
                thu: { open: true, start: '08:00', end: '18:00' },
                fri: { open: true, start: '08:00', end: '18:00' },
                sat: { open: true, start: '08:00', end: '12:00' },
                sun: { open: false, start: '09:00', end: '12:00' }
            };

            if (id) {
                const store = MFData.stores.find(s => s.id === id);
                if (store) {
                    document.getElementById('mf-edit-store-name').value = store.name || '';
                    document.getElementById('mf-edit-store-address').value = store.address || '';
                    document.getElementById('mf-edit-store-email').value = store.email || '';
                    document.getElementById('mf-edit-store-phone').value = store.phone || '';
                    document.getElementById('mf-edit-store-slot').value = store.slotDuration || '60';

                    // Charger les horaires
                    const hours = store.hours || defaultHours;
                    ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].forEach(day => {
                        const dayHours = hours[day] || defaultHours[day];
                        document.getElementById(`mf-hour-${day}-open`).checked = dayHours.open;
                        document.getElementById(`mf-hour-${day}-start`).value = dayHours.start || '08:00';
                        document.getElementById(`mf-hour-${day}-end`).value = dayHours.end || '18:00';
                        toggleMFDayHours(day);
                    });

                    // Charger les jours exceptionnels
                    renderMFExceptionalDays(store.exceptionalDays || []);
                }
            } else {
                // Reset form
                ['mf-edit-store-name', 'mf-edit-store-address', 'mf-edit-store-email', 'mf-edit-store-phone'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                document.getElementById('mf-edit-store-slot').value = '60';

                // Reset horaires par d√©faut
                ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].forEach(day => {
                    const dayHours = defaultHours[day];
                    document.getElementById(`mf-hour-${day}-open`).checked = dayHours.open;
                    document.getElementById(`mf-hour-${day}-start`).value = dayHours.start;
                    document.getElementById(`mf-hour-${day}-end`).value = dayHours.end;
                    toggleMFDayHours(day);
                });

                // Reset jours exceptionnels
                renderMFExceptionalDays([]);
            }

            document.getElementById('mf-store-form-modal').style.display = 'flex';
        }

        function editMFStore(id) {
            showMFStoreForm(id);
        }

        function closeMFStoreForm() {
            document.getElementById('mf-store-form-modal').style.display = 'none';
        }

        // Toggle affichage horaires jour
        function toggleMFDayHours(day) {
            const isOpen = document.getElementById(`mf-hour-${day}-open`).checked;
            const timesDiv = document.getElementById(`mf-hour-${day}-times`);
            const closedSpan = document.getElementById(`mf-hour-${day}-closed`);

            if (timesDiv) timesDiv.style.display = isOpen ? 'flex' : 'none';
            if (closedSpan) closedSpan.style.display = isOpen ? 'none' : 'inline';
        }

        // Jours exceptionnels
        let mfExceptionalDays = [];

        function renderMFExceptionalDays(days) {
            mfExceptionalDays = days || [];
            const container = document.getElementById('mf-exceptional-days');
            const noExceptional = document.getElementById('mf-no-exceptional');

            if (mfExceptionalDays.length === 0) {
                container.innerHTML = '';
                noExceptional.style.display = 'block';
                return;
            }

            noExceptional.style.display = 'none';
            container.innerHTML = mfExceptionalDays.map((day, idx) => `
                <div style="display:flex; align-items:center; gap:8px; padding:10px; background:var(--bg-card); border-radius:8px; flex-wrap:wrap;">
                    <input type="date" value="${day.date}" onchange="updateMFExceptionalDay(${idx}, 'date', this.value)"
                        style="padding:6px 10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                    <input type="text" value="${day.label || ''}" placeholder="Libell√© (ex: No√´l)" onchange="updateMFExceptionalDay(${idx}, 'label', this.value)"
                        style="flex:1; min-width:100px; padding:6px 10px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:12px;">
                    <label style="display:flex; align-items:center; gap:4px; font-size:11px;">
                        <input type="checkbox" ${day.closed ? 'checked' : ''} onchange="updateMFExceptionalDay(${idx}, 'closed', this.checked)">
                        Ferm√©
                    </label>
                    <div style="display:${day.closed ? 'none' : 'flex'}; align-items:center; gap:4px;" id="mf-exc-times-${idx}">
                        <input type="time" value="${day.start || '09:00'}" onchange="updateMFExceptionalDay(${idx}, 'start', this.value)"
                            style="padding:4px 6px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:11px;">
                        <span style="font-size:11px;">√†</span>
                        <input type="time" value="${day.end || '17:00'}" onchange="updateMFExceptionalDay(${idx}, 'end', this.value)"
                            style="padding:4px 6px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:4px; color:var(--text-primary); font-size:11px;">
                    </div>
                    <button onclick="removeMFExceptionalDay(${idx})" style="padding:4px 8px; background:var(--accent-danger)20; border:1px solid var(--accent-danger); border-radius:4px; color:var(--accent-danger); cursor:pointer; font-size:12px;">‚úï</button>
                </div>
            `).join('');
        }

        function addMFExceptionalDay() {
            const today = new Date().toISOString().split('T')[0];
            mfExceptionalDays.push({
                date: today,
                label: '',
                closed: false,
                start: '09:00',
                end: '17:00'
            });
            renderMFExceptionalDays(mfExceptionalDays);
        }

        function updateMFExceptionalDay(idx, field, value) {
            if (mfExceptionalDays[idx]) {
                mfExceptionalDays[idx][field] = value;
                // Si on change closed, re-render pour afficher/masquer les heures
                if (field === 'closed') {
                    renderMFExceptionalDays(mfExceptionalDays);
                }
            }
        }

        function removeMFExceptionalDay(idx) {
            mfExceptionalDays.splice(idx, 1);
            renderMFExceptionalDays(mfExceptionalDays);
        }

        function saveMFStore() {
            const id = document.getElementById('mf-edit-store-id').value;
            const name = document.getElementById('mf-edit-store-name').value.trim();
            const email = document.getElementById('mf-edit-store-email').value.trim();

            if (!name) { alert('Le nom est requis'); return; }
            if (!email) { alert('L\'email est requis pour l\'envoi des confirmations'); return; }

            // Collecter les horaires
            const hours = {};
            ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].forEach(day => {
                hours[day] = {
                    open: document.getElementById(`mf-hour-${day}-open`).checked,
                    start: document.getElementById(`mf-hour-${day}-start`).value,
                    end: document.getElementById(`mf-hour-${day}-end`).value
                };
            });

            const storeData = {
                name,
                address: document.getElementById('mf-edit-store-address').value.trim(),
                email,
                phone: document.getElementById('mf-edit-store-phone').value.trim(),
                slotDuration: parseInt(document.getElementById('mf-edit-store-slot').value) || 60,
                hours,
                exceptionalDays: mfExceptionalDays.filter(d => d.date) // Filtrer les jours vides
            };

            if (id) {
                const idx = MFData.stores.findIndex(s => s.id == id);
                if (idx >= 0) {
                    MFData.stores[idx] = { ...MFData.stores[idx], ...storeData };
                }
            } else {
                storeData.id = Date.now();
                MFData.stores.push(storeData);
            }

            saveMFData('stores');
            closeMFStoreForm();
            renderMFStoresTable();
            renderMFStoresTiles();
        }

        function showMFOrderDetail(orderId) {
            const order = MFData.orders.find(o => o.id === orderId);
            if (!order) return;

            const client = (QOData?.clients || []).find(c => c.id === order.clientId);
            const store = MFData.stores.find(s => s.id === order.storeId);

            document.getElementById('mf-detail-order-id').textContent = '#' + order.id;
            document.getElementById('mf-order-detail-content').innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div style="padding:16px; background:var(--bg-primary); border-radius:10px;">
                        <h4 style="color:var(--accent-primary); margin-bottom:10px;">üë§ Client</h4>
                        <div><strong>${client?.lastname || ''} ${client?.firstname || ''}</strong></div>
                        <div style="font-size:13px; color:var(--text-muted);">üìû ${client?.mobile || client?.phone || '-'}</div>
                        <div style="font-size:13px; color:var(--text-muted);">üìß ${client?.email || '-'}</div>
                    </div>
                    <div style="padding:16px; background:var(--bg-primary); border-radius:10px;">
                        <h4 style="color:var(--accent-primary); margin-bottom:10px;">üìç Retrait</h4>
                        <div><strong>${store?.name || ''}</strong></div>
                        <div style="font-size:13px; color:var(--text-muted);">${store?.address || ''}</div>
                        <div style="margin-top:8px; font-weight:600;">üìÖ ${formatDate(order.pickupDate)} √† ${order.pickupTime}</div>
                    </div>
                </div>
                <div style="background:var(--bg-primary); border-radius:10px; overflow:hidden; margin-bottom:20px;">
                    <table style="width:100%;">
                        <thead style="background:var(--bg-hover);"><tr><th style="padding:12px;">Article</th><th style="padding:12px; text-align:center;">Qt√©</th><th style="padding:12px; text-align:right;">Total</th></tr></thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr><td style="padding:12px;">${item.name}</td><td style="padding:12px; text-align:center;">${item.qty} ${item.unit}</td><td style="padding:12px; text-align:right;">${(item.price * item.qty).toFixed(2)} CHF</td></tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="text-align:right; font-size:13px;">
                    <div>Sous-total: ${order.subtotal.toFixed(2)} CHF</div>
                    <div>TVA (2.6%): ${order.tva.toFixed(2)} CHF</div>
                    <div style="font-size:20px; font-weight:700; color:var(--accent-primary); margin-top:8px;">TOTAL: ${order.total.toFixed(2)} CHF</div>
                </div>
                ${order.notes ? `<div style="margin-top:16px; padding:12px; background:var(--bg-primary); border-radius:8px;"><strong>üìù Notes:</strong> ${order.notes}</div>` : ''}
            `;

            const statusOptions = ['pending', 'confirmed', 'ready', 'delivered'];
            const currentIdx = statusOptions.indexOf(order.status);
            const nextStatus = statusOptions[currentIdx + 1];
            const statusLabels = { pending: 'En attente', confirmed: 'Confirm√©e', ready: 'Pr√™te', delivered: 'Remise' };

            document.getElementById('mf-order-detail-actions').innerHTML = `
                <button onclick="printMFOrderById(${order.id})" class="btn btn-secondary">üñ®Ô∏è Imprimer</button>
                ${nextStatus ? `<button onclick="updateMFOrderStatus(${order.id}, '${nextStatus}')" class="btn btn-primary">‚úÖ Marquer comme ${statusLabels[nextStatus]}</button>` : ''}
            `;

            document.getElementById('mf-order-detail-modal').style.display = 'flex';
        }

        function closeMFOrderDetail() {
            document.getElementById('mf-order-detail-modal').style.display = 'none';
        }

        function updateMFOrderStatus(orderId, newStatus) {
            const order = MFData.orders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                saveMFData('orders');
                closeMFOrderDetail();
                initMFDashboard();
            }
        }

        // Init MyFish
        function initMyFish() {
            initMFDashboard();
        }

        // Auto-init when MyFish tab is clicked
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.dataset.page === 'myfish') {
                    setTimeout(initMyFish, 100);
                }
            });
        });

        // ========================================
        // SYST√àME DE GESTION DES UTILISATEURS
        // ========================================

        // ===== VERSION DE L'APPLICATION =====
        const APP_VERSION = '3.2.7';
        const APP_VERSION_DATE = '2025-12-02';
        
        // ===== UTILISATEURS PAR D√âFAUT =====
        (function initDefaultUsers() {
            let users = JSON.parse(localStorage.getItem('trakio_users') || '[]');
            
            // V√©rifier si les IDs sont des strings (ancien format) - migration n√©cessaire

        // ===== INITIALISATION =====
        document.addEventListener('DOMContentLoaded', function() {
            loadSharedData();
            initMFSampleData();
            initMFDashboard();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO v4.5.0 - MyFish</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõí</text></svg>">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="trakio-config.js?v=4.5.0"></script>
    <script src="trakio-sync.js?v=4.5.0"></script>
    <script src="trakio-ui.js?v=4.5.0"></script>
    <style>
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .page-title { font-size: 26px; font-weight: 700; margin-bottom: 24px; }
        .myfish-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        @media (max-width: 1000px) { .myfish-layout { grid-template-columns: 1fr; } }
        .card { background: var(--trakio-bg-card); border: 1px solid var(--trakio-border); border-radius: 16px; padding: 20px; }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .search-box { position: relative; margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 14px 15px 14px 45px; background: var(--trakio-bg-input); border: 1px solid var(--trakio-border); border-radius: 10px; color: var(--trakio-text); font-size: 14px; }
        .search-box::before { content: 'üîç'; position: absolute; left: 15px; top: 50%; transform: translateY(-50%); }
        .articles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; max-height: 500px; overflow-y: auto; }
        .article-btn { padding: 20px 15px; background: var(--trakio-bg-input); border: 2px solid var(--trakio-border); border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s; }
        .article-btn:hover { border-color: var(--trakio-primary); background: var(--trakio-bg-hover); }
        .article-btn.selected { border-color: var(--trakio-primary); background: rgba(14, 165, 233, 0.1); }
        .article-icon { font-size: 28px; margin-bottom: 8px; }
        .article-name { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .article-price { font-size: 12px; color: var(--trakio-success); }
        .cart-items { max-height: 300px; overflow-y: auto; margin-bottom: 20px; }
        .cart-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--trakio-bg-input); border-radius: 10px; margin-bottom: 10px; }
        .cart-item-info { flex: 1; }
        .cart-item-name { font-weight: 600; font-size: 14px; }
        .cart-item-price { font-size: 12px; color: var(--trakio-text-muted); }
        .cart-item-qty { display: flex; align-items: center; gap: 8px; }
        .qty-btn { width: 28px; height: 28px; border: none; border-radius: 6px; background: var(--trakio-bg-hover); color: var(--trakio-text); cursor: pointer; font-size: 16px; }
        .qty-input { width: 50px; text-align: center; padding: 6px; background: var(--trakio-bg-card); border: 1px solid var(--trakio-border); border-radius: 6px; color: var(--trakio-text); }
        .cart-item-total { font-weight: 700; color: var(--trakio-success); min-width: 70px; text-align: right; }
        .cart-remove { background: none; border: none; color: var(--trakio-error); cursor: pointer; font-size: 16px; }
        .cart-summary { padding: 15px; background: var(--trakio-bg-input); border-radius: 10px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .summary-total { font-size: 24px; font-weight: 700; color: var(--trakio-success); border-top: 1px solid var(--trakio-border); padding-top: 12px; margin-top: 8px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; margin-top: 10px; }
        .btn-primary { background: var(--trakio-primary); color: white; }
        .btn-success { background: var(--trakio-success); color: white; }
        .empty-cart { text-align: center; padding: 40px; color: var(--trakio-text-muted); }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title">üõí MyFish - Vente rapide</h1>
        <div class="myfish-layout">
            <div class="card">
                <h3 class="card-title">üì¶ Articles</h3>
                <div class="search-box"><input type="text" id="search" placeholder="Rechercher un article..." oninput="filterArticles()"></div>
                <div class="articles-grid" id="articles-grid"></div>
            </div>
            <div class="card">
                <h3 class="card-title">üßæ Panier</h3>
                <div class="cart-items" id="cart-items"><div class="empty-cart">Panier vide</div></div>
                <div class="cart-summary">
                    <div class="summary-row"><span>Sous-total</span><span id="subtotal">CHF 0.00</span></div>
                    <div class="summary-row"><span>TVA (2.6%)</span><span id="tva">CHF 0.00</span></div>
                    <div class="summary-row summary-total"><span>Total</span><span id="total">CHF 0.00</span></div>
                </div>
                <button class="btn btn-success" onclick="checkout()">üí≥ Encaisser</button>
                <button class="btn btn-primary" onclick="clearCart()">üóëÔ∏è Vider le panier</button>
            </div>
        </div>
    </div>
    <script>
        let articlesData = [], cart = [];
        document.addEventListener('DOMContentLoaded', () => setTimeout(loadArticles, 300));
        async function loadArticles() { articlesData = await DataStore.articles.getAll(); renderArticles(); }
        function filterArticles() { renderArticles(); }
        function renderArticles() {
            const search = document.getElementById('search').value.toLowerCase();
            const filtered = articlesData.filter(a => !search || a.name.toLowerCase().includes(search));
            document.getElementById('articles-grid').innerHTML = filtered.map(a => '<div class="article-btn" onclick="addToCart(\''+a.id+'\')"><div class="article-icon">üêü</div><div class="article-name">'+a.name+'</div><div class="article-price">'+formatCHF(a.price)+'/kg</div></div>').join('') || '<div class="empty-cart">Aucun article</div>';
        }
        function addToCart(id) {
            const article = articlesData.find(a => a.id === id);
            if (!article) return;
            const existing = cart.find(i => i.id === id);
            if (existing) { existing.qty += 0.5; } else { cart.push({ id, name: article.name, price: article.price || 0, qty: 0.5 }); }
            renderCart();
        }
        function updateQty(id, delta) {
            const item = cart.find(i => i.id === id);
            if (item) { item.qty = Math.max(0.1, item.qty + delta); if (item.qty <= 0) removeFromCart(id); else renderCart(); }
        }
        function setQty(id, qty) {
            const item = cart.find(i => i.id === id);
            if (item) { item.qty = parseFloat(qty) || 0.1; renderCart(); }
        }
        function removeFromCart(id) { cart = cart.filter(i => i.id !== id); renderCart(); }
        function renderCart() {
            const container = document.getElementById('cart-items');
            if (cart.length === 0) { container.innerHTML = '<div class="empty-cart">Panier vide</div>'; } else {
                container.innerHTML = cart.map(i => '<div class="cart-item"><div class="cart-item-info"><div class="cart-item-name">'+i.name+'</div><div class="cart-item-price">'+formatCHF(i.price)+'/kg</div></div><div class="cart-item-qty"><button class="qty-btn" onclick="updateQty(\''+i.id+'\', -0.1)">-</button><input type="number" class="qty-input" value="'+i.qty.toFixed(1)+'" onchange="setQty(\''+i.id+'\', this.value)"><button class="qty-btn" onclick="updateQty(\''+i.id+'\', 0.1)">+</button></div><div class="cart-item-total">'+formatCHF(i.price * i.qty)+'</div><button class="cart-remove" onclick="removeFromCart(\''+i.id+'\')">√ó</button></div>').join('');
            }
            updateTotals();
        }
        function updateTotals() {
            const subtotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const tva = subtotal * 0.026;
            document.getElementById('subtotal').textContent = formatCHF(subtotal);
            document.getElementById('tva').textContent = formatCHF(tva);
            document.getElementById('total').textContent = formatCHF(subtotal + tva);
        }
        function clearCart() { cart = []; renderCart(); }
        async function checkout() {
            if (cart.length === 0) { TrakioUI.showToast('‚ùå Panier vide', 'error'); return; }
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const data = { items: cart.map(i => ({ articleId: i.id, name: i.name, quantity: i.qty, price: i.price })), subtotal: total, tva: total * 0.026, total: total * 1.026, source: 'myfish', status: 'paid' };
            await DataStore.ventes.save(null, data);
            TrakioUI.showToast('‚úÖ Vente enregistr√©e: ' + formatCHF(data.total), 'success');
            clearCart();
        }
    </script>
</body>
</html>

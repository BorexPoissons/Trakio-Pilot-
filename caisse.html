<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caisse - TRAKIO v5.0.4</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêü</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (optionnel - mode offline first) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --border: #475569;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --primary: #06b6d4;
            --primary-hover: #22d3ee;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --purple: #8b5cf6;
            --gradient: linear-gradient(135deg, #06b6d4, #14b8a6);
        }
        
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }
        
        /* ============================================
           HEADER COMPACT v5.0.4
        ============================================ */
        .main-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0 16px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--text);
        }
        
        .logo-icon { font-size: 22px; }
        .logo-text { 
            font-size: 16px; 
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-center {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .event-config {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 14px;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .event-config:hover { background: var(--border); }
        
        .event-name {
            font-weight: 600;
            font-size: 14px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .event-date {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .event-badge {
            padding: 3px 8px;
            background: var(--gradient);
            color: white;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-input);
            border-radius: 20px;
            font-size: 12px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.online { background: var(--success); }
        .status-dot.offline { background: var(--warning); }
        
        .header-btn {
            padding: 8px 14px;
            background: var(--bg-input);
            border: none;
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .header-btn:hover { background: var(--border); }
        .header-btn.primary { background: var(--gradient); color: white; }
        
        /* ============================================
           LAYOUT 3 COLONNES
        ============================================ */
        .pos-container {
            display: grid;
            grid-template-columns: 1fr 90px 400px;
            gap: 12px;
            height: calc(100vh - 50px);
            padding: 12px;
            overflow: hidden;
        }
        
        @media (max-width: 1200px) {
            .pos-container {
                grid-template-columns: 1fr 80px 340px;
            }
        }
        
        @media (max-width: 900px) {
            .pos-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: auto;
                overflow: auto;
            }
            
            .categories-col {
                display: flex !important;
                flex-direction: row !important;
                overflow-x: auto;
                gap: 8px;
                padding: 10px 0;
                order: 1;
            }
            
            .articles-col { order: 2; }
            .ticket-col { order: 3; }
            
            .category-btn {
                min-width: 70px;
                height: auto !important;
                padding: 10px !important;
            }
        }
        
        /* ============================================
           COLONNE ARTICLES
        ============================================ */
        .articles-col {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .col-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(20, 184, 166, 0.05));
        }
        
        .col-title {
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .col-badge {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
        }
        
        .search-input {
            width: calc(100% - 24px);
            margin: 12px;
            padding: 10px 14px 10px 38px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }
        
        .search-wrapper {
            position: relative;
        }
        
        .search-wrapper::before {
            content: 'üîç';
            position: absolute;
            left: 24px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }
        
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
            padding: 12px;
            overflow-y: auto;
            flex: 1;
        }
        
        .article-btn {
            background: var(--bg-input);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 14px 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            position: relative;
        }
        
        .article-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.2);
        }
        
        .article-btn:active { transform: scale(0.98); }
        
        .article-icon { font-size: 26px; margin-bottom: 6px; }
        
        .article-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .article-origin {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        .article-price {
            font-size: 14px;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .article-unit {
            font-size: 10px;
            color: var(--text-muted);
        }
        
        /* ============================================
           COLONNE CAT√âGORIES
        ============================================ */
        .categories-col {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .category-btn {
            height: 65px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
            color: white;
            font-weight: 600;
            font-size: 10px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .category-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .category-btn.active {
            box-shadow: 0 0 0 3px white, 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .category-btn span:first-child { font-size: 20px; }
        
        .cat-all { background: linear-gradient(135deg, #64748b, #475569); }
        .cat-favoris { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .cat-poissons { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
        .cat-crustaces { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .cat-coquillages { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .cat-fumes { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .cat-traiteur { background: linear-gradient(135deg, #10b981, #059669); }
        .cat-epicerie { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        
        /* ============================================
           COLONNE TICKET
        ============================================ */
        .ticket-col {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .ticket-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(20, 184, 166, 0.05));
        }
        
        .ticket-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ticket-count {
            background: var(--gradient);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .ticket-items {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .ticket-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .ticket-item-info { flex: 1; min-width: 0; }
        
        .ticket-item-name {
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .ticket-item-details {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .ticket-item-price {
            font-weight: 600;
            color: var(--success);
            white-space: nowrap;
        }
        
        .qty-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .qty-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            background: var(--bg-dark);
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .qty-btn:hover { background: var(--primary); }
        
        .qty-value {
            min-width: 28px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }
        
        .remove-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 16px;
        }
        
        .remove-btn:hover { background: rgba(239, 68, 68, 0.2); }
        
        /* TICKET TOTAUX */
        .ticket-totals {
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
        }
        
        .total-row.subtotal { color: var(--text-muted); }
        .total-row.discount { color: var(--error); }
        .total-row.redevance { color: var(--warning); }
        
        .total-row.grand-total {
            font-size: 22px;
            font-weight: 700;
            padding: 12px 0;
            border-top: 2px solid var(--border);
            margin-top: 10px;
        }
        
        .total-row.grand-total span:last-child {
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .discount-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }
        
        .discount-input label {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .discount-input input {
            width: 70px;
            padding: 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            text-align: center;
            font-family: inherit;
        }
        
        /* BOUTONS PAIEMENT */
        .payment-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 12px;
            border-top: 1px solid var(--border);
        }
        
        .pay-btn {
            padding: 14px 8px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            font-family: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        
        .pay-btn:hover { transform: translateY(-2px); }
        
        .pay-btn.cash { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .pay-btn.card { background: linear-gradient(135deg, var(--primary), #0284c7); color: white; }
        .pay-btn.twint { background: #000; color: white; }
        
        .pay-btn span:first-child { font-size: 22px; }
        
        .clear-btn {
            grid-column: 1 / -1;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            font-weight: 500;
            font-family: inherit;
        }
        
        .clear-btn:hover { background: var(--error); border-color: var(--error); }
        
        /* EMPTY STATE */
        .empty-ticket {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            padding: 40px;
            text-align: center;
        }
        
        .empty-ticket-icon {
            font-size: 50px;
            margin-bottom: 12px;
            opacity: 0.3;
        }
        
        /* ============================================
           MODALES
        ============================================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(20, 184, 166, 0.1));
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-body { padding: 20px; }
        
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            background: var(--bg-dark);
        }
        
        .modal-footer button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .modal-footer .cancel { background: var(--bg-input); color: var(--text); }
        .modal-footer .confirm { background: var(--gradient); color: white; }
        
        /* PES√âE */
        .weight-display {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .weight-value {
            font-size: 44px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .weight-unit { font-size: 18px; color: var(--text-muted); }
        
        .weight-info {
            text-align: center;
            margin-bottom: 16px;
            color: var(--text-muted);
            font-size: 14px;
        }
        
        .weight-info strong { color: var(--text); }
        .weight-info .total { color: var(--success); font-size: 18px; }
        
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .numpad-btn {
            padding: 18px;
            font-size: 22px;
            font-weight: 600;
            background: var(--bg-input);
            border: none;
            border-radius: 10px;
            color: var(--text);
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }
        
        .numpad-btn:hover { background: var(--border); }
        .numpad-btn.clear { background: var(--error); color: white; }
        
        /* FORMULAIRE MANIFESTATION */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .redevance-preview {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 14px;
            margin-top: 16px;
        }
        
        .redevance-preview h4 {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        
        .redevance-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
        }
        
        .redevance-item.highlight {
            font-size: 16px;
            font-weight: 700;
            color: var(--success);
            padding-top: 10px;
            border-top: 1px solid var(--border);
            margin-top: 6px;
        }
        
        /* RAPPORT */
        .modal-large {
            max-width: 600px;
        }
        
        .report-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .report-stat {
            background: var(--bg-dark);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        
        .report-stat-value {
            font-size: 26px;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .report-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .report-breakdown {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 16px;
        }
        
        .report-breakdown h4 {
            font-size: 14px;
            margin-bottom: 12px;
            color: var(--text-muted);
        }
        
        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }
        
        .breakdown-row:last-child { border-bottom: none; }
        
        .breakdown-row.total {
            font-size: 18px;
            font-weight: 700;
            color: var(--success);
            padding-top: 12px;
            margin-top: 8px;
            border-top: 2px solid var(--border);
            border-bottom: none;
        }
        
        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 14px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 20000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .notification.show { transform: translateX(0); }
        .notification.success { background: var(--success); }
        .notification.error { background: var(--error); }
        .notification.warning { background: var(--warning); }
        
        /* MODAL ARTICLES */
        .modal-articles {
            max-width: 700px;
            max-height: 90vh;
        }
        
        .articles-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .articles-tab {
            flex: 1;
            padding: 10px;
            background: var(--bg-input);
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .articles-tab.active {
            background: var(--gradient);
            color: white;
        }
        
        .articles-list {
            max-height: 350px;
            overflow-y: auto;
            margin-bottom: 16px;
        }
        
        .article-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .article-list-item:hover {
            background: var(--bg-input);
        }
        
        .article-list-fav {
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .article-list-fav:hover {
            transform: scale(1.2);
        }
        
        .article-list-info {
            flex: 1;
        }
        
        .article-list-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .article-list-details {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .article-list-price {
            font-weight: 700;
            color: var(--success);
            font-size: 14px;
        }
        
        .article-list-actions {
            display: flex;
            gap: 6px;
        }
        
        .article-list-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .article-list-btn:hover {
            background: var(--primary);
        }
        
        .article-list-btn.delete:hover {
            background: var(--error);
        }
        
        /* FORM ARTICLE */
        .article-form {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 2px solid var(--primary);
        }
        
        .article-form-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary);
        }
        
        .article-form-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .article-form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .article-form input,
        .article-form select {
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-family: inherit;
        }
        
        .article-form input:focus,
        .article-form select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .article-form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .article-form-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .article-form-btn.cancel {
            background: var(--bg-input);
            color: var(--text);
        }
        
        .article-form-btn.save {
            background: var(--gradient);
            color: white;
        }
        
        .empty-articles {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .empty-articles-icon {
            font-size: 40px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="main-header">
        <div class="header-left">
            <a href="index.html" class="logo">
                <span class="logo-icon">üêü</span>
                <span class="logo-text">TRAKIO</span>
            </a>
        </div>
        
        <div class="header-center">
            <div class="event-config" onclick="openEventModal()">
                <span>üìç</span>
                <div>
                    <div class="event-name" id="displayEventName">Magasin</div>
                    <div class="event-date" id="displayEventDate">-</div>
                </div>
                <span class="event-badge" id="displayRedevance">0%</span>
            </div>
        </div>
        
        <div class="header-right">
            <div class="status-badge">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Hors ligne</span>
            </div>
            <button class="header-btn" onclick="openArticlesModal()">‚öôÔ∏è Articles</button>
            <button class="header-btn" onclick="openReportModal()">üìä Rapport</button>
            <button class="header-btn" onclick="syncData()">üîÑ Sync</button>
        </div>
    </header>
    
    <!-- CONTAINER 3 COLONNES -->
    <div class="pos-container">
        <!-- COLONNE ARTICLES -->
        <div class="articles-col">
            <div class="col-header">
                <span class="col-title">
                    üêü Articles
                    <span class="col-badge" id="articles-count">(0)</span>
                </span>
            </div>
            <div class="search-wrapper">
                <input type="text" class="search-input" placeholder="Rechercher..." id="searchArticle" oninput="filterArticles()">
            </div>
            <div class="articles-grid" id="articles-grid">
                <!-- Articles dynamiques -->
            </div>
        </div>
        
        <!-- COLONNE CAT√âGORIES -->
        <div class="categories-col">
            <button class="category-btn cat-favoris" onclick="selectCategory('favoris')" data-cat="favoris">
                <span>‚≠ê</span>
                <span>Favoris</span>
            </button>
            <button class="category-btn cat-all active" onclick="selectCategory('')" data-cat="">
                <span>üì¶</span>
                <span>Tous</span>
            </button>
            <button class="category-btn cat-poissons" onclick="selectCategory('poissons')" data-cat="poissons">
                <span>üêü</span>
                <span>Poissons</span>
            </button>
            <button class="category-btn cat-crustaces" onclick="selectCategory('crustaces')" data-cat="crustaces">
                <span>ü¶ê</span>
                <span>Crustac√©s</span>
            </button>
            <button class="category-btn cat-coquillages" onclick="selectCategory('coquillages')" data-cat="coquillages">
                <span>ü¶™</span>
                <span>Coquillages</span>
            </button>
            <button class="category-btn cat-fumes" onclick="selectCategory('fumes')" data-cat="fumes">
                <span>üî•</span>
                <span>Fum√©s</span>
            </button>
            <button class="category-btn cat-traiteur" onclick="selectCategory('traiteur')" data-cat="traiteur">
                <span>üçΩÔ∏è</span>
                <span>Traiteur</span>
            </button>
            <button class="category-btn cat-epicerie" onclick="selectCategory('epicerie')" data-cat="epicerie">
                <span>üõí</span>
                <span>√âpicerie</span>
            </button>
        </div>
        
        <!-- COLONNE TICKET -->
        <div class="ticket-col">
            <div class="ticket-header">
                <div class="ticket-title-row">
                    <span class="col-title">üßæ Ticket</span>
                    <span class="ticket-count" id="ticket-count">0 article</span>
                </div>
            </div>
            
            <div class="ticket-items" id="ticket-items">
                <div class="empty-ticket">
                    <div class="empty-ticket-icon">üõí</div>
                    <p>Ticket vide</p>
                    <p style="font-size: 12px; margin-top: 5px;">Cliquez sur un article pour l'ajouter</p>
                </div>
            </div>
            
            <div class="ticket-totals">
                <div class="total-row subtotal">
                    <span>Sous-total HT</span>
                    <span id="subtotal-ht">0.00 CHF</span>
                </div>
                <div class="total-row subtotal">
                    <span>TVA (2.6%)</span>
                    <span id="total-tva">0.00 CHF</span>
                </div>
                <div class="discount-input">
                    <label>Remise</label>
                    <input type="number" id="globalDiscount" min="0" value="0" onchange="updateTotals()">
                    <span>CHF</span>
                </div>
                <div class="total-row discount" id="discount-row" style="display: none;">
                    <span>Remise</span>
                    <span id="total-discount">-0.00 CHF</span>
                </div>
                <div class="total-row grand-total">
                    <span>TOTAL</span>
                    <span id="grand-total">0.00 CHF</span>
                </div>
            </div>
            
            <div class="payment-buttons">
                <button class="pay-btn cash" onclick="processPayment('cash')">
                    <span>üíµ</span>
                    <span>Esp√®ces</span>
                </button>
                <button class="pay-btn card" onclick="processPayment('card')">
                    <span>üí≥</span>
                    <span>Carte</span>
                </button>
                <button class="pay-btn twint" onclick="processPayment('twint')">
                    <span>üì±</span>
                    <span>Twint</span>
                </button>
                <button class="clear-btn" onclick="clearTicket()">üóëÔ∏è Vider le ticket</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PES√âE -->
    <div class="modal-overlay" id="weightModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    ‚öñÔ∏è <span id="weight-article-name">Article</span>
                </div>
            </div>
            <div class="modal-body">
                <div class="weight-display">
                    <span class="weight-value" id="weight-value">0.000</span>
                    <span class="weight-unit">kg</span>
                </div>
                <div class="weight-info">
                    Prix: <strong id="weight-price">0.00 CHF/kg</strong> = 
                    <strong class="total" id="weight-total">0.00 CHF</strong>
                </div>
                <div class="numpad">
                    <button class="numpad-btn" onclick="numpadInput('1')">1</button>
                    <button class="numpad-btn" onclick="numpadInput('2')">2</button>
                    <button class="numpad-btn" onclick="numpadInput('3')">3</button>
                    <button class="numpad-btn" onclick="numpadInput('4')">4</button>
                    <button class="numpad-btn" onclick="numpadInput('5')">5</button>
                    <button class="numpad-btn" onclick="numpadInput('6')">6</button>
                    <button class="numpad-btn" onclick="numpadInput('7')">7</button>
                    <button class="numpad-btn" onclick="numpadInput('8')">8</button>
                    <button class="numpad-btn" onclick="numpadInput('9')">9</button>
                    <button class="numpad-btn clear" onclick="numpadInput('C')">C</button>
                    <button class="numpad-btn" onclick="numpadInput('0')">0</button>
                    <button class="numpad-btn" onclick="numpadInput('.')">.</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" onclick="closeWeightModal()">Annuler</button>
                <button class="confirm" onclick="confirmWeight()">‚úì Ajouter</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL √âV√âNEMENT/MANIFESTATION -->
    <div class="modal-overlay" id="eventModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üìç Configuration Manifestation</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nom de la manifestation *</label>
                    <input type="text" id="eventName" placeholder="Ex: March√© de No√´l Nyon">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="eventDate">
                    </div>
                    <div class="form-group">
                        <label>Redevance (%)</label>
                        <input type="number" id="eventRedevance" min="0" max="100" value="0" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Lieu pr√©d√©fini</label>
                    <select id="eventPreset" onchange="applyPreset()">
                        <option value="">-- Personnalis√© --</option>
                        <option value="magasin|0">üè™ Magasin (0%)</option>
                        <option value="marche_nyon|10">üé™ March√© Nyon (10%)</option>
                        <option value="marche_morges|12">üé™ March√© Morges (12%)</option>
                        <option value="fete_nyon|15">üéâ F√™te de Nyon (15%)</option>
                        <option value="livraison|0">üöö Livraison (0%)</option>
                    </select>
                </div>
                
                <div class="redevance-preview" id="redevancePreview" style="display: none;">
                    <h4>üí∞ Simulation redevance</h4>
                    <div class="redevance-item">
                        <span>CA TTC actuel</span>
                        <span id="previewCaTTC">0.00 CHF</span>
                    </div>
                    <div class="redevance-item">
                        <span>CA HT (hors TVA 2.6%)</span>
                        <span id="previewCaHT">0.00 CHF</span>
                    </div>
                    <div class="redevance-item">
                        <span>Redevance (<span id="previewRedevancePercent">0</span>%)</span>
                        <span id="previewRedevanceAmount">-0.00 CHF</span>
                    </div>
                    <div class="redevance-item highlight">
                        <span>√Ä remettre</span>
                        <span id="previewToRemit">0.00 CHF</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" onclick="closeEventModal()">Annuler</button>
                <button class="confirm" onclick="saveEventConfig()">‚úì Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL RAPPORT -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <div class="modal-title">üìä Rapport - <span id="reportEventName">Manifestation</span></div>
            </div>
            <div class="modal-body">
                <div class="report-stats">
                    <div class="report-stat">
                        <div class="report-stat-value" id="reportTxCount">0</div>
                        <div class="report-stat-label">Transactions</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-stat-value" id="reportCaTTC">0 CHF</div>
                        <div class="report-stat-label">CA TTC</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-stat-value" id="reportCaHT">0 CHF</div>
                        <div class="report-stat-label">CA HT</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-stat-value" id="reportArticles">0</div>
                        <div class="report-stat-label">Articles vendus</div>
                    </div>
                </div>
                
                <div class="report-breakdown">
                    <h4>üí≥ R√©partition paiements</h4>
                    <div class="breakdown-row">
                        <span>üíµ Esp√®ces</span>
                        <span id="reportCash">0.00 CHF</span>
                    </div>
                    <div class="breakdown-row">
                        <span>üí≥ Carte</span>
                        <span id="reportCard">0.00 CHF</span>
                    </div>
                    <div class="breakdown-row">
                        <span>üì± Twint</span>
                        <span id="reportTwint">0.00 CHF</span>
                    </div>
                </div>
                
                <div class="report-breakdown" style="margin-top: 16px;" id="redevanceSection">
                    <h4>üí∞ Calcul Redevance</h4>
                    <div class="breakdown-row">
                        <span>CA HT</span>
                        <span id="reportHT">0.00 CHF</span>
                    </div>
                    <div class="breakdown-row">
                        <span>Redevance (<span id="reportRedevancePercent">0</span>%)</span>
                        <span id="reportRedevanceAmount" style="color: var(--error);">-0.00 CHF</span>
                    </div>
                    <div class="breakdown-row total">
                        <span>üíµ √Ä REMETTRE</span>
                        <span id="reportToRemit">0.00 CHF</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" onclick="closeReportModal()">Fermer</button>
                <button class="confirm" onclick="exportReport()">üìÑ Exporter</button>
            </div>
        </div>
    </div>
    
    <!-- NOTIFICATION -->
    <div class="notification" id="notification"></div>
    
    <!-- MODAL GESTION ARTICLES -->
    <div class="modal-overlay" id="articlesModal">
        <div class="modal modal-articles">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Articles Caisse</div>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <div class="articles-tabs">
                    <button class="articles-tab active" onclick="setArticlesTab('list')" data-tab="list">
                        üìã Liste (<span id="articlesCount">0</span>)
                    </button>
                    <button class="articles-tab" onclick="setArticlesTab('favorites')" data-tab="favorites">
                        ‚≠ê Favoris (<span id="favoritesCount">0</span>)
                    </button>
                </div>
                
                <!-- Formulaire ajout/modif -->
                <div class="article-form" id="articleForm" style="display: none;">
                    <div class="article-form-title" id="articleFormTitle">‚ûï Nouvel article</div>
                    <input type="hidden" id="editArticleId">
                    <div class="article-form-grid">
                        <input type="text" id="articleName" placeholder="Nom de l'article *" required>
                        <input type="number" id="articlePrice" placeholder="Prix *" step="0.05" min="0" required>
                        <select id="articleUnit">
                            <option value="kg">kg</option>
                            <option value="pce">pi√®ce</option>
                            <option value="100g">100g</option>
                            <option value="lot">lot</option>
                        </select>
                    </div>
                    <div class="article-form-grid-2">
                        <select id="articleCategory">
                            <option value="poissons">üêü Poissons</option>
                            <option value="crustaces">ü¶ê Crustac√©s</option>
                            <option value="coquillages">ü¶™ Coquillages</option>
                            <option value="fumes">üî• Fum√©s</option>
                            <option value="traiteur">üçΩÔ∏è Traiteur</option>
                            <option value="epicerie">üõí √âpicerie</option>
                        </select>
                        <input type="text" id="articleOrigin" placeholder="Origine (optionnel)">
                    </div>
                    <div class="article-form-actions">
                        <button class="article-form-btn cancel" onclick="cancelArticleForm()">Annuler</button>
                        <button class="article-form-btn save" onclick="saveArticle()">üíæ Enregistrer</button>
                    </div>
                </div>
                
                <!-- Bouton ajouter -->
                <button class="header-btn primary" onclick="showArticleForm()" id="addArticleBtn" style="width: 100%; margin-bottom: 16px; justify-content: center;">
                    ‚ûï Ajouter un article
                </button>
                
                <!-- Liste articles -->
                <div class="articles-list" id="articlesList">
                    <div class="empty-articles">
                        <div class="empty-articles-icon">üì¶</div>
                        <p>Aucun article</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" onclick="closeArticlesModal()">Fermer</button>
                <button class="confirm" onclick="importFromModule()">üì• Importer du module Articles</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION & VARIABLES
        // ============================================
        
        const TVA_RATE = 2.6; // TVA alimentaire Suisse
        
        let articlesData = [];
        let filteredArticles = [];
        let currentCategory = '';
        let currentArticlesTab = 'list';
        let cart = [];
        let transactions = [];
        let currentWeightArticle = null;
        let weightInput = '';
        let transactionCounter = 0;
        let editingArticleId = null;
        
        // Configuration manifestation
        let eventConfig = {
            name: 'Magasin',
            date: new Date().toISOString().slice(0, 10),
            redevance: 0
        };
        
        // Firebase (optionnel)
        let db = null;
        let firebaseAvailable = false;
        
        // ============================================
        // INITIALISATION
        // ============================================
        
        function init() {
            // Charger config depuis localStorage
            loadEventConfig();
            loadArticles();
            loadTransactions();
            updateEventDisplay();
            updateStatus();
            
            // Essayer d'initialiser Firebase
            initFirebase();
            
            // Date par d√©faut = aujourd'hui
            document.getElementById('eventDate').value = new Date().toISOString().slice(0, 10);
        }
        
        function initFirebase() {
            try {
                if (typeof firebase !== 'undefined' && firebase.apps) {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
                        authDomain: "trakio-pilot-6e97a.firebaseapp.com",
                        projectId: "trakio-pilot-6e97a",
                        storageBucket: "trakio-pilot-6e97a.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdef123456"
                    };
                    
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    db = firebase.firestore();
                    firebaseAvailable = true;
                    console.log('‚úÖ Firebase disponible');
                }
            } catch (e) {
                console.log('‚ö†Ô∏è Mode hors ligne uniquement');
            }
            updateStatus();
        }
        
        function updateStatus() {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (firebaseAvailable) {
                dot.className = 'status-dot online';
                text.textContent = 'En ligne';
            } else {
                dot.className = 'status-dot offline';
                text.textContent = 'Hors ligne';
            }
        }
        
        // ============================================
        // ARTICLES CAISSE (localStorage s√©par√©)
        // ============================================
        
        function loadArticles() {
            // Charger depuis localStorage sp√©cifique caisse
            const stored = localStorage.getItem('trakio_caisse_articles');
            if (stored) {
                try {
                    articlesData = JSON.parse(stored).filter(a => a.active !== false);
                } catch (e) {
                    articlesData = getDefaultArticles();
                    saveArticlesToStorage();
                }
            } else {
                articlesData = getDefaultArticles();
                saveArticlesToStorage();
            }
            filterArticles();
        }
        
        function saveArticlesToStorage() {
            localStorage.setItem('trakio_caisse_articles', JSON.stringify(articlesData));
        }
        
        function getDefaultArticles() {
            // Articles de d√©mo pour fonctionner imm√©diatement
            return [
                { id: '1', name: 'Saumon frais', category: 'poissons', price: 45.00, unit: 'kg', tva: 2.6, origin: 'Norv√®ge', active: true, favorite: true },
                { id: '2', name: 'Filet de perche', category: 'poissons', price: 58.00, unit: 'kg', tva: 2.6, origin: 'Lac L√©man', active: true, favorite: true },
                { id: '3', name: 'Truite enti√®re', category: 'poissons', price: 28.00, unit: 'kg', tva: 2.6, origin: 'Suisse', active: true, favorite: false },
                { id: '4', name: 'Crevettes roses', category: 'crustaces', price: 32.00, unit: 'kg', tva: 2.6, origin: 'Madagascar', active: true, favorite: true },
                { id: '5', name: 'Hu√Ætres (dz)', category: 'coquillages', price: 24.00, unit: 'pce', tva: 2.6, origin: 'France', active: true, favorite: false },
                { id: '6', name: 'Moules', category: 'coquillages', price: 8.50, unit: 'kg', tva: 2.6, origin: 'Hollande', active: true, favorite: false },
                { id: '7', name: 'Saumon fum√©', category: 'fumes', price: 65.00, unit: 'kg', tva: 2.6, origin: '√âcosse', active: true, favorite: true },
                { id: '8', name: 'Tarama maison', category: 'traiteur', price: 4.50, unit: 'pce', tva: 2.6, active: true, favorite: false },
                { id: '9', name: 'Salade de la mer', category: 'traiteur', price: 28.00, unit: 'kg', tva: 2.6, active: true, favorite: false },
                { id: '10', name: 'Citrons (filet)', category: 'epicerie', price: 3.50, unit: 'pce', tva: 2.6, active: true, favorite: false }
            ];
        }
        
        function filterArticles() {
            const search = document.getElementById('searchArticle').value.toLowerCase();
            
            filteredArticles = articlesData.filter(article => {
                // Filtre favoris
                if (currentCategory === 'favoris') {
                    if (!article.favorite) return false;
                } else if (currentCategory) {
                    // Filtre cat√©gorie normale
                    if (article.category !== currentCategory) return false;
                }
                
                // Filtre recherche
                const matchSearch = !search || 
                    article.name?.toLowerCase().includes(search) ||
                    article.origin?.toLowerCase().includes(search);
                
                return matchSearch;
            });
            
            renderArticles();
        }
        
        function selectCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.cat === cat);
            });
            filterArticles();
        }
        
        function renderArticles() {
            const grid = document.getElementById('articles-grid');
            document.getElementById('articles-count').textContent = `(${filteredArticles.length})`;
            
            const icons = {
                poissons: 'üêü', crustaces: 'ü¶ê', coquillages: 'ü¶™',
                fumes: 'üî•', traiteur: 'üçΩÔ∏è', epicerie: 'üõí'
            };
            
            if (filteredArticles.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 40px; margin-bottom: 10px; opacity: 0.5;">
                            ${currentCategory === 'favoris' ? '‚≠ê' : 'üì¶'}
                        </div>
                        <p>${currentCategory === 'favoris' ? 'Aucun favori d√©fini' : 'Aucun article trouv√©'}</p>
                        <p style="font-size: 12px; margin-top: 5px;">
                            ${currentCategory === 'favoris' ? 'Cliquez sur ‚öôÔ∏è Articles pour configurer' : ''}
                        </p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = filteredArticles.map(article => `
                <button class="article-btn" onclick="addToCart('${article.id}')">
                    ${article.favorite ? '<span style="position:absolute;top:8px;right:8px;font-size:14px;">‚≠ê</span>' : ''}
                    <div class="article-icon">${icons[article.category] || 'üì¶'}</div>
                    <div class="article-name">${article.name}</div>
                    ${article.origin ? `<div class="article-origin">üìç ${article.origin}</div>` : ''}
                    <div class="article-price">${formatCHF(article.price)}</div>
                    <div class="article-unit">/${article.unit || 'kg'}</div>
                </button>
            `).join('');
        }
        
        // ============================================
        // PANIER
        // ============================================
        
        function addToCart(articleId) {
            const article = articlesData.find(a => a.id === articleId);
            if (!article) return;
            
            if (article.unit === 'kg') {
                openWeightModal(article);
                return;
            }
            
            const existing = cart.find(item => item.articleId === articleId && !item.weight);
            
            if (existing) {
                existing.qty++;
            } else {
                cart.push({
                    id: generateId(),
                    articleId: article.id,
                    name: article.name,
                    price: article.price || 0,
                    tva: article.tva || TVA_RATE,
                    unit: article.unit || 'pce',
                    qty: 1,
                    discount: 0
                });
            }
            
            renderCart();
            showNotification(`${article.name} ajout√©`, 'success', 1500);
        }
        
        function updateQty(itemId, delta) {
            const item = cart.find(i => i.id === itemId);
            if (!item) return;
            
            item.qty = Math.max(0.1, item.qty + delta);
            
            if (item.qty < 0.05) {
                cart = cart.filter(i => i.id !== itemId);
            }
            
            renderCart();
        }
        
        function removeItem(itemId) {
            cart = cart.filter(i => i.id !== itemId);
            renderCart();
        }
        
        function clearTicket() {
            if (cart.length > 0 && !confirm('Vider le ticket ?')) return;
            cart = [];
            document.getElementById('globalDiscount').value = 0;
            renderCart();
        }
        
        function renderCart() {
            const container = document.getElementById('ticket-items');
            const countBadge = document.getElementById('ticket-count');
            
            const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
            countBadge.textContent = `${totalQty.toFixed(totalQty % 1 ? 2 : 0)} article${totalQty > 1 ? 's' : ''}`;
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-ticket">
                        <div class="empty-ticket-icon">üõí</div>
                        <p>Ticket vide</p>
                        <p style="font-size: 12px; margin-top: 5px;">Cliquez sur un article</p>
                    </div>
                `;
                updateTotals();
                return;
            }
            
            container.innerHTML = cart.map(item => {
                const lineTotal = item.price * item.qty;
                return `
                    <div class="ticket-item">
                        <div class="ticket-item-info">
                            <div class="ticket-item-name">${item.name}</div>
                            <div class="ticket-item-details">
                                ${item.weight ? `${item.qty.toFixed(3)} kg √ó ${formatCHF(item.price)}/kg` : 
                                  `${item.qty} √ó ${formatCHF(item.price)}`}
                            </div>
                        </div>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="updateQty('${item.id}', ${item.weight ? -0.1 : -1})">‚àí</button>
                            <span class="qty-value">${item.weight ? item.qty.toFixed(2) : item.qty}</span>
                            <button class="qty-btn" onclick="updateQty('${item.id}', ${item.weight ? 0.1 : 1})">+</button>
                        </div>
                        <div class="ticket-item-price">${formatCHF(lineTotal)}</div>
                        <button class="remove-btn" onclick="removeItem('${item.id}')">√ó</button>
                    </div>
                `;
            }).join('');
            
            updateTotals();
        }
        
        function updateTotals() {
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            
            let subtotalTTC = 0;
            cart.forEach(item => {
                subtotalTTC += item.price * item.qty - (item.discount || 0);
            });
            
            const subtotalHT = subtotalTTC / (1 + TVA_RATE / 100);
            const totalTVA = subtotalTTC - subtotalHT;
            const total = swiss(subtotalTTC - globalDiscount);
            
            document.getElementById('subtotal-ht').textContent = formatCHF(subtotalHT);
            document.getElementById('total-tva').textContent = formatCHF(totalTVA);
            document.getElementById('grand-total').textContent = formatCHF(Math.max(0, total));
            
            const discountRow = document.getElementById('discount-row');
            if (globalDiscount > 0) {
                discountRow.style.display = 'flex';
                document.getElementById('total-discount').textContent = `-${formatCHF(globalDiscount)}`;
            } else {
                discountRow.style.display = 'none';
            }
        }
        
        // ============================================
        // MODAL PES√âE
        // ============================================
        
        function openWeightModal(article) {
            currentWeightArticle = article;
            weightInput = '';
            
            document.getElementById('weight-article-name').textContent = article.name;
            document.getElementById('weight-price').textContent = `${formatCHF(article.price)}/kg`;
            document.getElementById('weight-value').textContent = '0.000';
            document.getElementById('weight-total').textContent = '0.00 CHF';
            
            document.getElementById('weightModal').classList.add('active');
        }
        
        function closeWeightModal() {
            document.getElementById('weightModal').classList.remove('active');
            currentWeightArticle = null;
            weightInput = '';
        }
        
        function numpadInput(key) {
            if (key === 'C') {
                weightInput = '';
            } else if (key === '.') {
                if (!weightInput.includes('.')) {
                    weightInput += weightInput ? '.' : '0.';
                }
            } else {
                const parts = weightInput.split('.');
                if (parts[1] && parts[1].length >= 3) return;
                weightInput += key;
            }
            
            const weight = parseFloat(weightInput) || 0;
            document.getElementById('weight-value').textContent = weight.toFixed(3);
            
            if (currentWeightArticle) {
                const total = weight * currentWeightArticle.price;
                document.getElementById('weight-total').textContent = formatCHF(total);
            }
        }
        
        function confirmWeight() {
            const weight = parseFloat(weightInput) || 0;
            if (weight <= 0 || !currentWeightArticle) {
                showNotification('Entrez un poids valide', 'warning');
                return;
            }
            
            cart.push({
                id: generateId(),
                articleId: currentWeightArticle.id,
                name: currentWeightArticle.name,
                price: currentWeightArticle.price || 0,
                tva: currentWeightArticle.tva || TVA_RATE,
                unit: 'kg',
                qty: weight,
                weight: true,
                discount: 0
            });
            
            closeWeightModal();
            renderCart();
            showNotification(`${currentWeightArticle.name} (${weight.toFixed(3)} kg) ajout√©`, 'success');
        }
        
        // ============================================
        // CONFIGURATION MANIFESTATION
        // ============================================
        
        function loadEventConfig() {
            const stored = localStorage.getItem('trakio_caisse_event');
            if (stored) {
                eventConfig = JSON.parse(stored);
            }
            transactionCounter = parseInt(localStorage.getItem('trakio_tx_counter') || '0');
        }
        
        function saveEventConfigToStorage() {
            localStorage.setItem('trakio_caisse_event', JSON.stringify(eventConfig));
        }
        
        function updateEventDisplay() {
            document.getElementById('displayEventName').textContent = eventConfig.name || 'Non configur√©';
            document.getElementById('displayEventDate').textContent = eventConfig.date ? formatDate(eventConfig.date) : '-';
            document.getElementById('displayRedevance').textContent = `${eventConfig.redevance || 0}%`;
        }
        
        function openEventModal() {
            document.getElementById('eventName').value = eventConfig.name || '';
            document.getElementById('eventDate').value = eventConfig.date || new Date().toISOString().slice(0, 10);
            document.getElementById('eventRedevance').value = eventConfig.redevance || 0;
            document.getElementById('eventPreset').value = '';
            
            updateRedevancePreview();
            document.getElementById('eventModal').classList.add('active');
        }
        
        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
        }
        
        function applyPreset() {
            const preset = document.getElementById('eventPreset').value;
            if (!preset) return;
            
            const [name, redevance] = preset.split('|');
            const names = {
                'magasin': 'Magasin',
                'marche_nyon': 'March√© Nyon',
                'marche_morges': 'March√© Morges',
                'fete_nyon': 'F√™te de Nyon',
                'livraison': 'Livraison'
            };
            
            document.getElementById('eventName').value = names[name] || name;
            document.getElementById('eventRedevance').value = redevance;
            updateRedevancePreview();
        }
        
        function updateRedevancePreview() {
            const redevance = parseFloat(document.getElementById('eventRedevance').value) || 0;
            const preview = document.getElementById('redevancePreview');
            
            if (redevance > 0) {
                preview.style.display = 'block';
                
                // Calculer sur les transactions de l'√©v√©nement actuel
                const eventTx = getEventTransactions();
                const caTTC = eventTx.reduce((sum, tx) => sum + tx.total, 0);
                const caHT = caTTC / (1 + TVA_RATE / 100);
                const redevanceAmount = caHT * redevance / 100;
                const toRemit = caHT - redevanceAmount;
                
                document.getElementById('previewCaTTC').textContent = formatCHF(caTTC);
                document.getElementById('previewCaHT').textContent = formatCHF(caHT);
                document.getElementById('previewRedevancePercent').textContent = redevance;
                document.getElementById('previewRedevanceAmount').textContent = `-${formatCHF(redevanceAmount)}`;
                document.getElementById('previewToRemit').textContent = formatCHF(toRemit);
            } else {
                preview.style.display = 'none';
            }
        }
        
        function saveEventConfig() {
            const name = document.getElementById('eventName').value.trim();
            if (!name) {
                showNotification('Entrez un nom de manifestation', 'warning');
                return;
            }
            
            eventConfig = {
                name: name,
                date: document.getElementById('eventDate').value,
                redevance: parseFloat(document.getElementById('eventRedevance').value) || 0
            };
            
            saveEventConfigToStorage();
            updateEventDisplay();
            closeEventModal();
            showNotification('Configuration enregistr√©e', 'success');
        }
        
        // ============================================
        // TRANSACTIONS
        // ============================================
        
        function loadTransactions() {
            const stored = localStorage.getItem('trakio_caisse_transactions');
            if (stored) {
                transactions = JSON.parse(stored);
            }
        }
        
        function saveTransactions() {
            localStorage.setItem('trakio_caisse_transactions', JSON.stringify(transactions));
        }
        
        function getEventTransactions() {
            return transactions.filter(tx => 
                tx.event === eventConfig.name && 
                tx.date === eventConfig.date &&
                !tx.cancelled
            );
        }
        
        async function processPayment(method) {
            if (cart.length === 0) {
                showNotification('Le ticket est vide', 'warning');
                return;
            }
            
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            
            let subtotalTTC = 0;
            cart.forEach(item => {
                subtotalTTC += item.price * item.qty - (item.discount || 0);
            });
            
            const total = swiss(subtotalTTC - globalDiscount);
            
            // Incr√©menter compteur
            transactionCounter++;
            localStorage.setItem('trakio_tx_counter', transactionCounter.toString());
            
            // Cr√©er la transaction
            const transaction = {
                id: generateId(),
                num: transactionCounter,
                date: eventConfig.date || new Date().toISOString().slice(0, 10),
                time: new Date().toTimeString().slice(0, 5),
                event: eventConfig.name,
                redevance: eventConfig.redevance,
                items: cart.map(item => ({
                    articleId: item.articleId,
                    name: item.name,
                    price: item.price,
                    qty: item.qty,
                    unit: item.unit,
                    tva: item.tva,
                    discount: item.discount || 0,
                    total: item.price * item.qty - (item.discount || 0)
                })),
                subtotal: subtotalTTC,
                discount: globalDiscount,
                total: total,
                method: method,
                cancelled: false,
                synced: false
            };
            
            // Sauvegarder localement
            transactions.push(transaction);
            saveTransactions();
            
            // Essayer sync Firebase si disponible
            if (firebaseAvailable && db) {
                try {
                    await db.collection('caisse_transactions').add(transaction);
                    transaction.synced = true;
                    saveTransactions();
                } catch (e) {
                    console.log('Sync Firebase √©chou√©, gard√© local');
                }
            }
            
            const methodLabels = { cash: 'esp√®ces', card: 'carte', twint: 'Twint' };
            showNotification(`‚úì Paiement ${methodLabels[method]}: ${formatCHF(total)}`, 'success');
            
            // Reset
            cart = [];
            document.getElementById('globalDiscount').value = 0;
            renderCart();
        }
        
        // ============================================
        // RAPPORT
        // ============================================
        
        function openReportModal() {
            const eventTx = getEventTransactions();
            
            // Stats g√©n√©rales
            const txCount = eventTx.length;
            const caTTC = eventTx.reduce((sum, tx) => sum + tx.total, 0);
            const caHT = caTTC / (1 + TVA_RATE / 100);
            const articlesCount = eventTx.reduce((sum, tx) => 
                sum + tx.items.reduce((s, i) => s + i.qty, 0), 0
            );
            
            // Par m√©thode
            const cash = eventTx.filter(tx => tx.method === 'cash').reduce((s, tx) => s + tx.total, 0);
            const card = eventTx.filter(tx => tx.method === 'card').reduce((s, tx) => s + tx.total, 0);
            const twint = eventTx.filter(tx => tx.method === 'twint').reduce((s, tx) => s + tx.total, 0);
            
            // Redevance
            const redevancePercent = eventConfig.redevance || 0;
            const redevanceAmount = caHT * redevancePercent / 100;
            const toRemit = caHT - redevanceAmount;
            
            // Afficher
            document.getElementById('reportEventName').textContent = `${eventConfig.name} (${formatDate(eventConfig.date)})`;
            document.getElementById('reportTxCount').textContent = txCount;
            document.getElementById('reportCaTTC').textContent = formatCHF(caTTC);
            document.getElementById('reportCaHT').textContent = formatCHF(caHT);
            document.getElementById('reportArticles').textContent = Math.round(articlesCount);
            
            document.getElementById('reportCash').textContent = formatCHF(cash);
            document.getElementById('reportCard').textContent = formatCHF(card);
            document.getElementById('reportTwint').textContent = formatCHF(twint);
            
            document.getElementById('reportHT').textContent = formatCHF(caHT);
            document.getElementById('reportRedevancePercent').textContent = redevancePercent;
            document.getElementById('reportRedevanceAmount').textContent = `-${formatCHF(redevanceAmount)}`;
            document.getElementById('reportToRemit').textContent = formatCHF(toRemit);
            
            // Masquer section redevance si 0%
            document.getElementById('redevanceSection').style.display = redevancePercent > 0 ? 'block' : 'none';
            
            document.getElementById('reportModal').classList.add('active');
        }
        
        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
        }
        
        function exportReport() {
            const eventTx = getEventTransactions();
            const caTTC = eventTx.reduce((sum, tx) => sum + tx.total, 0);
            const caHT = caTTC / (1 + TVA_RATE / 100);
            const redevanceAmount = caHT * (eventConfig.redevance || 0) / 100;
            const toRemit = caHT - redevanceAmount;
            
            const cash = eventTx.filter(tx => tx.method === 'cash').reduce((s, tx) => s + tx.total, 0);
            const card = eventTx.filter(tx => tx.method === 'card').reduce((s, tx) => s + tx.total, 0);
            const twint = eventTx.filter(tx => tx.method === 'twint').reduce((s, tx) => s + tx.total, 0);
            
            const report = `
RAPPORT DE CAISSE - TRAKIO
================================
Manifestation: ${eventConfig.name}
Date: ${formatDate(eventConfig.date)}
================================

R√âSUM√â
------
Transactions: ${eventTx.length}
CA TTC: ${formatCHF(caTTC)}
CA HT: ${formatCHF(caHT)}

PAIEMENTS
---------
Esp√®ces: ${formatCHF(cash)}
Carte: ${formatCHF(card)}
Twint: ${formatCHF(twint)}

${eventConfig.redevance > 0 ? `
REDEVANCE
---------
Taux: ${eventConfig.redevance}%
Montant: ${formatCHF(redevanceAmount)}

√Ä REMETTRE: ${formatCHF(toRemit)}
` : ''}

D√âTAIL TRANSACTIONS
-------------------
${eventTx.map(tx => 
`#${tx.num} | ${tx.time} | ${tx.method.toUpperCase()} | ${formatCHF(tx.total)}`
).join('\n')}

================================
G√©n√©r√© le ${new Date().toLocaleString('fr-CH')}
            `.trim();
            
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `rapport_${eventConfig.name.replace(/\s+/g, '_')}_${eventConfig.date}.txt`;
            link.click();
            
            showNotification('Rapport export√©', 'success');
        }
        
        // ============================================
        // MODAL GESTION ARTICLES
        // ============================================
        
        function openArticlesModal() {
            currentArticlesTab = 'list';
            editingArticleId = null;
            document.getElementById('articleForm').style.display = 'none';
            document.getElementById('addArticleBtn').style.display = 'flex';
            updateArticlesTabs();
            renderArticlesList();
            document.getElementById('articlesModal').classList.add('active');
        }
        
        function closeArticlesModal() {
            document.getElementById('articlesModal').classList.remove('active');
            cancelArticleForm();
        }
        
        function setArticlesTab(tab) {
            currentArticlesTab = tab;
            updateArticlesTabs();
            renderArticlesList();
        }
        
        function updateArticlesTabs() {
            document.querySelectorAll('.articles-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === currentArticlesTab);
            });
            
            const totalCount = articlesData.length;
            const favCount = articlesData.filter(a => a.favorite).length;
            
            document.getElementById('articlesCount').textContent = totalCount;
            document.getElementById('favoritesCount').textContent = favCount;
        }
        
        function renderArticlesList() {
            const container = document.getElementById('articlesList');
            
            let listData = articlesData;
            if (currentArticlesTab === 'favorites') {
                listData = articlesData.filter(a => a.favorite);
            }
            
            if (listData.length === 0) {
                container.innerHTML = `
                    <div class="empty-articles">
                        <div class="empty-articles-icon">${currentArticlesTab === 'favorites' ? '‚≠ê' : 'üì¶'}</div>
                        <p>${currentArticlesTab === 'favorites' ? 'Aucun favori' : 'Aucun article'}</p>
                        <p style="font-size: 12px; margin-top: 5px;">
                            ${currentArticlesTab === 'favorites' ? 'Cliquez sur ‚òÜ pour ajouter des favoris' : 'Ajoutez des articles pour commencer'}
                        </p>
                    </div>
                `;
                return;
            }
            
            const icons = {
                poissons: 'üêü', crustaces: 'ü¶ê', coquillages: 'ü¶™',
                fumes: 'üî•', traiteur: 'üçΩÔ∏è', epicerie: 'üõí'
            };
            
            container.innerHTML = listData.map(article => `
                <div class="article-list-item">
                    <span class="article-list-fav" onclick="toggleFavorite('${article.id}')" title="${article.favorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}">
                        ${article.favorite ? '‚≠ê' : '‚òÜ'}
                    </span>
                    <span style="font-size: 20px;">${icons[article.category] || 'üì¶'}</span>
                    <div class="article-list-info">
                        <div class="article-list-name">${article.name}</div>
                        <div class="article-list-details">
                            ${article.origin ? `üìç ${article.origin} ‚Ä¢ ` : ''}${article.unit}
                        </div>
                    </div>
                    <div class="article-list-price">${formatCHF(article.price)}</div>
                    <div class="article-list-actions">
                        <button class="article-list-btn" onclick="editArticle('${article.id}')" title="Modifier">‚úèÔ∏è</button>
                        <button class="article-list-btn delete" onclick="deleteArticle('${article.id}')" title="Supprimer">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }
        
        function toggleFavorite(articleId) {
            const article = articlesData.find(a => a.id === articleId);
            if (article) {
                article.favorite = !article.favorite;
                saveArticlesToStorage();
                renderArticlesList();
                updateArticlesTabs();
                filterArticles(); // Refresh main grid
                showNotification(article.favorite ? '‚≠ê Ajout√© aux favoris' : 'Retir√© des favoris', 'success', 1500);
            }
        }
        
        function showArticleForm(articleId = null) {
            editingArticleId = articleId;
            const form = document.getElementById('articleForm');
            const addBtn = document.getElementById('addArticleBtn');
            
            form.style.display = 'block';
            addBtn.style.display = 'none';
            
            if (articleId) {
                const article = articlesData.find(a => a.id === articleId);
                if (article) {
                    document.getElementById('articleFormTitle').textContent = '‚úèÔ∏è Modifier l\'article';
                    document.getElementById('editArticleId').value = articleId;
                    document.getElementById('articleName').value = article.name || '';
                    document.getElementById('articlePrice').value = article.price || '';
                    document.getElementById('articleUnit').value = article.unit || 'kg';
                    document.getElementById('articleCategory').value = article.category || 'poissons';
                    document.getElementById('articleOrigin').value = article.origin || '';
                }
            } else {
                document.getElementById('articleFormTitle').textContent = '‚ûï Nouvel article';
                document.getElementById('editArticleId').value = '';
                document.getElementById('articleName').value = '';
                document.getElementById('articlePrice').value = '';
                document.getElementById('articleUnit').value = 'kg';
                document.getElementById('articleCategory').value = 'poissons';
                document.getElementById('articleOrigin').value = '';
            }
            
            document.getElementById('articleName').focus();
        }
        
        function cancelArticleForm() {
            editingArticleId = null;
            document.getElementById('articleForm').style.display = 'none';
            document.getElementById('addArticleBtn').style.display = 'flex';
        }
        
        function saveArticle() {
            const name = document.getElementById('articleName').value.trim();
            const price = parseFloat(document.getElementById('articlePrice').value);
            
            if (!name) {
                showNotification('Entrez un nom d\'article', 'warning');
                return;
            }
            
            if (isNaN(price) || price <= 0) {
                showNotification('Entrez un prix valide', 'warning');
                return;
            }
            
            const articleData = {
                name: name,
                price: price,
                unit: document.getElementById('articleUnit').value,
                category: document.getElementById('articleCategory').value,
                origin: document.getElementById('articleOrigin').value.trim(),
                tva: TVA_RATE,
                active: true
            };
            
            if (editingArticleId) {
                // Modification
                const index = articlesData.findIndex(a => a.id === editingArticleId);
                if (index !== -1) {
                    articleData.id = editingArticleId;
                    articleData.favorite = articlesData[index].favorite || false;
                    articlesData[index] = articleData;
                    showNotification('Article modifi√©', 'success');
                }
            } else {
                // Cr√©ation
                articleData.id = generateId();
                articleData.favorite = false;
                articlesData.push(articleData);
                showNotification('Article ajout√©', 'success');
            }
            
            saveArticlesToStorage();
            cancelArticleForm();
            renderArticlesList();
            updateArticlesTabs();
            filterArticles(); // Refresh main grid
        }
        
        function editArticle(articleId) {
            showArticleForm(articleId);
        }
        
        function deleteArticle(articleId) {
            const article = articlesData.find(a => a.id === articleId);
            if (!article) return;
            
            if (confirm(`Supprimer "${article.name}" ?`)) {
                articlesData = articlesData.filter(a => a.id !== articleId);
                saveArticlesToStorage();
                renderArticlesList();
                updateArticlesTabs();
                filterArticles();
                showNotification('Article supprim√©', 'success');
            }
        }
        
        function importFromModule() {
            // Importer depuis le module Articles principal
            const moduleArticles = localStorage.getItem('trakio_articles');
            
            if (!moduleArticles) {
                showNotification('Aucun article dans le module Articles', 'warning');
                return;
            }
            
            try {
                let imported = JSON.parse(moduleArticles);
                if (imported.articles) imported = imported.articles;
                
                if (!Array.isArray(imported) || imported.length === 0) {
                    showNotification('Aucun article √† importer', 'warning');
                    return;
                }
                
                const existingIds = new Set(articlesData.map(a => a.id));
                let addedCount = 0;
                
                imported.forEach(article => {
                    if (!existingIds.has(article.id) && article.active !== false) {
                        articlesData.push({
                            id: article.id || generateId(),
                            name: article.name,
                            price: article.price || 0,
                            unit: article.unit || 'kg',
                            category: article.category || 'poissons',
                            origin: article.origin || '',
                            tva: article.tva || TVA_RATE,
                            active: true,
                            favorite: false
                        });
                        addedCount++;
                    }
                });
                
                if (addedCount > 0) {
                    saveArticlesToStorage();
                    renderArticlesList();
                    updateArticlesTabs();
                    filterArticles();
                    showNotification(`${addedCount} articles import√©s`, 'success');
                } else {
                    showNotification('Tous les articles existent d√©j√†', 'warning');
                }
                
            } catch (e) {
                console.error('Erreur import:', e);
                showNotification('Erreur lors de l\'import', 'error');
            }
        }
        
        // ============================================
        // SYNC
        // ============================================
        
        async function syncData() {
            if (!firebaseAvailable || !db) {
                showNotification('Mode hors ligne - sync impossible', 'warning');
                return;
            }
            
            showNotification('Synchronisation...', 'success');
            
            // Sync transactions non sync
            const unsyncedTx = transactions.filter(tx => !tx.synced);
            
            for (const tx of unsyncedTx) {
                try {
                    await db.collection('caisse_transactions').add(tx);
                    tx.synced = true;
                } catch (e) {
                    console.error('Erreur sync tx:', e);
                }
            }
            
            saveTransactions();
            showNotification(`${unsyncedTx.length} transactions synchronis√©es`, 'success');
        }
        
        // ============================================
        // UTILITAIRES
        // ============================================
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        function swiss(amount) {
            // Arrondi suisse aux 5 centimes
            return Math.round(amount * 20) / 20;
        }
        
        function formatCHF(amount) {
            return new Intl.NumberFormat('fr-CH', {
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount) + ' CHF';
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-CH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function showNotification(message, type = 'success', duration = 3000) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type} show`;
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, duration);
        }
        
        // ============================================
        // RACCOURCIS CLAVIER
        // ============================================
        
        document.addEventListener('keydown', (e) => {
            // Escape = fermer modales
            if (e.key === 'Escape') {
                closeWeightModal();
                closeEventModal();
                closeReportModal();
                closeArticlesModal();
            }
            
            // Enter dans modal pes√©e = confirmer
            if (e.key === 'Enter' && document.getElementById('weightModal').classList.contains('active')) {
                confirmWeight();
            }
            
            // Numpad dans modal pes√©e
            if (document.getElementById('weightModal').classList.contains('active')) {
                if (e.key >= '0' && e.key <= '9') {
                    numpadInput(e.key);
                } else if (e.key === '.' || e.key === ',') {
                    numpadInput('.');
                } else if (e.key === 'Backspace') {
                    weightInput = weightInput.slice(0, -1);
                    const weight = parseFloat(weightInput) || 0;
                    document.getElementById('weight-value').textContent = weight.toFixed(3);
                    if (currentWeightArticle) {
                        document.getElementById('weight-total').textContent = formatCHF(weight * currentWeightArticle.price);
                    }
                }
            }
        });
        
        // Update preview quand on change la redevance
        document.getElementById('eventRedevance')?.addEventListener('input', updateRedevancePreview);
        
        // ============================================
        // D√âMARRAGE
        // ============================================
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

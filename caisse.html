<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Caisse">
    <meta name="theme-color" content="#0f172a">
    
    <title>TRAKIO Caisse v5.5.3</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêü</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-input: #0f172a;
            --border: #334155;
            --text-primary: #f8fafc;
            --text-muted: #64748b;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100%; width: 100%;
            overflow: hidden;
            position: fixed;
            touch-action: manipulation;
        }
        
        /* HEADER 40px */
        .header {
            height: calc(40px + var(--safe-top));
            padding-top: var(--safe-top);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 8px; padding-right: 8px;
        }
        
        .header-left { display: flex; align-items: center; gap: 6px; }
        .logo { font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 4px; }
        .logo-icon { width: 24px; height: 24px; background: linear-gradient(135deg, #06b6d4, #10b981); border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .version { font-size: 7px; background: var(--accent); color: #000; padding: 2px 4px; border-radius: 3px; font-weight: 600; }
        
        .header-center { display: flex; align-items: center; gap: 4px; }
        .event-select { padding: 4px 6px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 5px; color: var(--text-primary); font-size: 10px; font-family: inherit; max-width: 100px; }
        .status { display: flex; align-items: center; gap: 3px; font-size: 9px; color: var(--text-muted); }
        .status-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--success); }
        
        .header-right { display: flex; gap: 3px; }
        .header-btn { padding: 4px 6px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 12px; cursor: pointer; }
        .header-btn.has-queue { position: relative; }
        .header-btn.has-queue::after { content: attr(data-count); position: absolute; top: -4px; right: -4px; background: var(--warning); color: #000; font-size: 8px; font-weight: 700; padding: 1px 4px; border-radius: 8px; }
        
        /* CAT√âGORIES 38px */
        .categories-bar {
            height: 38px;
            background: var(--bg-secondary);
            display: flex;
            gap: 4px;
            padding: 3px 6px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
            -webkit-overflow-scrolling: touch;
        }
        .categories-bar::-webkit-scrollbar { display: none; }
        
        .cat-btn {
            flex-shrink: 0;
            height: 32px;
            padding: 0 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: white;
            font-weight: 600;
            font-size: 9px;
            white-space: nowrap;
        }
        .cat-btn:active { opacity: 0.8; }
        .cat-btn.active { box-shadow: 0 0 0 2px white; }
        .cat-btn span:first-child { font-size: 12px; }
        
        .cat-favoris { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .cat-tous { background: linear-gradient(135deg, #64748b, #475569); }
        .cat-poissons { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
        .cat-crustaces { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .cat-coquillages { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .cat-fumes { background: linear-gradient(135deg, #f97316, #ea580c); }
        .cat-traiteur { background: linear-gradient(135deg, #10b981, #059669); }
        .cat-epicerie { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        
        /* LAYOUT */
        .main {
            display: grid;
            grid-template-columns: 1fr 340px;
            height: calc(100% - 78px - var(--safe-top) - var(--safe-bottom));
            overflow: hidden;
        }
        
        /* ARTICLES */
        .articles-zone { display: flex; flex-direction: column; overflow: hidden; border-right: 1px solid var(--border); }
        
        .search-bar { padding: 4px 6px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); }
        .search-input { width: 100%; padding: 5px 8px 5px 26px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 5px; color: var(--text-primary); font-size: 11px; font-family: inherit; }
        .search-input:focus { outline: none; border-color: var(--accent); }
        .search-wrap { position: relative; }
        .search-icon { position: absolute; left: 7px; top: 50%; transform: translateY(-50%); font-size: 11px; opacity: 0.5; }
        
        /* TUILES UNIFORMES 50px (+20%) */
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(84px, 1fr));
            gap: 5px;
            padding: 5px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }
        
        .tile {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px;
            cursor: pointer;
            text-align: center;
            position: relative;
            height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .tile::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--cat-color, var(--accent)); border-radius: 6px 6px 0 0; }
        .tile:active { background: var(--bg-hover); transform: scale(0.95); }
        .tile-icon { font-size: 14px; line-height: 1; }
        .tile-name { font-size: 8px; font-weight: 600; line-height: 1; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
        .tile-price { font-size: 9px; font-weight: 700; color: var(--accent); }
        .tile-fav { position: absolute; top: 2px; right: 2px; font-size: 7px; }
        
        /* TICKET */
        .ticket-zone { display: flex; flex-direction: column; background: var(--bg-secondary); overflow: hidden; }
        
        .ticket-header { padding: 4px 6px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .ticket-title { font-weight: 600; font-size: 11px; display: flex; align-items: center; gap: 4px; }
        .ticket-count { background: var(--accent); color: #000; padding: 2px 6px; border-radius: 8px; font-size: 9px; font-weight: 600; }
        
        .ticket-items { flex: 1; overflow-y: auto; padding: 4px; -webkit-overflow-scrolling: touch; }
        
        .ticket-item {
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 4px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            margin-bottom: 3px;
        }
        .item-info { flex: 1; min-width: 0; }
        .item-name { font-weight: 600; font-size: 9px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-details { font-size: 7px; color: var(--text-muted); }
        .item-price { font-weight: 700; color: var(--accent); font-size: 9px; min-width: 45px; text-align: right; }
        
        .qty-btns { display: flex; align-items: center; gap: 1px; }
        .qty-btn { width: 18px; height: 18px; border-radius: 3px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .qty-val { min-width: 18px; text-align: center; font-size: 9px; font-weight: 600; }
        .del-btn { width: 18px; height: 18px; background: none; border: none; color: var(--danger); font-size: 12px; cursor: pointer; }
        
        .empty-ticket { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); font-size: 9px; }
        .empty-ticket span:first-child { font-size: 20px; opacity: 0.3; margin-bottom: 3px; }
        
        /* TOTAUX */
        .ticket-totals { padding: 4px 6px; border-top: 1px solid var(--border); background: var(--bg-card); }
        .total-row { display: flex; justify-content: space-between; font-size: 8px; padding: 1px 0; color: var(--text-muted); }
        .total-row.grand { font-size: 14px; font-weight: 700; color: var(--accent); padding: 4px 0 2px; border-top: 1px solid var(--border); margin-top: 2px; }
        .discount-row { display: flex; align-items: center; gap: 3px; padding: 1px 0; }
        .discount-row label { font-size: 7px; color: var(--text-muted); }
        .discount-row input { width: 40px; padding: 2px 3px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 3px; color: var(--text-primary); font-size: 9px; text-align: center; font-family: inherit; }
        
        /* PAIEMENT */
        .payment-section { padding: 4px 6px; border-top: 1px solid var(--border); }
        .payment-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; margin-bottom: 3px; }
        
        .pay-btn {
            padding: 6px 4px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 7px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            color: white;
            font-family: inherit;
        }
        .pay-btn:active { opacity: 0.8; transform: scale(0.95); }
        .pay-btn span:first-child { font-size: 14px; }
        .pay-btn.cash { background: linear-gradient(135deg, #10b981, #059669); }
        .pay-btn.card { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .pay-btn.twint { background: linear-gradient(135deg, #000, #333); }
        
        .action-btns { display: grid; grid-template-columns: repeat(2, 1fr); gap: 3px; }
        .action-btn {
            padding: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 8px;
            cursor: pointer;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }
        .action-btn:active { background: var(--bg-hover); }
        .action-btn.danger:active { background: var(--danger); color: white; }
        
        /* FILE D'ATTENTE */
        .queue-list { max-height: 200px; overflow-y: auto; }
        .queue-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
        }
        .queue-item:hover { border-color: var(--accent); }
        .queue-num { font-size: 18px; font-weight: 700; color: var(--warning); min-width: 35px; }
        .queue-info { flex: 1; }
        .queue-info-top { font-size: 12px; font-weight: 600; }
        .queue-info-bottom { font-size: 10px; color: var(--text-muted); }
        .queue-total { font-weight: 700; color: var(--accent); font-size: 14px; }
        .queue-del { background: none; border: none; color: var(--danger); font-size: 16px; cursor: pointer; padding: 4px; }
        
        /* Queue Detail Modal */
        .queue-detail-items { max-height: 200px; overflow-y: auto; margin-bottom: 12px; }
        .queue-detail-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: var(--bg-input); border-radius: 6px; margin-bottom: 4px; }
        .queue-detail-name { font-size: 12px; font-weight: 600; }
        .queue-detail-qty { font-size: 10px; color: var(--text-muted); }
        .queue-detail-price { font-size: 12px; font-weight: 700; color: var(--accent); }
        .queue-detail-total { display: flex; justify-content: space-between; padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 12px; font-size: 16px; font-weight: 700; }
        .queue-detail-total span:last-child { color: var(--accent); }
        .queue-detail-status { text-align: center; padding: 8px; border-radius: 6px; margin-bottom: 12px; font-size: 11px; font-weight: 600; }
        .queue-detail-status.paid { background: rgba(16,185,129,0.2); color: var(--success); }
        .queue-detail-status.unpaid { background: rgba(245,158,11,0.2); color: var(--warning); }
        
        /* MODALS */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 8px;
        }
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            max-width: 360px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        .modal.large { max-width: 500px; }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .modal-title { font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .modal-close { width: 24px; height: 24px; border-radius: 4px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary); font-size: 14px; cursor: pointer; }
        
        .modal-tabs { display: flex; gap: 4px; margin-bottom: 10px; }
        .modal-tab { flex: 1; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-muted); font-size: 10px; cursor: pointer; text-align: center; font-family: inherit; }
        .modal-tab.active { background: var(--accent); color: #000; border-color: var(--accent); }
        
        .modal-content { display: none; }
        .modal-content.active { display: block; }
        
        /* Weight/Cash modals */
        .weight-display { background: var(--bg-primary); border-radius: 8px; padding: 10px; text-align: center; margin-bottom: 8px; }
        .weight-value { font-size: 28px; font-weight: 700; color: var(--accent); }
        .weight-unit { font-size: 12px; color: var(--text-muted); }
        .weight-info { text-align: center; font-size: 10px; color: var(--text-muted); margin-bottom: 8px; }
        .weight-info strong { color: var(--success); }
        
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 10px; }
        .numpad-btn { padding: 10px; font-size: 16px; font-weight: 600; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); cursor: pointer; font-family: inherit; }
        .numpad-btn:active { background: var(--bg-hover); }
        .numpad-btn.clear { background: var(--danger); color: white; }
        
        .modal-actions { display: flex; gap: 6px; }
        .modal-actions button { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: 600; font-size: 11px; cursor: pointer; font-family: inherit; }
        .modal-actions .cancel { background: var(--bg-input); color: var(--text-primary); }
        .modal-actions .confirm { background: var(--success); color: white; }
        
        .cash-display { background: var(--bg-primary); border-radius: 8px; padding: 12px; text-align: center; margin-bottom: 10px; }
        .cash-label { font-size: 10px; color: var(--text-muted); }
        .cash-amount { font-size: 28px; font-weight: 700; color: var(--accent); }
        
        .cash-bills { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .cash-bill { padding: 14px 8px; background: var(--bg-input); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; text-align: center; font-family: inherit; }
        .cash-bill:active { transform: scale(0.95); }
        .cash-bill.selected { border-color: var(--success); background: rgba(16,185,129,0.2); }
        .cash-bill-val { font-size: 22px; font-weight: 700; color: var(--text-primary); }
        .cash-bill-label { font-size: 9px; color: var(--text-muted); margin-top: 2px; }
        
        .cash-input { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 18px; text-align: center; margin-bottom: 10px; font-family: inherit; }
        
        .cash-change { padding: 12px; background: var(--success); border-radius: 8px; text-align: center; margin-bottom: 10px; display: none; }
        .cash-change.visible { display: block; }
        .cash-change-label { font-size: 10px; opacity: 0.9; }
        .cash-change-val { font-size: 24px; font-weight: 700; }
        
        /* Paiement options */
        .pay-options { display: flex; gap: 6px; margin-bottom: 10px; }
        .pay-option { flex: 1; padding: 10px; background: var(--bg-input); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center; }
        .pay-option.selected { border-color: var(--success); background: rgba(16,185,129,0.1); }
        .pay-option-icon { font-size: 20px; margin-bottom: 4px; }
        .pay-option-label { font-size: 9px; font-weight: 600; }
        
        /* Rapport */
        .report-summary { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px; }
        .report-stat { background: var(--bg-input); border-radius: 8px; padding: 10px; text-align: center; }
        .report-stat-value { font-size: 20px; font-weight: 700; color: var(--accent); }
        .report-stat-label { font-size: 9px; color: var(--text-muted); }
        
        .report-filters { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .report-filter { flex: 1; min-width: 100px; }
        .report-filter label { display: block; font-size: 9px; color: var(--text-muted); margin-bottom: 4px; }
        .report-filter input, .report-filter select { width: 100%; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 11px; font-family: inherit; }
        
        .report-list { max-height: 250px; overflow-y: auto; }
        .report-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-input); border-radius: 8px; margin-bottom: 6px; font-size: 11px; }
        .report-item-left { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .report-item-num { font-weight: 700; color: var(--text-muted); }
        .report-item-time { color: var(--text-muted); }
        .report-item-date { color: var(--accent); font-size: 9px; }
        .report-item-event { font-size: 9px; background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px; }
        .report-item-method { font-size: 14px; }
        .report-item-total { font-weight: 700; color: var(--success); font-size: 12px; }
        
        .report-tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .report-tab { flex: 1; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-muted); font-size: 10px; cursor: pointer; text-align: center; font-family: inherit; }
        .report-tab.active { background: var(--accent); color: #000; border-color: var(--accent); }
        
        /* Config manifestation */
        .config-group { margin-bottom: 12px; }
        .config-group label { display: block; font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }
        .config-group input, .config-group select { width: 100%; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px; font-family: inherit; }
        
        .config-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        
        .event-card { background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 8px; }
        .event-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .event-card-name { font-weight: 600; font-size: 12px; }
        .event-card-actions { display: flex; gap: 4px; }
        .event-card-btn { padding: 4px 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; font-size: 10px; cursor: pointer; color: var(--text-primary); }
        
        /* Articles edit */
        .article-edit-list { max-height: 300px; overflow-y: auto; }
        .article-edit-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-input); border-radius: 6px; margin-bottom: 4px; }
        .article-edit-icon { font-size: 16px; }
        .article-edit-info { flex: 1; }
        .article-edit-name { font-size: 11px; font-weight: 600; }
        .article-edit-cat { font-size: 9px; color: var(--text-muted); }
        .article-edit-price { font-weight: 700; color: var(--accent); font-size: 11px; min-width: 50px; text-align: right; }
        .article-edit-btn { padding: 4px 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; font-size: 10px; cursor: pointer; color: var(--text-primary); }
        
        /* Install */
        .install-prompt { position: fixed; bottom: 6px; left: 6px; right: 6px; padding: 8px 10px; background: var(--bg-secondary); border: 1px solid var(--accent); border-radius: 8px; display: none; align-items: center; gap: 6px; z-index: 2000; }
        .install-prompt.show { display: flex; }
        .install-prompt-text { flex: 1; font-size: 10px; }
        .install-btn { padding: 5px 10px; background: var(--accent); border: none; border-radius: 4px; color: #000; font-weight: 600; font-size: 10px; cursor: pointer; font-family: inherit; }
        .install-close { background: none; border: none; color: var(--text-muted); font-size: 14px; cursor: pointer; }
        
        /* Notif */
        .notif { position: fixed; bottom: 6px; right: 6px; padding: 6px 10px; background: var(--bg-secondary); border: 1px solid var(--success); border-radius: 6px; display: flex; align-items: center; gap: 4px; z-index: 2000; transform: translateY(50px); opacity: 0; transition: all 0.3s; font-size: 10px; }
        .notif.show { transform: translateY(0); opacity: 1; }
        .notif.warning { border-color: var(--warning); }
        
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <div class="logo-icon">üêü</div>
                <span>TRAKIO</span>
                <span class="version">v5.5.3</span>
            </div>
        </div>
        <div class="header-center">
            <select class="event-select" id="eventSelect" onchange="onEventChange()">
                <option value="magasin">üìç Magasin</option>
            </select>
            <div class="status"><span class="status-dot"></span><span id="dateDisplay">-</span></div>
        </div>
        <div class="header-right">
            <button class="header-btn" onclick="refreshApp()" title="Mise √† jour">üîÑ</button>
            <button class="header-btn" id="queueBtn" onclick="openQueue()" title="File d'attente">‚è≥</button>
            <button class="header-btn" onclick="openReport()" title="Rapport">üìä</button>
            <button class="header-btn" onclick="openConfig()" title="Config">‚öôÔ∏è</button>
            <button class="header-btn" onclick="openArticles()" title="Articles">üìù</button>
            <button class="header-btn" onclick="exitApp()" title="Sortir">üè†</button>
        </div>
    </header>
    
    <div class="categories-bar">
        <button class="cat-btn cat-favoris" onclick="selectCat('favoris')" data-cat="favoris"><span>‚≠ê</span>Favoris</button>
        <button class="cat-btn cat-tous active" onclick="selectCat('')" data-cat=""><span>üì¶</span>Tous</button>
        <button class="cat-btn cat-poissons" onclick="selectCat('poissons')" data-cat="poissons"><span>üêü</span>Poissons</button>
        <button class="cat-btn cat-crustaces" onclick="selectCat('crustaces')" data-cat="crustaces"><span>ü¶ê</span>Crustac√©s</button>
        <button class="cat-btn cat-coquillages" onclick="selectCat('coquillages')" data-cat="coquillages"><span>ü¶™</span>Coquillages</button>
        <button class="cat-btn cat-fumes" onclick="selectCat('fumes')" data-cat="fumes"><span>üî•</span>Fum√©s</button>
        <button class="cat-btn cat-traiteur" onclick="selectCat('traiteur')" data-cat="traiteur"><span>üçΩÔ∏è</span>Traiteur</button>
        <button class="cat-btn cat-epicerie" onclick="selectCat('epicerie')" data-cat="epicerie"><span>üõí</span>√âpicerie</button>
    </div>
    
    <div class="main">
        <div class="articles-zone">
            <div class="search-bar">
                <div class="search-wrap">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Rechercher..." id="searchInput" oninput="filter()">
                </div>
            </div>
            <div class="articles-grid" id="grid"></div>
        </div>
        
        <div class="ticket-zone">
            <div class="ticket-header">
                <div class="ticket-title">üßæ Ticket</div>
                <div class="ticket-count" id="ticketCount">0</div>
            </div>
            <div class="ticket-items" id="ticketItems"><div class="empty-ticket"><span>üõí</span><span>Vide</span></div></div>
            <div class="ticket-totals">
                <div class="total-row"><span>HT</span><span id="ht">0.00</span></div>
                <div class="total-row"><span>TVA 2.6%</span><span id="tva">0.00</span></div>
                <div class="discount-row"><label>Remise</label><input type="number" id="disc" value="0" min="0" step="0.05" onchange="totals()"></div>
                <div class="total-row grand"><span>TOTAL</span><span id="total">0.00 CHF</span></div>
            </div>
            <div class="payment-section">
                <div class="payment-grid">
                    <button class="pay-btn cash" onclick="openPayment('cash')"><span>üíµ</span>Esp√®ces</button>
                    <button class="pay-btn card" onclick="openPayment('card')"><span>üí≥</span>Carte</button>
                    <button class="pay-btn twint" onclick="openPayment('twint')"><span>üì±</span>Twint</button>
                </div>
                <div class="action-btns">
                    <button class="action-btn" onclick="holdTicket()">‚è≥ Attente</button>
                    <button class="action-btn danger" onclick="clearCart()">üóëÔ∏è Vider</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL PES√âE -->
    <div class="modal-overlay" id="weightModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚öñÔ∏è <span id="wName">Article</span></div>
                <button class="modal-close" onclick="closeW()">√ó</button>
            </div>
            <div class="weight-display"><span class="weight-value" id="wVal">0.000</span><span class="weight-unit">kg</span></div>
            <div class="weight-info"><span id="wPrice">0.00/kg</span> = <strong id="wTotal">0.00 CHF</strong></div>
            <div class="numpad">
                <button class="numpad-btn" onclick="np('1')">1</button>
                <button class="numpad-btn" onclick="np('2')">2</button>
                <button class="numpad-btn" onclick="np('3')">3</button>
                <button class="numpad-btn" onclick="np('4')">4</button>
                <button class="numpad-btn" onclick="np('5')">5</button>
                <button class="numpad-btn" onclick="np('6')">6</button>
                <button class="numpad-btn" onclick="np('7')">7</button>
                <button class="numpad-btn" onclick="np('8')">8</button>
                <button class="numpad-btn" onclick="np('9')">9</button>
                <button class="numpad-btn clear" onclick="np('C')">C</button>
                <button class="numpad-btn" onclick="np('0')">0</button>
                <button class="numpad-btn" onclick="np('.')">.</button>
            </div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeW()">Annuler</button>
                <button class="confirm" onclick="confirmW()">‚úì OK</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PAIEMENT -->
    <div class="modal-overlay" id="payModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title"><span id="payIcon">üíµ</span> <span id="payTitle">Paiement</span></div>
                <button class="modal-close" onclick="closePayment()">√ó</button>
            </div>
            <div class="cash-display"><div class="cash-label">√Ä payer</div><div class="cash-amount" id="payTotal">0.00 CHF</div></div>
            
            <div id="cashOptions">
                <div class="cash-bills">
                    <button class="cash-bill" onclick="selBill(10)"><div class="cash-bill-val">10</div><div class="cash-bill-label">CHF</div></button>
                    <button class="cash-bill" onclick="selBill(20)"><div class="cash-bill-val">20</div><div class="cash-bill-label">CHF</div></button>
                    <button class="cash-bill" onclick="selBill(50)"><div class="cash-bill-val">50</div><div class="cash-bill-label">CHF</div></button>
                    <button class="cash-bill" onclick="selBill(100)"><div class="cash-bill-val">100</div><div class="cash-bill-label">CHF</div></button>
                    <button class="cash-bill" onclick="selBill(200)"><div class="cash-bill-val">200</div><div class="cash-bill-label">CHF</div></button>
                    <button class="cash-bill" onclick="selExact()"><div class="cash-bill-val">‚úì</div><div class="cash-bill-label">Exact</div></button>
                </div>
                <input type="number" class="cash-input" id="cashIn" placeholder="Montant re√ßu" step="0.05" oninput="calcCh()">
                <div class="cash-change" id="cashCh"><div class="cash-change-label">√Ä rendre</div><div class="cash-change-val" id="cashChVal">0.00</div></div>
            </div>
            
            <div class="pay-options">
                <div class="pay-option selected" onclick="selectPayOpt('done')">
                    <div class="pay-option-icon">‚úÖ</div>
                    <div class="pay-option-label">Termin√©</div>
                </div>
                <div class="pay-option" onclick="selectPayOpt('hold')">
                    <div class="pay-option-icon">‚è≥</div>
                    <div class="pay-option-label">En attente</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="cancel" onclick="closePayment()">Annuler</button>
                <button class="confirm" onclick="confirmPayment()">‚úì Valider</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL FILE D'ATTENTE -->
    <div class="modal-overlay" id="queueModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚è≥ File d'attente</div>
                <button class="modal-close" onclick="closeQueue()">√ó</button>
            </div>
            <div class="queue-list" id="queueList">
                <div style="text-align:center;color:var(--text-muted);padding:20px;font-size:11px;">Aucun client en attente</div>
            </div>
        </div>
    </div>
    
    <!-- MODAL D√âTAIL FILE D'ATTENTE -->
    <div class="modal-overlay" id="queueDetailModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üë§ Client <span id="queueDetailNum">#1</span></div>
                <button class="modal-close" onclick="closeQueueDetail()">√ó</button>
            </div>
            <div class="queue-detail-status" id="queueDetailStatus">‚è≥ Non pay√©</div>
            <div class="queue-detail-items" id="queueDetailItems"></div>
            <div class="queue-detail-total">
                <span>TOTAL</span>
                <span id="queueDetailTotal">0.00 CHF</span>
            </div>
            <div class="modal-actions" id="queueDetailActions">
                <button class="cancel" onclick="closeQueueDetail()">Fermer</button>
                <button class="confirm" id="queueDetailBtn" onclick="handleQueueAction()">‚úì Servi</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL RAPPORT -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal large">
            <div class="modal-header">
                <div class="modal-title">üìä Rapport des ventes</div>
                <button class="modal-close" onclick="closeReport()">√ó</button>
            </div>
            
            <div class="report-tabs">
                <button class="report-tab active" onclick="setReportTab('today')">üìÖ Aujourd'hui</button>
                <button class="report-tab" onclick="setReportTab('history')">üìú Historique</button>
            </div>
            
            <div id="reportToday">
                <div class="report-filters">
                    <div class="report-filter">
                        <label>üìç Lieu actuel</label>
                        <select id="rptEventToday" onchange="renderReportToday()">
                            <option value="">Tous les lieux</option>
                        </select>
                    </div>
                </div>
                <div class="report-summary">
                    <div class="report-stat"><div class="report-stat-value" id="rptTotal">0.00</div><div class="report-stat-label">Total CHF</div></div>
                    <div class="report-stat"><div class="report-stat-value" id="rptCount">0</div><div class="report-stat-label">Tickets</div></div>
                    <div class="report-stat"><div class="report-stat-value" id="rptCash">0.00</div><div class="report-stat-label">üíµ Esp√®ces</div></div>
                    <div class="report-stat"><div class="report-stat-value" id="rptCard">0.00</div><div class="report-stat-label">üí≥ Carte/Twint</div></div>
                </div>
                <div style="font-size:10px;color:var(--text-muted);margin-bottom:6px;">Ventes du jour :</div>
                <div class="report-list" id="reportList"></div>
            </div>
            
            <div id="reportHistory" style="display:none;">
                <div class="report-filters">
                    <div class="report-filter">
                        <label>üìÖ Date d√©but</label>
                        <input type="date" id="rptDateFrom" onchange="renderReportHistory()">
                    </div>
                    <div class="report-filter">
                        <label>üìÖ Date fin</label>
                        <input type="date" id="rptDateTo" onchange="renderReportHistory()">
                    </div>
                    <div class="report-filter">
                        <label>üìç Lieu</label>
                        <select id="rptEventHistory" onchange="renderReportHistory()">
                            <option value="">Tous les lieux</option>
                        </select>
                    </div>
                </div>
                <div class="report-summary">
                    <div class="report-stat"><div class="report-stat-value" id="rptTotalH">0.00</div><div class="report-stat-label">Total CHF</div></div>
                    <div class="report-stat"><div class="report-stat-value" id="rptCountH">0</div><div class="report-stat-label">Tickets</div></div>
                    <div class="report-stat"><div class="report-stat-value" id="rptCashH">0.00</div><div class="report-stat-label">üíµ Esp√®ces</div></div>
                    <div class="report-stat"><div class="report-stat-value" id="rptCardH">0.00</div><div class="report-stat-label">üí≥ Carte/Twint</div></div>
                </div>
                <div style="font-size:10px;color:var(--text-muted);margin-bottom:6px;">Historique :</div>
                <div class="report-list" id="reportListHistory"></div>
            </div>
            
            <div class="modal-actions" style="margin-top:12px;">
                <button class="cancel" onclick="exportReportCSV()">üì§ Export CSV</button>
                <button class="confirm" onclick="closeReport()">Fermer</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL CONFIG -->
    <div class="modal-overlay" id="configModal">
        <div class="modal large">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Configuration</div>
                <button class="modal-close" onclick="closeConfig()">√ó</button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="setConfigTab('events')">üìç Lieux</button>
                <button class="modal-tab" onclick="setConfigTab('new')">‚ûï Nouveau</button>
                <button class="modal-tab" onclick="setConfigTab('backup')">üíæ Backup</button>
            </div>
            <div class="modal-content active" id="configEvents">
                <div id="eventsList"></div>
            </div>
            <div class="modal-content" id="configNew">
                <div class="config-group"><label>Nom du lieu</label><input type="text" id="newEventName" placeholder="Ex: March√© de Nyon"></div>
                <div class="config-row">
                    <div class="config-group"><label>Remise d√©faut (%)</label><input type="number" id="newEventDiscount" value="0" min="0" max="100"></div>
                    <div class="config-group"><label>Commission (%)</label><input type="number" id="newEventCommission" value="0" min="0" max="100"></div>
                </div>
                <div class="config-group"><label>Type</label><select id="newEventType"><option value="magasin">Magasin</option><option value="marche">March√©</option><option value="manifestation">Manifestation</option></select></div>
                <div class="modal-actions">
                    <button class="confirm" onclick="addEvent()">‚ûï Ajouter</button>
                </div>
            </div>
            <div class="modal-content" id="configBackup">
                <div style="text-align:center;padding:10px;">
                    <p style="font-size:11px;color:var(--text-muted);margin-bottom:15px;">Sauvegarde toutes tes donn√©es : articles, ventes, lieux, file d'attente</p>
                    <div class="modal-actions" style="margin-bottom:15px;">
                        <button class="confirm" onclick="exportData()">üì§ Exporter</button>
                    </div>
                    <hr style="border-color:var(--border);margin:15px 0;">
                    <p style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">Restaurer depuis un fichier backup :</p>
                    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
                    <div class="modal-actions">
                        <button class="cancel" onclick="document.getElementById('importFile').click()">üì• Importer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL ARTICLES -->
    <div class="modal-overlay" id="articlesModal">
        <div class="modal large">
            <div class="modal-header">
                <div class="modal-title">üìù Gestion Articles</div>
                <button class="modal-close" onclick="closeArticles()">√ó</button>
            </div>
            <div class="search-bar" style="padding:0;margin-bottom:10px;">
                <div class="search-wrap">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Rechercher article..." id="articleSearchInput" oninput="filterArticles()">
                </div>
            </div>
            <div class="article-edit-list" id="articleEditList"></div>
        </div>
    </div>
    
    <!-- MODAL EDIT ARTICLE -->
    <div class="modal-overlay" id="editArticleModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚úèÔ∏è Modifier article</div>
                <button class="modal-close" onclick="closeEditArticle()">√ó</button>
            </div>
            <div class="config-group"><label>Nom</label><input type="text" id="editArtName"></div>
            <div class="config-row">
                <div class="config-group"><label>Prix</label><input type="number" id="editArtPrice" step="0.05"></div>
                <div class="config-group"><label>Unit√©</label><select id="editArtUnit"><option value="kg">kg</option><option value="pce">pi√®ce</option></select></div>
            </div>
            <div class="config-group"><label>Cat√©gorie</label><select id="editArtCat"><option value="poissons">üêü Poissons</option><option value="crustaces">ü¶ê Crustac√©s</option><option value="coquillages">ü¶™ Coquillages</option><option value="fumes">üî• Fum√©s</option><option value="traiteur">üçΩÔ∏è Traiteur</option><option value="epicerie">üõí √âpicerie</option></select></div>
            <div class="config-group" style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="editArtFav"><label style="margin:0;">‚≠ê Favori</label></div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeEditArticle()">Annuler</button>
                <button class="confirm" onclick="saveArticle()">üíæ Sauver</button>
            </div>
        </div>
    </div>
    
    <div class="install-prompt" id="installPrompt">
        <span>üì≤</span>
        <span class="install-prompt-text">Installer pour plein √©cran</span>
        <button class="install-btn" id="installBtn">Installer</button>
        <button class="install-close" onclick="hideInstall()">√ó</button>
    </div>
    
    <div class="notif" id="notif"><span id="nIcon">‚úì</span><span id="nText">OK</span></div>
    
    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBLU26IZVQQ0I7DHVY14GuZIZe-eZAm2bQ",
            authDomain: "trakio-pilot-6e97a.firebaseapp.com",
            projectId: "trakio-pilot-6e97a",
            storageBucket: "trakio-pilot-6e97a.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abc123"
        };
        
        let db = null;
        let firebaseReady = false;
        
        // Init Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebaseReady = true;
            console.log('üî• Firebase connect√©');
        } catch(e) {
            console.warn('Firebase non disponible, mode offline');
        }
        
        // FIREBASE SYNC FUNCTIONS
        async function syncToFirebase(collection, data) {
            if (!firebaseReady || !db) {
                console.log('‚ö†Ô∏è Firebase non disponible, donn√©es en local seulement');
                return false;
            }
            try {
                await db.collection(collection).doc('caisse').set({
                    data: data,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    device: 'caisse-pwa'
                }, { merge: true });
                updateSyncStatus(true);
                console.log('üî• Sync OK:', collection);
                return true;
            } catch(e) {
                console.warn('‚ùå Sync error:', collection, e);
                updateSyncStatus(false);
                return false;
            }
        }
        
        async function loadFromFirebase(collection, defaultData) {
            if (!firebaseReady || !db) return null;
            try {
                const doc = await db.collection(collection).doc('caisse').get();
                if (doc.exists && doc.data().data !== undefined) {
                    return doc.data().data;
                }
            } catch(e) {
                console.warn('‚ùå Load error:', collection, e);
            }
            return null;
        }
        
        function updateSyncStatus(connected) {
            const dot = document.querySelector('.status-dot');
            if (dot) {
                dot.style.background = connected ? 'var(--success)' : 'var(--warning)';
            }
        }
        
        // PWA
        let deferredPrompt;
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
        window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; if (!window.matchMedia('(display-mode: standalone)').matches) document.getElementById('installPrompt').classList.add('show'); });
        document.getElementById('installBtn').onclick = async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; hideInstall(); };
        function hideInstall() { document.getElementById('installPrompt').classList.remove('show'); }
        
        // DATA
        const TVA = 2.6;
        let articles = [], filtered = [], currentCat = '', cart = [];
        let wArt = null, wStr = '', payMethod = 'cash', payOption = 'done', payToPay = 0;
        let queue = [], txCnt = 0, editingArticleId = null;
        let events = [];
        
        const DEFAULTS = [
            {id:'a1',name:'Saumon',category:'poissons',price:45,unit:'kg',fav:1},
            {id:'a2',name:'Perche',category:'poissons',price:58,unit:'kg',fav:1},
            {id:'a3',name:'Truite',category:'poissons',price:28,unit:'kg',fav:0},
            {id:'a4',name:'Sole',category:'poissons',price:65,unit:'kg',fav:0},
            {id:'a5',name:'Dorade',category:'poissons',price:38,unit:'kg',fav:0},
            {id:'a6',name:'Bar',category:'poissons',price:42,unit:'kg',fav:1},
            {id:'a7',name:'F√©ra',category:'poissons',price:48,unit:'kg',fav:1},
            {id:'a8',name:'Omble',category:'poissons',price:52,unit:'kg',fav:0},
            {id:'a9',name:'Cabillaud',category:'poissons',price:35,unit:'kg',fav:0},
            {id:'a10',name:'Thon',category:'poissons',price:85,unit:'kg',fav:0},
            {id:'b1',name:'Crevettes',category:'crustaces',price:32,unit:'kg',fav:1},
            {id:'b2',name:'Gambas',category:'crustaces',price:45,unit:'kg',fav:0},
            {id:'b3',name:'Homard',category:'crustaces',price:75,unit:'kg',fav:0},
            {id:'b4',name:'Langoustines',category:'crustaces',price:55,unit:'kg',fav:1},
            {id:'b5',name:'√âcrevisses',category:'crustaces',price:48,unit:'kg',fav:0},
            {id:'b6',name:'Tourteau',category:'crustaces',price:28,unit:'kg',fav:0},
            {id:'c1',name:'Hu√Ætres',category:'coquillages',price:24,unit:'pce',fav:1},
            {id:'c2',name:'Moules',category:'coquillages',price:8.5,unit:'kg',fav:1},
            {id:'c3',name:'St-Jacques',category:'coquillages',price:65,unit:'kg',fav:0},
            {id:'c4',name:'Palourdes',category:'coquillages',price:28,unit:'kg',fav:0},
            {id:'c5',name:'Coques',category:'coquillages',price:12,unit:'kg',fav:0},
            {id:'d1',name:'Saumon fum√©',category:'fumes',price:65,unit:'kg',fav:1},
            {id:'d2',name:'Truite fum√©e',category:'fumes',price:55,unit:'kg',fav:0},
            {id:'d3',name:'Haddock',category:'fumes',price:42,unit:'kg',fav:0},
            {id:'d4',name:'Maquereau',category:'fumes',price:28,unit:'kg',fav:0},
            {id:'d5',name:'Anguille',category:'fumes',price:75,unit:'kg',fav:0},
            {id:'e1',name:'Tarama',category:'traiteur',price:4.5,unit:'pce',fav:1},
            {id:'e2',name:'Rillettes',category:'traiteur',price:5.5,unit:'pce',fav:0},
            {id:'e3',name:'Salade mer',category:'traiteur',price:28,unit:'kg',fav:0},
            {id:'e4',name:'Terrine',category:'traiteur',price:6,unit:'pce',fav:0},
            {id:'e5',name:'Ceviche',category:'traiteur',price:8.5,unit:'pce',fav:1},
            {id:'e6',name:'Soupe',category:'traiteur',price:12,unit:'pce',fav:0},
            {id:'f1',name:'Citrons',category:'epicerie',price:3.5,unit:'pce',fav:0},
            {id:'f2',name:'Tartare',category:'epicerie',price:4,unit:'pce',fav:0},
            {id:'f3',name:'Mayo',category:'epicerie',price:3.5,unit:'pce',fav:0},
            {id:'f4',name:'Vin blanc',category:'epicerie',price:12,unit:'pce',fav:0},
            {id:'f5',name:'Huile',category:'epicerie',price:18,unit:'pce',fav:0},
            {id:'f6',name:'Sac iso',category:'epicerie',price:5,unit:'pce',fav:0}
        ];
        
        const DEFAULT_EVENTS = [
            {id:'magasin',name:'Magasin',type:'magasin',discount:0,commission:0},
            {id:'nyon',name:'March√© Nyon',type:'marche',discount:0,commission:0},
            {id:'morges',name:'March√© Morges',type:'marche',discount:0,commission:0}
        ];
        
        async function init() {
            // Migration anciennes cl√©s si n√©cessaire
            if (!localStorage.getItem('trakio_articles2') && localStorage.getItem('trakio_articles')) {
                localStorage.setItem('trakio_articles2', localStorage.getItem('trakio_articles'));
            }
            
            console.log('üöÄ Initialisation TRAKIO Caisse...');
            
            // Charger depuis Firebase d'abord (source de v√©rit√©)
            if (firebaseReady) {
                console.log('üî• Chargement depuis Firebase...');
                
                const fbArticles = await loadFromFirebase('articles', null);
                const fbEvents = await loadFromFirebase('events', null);
                const fbQueue = await loadFromFirebase('queue', null);
                const fbTx = await loadFromFirebase('transactions', null);
                const fbTxCounter = await loadFromFirebase('txCounter', null);
                
                // Articles
                if (fbArticles && fbArticles.length > 0) {
                    articles = fbArticles;
                    localStorage.setItem('trakio_articles2', JSON.stringify(articles));
                    console.log('‚úÖ Articles Firebase:', articles.length);
                } else {
                    articles = JSON.parse(localStorage.getItem('trakio_articles2') || 'null') || [...DEFAULTS];
                    await syncToFirebase('articles', articles);
                }
                
                // √âv√©nements
                if (fbEvents && fbEvents.length > 0) {
                    events = fbEvents;
                    localStorage.setItem('trakio_events', JSON.stringify(events));
                    console.log('‚úÖ √âv√©nements Firebase:', events.length);
                } else {
                    events = JSON.parse(localStorage.getItem('trakio_events') || 'null') || [...DEFAULT_EVENTS];
                    await syncToFirebase('events', events);
                }
                
                // File d'attente
                if (fbQueue) {
                    queue = fbQueue;
                    localStorage.setItem('trakio_queue', JSON.stringify(queue));
                    console.log('‚úÖ Queue Firebase:', queue.length);
                } else {
                    queue = JSON.parse(localStorage.getItem('trakio_queue') || '[]');
                    if (queue.length > 0) await syncToFirebase('queue', queue);
                }
                
                // Transactions
                if (fbTx && fbTx.length > 0) {
                    localStorage.setItem('trakio_tx', JSON.stringify(fbTx));
                    console.log('‚úÖ Transactions Firebase:', fbTx.length);
                }
                
                // Compteur TX
                if (fbTxCounter) {
                    txCnt = fbTxCounter;
                    localStorage.setItem('trakio_tx_counter', txCnt);
                } else {
                    txCnt = +localStorage.getItem('trakio_tx_counter') || 0;
                    if (txCnt > 0) await syncToFirebase('txCounter', txCnt);
                }
                
            } else {
                console.log('‚ö†Ô∏è Mode hors-ligne, chargement localStorage...');
                articles = JSON.parse(localStorage.getItem('trakio_articles2') || 'null') || [...DEFAULTS];
                events = JSON.parse(localStorage.getItem('trakio_events') || 'null') || [...DEFAULT_EVENTS];
                queue = JSON.parse(localStorage.getItem('trakio_queue') || '[]');
                txCnt = +localStorage.getItem('trakio_tx_counter') || 0;
            }
            
            // Sauvegarder en local (backup)
            localStorage.setItem('trakio_articles2', JSON.stringify(articles));
            localStorage.setItem('trakio_events', JSON.stringify(events));
            localStorage.setItem('trakio_queue', JSON.stringify(queue));
            
            document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('fr-CH');
            updateEventSelect();
            updateQueueBtn();
            filter();
            
            updateSyncStatus(firebaseReady);
            console.log('‚úÖ TRAKIO Caisse pr√™t!');
        }
        
        function updateEventSelect() {
            const sel = document.getElementById('eventSelect');
            sel.innerHTML = events.map(e => `<option value="${e.id}">üìç ${e.name}</option>`).join('');
        }
        
        function onEventChange() {
            const e = events.find(x => x.id === document.getElementById('eventSelect').value);
            if (e && e.discount > 0) { document.getElementById('disc').value = e.discount; totals(); }
        }
        
        function filter() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            filtered = articles.filter(a => {
                if (currentCat === 'favoris' && !a.fav) return false;
                if (currentCat && currentCat !== 'favoris' && a.category !== currentCat) return false;
                return !q || a.name.toLowerCase().includes(q);
            });
            render();
        }
        
        function selectCat(c) { currentCat = c; document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.dataset.cat === c)); filter(); }
        
        function render() {
            const g = document.getElementById('grid');
            const icons = {poissons:'üêü',crustaces:'ü¶ê',coquillages:'ü¶™',fumes:'üî•',traiteur:'üçΩÔ∏è',epicerie:'üõí'};
            const colors = {poissons:'#0ea5e9',crustaces:'#ef4444',coquillages:'#8b5cf6',fumes:'#f97316',traiteur:'#10b981',epicerie:'#6366f1'};
            if (!filtered.length) { g.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text-muted);font-size:9px;">Aucun article</div>'; return; }
            g.innerHTML = filtered.map(a => `<div class="tile" onclick="add('${a.id}')" style="--cat-color:${colors[a.category]||'#64748b'}">${a.fav?'<span class="tile-fav">‚≠ê</span>':''}<div class="tile-icon">${icons[a.category]||'üì¶'}</div><div class="tile-name">${a.name}</div><div class="tile-price">${a.price.toFixed(2)}</div></div>`).join('');
        }
        
        function add(id) {
            const a = articles.find(x => x.id === id);
            if (!a) return;
            if (a.unit === 'kg') { openW(a); return; }
            const e = cart.find(x => x.aid === id && !x.isW);
            if (e) e.qty++; else cart.push({id: Date.now().toString(36), aid: a.id, name: a.name, price: a.price, unit: a.unit, qty: 1, isW: false});
            renderCart(); notify(a.name, 'success', 600);
        }
        
        function updQty(id, d) { const i = cart.find(x => x.id === id); if (!i) return; i.qty = Math.max(0.1, i.qty + d); if (i.qty < 0.05) cart = cart.filter(x => x.id !== id); renderCart(); }
        function del(id) { cart = cart.filter(x => x.id !== id); renderCart(); }
        function clearCart() { if (cart.length && !confirm('Vider ?')) return; cart = []; document.getElementById('disc').value = 0; renderCart(); }
        
        function renderCart() {
            const c = document.getElementById('ticketItems');
            const t = cart.reduce((s, i) => s + i.qty, 0);
            document.getElementById('ticketCount').textContent = t.toFixed(t % 1 ? 1 : 0);
            if (!cart.length) { c.innerHTML = '<div class="empty-ticket"><span>üõí</span><span>Vide</span></div>'; totals(); return; }
            c.innerHTML = cart.map(i => `<div class="ticket-item"><div class="item-info"><div class="item-name">${i.name}</div><div class="item-details">${i.isW ? i.qty.toFixed(3)+'kg' : i.qty} √ó ${i.price.toFixed(2)}</div></div><div class="qty-btns"><button class="qty-btn" onclick="updQty('${i.id}',${i.isW?-0.1:-1})">‚àí</button><span class="qty-val">${i.isW ? i.qty.toFixed(2) : i.qty}</span><button class="qty-btn" onclick="updQty('${i.id}',${i.isW?0.1:1})">+</button></div><div class="item-price">${(i.price * i.qty).toFixed(2)}</div><button class="del-btn" onclick="del('${i.id}')">√ó</button></div>`).join('');
            totals();
        }
        
        function totals() {
            const d = +document.getElementById('disc').value || 0;
            let ttc = cart.reduce((s, i) => s + i.price * i.qty, 0);
            const ht = ttc / (1 + TVA/100);
            document.getElementById('ht').textContent = ht.toFixed(2);
            document.getElementById('tva').textContent = (ttc - ht).toFixed(2);
            document.getElementById('total').textContent = Math.max(0, swiss(ttc - d)).toFixed(2) + ' CHF';
        }
        
        // WEIGHT MODAL
        function openW(a) { wArt = a; wStr = ''; document.getElementById('wName').textContent = a.name; document.getElementById('wPrice').textContent = a.price.toFixed(2) + '/kg'; document.getElementById('wVal').textContent = '0.000'; document.getElementById('wTotal').textContent = '0.00 CHF'; document.getElementById('weightModal').classList.add('active'); }
        function closeW() { document.getElementById('weightModal').classList.remove('active'); }
        function np(k) { if (k === 'C') wStr = ''; else if (k === '.') { if (!wStr.includes('.')) wStr += wStr ? '.' : '0.'; } else { const p = wStr.split('.'); if (p[1]?.length >= 3) return; wStr += k; } const w = +wStr || 0; document.getElementById('wVal').textContent = w.toFixed(3); document.getElementById('wTotal').textContent = (w * (wArt?.price || 0)).toFixed(2) + ' CHF'; }
        function confirmW() { const w = +wStr || 0; if (w <= 0) { notify('Poids?', 'warning'); return; } cart.push({id: Date.now().toString(36), aid: wArt.id, name: wArt.name, price: wArt.price, unit: 'kg', qty: w, isW: true}); closeW(); renderCart(); notify(wArt.name + ' ' + w.toFixed(3) + 'kg', 'success'); }
        
        // PAYMENT MODAL
        function openPayment(method) {
            if (!cart.length) { notify('Panier vide', 'warning'); return; }
            payMethod = method; payOption = 'done';
            const d = +document.getElementById('disc').value || 0;
            payToPay = swiss(cart.reduce((s, i) => s + i.price * i.qty, 0) - d);
            
            document.getElementById('payTotal').textContent = payToPay.toFixed(2) + ' CHF';
            document.getElementById('payIcon').textContent = method === 'cash' ? 'üíµ' : method === 'card' ? 'üí≥' : 'üì±';
            document.getElementById('payTitle').textContent = method === 'cash' ? 'Esp√®ces' : method === 'card' ? 'Carte' : 'Twint';
            document.getElementById('cashOptions').style.display = method === 'cash' ? 'block' : 'none';
            document.getElementById('cashIn').value = '';
            document.getElementById('cashCh').classList.remove('visible');
            document.querySelectorAll('.cash-bill').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.pay-option').forEach(o => o.classList.remove('selected'));
            document.querySelector('.pay-option').classList.add('selected');
            
            document.getElementById('payModal').classList.add('active');
        }
        
        function closePayment() { document.getElementById('payModal').classList.remove('active'); }
        
        function selBill(v) { document.querySelectorAll('.cash-bill').forEach(b => b.classList.remove('selected')); event.target.closest('.cash-bill').classList.add('selected'); document.getElementById('cashIn').value = v; calcCh(); }
        function selExact() { document.querySelectorAll('.cash-bill').forEach(b => b.classList.remove('selected')); event.target.closest('.cash-bill').classList.add('selected'); document.getElementById('cashIn').value = payToPay; calcCh(); }
        function calcCh() { const r = +document.getElementById('cashIn').value || 0; document.getElementById('cashChVal').textContent = Math.max(0, swiss(r - payToPay)).toFixed(2) + ' CHF'; document.getElementById('cashCh').classList.toggle('visible', r >= payToPay); }
        
        function selectPayOpt(opt) { payOption = opt; document.querySelectorAll('.pay-option').forEach(o => o.classList.remove('selected')); event.target.closest('.pay-option').classList.add('selected'); }
        
        function confirmPayment() {
            // Pour esp√®ces, v√©rifier montant suffisant
            if (payMethod === 'cash') {
                const received = +document.getElementById('cashIn').value || 0;
                if (received < payToPay) { notify('Montant insuffisant', 'warning'); return; }
            }
            
            if (payOption === 'hold') {
                // Mettre en attente (pay√© mais attend)
                queue.push({ id: Date.now().toString(36), num: queue.length + 1, items: [...cart], discount: +document.getElementById('disc').value || 0, total: payToPay, method: payMethod, paid: true, time: new Date().toTimeString().slice(0,5) });
                localStorage.setItem('trakio_queue', JSON.stringify(queue));
                syncToFirebase('queue', queue);
                updateQueueBtn();
                notify('‚è≥ Client en attente', 'success');
            } else {
                // Enregistrer la vente
                saveTx(payMethod, payToPay);
                notify('‚úÖ ' + payToPay.toFixed(2) + ' CHF', 'success');
            }
            
            closePayment(); cart = []; document.getElementById('disc').value = 0; renderCart();
        }
        
        function saveTx(method, total) {
            txCnt++; 
            localStorage.setItem('trakio_tx_counter', txCnt);
            
            // R√©cup√©rer l'√©v√©nement complet
            const eventId = document.getElementById('eventSelect').value;
            const eventData = events.find(e => e.id === eventId) || { id: eventId, name: eventId, type: 'magasin', discount: 0, commission: 0 };
            
            const tx = { 
                id: Date.now().toString(36), 
                num: txCnt, 
                date: new Date().toISOString().slice(0,10), 
                time: new Date().toTimeString().slice(0,5), 
                timestamp: Date.now(),
                // √âv√©nement complet
                event: eventData.id,
                eventName: eventData.name,
                eventType: eventData.type,
                eventCommission: eventData.commission || 0,
                // Vente
                items: cart.map(i => ({name: i.name, price: i.price, qty: i.qty, isW: i.isW, unit: i.unit})), 
                itemsCount: cart.length,
                discount: +document.getElementById('disc').value || 0, 
                subtotal: cart.reduce((s, i) => s + i.price * i.qty, 0),
                total: total, 
                method: method,
                // Commission calcul√©e
                commission: eventData.commission ? swiss(total * eventData.commission / 100) : 0
            };
            
            const txs = JSON.parse(localStorage.getItem('trakio_tx') || '[]'); 
            txs.push(tx); 
            localStorage.setItem('trakio_tx', JSON.stringify(txs));
            
            // Sync Firebase (transactions + compteur)
            syncToFirebase('transactions', txs);
            syncToFirebase('txCounter', txCnt);
            
            console.log('üíæ Transaction #' + txCnt + ' enregistr√©e:', eventData.name, total + ' CHF');
        }
        
        function holdTicket() {
            if (!cart.length) { notify('Panier vide', 'warning'); return; }
            const d = +document.getElementById('disc').value || 0;
            const tot = swiss(cart.reduce((s, i) => s + i.price * i.qty, 0) - d);
            queue.push({ id: Date.now().toString(36), num: queue.length + 1, items: [...cart], discount: d, total: tot, method: null, paid: false, time: new Date().toTimeString().slice(0,5) });
            localStorage.setItem('trakio_queue', JSON.stringify(queue));
            syncToFirebase('queue', queue);
            updateQueueBtn(); cart = []; document.getElementById('disc').value = 0; renderCart();
            notify('‚è≥ Mis en attente', 'success');
        }
        
        // QUEUE
        let currentQueueId = null;
        
        function updateQueueBtn() { const btn = document.getElementById('queueBtn'); if (queue.length > 0) { btn.classList.add('has-queue'); btn.dataset.count = queue.length; } else { btn.classList.remove('has-queue'); } }
        
        function openQueue() { renderQueue(); document.getElementById('queueModal').classList.add('active'); }
        function closeQueue() { document.getElementById('queueModal').classList.remove('active'); }
        
        function renderQueue() {
            const list = document.getElementById('queueList');
            if (!queue.length) { list.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;font-size:11px;">Aucun client en attente</div>'; return; }
            list.innerHTML = queue.map((q, i) => `<div class="queue-item" onclick="openQueueDetail('${q.id}')"><div class="queue-num">#${i+1}</div><div class="queue-info"><div class="queue-info-top">${q.items.length} article(s) ‚Ä¢ ${q.time}</div><div class="queue-info-bottom">${q.paid ? '‚úÖ Pay√© ('+q.method+')' : '‚è≥ Non pay√©'}</div></div><div class="queue-total">${q.total.toFixed(2)}</div><button class="queue-del" onclick="event.stopPropagation();delQueue('${q.id}')">√ó</button></div>`).join('');
        }
        
        function openQueueDetail(id) {
            const q = queue.find(x => x.id === id);
            if (!q) return;
            currentQueueId = id;
            
            // Num√©ro
            const idx = queue.findIndex(x => x.id === id);
            document.getElementById('queueDetailNum').textContent = '#' + (idx + 1);
            
            // Status
            const statusEl = document.getElementById('queueDetailStatus');
            if (q.paid) {
                statusEl.textContent = '‚úÖ Pay√© (' + (q.method === 'cash' ? 'Esp√®ces' : q.method === 'card' ? 'Carte' : 'Twint') + ')';
                statusEl.className = 'queue-detail-status paid';
            } else {
                statusEl.textContent = '‚è≥ Non pay√©';
                statusEl.className = 'queue-detail-status unpaid';
            }
            
            // Articles
            document.getElementById('queueDetailItems').innerHTML = q.items.map(i => `
                <div class="queue-detail-item">
                    <div>
                        <div class="queue-detail-name">${i.name}</div>
                        <div class="queue-detail-qty">${i.isW ? i.qty.toFixed(3) + 'kg' : i.qty + 'x'} √ó ${i.price.toFixed(2)}</div>
                    </div>
                    <div class="queue-detail-price">${(i.price * i.qty).toFixed(2)}</div>
                </div>
            `).join('');
            
            // Total
            document.getElementById('queueDetailTotal').textContent = q.total.toFixed(2) + ' CHF';
            
            // Bouton action
            const btn = document.getElementById('queueDetailBtn');
            if (q.paid) {
                btn.textContent = '‚úì Client servi';
                btn.style.background = 'var(--success)';
            } else {
                btn.textContent = 'üõí Reprendre le panier';
                btn.style.background = 'var(--accent)';
            }
            
            closeQueue();
            document.getElementById('queueDetailModal').classList.add('active');
        }
        
        function closeQueueDetail() { document.getElementById('queueDetailModal').classList.remove('active'); currentQueueId = null; }
        
        function handleQueueAction() {
            const q = queue.find(x => x.id === currentQueueId);
            if (!q) return;
            
            if (q.paid) {
                // D√©j√† pay√© ‚Üí retirer de la file (servi)
                queue = queue.filter(x => x.id !== currentQueueId);
                localStorage.setItem('trakio_queue', JSON.stringify(queue));
                syncToFirebase('queue', queue);
                updateQueueBtn();
                closeQueueDetail();
                notify('‚úÖ Client servi', 'success');
            } else {
                // Non pay√© ‚Üí reprendre le panier
                cart = [...q.items];
                document.getElementById('disc').value = q.discount;
                queue = queue.filter(x => x.id !== currentQueueId);
                localStorage.setItem('trakio_queue', JSON.stringify(queue));
                syncToFirebase('queue', queue);
                updateQueueBtn();
                closeQueueDetail();
                renderCart();
                notify('üõí Panier repris', 'success');
            }
        }
        
        function delQueue(id) { if (!confirm('Supprimer de la file ?')) return; queue = queue.filter(x => x.id !== id); localStorage.setItem('trakio_queue', JSON.stringify(queue)); syncToFirebase('queue', queue); updateQueueBtn(); renderQueue(); }
        
        // REPORT
        function openReport() { 
            // Remplir les s√©lecteurs d'√©v√©nements
            const eventOptions = '<option value="">Tous les lieux</option>' + events.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            document.getElementById('rptEventToday').innerHTML = eventOptions;
            document.getElementById('rptEventHistory').innerHTML = eventOptions;
            
            // S√©lectionner l'√©v√©nement actuel
            document.getElementById('rptEventToday').value = document.getElementById('eventSelect').value;
            
            // Dates par d√©faut pour historique (30 derniers jours)
            const today = new Date().toISOString().slice(0,10);
            const monthAgo = new Date(Date.now() - 30*24*60*60*1000).toISOString().slice(0,10);
            document.getElementById('rptDateFrom').value = monthAgo;
            document.getElementById('rptDateTo').value = today;
            
            setReportTab('today');
            document.getElementById('reportModal').classList.add('active'); 
        }
        function closeReport() { document.getElementById('reportModal').classList.remove('active'); }
        
        function setReportTab(tab) {
            document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.report-tab[onclick*="${tab}"]`).classList.add('active');
            document.getElementById('reportToday').style.display = tab === 'today' ? 'block' : 'none';
            document.getElementById('reportHistory').style.display = tab === 'history' ? 'block' : 'none';
            if (tab === 'today') renderReportToday();
            else renderReportHistory();
        }
        
        function renderReportToday() {
            const today = new Date().toISOString().slice(0,10);
            const eventFilter = document.getElementById('rptEventToday').value;
            const allTxs = JSON.parse(localStorage.getItem('trakio_tx') || '[]');
            
            let txs = allTxs.filter(t => t.date === today);
            if (eventFilter) {
                // Filtrer par event ID ou eventName
                txs = txs.filter(t => t.event === eventFilter || t.eventName === eventFilter);
            }
            
            renderReportStats(txs, 'rptTotal', 'rptCount', 'rptCash', 'rptCard');
            renderReportList(txs, 'reportList', false);
        }
        
        function renderReportHistory() {
            const dateFrom = document.getElementById('rptDateFrom').value;
            const dateTo = document.getElementById('rptDateTo').value;
            const eventFilter = document.getElementById('rptEventHistory').value;
            const allTxs = JSON.parse(localStorage.getItem('trakio_tx') || '[]');
            
            let txs = allTxs.filter(t => {
                if (dateFrom && t.date < dateFrom) return false;
                if (dateTo && t.date > dateTo) return false;
                if (eventFilter) {
                    // Filtrer par event ID ou eventName
                    if (t.event !== eventFilter && t.eventName !== events.find(e => e.id === eventFilter)?.name) return false;
                }
                return true;
            });
            
            renderReportStats(txs, 'rptTotalH', 'rptCountH', 'rptCashH', 'rptCardH');
            renderReportList(txs, 'reportListHistory', true);
        }
        
        function renderReportStats(txs, totalId, countId, cashId, cardId) {
            const total = txs.reduce((s, t) => s + (t.total || 0), 0);
            const cash = txs.filter(t => t.method === 'cash').reduce((s, t) => s + (t.total || 0), 0);
            const card = txs.filter(t => t.method !== 'cash').reduce((s, t) => s + (t.total || 0), 0);
            const commission = txs.reduce((s, t) => s + (t.commission || 0), 0);
            
            document.getElementById(totalId).textContent = total.toFixed(2);
            document.getElementById(countId).textContent = txs.length;
            document.getElementById(cashId).textContent = cash.toFixed(2);
            document.getElementById(cardId).textContent = card.toFixed(2);
        }
        
        function renderReportList(txs, listId, showDate) {
            const methodIcons = {cash: 'üíµ', card: 'üí≥', twint: 'üì±'};
            const list = document.getElementById(listId);
            
            if (!txs.length) {
                list.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;font-size:11px;">Aucune vente</div>';
                return;
            }
            
            // Trier par date/heure d√©croissant
            const sorted = txs.slice().sort((a, b) => (b.date + b.time).localeCompare(a.date + a.time));
            
            list.innerHTML = sorted.map(t => {
                // Utiliser eventName stock√© dans la transaction, sinon chercher dans events
                const eventName = t.eventName || events.find(e => e.id === t.event)?.name || t.event || '-';
                const commission = t.commission ? ` <span style="color:var(--warning);font-size:8px;">(-${t.commission.toFixed(2)})</span>` : '';
                
                return `<div class="report-item">
                    <div class="report-item-left">
                        <span class="report-item-num">#${t.num}</span>
                        ${showDate ? `<span class="report-item-date">${t.date}</span>` : ''}
                        <span class="report-item-time">${t.time}</span>
                        <span class="report-item-method">${methodIcons[t.method] || 'üí∞'}</span>
                        <span class="report-item-event">üìç ${eventName}</span>
                    </div>
                    <div class="report-item-total">${(t.total || 0).toFixed(2)}${commission}</div>
                </div>`;
            }).join('');
        }
        
        function exportReportCSV() {
            const allTxs = JSON.parse(localStorage.getItem('trakio_tx') || '[]');
            if (!allTxs.length) { notify('Aucune donn√©e', 'warning'); return; }
            
            // Header CSV
            let csv = 'Num√©ro;Date;Heure;Lieu;Type;M√©thode;Articles;Nb Articles;Sous-total;Remise;Total;Commission\n';
            
            allTxs.forEach(t => {
                const eventName = t.eventName || events.find(e => e.id === t.event)?.name || t.event || '-';
                const articles = (t.items || []).map(i => `${i.name}(${i.qty})`).join(' / ');
                csv += `${t.num};${t.date};${t.time};"${eventName}";${t.eventType || ''};${t.method};"${articles}";${t.itemsCount || t.items?.length || 0};${t.subtotal || ''};${t.discount || 0};${t.total};${t.commission || 0}\n`;
            });
            
            // T√©l√©charger
            const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trakio-ventes-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            notify('üì§ CSV export√©', 'success');
        }
        
        // CONFIG
        function openConfig() { renderEvents(); document.getElementById('configModal').classList.add('active'); }
        function closeConfig() { document.getElementById('configModal').classList.remove('active'); }
        
        function setConfigTab(tab) { document.querySelectorAll('#configModal .modal-tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('#configModal .modal-content').forEach(c => c.classList.remove('active')); document.querySelector(`#configModal .modal-tab[onclick*="${tab}"]`).classList.add('active'); document.getElementById(tab === 'events' ? 'configEvents' : tab === 'new' ? 'configNew' : 'configBackup').classList.add('active'); }
        
        function renderEvents() { document.getElementById('eventsList').innerHTML = events.map(e => `<div class="event-card"><div class="event-card-header"><div class="event-card-name">üìç ${e.name}</div><div class="event-card-actions">${e.id !== 'magasin' ? `<button class="event-card-btn" onclick="delEvent('${e.id}')">üóëÔ∏è</button>` : ''}</div></div><div style="font-size:10px;color:var(--text-muted);">Type: ${e.type} ‚Ä¢ Remise: ${e.discount}% ‚Ä¢ Commission: ${e.commission}%</div></div>`).join(''); }
        
        function addEvent() {
            const name = document.getElementById('newEventName').value.trim();
            if (!name) { notify('Nom requis', 'warning'); return; }
            events.push({ id: Date.now().toString(36), name: name, type: document.getElementById('newEventType').value, discount: +document.getElementById('newEventDiscount').value || 0, commission: +document.getElementById('newEventCommission').value || 0 });
            localStorage.setItem('trakio_events', JSON.stringify(events));
            syncToFirebase('events', events);
            updateEventSelect(); document.getElementById('newEventName').value = ''; setConfigTab('events'); renderEvents();
            notify('‚úÖ Lieu ajout√©', 'success');
        }
        
        function delEvent(id) { if (!confirm('Supprimer ?')) return; events = events.filter(e => e.id !== id); localStorage.setItem('trakio_events', JSON.stringify(events)); syncToFirebase('events', events); updateEventSelect(); renderEvents(); }
        
        // BACKUP / RESTORE
        function exportData() {
            const data = {
                version: 'v5.5.3',
                date: new Date().toISOString(),
                articles: JSON.parse(localStorage.getItem('trakio_articles2') || '[]'),
                events: JSON.parse(localStorage.getItem('trakio_events') || '[]'),
                transactions: JSON.parse(localStorage.getItem('trakio_tx') || '[]'),
                queue: JSON.parse(localStorage.getItem('trakio_queue') || '[]'),
                txCounter: localStorage.getItem('trakio_tx_counter') || '0'
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trakio-backup-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            notify('üì§ Backup export√© !', 'success');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.articles || !data.events) {
                        notify('Fichier invalide', 'warning');
                        return;
                    }
                    if (!confirm('‚ö†Ô∏è Restaurer ce backup ?\n\nCela remplacera toutes les donn√©es actuelles.')) return;
                    
                    localStorage.setItem('trakio_articles2', JSON.stringify(data.articles));
                    localStorage.setItem('trakio_events', JSON.stringify(data.events));
                    localStorage.setItem('trakio_tx', JSON.stringify(data.transactions || []));
                    localStorage.setItem('trakio_queue', JSON.stringify(data.queue || []));
                    localStorage.setItem('trakio_tx_counter', data.txCounter || '0');
                    
                    notify('üì• Backup restaur√© !', 'success');
                    setTimeout(() => location.reload(), 1000);
                } catch (err) {
                    notify('Erreur lecture fichier', 'warning');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // ARTICLES EDIT
        function openArticles() { filterArticles(); document.getElementById('articlesModal').classList.add('active'); }
        function closeArticles() { document.getElementById('articlesModal').classList.remove('active'); }
        
        function filterArticles() {
            const q = document.getElementById('articleSearchInput').value.toLowerCase();
            const list = articles.filter(a => !q || a.name.toLowerCase().includes(q));
            const icons = {poissons:'üêü',crustaces:'ü¶ê',coquillages:'ü¶™',fumes:'üî•',traiteur:'üçΩÔ∏è',epicerie:'üõí'};
            document.getElementById('articleEditList').innerHTML = list.map(a => `<div class="article-edit-item"><div class="article-edit-icon">${icons[a.category] || 'üì¶'}</div><div class="article-edit-info"><div class="article-edit-name">${a.fav ? '‚≠ê ' : ''}${a.name}</div><div class="article-edit-cat">${a.category} ‚Ä¢ ${a.unit}</div></div><div class="article-edit-price">${a.price.toFixed(2)}</div><button class="article-edit-btn" onclick="editArticle('${a.id}')">‚úèÔ∏è</button></div>`).join('');
        }
        
        function editArticle(id) {
            const a = articles.find(x => x.id === id);
            if (!a) return;
            editingArticleId = id;
            document.getElementById('editArtName').value = a.name;
            document.getElementById('editArtPrice').value = a.price;
            document.getElementById('editArtUnit').value = a.unit;
            document.getElementById('editArtCat').value = a.category;
            document.getElementById('editArtFav').checked = !!a.fav;
            document.getElementById('editArticleModal').classList.add('active');
        }
        
        function closeEditArticle() { document.getElementById('editArticleModal').classList.remove('active'); }
        
        function saveArticle() {
            const a = articles.find(x => x.id === editingArticleId);
            if (!a) return;
            a.name = document.getElementById('editArtName').value.trim();
            a.price = +document.getElementById('editArtPrice').value || 0;
            a.unit = document.getElementById('editArtUnit').value;
            a.category = document.getElementById('editArtCat').value;
            a.fav = document.getElementById('editArtFav').checked ? 1 : 0;
            localStorage.setItem('trakio_articles2', JSON.stringify(articles));
            syncToFirebase('articles', articles);
            closeEditArticle(); filterArticles(); filter();
            notify('üíæ Sauvegard√©', 'success');
        }
        
        // UTILS
        function swiss(n) { return Math.round(n * 20) / 20; }
        function notify(msg, type = 'success', dur = 1500) { const n = document.getElementById('notif'); document.getElementById('nIcon').textContent = type === 'success' ? '‚úì' : '‚ö†'; document.getElementById('nText').textContent = msg; n.className = `notif ${type} show`; setTimeout(() => n.classList.remove('show'), dur); }
        
        function exitApp() {
            if (cart.length > 0) {
                if (!confirm('‚ö†Ô∏è Panier non vide !\n\nVoulez-vous vraiment quitter ?')) return;
            } else {
                if (!confirm('Quitter la caisse ?')) return;
            }
            location.href = 'index.html';
        }
        
        function refreshApp() {
            if (cart.length > 0) {
                if (!confirm('‚ö†Ô∏è Panier non vide !\n\nVoulez-vous vraiment actualiser ?')) return;
            }
            // Vider le cache du Service Worker et recharger
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                }).then(() => {
                    location.reload(true);
                });
            } else {
                location.reload(true);
            }
        }
        
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeW(); closePayment(); closeQueue(); closeQueueDetail(); closeReport(); closeConfig(); closeArticles(); closeEditArticle(); } });
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

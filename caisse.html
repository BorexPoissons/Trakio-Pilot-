<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caisse - TRAKIO v5.1.0</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêü</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (optionnel - mode offline first) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-deep: #030712;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-input: #0f172a;
            --bg-dark: #0f172a;
            --border: #334155;
            --text: #f8fafc;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --primary: #06b6d4;
            --primary-hover: #22d3ee;
            --accent-cyan: #06b6d4;
            --accent-teal: #14b8a6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --gradient: linear-gradient(135deg, #06b6d4, #14b8a6);
            --gradient-main: linear-gradient(135deg, #06b6d4 0%, #14b8a6 50%, #10b981 100%);
        }
        
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }
        
        /* ============================================
           HEADER COMPACT v5.1.0 - Style unifi√©
        ============================================ */
        .main-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 16px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--text);
        }
        
        .logo-icon { font-size: 22px; }
        .logo-text { 
            font-size: 16px; 
            font-weight: 700;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .nav-version {
            font-size: 9px;
            padding: 2px 6px;
            background: rgba(6, 182, 212, 0.2);
            border-radius: 4px;
            color: var(--accent-cyan);
            font-weight: 600;
            margin-left: 8px;
        }
        
        .header-center {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .event-config {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 14px;
            background: var(--bg-hover);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .event-config:hover { background: var(--border); }
        
        .event-name {
            font-weight: 600;
            font-size: 14px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .event-date {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .event-badge {
            padding: 3px 8px;
            background: var(--gradient);
            color: white;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-input);
            border-radius: 20px;
            font-size: 12px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.online { background: var(--success); }
        .status-dot.offline { background: var(--warning); }
        
        .header-btn {
            padding: 8px 14px;
            background: var(--bg-input);
            border: none;
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .header-btn:hover { background: var(--border); }
        .header-btn.primary { background: var(--gradient); color: white; }
        
        /* ============================================
           LAYOUT 3 COLONNES
        ============================================ */
        .pos-container {
            display: grid;
            grid-template-columns: 1fr 90px 550px;
            gap: 12px;
            height: calc(100vh - 50px);
            padding: 12px;
            overflow: hidden;
        }
        
        @media (max-width: 1400px) {
            .pos-container {
                grid-template-columns: 1fr 80px 480px;
            }
        }
        
        @media (max-width: 1200px) {
            .pos-container {
                grid-template-columns: 1fr 80px 420px;
            }
        }
        
        @media (max-width: 900px) {
            .pos-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: auto;
                overflow: auto;
            }
            
            .categories-col {
                display: flex !important;
                flex-direction: row !important;
                overflow-x: auto;
                gap: 8px;
                padding: 10px 0;
                order: 1;
            }
            
            .articles-col { order: 2; }
            .ticket-col { order: 3; }
            
            .category-btn {
                min-width: 70px;
                height: auto !important;
                padding: 10px !important;
            }
        }
        
        /* ============================================
           COLONNE ARTICLES
        ============================================ */
        .articles-col {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .col-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(20, 184, 166, 0.05));
        }
        
        .col-title {
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .col-badge {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
        }
        
        .search-input {
            width: calc(100% - 24px);
            margin: 12px;
            padding: 10px 14px 10px 38px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }
        
        .search-wrapper {
            position: relative;
        }
        
        .search-wrapper::before {
            content: 'üîç';
            position: absolute;
            left: 24px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }
        
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            padding: 10px;
            overflow-y: hidden;
            flex: 1;
        }
        
        .articles-pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        
        .pagination-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            color: white;
        }
        
        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .pagination-info {
            font-size: 13px;
            color: var(--text-secondary);
            min-width: 80px;
            text-align: center;
        }
        
        .article-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            position: relative;
            overflow: hidden;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
        }
        
        .article-btn:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(6, 182, 212, 0.25);
        }
        
        .article-btn:active { transform: scale(0.98); }
        
        .article-color-bar {
            height: 5px;
            width: 100%;
            flex-shrink: 0;
        }
        
        .article-content {
            padding: 10px 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex: 1;
            min-height: 0;
        }
        
        .article-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text);
            line-height: 1.25;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .article-origin {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .article-price-section {
            margin-top: auto;
            padding-top: 6px;
        }
        
        .article-price {
            font-size: 15px;
            font-weight: 700;
            color: var(--accent-cyan);
        }
        
        .article-unit {
            font-size: 10px;
            color: var(--text-muted);
        }
        
        .article-favorite {
            position: absolute;
            top: 8px;
            right: 6px;
            font-size: 12px;
        }
        
        .article-image {
            width: 100%;
            flex: 1;
            min-height: 0;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 0;
        }
        
        .article-btn.has-image {
            display: flex;
            flex-direction: column;
        }
        
        .article-btn.has-image .article-header {
            padding: 6px 8px 4px;
            text-align: center;
        }
        
        .article-btn.has-image .article-header .article-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text);
            -webkit-line-clamp: 1;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .article-btn.has-image .article-content {
            padding: 4px 8px 8px;
            flex: 0 0 auto;
            text-align: center;
        }
        
        .article-btn.has-image .article-price-section {
            padding-top: 0;
        }
        
        .article-btn.has-image .article-price {
            font-size: 13px;
        }
        
        .article-btn.has-image .article-unit {
            font-size: 9px;
        }
        
        /* Upload image dans le formulaire */
        .image-upload-container {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-hover);
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .image-preview {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: var(--bg-card);
            border: 2px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--text-muted);
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-preview.has-image {
            border-style: solid;
            border-color: var(--accent-cyan);
        }
        
        .image-upload-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }
        
        .image-upload-btn {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .image-upload-btn:hover {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }
        
        .image-upload-btn.remove {
            background: transparent;
            color: var(--danger);
            border-color: var(--danger);
        }
        
        .image-upload-btn.remove:hover {
            background: var(--danger);
            color: white;
        }
        
        /* Recherche dans modal */
        .modal-search-wrapper {
            margin-bottom: 12px;
        }
        
        .modal-search-input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-family: inherit;
        }
        
        .modal-search-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        .modal-search-input::placeholder {
            color: var(--text-muted);
        }
        
        /* Modal Paiement Esp√®ces */
        .modal-cash {
            width: 400px;
            max-width: 95vw;
        }
        
        .cash-total-display {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-teal));
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 24px;
        }
        
        .cash-total-label {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .cash-total-amount {
            font-size: 42px;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .cash-given-section {
            margin-bottom: 20px;
        }
        
        .cash-given-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .cash-bills {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .cash-bill-btn {
            aspect-ratio: 1;
            border: 2px solid var(--border);
            background: var(--bg-primary);
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cash-bill-btn:hover {
            border-color: var(--accent-cyan);
            background: rgba(6, 182, 212, 0.1);
            transform: scale(1.05);
        }
        
        .cash-bill-btn:active {
            transform: scale(0.95);
        }
        
        .cash-custom {
            display: flex;
            gap: 10px;
        }
        
        .cash-custom input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 16px;
            font-family: inherit;
        }
        
        .cash-custom input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        .cash-custom-btn {
            padding: 12px 24px;
            background: var(--accent-cyan);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cash-custom-btn:hover {
            background: var(--accent-teal);
        }
        
        .cash-exact-btn-wrapper {
            margin-top: 16px;
        }
        
        .cash-exact-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cash-exact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        
        /* Modal Rendu Monnaie */
        .modal-change {
            width: 380px;
            max-width: 95vw;
            text-align: center;
            padding: 40px 30px;
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
        }
        
        .change-success-icon {
            font-size: 64px;
            margin-bottom: 16px;
            animation: bounceIn 0.5s ease;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .change-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 24px;
        }
        
        .change-details {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .change-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 16px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }
        
        .change-row:last-child {
            border-bottom: none;
        }
        
        .change-row span:last-child {
            font-weight: 600;
            color: var(--text);
        }
        
        .change-row.change-amount {
            padding-top: 16px;
            margin-top: 6px;
            border-top: 2px solid var(--accent-cyan);
            border-bottom: none;
        }
        
        .change-row.change-amount span:first-child {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }
        
        .change-row.change-amount span:last-child {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent-cyan);
        }
        
        .change-countdown {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 10px;
        }
        
        /* Modal Terminal (Carte & Twint) */
        .modal-terminal {
            width: 380px;
            max-width: 95vw;
            text-align: center;
            padding: 40px 30px;
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
        }
        
        .terminal-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .terminal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 20px;
        }
        
        .terminal-amount {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
        }
        
        .modal-terminal.twint .terminal-amount {
            background: linear-gradient(135deg, var(--accent-cyan), #22d3ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .terminal-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 24px;
            background: var(--bg-primary);
            border-radius: 12px;
            margin-bottom: 16px;
            color: var(--text-muted);
            font-size: 14px;
        }
        
        .terminal-loader {
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .terminal-loader.twint {
            border-top-color: #000000;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .terminal-hint {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }
        
        .terminal-actions {
            display: flex;
            gap: 12px;
        }
        
        .terminal-btn {
            flex: 1;
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .terminal-btn.cancel {
            background: var(--bg-primary);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        
        .terminal-btn.cancel:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .terminal-btn.confirm {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .terminal-btn.confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .terminal-btn.confirm.twint {
            background: linear-gradient(135deg, #000000, #333333);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .terminal-btn.confirm.twint:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        /* Modal Success Animation */
        .modal-terminal.success .terminal-icon {
            animation: bounceIn 0.5s ease;
        }
        
        .modal-terminal.success .terminal-status {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }
        
        .modal-terminal.success .terminal-loader {
            display: none;
        }
        
        /* ============================================
           COLONNE CAT√âGORIES
        ============================================ */
        .categories-col {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 4px;
        }
        
        .category-btn {
            height: 70px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            font-weight: 600;
            font-size: 10px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .category-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 100%);
            border-radius: 14px 14px 0 0;
        }
        
        .category-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.25);
        }
        
        .category-btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        .category-btn.active {
            box-shadow: 0 0 0 3px rgba(255,255,255,0.9), 0 8px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
            transform: scale(1.02);
        }
        
        .category-btn .cat-icon {
            font-size: 24px;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
            z-index: 1;
        }
        
        .category-btn .cat-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.3px;
            z-index: 1;
            text-transform: uppercase;
        }
        
        /* Couleurs des cat√©gories - Plus riches et profondes */
        .cat-all { 
            background: linear-gradient(145deg, #64748b 0%, #475569 50%, #334155 100%);
        }
        .cat-favoris { 
            background: linear-gradient(145deg, #fcd34d 0%, #fbbf24 50%, #f59e0b 100%);
        }
        .cat-poissons { 
            background: linear-gradient(145deg, #38bdf8 0%, #0ea5e9 50%, #0284c7 100%);
        }
        .cat-crustaces { 
            background: linear-gradient(145deg, #f87171 0%, #ef4444 50%, #dc2626 100%);
        }
        .cat-coquillages { 
            background: linear-gradient(145deg, #14b8a6 0%, #0d9488 50%, #0f766e 100%);
        }
        .cat-fumes { 
            background: linear-gradient(145deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
        }
        .cat-traiteur { 
            background: linear-gradient(145deg, #34d399 0%, #10b981 50%, #059669 100%);
        }
        .cat-epicerie { 
            background: linear-gradient(145deg, #a78bfa 0%, #8b5cf6 50%, #7c3aed 100%);
        }
        
        /* ============================================
           COLONNE TICKET
        ============================================ */
        .ticket-col {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .ticket-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(20, 184, 166, 0.05));
        }
        
        .ticket-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ticket-count {
            background: var(--gradient);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .ticket-items {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .ticket-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .ticket-item-info { flex: 1; min-width: 0; }
        
        .ticket-item-name {
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .ticket-item-details {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .ticket-item-price {
            font-weight: 600;
            color: var(--success);
            white-space: nowrap;
        }
        
        .qty-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .qty-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            background: var(--bg-dark);
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .qty-btn:hover { background: var(--primary); }
        
        .qty-value {
            min-width: 28px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }
        
        .remove-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 16px;
        }
        
        .remove-btn:hover { background: rgba(239, 68, 68, 0.2); }
        
        /* TICKET TOTAUX */
        .ticket-totals {
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
        }
        
        .total-row.subtotal { color: var(--text-muted); }
        .total-row.discount { color: var(--error); }
        .total-row.redevance { color: var(--warning); }
        
        .total-row.grand-total {
            font-size: 22px;
            font-weight: 700;
            padding: 12px 0;
            border-top: 2px solid var(--border);
            margin-top: 10px;
        }
        
        .total-row.grand-total span:last-child {
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .discount-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }
        
        .discount-input label {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .discount-input input {
            width: 70px;
            padding: 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            text-align: center;
            font-family: inherit;
        }
        
        /* BOUTONS PAIEMENT */
        .payment-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 12px;
            border-top: 1px solid var(--border);
        }
        
        .pay-btn {
            padding: 14px 8px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            font-family: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        
        .pay-btn:hover { transform: translateY(-2px); }
        
        .pay-btn.cash { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .pay-btn.card { background: linear-gradient(135deg, var(--primary), #0284c7); color: white; }
        .pay-btn.twint { background: #000; color: white; }
        
        .pay-btn span:first-child { font-size: 22px; }
        
        .clear-btn {
            grid-column: 1 / -1;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            font-weight: 500;
            font-family: inherit;
        }
        
        .clear-btn:hover { background: var(--error); border-color: var(--error); }
        
        /* EMPTY STATE */
        .empty-ticket {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            padding: 40px;
            text-align: center;
        }
        
        .empty-ticket-icon {
            font-size: 50px;
            margin-bottom: 12px;
            opacity: 0.3;
        }
        
        /* ============================================
           MODALES
        ============================================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(20, 184, 166, 0.1));
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-body { padding: 20px; }
        
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            background: var(--bg-dark);
        }
        
        .modal-footer button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .modal-footer .cancel { background: var(--bg-input); color: var(--text); }
        .modal-footer .confirm { background: var(--gradient); color: white; }
        
        /* PES√âE */
        .weight-display {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .weight-value {
            font-size: 44px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .weight-unit { font-size: 18px; color: var(--text-muted); }
        
        .weight-info {
            text-align: center;
            margin-bottom: 16px;
            color: var(--text-muted);
            font-size: 14px;
        }
        
        .weight-info strong { color: var(--text); }
        .weight-info .total { color: var(--success); font-size: 18px; }
        
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .numpad-btn {
            padding: 18px;
            font-size: 22px;
            font-weight: 600;
            background: var(--bg-input);
            border: none;
            border-radius: 10px;
            color: var(--text);
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }
        
        .numpad-btn:hover { background: var(--border); }
        .numpad-btn.clear { background: var(--error); color: white; }
        
        /* FORMULAIRE MANIFESTATION */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .redevance-preview {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 14px;
            margin-top: 16px;
        }
        
        .redevance-preview h4 {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        
        .redevance-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
        }
        
        .redevance-item.highlight {
            font-size: 16px;
            font-weight: 700;
            color: var(--success);
            padding-top: 10px;
            border-top: 1px solid var(--border);
            margin-top: 6px;
        }
        
        /* RAPPORT */
        .modal-large {
            max-width: 600px;
        }
        
        .report-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .report-stat {
            background: var(--bg-dark);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        
        .report-stat-value {
            font-size: 26px;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .report-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .report-breakdown {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 16px;
        }
        
        .report-breakdown h4 {
            font-size: 14px;
            margin-bottom: 12px;
            color: var(--text-muted);
        }
        
        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }
        
        .breakdown-row:last-child { border-bottom: none; }
        
        .breakdown-row.total {
            font-size: 18px;
            font-weight: 700;
            color: var(--success);
            padding-top: 12px;
            margin-top: 8px;
            border-top: 2px solid var(--border);
            border-bottom: none;
        }
        
        /* Modal Rapport am√©lior√© */
        .modal-report {
            max-width: 700px;
            max-height: 85vh;
        }
        
        .modal-report .modal-body {
            max-height: 65vh;
            overflow-y: auto;
        }
        
        .report-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--bg-dark);
            padding: 6px;
            border-radius: 12px;
        }
        
        .report-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .report-tab:hover {
            color: var(--text);
            background: rgba(255,255,255,0.05);
        }
        
        .report-tab.active {
            background: var(--gradient);
            color: white;
        }
        
        .report-tab-content {
            display: none;
        }
        
        .report-tab-content.active {
            display: block;
        }
        
        /* Liste des tickets */
        .tickets-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .ticket-card {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .ticket-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.2);
        }
        
        .ticket-card.cancelled {
            opacity: 0.5;
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
        }
        
        .ticket-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .ticket-number {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
        }
        
        .ticket-number span {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
            margin-left: 8px;
        }
        
        .ticket-datetime {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .ticket-items {
            margin-bottom: 12px;
        }
        
        .ticket-item-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
            color: var(--text);
        }
        
        .ticket-item-name {
            flex: 1;
        }
        
        .ticket-item-qty {
            color: var(--text-muted);
            margin: 0 12px;
        }
        
        .ticket-item-total {
            font-weight: 600;
            min-width: 80px;
            text-align: right;
        }
        
        .ticket-footer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }
        
        .ticket-payment-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .ticket-payment-badge.cash {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }
        
        .ticket-payment-badge.card {
            background: rgba(14, 165, 233, 0.15);
            color: #0ea5e9;
        }
        
        .ticket-payment-badge.twint {
            background: rgba(0, 0, 0, 0.15);
            color: var(--text);
        }
        
        .ticket-total {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-cyan);
        }
        
        .ticket-discount {
            font-size: 12px;
            color: var(--warning);
            margin-right: 10px;
        }
        
        .ticket-cancelled-badge {
            background: var(--danger);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .tickets-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        
        .tickets-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        /* Recherche tickets */
        .tickets-search-wrapper {
            margin-bottom: 16px;
        }
        
        .tickets-search-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }
        
        .tickets-search-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        /* Modal Ticket D√©tail - Style Supermarch√© */
        .modal-receipt {
            max-width: 400px;
            padding: 0;
            background: transparent;
            box-shadow: none;
        }
        
        .receipt-paper {
            background: #fafafa;
            color: #1a1a1a;
            padding: 30px 25px;
            font-family: 'Courier New', monospace;
            border-radius: 4px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative;
        }
        
        .receipt-paper::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(135deg, transparent 33.33%, #fafafa 33.33%, #fafafa 66.66%, transparent 66.66%),
                        linear-gradient(-135deg, transparent 33.33%, #fafafa 33.33%, #fafafa 66.66%, transparent 66.66%);
            background-size: 14px 20px;
        }
        
        .receipt-paper::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(45deg, transparent 33.33%, #fafafa 33.33%, #fafafa 66.66%, transparent 66.66%),
                        linear-gradient(-45deg, transparent 33.33%, #fafafa 33.33%, #fafafa 66.66%, transparent 66.66%);
            background-size: 14px 20px;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .receipt-logo {
            font-size: 36px;
            margin-bottom: 8px;
        }
        
        .receipt-company {
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 2px;
        }
        
        .receipt-subtitle {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        .receipt-event {
            font-size: 12px;
            margin-top: 10px;
            padding: 5px 10px;
            background: #eee;
            display: inline-block;
            border-radius: 3px;
        }
        
        .receipt-divider {
            text-align: center;
            color: #ccc;
            font-size: 10px;
            letter-spacing: -1px;
            margin: 12px 0;
        }
        
        .receipt-info {
            margin: 10px 0;
        }
        
        .receipt-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 3px 0;
        }
        
        .receipt-items {
            margin: 10px 0;
        }
        
        .receipt-item {
            margin-bottom: 8px;
        }
        
        .receipt-item-name {
            font-size: 13px;
            font-weight: 600;
        }
        
        .receipt-item-detail {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #555;
            padding-left: 10px;
        }
        
        .receipt-totals {
            margin: 15px 0;
        }
        
        .receipt-total-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 4px 0;
        }
        
        .receipt-total-row.small {
            font-size: 11px;
            color: #666;
        }
        
        .receipt-total-row.discount {
            color: #e53e3e;
        }
        
        .receipt-total-row.grand-total {
            font-size: 18px;
            font-weight: bold;
            padding-top: 10px;
            margin-top: 5px;
            border-top: 2px dashed #333;
        }
        
        .receipt-payment {
            text-align: center;
            font-size: 13px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .receipt-payment span:first-child {
            font-size: 20px;
            margin-right: 5px;
        }
        
        .receipt-footer {
            text-align: center;
            margin-top: 15px;
        }
        
        .receipt-footer p {
            font-size: 12px;
            margin: 5px 0;
        }
        
        .receipt-footer .receipt-small {
            font-size: 10px;
            color: #888;
        }
        
        .receipt-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding: 0 10px;
        }
        
        .receipt-btn {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-card);
            color: var(--text);
        }
        
        .receipt-btn:hover {
            transform: translateY(-2px);
        }
        
        .receipt-btn.print {
            background: var(--accent-cyan);
            color: white;
        }
        
        .receipt-btn.email {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 14px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 20000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .notification.show { transform: translateX(0); }
        .notification.success { background: var(--success); }
        .notification.error { background: var(--error); }
        .notification.warning { background: var(--warning); }
        
        /* MODAL ARTICLES */
        .modal-articles {
            max-width: 700px;
            max-height: 90vh;
        }
        
        .articles-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .articles-tab {
            flex: 1;
            padding: 10px;
            background: var(--bg-input);
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .articles-tab.active {
            background: var(--gradient);
            color: white;
        }
        
        .articles-list {
            max-height: 350px;
            overflow-y: auto;
            margin-bottom: 16px;
        }
        
        .article-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .article-list-item:hover {
            background: var(--bg-input);
        }
        
        .article-list-fav {
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .article-list-fav:hover {
            transform: scale(1.2);
        }
        
        .article-list-thumb {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            flex-shrink: 0;
            border: 2px solid var(--border);
        }
        
        .article-list-info {
            flex: 1;
        }
        
        .article-list-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .article-list-details {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .article-list-price {
            font-weight: 700;
            color: var(--success);
            font-size: 14px;
        }
        
        .article-list-actions {
            display: flex;
            gap: 6px;
        }
        
        .article-list-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .article-list-btn:hover {
            background: var(--primary);
        }
        
        .article-list-btn.delete:hover {
            background: var(--error);
        }
        
        /* FORM ARTICLE */
        .article-form {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 2px solid var(--primary);
        }
        
        .article-form-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary);
        }
        
        .article-form-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .article-form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .article-form input,
        .article-form select {
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-family: inherit;
        }
        
        .article-form input:focus,
        .article-form select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .article-form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .article-form-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .article-form-btn.cancel {
            background: var(--bg-input);
            color: var(--text);
        }
        
        .article-form-btn.save {
            background: var(--gradient);
            color: white;
        }
        
        .empty-articles {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .empty-articles-icon {
            font-size: 40px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="main-header">
        <div class="header-left">
            <a href="index.html" class="logo">
                <span class="logo-icon">üêü</span>
                <span class="logo-text">TRAKIO</span>
                <span class="nav-version">v5.1.0</span>
            </a>
        </div>
        
        <div class="header-center">
            <div class="event-config" onclick="openEventModal()">
                <span>üìç</span>
                <div>
                    <div class="event-name" id="displayEventName">Magasin</div>
                    <div class="event-date" id="displayEventDate">-</div>
                </div>
                <span class="event-badge" id="displayRedevance">0%</span>
            </div>
        </div>
        
        <div class="header-right">
            <div class="status-badge">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Hors ligne</span>
            </div>
            <button class="header-btn" onclick="openArticlesModal()">‚öôÔ∏è Articles</button>
            <button class="header-btn" onclick="openReportModal()">üìä Rapport</button>
            <button class="header-btn" onclick="syncData()">üîÑ Sync</button>
        </div>
    </header>
    
    <!-- CONTAINER 3 COLONNES -->
    <div class="pos-container">
        <!-- COLONNE ARTICLES -->
        <div class="articles-col">
            <div class="col-header">
                <span class="col-title">
                    üêü Articles
                    <span class="col-badge" id="articles-count">(0)</span>
                </span>
            </div>
            <div class="search-wrapper">
                <input type="text" class="search-input" placeholder="Rechercher..." id="searchArticle" oninput="filterArticles()">
            </div>
            <div class="articles-grid" id="articles-grid">
                <!-- Articles dynamiques -->
            </div>
            <div class="articles-pagination" id="articlesPagination">
                <button class="pagination-btn" onclick="prevPage()" id="prevPageBtn" disabled>‚óÄ</button>
                <span class="pagination-info" id="paginationInfo">1 / 1</span>
                <button class="pagination-btn" onclick="nextPage()" id="nextPageBtn" disabled>‚ñ∂</button>
            </div>
        </div>
        
        <!-- COLONNE CAT√âGORIES -->
        <div class="categories-col">
            <button class="category-btn cat-favoris" onclick="selectCategory('favoris')" data-cat="favoris">
                <span class="cat-icon">‚≠ê</span>
                <span class="cat-label">Favoris</span>
            </button>
            <button class="category-btn cat-all active" onclick="selectCategory('')" data-cat="">
                <span class="cat-icon">üóÇÔ∏è</span>
                <span class="cat-label">Tous</span>
            </button>
            <button class="category-btn cat-poissons" onclick="selectCategory('poissons')" data-cat="poissons">
                <span class="cat-icon">üêü</span>
                <span class="cat-label">Poissons</span>
            </button>
            <button class="category-btn cat-crustaces" onclick="selectCategory('crustaces')" data-cat="crustaces">
                <span class="cat-icon">ü¶û</span>
                <span class="cat-label">Crustac√©s</span>
            </button>
            <button class="category-btn cat-coquillages" onclick="selectCategory('coquillages')" data-cat="coquillages">
                <span class="cat-icon">ü¶™</span>
                <span class="cat-label">Coquillages</span>
            </button>
            <button class="category-btn cat-fumes" onclick="selectCategory('fumes')" data-cat="fumes">
                <span class="cat-icon">üç£</span>
                <span class="cat-label">Fum√©s</span>
            </button>
            <button class="category-btn cat-traiteur" onclick="selectCategory('traiteur')" data-cat="traiteur">
                <span class="cat-icon">üç¥</span>
                <span class="cat-label">Traiteur</span>
            </button>
            <button class="category-btn cat-epicerie" onclick="selectCategory('epicerie')" data-cat="epicerie">
                <span class="cat-icon">üß∫</span>
                <span class="cat-label">√âpicerie</span>
            </button>
        </div>
        
        <!-- COLONNE TICKET -->
        <div class="ticket-col">
            <div class="ticket-header">
                <div class="ticket-title-row">
                    <span class="col-title">üßæ Ticket</span>
                    <span class="ticket-count" id="ticket-count">0 article</span>
                </div>
            </div>
            
            <div class="ticket-items" id="ticket-items">
                <div class="empty-ticket">
                    <div class="empty-ticket-icon">üõí</div>
                    <p>Ticket vide</p>
                    <p style="font-size: 12px; margin-top: 5px;">Cliquez sur un article pour l'ajouter</p>
                </div>
            </div>
            
            <div class="ticket-totals">
                <div class="total-row subtotal">
                    <span>Sous-total HT</span>
                    <span id="subtotal-ht">0.00 CHF</span>
                </div>
                <div class="total-row subtotal">
                    <span>TVA (2.6%)</span>
                    <span id="total-tva">0.00 CHF</span>
                </div>
                <div class="discount-input">
                    <label>Remise</label>
                    <input type="number" id="globalDiscount" min="0" value="0" onchange="updateTotals()">
                    <span>CHF</span>
                </div>
                <div class="total-row discount" id="discount-row" style="display: none;">
                    <span>Remise</span>
                    <span id="total-discount">-0.00 CHF</span>
                </div>
                <div class="total-row grand-total">
                    <span>TOTAL</span>
                    <span id="grand-total">0.00 CHF</span>
                </div>
            </div>
            
            <div class="payment-buttons">
                <button class="pay-btn cash" onclick="openCashModal()">
                    <span>üíµ</span>
                    <span>Esp√®ces</span>
                </button>
                <button class="pay-btn card" onclick="openCardModal()">
                    <span>üí≥</span>
                    <span>Carte</span>
                </button>
                <button class="pay-btn twint" onclick="openTwintModal()">
                    <span>üì±</span>
                    <span>Twint</span>
                </button>
                <button class="clear-btn" onclick="clearTicket()">üóëÔ∏è Vider le ticket</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PES√âE -->
    <div class="modal-overlay" id="weightModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    ‚öñÔ∏è <span id="weight-article-name">Article</span>
                </div>
            </div>
            <div class="modal-body">
                <div class="weight-display">
                    <span class="weight-value" id="weight-value">0.000</span>
                    <span class="weight-unit">kg</span>
                </div>
                <div class="weight-info">
                    Prix: <strong id="weight-price">0.00 CHF/kg</strong> = 
                    <strong class="total" id="weight-total">0.00 CHF</strong>
                </div>
                <div class="numpad">
                    <button class="numpad-btn" onclick="numpadInput('1')">1</button>
                    <button class="numpad-btn" onclick="numpadInput('2')">2</button>
                    <button class="numpad-btn" onclick="numpadInput('3')">3</button>
                    <button class="numpad-btn" onclick="numpadInput('4')">4</button>
                    <button class="numpad-btn" onclick="numpadInput('5')">5</button>
                    <button class="numpad-btn" onclick="numpadInput('6')">6</button>
                    <button class="numpad-btn" onclick="numpadInput('7')">7</button>
                    <button class="numpad-btn" onclick="numpadInput('8')">8</button>
                    <button class="numpad-btn" onclick="numpadInput('9')">9</button>
                    <button class="numpad-btn clear" onclick="numpadInput('C')">C</button>
                    <button class="numpad-btn" onclick="numpadInput('0')">0</button>
                    <button class="numpad-btn" onclick="numpadInput('.')">.</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" onclick="closeWeightModal()">Annuler</button>
                <button class="confirm" onclick="confirmWeight()">‚úì Ajouter</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PAIEMENT ESP√àCES -->
    <div class="modal-overlay" id="cashModal">
        <div class="modal modal-cash">
            <div class="modal-header">
                <div class="modal-title">üíµ Paiement Esp√®ces</div>
            </div>
            <div class="modal-body">
                <div class="cash-total-display">
                    <div class="cash-total-label">Total √† payer</div>
                    <div class="cash-total-amount" id="cashTotalAmount">0.00 CHF</div>
                </div>
                
                <div class="cash-given-section">
                    <div class="cash-given-label">Montant re√ßu</div>
                    <div class="cash-bills">
                        <button class="cash-bill-btn" onclick="selectCashAmount(10)">10</button>
                        <button class="cash-bill-btn" onclick="selectCashAmount(20)">20</button>
                        <button class="cash-bill-btn" onclick="selectCashAmount(50)">50</button>
                        <button class="cash-bill-btn" onclick="selectCashAmount(100)">100</button>
                        <button class="cash-bill-btn" onclick="selectCashAmount(200)">200</button>
                    </div>
                    <div class="cash-custom">
                        <input type="number" id="cashCustomAmount" placeholder="Autre montant..." step="0.05" min="0">
                        <button class="cash-custom-btn" onclick="selectCustomCashAmount()">OK</button>
                    </div>
                </div>
                
                <div class="cash-exact-btn-wrapper">
                    <button class="cash-exact-btn" onclick="selectExactAmount()">üí∞ Montant exact</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" onclick="closeCashModal()">Annuler</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL RENDU MONNAIE -->
    <div class="modal-overlay" id="changeModal" onclick="closeChangeModalNow()">
        <div class="modal modal-change" onclick="event.stopPropagation()">
            <div class="change-success-icon">‚úÖ</div>
            <div class="change-title">Paiement accept√©</div>
            <div class="change-details">
                <div class="change-row">
                    <span>Total</span>
                    <span id="changeTotal">0.00 CHF</span>
                </div>
                <div class="change-row">
                    <span>Re√ßu</span>
                    <span id="changeReceived">0.00 CHF</span>
                </div>
                <div class="change-row change-amount">
                    <span>√Ä rendre</span>
                    <span id="changeAmount">0.00 CHF</span>
                </div>
            </div>
            <div class="change-countdown" id="changeCountdown">Fermeture dans 5s... <span style="opacity: 0.6;">(cliquer pour fermer)</span></div>
        </div>
    </div>
    
    <!-- MODAL PAIEMENT CARTE -->
    <div class="modal-overlay" id="cardModal">
        <div class="modal modal-terminal">
            <div class="terminal-icon">üí≥</div>
            <div class="terminal-title">Paiement par Carte</div>
            <div class="terminal-amount" id="cardTotalAmount">0.00 CHF</div>
            <div class="terminal-status">
                <div class="terminal-loader"></div>
                <span>En attente du terminal...</span>
            </div>
            <div class="terminal-hint">Pr√©sentez la carte au terminal de paiement</div>
            <div class="terminal-actions">
                <button class="terminal-btn cancel" onclick="closeCardModal()">‚úï Annuler</button>
                <button class="terminal-btn confirm" onclick="confirmCardPayment()">‚úì Paiement accept√©</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PAIEMENT TWINT -->
    <div class="modal-overlay" id="twintModal">
        <div class="modal modal-terminal twint">
            <div class="terminal-icon">üì±</div>
            <div class="terminal-title">Paiement Twint</div>
            <div class="terminal-amount" id="twintTotalAmount">0.00 CHF</div>
            <div class="terminal-status">
                <div class="terminal-loader twint"></div>
                <span>En attente de confirmation...</span>
            </div>
            <div class="terminal-hint">Le client scanne le QR code ou valide sur son app</div>
            <div class="terminal-actions">
                <button class="terminal-btn cancel" onclick="closeTwintModal()">‚úï Annuler</button>
                <button class="terminal-btn confirm twint" onclick="confirmTwintPayment()">‚úì Paiement accept√©</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL √âV√âNEMENT/MANIFESTATION -->
    <div class="modal-overlay" id="eventModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üìç Configuration Manifestation</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nom de la manifestation *</label>
                    <input type="text" id="eventName" placeholder="Ex: March√© de No√´l Nyon">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="eventDate">
                    </div>
                    <div class="form-group">
                        <label>Redevance (%)</label>
                        <input type="number" id="eventRedevance" min="0" max="100" value="0" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Lieu pr√©d√©fini</label>
                    <select id="eventPreset" onchange="applyPreset()">
                        <option value="">-- Personnalis√© --</option>
                        <option value="magasin|0">üè™ Magasin (0%)</option>
                        <option value="marche_nyon|10">üé™ March√© Nyon (10%)</option>
                        <option value="marche_morges|12">üé™ March√© Morges (12%)</option>
                        <option value="fete_nyon|15">üéâ F√™te de Nyon (15%)</option>
                        <option value="livraison|0">üöö Livraison (0%)</option>
                    </select>
                </div>
                
                <div class="redevance-preview" id="redevancePreview" style="display: none;">
                    <h4>üí∞ Simulation redevance</h4>
                    <div class="redevance-item">
                        <span>CA TTC actuel</span>
                        <span id="previewCaTTC">0.00 CHF</span>
                    </div>
                    <div class="redevance-item">
                        <span>CA HT (hors TVA 2.6%)</span>
                        <span id="previewCaHT">0.00 CHF</span>
                    </div>
                    <div class="redevance-item">
                        <span>Redevance (<span id="previewRedevancePercent">0</span>%)</span>
                        <span id="previewRedevanceAmount">-0.00 CHF</span>
                    </div>
                    <div class="redevance-item highlight">
                        <span>√Ä remettre</span>
                        <span id="previewToRemit">0.00 CHF</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" onclick="closeEventModal()">Annuler</button>
                <button class="confirm" onclick="saveEventConfig()">‚úì Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL RAPPORT -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal modal-report">
            <div class="modal-header">
                <div class="modal-title">üìä Rapport - <span id="reportEventName">Manifestation</span></div>
            </div>
            <div class="modal-body">
                <!-- Onglets -->
                <div class="report-tabs">
                    <button class="report-tab active" onclick="setReportTab('summary')" data-tab="summary">üìà R√©sum√©</button>
                    <button class="report-tab" onclick="setReportTab('tickets')" data-tab="tickets">üßæ Tickets (<span id="reportTicketCount">0</span>)</button>
                </div>
                
                <!-- TAB R√âSUM√â -->
                <div class="report-tab-content active" id="reportTabSummary">
                    <div class="report-stats">
                        <div class="report-stat">
                            <div class="report-stat-value" id="reportTxCount">0</div>
                            <div class="report-stat-label">Transactions</div>
                        </div>
                        <div class="report-stat">
                            <div class="report-stat-value" id="reportCaTTC">0 CHF</div>
                            <div class="report-stat-label">CA TTC</div>
                        </div>
                        <div class="report-stat">
                            <div class="report-stat-value" id="reportCaHT">0 CHF</div>
                            <div class="report-stat-label">CA HT</div>
                        </div>
                        <div class="report-stat">
                            <div class="report-stat-value" id="reportArticles">0</div>
                            <div class="report-stat-label">Articles vendus</div>
                        </div>
                    </div>
                    
                    <div class="report-breakdown">
                        <h4>üí≥ R√©partition paiements</h4>
                        <div class="breakdown-row">
                            <span>üíµ Esp√®ces</span>
                            <span id="reportCash">0.00 CHF</span>
                        </div>
                        <div class="breakdown-row">
                            <span>üí≥ Carte</span>
                            <span id="reportCard">0.00 CHF</span>
                        </div>
                        <div class="breakdown-row">
                            <span>üì± Twint</span>
                            <span id="reportTwint">0.00 CHF</span>
                        </div>
                    </div>
                    
                    <div class="report-breakdown" style="margin-top: 16px;" id="redevanceSection">
                        <h4>üí∞ Calcul Redevance</h4>
                        <div class="breakdown-row">
                            <span>CA HT</span>
                            <span id="reportHT">0.00 CHF</span>
                        </div>
                        <div class="breakdown-row">
                            <span>Redevance (<span id="reportRedevancePercent">0</span>%)</span>
                            <span id="reportRedevanceAmount" style="color: var(--error);">-0.00 CHF</span>
                        </div>
                        <div class="breakdown-row total">
                            <span>üíµ √Ä REMETTRE</span>
                            <span id="reportToRemit">0.00 CHF</span>
                        </div>
                    </div>
                </div>
                
                <!-- TAB TICKETS -->
                <div class="report-tab-content" id="reportTabTickets">
                    <div class="tickets-search-wrapper">
                        <input type="text" class="tickets-search-input" id="searchTickets" placeholder="üîç Rechercher par n¬∞, article, montant..." oninput="filterTicketsList()">
                    </div>
                    <div class="tickets-list" id="ticketsList">
                        <!-- Liste des tickets g√©n√©r√©e dynamiquement -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" onclick="closeReportModal()">Fermer</button>
                <button class="confirm" onclick="exportReport()">üìÑ Exporter</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL TICKET D√âTAIL (style supermarch√©) -->
    <div class="modal-overlay" id="ticketDetailModal" onclick="closeTicketDetail()">
        <div class="modal modal-receipt" onclick="event.stopPropagation()">
            <div class="receipt-paper" id="receiptContent">
                <div class="receipt-header">
                    <div class="receipt-logo">üêü</div>
                    <div class="receipt-company">BOREX POISSONS</div>
                    <div class="receipt-subtitle">Produits de la mer</div>
                    <div class="receipt-event" id="receiptEventName">Manifestation</div>
                </div>
                <div class="receipt-divider">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>
                <div class="receipt-info">
                    <div class="receipt-info-row">
                        <span>Ticket N¬∞</span>
                        <span id="receiptNumber">#0001</span>
                    </div>
                    <div class="receipt-info-row">
                        <span>Date</span>
                        <span id="receiptDate">10.12.2024</span>
                    </div>
                    <div class="receipt-info-row">
                        <span>Heure</span>
                        <span id="receiptTime">14:32</span>
                    </div>
                </div>
                <div class="receipt-divider">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>
                <div class="receipt-items" id="receiptItems">
                    <!-- Articles dynamiques -->
                </div>
                <div class="receipt-divider">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>
                <div class="receipt-totals">
                    <div class="receipt-total-row" id="receiptSubtotal">
                        <span>Sous-total</span>
                        <span>0.00</span>
                    </div>
                    <div class="receipt-total-row discount" id="receiptDiscountRow" style="display: none;">
                        <span>Remise</span>
                        <span id="receiptDiscount">-0.00</span>
                    </div>
                    <div class="receipt-total-row small">
                        <span>TVA 2.6%</span>
                        <span id="receiptTVA">0.00</span>
                    </div>
                    <div class="receipt-total-row grand-total">
                        <span>TOTAL CHF</span>
                        <span id="receiptTotal">0.00</span>
                    </div>
                </div>
                <div class="receipt-divider">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>
                <div class="receipt-payment">
                    <span id="receiptPaymentIcon">üíµ</span>
                    <span>Pay√© par </span>
                    <strong id="receiptPaymentMethod">Esp√®ces</strong>
                </div>
                <div class="receipt-footer">
                    <p>Merci de votre visite !</p>
                    <p class="receipt-small">www.borex-poissons.ch</p>
                </div>
            </div>
            <div class="receipt-actions">
                <button class="receipt-btn" onclick="closeTicketDetail()">‚úï Fermer</button>
                <button class="receipt-btn print" onclick="printReceipt()">üñ®Ô∏è Imprimer</button>
                <button class="receipt-btn email" onclick="emailReceipt()">üìß Email</button>
            </div>
        </div>
    </div>
    
    <!-- NOTIFICATION -->
    <div class="notification" id="notification"></div>
    
    <!-- MODAL GESTION ARTICLES -->
    <div class="modal-overlay" id="articlesModal">
        <div class="modal modal-articles">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Articles Caisse</div>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <div class="articles-tabs">
                    <button class="articles-tab active" onclick="setArticlesTab('list')" data-tab="list">
                        üìã Liste (<span id="articlesCount">0</span>)
                    </button>
                    <button class="articles-tab" onclick="setArticlesTab('favorites')" data-tab="favorites">
                        ‚≠ê Favoris (<span id="favoritesCount">0</span>)
                    </button>
                </div>
                
                <!-- Barre de recherche -->
                <div class="modal-search-wrapper">
                    <input type="text" class="modal-search-input" id="searchArticleModal" placeholder="üîç Rechercher un article..." oninput="filterArticlesList()">
                </div>
                
                <!-- Formulaire ajout/modif -->
                <div class="article-form" id="articleForm" style="display: none;">
                    <div class="article-form-title" id="articleFormTitle">‚ûï Nouvel article</div>
                    <input type="hidden" id="editArticleId">
                    <div class="article-form-grid">
                        <input type="text" id="articleName" placeholder="Nom de l'article *" required>
                        <input type="number" id="articlePrice" placeholder="Prix *" step="0.05" min="0" required>
                        <select id="articleUnit">
                            <option value="kg">kg</option>
                            <option value="pce">pi√®ce</option>
                            <option value="100g">100g</option>
                            <option value="lot">lot</option>
                        </select>
                    </div>
                    <div class="article-form-grid-2">
                        <select id="articleCategory">
                            <option value="poissons">üêü Poissons</option>
                            <option value="crustaces">ü¶ê Crustac√©s</option>
                            <option value="coquillages">ü¶™ Coquillages</option>
                            <option value="fumes">üî• Fum√©s</option>
                            <option value="traiteur">üçΩÔ∏è Traiteur</option>
                            <option value="epicerie">üõí √âpicerie</option>
                        </select>
                        <input type="text" id="articleOrigin" placeholder="Origine (optionnel)">
                    </div>
                    <!-- Upload Image -->
                    <div class="image-upload-container">
                        <div class="image-preview" id="imagePreview">üì∑</div>
                        <div class="image-upload-actions">
                            <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
                            <button type="button" class="image-upload-btn" onclick="document.getElementById('imageInput').click()">üì∑ Ajouter photo</button>
                            <button type="button" class="image-upload-btn remove" id="removeImageBtn" onclick="removeImage()" style="display:none;">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                    <input type="hidden" id="articleImage">
                    <div class="article-form-actions">
                        <button class="article-form-btn cancel" onclick="cancelArticleForm()">Annuler</button>
                        <button class="article-form-btn save" onclick="saveArticle()">üíæ Enregistrer</button>
                    </div>
                </div>
                
                <!-- Bouton ajouter -->
                <button class="header-btn primary" onclick="showArticleForm()" id="addArticleBtn" style="width: 100%; margin-bottom: 16px; justify-content: center;">
                    ‚ûï Ajouter un article
                </button>
                
                <!-- Liste articles -->
                <div class="articles-list" id="articlesList">
                    <div class="empty-articles">
                        <div class="empty-articles-icon">üì¶</div>
                        <p>Aucun article</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" onclick="closeArticlesModal()">Fermer</button>
                <button class="confirm" onclick="importFromModule()">üì• Importer du module Articles</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION & VARIABLES
        // ============================================
        
        const APP_VERSION = '5.1.0';
        const TVA_RATE = 2.6; // TVA alimentaire Suisse
        
        let articlesData = [];
        let filteredArticles = [];
        let currentCategory = '';
        let currentPage = 1;
        const ARTICLES_PER_PAGE = 18; // 6 colonnes x 3 lignes
        let currentArticlesTab = 'list';
        let cart = [];
        let transactions = [];
        let currentWeightArticle = null;
        let weightInput = '';
        let transactionCounter = 0;
        let editingArticleId = null;
        
        // Configuration manifestation
        let eventConfig = {
            name: 'Magasin',
            date: new Date().toISOString().slice(0, 10),
            redevance: 0
        };
        
        // Firebase (optionnel)
        let db = null;
        let firebaseAvailable = false;
        
        // ============================================
        // INITIALISATION
        // ============================================
        
        function init() {
            // Charger config depuis localStorage
            loadEventConfig();
            loadArticles();
            loadTransactions();
            updateEventDisplay();
            updateStatus();
            
            // Essayer d'initialiser Firebase
            initFirebase();
            
            // Date par d√©faut = aujourd'hui
            document.getElementById('eventDate').value = new Date().toISOString().slice(0, 10);
        }
        
        function initFirebase() {
            try {
                if (typeof firebase !== 'undefined' && firebase.apps) {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
                        authDomain: "trakio-pilot-6e97a.firebaseapp.com",
                        projectId: "trakio-pilot-6e97a",
                        storageBucket: "trakio-pilot-6e97a.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdef123456"
                    };
                    
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    db = firebase.firestore();
                    firebaseAvailable = true;
                    console.log('‚úÖ Firebase disponible');
                }
            } catch (e) {
                console.log('‚ö†Ô∏è Mode hors ligne uniquement');
            }
            updateStatus();
        }
        
        function updateStatus() {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (firebaseAvailable) {
                dot.className = 'status-dot online';
                text.textContent = 'En ligne';
            } else {
                dot.className = 'status-dot offline';
                text.textContent = 'Hors ligne';
            }
        }
        
        // ============================================
        // ARTICLES CAISSE (localStorage s√©par√©)
        // ============================================
        
        function loadArticles() {
            // Charger depuis localStorage sp√©cifique caisse
            const stored = localStorage.getItem('trakio_caisse_articles');
            if (stored) {
                try {
                    articlesData = JSON.parse(stored).filter(a => a.active !== false);
                } catch (e) {
                    articlesData = getDefaultArticles();
                    saveArticlesToStorage();
                }
            } else {
                articlesData = getDefaultArticles();
                saveArticlesToStorage();
            }
            filterArticles();
        }
        
        function saveArticlesToStorage() {
            localStorage.setItem('trakio_caisse_articles', JSON.stringify(articlesData));
        }
        
        // ============================================
        // FIREBASE SYNC - Articles & Transactions
        // ============================================
        
        function getDateFolder() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }
        
        async function saveArticlesToFirebase() {
            if (!firebaseAvailable || !db) return;
            
            try {
                const batch = db.batch();
                const collectionRef = db.collection('caisse').doc('articles').collection('items');
                
                // Sauvegarder chaque article
                for (const article of articlesData) {
                    const docRef = collectionRef.doc(article.id);
                    batch.set(docRef, {
                        ...article,
                        syncedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                await batch.commit();
                console.log('‚úÖ Articles synchronis√©s avec Firebase');
            } catch (e) {
                console.error('‚ùå Erreur sync articles Firebase:', e);
            }
        }
        
        async function saveTransactionToFirebase(transaction) {
            if (!firebaseAvailable || !db) return;
            
            try {
                const dateFolder = getDateFolder();
                const eventName = eventConfig.name || 'default';
                
                // Structure: caisse/{eventName}/{date}/transactions/{transactionId}
                await db.collection('caisse')
                    .doc(eventName.replace(/[^a-zA-Z0-9]/g, '_'))
                    .collection(dateFolder)
                    .doc(transaction.id)
                    .set({
                        ...transaction,
                        syncedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                console.log('‚úÖ Transaction sauvegard√©e:', transaction.id);
            } catch (e) {
                console.error('‚ùå Erreur save transaction:', e);
            }
        }
        
        async function saveDailyReport(report) {
            if (!firebaseAvailable || !db) return;
            
            try {
                const dateFolder = getDateFolder();
                const eventName = eventConfig.name || 'default';
                
                // Structure: caisse/{eventName}/{date}/report
                await db.collection('caisse')
                    .doc(eventName.replace(/[^a-zA-Z0-9]/g, '_'))
                    .collection(dateFolder)
                    .doc('_report')
                    .set({
                        ...report,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                console.log('‚úÖ Rapport journalier sauvegard√©');
            } catch (e) {
                console.error('‚ùå Erreur save rapport:', e);
            }
        }
        
        async function loadArticlesFromFirebase() {
            if (!firebaseAvailable || !db) return false;
            
            try {
                const snapshot = await db.collection('caisse').doc('articles').collection('items').get();
                
                if (!snapshot.empty) {
                    const firebaseArticles = [];
                    snapshot.forEach(doc => {
                        firebaseArticles.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Merge avec localStorage (Firebase prioritaire)
                    if (firebaseArticles.length > 0) {
                        articlesData = firebaseArticles.filter(a => a.active !== false);
                        saveArticlesToStorage();
                        console.log('‚úÖ Articles charg√©s depuis Firebase:', articlesData.length);
                        return true;
                    }
                }
            } catch (e) {
                console.error('‚ùå Erreur chargement Firebase:', e);
            }
            return false;
        }
        
        async function syncAllData() {
            showNotification('Synchronisation...', 'info');
            
            try {
                // 1. Charger articles depuis Firebase
                await loadArticlesFromFirebase();
                
                // 2. Sauvegarder articles locaux vers Firebase
                await saveArticlesToFirebase();
                
                // 3. Sauvegarder transactions du jour
                for (const tx of transactions) {
                    await saveTransactionToFirebase(tx);
                }
                
                // 4. Sauvegarder rapport journalier
                const report = generateDailyReportData();
                await saveDailyReport(report);
                
                filterArticles();
                showNotification('Synchronisation termin√©e', 'success');
            } catch (e) {
                showNotification('Erreur de synchronisation', 'error');
                console.error(e);
            }
        }
        
        function generateDailyReportData() {
            const today = new Date().toISOString().slice(0, 10);
            const todayTx = transactions.filter(t => t.date?.startsWith(today));
            
            return {
                date: today,
                event: eventConfig.name || 'default',
                redevance: eventConfig.redevance || 0,
                totalTransactions: todayTx.length,
                totalHT: todayTx.reduce((sum, t) => sum + (t.totalHT || 0), 0),
                totalTVA: todayTx.reduce((sum, t) => sum + (t.totalTVA || 0), 0),
                totalTTC: todayTx.reduce((sum, t) => sum + (t.totalTTC || 0), 0),
                totalRedevance: todayTx.reduce((sum, t) => sum + (t.redevance || 0), 0),
                payments: {
                    cash: todayTx.filter(t => t.paymentMethod === 'cash').reduce((sum, t) => sum + (t.totalTTC || 0), 0),
                    card: todayTx.filter(t => t.paymentMethod === 'card').reduce((sum, t) => sum + (t.totalTTC || 0), 0),
                    twint: todayTx.filter(t => t.paymentMethod === 'twint').reduce((sum, t) => sum + (t.totalTTC || 0), 0)
                }
            };
        }
        
        function getDefaultArticles() {
            // Articles de d√©mo pour fonctionner imm√©diatement
            return [
                { id: '1', name: 'Saumon frais', category: 'poissons', price: 45.00, unit: 'kg', tva: 2.6, origin: 'Norv√®ge', active: true, favorite: true },
                { id: '2', name: 'Filet de perche', category: 'poissons', price: 58.00, unit: 'kg', tva: 2.6, origin: 'Lac L√©man', active: true, favorite: true },
                { id: '3', name: 'Truite enti√®re', category: 'poissons', price: 28.00, unit: 'kg', tva: 2.6, origin: 'Suisse', active: true, favorite: false },
                { id: '4', name: 'Crevettes roses', category: 'crustaces', price: 32.00, unit: 'kg', tva: 2.6, origin: 'Madagascar', active: true, favorite: true },
                { id: '5', name: 'Hu√Ætres (dz)', category: 'coquillages', price: 24.00, unit: 'pce', tva: 2.6, origin: 'France', active: true, favorite: false },
                { id: '6', name: 'Moules', category: 'coquillages', price: 8.50, unit: 'kg', tva: 2.6, origin: 'Hollande', active: true, favorite: false },
                { id: '7', name: 'Saumon fum√©', category: 'fumes', price: 65.00, unit: 'kg', tva: 2.6, origin: '√âcosse', active: true, favorite: true },
                { id: '8', name: 'Tarama maison', category: 'traiteur', price: 4.50, unit: 'pce', tva: 2.6, active: true, favorite: false },
                { id: '9', name: 'Salade de la mer', category: 'traiteur', price: 28.00, unit: 'kg', tva: 2.6, active: true, favorite: false },
                { id: '10', name: 'Citrons (filet)', category: 'epicerie', price: 3.50, unit: 'pce', tva: 2.6, active: true, favorite: false }
            ];
        }
        
        function filterArticles() {
            const search = document.getElementById('searchArticle').value.toLowerCase();
            
            filteredArticles = articlesData.filter(article => {
                // Filtre favoris
                if (currentCategory === 'favoris') {
                    if (!article.favorite) return false;
                } else if (currentCategory) {
                    // Filtre cat√©gorie normale
                    if (article.category !== currentCategory) return false;
                }
                
                // Filtre recherche
                const matchSearch = !search || 
                    article.name?.toLowerCase().includes(search) ||
                    article.origin?.toLowerCase().includes(search);
                
                return matchSearch;
            });
            
            currentPage = 1; // Reset page on filter
            renderArticles();
        }
        
        function selectCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.cat === cat);
            });
            filterArticles();
        }
        
        function renderArticles() {
            const grid = document.getElementById('articles-grid');
            document.getElementById('articles-count').textContent = `(${filteredArticles.length})`;
            
            const categoryColors = {
                poissons: '#06b6d4',
                crustaces: '#ef4444',
                coquillages: '#14b8a6',
                fumes: '#f59e0b',
                traiteur: '#10b981',
                epicerie: '#8b5cf6'
            };
            
            // Calcul pagination
            const totalPages = Math.ceil(filteredArticles.length / ARTICLES_PER_PAGE) || 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            const startIndex = (currentPage - 1) * ARTICLES_PER_PAGE;
            const endIndex = startIndex + ARTICLES_PER_PAGE;
            const pageArticles = filteredArticles.slice(startIndex, endIndex);
            
            // Mise √† jour pagination UI
            document.getElementById('paginationInfo').textContent = `${currentPage} / ${totalPages}`;
            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
            
            if (filteredArticles.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 40px; margin-bottom: 10px; opacity: 0.5;">
                            ${currentCategory === 'favoris' ? '‚≠ê' : 'üì¶'}
                        </div>
                        <p>${currentCategory === 'favoris' ? 'Aucun favori d√©fini' : 'Aucun article trouv√©'}</p>
                        <p style="font-size: 12px; margin-top: 5px;">
                            ${currentCategory === 'favoris' ? 'Cliquez sur ‚öôÔ∏è Articles pour configurer' : ''}
                        </p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = pageArticles.map(article => {
                const color = categoryColors[article.category] || '#64748b';
                const hasImage = article.image && article.image.length > 0;
                
                if (hasImage) {
                    return `
                    <button class="article-btn has-image" onclick="addToCart('${article.id}')">
                        <div class="article-color-bar" style="background: ${color};"></div>
                        ${article.favorite ? '<span class="article-favorite">‚≠ê</span>' : ''}
                        <div class="article-header">
                            <div class="article-name">${article.name}</div>
                        </div>
                        <div class="article-image" style="background-image: url('${article.image}');"></div>
                        <div class="article-content">
                            <div class="article-price-section">
                                <span class="article-price">${formatCHF(article.price)}</span>
                                <span class="article-unit">/${article.unit || 'kg'}</span>
                            </div>
                        </div>
                    </button>
                `} else {
                    return `
                    <button class="article-btn" onclick="addToCart('${article.id}')">
                        <div class="article-color-bar" style="background: ${color};"></div>
                        ${article.favorite ? '<span class="article-favorite">‚≠ê</span>' : ''}
                        <div class="article-content">
                            <div>
                                <div class="article-name">${article.name}</div>
                                ${article.origin ? `<div class="article-origin">${article.origin}</div>` : ''}
                            </div>
                            <div class="article-price-section">
                                <div class="article-price">${formatCHF(article.price)}</div>
                                <div class="article-unit">/${article.unit || 'kg'}</div>
                            </div>
                        </div>
                    </button>
                `}
            }).join('');
        }
        
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderArticles();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(filteredArticles.length / ARTICLES_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderArticles();
            }
        }
        
        // ============================================
        // PANIER
        // ============================================
        
        function addToCart(articleId) {
            const article = articlesData.find(a => a.id === articleId);
            if (!article) return;
            
            if (article.unit === 'kg') {
                openWeightModal(article);
                return;
            }
            
            const existing = cart.find(item => item.articleId === articleId && !item.weight);
            
            if (existing) {
                existing.qty++;
            } else {
                cart.push({
                    id: generateId(),
                    articleId: article.id,
                    name: article.name,
                    price: article.price || 0,
                    tva: article.tva || TVA_RATE,
                    unit: article.unit || 'pce',
                    qty: 1,
                    discount: 0
                });
            }
            
            renderCart();
            showNotification(`${article.name} ajout√©`, 'success', 1500);
        }
        
        function updateQty(itemId, delta) {
            const item = cart.find(i => i.id === itemId);
            if (!item) return;
            
            item.qty = Math.max(0.1, item.qty + delta);
            
            if (item.qty < 0.05) {
                cart = cart.filter(i => i.id !== itemId);
            }
            
            renderCart();
        }
        
        function removeItem(itemId) {
            cart = cart.filter(i => i.id !== itemId);
            renderCart();
        }
        
        function clearTicket() {
            if (cart.length > 0 && !confirm('Vider le ticket ?')) return;
            cart = [];
            document.getElementById('globalDiscount').value = 0;
            renderCart();
        }
        
        function renderCart() {
            const container = document.getElementById('ticket-items');
            const countBadge = document.getElementById('ticket-count');
            
            const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
            countBadge.textContent = `${totalQty.toFixed(totalQty % 1 ? 2 : 0)} article${totalQty > 1 ? 's' : ''}`;
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-ticket">
                        <div class="empty-ticket-icon">üõí</div>
                        <p>Ticket vide</p>
                        <p style="font-size: 12px; margin-top: 5px;">Cliquez sur un article</p>
                    </div>
                `;
                updateTotals();
                return;
            }
            
            container.innerHTML = cart.map(item => {
                const lineTotal = item.price * item.qty;
                return `
                    <div class="ticket-item">
                        <div class="ticket-item-info">
                            <div class="ticket-item-name">${item.name}</div>
                            <div class="ticket-item-details">
                                ${item.weight ? `${item.qty.toFixed(3)} kg √ó ${formatCHF(item.price)}/kg` : 
                                  `${item.qty} √ó ${formatCHF(item.price)}`}
                            </div>
                        </div>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="updateQty('${item.id}', ${item.weight ? -0.1 : -1})">‚àí</button>
                            <span class="qty-value">${item.weight ? item.qty.toFixed(2) : item.qty}</span>
                            <button class="qty-btn" onclick="updateQty('${item.id}', ${item.weight ? 0.1 : 1})">+</button>
                        </div>
                        <div class="ticket-item-price">${formatCHF(lineTotal)}</div>
                        <button class="remove-btn" onclick="removeItem('${item.id}')">√ó</button>
                    </div>
                `;
            }).join('');
            
            updateTotals();
        }
        
        function updateTotals() {
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            
            let subtotalTTC = 0;
            cart.forEach(item => {
                subtotalTTC += item.price * item.qty - (item.discount || 0);
            });
            
            const subtotalHT = subtotalTTC / (1 + TVA_RATE / 100);
            const totalTVA = subtotalTTC - subtotalHT;
            const total = swiss(subtotalTTC - globalDiscount);
            
            document.getElementById('subtotal-ht').textContent = formatCHF(subtotalHT);
            document.getElementById('total-tva').textContent = formatCHF(totalTVA);
            document.getElementById('grand-total').textContent = formatCHF(Math.max(0, total));
            
            const discountRow = document.getElementById('discount-row');
            if (globalDiscount > 0) {
                discountRow.style.display = 'flex';
                document.getElementById('total-discount').textContent = `-${formatCHF(globalDiscount)}`;
            } else {
                discountRow.style.display = 'none';
            }
        }
        
        // ============================================
        // MODAL PES√âE
        // ============================================
        
        function openWeightModal(article) {
            currentWeightArticle = article;
            weightInput = '';
            
            document.getElementById('weight-article-name').textContent = article.name;
            document.getElementById('weight-price').textContent = `${formatCHF(article.price)}/kg`;
            document.getElementById('weight-value').textContent = '0.000';
            document.getElementById('weight-total').textContent = '0.00 CHF';
            
            document.getElementById('weightModal').classList.add('active');
        }
        
        function closeWeightModal() {
            document.getElementById('weightModal').classList.remove('active');
            currentWeightArticle = null;
            weightInput = '';
        }
        
        function numpadInput(key) {
            if (key === 'C') {
                weightInput = '';
            } else if (key === '.') {
                if (!weightInput.includes('.')) {
                    weightInput += weightInput ? '.' : '0.';
                }
            } else {
                const parts = weightInput.split('.');
                if (parts[1] && parts[1].length >= 3) return;
                weightInput += key;
            }
            
            const weight = parseFloat(weightInput) || 0;
            document.getElementById('weight-value').textContent = weight.toFixed(3);
            
            if (currentWeightArticle) {
                const total = weight * currentWeightArticle.price;
                document.getElementById('weight-total').textContent = formatCHF(total);
            }
        }
        
        function confirmWeight() {
            const weight = parseFloat(weightInput) || 0;
            if (weight <= 0 || !currentWeightArticle) {
                showNotification('Entrez un poids valide', 'warning');
                return;
            }
            
            cart.push({
                id: generateId(),
                articleId: currentWeightArticle.id,
                name: currentWeightArticle.name,
                price: currentWeightArticle.price || 0,
                tva: currentWeightArticle.tva || TVA_RATE,
                unit: 'kg',
                qty: weight,
                weight: true,
                discount: 0
            });
            
            closeWeightModal();
            renderCart();
            showNotification(`${currentWeightArticle.name} (${weight.toFixed(3)} kg) ajout√©`, 'success');
        }
        
        // ============================================
        // CONFIGURATION MANIFESTATION
        // ============================================
        
        function loadEventConfig() {
            const stored = localStorage.getItem('trakio_caisse_event');
            if (stored) {
                eventConfig = JSON.parse(stored);
            }
            transactionCounter = parseInt(localStorage.getItem('trakio_tx_counter') || '0');
        }
        
        function saveEventConfigToStorage() {
            localStorage.setItem('trakio_caisse_event', JSON.stringify(eventConfig));
        }
        
        function updateEventDisplay() {
            document.getElementById('displayEventName').textContent = eventConfig.name || 'Non configur√©';
            document.getElementById('displayEventDate').textContent = eventConfig.date ? formatDate(eventConfig.date) : '-';
            document.getElementById('displayRedevance').textContent = `${eventConfig.redevance || 0}%`;
        }
        
        function openEventModal() {
            document.getElementById('eventName').value = eventConfig.name || '';
            document.getElementById('eventDate').value = eventConfig.date || new Date().toISOString().slice(0, 10);
            document.getElementById('eventRedevance').value = eventConfig.redevance || 0;
            document.getElementById('eventPreset').value = '';
            
            updateRedevancePreview();
            document.getElementById('eventModal').classList.add('active');
        }
        
        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
        }
        
        function applyPreset() {
            const preset = document.getElementById('eventPreset').value;
            if (!preset) return;
            
            const [name, redevance] = preset.split('|');
            const names = {
                'magasin': 'Magasin',
                'marche_nyon': 'March√© Nyon',
                'marche_morges': 'March√© Morges',
                'fete_nyon': 'F√™te de Nyon',
                'livraison': 'Livraison'
            };
            
            document.getElementById('eventName').value = names[name] || name;
            document.getElementById('eventRedevance').value = redevance;
            updateRedevancePreview();
        }
        
        function updateRedevancePreview() {
            const redevance = parseFloat(document.getElementById('eventRedevance').value) || 0;
            const preview = document.getElementById('redevancePreview');
            
            if (redevance > 0) {
                preview.style.display = 'block';
                
                // Calculer sur les transactions de l'√©v√©nement actuel
                const eventTx = getEventTransactions();
                const caTTC = eventTx.reduce((sum, tx) => sum + tx.total, 0);
                const caHT = caTTC / (1 + TVA_RATE / 100);
                const redevanceAmount = caHT * redevance / 100;
                const toRemit = caHT - redevanceAmount;
                
                document.getElementById('previewCaTTC').textContent = formatCHF(caTTC);
                document.getElementById('previewCaHT').textContent = formatCHF(caHT);
                document.getElementById('previewRedevancePercent').textContent = redevance;
                document.getElementById('previewRedevanceAmount').textContent = `-${formatCHF(redevanceAmount)}`;
                document.getElementById('previewToRemit').textContent = formatCHF(toRemit);
            } else {
                preview.style.display = 'none';
            }
        }
        
        function saveEventConfig() {
            const name = document.getElementById('eventName').value.trim();
            if (!name) {
                showNotification('Entrez un nom de manifestation', 'warning');
                return;
            }
            
            eventConfig = {
                name: name,
                date: document.getElementById('eventDate').value,
                redevance: parseFloat(document.getElementById('eventRedevance').value) || 0
            };
            
            saveEventConfigToStorage();
            updateEventDisplay();
            closeEventModal();
            showNotification('Configuration enregistr√©e', 'success');
        }
        
        // ============================================
        // TRANSACTIONS
        // ============================================
        
        function loadTransactions() {
            const stored = localStorage.getItem('trakio_caisse_transactions');
            if (stored) {
                transactions = JSON.parse(stored);
            }
        }
        
        function saveTransactions() {
            localStorage.setItem('trakio_caisse_transactions', JSON.stringify(transactions));
        }
        
        function getEventTransactions() {
            if (!eventConfig || !eventConfig.name) return [];
            return transactions.filter(tx => 
                tx.event === eventConfig.name && 
                tx.date === eventConfig.date &&
                !tx.cancelled
            );
        }
        
        // ============================================
        // PAIEMENT ESP√àCES - MODAL RENDU MONNAIE
        // ============================================
        
        let cashModalTotal = 0;
        let changeCountdownTimer = null;
        
        function openCashModal() {
            if (cart.length === 0) {
                showNotification('Le ticket est vide', 'warning');
                return;
            }
            
            // Calculer le total
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            let subtotalTTC = 0;
            cart.forEach(item => {
                subtotalTTC += item.price * item.qty - (item.discount || 0);
            });
            cashModalTotal = swiss(subtotalTTC - globalDiscount);
            
            // Afficher le total
            document.getElementById('cashTotalAmount').textContent = formatCHF(cashModalTotal);
            document.getElementById('cashCustomAmount').value = '';
            
            // Ouvrir le modal
            document.getElementById('cashModal').classList.add('active');
        }
        
        function closeCashModal() {
            document.getElementById('cashModal').classList.remove('active');
        }
        
        function selectCashAmount(amount) {
            if (amount < cashModalTotal) {
                showNotification(`Montant insuffisant (minimum ${formatCHF(cashModalTotal)})`, 'warning');
                return;
            }
            processCashPayment(amount);
        }
        
        function selectCustomCashAmount() {
            const amount = parseFloat(document.getElementById('cashCustomAmount').value) || 0;
            if (amount < cashModalTotal) {
                showNotification(`Montant insuffisant (minimum ${formatCHF(cashModalTotal)})`, 'warning');
                return;
            }
            processCashPayment(amount);
        }
        
        function selectExactAmount() {
            processCashPayment(cashModalTotal);
        }
        
        function processCashPayment(amountReceived) {
            const changeAmount = swiss(amountReceived - cashModalTotal);
            
            // Fermer le modal esp√®ces
            closeCashModal();
            
            // D√©finir le mode de paiement courant
            currentPaymentMethod = 'cash';
            
            // Afficher le rendu
            document.getElementById('changeTotal').textContent = formatCHF(cashModalTotal);
            document.getElementById('changeReceived').textContent = formatCHF(amountReceived);
            document.getElementById('changeAmount').textContent = formatCHF(changeAmount);
            
            // Ouvrir le modal de rendu
            document.getElementById('changeModal').classList.add('active');
            
            // Countdown et fermeture automatique
            let countdown = 5;
            document.getElementById('changeCountdown').innerHTML = `Fermeture dans ${countdown}s... <span style="opacity: 0.6;">(cliquer pour fermer)</span>`;
            
            if (changeCountdownTimer) clearInterval(changeCountdownTimer);
            
            changeCountdownTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    document.getElementById('changeCountdown').innerHTML = `Fermeture dans ${countdown}s... <span style="opacity: 0.6;">(cliquer pour fermer)</span>`;
                } else {
                    clearInterval(changeCountdownTimer);
                    document.getElementById('changeModal').classList.remove('active');
                    // Enregistrer la transaction (sans notification car d√©j√† affich√©e)
                    processPayment('cash', true);
                }
            }, 1000);
        }
        
        let currentPaymentMethod = 'cash'; // Pour savoir quel type de paiement traiter
        
        function closeChangeModalNow() {
            if (changeCountdownTimer) clearInterval(changeCountdownTimer);
            document.getElementById('changeModal').classList.remove('active');
            
            // Ne rien faire si ce n'est pas un paiement esp√®ces (carte/twint d√©j√† trait√©s)
            if (currentPaymentMethod === 'cash' && cart.length > 0) {
                processPayment('cash', true);
            }
            
            resetChangeModal();
        }
        
        // ============================================
        // PAIEMENT CARTE - MODAL TERMINAL
        // ============================================
        
        let cardModalTotal = 0;
        
        function openCardModal() {
            if (cart.length === 0) {
                showNotification('Le ticket est vide', 'warning');
                return;
            }
            
            // Calculer le total
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            let subtotalTTC = 0;
            cart.forEach(item => {
                subtotalTTC += item.price * item.qty - (item.discount || 0);
            });
            cardModalTotal = swiss(subtotalTTC - globalDiscount);
            
            // Afficher le total
            document.getElementById('cardTotalAmount').textContent = formatCHF(cardModalTotal);
            
            // Ouvrir le modal
            document.getElementById('cardModal').classList.add('active');
        }
        
        function closeCardModal() {
            document.getElementById('cardModal').classList.remove('active');
        }
        
        function confirmCardPayment() {
            closeCardModal();
            
            // Afficher confirmation succ√®s
            showSuccessModal('card', cardModalTotal);
            
            // Enregistrer la transaction
            processPayment('card', true);
        }
        
        // ============================================
        // PAIEMENT TWINT - MODAL TERMINAL
        // ============================================
        
        let twintModalTotal = 0;
        
        function openTwintModal() {
            if (cart.length === 0) {
                showNotification('Le ticket est vide', 'warning');
                return;
            }
            
            // Calculer le total
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            let subtotalTTC = 0;
            cart.forEach(item => {
                subtotalTTC += item.price * item.qty - (item.discount || 0);
            });
            twintModalTotal = swiss(subtotalTTC - globalDiscount);
            
            // Afficher le total
            document.getElementById('twintTotalAmount').textContent = formatCHF(twintModalTotal);
            
            // Ouvrir le modal
            document.getElementById('twintModal').classList.add('active');
        }
        
        function closeTwintModal() {
            document.getElementById('twintModal').classList.remove('active');
        }
        
        function confirmTwintPayment() {
            closeTwintModal();
            
            // Afficher confirmation succ√®s
            showSuccessModal('twint', twintModalTotal);
            
            // Enregistrer la transaction
            processPayment('twint', true);
        }
        
        // ============================================
        // MODAL SUCC√àS G√âN√âRIQUE
        // ============================================
        
        function showSuccessModal(method, amount) {
            const methodLabels = { card: 'üí≥ Carte', twint: 'üì± Twint', cash: 'üíµ Esp√®ces' };
            const methodColors = { card: '#0ea5e9', twint: '#000000', cash: '#10b981' };
            
            // D√©finir le mode de paiement (pas cash = transaction d√©j√† trait√©e)
            currentPaymentMethod = method;
            
            // R√©utiliser le modal de rendu pour afficher le succ√®s
            document.getElementById('changeTotal').textContent = formatCHF(amount);
            document.getElementById('changeReceived').textContent = methodLabels[method];
            document.getElementById('changeAmount').textContent = '‚úì Pay√©';
            document.getElementById('changeAmount').style.color = methodColors[method];
            
            // Modifier les labels
            const rows = document.querySelectorAll('#changeModal .change-row');
            rows[1].querySelector('span:first-child').textContent = 'Mode';
            rows[2].querySelector('span:first-child').textContent = 'Statut';
            
            // Ouvrir le modal
            document.getElementById('changeModal').classList.add('active');
            
            // Fermeture automatique apr√®s 3 secondes
            let countdown = 3;
            document.getElementById('changeCountdown').innerHTML = `Fermeture dans ${countdown}s... <span style="opacity: 0.6;">(cliquer pour fermer)</span>`;
            
            if (changeCountdownTimer) clearInterval(changeCountdownTimer);
            
            changeCountdownTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    document.getElementById('changeCountdown').innerHTML = `Fermeture dans ${countdown}s... <span style="opacity: 0.6;">(cliquer pour fermer)</span>`;
                } else {
                    clearInterval(changeCountdownTimer);
                    document.getElementById('changeModal').classList.remove('active');
                    resetChangeModal();
                }
            }, 1000);
        }
        
        function resetChangeModal() {
            // Remettre les labels par d√©faut
            const rows = document.querySelectorAll('#changeModal .change-row');
            rows[1].querySelector('span:first-child').textContent = 'Re√ßu';
            rows[2].querySelector('span:first-child').textContent = '√Ä rendre';
            document.getElementById('changeAmount').style.color = '';
        }
        
        // ============================================
        // PAIEMENT G√âN√âRAL
        // ============================================
        
        async function processPayment(method, skipNotification = false) {
            if (cart.length === 0) {
                showNotification('Le ticket est vide', 'warning');
                return;
            }
            
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            
            let subtotalTTC = 0;
            cart.forEach(item => {
                subtotalTTC += item.price * item.qty - (item.discount || 0);
            });
            
            const total = swiss(subtotalTTC - globalDiscount);
            const totalHT = total / (1 + TVA_RATE / 100);
            const totalTVA = total - totalHT;
            const redevanceAmount = total * ((eventConfig.redevance || 0) / 100);
            
            // Incr√©menter compteur
            transactionCounter++;
            localStorage.setItem('trakio_tx_counter', transactionCounter.toString());
            
            // Cr√©er la transaction
            const transaction = {
                id: generateId(),
                num: transactionCounter,
                date: eventConfig.date || new Date().toISOString().slice(0, 10),
                time: new Date().toTimeString().slice(0, 5),
                timestamp: Date.now(),
                event: eventConfig.name,
                eventRedevance: eventConfig.redevance,
                items: cart.map(item => ({
                    articleId: item.articleId,
                    name: item.name,
                    price: item.price,
                    qty: item.qty,
                    unit: item.unit,
                    tva: item.tva,
                    discount: item.discount || 0,
                    total: item.price * item.qty - (item.discount || 0)
                })),
                subtotal: subtotalTTC,
                discount: globalDiscount,
                totalHT: swiss(totalHT),
                totalTVA: swiss(totalTVA),
                totalTTC: total,
                total: total,
                redevance: swiss(redevanceAmount),
                paymentMethod: method,
                method: method,
                cancelled: false,
                synced: false
            };
            
            // Sauvegarder localement
            transactions.push(transaction);
            saveTransactions();
            
            // Sync Firebase avec structure dossier/date
            if (firebaseAvailable && db) {
                await saveTransactionToFirebase(transaction);
                transaction.synced = true;
                saveTransactions();
            }
            
            if (!skipNotification) {
                const methodLabels = { cash: 'esp√®ces', card: 'carte', twint: 'Twint' };
                showNotification(`‚úì Paiement ${methodLabels[method]}: ${formatCHF(total)}`, 'success');
            }
            
            // Reset
            cart = [];
            document.getElementById('globalDiscount').value = 0;
            renderCart();
        }
        
        // ============================================
        // RAPPORT
        // ============================================
        
        let currentReportTab = 'summary';
        
        function setReportTab(tab) {
            currentReportTab = tab;
            
            // Update tabs UI
            document.querySelectorAll('.report-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            
            // Update content
            document.getElementById('reportTabSummary').classList.toggle('active', tab === 'summary');
            document.getElementById('reportTabTickets').classList.toggle('active', tab === 'tickets');
            
            if (tab === 'tickets') {
                renderTicketsList();
            }
        }
        
        function filterTicketsList() {
            renderTicketsList();
        }
        
        function renderTicketsList() {
            const eventTx = getEventTransactions();
            const container = document.getElementById('ticketsList');
            const searchInput = document.getElementById('searchTickets');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            
            let filteredTx = eventTx;
            
            // Filtrer par recherche
            if (searchTerm) {
                filteredTx = eventTx.filter(tx => {
                    // Recherche par num√©ro
                    if (tx.num.toString().includes(searchTerm)) return true;
                    // Recherche par montant
                    if (tx.total.toString().includes(searchTerm)) return true;
                    // Recherche par article
                    if (tx.items.some(item => item.name.toLowerCase().includes(searchTerm))) return true;
                    // Recherche par mode de paiement
                    const methods = { cash: 'esp√®ces', card: 'carte', twint: 'twint' };
                    if (methods[tx.method]?.includes(searchTerm)) return true;
                    return false;
                });
            }
            
            if (filteredTx.length === 0) {
                container.innerHTML = `
                    <div class="tickets-empty">
                        <div class="tickets-empty-icon">${searchTerm ? 'üîç' : 'üßæ'}</div>
                        <p>${searchTerm ? 'Aucun ticket trouv√© pour "' + searchTerm + '"' : 'Aucun ticket pour cette manifestation'}</p>
                    </div>
                `;
                return;
            }
            
            // Trier par timestamp d√©croissant (plus r√©cent en premier)
            const sortedTx = [...filteredTx].sort((a, b) => b.timestamp - a.timestamp);
            
            const paymentIcons = { cash: 'üíµ', card: 'üí≥', twint: 'üì±' };
            const paymentLabels = { cash: 'Esp√®ces', card: 'Carte', twint: 'Twint' };
            
            container.innerHTML = sortedTx.map(tx => `
                <div class="ticket-card ${tx.cancelled ? 'cancelled' : ''}" onclick="showTicketDetail('${tx.id}')" style="cursor: pointer;">
                    <div class="ticket-header-row">
                        <div class="ticket-number">
                            #${tx.num.toString().padStart(4, '0')}
                            ${tx.cancelled ? '<span class="ticket-cancelled-badge">ANNUL√â</span>' : ''}
                        </div>
                        <div class="ticket-datetime">
                            üìÖ ${formatDate(tx.date)} √† ${tx.time}
                        </div>
                    </div>
                    <div class="ticket-items">
                        ${tx.items.map(item => `
                            <div class="ticket-item-row">
                                <span class="ticket-item-name">${item.name}</span>
                                <span class="ticket-item-qty">${item.qty} √ó ${formatCHF(item.price)}/${item.unit || 'kg'}</span>
                                <span class="ticket-item-total">${formatCHF(item.total)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="ticket-footer-row">
                        <span class="ticket-payment-badge ${tx.method}">
                            ${paymentIcons[tx.method] || 'üí∞'} ${paymentLabels[tx.method] || tx.method}
                        </span>
                        <div>
                            ${tx.discount > 0 ? `<span class="ticket-discount">-${formatCHF(tx.discount)}</span>` : ''}
                            <span class="ticket-total">${formatCHF(tx.total)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // ============================================
        // TICKET D√âTAIL - STYLE SUPERMARCH√â
        // ============================================
        
        let currentTicketId = null;
        
        function showTicketDetail(ticketId) {
            const tx = transactions.find(t => t.id === ticketId);
            if (!tx) return;
            
            currentTicketId = ticketId;
            
            // Remplir le ticket
            document.getElementById('receiptEventName').textContent = tx.event || 'Vente directe';
            document.getElementById('receiptNumber').textContent = '#' + tx.num.toString().padStart(4, '0');
            document.getElementById('receiptDate').textContent = formatDate(tx.date);
            document.getElementById('receiptTime').textContent = tx.time;
            
            // Articles
            const itemsHtml = tx.items.map(item => `
                <div class="receipt-item">
                    <div class="receipt-item-name">${item.name}</div>
                    <div class="receipt-item-detail">
                        <span>${item.qty} √ó ${formatCHF(item.price)}/${item.unit || 'kg'}</span>
                        <span>${formatCHF(item.total)}</span>
                    </div>
                </div>
            `).join('');
            document.getElementById('receiptItems').innerHTML = itemsHtml;
            
            // Totaux
            const subtotal = tx.items.reduce((sum, item) => sum + item.total, 0);
            document.getElementById('receiptSubtotal').querySelector('span:last-child').textContent = formatCHF(subtotal);
            
            // Remise
            if (tx.discount > 0) {
                document.getElementById('receiptDiscountRow').style.display = 'flex';
                document.getElementById('receiptDiscount').textContent = '-' + formatCHF(tx.discount);
            } else {
                document.getElementById('receiptDiscountRow').style.display = 'none';
            }
            
            // TVA et Total
            const tva = tx.totalTVA || (tx.total * TVA_RATE / (100 + TVA_RATE));
            document.getElementById('receiptTVA').textContent = formatCHF(tva);
            document.getElementById('receiptTotal').textContent = formatCHF(tx.total);
            
            // Mode de paiement
            const paymentIcons = { cash: 'üíµ', card: 'üí≥', twint: 'üì±' };
            const paymentLabels = { cash: 'Esp√®ces', card: 'Carte', twint: 'Twint' };
            document.getElementById('receiptPaymentIcon').textContent = paymentIcons[tx.method] || 'üí∞';
            document.getElementById('receiptPaymentMethod').textContent = paymentLabels[tx.method] || tx.method;
            
            // Ouvrir le modal
            document.getElementById('ticketDetailModal').classList.add('active');
        }
        
        function closeTicketDetail() {
            document.getElementById('ticketDetailModal').classList.remove('active');
            currentTicketId = null;
        }
        
        function printReceipt() {
            const content = document.getElementById('receiptContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Ticket</title>
                    <style>
                        body {
                            font-family: 'Courier New', monospace;
                            padding: 20px;
                            max-width: 300px;
                            margin: 0 auto;
                        }
                        .receipt-logo { font-size: 36px; text-align: center; }
                        .receipt-company { font-size: 18px; font-weight: bold; text-align: center; letter-spacing: 2px; }
                        .receipt-subtitle { font-size: 11px; color: #666; text-align: center; }
                        .receipt-event { font-size: 12px; text-align: center; padding: 5px; background: #eee; display: inline-block; border-radius: 3px; }
                        .receipt-header { text-align: center; margin-bottom: 15px; }
                        .receipt-divider { text-align: center; color: #ccc; font-size: 10px; margin: 12px 0; }
                        .receipt-info-row, .receipt-item-detail, .receipt-total-row { display: flex; justify-content: space-between; font-size: 12px; padding: 3px 0; }
                        .receipt-item-name { font-size: 13px; font-weight: 600; }
                        .receipt-item-detail { padding-left: 10px; color: #555; }
                        .receipt-total-row.grand-total { font-size: 18px; font-weight: bold; border-top: 2px dashed #333; padding-top: 10px; margin-top: 5px; }
                        .receipt-total-row.small { font-size: 11px; color: #666; }
                        .receipt-total-row.discount { color: #e53e3e; }
                        .receipt-payment { text-align: center; padding: 10px; background: #f0f0f0; border-radius: 4px; margin: 10px 0; }
                        .receipt-footer { text-align: center; margin-top: 15px; }
                        .receipt-footer p { font-size: 12px; margin: 5px 0; }
                        .receipt-small { font-size: 10px; color: #888; }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        function emailReceipt() {
            const tx = transactions.find(t => t.id === currentTicketId);
            if (!tx) return;
            
            // Construire le corps de l'email
            const itemsList = tx.items.map(item => 
                `  - ${item.name}: ${item.qty} x ${formatCHF(item.price)} = ${formatCHF(item.total)}`
            ).join('%0A');
            
            const paymentLabels = { cash: 'Esp√®ces', card: 'Carte', twint: 'Twint' };
            
            const subject = encodeURIComponent(`Ticket #${tx.num.toString().padStart(4, '0')} - Borex Poissons`);
            const body = encodeURIComponent(`BOREX POISSONS - Ticket de caisse
================================
Ticket N¬∞ #${tx.num.toString().padStart(4, '0')}
Date: ${formatDate(tx.date)} √† ${tx.time}
√âv√©nement: ${tx.event || 'Vente directe'}
================================

ARTICLES:
${tx.items.map(item => `  - ${item.name}: ${item.qty} x ${formatCHF(item.price)} = ${formatCHF(item.total)}`).join('\n')}

--------------------------------
${tx.discount > 0 ? `Remise: -${formatCHF(tx.discount)}\n` : ''}TVA 2.6%: ${formatCHF(tx.totalTVA || (tx.total * TVA_RATE / (100 + TVA_RATE)))}
TOTAL: ${formatCHF(tx.total)}
--------------------------------

Pay√© par: ${paymentLabels[tx.method] || tx.method}

Merci de votre visite !
www.borex-poissons.ch`);
            
            // Ouvrir le client email
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }
        
        function openReportModal() {
            const eventTx = getEventTransactions();
            
            // Stats g√©n√©rales
            const txCount = eventTx.length;
            const caTTC = eventTx.reduce((sum, tx) => sum + tx.total, 0);
            const caHT = caTTC / (1 + TVA_RATE / 100);
            const articlesCount = eventTx.reduce((sum, tx) => 
                sum + tx.items.reduce((s, i) => s + i.qty, 0), 0
            );
            
            // Par m√©thode
            const cash = eventTx.filter(tx => tx.method === 'cash').reduce((s, tx) => s + tx.total, 0);
            const card = eventTx.filter(tx => tx.method === 'card').reduce((s, tx) => s + tx.total, 0);
            const twint = eventTx.filter(tx => tx.method === 'twint').reduce((s, tx) => s + tx.total, 0);
            
            // Redevance
            const redevancePercent = eventConfig.redevance || 0;
            const redevanceAmount = caHT * redevancePercent / 100;
            const toRemit = caHT - redevanceAmount;
            
            // Afficher
            document.getElementById('reportEventName').textContent = `${eventConfig.name} (${formatDate(eventConfig.date)})`;
            document.getElementById('reportTxCount').textContent = txCount;
            document.getElementById('reportTicketCount').textContent = txCount;
            document.getElementById('reportCaTTC').textContent = formatCHF(caTTC);
            document.getElementById('reportCaHT').textContent = formatCHF(caHT);
            document.getElementById('reportArticles').textContent = Math.round(articlesCount);
            
            document.getElementById('reportCash').textContent = formatCHF(cash);
            document.getElementById('reportCard').textContent = formatCHF(card);
            document.getElementById('reportTwint').textContent = formatCHF(twint);
            
            document.getElementById('reportHT').textContent = formatCHF(caHT);
            document.getElementById('reportRedevancePercent').textContent = redevancePercent;
            document.getElementById('reportRedevanceAmount').textContent = `-${formatCHF(redevanceAmount)}`;
            document.getElementById('reportToRemit').textContent = formatCHF(toRemit);
            
            // Masquer section redevance si 0%
            document.getElementById('redevanceSection').style.display = redevancePercent > 0 ? 'block' : 'none';
            
            // Reset tab to summary
            currentReportTab = 'summary';
            setReportTab('summary');
            
            document.getElementById('reportModal').classList.add('active');
        }
        
        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
        }
        
        function exportReport() {
            const eventTx = getEventTransactions();
            const caTTC = eventTx.reduce((sum, tx) => sum + tx.total, 0);
            const caHT = caTTC / (1 + TVA_RATE / 100);
            const redevanceAmount = caHT * (eventConfig.redevance || 0) / 100;
            const toRemit = caHT - redevanceAmount;
            
            const cash = eventTx.filter(tx => tx.method === 'cash').reduce((s, tx) => s + tx.total, 0);
            const card = eventTx.filter(tx => tx.method === 'card').reduce((s, tx) => s + tx.total, 0);
            const twint = eventTx.filter(tx => tx.method === 'twint').reduce((s, tx) => s + tx.total, 0);
            
            const report = `
RAPPORT DE CAISSE - TRAKIO
================================
Manifestation: ${eventConfig.name}
Date: ${formatDate(eventConfig.date)}
================================

R√âSUM√â
------
Transactions: ${eventTx.length}
CA TTC: ${formatCHF(caTTC)}
CA HT: ${formatCHF(caHT)}

PAIEMENTS
---------
Esp√®ces: ${formatCHF(cash)}
Carte: ${formatCHF(card)}
Twint: ${formatCHF(twint)}

${eventConfig.redevance > 0 ? `
REDEVANCE
---------
Taux: ${eventConfig.redevance}%
Montant: ${formatCHF(redevanceAmount)}

√Ä REMETTRE: ${formatCHF(toRemit)}
` : ''}

D√âTAIL TRANSACTIONS
-------------------
${eventTx.map(tx => 
`#${tx.num} | ${tx.time} | ${tx.method.toUpperCase()} | ${formatCHF(tx.total)}`
).join('\n')}

================================
G√©n√©r√© le ${new Date().toLocaleString('fr-CH')}
            `.trim();
            
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `rapport_${eventConfig.name.replace(/\s+/g, '_')}_${eventConfig.date}.txt`;
            link.click();
            
            showNotification('Rapport export√©', 'success');
        }
        
        // ============================================
        // MODAL GESTION ARTICLES
        // ============================================
        
        function openArticlesModal() {
            currentArticlesTab = 'list';
            editingArticleId = null;
            document.getElementById('articleForm').style.display = 'none';
            document.getElementById('addArticleBtn').style.display = 'flex';
            document.getElementById('searchArticleModal').value = ''; // Reset recherche
            updateArticlesTabs();
            renderArticlesList();
            document.getElementById('articlesModal').classList.add('active');
        }
        
        function closeArticlesModal() {
            document.getElementById('articlesModal').classList.remove('active');
            cancelArticleForm();
        }
        
        function setArticlesTab(tab) {
            currentArticlesTab = tab;
            updateArticlesTabs();
            renderArticlesList();
        }
        
        function updateArticlesTabs() {
            document.querySelectorAll('.articles-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === currentArticlesTab);
            });
            
            const totalCount = articlesData.length;
            const favCount = articlesData.filter(a => a.favorite).length;
            
            document.getElementById('articlesCount').textContent = totalCount;
            document.getElementById('favoritesCount').textContent = favCount;
        }
        
        function renderArticlesList() {
            const container = document.getElementById('articlesList');
            const searchInput = document.getElementById('searchArticleModal');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            
            let listData = articlesData;
            
            // Filtre par tab (favoris ou tous)
            if (currentArticlesTab === 'favorites') {
                listData = articlesData.filter(a => a.favorite);
            }
            
            // Filtre par recherche
            if (searchTerm) {
                listData = listData.filter(a => 
                    a.name?.toLowerCase().includes(searchTerm) ||
                    a.origin?.toLowerCase().includes(searchTerm) ||
                    a.category?.toLowerCase().includes(searchTerm)
                );
            }
            
            if (listData.length === 0) {
                container.innerHTML = `
                    <div class="empty-articles">
                        <div class="empty-articles-icon">${searchTerm ? 'üîç' : (currentArticlesTab === 'favorites' ? '‚≠ê' : 'üì¶')}</div>
                        <p>${searchTerm ? 'Aucun r√©sultat pour "' + searchTerm + '"' : (currentArticlesTab === 'favorites' ? 'Aucun favori' : 'Aucun article')}</p>
                        <p style="font-size: 12px; margin-top: 5px;">
                            ${searchTerm ? 'Essayez un autre terme de recherche' : (currentArticlesTab === 'favorites' ? 'Cliquez sur ‚òÜ pour ajouter des favoris' : 'Ajoutez des articles pour commencer')}
                        </p>
                    </div>
                `;
                return;
            }
            
            const icons = {
                poissons: 'üêü', crustaces: 'ü¶ê', coquillages: 'ü¶™',
                fumes: 'üî•', traiteur: 'üçΩÔ∏è', epicerie: 'üõí'
            };
            
            container.innerHTML = listData.map(article => `
                <div class="article-list-item">
                    <span class="article-list-fav" onclick="toggleFavorite('${article.id}')" title="${article.favorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}">
                        ${article.favorite ? '‚≠ê' : '‚òÜ'}
                    </span>
                    ${article.image ? 
                        `<div class="article-list-thumb" style="background-image: url('${article.image}');"></div>` :
                        `<span style="font-size: 20px;">${icons[article.category] || 'üì¶'}</span>`
                    }
                    <div class="article-list-info">
                        <div class="article-list-name">${article.name}</div>
                        <div class="article-list-details">
                            ${article.origin ? `üìç ${article.origin} ‚Ä¢ ` : ''}${article.unit}
                        </div>
                    </div>
                    <div class="article-list-price">${formatCHF(article.price)}</div>
                    <div class="article-list-actions">
                        <button class="article-list-btn" onclick="editArticle('${article.id}')" title="Modifier">‚úèÔ∏è</button>
                        <button class="article-list-btn delete" onclick="deleteArticle('${article.id}')" title="Supprimer">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }
        
        function filterArticlesList() {
            renderArticlesList();
        }
        
        function toggleFavorite(articleId) {
            const article = articlesData.find(a => a.id === articleId);
            if (article) {
                article.favorite = !article.favorite;
                saveArticlesToStorage();
                renderArticlesList();
                updateArticlesTabs();
                filterArticles(); // Refresh main grid
                showNotification(article.favorite ? '‚≠ê Ajout√© aux favoris' : 'Retir√© des favoris', 'success', 1500);
            }
        }
        
        function showArticleForm(articleId = null) {
            editingArticleId = articleId;
            const form = document.getElementById('articleForm');
            const addBtn = document.getElementById('addArticleBtn');
            
            form.style.display = 'block';
            addBtn.style.display = 'none';
            
            // Reset image preview
            resetImagePreview();
            
            if (articleId) {
                const article = articlesData.find(a => a.id === articleId);
                if (article) {
                    document.getElementById('articleFormTitle').textContent = '‚úèÔ∏è Modifier l\'article';
                    document.getElementById('editArticleId').value = articleId;
                    document.getElementById('articleName').value = article.name || '';
                    document.getElementById('articlePrice').value = article.price || '';
                    document.getElementById('articleUnit').value = article.unit || 'kg';
                    document.getElementById('articleCategory').value = article.category || 'poissons';
                    document.getElementById('articleOrigin').value = article.origin || '';
                    
                    // Charger l'image si elle existe
                    if (article.image) {
                        document.getElementById('articleImage').value = article.image;
                        document.getElementById('imagePreview').innerHTML = `<img src="${article.image}" alt="Preview">`;
                        document.getElementById('imagePreview').classList.add('has-image');
                        document.getElementById('removeImageBtn').style.display = 'block';
                    }
                }
            } else {
                document.getElementById('articleFormTitle').textContent = '‚ûï Nouvel article';
                document.getElementById('editArticleId').value = '';
                document.getElementById('articleName').value = '';
                document.getElementById('articlePrice').value = '';
                document.getElementById('articleUnit').value = 'kg';
                document.getElementById('articleCategory').value = 'poissons';
                document.getElementById('articleOrigin').value = '';
            }
            
            document.getElementById('articleName').focus();
        }
        
        function resetImagePreview() {
            document.getElementById('articleImage').value = '';
            document.getElementById('imagePreview').innerHTML = 'üì∑';
            document.getElementById('imagePreview').classList.remove('has-image');
            document.getElementById('removeImageBtn').style.display = 'none';
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Compression et redimensionnement automatique
            const maxSize = 200; // 200x200 pixels max
            const quality = 0.9; // 90% qualit√© PNG
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Cr√©er un canvas pour redimensionner
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Redimensionner si trop grand
                    if (width > height) {
                        if (width > maxSize) {
                            height = Math.round(height * maxSize / width);
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = Math.round(width * maxSize / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Supprimer le fond blanc/clair
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        // D√©tecter les pixels clairs (fond blanc/gris clair)
                        // Seuil : si R, G, B sont tous > 200 et proches les uns des autres
                        const isLight = r > 200 && g > 200 && b > 200;
                        const isGrayish = Math.abs(r - g) < 30 && Math.abs(g - b) < 30 && Math.abs(r - b) < 30;
                        
                        if (isLight && isGrayish) {
                            data[i + 3] = 0; // Rendre transparent
                        }
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    
                    // Convertir en PNG avec transparence
                    const compressedBase64 = canvas.toDataURL('image/png');
                    
                    document.getElementById('articleImage').value = compressedBase64;
                    document.getElementById('imagePreview').innerHTML = `<img src="${compressedBase64}" alt="Preview">`;
                    document.getElementById('imagePreview').classList.add('has-image');
                    document.getElementById('removeImageBtn').style.display = 'block';
                    
                    console.log('Image trait√©e:', Math.round(compressedBase64.length / 1024) + 'KB');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function removeImage() {
            resetImagePreview();
            document.getElementById('imageInput').value = '';
        }
        
        function cancelArticleForm() {
            editingArticleId = null;
            document.getElementById('articleForm').style.display = 'none';
            document.getElementById('addArticleBtn').style.display = 'flex';
            resetImagePreview();
        }
        
        function saveArticle() {
            const name = document.getElementById('articleName').value.trim();
            const price = parseFloat(document.getElementById('articlePrice').value);
            
            if (!name) {
                showNotification('Entrez un nom d\'article', 'warning');
                return;
            }
            
            if (isNaN(price) || price <= 0) {
                showNotification('Entrez un prix valide', 'warning');
                return;
            }
            
            const imageData = document.getElementById('articleImage').value;
            
            const articleData = {
                name: name,
                price: price,
                unit: document.getElementById('articleUnit').value,
                category: document.getElementById('articleCategory').value,
                origin: document.getElementById('articleOrigin').value.trim(),
                image: imageData || null,
                tva: TVA_RATE,
                active: true,
                updatedAt: Date.now()
            };
            
            if (editingArticleId) {
                // Modification
                const index = articlesData.findIndex(a => a.id === editingArticleId);
                if (index !== -1) {
                    articleData.id = editingArticleId;
                    articleData.favorite = articlesData[index].favorite || false;
                    articleData.createdAt = articlesData[index].createdAt || Date.now();
                    articlesData[index] = articleData;
                    showNotification('Article modifi√©', 'success');
                }
            } else {
                // Cr√©ation
                articleData.id = generateId();
                articleData.favorite = false;
                articleData.createdAt = Date.now();
                articlesData.push(articleData);
                showNotification('Article ajout√©', 'success');
            }
            
            saveArticlesToStorage();
            saveArticlesToFirebase(); // Sync Firebase
            cancelArticleForm();
            renderArticlesList();
            updateArticlesTabs();
            filterArticles(); // Refresh main grid
        }
        
        function editArticle(articleId) {
            showArticleForm(articleId);
        }
        
        function deleteArticle(articleId) {
            const article = articlesData.find(a => a.id === articleId);
            if (!article) return;
            
            if (confirm(`Supprimer "${article.name}" ?`)) {
                articlesData = articlesData.filter(a => a.id !== articleId);
                saveArticlesToStorage();
                renderArticlesList();
                updateArticlesTabs();
                filterArticles();
                showNotification('Article supprim√©', 'success');
            }
        }
        
        function importFromModule() {
            // Importer depuis le module Articles principal
            const moduleArticles = localStorage.getItem('trakio_articles');
            
            if (!moduleArticles) {
                showNotification('Aucun article dans le module Articles', 'warning');
                return;
            }
            
            try {
                let imported = JSON.parse(moduleArticles);
                if (imported.articles) imported = imported.articles;
                
                if (!Array.isArray(imported) || imported.length === 0) {
                    showNotification('Aucun article √† importer', 'warning');
                    return;
                }
                
                const existingIds = new Set(articlesData.map(a => a.id));
                let addedCount = 0;
                
                imported.forEach(article => {
                    if (!existingIds.has(article.id) && article.active !== false) {
                        articlesData.push({
                            id: article.id || generateId(),
                            name: article.name,
                            price: article.price || 0,
                            unit: article.unit || 'kg',
                            category: article.category || 'poissons',
                            origin: article.origin || '',
                            tva: article.tva || TVA_RATE,
                            active: true,
                            favorite: false
                        });
                        addedCount++;
                    }
                });
                
                if (addedCount > 0) {
                    saveArticlesToStorage();
                    renderArticlesList();
                    updateArticlesTabs();
                    filterArticles();
                    showNotification(`${addedCount} articles import√©s`, 'success');
                } else {
                    showNotification('Tous les articles existent d√©j√†', 'warning');
                }
                
            } catch (e) {
                console.error('Erreur import:', e);
                showNotification('Erreur lors de l\'import', 'error');
            }
        }
        
        // ============================================
        // SYNC
        // ============================================
        
        async function syncData() {
            if (!firebaseAvailable || !db) {
                showNotification('Mode hors ligne - sync impossible', 'warning');
                return;
            }
            
            await syncAllData();
        }
        
        // ============================================
        // UTILITAIRES
        // ============================================
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        function swiss(amount) {
            // Arrondi suisse aux 5 centimes
            return Math.round(amount * 20) / 20;
        }
        
        function formatCHF(amount) {
            return new Intl.NumberFormat('fr-CH', {
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount) + ' CHF';
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-CH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function showNotification(message, type = 'success', duration = 3000) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type} show`;
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, duration);
        }
        
        // ============================================
        // RACCOURCIS CLAVIER
        // ============================================
        
        document.addEventListener('keydown', (e) => {
            // Escape = fermer modales
            if (e.key === 'Escape') {
                closeWeightModal();
                closeEventModal();
                closeReportModal();
                closeArticlesModal();
            }
            
            // Enter dans modal pes√©e = confirmer
            if (e.key === 'Enter' && document.getElementById('weightModal').classList.contains('active')) {
                confirmWeight();
            }
            
            // Numpad dans modal pes√©e
            if (document.getElementById('weightModal').classList.contains('active')) {
                if (e.key >= '0' && e.key <= '9') {
                    numpadInput(e.key);
                } else if (e.key === '.' || e.key === ',') {
                    numpadInput('.');
                } else if (e.key === 'Backspace') {
                    weightInput = weightInput.slice(0, -1);
                    const weight = parseFloat(weightInput) || 0;
                    document.getElementById('weight-value').textContent = weight.toFixed(3);
                    if (currentWeightArticle) {
                        document.getElementById('weight-total').textContent = formatCHF(weight * currentWeightArticle.price);
                    }
                }
            }
        });
        
        // Update preview quand on change la redevance
        document.getElementById('eventRedevance')?.addEventListener('input', updateRedevancePreview);
        
        // ============================================
        // D√âMARRAGE
        // ============================================
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

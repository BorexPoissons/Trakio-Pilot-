<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caisse - TRAKIO v4.3.0</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêü</text></svg>">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- TRAKIO Core -->
    <script src="trakio-config.js"></script>
    <script src="trakio-sync.js"></script>
    <script src="trakio-ui.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --border: #475569;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --primary: #0ea5e9;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        
        body.trakio-app {
            overflow: hidden;
            height: 100vh;
        }
        
        /* LAYOUT 3 COLONNES */
        .pos-container {
            display: grid;
            grid-template-columns: 1fr 100px 380px;
            gap: 15px;
            height: calc(100vh - 80px);
            padding: 15px;
            overflow: hidden;
        }
        
        @media (max-width: 1200px) {
            .pos-container {
                grid-template-columns: 1fr 80px 320px;
            }
        }
        
        @media (max-width: 900px) {
            .pos-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: auto;
                overflow: auto;
            }
            
            .categories-col {
                display: flex !important;
                flex-direction: row !important;
                overflow-x: auto;
                gap: 8px;
                padding: 10px 0;
            }
            
            .category-btn {
                min-width: 80px;
                height: auto !important;
                padding: 10px !important;
            }
        }
        
        /* COLONNE ARTICLES */
        .articles-col {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .col-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.2);
        }
        
        .col-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            margin: 10px 15px;
            width: calc(100% - 30px);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }
        
        .article-btn {
            background: var(--bg-input);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .article-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .article-btn:active {
            transform: scale(0.98);
        }
        
        .article-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .article-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 4px;
            line-height: 1.2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .article-origin {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        .article-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--success);
        }
        
        .article-unit {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        /* COLONNE CAT√âGORIES */
        .categories-col {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .category-btn {
            height: 70px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
            color: white;
            font-weight: 600;
            font-size: 11px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .category-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .category-btn.active {
            box-shadow: 0 0 0 3px white, 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .category-btn span:first-child {
            font-size: 22px;
        }
        
        .cat-all { background: linear-gradient(135deg, #64748b, #475569); }
        .cat-poissons { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
        .cat-crustaces { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .cat-coquillages { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .cat-fumes { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .cat-traiteur { background: linear-gradient(135deg, #10b981, #059669); }
        .cat-epicerie { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        
        /* COLONNE TICKET */
        .ticket-col {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .ticket-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        
        .ticket-event {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .ticket-event select {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
        }
        
        .ticket-items {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .ticket-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .ticket-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .ticket-item-name {
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .ticket-item-details {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .ticket-item-price {
            font-weight: 600;
            color: var(--success);
            white-space: nowrap;
        }
        
        .ticket-item-price.discounted {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .ticket-item-price .original {
            font-size: 11px;
            text-decoration: line-through;
            color: var(--text-muted);
        }
        
        .ticket-item-price .discount-amount {
            font-size: 10px;
            color: var(--error);
        }
        
        .qty-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--bg-dark);
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .qty-btn:hover {
            background: var(--primary);
        }
        
        .qty-value {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
        }
        
        .remove-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 16px;
        }
        
        .remove-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        /* TICKET TOTAUX */
        .ticket-totals {
            padding: 15px;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
        }
        
        .total-row.subtotal {
            color: var(--text-muted);
        }
        
        .total-row.discount {
            color: var(--error);
        }
        
        .total-row.grand-total {
            font-size: 20px;
            font-weight: 700;
            padding: 10px 0;
            border-top: 2px solid var(--border);
            margin-top: 10px;
        }
        
        .discount-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }
        
        .discount-input label {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .discount-input input {
            width: 70px;
            padding: 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            text-align: center;
        }
        
        /* BOUTONS PAIEMENT */
        .payment-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 15px;
            border-top: 1px solid var(--border);
        }
        
        .pay-btn {
            padding: 15px 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .pay-btn:hover {
            transform: translateY(-2px);
        }
        
        .pay-btn.cash {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }
        
        .pay-btn.card {
            background: linear-gradient(135deg, var(--primary), #0284c7);
            color: white;
        }
        
        .pay-btn.twint {
            background: #000;
            color: white;
        }
        
        .pay-btn span:first-child {
            font-size: 24px;
        }
        
        .clear-btn {
            grid-column: 1 / -1;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            font-weight: 500;
        }
        
        .clear-btn:hover {
            background: var(--error);
            border-color: var(--error);
        }
        
        /* MODAL PES√âE */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--border);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .weight-display {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .weight-value {
            font-size: 48px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        
        .weight-unit {
            font-size: 20px;
            color: var(--text-muted);
        }
        
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .numpad-btn {
            padding: 20px;
            font-size: 24px;
            font-weight: 600;
            background: var(--bg-input);
            border: none;
            border-radius: 10px;
            color: var(--text);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .numpad-btn:hover {
            background: var(--border);
        }
        
        .numpad-btn.action {
            background: var(--primary);
            color: white;
        }
        
        .numpad-btn.clear {
            background: var(--error);
            color: white;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        
        .modal-actions button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
        }
        
        .modal-actions .cancel {
            background: var(--bg-input);
            color: var(--text);
        }
        
        .modal-actions .confirm {
            background: var(--success);
            color: white;
        }
        
        /* EMPTY STATE */
        .empty-ticket {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            padding: 40px;
            text-align: center;
        }
        
        .empty-ticket-icon {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="pos-container">
        <!-- COLONNE ARTICLES -->
        <div class="articles-col">
            <div class="col-header">
                <span class="col-title">
                    <span>üêü</span>
                    <span>Articles</span>
                    <span id="articles-count" style="color: var(--text-muted); font-weight: 400;">(0)</span>
                </span>
                <button onclick="openSettings()" style="background: var(--bg-input); border: none; padding: 8px 12px; border-radius: 8px; color: var(--text); cursor: pointer;">
                    ‚öôÔ∏è Param√®tres
                </button>
            </div>
            <input type="text" class="search-input" placeholder="üîç Rechercher un article..." id="searchArticle" oninput="filterArticles()">
            <div class="articles-grid" id="articles-grid">
                <!-- Articles dynamiques -->
            </div>
        </div>
        
        <!-- COLONNE CAT√âGORIES -->
        <div class="categories-col">
            <button class="category-btn cat-all active" onclick="selectCategory('')" data-cat="">
                <span>üì¶</span>
                <span>Tous</span>
            </button>
            <button class="category-btn cat-poissons" onclick="selectCategory('poissons')" data-cat="poissons">
                <span>üêü</span>
                <span>Poissons</span>
            </button>
            <button class="category-btn cat-crustaces" onclick="selectCategory('crustaces')" data-cat="crustaces">
                <span>ü¶ê</span>
                <span>Crustac√©s</span>
            </button>
            <button class="category-btn cat-coquillages" onclick="selectCategory('coquillages')" data-cat="coquillages">
                <span>ü¶™</span>
                <span>Coquillages</span>
            </button>
            <button class="category-btn cat-fumes" onclick="selectCategory('fumes')" data-cat="fumes">
                <span>üî•</span>
                <span>Fum√©s</span>
            </button>
            <button class="category-btn cat-traiteur" onclick="selectCategory('traiteur')" data-cat="traiteur">
                <span>üçΩÔ∏è</span>
                <span>Traiteur</span>
            </button>
            <button class="category-btn cat-epicerie" onclick="selectCategory('epicerie')" data-cat="epicerie">
                <span>üõí</span>
                <span>√âpicerie</span>
            </button>
        </div>
        
        <!-- COLONNE TICKET -->
        <div class="ticket-col">
            <div class="ticket-header">
                <div class="ticket-event">
                    <span>üìç</span>
                    <select id="eventSelect">
                        <option value="magasin">Magasin</option>
                        <option value="marche_nyon">March√© Nyon</option>
                        <option value="marche_morges">March√© Morges</option>
                        <option value="livraison">Livraison</option>
                    </select>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="col-title">
                        <span>üßæ</span>
                        <span>Ticket</span>
                    </span>
                    <span id="ticket-count" style="background: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 12px;">0 article</span>
                </div>
            </div>
            
            <div class="ticket-items" id="ticket-items">
                <div class="empty-ticket">
                    <div class="empty-ticket-icon">üõí</div>
                    <p>Ticket vide</p>
                    <p style="font-size: 12px; margin-top: 5px;">Cliquez sur un article pour l'ajouter</p>
                </div>
            </div>
            
            <div class="ticket-totals">
                <div class="total-row subtotal">
                    <span>Sous-total HT</span>
                    <span id="subtotal-ht">0.00 CHF</span>
                </div>
                <div class="total-row subtotal">
                    <span>TVA</span>
                    <span id="total-tva">0.00 CHF</span>
                </div>
                <div class="discount-input">
                    <label>Remise globale</label>
                    <input type="number" id="globalDiscount" min="0" value="0" onchange="updateTotals()">
                    <span>CHF</span>
                </div>
                <div class="total-row discount" id="discount-row" style="display: none;">
                    <span>Remise</span>
                    <span id="total-discount">-0.00 CHF</span>
                </div>
                <div class="total-row grand-total">
                    <span>TOTAL</span>
                    <span id="grand-total">0.00 CHF</span>
                </div>
            </div>
            
            <div class="payment-buttons">
                <button class="pay-btn cash" onclick="processPayment('cash')">
                    <span>üíµ</span>
                    <span>Esp√®ces</span>
                </button>
                <button class="pay-btn card" onclick="processPayment('card')">
                    <span>üí≥</span>
                    <span>Carte</span>
                </button>
                <button class="pay-btn twint" onclick="processPayment('twint')">
                    <span>üì±</span>
                    <span>Twint</span>
                </button>
                <button class="clear-btn" onclick="clearTicket()">üóëÔ∏è Vider le ticket</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PES√âE -->
    <div class="modal-overlay" id="weightModal">
        <div class="modal">
            <div class="modal-title">
                <span>‚öñÔ∏è</span>
                <span id="weight-article-name">Article</span>
            </div>
            <div class="weight-display">
                <span class="weight-value" id="weight-value">0.000</span>
                <span class="weight-unit">kg</span>
            </div>
            <div style="text-align: center; margin-bottom: 15px; color: var(--text-muted);">
                Prix: <strong id="weight-price">0.00 CHF/kg</strong> = <strong id="weight-total" style="color: var(--success);">0.00 CHF</strong>
            </div>
            <div class="numpad">
                <button class="numpad-btn" onclick="numpadInput('1')">1</button>
                <button class="numpad-btn" onclick="numpadInput('2')">2</button>
                <button class="numpad-btn" onclick="numpadInput('3')">3</button>
                <button class="numpad-btn" onclick="numpadInput('4')">4</button>
                <button class="numpad-btn" onclick="numpadInput('5')">5</button>
                <button class="numpad-btn" onclick="numpadInput('6')">6</button>
                <button class="numpad-btn" onclick="numpadInput('7')">7</button>
                <button class="numpad-btn" onclick="numpadInput('8')">8</button>
                <button class="numpad-btn" onclick="numpadInput('9')">9</button>
                <button class="numpad-btn clear" onclick="numpadInput('C')">C</button>
                <button class="numpad-btn" onclick="numpadInput('0')">0</button>
                <button class="numpad-btn" onclick="numpadInput('.')">.</button>
            </div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeWeightModal()">Annuler</button>
                <button class="confirm" onclick="confirmWeight()">‚úì Ajouter</button>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // INITIALISATION
        // ============================================
        
        initTrakioApp('caisse');
        
        let articlesData = [];
        let filteredArticles = [];
        let currentCategory = '';
        let cart = [];
        let currentWeightArticle = null;
        let weightInput = '';
        let transactionCounter = parseInt(localStorage.getItem('trakio_tx_counter') || '0');
        
        // ============================================
        // CHARGEMENT DES ARTICLES
        // ============================================
        
        async function loadArticles() {
            try {
                articlesData = await Articles.getAll({
                    orderBy: { field: 'name', direction: 'asc' }
                });
                
                // Filtrer uniquement les articles actifs
                articlesData = articlesData.filter(a => a.active !== false);
                
                filterArticles();
                
            } catch (error) {
                console.error('Erreur chargement articles:', error);
                showNotification('Erreur de chargement', 'error');
            }
        }
        
        function filterArticles() {
            const search = document.getElementById('searchArticle').value.toLowerCase();
            
            filteredArticles = articlesData.filter(article => {
                const matchCategory = !currentCategory || article.category === currentCategory;
                const matchSearch = !search || 
                    article.name?.toLowerCase().includes(search) ||
                    article.origin?.toLowerCase().includes(search);
                
                return matchCategory && matchSearch;
            });
            
            renderArticles();
        }
        
        function selectCategory(cat) {
            currentCategory = cat;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.cat === cat);
            });
            
            filterArticles();
        }
        
        // ============================================
        // RENDU DES ARTICLES
        // ============================================
        
        function renderArticles() {
            const grid = document.getElementById('articles-grid');
            document.getElementById('articles-count').textContent = `(${filteredArticles.length})`;
            
            const categoryIcons = {
                poissons: 'üêü',
                crustaces: 'ü¶ê',
                coquillages: 'ü¶™',
                fumes: 'üî•',
                traiteur: 'üçΩÔ∏è',
                epicerie: 'üõí'
            };
            
            grid.innerHTML = filteredArticles.map(article => `
                <button class="article-btn" onclick="addToCart('${article.id}')">
                    <div class="article-icon">${categoryIcons[article.category] || 'üì¶'}</div>
                    <div class="article-name">${article.name}</div>
                    ${article.origin ? `<div class="article-origin">üìç ${article.origin}</div>` : ''}
                    <div class="article-price">${formatCHF(article.price || 0)}</div>
                    <div class="article-unit">/${article.unit || 'kg'}</div>
                </button>
            `).join('');
        }
        
        // ============================================
        // GESTION DU PANIER
        // ============================================
        
        function addToCart(articleId) {
            const article = articlesData.find(a => a.id === articleId);
            if (!article) return;
            
            // Si article √† peser
            if (article.unit === 'kg') {
                openWeightModal(article);
                return;
            }
            
            // Article √† la pi√®ce
            const existing = cart.find(item => item.articleId === articleId && !item.weight);
            
            if (existing) {
                existing.qty++;
            } else {
                cart.push({
                    id: generateId('item'),
                    articleId: article.id,
                    name: article.name,
                    price: article.price || 0,
                    tva: article.tva || 2.6,
                    unit: article.unit || 'pce',
                    qty: 1,
                    discount: 0
                });
            }
            
            renderCart();
            showNotification(`${article.name} ajout√©`, 'success', 1500);
        }
        
        function updateQty(itemId, delta) {
            const item = cart.find(i => i.id === itemId);
            if (!item) return;
            
            item.qty = Math.max(0.1, item.qty + delta);
            
            // Supprimer si qty tr√®s faible
            if (item.qty < 0.05) {
                cart = cart.filter(i => i.id !== itemId);
            }
            
            renderCart();
        }
        
        function removeItem(itemId) {
            cart = cart.filter(i => i.id !== itemId);
            renderCart();
        }
        
        function clearTicket() {
            if (cart.length > 0 && !confirm('Vider le ticket ?')) return;
            cart = [];
            document.getElementById('globalDiscount').value = 0;
            renderCart();
        }
        
        // ============================================
        // RENDU DU TICKET
        // ============================================
        
        function renderCart() {
            const container = document.getElementById('ticket-items');
            const countBadge = document.getElementById('ticket-count');
            
            const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
            countBadge.textContent = `${totalQty.toFixed(totalQty % 1 ? 2 : 0)} article${totalQty > 1 ? 's' : ''}`;
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-ticket">
                        <div class="empty-ticket-icon">üõí</div>
                        <p>Ticket vide</p>
                        <p style="font-size: 12px; margin-top: 5px;">Cliquez sur un article pour l'ajouter</p>
                    </div>
                `;
                updateTotals();
                return;
            }
            
            container.innerHTML = cart.map(item => {
                const lineTotal = item.price * item.qty;
                const hasDiscount = item.discount > 0;
                const discountedTotal = lineTotal - item.discount;
                
                return `
                    <div class="ticket-item">
                        <div class="ticket-item-info">
                            <div class="ticket-item-name">${item.name}</div>
                            <div class="ticket-item-details">
                                ${item.weight ? `${item.qty.toFixed(3)} kg √ó ${formatCHF(item.price)}/kg` : 
                                  `${item.qty} √ó ${formatCHF(item.price)}`}
                            </div>
                        </div>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="updateQty('${item.id}', ${item.weight ? -0.1 : -1})">‚àí</button>
                            <span class="qty-value">${item.weight ? item.qty.toFixed(2) : item.qty}</span>
                            <button class="qty-btn" onclick="updateQty('${item.id}', ${item.weight ? 0.1 : 1})">+</button>
                        </div>
                        <div class="ticket-item-price ${hasDiscount ? 'discounted' : ''}">
                            ${hasDiscount ? `
                                <span class="original">${formatCHF(lineTotal)}</span>
                                <span>${formatCHF(discountedTotal)}</span>
                                <span class="discount-amount">-${formatCHF(item.discount)}</span>
                            ` : formatCHF(lineTotal)}
                        </div>
                        <button class="remove-btn" onclick="removeItem('${item.id}')">√ó</button>
                    </div>
                `;
            }).join('');
            
            updateTotals();
        }
        
        function updateTotals() {
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            
            let subtotalHT = 0;
            let totalTVA = 0;
            
            cart.forEach(item => {
                const lineTotal = item.price * item.qty - (item.discount || 0);
                const tvaRate = item.tva || 2.6;
                const ht = lineTotal / (1 + tvaRate / 100);
                const tva = lineTotal - ht;
                
                subtotalHT += ht;
                totalTVA += tva;
            });
            
            const subtotal = subtotalHT + totalTVA;
            const total = TRAKIO.swiss(subtotal - globalDiscount);
            
            document.getElementById('subtotal-ht').textContent = formatCHF(subtotalHT);
            document.getElementById('total-tva').textContent = formatCHF(totalTVA);
            document.getElementById('grand-total').textContent = formatCHF(Math.max(0, total));
            
            const discountRow = document.getElementById('discount-row');
            if (globalDiscount > 0) {
                discountRow.style.display = 'flex';
                document.getElementById('total-discount').textContent = `-${formatCHF(globalDiscount)}`;
            } else {
                discountRow.style.display = 'none';
            }
        }
        
        // ============================================
        // MODAL PES√âE
        // ============================================
        
        function openWeightModal(article) {
            currentWeightArticle = article;
            weightInput = '';
            
            document.getElementById('weight-article-name').textContent = article.name;
            document.getElementById('weight-price').textContent = `${formatCHF(article.price)}/kg`;
            document.getElementById('weight-value').textContent = '0.000';
            document.getElementById('weight-total').textContent = '0.00 CHF';
            
            document.getElementById('weightModal').classList.add('active');
        }
        
        function closeWeightModal() {
            document.getElementById('weightModal').classList.remove('active');
            currentWeightArticle = null;
            weightInput = '';
        }
        
        function numpadInput(key) {
            if (key === 'C') {
                weightInput = '';
            } else if (key === '.') {
                if (!weightInput.includes('.')) {
                    weightInput += weightInput ? '.' : '0.';
                }
            } else {
                // Max 3 d√©cimales
                const parts = weightInput.split('.');
                if (parts[1] && parts[1].length >= 3) return;
                weightInput += key;
            }
            
            const weight = parseFloat(weightInput) || 0;
            document.getElementById('weight-value').textContent = weight.toFixed(3);
            
            if (currentWeightArticle) {
                const total = weight * currentWeightArticle.price;
                document.getElementById('weight-total').textContent = formatCHF(total);
            }
        }
        
        function confirmWeight() {
            const weight = parseFloat(weightInput) || 0;
            if (weight <= 0 || !currentWeightArticle) {
                showNotification('Entrez un poids valide', 'warning');
                return;
            }
            
            cart.push({
                id: generateId('item'),
                articleId: currentWeightArticle.id,
                name: currentWeightArticle.name,
                price: currentWeightArticle.price || 0,
                tva: currentWeightArticle.tva || 2.6,
                unit: 'kg',
                qty: weight,
                weight: true,
                discount: 0
            });
            
            closeWeightModal();
            renderCart();
            showNotification(`${currentWeightArticle.name} (${weight.toFixed(3)} kg) ajout√©`, 'success');
        }
        
        // ============================================
        // PAIEMENT
        // ============================================
        
        async function processPayment(method) {
            if (cart.length === 0) {
                showNotification('Le ticket est vide', 'warning');
                return;
            }
            
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            const event = document.getElementById('eventSelect').value;
            
            // Calculer le total
            let total = 0;
            cart.forEach(item => {
                total += item.price * item.qty - (item.discount || 0);
            });
            total = TRAKIO.swiss(total - globalDiscount);
            
            // Incr√©menter compteur
            transactionCounter++;
            localStorage.setItem('trakio_tx_counter', transactionCounter.toString());
            
            // Cr√©er la transaction
            const transaction = {
                num: transactionCounter,
                date: new Date().toISOString().slice(0, 10),
                time: new Date().toTimeString().slice(0, 5),
                event: event,
                items: cart.map(item => ({
                    articleId: item.articleId,
                    name: item.name,
                    price: item.price,
                    qty: item.qty,
                    unit: item.unit,
                    tva: item.tva,
                    discount: item.discount || 0,
                    total: item.price * item.qty - (item.discount || 0)
                })),
                subtotal: total + globalDiscount,
                discount: globalDiscount,
                total: total,
                method: method,
                user: TRAKIO_STATE.currentUser,
                cancelled: false
            };
            
            try {
                // Sauvegarder dans Firebase
                await CaisseTransactions.save(null, transaction);
                
                showNotification(`Paiement ${method === 'cash' ? 'esp√®ces' : method === 'card' ? 'carte' : 'Twint'}: ${formatCHF(total)}`, 'success');
                
                // R√©initialiser
                cart = [];
                document.getElementById('globalDiscount').value = 0;
                renderCart();
                
            } catch (error) {
                console.error('Erreur paiement:', error);
                showNotification('Erreur de sauvegarde', 'error');
            }
        }
        
        // ============================================
        // PARAM√àTRES
        // ============================================
        
        function openSettings() {
            window.location.href = 'articles.html';
        }
        
        // ============================================
        // RACCOURCIS CLAVIER
        // ============================================
        
        document.addEventListener('keydown', (e) => {
            // Escape = fermer modal
            if (e.key === 'Escape') {
                closeWeightModal();
            }
            
            // Enter dans modal = confirmer
            if (e.key === 'Enter' && document.getElementById('weightModal').classList.contains('active')) {
                confirmWeight();
            }
            
            // Numpad dans modal
            if (document.getElementById('weightModal').classList.contains('active')) {
                if (e.key >= '0' && e.key <= '9') {
                    numpadInput(e.key);
                } else if (e.key === '.' || e.key === ',') {
                    numpadInput('.');
                } else if (e.key === 'Backspace') {
                    weightInput = weightInput.slice(0, -1);
                    const weight = parseFloat(weightInput) || 0;
                    document.getElementById('weight-value').textContent = weight.toFixed(3);
                    if (currentWeightArticle) {
                        document.getElementById('weight-total').textContent = formatCHF(weight * currentWeightArticle.price);
                    }
                }
            }
        });
        
        // ============================================
        // D√âMARRAGE
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadArticles, 300);
            
            // √âcoute temps r√©el des articles
            Articles.listen((data) => {
                articlesData = data.filter(a => a.active !== false);
                filterArticles();
            });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Caisse">
    <meta name="theme-color" content="#0f172a">
    
    <title>TRAKIO Caisse</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêü</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-input: #0f172a;
            --border: #334155;
            --text-primary: #f8fafc;
            --text-muted: #64748b;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            touch-action: manipulation;
        }
        
        /* HEADER 40px */
        .header {
            height: calc(40px + var(--safe-top));
            padding-top: var(--safe-top);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 10px;
            padding-right: 10px;
        }
        
        .header-left { display: flex; align-items: center; gap: 6px; }
        
        .logo { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 5px; }
        
        .logo-icon {
            width: 26px; height: 26px;
            background: linear-gradient(135deg, #06b6d4, #10b981);
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px;
        }
        
        .version { font-size: 8px; background: var(--accent); color: #000; padding: 2px 5px; border-radius: 3px; font-weight: 600; }
        
        .header-center { display: flex; align-items: center; gap: 6px; }
        
        .event-select {
            padding: 5px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-primary);
            font-size: 11px;
            font-family: inherit;
        }
        
        .status { display: flex; align-items: center; gap: 4px; font-size: 10px; color: var(--text-muted); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--success); }
        
        .header-right { display: flex; gap: 5px; }
        
        .header-btn {
            padding: 5px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }
        
        /* CAT√âGORIES 42px */
        .categories-bar {
            height: 42px;
            background: var(--bg-secondary);
            display: flex;
            gap: 5px;
            padding: 4px 8px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
            -webkit-overflow-scrolling: touch;
        }
        
        .categories-bar::-webkit-scrollbar { display: none; }
        
        .cat-btn {
            flex-shrink: 0;
            height: 34px;
            padding: 0 10px;
            border: none;
            border-radius: 7px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            color: white;
            font-weight: 600;
            font-size: 10px;
            white-space: nowrap;
        }
        
        .cat-btn:active { opacity: 0.8; }
        .cat-btn.active { box-shadow: 0 0 0 2px white; }
        .cat-btn span:first-child { font-size: 14px; }
        
        .cat-favoris { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .cat-tous { background: linear-gradient(135deg, #64748b, #475569); }
        .cat-poissons { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
        .cat-crustaces { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .cat-coquillages { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .cat-fumes { background: linear-gradient(135deg, #f97316, #ea580c); }
        .cat-traiteur { background: linear-gradient(135deg, #10b981, #059669); }
        .cat-epicerie { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        
        /* LAYOUT */
        .main {
            display: grid;
            grid-template-columns: 1fr 300px;
            height: calc(100% - 82px - var(--safe-top) - var(--safe-bottom));
            overflow: hidden;
        }
        
        /* ARTICLES */
        .articles-zone {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-right: 1px solid var(--border);
        }
        
        .search-bar {
            padding: 6px 8px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }
        
        .search-input {
            width: 100%;
            padding: 6px 10px 6px 28px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
        }
        
        .search-input:focus { outline: none; border-color: var(--accent); }
        .search-wrap { position: relative; }
        .search-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 12px; opacity: 0.5; }
        
        /* TUILES ULTRA-COMPACTES */
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 4px;
            padding: 6px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }
        
        .tile {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 3px;
            cursor: pointer;
            text-align: center;
            position: relative;
            min-height: 42px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .tile::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: var(--cat-color, var(--accent));
            border-radius: 6px 6px 0 0;
        }
        
        .tile:active { background: var(--bg-hover); transform: scale(0.95); }
        
        .tile-icon { font-size: 14px; line-height: 1; }
        .tile-name { font-size: 8px; font-weight: 600; line-height: 1.1; margin-top: 1px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
        .tile-price { font-size: 9px; font-weight: 700; color: var(--accent); }
        .tile-fav { position: absolute; top: 1px; right: 1px; font-size: 7px; }
        
        /* TICKET */
        .ticket-zone {
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            overflow: hidden;
        }
        
        .ticket-header {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ticket-title { font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 5px; }
        
        .ticket-count {
            background: var(--accent);
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .ticket-items {
            flex: 1;
            overflow-y: auto;
            padding: 4px;
            -webkit-overflow-scrolling: touch;
        }
        
        .ticket-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 4px;
        }
        
        .item-info { flex: 1; min-width: 0; }
        .item-name { font-weight: 600; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-details { font-size: 8px; color: var(--text-muted); }
        .item-price { font-weight: 700; color: var(--accent); font-size: 10px; min-width: 50px; text-align: right; }
        
        .qty-btns { display: flex; align-items: center; gap: 1px; }
        
        .qty-btn {
            width: 20px; height: 20px;
            border-radius: 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 12px; font-weight: 600;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        
        .qty-val { min-width: 20px; text-align: center; font-size: 10px; font-weight: 600; }
        .del-btn { width: 20px; height: 20px; background: none; border: none; color: var(--danger); font-size: 13px; cursor: pointer; }
        
        .empty-ticket {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 10px;
        }
        
        .empty-ticket span:first-child { font-size: 24px; opacity: 0.3; margin-bottom: 4px; }
        
        /* TOTAUX */
        .ticket-totals {
            padding: 5px 8px;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
        }
        
        .total-row { display: flex; justify-content: space-between; font-size: 9px; padding: 2px 0; color: var(--text-muted); }
        
        .total-row.grand {
            font-size: 15px; font-weight: 700; color: var(--accent);
            padding: 5px 0 2px;
            border-top: 1px solid var(--border);
            margin-top: 2px;
        }
        
        .discount-row { display: flex; align-items: center; gap: 4px; padding: 2px 0; }
        .discount-row label { font-size: 8px; color: var(--text-muted); }
        
        .discount-row input {
            width: 45px; padding: 2px 4px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 10px; text-align: center;
            font-family: inherit;
        }
        
        /* PAIEMENT */
        .payment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            padding: 5px 8px;
            border-top: 1px solid var(--border);
        }
        
        .pay-btn {
            padding: 8px 5px;
            border: none;
            border-radius: 7px;
            cursor: pointer;
            font-weight: 600;
            font-size: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            color: white;
            font-family: inherit;
        }
        
        .pay-btn:active { opacity: 0.8; transform: scale(0.95); }
        .pay-btn span:first-child { font-size: 16px; }
        
        .pay-btn.cash { background: linear-gradient(135deg, #10b981, #059669); }
        .pay-btn.card { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .pay-btn.twint { background: linear-gradient(135deg, #000, #333); }
        
        .clear-btn {
            grid-column: 1 / -1;
            padding: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-muted);
            font-size: 9px;
            cursor: pointer;
            font-family: inherit;
        }
        
        .clear-btn:active { background: var(--danger); color: white; }
        
        /* MODALS */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 10px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 15px;
            width: 100%;
            max-width: 300px;
            border: 1px solid var(--border);
        }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .modal-title { font-size: 15px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        
        .modal-close {
            width: 26px; height: 26px;
            border-radius: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 15px;
            cursor: pointer;
        }
        
        .weight-display {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .weight-value { font-size: 32px; font-weight: 700; color: var(--accent); }
        .weight-unit { font-size: 14px; color: var(--text-muted); }
        .weight-info { text-align: center; font-size: 11px; color: var(--text-muted); margin-bottom: 8px; }
        .weight-info strong { color: var(--success); }
        
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 10px; }
        
        .numpad-btn {
            padding: 10px;
            font-size: 16px; font-weight: 600;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 7px;
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
        }
        
        .numpad-btn:active { background: var(--bg-hover); }
        .numpad-btn.clear { background: var(--danger); color: white; }
        
        .modal-actions { display: flex; gap: 6px; }
        
        .modal-actions button {
            flex: 1; padding: 10px;
            border: none; border-radius: 8px;
            font-weight: 600; font-size: 12px;
            cursor: pointer; font-family: inherit;
        }
        
        .modal-actions .cancel { background: var(--bg-input); color: var(--text-primary); }
        .modal-actions .confirm { background: var(--success); color: white; }
        
        /* Cash */
        .cash-display { background: var(--bg-primary); border-radius: 10px; padding: 10px; text-align: center; margin-bottom: 8px; }
        .cash-label { font-size: 9px; color: var(--text-muted); }
        .cash-amount { font-size: 26px; font-weight: 700; color: var(--accent); }
        
        .cash-bills { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 8px; }
        
        .cash-bill {
            padding: 8px 5px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 7px;
            cursor: pointer;
            text-align: center;
            font-family: inherit;
        }
        
        .cash-bill.selected { border-color: var(--success); background: rgba(16,185,129,0.1); }
        .cash-bill-val { font-size: 14px; font-weight: 700; }
        .cash-bill-label { font-size: 7px; color: var(--text-muted); }
        
        .cash-input {
            width: 100%;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 7px;
            color: var(--text-primary);
            font-size: 14px;
            text-align: center;
            margin-bottom: 8px;
            font-family: inherit;
        }
        
        .cash-change {
            padding: 10px;
            background: var(--success);
            border-radius: 7px;
            text-align: center;
            margin-bottom: 8px;
            display: none;
        }
        
        .cash-change.visible { display: block; }
        .cash-change-label { font-size: 9px; opacity: 0.9; }
        .cash-change-val { font-size: 22px; font-weight: 700; }
        
        /* Install */
        .install-prompt {
            position: fixed;
            bottom: 8px; left: 8px; right: 8px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--accent);
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 2000;
        }
        
        .install-prompt.show { display: flex; }
        .install-prompt-text { flex: 1; font-size: 11px; }
        
        .install-btn {
            padding: 6px 12px;
            background: var(--accent);
            border: none;
            border-radius: 5px;
            color: #000;
            font-weight: 600;
            font-size: 11px;
            cursor: pointer;
            font-family: inherit;
        }
        
        .install-close { background: none; border: none; color: var(--text-muted); font-size: 16px; cursor: pointer; }
        
        /* Notif */
        .notif {
            position: fixed;
            bottom: 8px; right: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--success);
            border-radius: 7px;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 2000;
            transform: translateY(50px);
            opacity: 0;
            transition: all 0.3s;
            font-size: 11px;
        }
        
        .notif.show { transform: translateY(0); opacity: 1; }
        .notif.warning { border-color: var(--warning); }
        
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <div class="logo-icon">üêü</div>
                <span>TRAKIO</span>
                <span class="version">v5.3.2</span>
            </div>
        </div>
        <div class="header-center">
            <select class="event-select" id="eventSelect">
                <option value="magasin">üìç Magasin</option>
                <option value="nyon">üìç Nyon</option>
                <option value="morges">üìç Morges</option>
                <option value="livraison">üìç Livraison</option>
            </select>
            <div class="status"><span class="status-dot"></span><span id="dateDisplay">-</span></div>
        </div>
        <div class="header-right">
            <button class="header-btn" onclick="location.href='index.html'">üè†</button>
            <button class="header-btn" onclick="syncData()">üîÑ</button>
        </div>
    </header>
    
    <div class="categories-bar">
        <button class="cat-btn cat-favoris" onclick="selectCat('favoris')" data-cat="favoris"><span>‚≠ê</span>Favoris</button>
        <button class="cat-btn cat-tous active" onclick="selectCat('')" data-cat=""><span>üì¶</span>Tous</button>
        <button class="cat-btn cat-poissons" onclick="selectCat('poissons')" data-cat="poissons"><span>üêü</span>Poissons</button>
        <button class="cat-btn cat-crustaces" onclick="selectCat('crustaces')" data-cat="crustaces"><span>ü¶ê</span>Crustac√©s</button>
        <button class="cat-btn cat-coquillages" onclick="selectCat('coquillages')" data-cat="coquillages"><span>ü¶™</span>Coquillages</button>
        <button class="cat-btn cat-fumes" onclick="selectCat('fumes')" data-cat="fumes"><span>üî•</span>Fum√©s</button>
        <button class="cat-btn cat-traiteur" onclick="selectCat('traiteur')" data-cat="traiteur"><span>üçΩÔ∏è</span>Traiteur</button>
        <button class="cat-btn cat-epicerie" onclick="selectCat('epicerie')" data-cat="epicerie"><span>üõí</span>√âpicerie</button>
    </div>
    
    <div class="main">
        <div class="articles-zone">
            <div class="search-bar">
                <div class="search-wrap">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Rechercher..." id="searchInput" oninput="filter()">
                </div>
            </div>
            <div class="articles-grid" id="grid"></div>
        </div>
        
        <div class="ticket-zone">
            <div class="ticket-header">
                <div class="ticket-title">üßæ Ticket</div>
                <div class="ticket-count" id="ticketCount">0</div>
            </div>
            <div class="ticket-items" id="ticketItems"><div class="empty-ticket"><span>üõí</span><span>Vide</span></div></div>
            <div class="ticket-totals">
                <div class="total-row"><span>HT</span><span id="ht">0.00</span></div>
                <div class="total-row"><span>TVA 2.6%</span><span id="tva">0.00</span></div>
                <div class="discount-row"><label>Remise</label><input type="number" id="disc" value="0" min="0" step="0.05" onchange="totals()"></div>
                <div class="total-row grand"><span>TOTAL</span><span id="total">0.00 CHF</span></div>
            </div>
            <div class="payment-grid">
                <button class="pay-btn cash" onclick="openCash()"><span>üíµ</span>Esp√®ces</button>
                <button class="pay-btn card" onclick="pay('card')"><span>üí≥</span>Carte</button>
                <button class="pay-btn twint" onclick="pay('twint')"><span>üì±</span>Twint</button>
                <button class="clear-btn" onclick="clearCart()">üóëÔ∏è Vider</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PES√âE -->
    <div class="modal-overlay" id="weightModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚öñÔ∏è <span id="wName">Article</span></div>
                <button class="modal-close" onclick="closeW()">√ó</button>
            </div>
            <div class="weight-display"><span class="weight-value" id="wVal">0.000</span><span class="weight-unit">kg</span></div>
            <div class="weight-info"><span id="wPrice">0.00/kg</span> = <strong id="wTotal">0.00 CHF</strong></div>
            <div class="numpad">
                <button class="numpad-btn" onclick="np('1')">1</button>
                <button class="numpad-btn" onclick="np('2')">2</button>
                <button class="numpad-btn" onclick="np('3')">3</button>
                <button class="numpad-btn" onclick="np('4')">4</button>
                <button class="numpad-btn" onclick="np('5')">5</button>
                <button class="numpad-btn" onclick="np('6')">6</button>
                <button class="numpad-btn" onclick="np('7')">7</button>
                <button class="numpad-btn" onclick="np('8')">8</button>
                <button class="numpad-btn" onclick="np('9')">9</button>
                <button class="numpad-btn clear" onclick="np('C')">C</button>
                <button class="numpad-btn" onclick="np('0')">0</button>
                <button class="numpad-btn" onclick="np('.')">.</button>
            </div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeW()">Annuler</button>
                <button class="confirm" onclick="confirmW()">‚úì OK</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL ESP√àCES -->
    <div class="modal-overlay" id="cashModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üíµ Esp√®ces</div>
                <button class="modal-close" onclick="closeCash()">√ó</button>
            </div>
            <div class="cash-display"><div class="cash-label">√Ä payer</div><div class="cash-amount" id="cashTotal">0.00</div></div>
            <div class="cash-bills">
                <button class="cash-bill" onclick="selBill(10)"><div class="cash-bill-val">10</div><div class="cash-bill-label">CHF</div></button>
                <button class="cash-bill" onclick="selBill(20)"><div class="cash-bill-val">20</div><div class="cash-bill-label">CHF</div></button>
                <button class="cash-bill" onclick="selBill(50)"><div class="cash-bill-val">50</div><div class="cash-bill-label">CHF</div></button>
                <button class="cash-bill" onclick="selBill(100)"><div class="cash-bill-val">100</div><div class="cash-bill-label">CHF</div></button>
                <button class="cash-bill" onclick="selBill(200)"><div class="cash-bill-val">200</div><div class="cash-bill-label">CHF</div></button>
                <button class="cash-bill" onclick="selExact()"><div class="cash-bill-val">‚úì</div><div class="cash-bill-label">Exact</div></button>
            </div>
            <input type="number" class="cash-input" id="cashIn" placeholder="Re√ßu" step="0.05" oninput="calcCh()">
            <div class="cash-change" id="cashCh"><div class="cash-change-label">√Ä rendre</div><div class="cash-change-val" id="cashChVal">0.00</div></div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeCash()">Annuler</button>
                <button class="confirm" onclick="confirmCash()">‚úì OK</button>
            </div>
        </div>
    </div>
    
    <div class="install-prompt" id="installPrompt">
        <span>üì≤</span>
        <span class="install-prompt-text">Installer pour plein √©cran</span>
        <button class="install-btn" id="installBtn">Installer</button>
        <button class="install-close" onclick="hideInstall()">√ó</button>
    </div>
    
    <div class="notif" id="notif"><span id="nIcon">‚úì</span><span id="nText">OK</span></div>
    
    <script>
        let deferredPrompt;
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
        window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; if (!window.matchMedia('(display-mode: standalone)').matches) document.getElementById('installPrompt').classList.add('show'); });
        document.getElementById('installBtn').onclick = async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; hideInstall(); };
        function hideInstall() { document.getElementById('installPrompt').classList.remove('show'); }
        
        const TVA = 2.6;
        let articles = [], filtered = [], currentCat = '', cart = [];
        let wArt = null, wStr = '', cashToPay = 0;
        let txCnt = +localStorage.getItem('trakio_tx_counter') || 0;
        
        const DEFAULTS = [
            {id:'a1',name:'Saumon',category:'poissons',price:45,unit:'kg',fav:1},
            {id:'a2',name:'Perche',category:'poissons',price:58,unit:'kg',fav:1},
            {id:'a3',name:'Truite',category:'poissons',price:28,unit:'kg',fav:0},
            {id:'a4',name:'Sole',category:'poissons',price:65,unit:'kg',fav:0},
            {id:'a5',name:'Dorade',category:'poissons',price:38,unit:'kg',fav:0},
            {id:'a6',name:'Bar',category:'poissons',price:42,unit:'kg',fav:1},
            {id:'a7',name:'F√©ra',category:'poissons',price:48,unit:'kg',fav:1},
            {id:'a8',name:'Omble',category:'poissons',price:52,unit:'kg',fav:0},
            {id:'a9',name:'Cabillaud',category:'poissons',price:35,unit:'kg',fav:0},
            {id:'a10',name:'Thon',category:'poissons',price:85,unit:'kg',fav:0},
            {id:'b1',name:'Crevettes',category:'crustaces',price:32,unit:'kg',fav:1},
            {id:'b2',name:'Gambas',category:'crustaces',price:45,unit:'kg',fav:0},
            {id:'b3',name:'Homard',category:'crustaces',price:75,unit:'kg',fav:0},
            {id:'b4',name:'Langoustines',category:'crustaces',price:55,unit:'kg',fav:1},
            {id:'b5',name:'√âcrevisses',category:'crustaces',price:48,unit:'kg',fav:0},
            {id:'b6',name:'Tourteau',category:'crustaces',price:28,unit:'kg',fav:0},
            {id:'c1',name:'Hu√Ætres',category:'coquillages',price:24,unit:'pce',fav:1},
            {id:'c2',name:'Moules',category:'coquillages',price:8.5,unit:'kg',fav:1},
            {id:'c3',name:'St-Jacques',category:'coquillages',price:65,unit:'kg',fav:0},
            {id:'c4',name:'Palourdes',category:'coquillages',price:28,unit:'kg',fav:0},
            {id:'c5',name:'Coques',category:'coquillages',price:12,unit:'kg',fav:0},
            {id:'d1',name:'Saumon fum√©',category:'fumes',price:65,unit:'kg',fav:1},
            {id:'d2',name:'Truite fum√©e',category:'fumes',price:55,unit:'kg',fav:0},
            {id:'d3',name:'Haddock',category:'fumes',price:42,unit:'kg',fav:0},
            {id:'d4',name:'Maquereau',category:'fumes',price:28,unit:'kg',fav:0},
            {id:'d5',name:'Anguille',category:'fumes',price:75,unit:'kg',fav:0},
            {id:'e1',name:'Tarama',category:'traiteur',price:4.5,unit:'pce',fav:1},
            {id:'e2',name:'Rillettes',category:'traiteur',price:5.5,unit:'pce',fav:0},
            {id:'e3',name:'Salade mer',category:'traiteur',price:28,unit:'kg',fav:0},
            {id:'e4',name:'Terrine',category:'traiteur',price:6,unit:'pce',fav:0},
            {id:'e5',name:'Ceviche',category:'traiteur',price:8.5,unit:'pce',fav:1},
            {id:'e6',name:'Soupe',category:'traiteur',price:12,unit:'pce',fav:0},
            {id:'f1',name:'Citrons',category:'epicerie',price:3.5,unit:'pce',fav:0},
            {id:'f2',name:'Tartare',category:'epicerie',price:4,unit:'pce',fav:0},
            {id:'f3',name:'Mayo',category:'epicerie',price:3.5,unit:'pce',fav:0},
            {id:'f4',name:'Vin blanc',category:'epicerie',price:12,unit:'pce',fav:0},
            {id:'f5',name:'Huile',category:'epicerie',price:18,unit:'pce',fav:0},
            {id:'f6',name:'Sac iso',category:'epicerie',price:5,unit:'pce',fav:0}
        ];
        
        function init() {
            const s = localStorage.getItem('trakio_articles2');
            articles = s ? JSON.parse(s) : [...DEFAULTS];
            localStorage.setItem('trakio_articles2', JSON.stringify(articles));
            document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('fr-CH');
            filter();
        }
        
        function filter() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            filtered = articles.filter(a => {
                if (currentCat === 'favoris' && !a.fav) return false;
                if (currentCat && currentCat !== 'favoris' && a.category !== currentCat) return false;
                return !q || a.name.toLowerCase().includes(q);
            });
            render();
        }
        
        function selectCat(c) { currentCat = c; document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.dataset.cat === c)); filter(); }
        
        function render() {
            const g = document.getElementById('grid');
            const icons = {poissons:'üêü',crustaces:'ü¶ê',coquillages:'ü¶™',fumes:'üî•',traiteur:'üçΩÔ∏è',epicerie:'üõí'};
            const colors = {poissons:'#0ea5e9',crustaces:'#ef4444',coquillages:'#8b5cf6',fumes:'#f97316',traiteur:'#10b981',epicerie:'#6366f1'};
            if (!filtered.length) { g.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text-muted);font-size:10px;">Aucun article</div>'; return; }
            g.innerHTML = filtered.map(a => `<div class="tile" onclick="add('${a.id}')" style="--cat-color:${colors[a.category]||'#64748b'}">${a.fav?'<span class="tile-fav">‚≠ê</span>':''}<div class="tile-icon">${icons[a.category]||'üì¶'}</div><div class="tile-name">${a.name}</div><div class="tile-price">${a.price.toFixed(2)}</div></div>`).join('');
        }
        
        function add(id) {
            const a = articles.find(x => x.id === id);
            if (!a) return;
            if (a.unit === 'kg') { openW(a); return; }
            const e = cart.find(x => x.aid === id && !x.isW);
            if (e) e.qty++; else cart.push({id: Date.now().toString(36), aid: a.id, name: a.name, price: a.price, unit: a.unit, qty: 1, isW: false});
            renderCart(); notify(a.name, 'success', 800);
        }
        
        function updQty(id, d) { const i = cart.find(x => x.id === id); if (!i) return; i.qty = Math.max(0.1, i.qty + d); if (i.qty < 0.05) cart = cart.filter(x => x.id !== id); renderCart(); }
        function del(id) { cart = cart.filter(x => x.id !== id); renderCart(); }
        function clearCart() { if (cart.length && !confirm('Vider ?')) return; cart = []; document.getElementById('disc').value = 0; renderCart(); }
        
        function renderCart() {
            const c = document.getElementById('ticketItems');
            const t = cart.reduce((s, i) => s + i.qty, 0);
            document.getElementById('ticketCount').textContent = t.toFixed(t % 1 ? 1 : 0);
            if (!cart.length) { c.innerHTML = '<div class="empty-ticket"><span>üõí</span><span>Vide</span></div>'; totals(); return; }
            c.innerHTML = cart.map(i => `<div class="ticket-item"><div class="item-info"><div class="item-name">${i.name}</div><div class="item-details">${i.isW ? i.qty.toFixed(3)+'kg' : i.qty} √ó ${i.price.toFixed(2)}</div></div><div class="qty-btns"><button class="qty-btn" onclick="updQty('${i.id}',${i.isW?-0.1:-1})">‚àí</button><span class="qty-val">${i.isW ? i.qty.toFixed(2) : i.qty}</span><button class="qty-btn" onclick="updQty('${i.id}',${i.isW?0.1:1})">+</button></div><div class="item-price">${(i.price * i.qty).toFixed(2)}</div><button class="del-btn" onclick="del('${i.id}')">√ó</button></div>`).join('');
            totals();
        }
        
        function totals() {
            const d = +document.getElementById('disc').value || 0;
            let ttc = cart.reduce((s, i) => s + i.price * i.qty, 0);
            const ht = ttc / (1 + TVA/100);
            document.getElementById('ht').textContent = ht.toFixed(2);
            document.getElementById('tva').textContent = (ttc - ht).toFixed(2);
            document.getElementById('total').textContent = Math.max(0, swiss(ttc - d)).toFixed(2) + ' CHF';
        }
        
        function openW(a) { wArt = a; wStr = ''; document.getElementById('wName').textContent = a.name; document.getElementById('wPrice').textContent = a.price.toFixed(2) + '/kg'; document.getElementById('wVal').textContent = '0.000'; document.getElementById('wTotal').textContent = '0.00 CHF'; document.getElementById('weightModal').classList.add('active'); }
        function closeW() { document.getElementById('weightModal').classList.remove('active'); }
        function np(k) { if (k === 'C') wStr = ''; else if (k === '.') { if (!wStr.includes('.')) wStr += wStr ? '.' : '0.'; } else { const p = wStr.split('.'); if (p[1]?.length >= 3) return; wStr += k; } const w = +wStr || 0; document.getElementById('wVal').textContent = w.toFixed(3); document.getElementById('wTotal').textContent = (w * (wArt?.price || 0)).toFixed(2) + ' CHF'; }
        function confirmW() { const w = +wStr || 0; if (w <= 0) { notify('Poids?', 'warning'); return; } cart.push({id: Date.now().toString(36), aid: wArt.id, name: wArt.name, price: wArt.price, unit: 'kg', qty: w, isW: true}); closeW(); renderCart(); notify(wArt.name + ' ' + w.toFixed(3) + 'kg', 'success'); }
        
        function openCash() { if (!cart.length) { notify('Vide', 'warning'); return; } const d = +document.getElementById('disc').value || 0; cashToPay = swiss(cart.reduce((s, i) => s + i.price * i.qty, 0) - d); document.getElementById('cashTotal').textContent = cashToPay.toFixed(2) + ' CHF'; document.getElementById('cashIn').value = ''; document.getElementById('cashCh').classList.remove('visible'); document.querySelectorAll('.cash-bill').forEach(b => b.classList.remove('selected')); document.getElementById('cashModal').classList.add('active'); }
        function closeCash() { document.getElementById('cashModal').classList.remove('active'); }
        function selBill(v) { document.querySelectorAll('.cash-bill').forEach(b => b.classList.remove('selected')); event.target.closest('.cash-bill').classList.add('selected'); document.getElementById('cashIn').value = v; calcCh(); }
        function selExact() { document.querySelectorAll('.cash-bill').forEach(b => b.classList.remove('selected')); event.target.closest('.cash-bill').classList.add('selected'); document.getElementById('cashIn').value = cashToPay; calcCh(); }
        function calcCh() { const r = +document.getElementById('cashIn').value || 0; document.getElementById('cashChVal').textContent = Math.max(0, swiss(r - cashToPay)).toFixed(2) + ' CHF'; document.getElementById('cashCh').classList.toggle('visible', r >= cashToPay); }
        function confirmCash() { if ((+document.getElementById('cashIn').value || 0) < cashToPay) { notify('Insuffisant', 'warning'); return; } closeCash(); pay('cash'); }
        
        function pay(m) {
            if (!cart.length) { notify('Vide', 'warning'); return; }
            const d = +document.getElementById('disc').value || 0;
            const tot = swiss(cart.reduce((s, i) => s + i.price * i.qty, 0) - d);
            txCnt++; localStorage.setItem('trakio_tx_counter', txCnt);
            const tx = {id: Date.now().toString(36), num: txCnt, date: new Date().toISOString().slice(0,10), time: new Date().toTimeString().slice(0,5), event: document.getElementById('eventSelect').value, items: cart.map(i => ({name: i.name, price: i.price, qty: i.qty})), discount: d, total: tot, method: m};
            const txs = JSON.parse(localStorage.getItem('trakio_tx') || '[]'); txs.push(tx); localStorage.setItem('trakio_tx', JSON.stringify(txs));
            notify('‚úÖ ' + tot.toFixed(2) + ' CHF', 'success');
            cart = []; document.getElementById('disc').value = 0; renderCart();
        }
        
        function swiss(n) { return Math.round(n * 20) / 20; }
        function notify(msg, type = 'success', dur = 1500) { const n = document.getElementById('notif'); document.getElementById('nIcon').textContent = type === 'success' ? '‚úì' : '‚ö†'; document.getElementById('nText').textContent = msg; n.className = `notif ${type} show`; setTimeout(() => n.classList.remove('show'), dur); }
        function syncData() { const s = localStorage.getItem('trakio_articles2'); articles = s ? JSON.parse(s) : [...DEFAULTS]; filter(); notify('üîÑ OK', 'success', 1000); }
        
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeW(); closeCash(); } if (document.getElementById('weightModal').classList.contains('active')) { if (e.key >= '0' && e.key <= '9') np(e.key); else if (e.key === '.' || e.key === ',') np('.'); else if (e.key === 'Enter') confirmW(); } });
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

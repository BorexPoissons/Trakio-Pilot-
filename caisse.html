<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO v4.5.0 - Caisse</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’µ</text></svg>">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="trakio-config.js?v=4.5.0"></script>
    <script src="trakio-sync.js?v=4.5.0"></script>
    <script src="trakio-ui.js?v=4.5.0"></script>
    <style>
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .page-title { font-size: 26px; font-weight: 700; margin-bottom: 24px; }
        .pos-layout { display: grid; grid-template-columns: 1fr 400px; gap: 20px; height: calc(100vh - 160px); }
        @media (max-width: 1000px) { .pos-layout { grid-template-columns: 1fr; height: auto; } }
        .card { background: var(--trakio-bg-card); border: 1px solid var(--trakio-border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; }
        .categories { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .cat-btn { padding: 10px 18px; background: var(--trakio-bg-input); border: none; border-radius: 10px; color: var(--trakio-text); cursor: pointer; font-size: 13px; font-weight: 500; }
        .cat-btn.active { background: var(--trakio-primary); }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; flex: 1; overflow-y: auto; align-content: start; }
        .product-btn { padding: 15px 10px; background: var(--trakio-bg-input); border: none; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.15s; }
        .product-btn:hover { background: var(--trakio-primary); transform: scale(1.03); }
        .product-name { font-size: 12px; font-weight: 600; color: var(--trakio-text); margin-bottom: 4px; }
        .product-price { font-size: 11px; color: var(--trakio-success); }
        .cart-section { display: flex; flex-direction: column; height: 100%; }
        .cart-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; }
        .cart-items { flex: 1; overflow-y: auto; margin-bottom: 15px; }
        .cart-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--trakio-bg-input); border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
        .cart-item-name { flex: 1; font-weight: 500; }
        .cart-item-qty { width: 40px; text-align: center; padding: 4px; background: var(--trakio-bg-card); border: 1px solid var(--trakio-border); border-radius: 4px; color: var(--trakio-text); }
        .cart-item-total { font-weight: 600; color: var(--trakio-success); min-width: 65px; text-align: right; }
        .cart-item-remove { background: none; border: none; color: var(--trakio-error); cursor: pointer; }
        .totals { padding: 15px; background: var(--trakio-bg-input); border-radius: 12px; margin-bottom: 15px; }
        .total-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 6px; }
        .total-row.grand { font-size: 22px; font-weight: 700; color: var(--trakio-success); padding-top: 10px; border-top: 1px solid var(--trakio-border); margin-top: 6px; }
        .payment-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .pay-btn { padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .pay-btn.cash { background: var(--trakio-success); color: white; }
        .pay-btn.card { background: var(--trakio-primary); color: white; }
        .empty { text-align: center; padding: 30px; color: var(--trakio-text-muted); }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title">ðŸ’µ Caisse</h1>
        <div class="pos-layout">
            <div class="card">
                <div class="categories" id="categories"></div>
                <div class="products-grid" id="products"></div>
            </div>
            <div class="card cart-section">
                <div class="cart-title">ðŸ§¾ Ticket</div>
                <div class="cart-items" id="cart"><div class="empty">Aucun article</div></div>
                <div class="totals">
                    <div class="total-row"><span>Sous-total</span><span id="subtotal">CHF 0.00</span></div>
                    <div class="total-row"><span>TVA 2.6%</span><span id="tva">CHF 0.00</span></div>
                    <div class="total-row grand"><span>Total</span><span id="total">CHF 0.00</span></div>
                </div>
                <div class="payment-btns">
                    <button class="pay-btn cash" onclick="pay('cash')">ðŸ’µ EspÃ¨ces</button>
                    <button class="pay-btn card" onclick="pay('card')">ðŸ’³ Carte</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        let articles = [], cart = [], currentCat = 'all';
        const cats = [{ id: 'all', name: 'Tous', icon: 'ðŸ“¦' },{ id: 'poissons', name: 'Poissons', icon: 'ðŸŸ' },{ id: 'crustaces', name: 'CrustacÃ©s', icon: 'ðŸ¦' },{ id: 'coquillages', name: 'Coquillages', icon: 'ðŸ¦ª' },{ id: 'traiteur', name: 'Traiteur', icon: 'ðŸ½ï¸' }];
        document.addEventListener('DOMContentLoaded', () => setTimeout(init, 300));
        async function init() { articles = await DataStore.articles.getAll(); renderCategories(); renderProducts(); }
        function renderCategories() { document.getElementById('categories').innerHTML = cats.map(c => '<button class="cat-btn '+(currentCat===c.id?'active':'')+'" onclick="setCat(\''+c.id+'\')">'+c.icon+' '+c.name+'</button>').join(''); }
        function setCat(cat) { currentCat = cat; renderCategories(); renderProducts(); }
        function renderProducts() {
            const filtered = currentCat === 'all' ? articles : articles.filter(a => a.category === currentCat);
            document.getElementById('products').innerHTML = filtered.map(a => '<button class="product-btn" onclick="addToCart(\''+a.id+'\')"><div class="product-name">'+a.name+'</div><div class="product-price">'+formatCHF(a.price)+'</div></button>').join('') || '<div class="empty">Aucun article</div>';
        }
        function addToCart(id) {
            const art = articles.find(a => a.id === id);
            if (!art) return;
            const existing = cart.find(i => i.id === id);
            if (existing) existing.qty++; else cart.push({ id, name: art.name, price: art.price || 0, qty: 1 });
            renderCart();
        }
        function setQty(id, qty) { const item = cart.find(i => i.id === id); if (item) { item.qty = Math.max(1, parseInt(qty) || 1); renderCart(); } }
        function removeItem(id) { cart = cart.filter(i => i.id !== id); renderCart(); }
        function renderCart() {
            const container = document.getElementById('cart');
            if (cart.length === 0) { container.innerHTML = '<div class="empty">Aucun article</div>'; } else {
                container.innerHTML = cart.map(i => '<div class="cart-item"><span class="cart-item-name">'+i.name+'</span><input type="number" class="cart-item-qty" value="'+i.qty+'" min="1" onchange="setQty(\''+i.id+'\', this.value)"><span class="cart-item-total">'+formatCHF(i.price*i.qty)+'</span><button class="cart-item-remove" onclick="removeItem(\''+i.id+'\')">Ã—</button></div>').join('');
            }
            updateTotals();
        }
        function updateTotals() {
            const sub = cart.reduce((s, i) => s + i.price * i.qty, 0);
            const tva = sub * 0.026;
            document.getElementById('subtotal').textContent = formatCHF(sub);
            document.getElementById('tva').textContent = formatCHF(tva);
            document.getElementById('total').textContent = formatCHF(sub + tva);
        }
        async function pay(method) {
            if (cart.length === 0) { TrakioUI.showToast('âŒ Panier vide', 'error'); return; }
            const sub = cart.reduce((s, i) => s + i.price * i.qty, 0);
            const data = { items: cart.map(i => ({ id: i.id, name: i.name, qty: i.qty, price: i.price })), subtotal: sub, tva: sub * 0.026, total: sub * 1.026, paymentMethod: method, source: 'caisse', status: 'paid' };
            await DataStore.ventes.save(null, data);
            TrakioUI.showToast('âœ… Paiement ' + method + ': ' + formatCHF(data.total), 'success');
            cart = []; renderCart();
        }
    </script>
</body>
</html>

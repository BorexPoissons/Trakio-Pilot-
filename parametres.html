<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAKIO v5.0.4 - Param√®tres</title>
    <!-- TRAKIO v5.0.4 - Param√®tres Admin - Derni√®re mise √† jour: 12.12.2025 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öôÔ∏è</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #030712;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-input: #0f172a;
            --border: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-cyan: #06b6d4;
            --accent-teal: #14b8a6;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-orange: #f97316;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gradient-main: linear-gradient(135deg, #06b6d4 0%, #14b8a6 50%, #10b981 100%);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* ============ TOP NAVIGATION ============ */
        .top-nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 15px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: inherit;
        }
        .nav-logo {
            width: 32px;
            height: 32px;
            background: var(--gradient-main);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .nav-title { font-weight: 700; font-size: 18px; }
        .nav-version {
            font-size: 10px;
            background: var(--accent-cyan);
            color: var(--bg-deep);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .nav-links {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            justify-content: center;
            flex-wrap: wrap;
        }
        .nav-link {
            padding: 8px 12px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .nav-link:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-link.active { background: var(--accent-cyan); color: var(--bg-deep); }
        .nav-right { display: flex; align-items: center; gap: 15px; }
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
        }
        .user-avatar {
            width: 28px;
            height: 28px;
            background: var(--gradient-main);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        /* Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            gap: 4px;
            padding: 8px;
            background: none;
            border: none;
            cursor: pointer;
        }
        .hamburger span {
            width: 20px;
            height: 2px;
            background: var(--text-primary);
            border-radius: 1px;
        }
        .mobile-menu {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
        }
        .mobile-menu.show { display: block; }
        .mobile-menu-content {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: var(--bg-secondary);
            padding: 20px;
            overflow-y: auto;
        }
        .mobile-menu-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
        }
        .mobile-nav-links {
            margin-top: 50px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .mobile-nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
        }
        .mobile-nav-link:hover, .mobile-nav-link.active {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* ============ MAIN CONTENT ============ */
        .main-content { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .page-header { margin-bottom: 30px; }
        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .page-subtitle { color: var(--text-secondary); font-size: 14px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }
        .tab {
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }
        .tab:hover { background: var(--bg-hover); color: var(--text-primary); }
        .tab.active {
            background: var(--accent-cyan);
            color: var(--bg-deep);
            border-color: var(--accent-cyan);
        }

        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 25px;
            margin-bottom: 20px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* User List */
        .user-list { display: flex; flex-direction: column; gap: 12px; }
        .user-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--bg-input);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .user-card-avatar {
            width: 50px;
            height: 50px;
            background: var(--gradient-main);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .user-card-info { flex: 1; }
        .user-card-name { font-weight: 600; font-size: 16px; margin-bottom: 3px; }
        .user-card-role { font-size: 13px; color: var(--text-secondary); }
        .user-card-actions { display: flex; gap: 8px; }
        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }
        .btn-icon:hover { border-color: var(--accent-cyan); background: var(--bg-hover); }
        .btn-icon.danger:hover { border-color: var(--danger); color: var(--danger); }
        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge.admin { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
        .badge.manager { background: rgba(6, 182, 212, 0.2); color: var(--accent-cyan); }
        .badge.employee { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge.default { background: rgba(148, 163, 184, 0.2); color: var(--text-secondary); }

        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
        }
        .btn-primary {
            background: var(--gradient-main);
            color: var(--bg-deep);
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        .btn-secondary:hover { border-color: var(--accent-cyan); }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-danger:hover { opacity: 0.9; }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border);
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        .modal-title { font-size: 20px; font-weight: 700; }
        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 18px;
        }
        .modal-close:hover { border-color: var(--danger); color: var(--danger); }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        /* Permissions */
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        .permission-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .permission-item:hover { background: var(--bg-hover); }
        .permission-item input { display: none; }
        .permission-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .permission-item input:checked + .permission-checkbox {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }
        .permission-item input:checked + .permission-checkbox::after {
            content: '‚úì';
            color: var(--bg-deep);
            font-size: 12px;
            font-weight: bold;
        }
        .permission-label { font-size: 13px; }

        /* Backup Section */
        .backup-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .backup-card {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            background: var(--bg-input);
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .backup-icon { font-size: 40px; margin-bottom: 15px; }
        .backup-title { font-weight: 600; margin-bottom: 5px; }
        .backup-desc { font-size: 12px; color: var(--text-secondary); margin-bottom: 15px; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 3000;
        }
        .toast.show { display: flex; }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }

        /* Responsive */
        @media (max-width: 1200px) {
            .nav-link span { display: none; }
            .nav-link { padding: 8px; font-size: 18px; }
        }
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .hamburger { display: flex; }
            .tabs { flex-wrap: wrap; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- MOBILE MENU -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-content">
            <button class="mobile-menu-close" onclick="closeMobileMenu()">√ó</button>
            <div class="mobile-nav-links">
                <a href="index.html" class="mobile-nav-link">üè† Dashboard</a>
                <a href="articles.html" class="mobile-nav-link">üì¶ Articles</a>
                <a href="clients.html" class="mobile-nav-link">üë• Clients</a>
                <a href="commandes.html" class="mobile-nav-link">üìã Commandes</a>
                <a href="myfish.html" class="mobile-nav-link">üêü MyFish</a>
                <a href="caisse.html" class="mobile-nav-link">üí∞ Caisse</a>
                <a href="live.html" class="mobile-nav-link">üìä Live</a>
                <a href="tracabilite.html" class="mobile-nav-link">üè∑Ô∏è Tra√ßabilit√©</a>
                <a href="compta.html" class="mobile-nav-link">üìà Compta</a>
                <a href="shopify.html" class="mobile-nav-link">üõí Shopify</a>
                <a href="whatsapp.html" class="mobile-nav-link">üí¨ WhatsApp</a>
                <a href="parametres.html" class="mobile-nav-link active">‚öôÔ∏è Param√®tres</a>
            </div>
        </div>
    </div>

    <!-- TOP NAVIGATION -->
    <nav class="top-nav">
        <div class="nav-left">
            <a href="index.html" class="nav-brand">
                <div class="nav-logo">üêü</div>
                <span class="nav-title">TRAKIO</span>
                <span class="nav-version">v5.0.4</span>
            </a>
            <button class="hamburger" onclick="openMobileMenu()">
                <span></span><span></span><span></span>
            </button>
        </div>
        <div class="nav-links">
            <a href="index.html" class="nav-link">üè† <span>Dashboard</span></a>
            <a href="articles.html" class="nav-link">üì¶ <span>Articles</span></a>
            <a href="clients.html" class="nav-link">üë• <span>Clients</span></a>
            <a href="commandes.html" class="nav-link">üìã <span>Commandes</span></a>
            <a href="myfish.html" class="nav-link">üêü <span>MyFish</span></a>
            <a href="caisse.html" class="nav-link">üí∞ <span>Caisse</span></a>
            <a href="live.html" class="nav-link">üìä <span>Live</span></a>
            <a href="tracabilite.html" class="nav-link">üè∑Ô∏è <span>Tra√ßabilit√©</span></a>
            <a href="compta.html" class="nav-link">üìà <span>Compta</span></a>
            <a href="shopify.html" class="nav-link">üõí <span>Shopify</span></a>
            <a href="whatsapp.html" class="nav-link">üí¨ <span>WhatsApp</span></a>
            <a href="parametres.html" class="nav-link active">‚öôÔ∏è <span>Param√®tres</span></a>
        </div>
        <div class="nav-right">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">üëë</div>
                <span id="userName">Admin</span>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <header class="page-header">
            <h1 class="page-title">‚öôÔ∏è Param√®tres</h1>
            <p class="page-subtitle">Gestion des utilisateurs, permissions et configuration syst√®me</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('users')">üë• Utilisateurs</button>
            <button class="tab" onclick="switchTab('permissions')">üîê Permissions</button>
            <button class="tab" onclick="switchTab('backup')">üíæ Sauvegarde</button>
            <button class="tab" onclick="switchTab('system')">üîß Syst√®me</button>
        </div>

        <!-- USERS TAB -->
        <div class="tab-content active" id="tab-users">
            <div class="card">
                <div class="card-title" style="justify-content: space-between;">
                    <span>üë• Utilisateurs</span>
                    <button class="btn btn-primary" onclick="openUserModal()">+ Ajouter</button>
                </div>
                <div class="user-list" id="userList"></div>
            </div>
        </div>

        <!-- PERMISSIONS TAB -->
        <div class="tab-content" id="tab-permissions">
            <div class="card">
                <h3 class="card-title">üîê Permissions par r√¥le</h3>
                <div class="form-group">
                    <label class="form-label">S√©lectionner un r√¥le</label>
                    <select class="form-select" id="roleSelect" onchange="loadRolePermissions()">
                        <option value="admin">üëë Administrateur</option>
                        <option value="manager">üìä Manager</option>
                        <option value="employee">üêü Employ√©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Modules accessibles</label>
                    <div class="permissions-grid" id="permissionsGrid"></div>
                </div>
                <button class="btn btn-primary" onclick="savePermissions()">üíæ Sauvegarder</button>
            </div>
        </div>

        <!-- BACKUP TAB -->
        <div class="tab-content" id="tab-backup">
            <div class="card">
                <h3 class="card-title">üíæ Sauvegarde & Restauration</h3>
                <div class="backup-actions">
                    <div class="backup-card">
                        <div class="backup-icon">üì§</div>
                        <div class="backup-title">Exporter</div>
                        <div class="backup-desc">T√©l√©charger toutes les donn√©es</div>
                        <button class="btn btn-secondary" onclick="exportData()">Exporter JSON</button>
                    </div>
                    <div class="backup-card">
                        <div class="backup-icon">üì•</div>
                        <div class="backup-title">Importer</div>
                        <div class="backup-desc">Restaurer depuis un fichier</div>
                        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Importer JSON</button>
                    </div>
                    <div class="backup-card">
                        <div class="backup-icon">üóëÔ∏è</div>
                        <div class="backup-title">R√©initialiser</div>
                        <div class="backup-desc">Effacer toutes les donn√©es</div>
                        <button class="btn btn-danger" onclick="confirmReset()">R√©initialiser</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SYSTEM TAB -->
        <div class="tab-content" id="tab-system">
            <div class="card">
                <h3 class="card-title">üîß Informations syst√®me</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Version</label>
                        <input type="text" class="form-input" value="TRAKIO v5.0.4" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Firebase</label>
                        <input type="text" class="form-input" value="trakio-pilot-6e97a" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Articles stock√©s</label>
                        <input type="text" class="form-input" id="statsArticles" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Clients stock√©s</label>
                        <input type="text" class="form-input" id="statsClients" readonly>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- USER MODAL -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Nouvel utilisateur</h3>
                <button class="modal-close" onclick="closeUserModal()">√ó</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label class="form-label">Nom *</label>
                    <input type="text" class="form-input" id="userNameInput" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Code PIN (4 chiffres) *</label>
                        <input type="text" class="form-input" id="userPin" maxlength="4" pattern="[0-9]{4}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">R√¥le *</label>
                        <select class="form-select" id="userRole">
                            <option value="employee">üêü Employ√©</option>
                            <option value="manager">üìä Manager</option>
                            <option value="admin">üëë Administrateur</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Avatar (emoji)</label>
                    <input type="text" class="form-input" id="userAvatarInput" placeholder="üêü" maxlength="2">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">üíæ Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast">
        <span id="toastIcon">‚úì</span>
        <span id="toastMessage">Message</span>
    </div>

    <script>
        const APP_VERSION = '5.0.4';
        const DEFAULT_USERS = [
            { id: 'pascal', name: 'Pascal', pin: '1277', role: 'admin', avatar: 'üëë', isDefault: true },
            { id: 'celine', name: 'C√©line', pin: '1277', role: 'manager', avatar: 'üìä', isDefault: true },
            { id: 'hayat', name: 'Hayat', pin: '1260', role: 'employee', avatar: 'üêü', isDefault: true }
        ];
        const ALL_MODULES = [
            { id: 'dashboard', name: 'üè† Dashboard' },
            { id: 'articles', name: 'üì¶ Articles' },
            { id: 'clients', name: 'üë• Clients' },
            { id: 'commandes', name: 'üìã Commandes' },
            { id: 'myfish', name: 'üêü MyFish' },
            { id: 'caisse', name: 'üí∞ Caisse' },
            { id: 'live', name: 'üìä Live' },
            { id: 'tracabilite', name: 'üè∑Ô∏è Tra√ßabilit√©' },
            { id: 'compta', name: 'üìà Compta' },
            { id: 'shopify', name: 'üõí Shopify' },
            { id: 'whatsapp', name: 'üí¨ WhatsApp' },
            { id: 'parametres', name: '‚öôÔ∏è Param√®tres' }
        ];
        const DEFAULT_PERMISSIONS = {
            admin: ['dashboard', 'articles', 'clients', 'commandes', 'myfish', 'caisse', 'live', 'tracabilite', 'compta', 'shopify', 'whatsapp', 'parametres'],
            manager: ['dashboard', 'articles', 'clients', 'commandes', 'myfish', 'caisse', 'live', 'tracabilite', 'compta'],
            employee: ['dashboard', 'myfish', 'caisse', 'clients', 'commandes']
        };

        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadUsers();
            loadRolePermissions();
            loadStats();
            document.getElementById('userForm').addEventListener('submit', saveUser);
        });

        function checkAuth() {
            const savedUser = localStorage.getItem('trakio_current_user');
            if (!savedUser) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = JSON.parse(savedUser);
            if (currentUser.role !== 'admin') {
                showToast('Acc√®s refus√©', 'error');
                setTimeout(() => window.location.href = 'index.html', 1500);
                return;
            }
            document.getElementById('userAvatar').textContent = currentUser.avatar;
            document.getElementById('userName').textContent = currentUser.name;
        }

        function getAllUsers() {
            const customUsers = JSON.parse(localStorage.getItem('trakio_users') || '[]');
            return [...DEFAULT_USERS, ...customUsers];
        }

        function getCustomUsers() {
            return JSON.parse(localStorage.getItem('trakio_users') || '[]');
        }

        function saveCustomUsers(users) {
            localStorage.setItem('trakio_users', JSON.stringify(users));
        }

        function loadUsers() {
            const users = getAllUsers();
            const list = document.getElementById('userList');
            list.innerHTML = users.map(user => `
                <div class="user-card">
                    <div class="user-card-avatar">${user.avatar}</div>
                    <div class="user-card-info">
                        <div class="user-card-name">${user.name} ${user.isDefault ? '<span class="badge default">Par d√©faut</span>' : ''}</div>
                        <div class="user-card-role"><span class="badge ${user.role}">${getRoleLabel(user.role)}</span></div>
                    </div>
                    <div class="user-card-actions">
                        <button class="btn-icon" onclick="editUser('${user.id}')" title="Modifier">‚úèÔ∏è</button>
                        ${!user.isDefault ? `<button class="btn-icon danger" onclick="deleteUser('${user.id}')" title="Supprimer">üóëÔ∏è</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getRoleLabel(role) {
            const labels = { admin: 'üëë Admin', manager: 'üìä Manager', employee: 'üêü Employ√©' };
            return labels[role] || role;
        }

        function openUserModal(userId = null) {
            document.getElementById('modalTitle').textContent = userId ? 'Modifier utilisateur' : 'Nouvel utilisateur';
            document.getElementById('userId').value = userId || '';
            document.getElementById('userNameInput').value = '';
            document.getElementById('userPin').value = '';
            document.getElementById('userRole').value = 'employee';
            document.getElementById('userAvatarInput').value = 'üêü';
            if (userId) {
                const users = getAllUsers();
                const user = users.find(u => u.id === userId);
                if (user) {
                    document.getElementById('userNameInput').value = user.name;
                    document.getElementById('userPin').value = user.pin;
                    document.getElementById('userRole').value = user.role;
                    document.getElementById('userAvatarInput').value = user.avatar;
                }
            }
            document.getElementById('userModal').classList.add('show');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('show');
        }

        function saveUser(e) {
            e.preventDefault();
            const userId = document.getElementById('userId').value;
            const name = document.getElementById('userNameInput').value.trim();
            const pin = document.getElementById('userPin').value;
            const role = document.getElementById('userRole').value;
            const avatar = document.getElementById('userAvatarInput').value || 'üêü';

            if (!/^[0-9]{4}$/.test(pin)) {
                showToast('Le PIN doit contenir 4 chiffres', 'error');
                return;
            }

            const customUsers = getCustomUsers();
            if (userId) {
                // Check if editing default user
                const defaultUser = DEFAULT_USERS.find(u => u.id === userId);
                if (defaultUser) {
                    // Update default user in custom list
                    const idx = customUsers.findIndex(u => u.id === userId);
                    const updatedUser = { ...defaultUser, name, pin, role, avatar };
                    if (idx >= 0) {
                        customUsers[idx] = updatedUser;
                    } else {
                        customUsers.push(updatedUser);
                    }
                } else {
                    const idx = customUsers.findIndex(u => u.id === userId);
                    if (idx >= 0) {
                        customUsers[idx] = { ...customUsers[idx], name, pin, role, avatar };
                    }
                }
            } else {
                const newUser = {
                    id: 'user_' + Date.now(),
                    name,
                    pin,
                    role,
                    avatar,
                    isDefault: false
                };
                customUsers.push(newUser);
            }

            saveCustomUsers(customUsers);
            loadUsers();
            closeUserModal();
            showToast('Utilisateur sauvegard√©');
        }

        function editUser(userId) {
            openUserModal(userId);
        }

        function deleteUser(userId) {
            if (!confirm('Supprimer cet utilisateur ?')) return;
            const customUsers = getCustomUsers().filter(u => u.id !== userId);
            saveCustomUsers(customUsers);
            loadUsers();
            showToast('Utilisateur supprim√©');
        }

        // Tabs
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // Permissions
        function loadRolePermissions() {
            const role = document.getElementById('roleSelect').value;
            const savedPerms = JSON.parse(localStorage.getItem('trakio_permissions') || '{}');
            const permissions = savedPerms[role] || DEFAULT_PERMISSIONS[role];
            const grid = document.getElementById('permissionsGrid');
            grid.innerHTML = ALL_MODULES.map(mod => `
                <label class="permission-item">
                    <input type="checkbox" value="${mod.id}" ${permissions.includes(mod.id) ? 'checked' : ''}>
                    <span class="permission-checkbox"></span>
                    <span class="permission-label">${mod.name}</span>
                </label>
            `).join('');
        }

        function savePermissions() {
            const role = document.getElementById('roleSelect').value;
            const checked = Array.from(document.querySelectorAll('#permissionsGrid input:checked')).map(i => i.value);
            const savedPerms = JSON.parse(localStorage.getItem('trakio_permissions') || '{}');
            savedPerms[role] = checked;
            localStorage.setItem('trakio_permissions', JSON.stringify(savedPerms));
            showToast('Permissions sauvegard√©es');
        }

        // Backup
        function exportData() {
            const data = {
                version: APP_VERSION,
                exportDate: new Date().toISOString(),
                users: getCustomUsers(),
                permissions: JSON.parse(localStorage.getItem('trakio_permissions') || '{}'),
                articles: JSON.parse(localStorage.getItem('trakio_articles') || '[]'),
                clients: JSON.parse(localStorage.getItem('trakio_clients') || '[]'),
                commandes: JSON.parse(localStorage.getItem('trakio_commandes') || '[]'),
                ventes: JSON.parse(localStorage.getItem('trakio_ventes') || '[]')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trakio_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('Export r√©ussi');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.users) localStorage.setItem('trakio_users', JSON.stringify(data.users));
                    if (data.permissions) localStorage.setItem('trakio_permissions', JSON.stringify(data.permissions));
                    if (data.articles) localStorage.setItem('trakio_articles', JSON.stringify(data.articles));
                    if (data.clients) localStorage.setItem('trakio_clients', JSON.stringify(data.clients));
                    if (data.commandes) localStorage.setItem('trakio_commandes', JSON.stringify(data.commandes));
                    if (data.ventes) localStorage.setItem('trakio_ventes', JSON.stringify(data.ventes));
                    loadUsers();
                    loadStats();
                    showToast('Import r√©ussi');
                } catch (err) {
                    showToast('Fichier invalide', 'error');
                }
            };
            reader.readAsText(file);
        }

        function confirmReset() {
            if (!confirm('‚ö†Ô∏è ATTENTION: Toutes les donn√©es seront effac√©es. Continuer ?')) return;
            if (!confirm('Derni√®re confirmation: √ätes-vous vraiment s√ªr ?')) return;
            localStorage.removeItem('trakio_users');
            localStorage.removeItem('trakio_permissions');
            localStorage.removeItem('trakio_articles');
            localStorage.removeItem('trakio_clients');
            localStorage.removeItem('trakio_commandes');
            localStorage.removeItem('trakio_ventes');
            loadUsers();
            loadStats();
            showToast('Donn√©es r√©initialis√©es');
        }

        // Stats
        function loadStats() {
            const articles = JSON.parse(localStorage.getItem('trakio_articles') || '[]');
            const clients = JSON.parse(localStorage.getItem('trakio_clients') || '[]');
            document.getElementById('statsArticles').value = articles.length;
            document.getElementById('statsClients').value = clients.length;
        }

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            document.getElementById('toastIcon').textContent = type === 'success' ? '‚úì' : '‚úï';
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Mobile Menu
        function openMobileMenu() { document.getElementById('mobileMenu').classList.add('show'); }
        function closeMobileMenu() { document.getElementById('mobileMenu').classList.remove('show'); }
    </script>
</body>
</html>
